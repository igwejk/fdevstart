/**
 * @file toolmatcher
 * @module jfseb.fdevstart.toolmatcher
 * @copyright (c) Gerd Forstmann
 *
 * Match a tool record on a sentence,
 *
 * This will unify matching required and optional category words
 * with the requirements of the tool.
 *
 */
"use strict";
// / <reference path="../../lib/node-4.d.ts" />

var debug = require('debug');
var utils = require('../utils/utils');
var Sentence = require('./sentence');
var OpsWord = require('./word');
var Word = OpsWord.Word;
var Category = OpsWord.Category;
var debuglog = debug('toolmatcher');
function matchTool(oSentence, oTool) {
    var used = {};
    var required = {};
    var optional = {};
    var matched = {};
    var spurious = {};
    var toolmentioned = [];
    Object.keys(oTool.requires || {}).forEach(function (sCategory) {
        var _Sentence$findWordByC = Sentence.findWordByCategory(oSentence, sCategory),
            word = _Sentence$findWordByC.word,
            index = _Sentence$findWordByC.index;

        if (word) {
            matched[word] = "required";
            used[index] = 1;
            required[sCategory] = word;
        }
    });
    Object.keys(oTool.optional || {}).forEach(function (sCategory) {
        var _Sentence$findWordByC2 = Sentence.findWordByCategory(oSentence, sCategory),
            word = _Sentence$findWordByC2.word,
            index = _Sentence$findWordByC2.index;

        if (word) {
            matched[word] = "optional";
            used[index] = 1;
            optional[sCategory] = word;
        }
    });
    oSentence.forEach(function (oWord, index) {
        if (!used[index] && !Word.isFiller(oWord) && !Word.isCategory(oWord)) {
            debuglog("have spurious word" + JSON.stringify(oWord));
            spurious[oWord.matchedString] = 1;
        }
        if (!used[index] && oWord.category === Category.CAT_TOOL && oWord.matchedString === oTool.name) {
            toolmentioned.push(oWord);
        }
    });
    debuglog('satisfied : ' + Object.keys(oTool.requires).join(";"));
    debuglog('required  : ' + Object.keys(oTool.requires).join(";"));
    var missing = utils.ArrayUtils.setMinus(Object.keys(oTool.requires), Object.keys(required)).reduce(function (map, sKey) {
        map[sKey] = 1;
        return map;
    }, {});
    return {
        required: required,
        missing: missing,
        optional: optional,
        spurious: spurious,
        toolmentioned: toolmentioned
    };
}
exports.matchTool = matchTool;
var match = require('./match');
var ToolMatch = match.ToolMatch;
function matchTools(aSentences, aTool) {
    //var stream = new streamutils.MatchStream();
    var result = [];
    aTool.forEach(function (oTool) {
        aSentences.forEach(function (oSentence) {
            var toolmatchresult = matchTool(oSentence, oTool);
            var toolmatch = {
                toolmatchresult: toolmatchresult,
                sentence: oSentence,
                tool: oTool,
                rank: 0
            };
            toolmatch.rank = ToolMatch.rankResult(toolmatch.toolmatchresult);
            if (ToolMatch.isAnyMatch(toolmatch)) {
                result.push(toolmatch);
            }
        });
    });
    result.sort(ToolMatch.compBetterMatch);
    return result;
}
exports.matchTools = matchTools;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC90b29sbWF0Y2hlci50cyIsIm1hdGNoL3Rvb2xtYXRjaGVyLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsInV0aWxzIiwiU2VudGVuY2UiLCJPcHNXb3JkIiwiV29yZCIsIkNhdGVnb3J5IiwiZGVidWdsb2ciLCJtYXRjaFRvb2wiLCJvU2VudGVuY2UiLCJvVG9vbCIsInVzZWQiLCJyZXF1aXJlZCIsIm9wdGlvbmFsIiwibWF0Y2hlZCIsInNwdXJpb3VzIiwidG9vbG1lbnRpb25lZCIsIk9iamVjdCIsImtleXMiLCJyZXF1aXJlcyIsImZvckVhY2giLCJzQ2F0ZWdvcnkiLCJmaW5kV29yZEJ5Q2F0ZWdvcnkiLCJ3b3JkIiwiaW5kZXgiLCJvV29yZCIsImlzRmlsbGVyIiwiaXNDYXRlZ29yeSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtYXRjaGVkU3RyaW5nIiwiY2F0ZWdvcnkiLCJDQVRfVE9PTCIsIm5hbWUiLCJwdXNoIiwiam9pbiIsIm1pc3NpbmciLCJBcnJheVV0aWxzIiwic2V0TWludXMiLCJyZWR1Y2UiLCJtYXAiLCJzS2V5IiwiZXhwb3J0cyIsIm1hdGNoIiwiVG9vbE1hdGNoIiwibWF0Y2hUb29scyIsImFTZW50ZW5jZXMiLCJhVG9vbCIsInJlc3VsdCIsInRvb2xtYXRjaHJlc3VsdCIsInRvb2xtYXRjaCIsInNlbnRlbmNlIiwidG9vbCIsInJhbmsiLCJyYW5rUmVzdWx0IiwiaXNBbnlNYXRjaCIsInNvcnQiLCJjb21wQmV0dGVyTWF0Y2giXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7OztBQ1dBO0FEQ0E7O0FBRUEsSUFBWUEsUUFBS0MsUUFBTSxPQUFOLENBQWpCO0FBSUEsSUFBWUMsUUFBS0QsUUFBTSxnQkFBTixDQUFqQjtBQUdBLElBQVlFLFdBQVFGLFFBQU0sWUFBTixDQUFwQjtBQUNBLElBQVlHLFVBQU9ILFFBQU0sUUFBTixDQUFuQjtBQUVBLElBQU1JLE9BQU9ELFFBQVFDLElBQXJCO0FBQ0EsSUFB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SUxFLGtCQUFVQSxRQUpMO0FBS0xDLHVCQUFnQkE7QUFMWCxLQUFQO0FBT0Q7QUFoRGUwQixRQUFBbEMsU0FBQSxHQUFTQSxTQUFUO0FBa0RoQixJQUFZbUMsUUFBSzFDLFFBQU0sU0FBTixDQUFqQjtBQUVBLElBQU0yQyxZQUFZRCxNQUFNQyxTQUF4QjtBQUVBLFNBQUFDLFVBQUEsQ0FBMkJDLFVBQTNCLEVBQWdFQyxLQUFoRSxFQUEwRjtBQUN4RjtBQUNBLFFBQUlDLFNBQVMsRUFBYjtBQUNBRCxVQUFNM0IsT0FBTixDQUFjLFVBQVVWLEtBQVYsRUFBZTtBQUMzQm9DLG1CQUFXMUIsT0FBWCxDQUFtQixVQUFVWCxTQUFWLEVBQW1CO0FBQ3BDLGdCQUFJd0Msa0JBQWtCekMsVUFBVUMsU0FBVixFQUFxQkMsS0FBckIsQ0FBdEI7QUFDQSxnQkFBSXdDLFlBQVk7QUFDZEQsaUNBQWlCQSxlQURIO0FBRWRFLDBCQUFVMUMsU0FGSTtBQUdkMkMsc0JBQU8xQyxLQUhPO0FBSWQyQyxzQkFBTztBQUpPLGFBQWhCO0FBTUFILHNCQUFVRyxJQUFWLEdBQWlCVCxVQUFVVSxVQUFWLENBQXFCSixVQUFVRCxlQUEvQixDQUFqQjtBQUNBLGdCQUFJTCxVQUFVVyxVQUFWLENBQXFCTCxTQUFyQixDQUFKLEVBQXFDO0FBQ25DRix1QkFBT2QsSUFBUCxDQUFZZ0IsU0FBWjtBQUNEO0FBQ0YsU0FaRDtBQWFELEtBZEQ7QUFlQUYsV0FBT1EsSUFBUCxDQUFZWixVQUFVYSxlQUF0QjtBQUNBLFdBQU9ULE1BQVA7QUFDRDtBQXBCZU4sUUFBQUcsVUFBQSxHQUFVQSxVQUFWIiwiZmlsZSI6Im1hdGNoL3Rvb2xtYXRjaGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEBmaWxlIHRvb2xtYXRjaGVyXHJcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LnRvb2xtYXRjaGVyXHJcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXHJcbiAqXHJcbiAqIE1hdGNoIGEgdG9vbCByZWNvcmQgb24gYSBzZW50ZW5jZSxcclxuICpcclxuICogVGhpcyB3aWxsIHVuaWZ5IG1hdGNoaW5nIHJlcXVpcmVkIGFuZCBvcHRpb25hbCBjYXRlZ29yeSB3b3Jkc1xyXG4gKiB3aXRoIHRoZSByZXF1aXJlbWVudHMgb2YgdGhlIHRvb2wuXHJcbiAqXHJcbiAqL1xyXG5cclxuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxyXG5cclxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xyXG5cclxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XHJcblxyXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuLi91dGlscy91dGlscyc7XHJcblxyXG5cclxuaW1wb3J0ICogYXMgU2VudGVuY2UgZnJvbSAnLi9zZW50ZW5jZSc7XHJcbmltcG9ydCAqIGFzIE9wc1dvcmQgZnJvbSAnLi93b3JkJztcclxuXHJcbmNvbnN0IFdvcmQgPSBPcHNXb3JkLldvcmQ7XHJcbmNvbnN0IENhdGVnb3J5ID0gT3BzV29yZC5DYXRlZ29yeTtcclxuXHJcbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ3Rvb2xtYXRjaGVyJyk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWF0Y2hUb29sKG9TZW50ZW5jZTogSU1hdGNoLklTZW50ZW5jZSwgb1Rvb2w6IElNYXRjaC5JVG9vbCk6IElNYXRjaC5JVG9vbE1hdGNoUmVzdWx0IHtcclxuICB2YXIgdXNlZCA9IHt9IGFzIHsgW2tleTogbnVtYmVyXTogbnVtYmVyIH07XHJcbiAgdmFyIHJlcXVpcmVkID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBJTWF0Y2guSVdvcmQgfTtcclxuICB2YXIgb3B0aW9uYWwgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5JV29yZCB9O1xyXG4gIHZhciBtYXRjaGVkID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcclxuICB2YXIgc3B1cmlvdXMgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9O1xyXG4gIHZhciB0b29sbWVudGlvbmVkID0gW10gYXMgQXJyYXk8SU1hdGNoLklXb3JkPjtcclxuICBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcyB8fCB7fSkuZm9yRWFjaChmdW5jdGlvbiAoc0NhdGVnb3J5OiBzdHJpbmcpIHtcclxuICAgIGxldCB7IHdvcmQsIGluZGV4IH0gPSBTZW50ZW5jZS5maW5kV29yZEJ5Q2F0ZWdvcnkob1NlbnRlbmNlLCBzQ2F0ZWdvcnkpO1xyXG4gICAgaWYgKHdvcmQpIHtcclxuICAgICAgbWF0Y2hlZFt3b3JkIGFzIGFueV0gPSBcInJlcXVpcmVkXCI7XHJcbiAgICAgIHVzZWRbaW5kZXhdID0gMTtcclxuICAgICAgcmVxdWlyZWRbc0NhdGVnb3J5XSA9IHdvcmQ7XHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgT2JqZWN0LmtleXMob1Rvb2wub3B0aW9uYWwgfHwge30pLmZvckVhY2goZnVuY3Rpb24gKHNDYXRlZ29yeTogc3RyaW5nKSB7XHJcbiAgICB2YXIgeyB3b3JkLCBpbmRleCB9ID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KTtcclxuICAgIGlmICh3b3JkKSB7XHJcbiAgICAgIG1hdGNoZWRbd29yZCBhcyBhbnldID0gXCJvcHRpb25hbFwiO1xyXG4gICAgICB1c2VkW2luZGV4XSA9IDE7XHJcbiAgICAgIG9wdGlvbmFsW3NDYXRlZ29yeV0gPSB3b3JkO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBvU2VudGVuY2UuZm9yRWFjaChmdW5jdGlvbiAob1dvcmQsIGluZGV4KSB7XHJcbiAgICBpZiAoIXVzZWRbaW5kZXhdICYmICFXb3JkLmlzRmlsbGVyKG9Xb3JkKSAmJiAhV29yZC5pc0NhdGVnb3J5KG9Xb3JkKSkge1xyXG4gICAgICBkZWJ1Z2xvZyhcImhhdmUgc3B1cmlvdXMgd29yZFwiICsgSlNPTi5zdHJpbmdpZnkob1dvcmQpKTtcclxuICAgICAgc3B1cmlvdXNbb1dvcmQubWF0Y2hlZFN0cmluZ10gPSAxO1xyXG4gICAgfVxyXG4gICAgaWYgKCF1c2VkW2luZGV4XSAmJiBvV29yZC5jYXRlZ29yeSA9PT0gQ2F0ZWdvcnkuQ0FUX1RPT0wgJiYgb1dvcmQubWF0Y2hlZFN0cmluZyA9PT0gb1Rvb2wubmFtZSApIHtcclxuICAgICAgdG9vbG1lbnRpb25lZC5wdXNoKG9Xb3JkKTtcclxuICAgIH1cclxuICB9KTtcclxuICBkZWJ1Z2xvZygnc2F0aXNmaWVkIDogJyArIE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzKS5qb2luKFwiO1wiKSk7XHJcbiAgZGVidWdsb2coJ3JlcXVpcmVkICA6ICcgKyBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcykuam9pbihcIjtcIikpO1xyXG4gIHZhciBtaXNzaW5nID0gdXRpbHMuQXJyYXlVdGlscy5zZXRNaW51cyhPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcyksIE9iamVjdC5rZXlzKHJlcXVpcmVkKSkucmVkdWNlKFxyXG4gICAgZnVuY3Rpb24gKG1hcCwgc0tleSkge1xyXG4gICAgICBtYXBbc0tleV0gPSAxO1xyXG4gICAgICByZXR1cm4gbWFwO1xyXG4gICAgfSwge30pXHJcblxyXG4gIHJldHVybiB7XHJcbiAgICByZXF1aXJlZDogcmVxdWlyZWQsXHJcbiAgICBtaXNzaW5nOiBtaXNzaW5nLFxyXG4gICAgb3B0aW9uYWw6IG9wdGlvbmFsLFxyXG4gICAgc3B1cmlvdXM6IHNwdXJpb3VzLFxyXG4gICAgdG9vbG1lbnRpb25lZCA6IHRvb2xtZW50aW9uZWRcclxuICB9XHJcbn1cclxuXHJcbmltcG9ydCAqIGFzIG1hdGNoIGZyb20gJy4vbWF0Y2gnO1xyXG5cclxuY29uc3QgVG9vbE1hdGNoID0gbWF0Y2guVG9vbE1hdGNoO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoVG9vbHMoYVNlbnRlbmNlczogQXJyYXk8SU1hdGNoLklTZW50ZW5jZT4sIGFUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcclxuICAvL3ZhciBzdHJlYW0gPSBuZXcgc3RyZWFtdXRpbHMuTWF0Y2hTdHJlYW0oKTtcclxuICB2YXIgcmVzdWx0ID0gW107XHJcbiAgYVRvb2wuZm9yRWFjaChmdW5jdGlvbiAob1Rvb2wpIHtcclxuICAgIGFTZW50ZW5jZXMuZm9yRWFjaChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XHJcbiAgICAgIHZhciB0b29sbWF0Y2hyZXN1bHQgPSBtYXRjaFRvb2wob1NlbnRlbmNlLCBvVG9vbCk7XHJcbiAgICAgIHZhciB0b29sbWF0Y2ggPSB7XHJcbiAgICAgICAgdG9vbG1hdGNocmVzdWx0OiB0b29sbWF0Y2hyZXN1bHQsXHJcbiAgICAgICAgc2VudGVuY2U6IG9TZW50ZW5jZSxcclxuICAgICAgICB0b29sIDogb1Rvb2wsXHJcbiAgICAgICAgcmFuayA6IDBcclxuICAgICAgfTtcclxuICAgICAgdG9vbG1hdGNoLnJhbmsgPSBUb29sTWF0Y2gucmFua1Jlc3VsdCh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0KTtcclxuICAgICAgaWYgKFRvb2xNYXRjaC5pc0FueU1hdGNoKHRvb2xtYXRjaCkpIHtcclxuICAgICAgICByZXN1bHQucHVzaCh0b29sbWF0Y2gpO1xyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH0pO1xyXG4gIHJlc3VsdC5zb3J0KFRvb2xNYXRjaC5jb21wQmV0dGVyTWF0Y2gpO1xyXG4gIHJldHVybiByZXN1bHQ7XHJcbn0iLCIvKipcbiAqIEBmaWxlIHRvb2xtYXRjaGVyXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC50b29sbWF0Y2hlclxuICogQGNvcHlyaWdodCAoYykgR2VyZCBGb3JzdG1hbm5cbiAqXG4gKiBNYXRjaCBhIHRvb2wgcmVjb3JkIG9uIGEgc2VudGVuY2UsXG4gKlxuICogVGhpcyB3aWxsIHVuaWZ5IG1hdGNoaW5nIHJlcXVpcmVkIGFuZCBvcHRpb25hbCBjYXRlZ29yeSB3b3Jkc1xuICogd2l0aCB0aGUgcmVxdWlyZW1lbnRzIG9mIHRoZSB0b29sLlxuICpcbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG4vLyAvIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL2xpYi9ub2RlLTQuZC50c1wiIC8+XG5jb25zdCBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG5jb25zdCB1dGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzJyk7XG5jb25zdCBTZW50ZW5jZSA9IHJlcXVpcmUoJy4vc2VudGVuY2UnKTtcbmNvbnN0IE9wc1dvcmQgPSByZXF1aXJlKCcuL3dvcmQnKTtcbmNvbnN0IFdvcmQgPSBPcHNXb3JkLldvcmQ7XG5jb25zdCBDYXRlZ29yeSA9IE9wc1dvcmQuQ2F0ZWdvcnk7XG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2hlcicpO1xuZnVuY3Rpb24gbWF0Y2hUb29sKG9TZW50ZW5jZSwgb1Rvb2wpIHtcbiAgICB2YXIgdXNlZCA9IHt9O1xuICAgIHZhciByZXF1aXJlZCA9IHt9O1xuICAgIHZhciBvcHRpb25hbCA9IHt9O1xuICAgIHZhciBtYXRjaGVkID0ge307XG4gICAgdmFyIHNwdXJpb3VzID0ge307XG4gICAgdmFyIHRvb2xtZW50aW9uZWQgPSBbXTtcbiAgICBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcyB8fCB7fSkuZm9yRWFjaChmdW5jdGlvbiAoc0NhdGVnb3J5KSB7XG4gICAgICAgIGxldCB7IHdvcmQsIGluZGV4IH0gPSBTZW50ZW5jZS5maW5kV29yZEJ5Q2F0ZWdvcnkob1NlbnRlbmNlLCBzQ2F0ZWdvcnkpO1xuICAgICAgICBpZiAod29yZCkge1xuICAgICAgICAgICAgbWF0Y2hlZFt3b3JkXSA9IFwicmVxdWlyZWRcIjtcbiAgICAgICAgICAgIHVzZWRbaW5kZXhdID0gMTtcbiAgICAgICAgICAgIHJlcXVpcmVkW3NDYXRlZ29yeV0gPSB3b3JkO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgT2JqZWN0LmtleXMob1Rvb2wub3B0aW9uYWwgfHwge30pLmZvckVhY2goZnVuY3Rpb24gKHNDYXRlZ29yeSkge1xuICAgICAgICB2YXIgeyB3b3JkLCBpbmRleCB9ID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KTtcbiAgICAgICAgaWYgKHdvcmQpIHtcbiAgICAgICAgICAgIG1hdGNoZWRbd29yZF0gPSBcIm9wdGlvbmFsXCI7XG4gICAgICAgICAgICB1c2VkW2luZGV4XSA9IDE7XG4gICAgICAgICAgICBvcHRpb25hbFtzQ2F0ZWdvcnldID0gd29yZDtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIG9TZW50ZW5jZS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZCwgaW5kZXgpIHtcbiAgICAgICAgaWYgKCF1c2VkW2luZGV4XSAmJiAhV29yZC5pc0ZpbGxlcihvV29yZCkgJiYgIVdvcmQuaXNDYXRlZ29yeShvV29yZCkpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiaGF2ZSBzcHVyaW91cyB3b3JkXCIgKyBKU09OLnN0cmluZ2lmeShvV29yZCkpO1xuICAgICAgICAgICAgc3B1cmlvdXNbb1dvcmQubWF0Y2hlZFN0cmluZ10gPSAxO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdXNlZFtpbmRleF0gJiYgb1dvcmQuY2F0ZWdvcnkgPT09IENhdGVnb3J5LkNBVF9UT09MICYmIG9Xb3JkLm1hdGNoZWRTdHJpbmcgPT09IG9Ub29sLm5hbWUpIHtcbiAgICAgICAgICAgIHRvb2xtZW50aW9uZWQucHVzaChvV29yZCk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBkZWJ1Z2xvZygnc2F0aXNmaWVkIDogJyArIE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzKS5qb2luKFwiO1wiKSk7XG4gICAgZGVidWdsb2coJ3JlcXVpcmVkICA6ICcgKyBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcykuam9pbihcIjtcIikpO1xuICAgIHZhciBtaXNzaW5nID0gdXRpbHMuQXJyYXlVdGlscy5zZXRNaW51cyhPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcyksIE9iamVjdC5rZXlzKHJlcXVpcmVkKSkucmVkdWNlKGZ1bmN0aW9uIChtYXAsIHNLZXkpIHtcbiAgICAgICAgbWFwW3NLZXldID0gMTtcbiAgICAgICAgcmV0dXJuIG1hcDtcbiAgICB9LCB7fSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkLFxuICAgICAgICBtaXNzaW5nOiBtaXNzaW5nLFxuICAgICAgICBvcHRpb25hbDogb3B0aW9uYWwsXG4gICAgICAgIHNwdXJpb3VzOiBzcHVyaW91cyxcbiAgICAgICAgdG9vbG1lbnRpb25lZDogdG9vbG1lbnRpb25lZFxuICAgIH07XG59XG5leHBvcnRzLm1hdGNoVG9vbCA9IG1hdGNoVG9vbDtcbmNvbnN0IG1hdGNoID0gcmVxdWlyZSgnLi9tYXRjaCcpO1xuY29uc3QgVG9vbE1hdGNoID0gbWF0Y2guVG9vbE1hdGNoO1xuZnVuY3Rpb24gbWF0Y2hUb29scyhhU2VudGVuY2VzLCBhVG9vbCkge1xuICAgIC8vdmFyIHN0cmVhbSA9IG5ldyBzdHJlYW11dGlscy5NYXRjaFN0cmVhbSgpO1xuICAgIHZhciByZXN1bHQgPSBbXTtcbiAgICBhVG9vbC5mb3JFYWNoKGZ1bmN0aW9uIChvVG9vbCkge1xuICAgICAgICBhU2VudGVuY2VzLmZvckVhY2goZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgdmFyIHRvb2xtYXRjaHJlc3VsdCA9IG1hdGNoVG9vbChvU2VudGVuY2UsIG9Ub29sKTtcbiAgICAgICAgICAgIHZhciB0b29sbWF0Y2ggPSB7XG4gICAgICAgICAgICAgICAgdG9vbG1hdGNocmVzdWx0OiB0b29sbWF0Y2hyZXN1bHQsXG4gICAgICAgICAgICAgICAgc2VudGVuY2U6IG9TZW50ZW5jZSxcbiAgICAgICAgICAgICAgICB0b29sOiBvVG9vbCxcbiAgICAgICAgICAgICAgICByYW5rOiAwXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdG9vbG1hdGNoLnJhbmsgPSBUb29sTWF0Y2gucmFua1Jlc3VsdCh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0KTtcbiAgICAgICAgICAgIGlmIChUb29sTWF0Y2guaXNBbnlNYXRjaCh0b29sbWF0Y2gpKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godG9vbG1hdGNoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmVzdWx0LnNvcnQoVG9vbE1hdGNoLmNvbXBCZXR0ZXJNYXRjaCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbmV4cG9ydHMubWF0Y2hUb29scyA9IG1hdGNoVG9vbHM7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
