/**
 * Functionality to execute a certain response
 *
 * via a) commandline (e.g. browser startup)
 * @file
 */
"use strict";

var debug = require('debug');
var IFMatch = require('../match/ifmatch');
var debuglog = debug('dispatcher');
var child_process_1 = require('child_process');
var Match = require('../match/match');
(function (EnumResponseCode) {
    EnumResponseCode[EnumResponseCode["NOMATCH"] = 0] = "NOMATCH";
    EnumResponseCode[EnumResponseCode["EXEC"] = 1] = "EXEC";
    EnumResponseCode[EnumResponseCode["QUERY"] = 2] = "QUERY";
})(exports.EnumResponseCode || (exports.EnumResponseCode = {}));
var EnumResponseCode = exports.EnumResponseCode;
/**
 * Defines the interface for an analysis
 * reponse
 */
/*
export interface IResponse {
  rating : number,
  type : EnumResponseCode,
  query : string,
  context : { [key:string] :string},
  text : string,
  action : IAction,
  prompts : { [key :string ] : { text : string, description : any }; }


export const enum EnumActionType {
  STARTURL,
  STARTCMDLINE
}

export interface IAction {
  data : any,
  type : EnumActionType,
  pattern : string,
  concrete : string
}
}*/
//var exec = require('child_process').exec
function startBrowser(oUrlAction) {
    var cmd = '"%ProgramFiles(x86)%\\Google\\Chrome\\Application\\chrome.exe" --incognito -url "' + oUrlAction.concrete + '"';
    child_process_1.exec(cmd, function (error, stdout, stderr) {
        if (error) {
            console.error("exec error: " + error);
            return;
        }
        console.log("stdout: " + stdout);
        console.log("stderr: " + stderr);
    });
}
function startCommandLine(scmd) {
    var cmd = scmd.concrete;
    child_process_1.exec(cmd, function (error, stdout, stderr) {
        if (error) {
            console.error("exec error: " + error);
            return;
        }
        console.log("stdout: " + stdout);
        console.log("stderr: " + stderr);
    });
}
function expandContextIntoAction(oResult) {
    var pattern = oResult.action.pattern;
    Object.keys(oResult.context).forEach(function (sKey) {
        var regex = new RegExp('{' + sKey + '}', 'g');
        pattern = pattern.replace(regex, oResult.context[sKey]);
        pattern = pattern.replace(regex, oResult.context[sKey]);
    });
    oResult.action.concrete = pattern;
    return pattern;
}
exports.expandContextIntoAction = expandContextIntoAction;
/**
 * execute some starupt
 *
 */
function executeStartup(oResult, cb) {
    if (oResult.type !== 1 /* EXEC */) {
            return;
        }
    var action = oResult.action;
    if (oResult.action.type === 0 /* STARTURL */) {
            //var ptn = expandParametersInURL(oResult)
            startBrowser(action);
            return action.concrete;
        } else if (oResult.action.type === 1 /* STARTCMDLINE */) {
            startCommandLine(action);
        } else {
        var s = "Don't know how to start " + oResult.type + '\n for "' + oResult.query + '"';
        console.error(s);
        return s;
    }
}
function expandParametersInURL(oMergedContextResult) {
    var ptn = oMergedContextResult.result.pattern;
    Object.keys(oMergedContextResult.context).forEach(function (sKey) {
        var regex = new RegExp('{' + sKey + '}', 'g');
        ptn = ptn.replace(regex, oMergedContextResult.context[sKey]);
        ptn = ptn.replace(regex, oMergedContextResult.context[sKey]);
    });
    return ptn;
}
function execTool(match) {
    return "can execute" + match.tool.name + " " + Match.ToolMatch.dumpNice(match);
    // TODO invoke tool specific starter
    /* if (oMergedContextResult.result.type === 'URL') {
      var ptn = expandParametersInURL(oMergedContextResult)
      startBrowser(ptn)
      return ptn
    } else {
      var s = ("Don't know how to start " + oMergedContextResult.result.type + '\n for "' + oMergedContextResult.query + '"')
      debuglog(s)
      return s
    }*/
}
exports.execTool = execTool;
//  executeStartup: executeStartup
//}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leGVjL2V4ZWMudHMiLCJleGVjL2V4ZWMuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiSUZNYXRjaCIsImRlYnVnbG9nIiwiY2hpbGRfcHJvY2Vzc18xIiwiTWF0Y2giLCJFbnVtUmVzcG9uc2VDb2RlIiwiZXhwb3J0cyIsInN0YXJ0QnJvd3NlciIsIm9VcmxBY3Rpb24iLCJjbWQiLCJjb25jcmV0ZSIsImV4ZWMiLCJlcnJvciIsInN0ZG91dCIsInN0ZGVyciIsImNvbnNvbGUiLCJsb2ciLCJzdGFydENvbW1hbmRMaW5lIiwic2NtZCIsImV4cGFuZENvbnRleHRJbnRvQWN0aW9uIiwib1Jlc3VsdCIsInBhdHRlcm4iLCJhY3Rpb24iLCJPYmplY3QiLCJrZXlzIiwiY29udGV4dCIsImZvckVhY2giLCJzS2V5IiwicmVnZXgiLCJSZWdFeHAiLCJyZXBsYWNlIiwiZXhlY3V0ZVN0YXJ0dXAiLCJjYiIsInR5cGUiLCJzIiwicXVlcnkiLCJleHBhbmRQYXJhbWV0ZXJzSW5VUkwiLCJvTWVyZ2VkQ29udGV4dFJlc3VsdCIsInB0biIsInJlc3VsdCIsImV4ZWNUb29sIiwibWF0Y2giLCJ0b29sIiwibmFtZSIsIlRvb2xNYXRjaCIsImR1bXBOaWNlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FDTUE7O0FER0EsSUFBWUEsUUFBS0MsUUFBTSxPQUFOLENBQWpCO0FBRUEsSUFBYUMsVUFBT0QsUUFBTSxrQkFBTixDQUFwQjtBQUVBLElBQU1FLFdBQVdILE1BQU0sWUFBTixDQUFqQjtBQUVBLElBQUFJLGtCQUFBSCxRQUFxQixlQUFyQixDQUFBO0FBR0EsSUFBWUksUUFBS0osUUFBTSxnQkFBTixDQUFqQjtBQUdBLENBQUEsVUFBa0JLLGdCQUFsQixFQUFrQztBQUNoQ0EscUJBQUFBLGlCQUFBLFNBQUEsSUFBQSxDQUFBLElBQUEsU0FBQTtBQUNBQSxxQkFBQUEsaUJBQUEsTUFBQSxJQUFBLENBQUEsSUFBQSxNQUFBO0FBQ0FBLHFCQUFBQSxp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b0Q7QUFDbEQsUUFBSUMsTUFBTUQscUJBQXFCRSxNQUFyQixDQUE0QmxCLE9BQXRDO0FBQ0FFLFdBQU9DLElBQVAsQ0FBWWEscUJBQXFCWixPQUFqQyxFQUEwQ0MsT0FBMUMsQ0FBa0QsVUFBVUMsSUFBVixFQUFjO0FBQzlELFlBQUlDLFFBQVEsSUFBSUMsTUFBSixDQUFXLE1BQU1GLElBQU4sR0FBYSxHQUF4QixFQUE2QixHQUE3QixDQUFaO0FBQ0FXLGNBQU1BLElBQUlSLE9BQUosQ0FBWUYsS0FBWixFQUFtQlMscUJBQXFCWixPQUFyQixDQUE2QkUsSUFBN0IsQ0FBbkIsQ0FBTjtBQUNBVyxjQUFNQSxJQUFJUixPQUFKLENBQVlGLEtBQVosRUFBbUJTLHFCQUFxQlosT0FBckIsQ0FBNkJFLElBQTdCLENBQW5CLENBQU47QUFDRCxLQUpEO0FBS0EsV0FBT1csR0FBUDtBQUNEO0FBRUgsU0FBQUUsUUFBQSxDQUF5QkMsS0FBekIsRUFBaUQ7QUFDN0MsV0FBTyxnQkFBZ0JBLE1BQU1DLElBQU4sQ0FBV0MsSUFBM0IsR0FBa0MsR0FBbEMsR0FDUHZDLE1BQU13QyxTQUFOLENBQWdCQyxRQUFoQixDQUF5QkosS0FBekIsQ0FEQTtBQUdBO0FBQ0E7Ozs7Ozs7OztBQVNEO0FBZGFuQyxRQUFBa0MsUUFBQSxHQUFRQSxRQUFSO0FBaUJoQjtBQUNBIiwiZmlsZSI6ImV4ZWMvZXhlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBGdW5jdGlvbmFsaXR5IHRvIGV4ZWN1dGUgYSBjZXJ0YWluIHJlc3BvbnNlXHJcbiAqXHJcbiAqIHZpYSBhKSBjb21tYW5kbGluZSAoZS5nLiBicm93c2VyIHN0YXJ0dXApXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5cclxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xyXG5cclxuaW1wb3J0ICogIGFzIElGTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XHJcblxyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdkaXNwYXRjaGVyJylcclxuXHJcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcclxuXHJcbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvbWF0Y2gnO1xyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBlbnVtIEVudW1SZXNwb25zZUNvZGUge1xyXG4gIE5PTUFUQ0ggPSAwLFxyXG4gIEVYRUMsXHJcbiAgUVVFUllcclxufVxyXG5cclxuLyoqXHJcbiAqIERlZmluZXMgdGhlIGludGVyZmFjZSBmb3IgYW4gYW5hbHlzaXNcclxuICogcmVwb25zZVxyXG4gKi9cclxuLypcclxuZXhwb3J0IGludGVyZmFjZSBJUmVzcG9uc2Uge1xyXG4gIHJhdGluZyA6IG51bWJlcixcclxuICB0eXBlIDogRW51bVJlc3BvbnNlQ29kZSxcclxuICBxdWVyeSA6IHN0cmluZyxcclxuICBjb250ZXh0IDogeyBba2V5OnN0cmluZ10gOnN0cmluZ30sXHJcbiAgdGV4dCA6IHN0cmluZyxcclxuICBhY3Rpb24gOiBJQWN0aW9uLFxyXG4gIHByb21wdHMgOiB7IFtrZXkgOnN0cmluZyBdIDogeyB0ZXh0IDogc3RyaW5nLCBkZXNjcmlwdGlvbiA6IGFueSB9OyB9XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IGVudW0gRW51bUFjdGlvblR5cGUge1xyXG4gIFNUQVJUVVJMLFxyXG4gIFNUQVJUQ01ETElORVxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElBY3Rpb24ge1xyXG4gIGRhdGEgOiBhbnksXHJcbiAgdHlwZSA6IEVudW1BY3Rpb25UeXBlLFxyXG4gIHBhdHRlcm4gOiBzdHJpbmcsXHJcbiAgY29uY3JldGUgOiBzdHJpbmdcclxufVxyXG59Ki9cclxuXHJcbi8vdmFyIGV4ZWMgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZXhlY1xyXG5cclxuZnVuY3Rpb24gc3RhcnRCcm93c2VyIChvVXJsQWN0aW9uIDogSUZNYXRjaC5JQWN0aW9uKSB7XHJcbiAgdmFyIGNtZCA9XHJcbiAgJ1wiJVByb2dyYW1GaWxlcyh4ODYpJVxcXFxHb29nbGVcXFxcQ2hyb21lXFxcXEFwcGxpY2F0aW9uXFxcXGNocm9tZS5leGVcIiAtLWluY29nbml0byAtdXJsIFwiJyArIG9VcmxBY3Rpb24uY29uY3JldGUgKyAnXCInXHJcbiAgZXhlYyhjbWQsIGZ1bmN0aW9uIChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcclxuICAgIGlmIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGBleGVjIGVycm9yOiAke2Vycm9yfWApXHJcbiAgICAgIHJldHVyblxyXG4gICAgfVxyXG4gICAgY29uc29sZS5sb2coYHN0ZG91dDogJHtzdGRvdXR9YClcclxuICAgIGNvbnNvbGUubG9nKGBzdGRlcnI6ICR7c3RkZXJyfWApXHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gc3RhcnRDb21tYW5kTGluZSAoc2NtZCA6IElGTWF0Y2guSUFjdGlvbikge1xyXG4gIHZhciBjbWQgPSBzY21kLmNvbmNyZXRlO1xyXG4gIGV4ZWMoY21kLCBmdW5jdGlvbiAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XHJcbiAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihgZXhlYyBlcnJvcjogJHtlcnJvcn1gKVxyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuICAgIGNvbnNvbGUubG9nKGBzdGRvdXQ6ICR7c3Rkb3V0fWApXHJcbiAgICBjb25zb2xlLmxvZyhgc3RkZXJyOiAke3N0ZGVycn1gKVxyXG4gIH0pXHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhwYW5kQ29udGV4dEludG9BY3Rpb24gKG9SZXN1bHQgOiBJRk1hdGNoLklSZXNwb25zZSkge1xyXG4gIHZhciBwYXR0ZXJuID0gb1Jlc3VsdC5hY3Rpb24ucGF0dGVyblxyXG4gIE9iamVjdC5rZXlzKG9SZXN1bHQuY29udGV4dCkuZm9yRWFjaChmdW5jdGlvbiAoc0tleSkge1xyXG4gICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgneycgKyBzS2V5ICsgJ30nLCAnZycpXHJcbiAgICBwYXR0ZXJuID0gcGF0dGVybi5yZXBsYWNlKHJlZ2V4LCBvUmVzdWx0LmNvbnRleHRbc0tleV0pXHJcbiAgICBwYXR0ZXJuID0gcGF0dGVybi5yZXBsYWNlKHJlZ2V4LCBvUmVzdWx0LmNvbnRleHRbc0tleV0pXHJcbiAgfSlcclxuICBvUmVzdWx0LmFjdGlvbi5jb25jcmV0ZSA9IHBhdHRlcm47XHJcbiAgcmV0dXJuIHBhdHRlcm5cclxufVxyXG5cclxuLyoqXHJcbiAqIGV4ZWN1dGUgc29tZSBzdGFydXB0XHJcbiAqXHJcbiAqL1xyXG5mdW5jdGlvbiBleGVjdXRlU3RhcnR1cCAob1Jlc3VsdDogSUZNYXRjaC5JUmVzcG9uc2UsIGNiOiAoZXJyIDogYW55LCBhIDogSUZNYXRjaC5JUmVzcG9uc2UpID0+IHN0cmluZykge1xyXG4gIGlmIChvUmVzdWx0LnR5cGUgIT09IElGTWF0Y2guRW51bVJlc3BvbnNlQ29kZS5FWEVDKSB7XHJcbiAgICByZXR1cm5cclxuICB9XHJcbiAgdmFyIGFjdGlvbiA9IG9SZXN1bHQuYWN0aW9uO1xyXG4gIGlmKG9SZXN1bHQuYWN0aW9uLnR5cGUgPT09IElGTWF0Y2guRW51bUFjdGlvblR5cGUuU1RBUlRVUkwpIHtcclxuICAgIC8vdmFyIHB0biA9IGV4cGFuZFBhcmFtZXRlcnNJblVSTChvUmVzdWx0KVxyXG4gICAgc3RhcnRCcm93c2VyKGFjdGlvbilcclxuICAgIHJldHVybiBhY3Rpb24uY29uY3JldGVcclxuICB9IGVsc2UgaWYob1Jlc3VsdC5hY3Rpb24udHlwZSA9PT0gSUZNYXRjaC5FbnVtQWN0aW9uVHlwZS5TVEFSVENNRExJTkUpIHtcclxuICAgIHN0YXJ0Q29tbWFuZExpbmUoYWN0aW9uKTtcclxuICB9IGVsc2Uge1xyXG4gICAgdmFyIHMgPSAoXCJEb24ndCBrbm93IGhvdyB0byBzdGFydCBcIiArIG9SZXN1bHQudHlwZSArICdcXG4gZm9yIFwiJyArIG9SZXN1bHQucXVlcnkgKyAnXCInKVxyXG4gICAgY29uc29sZS5lcnJvcihzKVxyXG4gICAgcmV0dXJuIHNcclxuICB9XHJcbn1cclxuXHJcblxyXG4gIGZ1bmN0aW9uIGV4cGFuZFBhcmFtZXRlcnNJblVSTCAob01lcmdlZENvbnRleHRSZXN1bHQpIHtcclxuICAgIHZhciBwdG4gPSBvTWVyZ2VkQ29udGV4dFJlc3VsdC5yZXN1bHQucGF0dGVyblxyXG4gICAgT2JqZWN0LmtleXMob01lcmdlZENvbnRleHRSZXN1bHQuY29udGV4dCkuZm9yRWFjaChmdW5jdGlvbiAoc0tleSkge1xyXG4gICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCd7JyArIHNLZXkgKyAnfScsICdnJylcclxuICAgICAgcHRuID0gcHRuLnJlcGxhY2UocmVnZXgsIG9NZXJnZWRDb250ZXh0UmVzdWx0LmNvbnRleHRbc0tleV0pXHJcbiAgICAgIHB0biA9IHB0bi5yZXBsYWNlKHJlZ2V4LCBvTWVyZ2VkQ29udGV4dFJlc3VsdC5jb250ZXh0W3NLZXldKVxyXG4gICAgfSlcclxuICAgIHJldHVybiBwdG5cclxuICB9XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhlY1Rvb2wobWF0Y2g6IElNYXRjaC5JVG9vbE1hdGNoKSA6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gXCJjYW4gZXhlY3V0ZVwiICsgbWF0Y2gudG9vbC5uYW1lICsgXCIgXCIgK1xyXG4gICAgTWF0Y2guVG9vbE1hdGNoLmR1bXBOaWNlKG1hdGNoKTtcclxuXHJcbiAgICAvLyBUT0RPIGludm9rZSB0b29sIHNwZWNpZmljIHN0YXJ0ZXJcclxuICAgIC8qIGlmIChvTWVyZ2VkQ29udGV4dFJlc3VsdC5yZXN1bHQudHlwZSA9PT0gJ1VSTCcpIHtcclxuICAgICAgdmFyIHB0biA9IGV4cGFuZFBhcmFtZXRlcnNJblVSTChvTWVyZ2VkQ29udGV4dFJlc3VsdClcclxuICAgICAgc3RhcnRCcm93c2VyKHB0bilcclxuICAgICAgcmV0dXJuIHB0blxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFyIHMgPSAoXCJEb24ndCBrbm93IGhvdyB0byBzdGFydCBcIiArIG9NZXJnZWRDb250ZXh0UmVzdWx0LnJlc3VsdC50eXBlICsgJ1xcbiBmb3IgXCInICsgb01lcmdlZENvbnRleHRSZXN1bHQucXVlcnkgKyAnXCInKVxyXG4gICAgICBkZWJ1Z2xvZyhzKVxyXG4gICAgICByZXR1cm4gc1xyXG4gICAgfSovXHJcbiAgfVxyXG5cclxuXHJcbi8vICBleGVjdXRlU3RhcnR1cDogZXhlY3V0ZVN0YXJ0dXBcclxuLy99XHJcbiIsIi8qKlxuICogRnVuY3Rpb25hbGl0eSB0byBleGVjdXRlIGEgY2VydGFpbiByZXNwb25zZVxuICpcbiAqIHZpYSBhKSBjb21tYW5kbGluZSAoZS5nLiBicm93c2VyIHN0YXJ0dXApXG4gKiBAZmlsZVxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgSUZNYXRjaCA9IHJlcXVpcmUoJy4uL21hdGNoL2lmbWF0Y2gnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdkaXNwYXRjaGVyJyk7XG52YXIgY2hpbGRfcHJvY2Vzc18xID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xudmFyIE1hdGNoID0gcmVxdWlyZSgnLi4vbWF0Y2gvbWF0Y2gnKTtcbihmdW5jdGlvbiAoRW51bVJlc3BvbnNlQ29kZSkge1xuICAgIEVudW1SZXNwb25zZUNvZGVbRW51bVJlc3BvbnNlQ29kZVtcIk5PTUFUQ0hcIl0gPSAwXSA9IFwiTk9NQVRDSFwiO1xuICAgIEVudW1SZXNwb25zZUNvZGVbRW51bVJlc3BvbnNlQ29kZVtcIkVYRUNcIl0gPSAxXSA9IFwiRVhFQ1wiO1xuICAgIEVudW1SZXNwb25zZUNvZGVbRW51bVJlc3BvbnNlQ29kZVtcIlFVRVJZXCJdID0gMl0gPSBcIlFVRVJZXCI7XG59KShleHBvcnRzLkVudW1SZXNwb25zZUNvZGUgfHwgKGV4cG9ydHMuRW51bVJlc3BvbnNlQ29kZSA9IHt9KSk7XG52YXIgRW51bVJlc3BvbnNlQ29kZSA9IGV4cG9ydHMuRW51bVJlc3BvbnNlQ29kZTtcbi8qKlxuICogRGVmaW5lcyB0aGUgaW50ZXJmYWNlIGZvciBhbiBhbmFseXNpc1xuICogcmVwb25zZVxuICovXG4vKlxuZXhwb3J0IGludGVyZmFjZSBJUmVzcG9uc2Uge1xuICByYXRpbmcgOiBudW1iZXIsXG4gIHR5cGUgOiBFbnVtUmVzcG9uc2VDb2RlLFxuICBxdWVyeSA6IHN0cmluZyxcbiAgY29udGV4dCA6IHsgW2tleTpzdHJpbmddIDpzdHJpbmd9LFxuICB0ZXh0IDogc3RyaW5nLFxuICBhY3Rpb24gOiBJQWN0aW9uLFxuICBwcm9tcHRzIDogeyBba2V5IDpzdHJpbmcgXSA6IHsgdGV4dCA6IHN0cmluZywgZGVzY3JpcHRpb24gOiBhbnkgfTsgfVxuXG5cbmV4cG9ydCBjb25zdCBlbnVtIEVudW1BY3Rpb25UeXBlIHtcbiAgU1RBUlRVUkwsXG4gIFNUQVJUQ01ETElORVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElBY3Rpb24ge1xuICBkYXRhIDogYW55LFxuICB0eXBlIDogRW51bUFjdGlvblR5cGUsXG4gIHBhdHRlcm4gOiBzdHJpbmcsXG4gIGNvbmNyZXRlIDogc3RyaW5nXG59XG59Ki9cbi8vdmFyIGV4ZWMgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZXhlY1xuZnVuY3Rpb24gc3RhcnRCcm93c2VyKG9VcmxBY3Rpb24pIHtcbiAgICB2YXIgY21kID0gJ1wiJVByb2dyYW1GaWxlcyh4ODYpJVxcXFxHb29nbGVcXFxcQ2hyb21lXFxcXEFwcGxpY2F0aW9uXFxcXGNocm9tZS5leGVcIiAtLWluY29nbml0byAtdXJsIFwiJyArIG9VcmxBY3Rpb24uY29uY3JldGUgKyAnXCInO1xuICAgIGNoaWxkX3Byb2Nlc3NfMS5leGVjKGNtZCwgZnVuY3Rpb24gKGVycm9yLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJleGVjIGVycm9yOiBcIiArIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyhcInN0ZG91dDogXCIgKyBzdGRvdXQpO1xuICAgICAgICBjb25zb2xlLmxvZyhcInN0ZGVycjogXCIgKyBzdGRlcnIpO1xuICAgIH0pO1xufVxuZnVuY3Rpb24gc3RhcnRDb21tYW5kTGluZShzY21kKSB7XG4gICAgdmFyIGNtZCA9IHNjbWQuY29uY3JldGU7XG4gICAgY2hpbGRfcHJvY2Vzc18xLmV4ZWMoY21kLCBmdW5jdGlvbiAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcImV4ZWMgZXJyb3I6IFwiICsgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFwic3Rkb3V0OiBcIiArIHN0ZG91dCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwic3RkZXJyOiBcIiArIHN0ZGVycik7XG4gICAgfSk7XG59XG5mdW5jdGlvbiBleHBhbmRDb250ZXh0SW50b0FjdGlvbihvUmVzdWx0KSB7XG4gICAgdmFyIHBhdHRlcm4gPSBvUmVzdWx0LmFjdGlvbi5wYXR0ZXJuO1xuICAgIE9iamVjdC5rZXlzKG9SZXN1bHQuY29udGV4dCkuZm9yRWFjaChmdW5jdGlvbiAoc0tleSkge1xuICAgICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCd7JyArIHNLZXkgKyAnfScsICdnJyk7XG4gICAgICAgIHBhdHRlcm4gPSBwYXR0ZXJuLnJlcGxhY2UocmVnZXgsIG9SZXN1bHQuY29udGV4dFtzS2V5XSk7XG4gICAgICAgIHBhdHRlcm4gPSBwYXR0ZXJuLnJlcGxhY2UocmVnZXgsIG9SZXN1bHQuY29udGV4dFtzS2V5XSk7XG4gICAgfSk7XG4gICAgb1Jlc3VsdC5hY3Rpb24uY29uY3JldGUgPSBwYXR0ZXJuO1xuICAgIHJldHVybiBwYXR0ZXJuO1xufVxuZXhwb3J0cy5leHBhbmRDb250ZXh0SW50b0FjdGlvbiA9IGV4cGFuZENvbnRleHRJbnRvQWN0aW9uO1xuLyoqXG4gKiBleGVjdXRlIHNvbWUgc3RhcnVwdFxuICpcbiAqL1xuZnVuY3Rpb24gZXhlY3V0ZVN0YXJ0dXAob1Jlc3VsdCwgY2IpIHtcbiAgICBpZiAob1Jlc3VsdC50eXBlICE9PSAxIC8qIEVYRUMgKi8pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgYWN0aW9uID0gb1Jlc3VsdC5hY3Rpb247XG4gICAgaWYgKG9SZXN1bHQuYWN0aW9uLnR5cGUgPT09IDAgLyogU1RBUlRVUkwgKi8pIHtcbiAgICAgICAgLy92YXIgcHRuID0gZXhwYW5kUGFyYW1ldGVyc0luVVJMKG9SZXN1bHQpXG4gICAgICAgIHN0YXJ0QnJvd3NlcihhY3Rpb24pO1xuICAgICAgICByZXR1cm4gYWN0aW9uLmNvbmNyZXRlO1xuICAgIH1cbiAgICBlbHNlIGlmIChvUmVzdWx0LmFjdGlvbi50eXBlID09PSAxIC8qIFNUQVJUQ01ETElORSAqLykge1xuICAgICAgICBzdGFydENvbW1hbmRMaW5lKGFjdGlvbik7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICB2YXIgcyA9IChcIkRvbid0IGtub3cgaG93IHRvIHN0YXJ0IFwiICsgb1Jlc3VsdC50eXBlICsgJ1xcbiBmb3IgXCInICsgb1Jlc3VsdC5xdWVyeSArICdcIicpO1xuICAgICAgICBjb25zb2xlLmVycm9yKHMpO1xuICAgICAgICByZXR1cm4gcztcbiAgICB9XG59XG5mdW5jdGlvbiBleHBhbmRQYXJhbWV0ZXJzSW5VUkwob01lcmdlZENvbnRleHRSZXN1bHQpIHtcbiAgICB2YXIgcHRuID0gb01lcmdlZENvbnRleHRSZXN1bHQucmVzdWx0LnBhdHRlcm47XG4gICAgT2JqZWN0LmtleXMob01lcmdlZENvbnRleHRSZXN1bHQuY29udGV4dCkuZm9yRWFjaChmdW5jdGlvbiAoc0tleSkge1xuICAgICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCd7JyArIHNLZXkgKyAnfScsICdnJyk7XG4gICAgICAgIHB0biA9IHB0bi5yZXBsYWNlKHJlZ2V4LCBvTWVyZ2VkQ29udGV4dFJlc3VsdC5jb250ZXh0W3NLZXldKTtcbiAgICAgICAgcHRuID0gcHRuLnJlcGxhY2UocmVnZXgsIG9NZXJnZWRDb250ZXh0UmVzdWx0LmNvbnRleHRbc0tleV0pO1xuICAgIH0pO1xuICAgIHJldHVybiBwdG47XG59XG5mdW5jdGlvbiBleGVjVG9vbChtYXRjaCkge1xuICAgIHJldHVybiBcImNhbiBleGVjdXRlXCIgKyBtYXRjaC50b29sLm5hbWUgKyBcIiBcIiArXG4gICAgICAgIE1hdGNoLlRvb2xNYXRjaC5kdW1wTmljZShtYXRjaCk7XG4gICAgLy8gVE9ETyBpbnZva2UgdG9vbCBzcGVjaWZpYyBzdGFydGVyXG4gICAgLyogaWYgKG9NZXJnZWRDb250ZXh0UmVzdWx0LnJlc3VsdC50eXBlID09PSAnVVJMJykge1xuICAgICAgdmFyIHB0biA9IGV4cGFuZFBhcmFtZXRlcnNJblVSTChvTWVyZ2VkQ29udGV4dFJlc3VsdClcbiAgICAgIHN0YXJ0QnJvd3NlcihwdG4pXG4gICAgICByZXR1cm4gcHRuXG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBzID0gKFwiRG9uJ3Qga25vdyBob3cgdG8gc3RhcnQgXCIgKyBvTWVyZ2VkQ29udGV4dFJlc3VsdC5yZXN1bHQudHlwZSArICdcXG4gZm9yIFwiJyArIG9NZXJnZWRDb250ZXh0UmVzdWx0LnF1ZXJ5ICsgJ1wiJylcbiAgICAgIGRlYnVnbG9nKHMpXG4gICAgICByZXR1cm4gc1xuICAgIH0qL1xufVxuZXhwb3J0cy5leGVjVG9vbCA9IGV4ZWNUb29sO1xuLy8gIGV4ZWN1dGVTdGFydHVwOiBleGVjdXRlU3RhcnR1cFxuLy99XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
