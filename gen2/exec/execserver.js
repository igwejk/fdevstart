/**
 * Functionality to execute a certain response on the server,
 * interpreting a general model context
 *
 *
 * via a) commandline (e.g. browser startup)
 * @file
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require('debug');
var debuglog = debug('execserver');
var Toolmatch = require('../match/toolmatch');
var Exectemplate = require('./exectemplate');
function noStar(a, b) {
    if (b === '*') {
        return a;
    }
    if (a === '*') {
        return b;
    }
    if (a !== b) {
        throw new Error('Illegal Argument no match ' + a + " " + b);
    }
    return b;
}
exports.noStar = noStar;
function makeGenericText(match, setId, record) {
    var res = "start " + match.tool.name;
    var set = match.tool.sets[setId];
    var context = Toolmatch.makeMatchSet(match, set);
    set.set.forEach(function (category, index) {
        var value = noStar(context[category], record[category]);
        var prefix = "";
        if (index === 0) {
            prefix += ' using ';
        } else if (index === set.set.length - 1) {
            prefix += ' and ';
        } else {
            prefix = '; ';
        }
        if (category === "category") {
            res = res + prefix + '"' + value + '"';
        }
        res = res + prefix + category + ' "' + value + '"';
    });
    return res;
}
exports.makeGenericText = makeGenericText;
function execTool(match, records, bExplain) {
    //
    debuglog("records for match " + JSON.stringify(match));
    var matchSetRecord = Toolmatch.findFirstSetRecord(match, records);
    if (!matchSetRecord) {
        return {
            text: "cannot start",
            action: {}
        };
    }
    ;
    var set = match.tool.sets[matchSetRecord.setId];
    var pattern = matchSetRecord.record[set.response];
    var context = Toolmatch.makeMatchSet(match, set);
    var url = Exectemplate.expandTemplate(context, pattern);
    var text = "";
    debuglog("record " + JSON.stringify("matchSetRecord "));
    var patternText = matchSetRecord.record["_text" + set.response];
    if (patternText) {
        text = Exectemplate.expandTemplate(context, patternText);
    } else {
        text = makeGenericText(match, matchSetRecord.setId, matchSetRecord.record);
    }
    return {
        text: text,
        action: { url: url }
    };
}
exports.execTool = execTool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leGVjL2V4ZWNzZXJ2ZXIudHMiLCJleGVjL2V4ZWNzZXJ2ZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJUb29sbWF0Y2giLCJFeGVjdGVtcGxhdGUiLCJub1N0YXIiLCJhIiwiYiIsIkVycm9yIiwiZXhwb3J0cyIsIm1ha2VHZW5lcmljVGV4dCIsIm1hdGNoIiwic2V0SWQiLCJyZWNvcmQiLCJyZXMiLCJ0b29sIiwibmFtZSIsInNldCIsInNldHMiLCJjb250ZXh0IiwibWFrZU1hdGNoU2V0IiwiZm9yRWFjaCIsImNhdGVnb3J5IiwiaW5kZXgiLCJ2YWx1ZSIsInByZWZpeCIsImxlbmd0aCIsImV4ZWNUb29sIiwicmVjb3JkcyIsImJFeHBsYWluIiwiSlNPTiIsInN0cmluZ2lmeSIsIm1hdGNoU2V0UmVjb3JkIiwiZmluZEZpcnN0U2V0UmVjb3JkIiwidGV4dCIsImFjdGlvbiIsInBhdHRlcm4iLCJyZXNwb25zZSIsInVybCIsImV4cGFuZFRlbXBsYXRlIiwicGF0dGVyblRleHQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7QUNTQTs7QURHQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4sQ0FBakI7QUFJQSxJQUFNQyxXQUFXRixNQUFNLFlBQU4sQ0FBakI7QUFXQSxJQUFZRyxZQUFTRixRQUFNLG9CQUFOLENBQXJCO0FBRUEsSUFBWUcsZUFBWUgsUUFBTSxnQkFBTixDQUF4QjtBQUVBLFNBQUFJLE1BQUEsQ0FBdUJDLENBQXZCLEVBQWtDQyxDQUFsQyxFQUEyQztBQUN6QyxRQUFJQSxNQUFNLEdBQVYsRUFBZTtBQUNiLGVBQU9ELENBQVA7QUFDRDtBQUNELFFBQUlBLE1BQU0sR0FBVixFQUFlO0FBQ2IsZUFBT0MsQ0FBUDtBQUNEO0FBQ0QsUUFBSUQsTUFBTUMsQ0FBVixFQUFhO0FBQ1gsY0FBTSxJQUFJQyxLQUFKLENBQVUsK0JBQStCRixDQUEvQixHQUFtQyxHQUFuQyxHQUF5Q0MsQ0FBbkQsQ0FBTjtB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LyoqXHJcbiAqIEZ1bmN0aW9uYWxpdHkgdG8gZXhlY3V0ZSBhIGNlcnRhaW4gcmVzcG9uc2Ugb24gdGhlIHNlcnZlcixcclxuICogaW50ZXJwcmV0aW5nIGEgZ2VuZXJhbCBtb2RlbCBjb250ZXh0XHJcbiAqXHJcbiAqXHJcbiAqIHZpYSBhKSBjb21tYW5kbGluZSAoZS5nLiBicm93c2VyIHN0YXJ0dXApXHJcbiAqIEBmaWxlXHJcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cclxuICovXHJcblxyXG5pbXBvcnQgKiBhcyBpbnRmIGZyb20gJ2NvbnN0YW50cyc7XHJcblxyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcblxyXG5pbXBvcnQgKiAgYXMgSUZNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuXHJcbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ2V4ZWNzZXJ2ZXInKVxyXG5cclxuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xyXG5cclxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xyXG5pbXBvcnQgKiBhcyBNYXRjaCBmcm9tICcuLi9tYXRjaC9tYXRjaCc7XHJcblxyXG5cclxuaW1wb3J0ICogYXMgaW5wdXRGaWx0ZXJSdWxlcyBmcm9tICcuLi9tYXRjaC9pbnB1dEZpbHRlclJ1bGVzJztcclxuXHJcblxyXG5pbXBvcnQgKiBhcyBUb29sbWF0Y2ggZnJvbSAnLi4vbWF0Y2gvdG9vbG1hdGNoJztcclxuXHJcbmltcG9ydCAqIGFzIEV4ZWN0ZW1wbGF0ZSBmcm9tICcuL2V4ZWN0ZW1wbGF0ZSc7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbm9TdGFyKGE6IHN0cmluZywgYjogc3RyaW5nKSB7XHJcbiAgaWYgKGIgPT09ICcqJykge1xyXG4gICAgcmV0dXJuIGE7XHJcbiAgfVxyXG4gIGlmIChhID09PSAnKicpIHtcclxuICAgIHJldHVybiBiO1xyXG4gIH1cclxuICBpZiAoYSAhPT0gYikge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbGxlZ2FsIEFyZ3VtZW50IG5vIG1hdGNoICcgKyBhICsgXCIgXCIgKyBiKTtcclxuICB9XHJcbiAgcmV0dXJuIGI7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYWtlR2VuZXJpY1RleHQobWF0Y2g6IElNYXRjaC5JVG9vbE1hdGNoLCBzZXRJZDogc3RyaW5nLCByZWNvcmQ6IElNYXRjaC5JUmVjb3JkKTogc3RyaW5nIHtcclxuICB2YXIgcmVzID0gXCJzdGFydCBcIiArIG1hdGNoLnRvb2wubmFtZTtcclxuICB2YXIgc2V0ID0gbWF0Y2gudG9vbC5zZXRzW3NldElkXTtcclxuICB2YXIgY29udGV4dCA9IFRvb2xtYXRjaC5tYWtlTWF0Y2hTZXQobWF0Y2gsIHNldCk7XHJcbiAgc2V0LnNldC5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSwgaW5kZXgpIHtcclxuICAgIHZhciB2YWx1ZSA9IG5vU3Rhcihjb250ZXh0W2NhdGVnb3J5XSwgcmVjb3JkW2NhdGVnb3J5XSk7XHJcbiAgICB2YXIgcHJlZml4ID0gXCJcIjtcclxuICAgIGlmIChpbmRleCA9PT0gMCkge1xyXG4gICAgICBwcmVmaXggKz0gJyB1c2luZyAnO1xyXG4gICAgfSBlbHNlIGlmIChpbmRleCA9PT0gc2V0LnNldC5sZW5ndGggLSAxKSB7XHJcbiAgICAgIHByZWZpeCArPSAnIGFuZCAnO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcHJlZml4ID0gJzsgJztcclxuICAgIH1cclxuICAgIGlmIChjYXRlZ29yeSA9PT0gXCJjYXRlZ29yeVwiKSB7XHJcbiAgICAgIHJlcyA9IHJlcyArIHByZWZpeCArJ1wiJyArIHZhbHVlICsgJ1wiJztcclxuICAgIH1cclxuICAgIHJlcyA9IHJlcyArIHByZWZpeCArIGNhdGVnb3J5ICsgJyBcIicgKyB2YWx1ZSAgKyAnXCInO1xyXG4gIH0pO1xyXG4gIHJldHVybiByZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBleGVjVG9vbChtYXRjaDogSU1hdGNoLklUb29sTWF0Y2gsIHJlY29yZHM6IElNYXRjaC5JUmVjb3JkW10sIGJFeHBsYWluPzogYm9vbGVhbiApOiB7XHJcbiAgdGV4dDogc3RyaW5nLFxyXG4gIGFjdGlvbjogYW55XHJcbn0ge1xyXG4gIC8vXHJcbiAgZGVidWdsb2coXCJyZWNvcmRzIGZvciBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoKSk7XHJcbiAgdmFyIG1hdGNoU2V0UmVjb3JkID0gVG9vbG1hdGNoLmZpbmRGaXJzdFNldFJlY29yZChtYXRjaCwgcmVjb3Jkcyk7XHJcbiAgaWYoIW1hdGNoU2V0UmVjb3JkKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0ZXh0IDogXCJjYW5ub3Qgc3RhcnRcIixcclxuICAgICAgYWN0aW9uOiB7fVxyXG4gICAgfVxyXG4gIH07XHJcbiAgdmFyIHNldCA9IG1hdGNoLnRvb2wuc2V0c1ttYXRjaFNldFJlY29yZC5zZXRJZF07XHJcbiAgdmFyIHBhdHRlcm4gPSBtYXRjaFNldFJlY29yZC5yZWNvcmRbc2V0LnJlc3BvbnNlXTtcclxuXHJcbiAgdmFyIGNvbnRleHQgPSBUb29sbWF0Y2gubWFrZU1hdGNoU2V0KG1hdGNoLCBzZXQpO1xyXG4gIHZhciB1cmwgPSBFeGVjdGVtcGxhdGUuZXhwYW5kVGVtcGxhdGUoY29udGV4dCwgcGF0dGVybik7XHJcbiAgdmFyIHRleHQgPSBcIlwiO1xyXG4gIGRlYnVnbG9nKFwicmVjb3JkIFwiICtKU09OLnN0cmluZ2lmeShcIm1hdGNoU2V0UmVjb3JkIFwiKSk7XHJcbiAgdmFyIHBhdHRlcm5UZXh0ID0gbWF0Y2hTZXRSZWNvcmQucmVjb3JkW1wiX3RleHRcIiArIHNldC5yZXNwb25zZV07XHJcbiAgaWYgKHBhdHRlcm5UZXh0KSB7XHJcbiAgICB0ZXh0ID0gRXhlY3RlbXBsYXRlLmV4cGFuZFRlbXBsYXRlKGNvbnRleHQsIHBhdHRlcm5UZXh0KTtcclxuICB9IGVsc2Uge1xyXG4gICAgdGV4dCA9IG1ha2VHZW5lcmljVGV4dChtYXRjaCwgbWF0Y2hTZXRSZWNvcmQuc2V0SWQsIG1hdGNoU2V0UmVjb3JkLnJlY29yZClcclxuICB9XHJcbiAgcmV0dXJuIHtcclxuICAgIHRleHQ6IHRleHQsXHJcbiAgICBhY3Rpb246IHsgdXJsOiB1cmwgfVxyXG4gIH1cclxufVxyXG4iLCIvKipcbiAqIEZ1bmN0aW9uYWxpdHkgdG8gZXhlY3V0ZSBhIGNlcnRhaW4gcmVzcG9uc2Ugb24gdGhlIHNlcnZlcixcbiAqIGludGVycHJldGluZyBhIGdlbmVyYWwgbW9kZWwgY29udGV4dFxuICpcbiAqXG4gKiB2aWEgYSkgY29tbWFuZGxpbmUgKGUuZy4gYnJvd3NlciBzdGFydHVwKVxuICogQGZpbGVcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2V4ZWNzZXJ2ZXInKTtcbnZhciBUb29sbWF0Y2ggPSByZXF1aXJlKCcuLi9tYXRjaC90b29sbWF0Y2gnKTtcbnZhciBFeGVjdGVtcGxhdGUgPSByZXF1aXJlKCcuL2V4ZWN0ZW1wbGF0ZScpO1xuZnVuY3Rpb24gbm9TdGFyKGEsIGIpIHtcbiAgICBpZiAoYiA9PT0gJyonKSB7XG4gICAgICAgIHJldHVybiBhO1xuICAgIH1cbiAgICBpZiAoYSA9PT0gJyonKSB7XG4gICAgICAgIHJldHVybiBiO1xuICAgIH1cbiAgICBpZiAoYSAhPT0gYikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0lsbGVnYWwgQXJndW1lbnQgbm8gbWF0Y2ggJyArIGEgKyBcIiBcIiArIGIpO1xuICAgIH1cbiAgICByZXR1cm4gYjtcbn1cbmV4cG9ydHMubm9TdGFyID0gbm9TdGFyO1xuZnVuY3Rpb24gbWFrZUdlbmVyaWNUZXh0KG1hdGNoLCBzZXRJZCwgcmVjb3JkKSB7XG4gICAgdmFyIHJlcyA9IFwic3RhcnQgXCIgKyBtYXRjaC50b29sLm5hbWU7XG4gICAgdmFyIHNldCA9IG1hdGNoLnRvb2wuc2V0c1tzZXRJZF07XG4gICAgdmFyIGNvbnRleHQgPSBUb29sbWF0Y2gubWFrZU1hdGNoU2V0KG1hdGNoLCBzZXQpO1xuICAgIHNldC5zZXQuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnksIGluZGV4KSB7XG4gICAgICAgIHZhciB2YWx1ZSA9IG5vU3Rhcihjb250ZXh0W2NhdGVnb3J5XSwgcmVjb3JkW2NhdGVnb3J5XSk7XG4gICAgICAgIHZhciBwcmVmaXggPSBcIlwiO1xuICAgICAgICBpZiAoaW5kZXggPT09IDApIHtcbiAgICAgICAgICAgIHByZWZpeCArPSAnIHVzaW5nICc7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaW5kZXggPT09IHNldC5zZXQubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgcHJlZml4ICs9ICcgYW5kICc7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBwcmVmaXggPSAnOyAnO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjYXRlZ29yeSA9PT0gXCJjYXRlZ29yeVwiKSB7XG4gICAgICAgICAgICByZXMgPSByZXMgKyBwcmVmaXggKyAnXCInICsgdmFsdWUgKyAnXCInO1xuICAgICAgICB9XG4gICAgICAgIHJlcyA9IHJlcyArIHByZWZpeCArIGNhdGVnb3J5ICsgJyBcIicgKyB2YWx1ZSArICdcIic7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMubWFrZUdlbmVyaWNUZXh0ID0gbWFrZUdlbmVyaWNUZXh0O1xuZnVuY3Rpb24gZXhlY1Rvb2wobWF0Y2gsIHJlY29yZHMsIGJFeHBsYWluKSB7XG4gICAgLy9cbiAgICBkZWJ1Z2xvZyhcInJlY29yZHMgZm9yIG1hdGNoIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2gpKTtcbiAgICB2YXIgbWF0Y2hTZXRSZWNvcmQgPSBUb29sbWF0Y2guZmluZEZpcnN0U2V0UmVjb3JkKG1hdGNoLCByZWNvcmRzKTtcbiAgICBpZiAoIW1hdGNoU2V0UmVjb3JkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0ZXh0OiBcImNhbm5vdCBzdGFydFwiLFxuICAgICAgICAgICAgYWN0aW9uOiB7fVxuICAgICAgICB9O1xuICAgIH1cbiAgICA7XG4gICAgdmFyIHNldCA9IG1hdGNoLnRvb2wuc2V0c1ttYXRjaFNldFJlY29yZC5zZXRJZF07XG4gICAgdmFyIHBhdHRlcm4gPSBtYXRjaFNldFJlY29yZC5yZWNvcmRbc2V0LnJlc3BvbnNlXTtcbiAgICB2YXIgY29udGV4dCA9IFRvb2xtYXRjaC5tYWtlTWF0Y2hTZXQobWF0Y2gsIHNldCk7XG4gICAgdmFyIHVybCA9IEV4ZWN0ZW1wbGF0ZS5leHBhbmRUZW1wbGF0ZShjb250ZXh0LCBwYXR0ZXJuKTtcbiAgICB2YXIgdGV4dCA9IFwiXCI7XG4gICAgZGVidWdsb2coXCJyZWNvcmQgXCIgKyBKU09OLnN0cmluZ2lmeShcIm1hdGNoU2V0UmVjb3JkIFwiKSk7XG4gICAgdmFyIHBhdHRlcm5UZXh0ID0gbWF0Y2hTZXRSZWNvcmQucmVjb3JkW1wiX3RleHRcIiArIHNldC5yZXNwb25zZV07XG4gICAgaWYgKHBhdHRlcm5UZXh0KSB7XG4gICAgICAgIHRleHQgPSBFeGVjdGVtcGxhdGUuZXhwYW5kVGVtcGxhdGUoY29udGV4dCwgcGF0dGVyblRleHQpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdGV4dCA9IG1ha2VHZW5lcmljVGV4dChtYXRjaCwgbWF0Y2hTZXRSZWNvcmQuc2V0SWQsIG1hdGNoU2V0UmVjb3JkLnJlY29yZCk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHRleHQ6IHRleHQsXG4gICAgICAgIGFjdGlvbjogeyB1cmw6IHVybCB9XG4gICAgfTtcbn1cbmV4cG9ydHMuZXhlY1Rvb2wgPSBleGVjVG9vbDtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
