/**
 * Functionality to execute a certain response on the server,
 * interpreting a general model context
 *
 *
 * via a) commandline (e.g. browser startup)
 * @file
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require("debug");
var debuglog = debug('execserver');
var Toolmatch = require("../match/toolmatch");
var Exectemplate = require("./exectemplate");
function noStar(a, b) {
    if (b === '*') {
        return a;
    }
    if (a === '*') {
        return b;
    }
    if (a !== b) {
        throw new Error('Illegal Argument no match ' + a + " " + b);
    }
    return b;
}
exports.noStar = noStar;
function makeGenericText(match, setId, record) {
    var res = "start " + match.tool.name;
    var set = match.tool.sets[setId];
    var context = Toolmatch.makeMatchSet(match, set);
    set.set.forEach(function (category, index) {
        var value = noStar(context[category], record[category]);
        var prefix = "";
        if (index === 0) {
            prefix += ' using ';
        } else if (index === set.set.length - 1) {
            prefix += ' and ';
        } else {
            prefix = '; ';
        }
        if (category === "category") {
            res = res + prefix + '"' + value + '"';
        }
        res = res + prefix + category + ' "' + value + '"';
    });
    return res;
}
exports.makeGenericText = makeGenericText;
function execTool(match, records, bExplain) {
    //
    debuglog("records for match " + JSON.stringify(match));
    var matchSetRecord = Toolmatch.findFirstSetRecord(match, records);
    if (!matchSetRecord) {
        return {
            text: "cannot start",
            action: {}
        };
    }
    ;
    var set = match.tool.sets[matchSetRecord.setId];
    var pattern = matchSetRecord.record[set.response];
    var context = Toolmatch.makeMatchSet(match, set);
    var url = Exectemplate.expandTemplate(context, pattern);
    var text = "";
    debuglog("record " + JSON.stringify("matchSetRecord "));
    var patternText = matchSetRecord.record["_text" + set.response];
    if (patternText) {
        text = Exectemplate.expandTemplate(context, patternText);
    } else {
        text = makeGenericText(match, matchSetRecord.setId, matchSetRecord.record);
    }
    return {
        text: text,
        action: { url: url }
    };
}
exports.execTool = execTool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leGVjL2V4ZWNzZXJ2ZXIudHMiLCJleGVjL2V4ZWNzZXJ2ZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJUb29sbWF0Y2giLCJFeGVjdGVtcGxhdGUiLCJub1N0YXIiLCJhIiwiYiIsIkVycm9yIiwiZXhwb3J0cyIsIm1ha2VHZW5lcmljVGV4dCIsIm1hdGNoIiwic2V0SWQiLCJyZWNvcmQiLCJyZXMiLCJ0b29sIiwibmFtZSIsInNldCIsInNldHMiLCJjb250ZXh0IiwibWFrZU1hdGNoU2V0IiwiZm9yRWFjaCIsImNhdGVnb3J5IiwiaW5kZXgiLCJ2YWx1ZSIsInByZWZpeCIsImxlbmd0aCIsImV4ZWNUb29sIiwicmVjb3JkcyIsImJFeHBsYWluIiwiSlNPTiIsInN0cmluZ2lmeSIsIm1hdGNoU2V0UmVjb3JkIiwiZmluZEZpcnN0U2V0UmVjb3JkIiwidGV4dCIsImFjdGlvbiIsInBhdHRlcm4iLCJyZXNwb25zZSIsInVybCIsImV4cGFuZFRlbXBsYXRlIiwicGF0dGVyblRleHQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7QUNTQTs7QURHQSxJQUFBQSxRQUFBQyxRQUFBLE9BQUEsQ0FBQTtBQUlBLElBQU1DLFdBQVdGLE1BQU0sWUFBTixDQUFqQjtBQVdBLElBQUFHLFlBQUFGLFFBQUEsb0JBQUEsQ0FBQTtBQUVBLElBQUFHLGVBQUFILFFBQUEsZ0JBQUEsQ0FBQTtBQUVBLFNBQUFJLE1BQUEsQ0FBdUJDLENBQXZCLEVBQWtDQyxDQUFsQyxFQUEyQztBQUN6QyxRQUFJQSxNQUFNLEdBQVYsRUFBZTtBQUNiLGVBQU9ELENBQVA7QUFDRDtBQUNELFFBQUlBLE1BQU0sR0FBVixFQUFlO0FBQ2IsZUFBT0MsQ0FBUDtBQUNEO0FBQ0QsUUFBSUQsTUFBTUMsQ0FBVixFQUFhO0FBQ1gsY0FBTSxJQUFJQyxLQUFKLENBQVUsK0JBQStCRixDQUEvQixHQUFtQyxHQUFuQyxHQUF5Q0MsQ0FBbkQsQ0FBTjtBQUNE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XG4gKiBGdW5jdGlvbmFsaXR5IHRvIGV4ZWN1dGUgYSBjZXJ0YWluIHJlc3BvbnNlIG9uIHRoZSBzZXJ2ZXIsXHJcbiAqIGludGVycHJldGluZyBhIGdlbmVyYWwgbW9kZWwgY29udGV4dFxyXG4gKlxyXG4gKlxyXG4gKiB2aWEgYSkgY29tbWFuZGxpbmUgKGUuZy4gYnJvd3NlciBzdGFydHVwKVxyXG4gKiBAZmlsZVxyXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5cclxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xyXG5cclxuaW1wb3J0ICogIGFzIElGTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XHJcblxyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdleGVjc2VydmVyJylcclxuXHJcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcclxuXHJcbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvbWF0Y2gnO1xyXG5cclxuXHJcbmltcG9ydCAqIGFzIGlucHV0RmlsdGVyUnVsZXMgZnJvbSAnLi4vbWF0Y2gvaW5wdXRGaWx0ZXJSdWxlcyc7XHJcblxyXG5cclxuaW1wb3J0ICogYXMgVG9vbG1hdGNoIGZyb20gJy4uL21hdGNoL3Rvb2xtYXRjaCc7XHJcblxyXG5pbXBvcnQgKiBhcyBFeGVjdGVtcGxhdGUgZnJvbSAnLi9leGVjdGVtcGxhdGUnO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG5vU3RhcihhOiBzdHJpbmcsIGI6IHN0cmluZykge1xyXG4gIGlmIChiID09PSAnKicpIHtcclxuICAgIHJldHVybiBhO1xyXG4gIH1cclxuICBpZiAoYSA9PT0gJyonKSB7XHJcbiAgICByZXR1cm4gYjtcclxuICB9XHJcbiAgaWYgKGEgIT09IGIpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignSWxsZWdhbCBBcmd1bWVudCBubyBtYXRjaCAnICsgYSArIFwiIFwiICsgYik7XHJcbiAgfVxyXG4gIHJldHVybiBiO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZUdlbmVyaWNUZXh0KG1hdGNoOiBJTWF0Y2guSVRvb2xNYXRjaCwgc2V0SWQ6IHN0cmluZywgcmVjb3JkOiBJTWF0Y2guSVJlY29yZCk6IHN0cmluZyB7XHJcbiAgdmFyIHJlcyA9IFwic3RhcnQgXCIgKyBtYXRjaC50b29sLm5hbWU7XHJcbiAgdmFyIHNldCA9IG1hdGNoLnRvb2wuc2V0c1tzZXRJZF07XHJcbiAgdmFyIGNvbnRleHQgPSBUb29sbWF0Y2gubWFrZU1hdGNoU2V0KG1hdGNoLCBzZXQpO1xyXG4gIHNldC5zZXQuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnksIGluZGV4KSB7XHJcbiAgICB2YXIgdmFsdWUgPSBub1N0YXIoY29udGV4dFtjYXRlZ29yeV0sIHJlY29yZFtjYXRlZ29yeV0pO1xyXG4gICAgdmFyIHByZWZpeCA9IFwiXCI7XHJcbiAgICBpZiAoaW5kZXggPT09IDApIHtcclxuICAgICAgcHJlZml4ICs9ICcgdXNpbmcgJztcclxuICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IHNldC5zZXQubGVuZ3RoIC0gMSkge1xyXG4gICAgICBwcmVmaXggKz0gJyBhbmQgJztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHByZWZpeCA9ICc7ICc7XHJcbiAgICB9XHJcbiAgICBpZiAoY2F0ZWdvcnkgPT09IFwiY2F0ZWdvcnlcIikge1xyXG4gICAgICByZXMgPSByZXMgKyBwcmVmaXggKydcIicgKyB2YWx1ZSArICdcIic7XHJcbiAgICB9XHJcbiAgICByZXMgPSByZXMgKyBwcmVmaXggKyBjYXRlZ29yeSArICcgXCInICsgdmFsdWUgICsgJ1wiJztcclxuICB9KTtcclxuICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhlY1Rvb2wobWF0Y2g6IElNYXRjaC5JVG9vbE1hdGNoLCByZWNvcmRzOiBJTWF0Y2guSVJlY29yZFtdLCBiRXhwbGFpbj86IGJvb2xlYW4gKToge1xyXG4gIHRleHQ6IHN0cmluZyxcclxuICBhY3Rpb246IGFueVxyXG59IHtcclxuICAvL1xyXG4gIGRlYnVnbG9nKFwicmVjb3JkcyBmb3IgbWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaCkpO1xyXG4gIHZhciBtYXRjaFNldFJlY29yZCA9IFRvb2xtYXRjaC5maW5kRmlyc3RTZXRSZWNvcmQobWF0Y2gsIHJlY29yZHMpO1xyXG4gIGlmKCFtYXRjaFNldFJlY29yZCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdGV4dCA6IFwiY2Fubm90IHN0YXJ0XCIsXHJcbiAgICAgIGFjdGlvbjoge31cclxuICAgIH1cclxuICB9O1xyXG4gIHZhciBzZXQgPSBtYXRjaC50b29sLnNldHNbbWF0Y2hTZXRSZWNvcmQuc2V0SWRdO1xyXG4gIHZhciBwYXR0ZXJuID0gbWF0Y2hTZXRSZWNvcmQucmVjb3JkW3NldC5yZXNwb25zZV07XHJcblxyXG4gIHZhciBjb250ZXh0ID0gVG9vbG1hdGNoLm1ha2VNYXRjaFNldChtYXRjaCwgc2V0KTtcclxuICB2YXIgdXJsID0gRXhlY3RlbXBsYXRlLmV4cGFuZFRlbXBsYXRlKGNvbnRleHQsIHBhdHRlcm4pO1xyXG4gIHZhciB0ZXh0ID0gXCJcIjtcclxuICBkZWJ1Z2xvZyhcInJlY29yZCBcIiArSlNPTi5zdHJpbmdpZnkoXCJtYXRjaFNldFJlY29yZCBcIikpO1xyXG4gIHZhciBwYXR0ZXJuVGV4dCA9IG1hdGNoU2V0UmVjb3JkLnJlY29yZFtcIl90ZXh0XCIgKyBzZXQucmVzcG9uc2VdO1xyXG4gIGlmIChwYXR0ZXJuVGV4dCkge1xyXG4gICAgdGV4dCA9IEV4ZWN0ZW1wbGF0ZS5leHBhbmRUZW1wbGF0ZShjb250ZXh0LCBwYXR0ZXJuVGV4dCk7XHJcbiAgfSBlbHNlIHtcclxuICAgIHRleHQgPSBtYWtlR2VuZXJpY1RleHQobWF0Y2gsIG1hdGNoU2V0UmVjb3JkLnNldElkLCBtYXRjaFNldFJlY29yZC5yZWNvcmQpXHJcbiAgfVxyXG4gIHJldHVybiB7XHJcbiAgICB0ZXh0OiB0ZXh0LFxyXG4gICAgYWN0aW9uOiB7IHVybDogdXJsIH1cclxuICB9XHJcbn1cclxuIiwiLyoqXG4gKiBGdW5jdGlvbmFsaXR5IHRvIGV4ZWN1dGUgYSBjZXJ0YWluIHJlc3BvbnNlIG9uIHRoZSBzZXJ2ZXIsXG4gKiBpbnRlcnByZXRpbmcgYSBnZW5lcmFsIG1vZGVsIGNvbnRleHRcbiAqXG4gKlxuICogdmlhIGEpIGNvbW1hbmRsaW5lIChlLmcuIGJyb3dzZXIgc3RhcnR1cClcbiAqIEBmaWxlXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2V4ZWNzZXJ2ZXInKTtcbnZhciBUb29sbWF0Y2ggPSByZXF1aXJlKFwiLi4vbWF0Y2gvdG9vbG1hdGNoXCIpO1xudmFyIEV4ZWN0ZW1wbGF0ZSA9IHJlcXVpcmUoXCIuL2V4ZWN0ZW1wbGF0ZVwiKTtcbmZ1bmN0aW9uIG5vU3RhcihhLCBiKSB7XG4gICAgaWYgKGIgPT09ICcqJykge1xuICAgICAgICByZXR1cm4gYTtcbiAgICB9XG4gICAgaWYgKGEgPT09ICcqJykge1xuICAgICAgICByZXR1cm4gYjtcbiAgICB9XG4gICAgaWYgKGEgIT09IGIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbGxlZ2FsIEFyZ3VtZW50IG5vIG1hdGNoICcgKyBhICsgXCIgXCIgKyBiKTtcbiAgICB9XG4gICAgcmV0dXJuIGI7XG59XG5leHBvcnRzLm5vU3RhciA9IG5vU3RhcjtcbmZ1bmN0aW9uIG1ha2VHZW5lcmljVGV4dChtYXRjaCwgc2V0SWQsIHJlY29yZCkge1xuICAgIHZhciByZXMgPSBcInN0YXJ0IFwiICsgbWF0Y2gudG9vbC5uYW1lO1xuICAgIHZhciBzZXQgPSBtYXRjaC50b29sLnNldHNbc2V0SWRdO1xuICAgIHZhciBjb250ZXh0ID0gVG9vbG1hdGNoLm1ha2VNYXRjaFNldChtYXRjaCwgc2V0KTtcbiAgICBzZXQuc2V0LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5LCBpbmRleCkge1xuICAgICAgICB2YXIgdmFsdWUgPSBub1N0YXIoY29udGV4dFtjYXRlZ29yeV0sIHJlY29yZFtjYXRlZ29yeV0pO1xuICAgICAgICB2YXIgcHJlZml4ID0gXCJcIjtcbiAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICBwcmVmaXggKz0gJyB1c2luZyAnO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGluZGV4ID09PSBzZXQuc2V0Lmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIHByZWZpeCArPSAnIGFuZCAnO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcHJlZml4ID0gJzsgJztcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2F0ZWdvcnkgPT09IFwiY2F0ZWdvcnlcIikge1xuICAgICAgICAgICAgcmVzID0gcmVzICsgcHJlZml4ICsgJ1wiJyArIHZhbHVlICsgJ1wiJztcbiAgICAgICAgfVxuICAgICAgICByZXMgPSByZXMgKyBwcmVmaXggKyBjYXRlZ29yeSArICcgXCInICsgdmFsdWUgKyAnXCInO1xuICAgIH0pO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLm1ha2VHZW5lcmljVGV4dCA9IG1ha2VHZW5lcmljVGV4dDtcbmZ1bmN0aW9uIGV4ZWNUb29sKG1hdGNoLCByZWNvcmRzLCBiRXhwbGFpbikge1xuICAgIC8vXG4gICAgZGVidWdsb2coXCJyZWNvcmRzIGZvciBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoKSk7XG4gICAgdmFyIG1hdGNoU2V0UmVjb3JkID0gVG9vbG1hdGNoLmZpbmRGaXJzdFNldFJlY29yZChtYXRjaCwgcmVjb3Jkcyk7XG4gICAgaWYgKCFtYXRjaFNldFJlY29yZCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGV4dDogXCJjYW5ub3Qgc3RhcnRcIixcbiAgICAgICAgICAgIGFjdGlvbjoge31cbiAgICAgICAgfTtcbiAgICB9XG4gICAgO1xuICAgIHZhciBzZXQgPSBtYXRjaC50b29sLnNldHNbbWF0Y2hTZXRSZWNvcmQuc2V0SWRdO1xuICAgIHZhciBwYXR0ZXJuID0gbWF0Y2hTZXRSZWNvcmQucmVjb3JkW3NldC5yZXNwb25zZV07XG4gICAgdmFyIGNvbnRleHQgPSBUb29sbWF0Y2gubWFrZU1hdGNoU2V0KG1hdGNoLCBzZXQpO1xuICAgIHZhciB1cmwgPSBFeGVjdGVtcGxhdGUuZXhwYW5kVGVtcGxhdGUoY29udGV4dCwgcGF0dGVybik7XG4gICAgdmFyIHRleHQgPSBcIlwiO1xuICAgIGRlYnVnbG9nKFwicmVjb3JkIFwiICsgSlNPTi5zdHJpbmdpZnkoXCJtYXRjaFNldFJlY29yZCBcIikpO1xuICAgIHZhciBwYXR0ZXJuVGV4dCA9IG1hdGNoU2V0UmVjb3JkLnJlY29yZFtcIl90ZXh0XCIgKyBzZXQucmVzcG9uc2VdO1xuICAgIGlmIChwYXR0ZXJuVGV4dCkge1xuICAgICAgICB0ZXh0ID0gRXhlY3RlbXBsYXRlLmV4cGFuZFRlbXBsYXRlKGNvbnRleHQsIHBhdHRlcm5UZXh0KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHRleHQgPSBtYWtlR2VuZXJpY1RleHQobWF0Y2gsIG1hdGNoU2V0UmVjb3JkLnNldElkLCBtYXRjaFNldFJlY29yZC5yZWNvcmQpO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICB0ZXh0OiB0ZXh0LFxuICAgICAgICBhY3Rpb246IHsgdXJsOiB1cmwgfVxuICAgIH07XG59XG5leHBvcnRzLmV4ZWNUb29sID0gZXhlY1Rvb2w7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
