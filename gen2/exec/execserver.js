/**
 * Functionality to execute a certain response on the server,
 * interpreting a general model context
 *
 *
 * via a) commandline (e.g. browser startup)
 * @file
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require('debug');
var debuglog = debug('execserver');
var inputFilterRules = require('../match/inputFilterRules');
var toolExecutors = {
    "xFLP": {},
    "xFLPD": {},
    "unit test": function unitTest(match) {
        var unittest = match.toolmatchresult.required["unit test"].matchedString;
        var url = inputFilterRules.getUnitTestUrl(unittest);
        return {
            text: "starting unit test \"" + unittest + "\"" + (url ? ' with url ' + url : 'no url :-('),
            action: { url: url }
        };
    },
    "wiki": function wiki(match) {
        var wiki = match.toolmatchresult.required["wiki"].matchedString;
        var url = inputFilterRules.getWikiUrl(wiki);
        return {
            text: "starting wiki " + wiki + (url ? ' with url ' + url : 'no url :-('),
            action: { url: url }
        };
    }
};
var Toolmatch = require('../match/toolmatch');
var Exectemplate = require('./exectemplate');
function noStar(a, b) {
    if (b === '*') {
        return a;
    }
    if (a === '*') {
        return b;
    }
    if (a !== b) {
        throw new Error('Illegal Argument no match ' + a + " " + b);
    }
    return b;
}
exports.noStar = noStar;
function makeGenericText(match, setId, record) {
    var res = "start " + match.tool.name;
    var set = match.tool.sets[setId];
    var context = Toolmatch.makeMatchSet(match, set);
    set.set.forEach(function (category, index) {
        var value = noStar(context[category], record[category]);
        var prefix = "";
        if (index === 0) {
            prefix += ' using ';
        } else if (index === set.set.length - 1) {
            prefix += ' and ';
        } else {
            prefix = '; ';
        }
        if (category === "category") {
            res = res + prefix + '"' + value + '"';
        }
        res = res + prefix + category + ' "' + value + '"';
    });
    return res;
}
exports.makeGenericText = makeGenericText;
function execTool(match, records, bExplain) {
    //
    var matchSetRecord = Toolmatch.findFirstSetRecord(match, records);
    var set = match.tool.sets[matchSetRecord.setId];
    var pattern = matchSetRecord.record[set.response];
    var context = Toolmatch.makeMatchSet(match, set);
    var url = Exectemplate.expandTemplate(context, pattern);
    var text = "";
    debuglog("record " + JSON.stringify("matchSetRecord "));
    var patternText = matchSetRecord.record["_text" + set.response];
    if (patternText) {
        text = Exectemplate.expandTemplate(context, patternText);
    } else {
        text = makeGenericText(match, matchSetRecord.setId, matchSetRecord.record);
    }
    return {
        text: text,
        action: { url: url }
    };
}
exports.execTool = execTool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leGVjL2V4ZWNzZXJ2ZXIudHMiLCJleGVjL2V4ZWNzZXJ2ZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJpbnB1dEZpbHRlclJ1bGVzIiwidG9vbEV4ZWN1dG9ycyIsIm1hdGNoIiwidW5pdHRlc3QiLCJ0b29sbWF0Y2hyZXN1bHQiLCJyZXF1aXJlZCIsIm1hdGNoZWRTdHJpbmciLCJ1cmwiLCJnZXRVbml0VGVzdFVybCIsInRleHQiLCJhY3Rpb24iLCJ3aWtpIiwiZ2V0V2lraVVybCIsIlRvb2xtYXRjaCIsIkV4ZWN0ZW1wbGF0ZSIsIm5vU3RhciIsImEiLCJiIiwiRXJyb3IiLCJleHBvcnRzIiwibWFrZUdlbmVyaWNUZXh0Iiwic2V0SWQiLCJyZWNvcmQiLCJyZXMiLCJ0b29sIiwibmFtZSIsInNldCIsInNldHMiLCJjb250ZXh0IiwibWFrZU1hdGNoU2V0IiwiZm9yRWFjaCIsImNhdGVnb3J5IiwiaW5kZXgiLCJ2YWx1ZSIsInByZWZpeCIsImxlbmd0aCIsImV4ZWNUb29sIiwicmVjb3JkcyIsImJFeHBsYWluIiwibWF0Y2hTZXRSZWNvcmQiLCJmaW5kRmlyc3RTZXRSZWNvcmQiLCJwYXR0ZXJuIiwicmVzcG9uc2UiLCJleHBhbmRUZW1wbGF0ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJwYXR0ZXJuVGV4dCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7OztBQ1NBOztBREdBLElBQVlBLFFBQUtDLFFBQU0sT0FBTixDQUFqQjtBQUlBLElBQU1DLFdBQVdGLE1BQU0sWUFBTixDQUFqQjtBQVFBLElBQVlHLG1CQUFnQkYsUUFBTSwyQkFBTixDQUE1QjtBQUdBLElBQUlHLGdCQUFnQjtBQUNsQixZQUFRLEVBRFU7QUFFbEIsYUFBUyxFQUZTO0FBR2xCLGlCQUFhLGtCQUFVQyxLQUFWLEVBQW1DO0FBQzlDLFlBQUlDLFdBQVdELE1BQU1FLGVBQU4sQ0FBc0JDLFFBQXRCLENBQStCLFdBQS9CLEVBQTRDQyxhQUEz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QUFlbEIsS0FBL0IsQ0FBVjtBQUNBLFFBQUlvQixVQUFVRixlQUFlakIsTUFBZixDQUFzQkksSUFBSWdCLFFBQTFCLENBQWQ7QUFFQSxRQUFJZCxVQUFVZixVQUFVZ0IsWUFBVixDQUF1QjNCLEtBQXZCLEVBQThCd0IsR0FBOUIsQ0FBZDtBQUNBLFFBQUluQixNQUFNTyxhQUFhNkIsY0FBYixDQUE0QmYsT0FBNUIsRUFBcUNhLE9BQXJDLENBQVY7QUFDQSxRQUFJaEMsT0FBTyxFQUFYO0FBQ0FWLGFBQVMsWUFBVzZDLEtBQUtDLFNBQUwsQ0FBZSxpQkFBZixDQUFwQjtBQUNBLFFBQUlDLGNBQWNQLGVBQWVqQixNQUFmLENBQXNCLFVBQVVJLElBQUlnQixRQUFwQyxDQUFsQjtBQUNBLFFBQUlJLFdBQUosRUFBaUI7QUFDZnJDLGVBQU9LLGFBQWE2QixjQUFiLENBQTRCZixPQUE1QixFQUFxQ2tCLFdBQXJDLENBQVA7QUFDRCxLQUZELE1BRU87QUFDTHJDLGVBQU9XLGdCQUFnQmxCLEtBQWhCLEVBQXVCcUMsZUFBZWxCLEtBQXRDLEVBQTZDa0IsZUFBZWpCLE1BQTVELENBQVA7QUFDRDtBQUNELFdBQU87QUFDTGIsY0FBTUEsSUFERDtBQUVMQyxnQkFBUSxFQUFFSCxLQUFLQSxHQUFQO0FBRkgsS0FBUDtBQUlEO0FBdkJlWSxRQUFBaUIsUUFBQSxHQUFRQSxRQUFSIiwiZmlsZSI6ImV4ZWMvZXhlY3NlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBGdW5jdGlvbmFsaXR5IHRvIGV4ZWN1dGUgYSBjZXJ0YWluIHJlc3BvbnNlIG9uIHRoZSBzZXJ2ZXIsXHJcbiAqIGludGVycHJldGluZyBhIGdlbmVyYWwgbW9kZWwgY29udGV4dFxyXG4gKlxyXG4gKlxyXG4gKiB2aWEgYSkgY29tbWFuZGxpbmUgKGUuZy4gYnJvd3NlciBzdGFydHVwKVxyXG4gKiBAZmlsZVxyXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5cclxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xyXG5cclxuaW1wb3J0ICogIGFzIElGTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XHJcblxyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdleGVjc2VydmVyJylcclxuXHJcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcclxuXHJcbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvbWF0Y2gnO1xyXG5cclxuXHJcbmltcG9ydCAqIGFzIGlucHV0RmlsdGVyUnVsZXMgZnJvbSAnLi4vbWF0Y2gvaW5wdXRGaWx0ZXJSdWxlcyc7XHJcblxyXG5cclxudmFyIHRvb2xFeGVjdXRvcnMgPSB7XHJcbiAgXCJ4RkxQXCI6IHt9LFxyXG4gIFwieEZMUERcIjoge30sXHJcbiAgXCJ1bml0IHRlc3RcIjogZnVuY3Rpb24gKG1hdGNoOiBJRk1hdGNoLklUb29sTWF0Y2gpIHtcclxuICAgIHZhciB1bml0dGVzdCA9IG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtcInVuaXQgdGVzdFwiXS5tYXRjaGVkU3RyaW5nO1xyXG4gICAgdmFyIHVybCA9IGlucHV0RmlsdGVyUnVsZXMuZ2V0VW5pdFRlc3RVcmwodW5pdHRlc3QpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdGV4dDogXCJzdGFydGluZyB1bml0IHRlc3QgXFxcIlwiICsgdW5pdHRlc3QgKyBcIlxcXCJcIiArICh1cmwgPyAoJyB3aXRoIHVybCAnICsgdXJsKSA6ICdubyB1cmwgOi0oJyksXHJcbiAgICAgIGFjdGlvbjogeyB1cmw6IHVybCB9XHJcbiAgICB9XHJcbiAgfSxcclxuICBcIndpa2lcIjogZnVuY3Rpb24gKG1hdGNoOiBJRk1hdGNoLklUb29sTWF0Y2gpIHtcclxuICAgIHZhciB3aWtpID0gbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW1wid2lraVwiXS5tYXRjaGVkU3RyaW5nO1xyXG4gICAgdmFyIHVybCA9IGlucHV0RmlsdGVyUnVsZXMuZ2V0V2lraVVybCh3aWtpKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRleHQ6IFwic3RhcnRpbmcgd2lraSBcIiArIHdpa2kgKyAodXJsID8gKCcgd2l0aCB1cmwgJyArIHVybCkgOiAnbm8gdXJsIDotKCcpLFxyXG4gICAgICBhY3Rpb246IHsgdXJsOiB1cmwgfVxyXG4gICAgfVxyXG4gIH1cclxufTtcclxuXHJcbmltcG9ydCAqIGFzIFRvb2xtYXRjaCBmcm9tICcuLi9tYXRjaC90b29sbWF0Y2gnO1xyXG5cclxuaW1wb3J0ICogYXMgRXhlY3RlbXBsYXRlIGZyb20gJy4vZXhlY3RlbXBsYXRlJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBub1N0YXIoYTogc3RyaW5nLCBiOiBzdHJpbmcpIHtcclxuICBpZiAoYiA9PT0gJyonKSB7XHJcbiAgICByZXR1cm4gYTtcclxuICB9XHJcbiAgaWYgKGEgPT09ICcqJykge1xyXG4gICAgcmV0dXJuIGI7XHJcbiAgfVxyXG4gIGlmIChhICE9PSBiKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0lsbGVnYWwgQXJndW1lbnQgbm8gbWF0Y2ggJyArIGEgKyBcIiBcIiArIGIpO1xyXG4gIH1cclxuICByZXR1cm4gYjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VHZW5lcmljVGV4dChtYXRjaDogSU1hdGNoLklUb29sTWF0Y2gsIHNldElkOiBzdHJpbmcsIHJlY29yZDogSU1hdGNoLklSZWNvcmQpOiBzdHJpbmcge1xyXG4gIHZhciByZXMgPSBcInN0YXJ0IFwiICsgbWF0Y2gudG9vbC5uYW1lO1xyXG4gIHZhciBzZXQgPSBtYXRjaC50b29sLnNldHNbc2V0SWRdO1xyXG4gIHZhciBjb250ZXh0ID0gVG9vbG1hdGNoLm1ha2VNYXRjaFNldChtYXRjaCwgc2V0KTtcclxuICBzZXQuc2V0LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5LCBpbmRleCkge1xyXG4gICAgdmFyIHZhbHVlID0gbm9TdGFyKGNvbnRleHRbY2F0ZWdvcnldLCByZWNvcmRbY2F0ZWdvcnldKTtcclxuICAgIHZhciBwcmVmaXggPSBcIlwiO1xyXG4gICAgaWYgKGluZGV4ID09PSAwKSB7XHJcbiAgICAgIHByZWZpeCArPSAnIHVzaW5nICc7XHJcbiAgICB9IGVsc2UgaWYgKGluZGV4ID09PSBzZXQuc2V0Lmxlbmd0aCAtIDEpIHtcclxuICAgICAgcHJlZml4ICs9ICcgYW5kICc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwcmVmaXggPSAnOyAnO1xyXG4gICAgfVxyXG4gICAgaWYgKGNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcclxuICAgICAgcmVzID0gcmVzICsgcHJlZml4ICsnXCInICsgdmFsdWUgKyAnXCInO1xyXG4gICAgfVxyXG4gICAgcmVzID0gcmVzICsgcHJlZml4ICsgY2F0ZWdvcnkgKyAnIFwiJyArIHZhbHVlICArICdcIic7XHJcbiAgfSk7XHJcbiAgcmV0dXJuIHJlcztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4ZWNUb29sKG1hdGNoOiBJTWF0Y2guSVRvb2xNYXRjaCwgcmVjb3JkczogSU1hdGNoLklSZWNvcmRbXSwgYkV4cGxhaW4/OiBib29sZWFuICk6IHtcclxuICB0ZXh0OiBzdHJpbmcsXHJcbiAgYWN0aW9uOiBhbnlcclxufSB7XHJcbiAgLy9cclxuICB2YXIgbWF0Y2hTZXRSZWNvcmQgPSBUb29sbWF0Y2guZmluZEZpcnN0U2V0UmVjb3JkKG1hdGNoLCByZWNvcmRzKTtcclxuICB2YXIgc2V0ID0gbWF0Y2gudG9vbC5zZXRzW21hdGNoU2V0UmVjb3JkLnNldElkXTtcclxuICB2YXIgcGF0dGVybiA9IG1hdGNoU2V0UmVjb3JkLnJlY29yZFtzZXQucmVzcG9uc2VdO1xyXG5cclxuICB2YXIgY29udGV4dCA9IFRvb2xtYXRjaC5tYWtlTWF0Y2hTZXQobWF0Y2gsIHNldCk7XHJcbiAgdmFyIHVybCA9IEV4ZWN0ZW1wbGF0ZS5leHBhbmRUZW1wbGF0ZShjb250ZXh0LCBwYXR0ZXJuKTtcclxuICB2YXIgdGV4dCA9IFwiXCI7XHJcbiAgZGVidWdsb2coXCJyZWNvcmQgXCIgK0pTT04uc3RyaW5naWZ5KFwibWF0Y2hTZXRSZWNvcmQgXCIpKTtcclxuICB2YXIgcGF0dGVyblRleHQgPSBtYXRjaFNldFJlY29yZC5yZWNvcmRbXCJfdGV4dFwiICsgc2V0LnJlc3BvbnNlXTtcclxuICBpZiAocGF0dGVyblRleHQpIHtcclxuICAgIHRleHQgPSBFeGVjdGVtcGxhdGUuZXhwYW5kVGVtcGxhdGUoY29udGV4dCwgcGF0dGVyblRleHQpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICB0ZXh0ID0gbWFrZUdlbmVyaWNUZXh0KG1hdGNoLCBtYXRjaFNldFJlY29yZC5zZXRJZCwgbWF0Y2hTZXRSZWNvcmQucmVjb3JkKVxyXG4gIH1cclxuICByZXR1cm4ge1xyXG4gICAgdGV4dDogdGV4dCxcclxuICAgIGFjdGlvbjogeyB1cmw6IHVybCB9XHJcbiAgfVxyXG59XHJcbiIsIi8qKlxuICogRnVuY3Rpb25hbGl0eSB0byBleGVjdXRlIGEgY2VydGFpbiByZXNwb25zZSBvbiB0aGUgc2VydmVyLFxuICogaW50ZXJwcmV0aW5nIGEgZ2VuZXJhbCBtb2RlbCBjb250ZXh0XG4gKlxuICpcbiAqIHZpYSBhKSBjb21tYW5kbGluZSAoZS5nLiBicm93c2VyIHN0YXJ0dXApXG4gKiBAZmlsZVxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnZXhlY3NlcnZlcicpO1xudmFyIGlucHV0RmlsdGVyUnVsZXMgPSByZXF1aXJlKCcuLi9tYXRjaC9pbnB1dEZpbHRlclJ1bGVzJyk7XG52YXIgdG9vbEV4ZWN1dG9ycyA9IHtcbiAgICBcInhGTFBcIjoge30sXG4gICAgXCJ4RkxQRFwiOiB7fSxcbiAgICBcInVuaXQgdGVzdFwiOiBmdW5jdGlvbiAobWF0Y2gpIHtcbiAgICAgICAgdmFyIHVuaXR0ZXN0ID0gbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW1widW5pdCB0ZXN0XCJdLm1hdGNoZWRTdHJpbmc7XG4gICAgICAgIHZhciB1cmwgPSBpbnB1dEZpbHRlclJ1bGVzLmdldFVuaXRUZXN0VXJsKHVuaXR0ZXN0KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQ6IFwic3RhcnRpbmcgdW5pdCB0ZXN0IFxcXCJcIiArIHVuaXR0ZXN0ICsgXCJcXFwiXCIgKyAodXJsID8gKCcgd2l0aCB1cmwgJyArIHVybCkgOiAnbm8gdXJsIDotKCcpLFxuICAgICAgICAgICAgYWN0aW9uOiB7IHVybDogdXJsIH1cbiAgICAgICAgfTtcbiAgICB9LFxuICAgIFwid2lraVwiOiBmdW5jdGlvbiAobWF0Y2gpIHtcbiAgICAgICAgdmFyIHdpa2kgPSBtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbXCJ3aWtpXCJdLm1hdGNoZWRTdHJpbmc7XG4gICAgICAgIHZhciB1cmwgPSBpbnB1dEZpbHRlclJ1bGVzLmdldFdpa2lVcmwod2lraSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0ZXh0OiBcInN0YXJ0aW5nIHdpa2kgXCIgKyB3aWtpICsgKHVybCA/ICgnIHdpdGggdXJsICcgKyB1cmwpIDogJ25vIHVybCA6LSgnKSxcbiAgICAgICAgICAgIGFjdGlvbjogeyB1cmw6IHVybCB9XG4gICAgICAgIH07XG4gICAgfVxufTtcbnZhciBUb29sbWF0Y2ggPSByZXF1aXJlKCcuLi9tYXRjaC90b29sbWF0Y2gnKTtcbnZhciBFeGVjdGVtcGxhdGUgPSByZXF1aXJlKCcuL2V4ZWN0ZW1wbGF0ZScpO1xuZnVuY3Rpb24gbm9TdGFyKGEsIGIpIHtcbiAgICBpZiAoYiA9PT0gJyonKSB7XG4gICAgICAgIHJldHVybiBhO1xuICAgIH1cbiAgICBpZiAoYSA9PT0gJyonKSB7XG4gICAgICAgIHJldHVybiBiO1xuICAgIH1cbiAgICBpZiAoYSAhPT0gYikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0lsbGVnYWwgQXJndW1lbnQgbm8gbWF0Y2ggJyArIGEgKyBcIiBcIiArIGIpO1xuICAgIH1cbiAgICByZXR1cm4gYjtcbn1cbmV4cG9ydHMubm9TdGFyID0gbm9TdGFyO1xuZnVuY3Rpb24gbWFrZUdlbmVyaWNUZXh0KG1hdGNoLCBzZXRJZCwgcmVjb3JkKSB7XG4gICAgdmFyIHJlcyA9IFwic3RhcnQgXCIgKyBtYXRjaC50b29sLm5hbWU7XG4gICAgdmFyIHNldCA9IG1hdGNoLnRvb2wuc2V0c1tzZXRJZF07XG4gICAgdmFyIGNvbnRleHQgPSBUb29sbWF0Y2gubWFrZU1hdGNoU2V0KG1hdGNoLCBzZXQpO1xuICAgIHNldC5zZXQuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnksIGluZGV4KSB7XG4gICAgICAgIHZhciB2YWx1ZSA9IG5vU3Rhcihjb250ZXh0W2NhdGVnb3J5XSwgcmVjb3JkW2NhdGVnb3J5XSk7XG4gICAgICAgIHZhciBwcmVmaXggPSBcIlwiO1xuICAgICAgICBpZiAoaW5kZXggPT09IDApIHtcbiAgICAgICAgICAgIHByZWZpeCArPSAnIHVzaW5nICc7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaW5kZXggPT09IHNldC5zZXQubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgcHJlZml4ICs9ICcgYW5kICc7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBwcmVmaXggPSAnOyAnO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjYXRlZ29yeSA9PT0gXCJjYXRlZ29yeVwiKSB7XG4gICAgICAgICAgICByZXMgPSByZXMgKyBwcmVmaXggKyAnXCInICsgdmFsdWUgKyAnXCInO1xuICAgICAgICB9XG4gICAgICAgIHJlcyA9IHJlcyArIHByZWZpeCArIGNhdGVnb3J5ICsgJyBcIicgKyB2YWx1ZSArICdcIic7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMubWFrZUdlbmVyaWNUZXh0ID0gbWFrZUdlbmVyaWNUZXh0O1xuZnVuY3Rpb24gZXhlY1Rvb2wobWF0Y2gsIHJlY29yZHMsIGJFeHBsYWluKSB7XG4gICAgLy9cbiAgICB2YXIgbWF0Y2hTZXRSZWNvcmQgPSBUb29sbWF0Y2guZmluZEZpcnN0U2V0UmVjb3JkKG1hdGNoLCByZWNvcmRzKTtcbiAgICB2YXIgc2V0ID0gbWF0Y2gudG9vbC5zZXRzW21hdGNoU2V0UmVjb3JkLnNldElkXTtcbiAgICB2YXIgcGF0dGVybiA9IG1hdGNoU2V0UmVjb3JkLnJlY29yZFtzZXQucmVzcG9uc2VdO1xuICAgIHZhciBjb250ZXh0ID0gVG9vbG1hdGNoLm1ha2VNYXRjaFNldChtYXRjaCwgc2V0KTtcbiAgICB2YXIgdXJsID0gRXhlY3RlbXBsYXRlLmV4cGFuZFRlbXBsYXRlKGNvbnRleHQsIHBhdHRlcm4pO1xuICAgIHZhciB0ZXh0ID0gXCJcIjtcbiAgICBkZWJ1Z2xvZyhcInJlY29yZCBcIiArIEpTT04uc3RyaW5naWZ5KFwibWF0Y2hTZXRSZWNvcmQgXCIpKTtcbiAgICB2YXIgcGF0dGVyblRleHQgPSBtYXRjaFNldFJlY29yZC5yZWNvcmRbXCJfdGV4dFwiICsgc2V0LnJlc3BvbnNlXTtcbiAgICBpZiAocGF0dGVyblRleHQpIHtcbiAgICAgICAgdGV4dCA9IEV4ZWN0ZW1wbGF0ZS5leHBhbmRUZW1wbGF0ZShjb250ZXh0LCBwYXR0ZXJuVGV4dCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICB0ZXh0ID0gbWFrZUdlbmVyaWNUZXh0KG1hdGNoLCBtYXRjaFNldFJlY29yZC5zZXRJZCwgbWF0Y2hTZXRSZWNvcmQucmVjb3JkKTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdGV4dDogdGV4dCxcbiAgICAgICAgYWN0aW9uOiB7IHVybDogdXJsIH1cbiAgICB9O1xufVxuZXhwb3J0cy5leGVjVG9vbCA9IGV4ZWNUb29sO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
