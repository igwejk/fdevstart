/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require("debug");
var debuglog = debug('model');
var logger = require("../utils/logger");
var loadlog = logger.logger('modelload', '');
var IMatch = require("../match/ifmatch");
var InputFilterRules = require("../match/inputFilterRules");
var Tools = require("../match/tools");
var fs = require("fs");
var Meta = require("./meta");
var Utils = require("../utils/utils");
var CircularSer = require("../utils/circularser");
var process = require("process");
var _ = require("lodash");
exports.global_AddSplits = true; // false;
/**
 * the model path, may be controlled via environment variable
 */
var envModelPath = process.env["ABOT_MODELPATH"] || "testmodel";
var ARR_MODEL_PROPERTIES = ["domain", "bitindex", "defaultkeycolumn", "defaulturi", "categoryDescribed", "columns", "description", "tool", "toolhidden", "synonyms", "category", "wordindex", "exactmatch", "hidden"];
function addSynonyms(synonyms, category, synonymFor, bitindex, mRules, seen) {
    synonyms.forEach(function (syn) {
        var oRule = {
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            bitindex: bitindex,
            _ranking: 0.95
        };
        debuglog(debuglog.enabled ? "inserting synonym" + JSON.stringify(oRule) : '-');
        insertRuleIfNotPresent(mRules, oRule, seen);
    });
}
function getRuleKey(rule) {
    var r1 = rule.matchedString + "-|-" + rule.category + " -|- " + rule.type + " -|- " + rule.word + " ";
    if (rule.range) {
        var r2 = getRuleKey(rule.range.rule);
        r1 += " -|- " + rule.range.low + "/" + rule.range.high + " -|- " + r2;
    }
    return r1;
}
var Breakdown = require("../match/breakdown");
/* given a rule which represents a word sequence which is split during tokenization */
function addBestSplit(mRules, rule, seenRules) {
    if (!exports.global_AddSplits) {
        return;
    }
    if (rule.type !== 0 /* WORD */) {
            return;
        }
    var best = Breakdown.makeMatchPattern(rule.lowercaseword);
    if (!best) {
        return;
    }
    var newRule = {
        category: rule.category,
        matchedString: rule.matchedString,
        bitindex: rule.bitindex,
        word: best.longestToken,
        type: 0,
        lowercaseword: best.longestToken,
        _ranking: 0.95,
        //    exactOnly : rule.exactOnly,
        range: best.span
    };
    if (rule.exactOnly) {
        newRule.exactOnly = rule.exactOnly;
    }
    ;
    newRule.range.rule = rule;
    insertRuleIfNotPresent(mRules, newRule, seenRules);
}
exports.addBestSplit = addBestSplit;
function insertRuleIfNotPresent(mRules, rule, seenRules) {
    if (rule.type !== 0 /* WORD */) {
            mRules.push(rule);
            return;
        }
    if (rule.word === undefined || rule.matchedString === undefined) {
        throw new Error('illegal rule' + JSON.stringify(rule, undefined, 2));
    }
    var r = getRuleKey(rule);
    /* if( (rule.word === "service" || rule.word=== "services") && r.indexOf('OData') >= 0) {
         console.log("rulekey is" + r);
         console.log("presence is " + JSON.stringify(seenRules[r]));
     }*/
    rule.lowercaseword = rule.word.toLowerCase();
    if (seenRules[r]) {
        debuglog(debuglog.enabled ? "Attempting to insert duplicate" + JSON.stringify(rule, undefined, 2) : "-");
        var duplicates = seenRules[r].filter(function (oEntry) {
            return 0 === InputFilterRules.compareMRuleFull(oEntry, rule);
        });
        if (duplicates.length > 0) {
            return;
        }
    }
    seenRules[r] = seenRules[r] || [];
    seenRules[r].push(rule);
    if (rule.word === "") {
        debuglog(debuglog.enabled ? 'Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2) : '-');
        loadlog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        return;
    }
    mRules.push(rule);
    addBestSplit(mRules, rule, seenRules);
    return;
}
function loadModelData(modelPath, oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var bitindex = oMdl.bitindex;
    var sFileName = './' + modelPath + '/' + sModelName + ".data.json";
    var mdldata = fs.readFileSync(sFileName, 'utf-8');
    var oMdlData = JSON.parse(mdldata);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.tool) {
            oEntry._domain = oMdl.domain;
        }
        if (!oEntry.tool && oMdl.tool.name) {
            oEntry.tool = oMdl.tool.name;
        }
        oModel.records.push(oEntry);
        oMdl.category.forEach(function (cat) {
            if (oEntry[cat] === 'undefined') {
                oEntry[cat] = "n/a";
                var bug = "INCONSISTENT*> ModelData " + sFileName + " does not contain category " + cat + " with value 'undefined', undefined is illegal value, use n/a " + JSON.stringify(oEntry) + "";
                debuglog(bug);
            }
        });
        oMdl.wordindex.forEach(function (category) {
            if (oEntry[category] === undefined) {
                debuglog("INCONSISTENT*> ModelData " + sFileName + " does not contain category " + category + " of wordindex" + JSON.stringify(oEntry) + "");
                return;
            }
            if (oEntry[category] !== "*") {
                var sString = oEntry[category];
                debuglog("pushing rule with " + category + " -> " + sString);
                var oRule = {
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    bitindex: bitindex,
                    _ranking: 0.95
                };
                if (oMdl.exactmatch && oMdl.exactmatch.indexOf(category) >= 0) {
                    oRule.exactOnly = true;
                }
                insertRuleIfNotPresent(oModel.mRules, oRule, oModel.seenRules);
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, bitindex, oModel.mRules, oModel.seenRules);
                }
                if (oEntry.synonyms && oEntry.synonyms[category]) {
                    addSynonyms(oEntry.synonyms[category], category, sString, bitindex, oModel.mRules, oModel.seenRules);
                }
            }
        });
    });
}
function loadModel(modelPath, sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var mdl = fs.readFileSync('./' + modelPath + '/' + sModelName + ".model.json", 'utf-8');
    var oMdl = JSON.parse(mdl);
    mergeModelJson(sModelName, oMdl, oModel);
    loadModelData(modelPath, oMdl, sModelName, oModel);
}
function getDomainBitIndex(domain, oModel) {
    var index = oModel.domains.indexOf(domain);
    if (index < 0) {
        index = oModel.domains.length;
    }
    if (index >= 32) {
        throw new Error("too many domain for single 32 bit index");
    }
    return 0x0001 << index;
}
exports.getDomainBitIndex = getDomainBitIndex;
function mergeModelJson(sModelName, oMdl, oModel) {
    var categoryDescribedMap = {};
    oMdl.bitindex = getDomainBitIndex(oMdl.domain, oModel);
    oMdl.categoryDescribed = [];
    // rectify category
    oMdl.category = oMdl.category.map(function (cat) {
        if (typeof cat === "string") {
            return cat;
        }
        if (typeof cat.name !== "string") {
            console.log("Missing name in object typed category in " + JSON.stringify(cat) + " in model " + sModelName);
            process.exit(-1);
        }
        categoryDescribedMap[cat.name] = cat;
        oMdl.categoryDescribed.push(cat);
        return cat.name;
    });
    // add the categories to the model:
    oMdl.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            lowercaseword: category.toLowerCase(),
            bitindex: oMdl.bitindex,
            _ranking: 0.95
        }, oModel.seenRules);
    });
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // check properties of model
    Object.keys(oMdl).sort().forEach(function (sProperty) {
        if (ARR_MODEL_PROPERTIES.indexOf(sProperty) < 0) {
            throw new Error('Model property "' + sProperty + '" not a known model property in model of domain ' + oMdl.domain + ' ');
        }
    });
    // consider streamlining the categories
    oModel.rawModels[oMdl.domain] = oMdl;
    oModel.full.domain[oMdl.domain] = {
        description: oMdl.description,
        categories: categoryDescribedMap,
        bitindex: oMdl.bitindex
    };
    // check that members of wordindex are in categories,
    oMdl.wordindex = oMdl.wordindex || [];
    oMdl.wordindex.forEach(function (sWordIndex) {
        if (oMdl.category.indexOf(sWordIndex) < 0) {
            throw new Error('Model wordindex "' + sWordIndex + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    oMdl.exactmatch = oMdl.exactmatch || [];
    oMdl.exactmatch.forEach(function (sExactMatch) {
        if (oMdl.category.indexOf(sExactMatch) < 0) {
            throw new Error('Model exactmatch "' + sExactMatch + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    // add relation domain -> category
    var domainStr = MetaF.Domain(oMdl.domain).toFullString();
    var relationStr = MetaF.Relation(Meta.RELATION_hasCategory).toFullString();
    var reverseRelationStr = MetaF.Relation(Meta.RELATION_isCategoryOf).toFullString();
    oMdl.category.forEach(function (sCategory) {
        var CategoryString = MetaF.Category(sCategory).toFullString();
        oModel.meta.t3[domainStr] = oModel.meta.t3[domainStr] || {};
        oModel.meta.t3[domainStr][relationStr] = oModel.meta.t3[domainStr][relationStr] || {};
        oModel.meta.t3[domainStr][relationStr][CategoryString] = {};
        oModel.meta.t3[CategoryString] = oModel.meta.t3[CategoryString] || {};
        oModel.meta.t3[CategoryString][reverseRelationStr] = oModel.meta.t3[CategoryString][reverseRelationStr] || {};
        oModel.meta.t3[CategoryString][reverseRelationStr][domainStr] = {};
    });
    // add a precice domain matchrule
    insertRuleIfNotPresent(oModel.mRules, {
        category: "domain",
        matchedString: oMdl.domain,
        type: 0 /* WORD */
        , word: oMdl.domain,
        bitindex: oMdl.bitindex,
        _ranking: 0.95
    }, oModel.seenRules);
    // check the tool
    if (oMdl.tool && oMdl.tool.requires) {
        var requires = Object.keys(oMdl.tool.requires || {});
        var diff = _.difference(requires, oMdl.category);
        if (diff.length > 0) {
            console.log(" " + oMdl.domain + " : Unkown category in requires of tool: \"" + diff.join('"') + '"');
            process.exit(-1);
        }
        var optional = Object.keys(oMdl.tool.optional);
        diff = _.difference(optional, oMdl.category);
        if (diff.length > 0) {
            console.log(" " + oMdl.domain + " : Unkown category optional of tool: \"" + diff.join('"') + '"');
            process.exit(-1);
        }
        Object.keys(oMdl.tool.sets || {}).forEach(function (setID) {
            var diff = _.difference(oMdl.tool.sets[setID].set, oMdl.category);
            if (diff.length > 0) {
                console.log(" " + oMdl.domain + " : Unkown category in setId " + setID + " of tool: \"" + diff.join('"') + '"');
                process.exit(-1);
            }
        });
        // extract tools an add to tools:
        oModel.tools.filter(function (oEntry) {
            if (oEntry.name === (oMdl.tool && oMdl.tool.name)) {
                console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
                //throw new Error('Domain already loaded?');
                process.exit(-1);
            }
        });
    } else {
        oMdl.toolhidden = true;
        oMdl.tool.requires = { "impossible": {} };
    }
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden && oMdl.tool && oMdl.tool.name) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            bitindex: oMdl.bitindex,
            _ranking: 0.95
        }, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oMdl.bitindex, oModel.mRules, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                if (oModel.full.domain[oMdl.domain].categories[ssynkey]) {
                    oModel.full.domain[oMdl.domain].categories[ssynkey].synonyms = oMdl.synonyms[ssynkey];
                }
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oMdl.bitindex, oModel.mRules, oModel.seenRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    if (oMdl.tool.name) {
        oModel.tools.push(oMdl.tool);
    }
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
} // loadmodel
function splitRules(rules) {
    var res = {};
    var nonWordRules = [];
    rules.forEach(function (rule) {
        if (rule.type === 0 /* WORD */) {
                if (!rule.lowercaseword) {
                    throw new Error("Rule has no member lowercaseword" + JSON.stringify(rule));
                }
                res[rule.lowercaseword] = res[rule.lowercaseword] || { bitindex: 0, rules: [] };
                res[rule.lowercaseword].bitindex = res[rule.lowercaseword].bitindex | rule.bitindex;
                res[rule.lowercaseword].rules.push(rule);
            } else {
            nonWordRules.push(rule);
        }
    });
    return {
        wordMap: res,
        nonWordRules: nonWordRules,
        allRules: rules
    };
}
exports.splitRules = splitRules;
function cmpLengthSort(a, b) {
    var d = a.length - b.length;
    if (d) {
        return d;
    }
    return a.localeCompare(b);
}
var Distance = require("../utils/damerauLevenshtein");
var Algol = require("../match/algol");
// offset[0] : len-2
//             len -1
//             len
//             len +1
//             len +2
//             len +3
function findNextLen(targetLen, arr, offsets) {
    offsets.shift();
    for (var i = offsets[4]; i < arr.length && arr[i].length <= targetLen; ++i) {}
    //console.log("pushing " + i);
    offsets.push(i);
}
exports.findNextLen = findNextLen;
function addRangeRulesUnlessPresent(rules, lcword, rangeRules, presentRulesForKey, seenRules) {
    rangeRules.forEach(function (rangeRule) {
        var newRule = Object.assign({}, rangeRule);
        newRule.lowercaseword = lcword;
        newRule.word = lcword;
        //if((lcword === 'services' || lcword === 'service') && newRule.range.rule.lowercaseword.indexOf('odata')>=0) {
        //    console.log("adding "+ JSON.stringify(newRule) + "\n");
        //}
        //todo: check whether an equivalent rule is already present?
        var cnt = rules.length;
        insertRuleIfNotPresent(rules, newRule, seenRules);
    });
}
exports.addRangeRulesUnlessPresent = addRangeRulesUnlessPresent;
function addCloseExactRangeRules(rules, seenRules) {
    var keysMap = {};
    var rangeKeysMap = {};
    rules.forEach(function (rule) {
        if (rule.type === 0 /* WORD */) {
                //keysMap[rule.lowercaseword] = 1;
                keysMap[rule.lowercaseword] = keysMap[rule.lowercaseword] || [];
                keysMap[rule.lowercaseword].push(rule);
                if (!rule.exactOnly && rule.range) {
                    rangeKeysMap[rule.lowercaseword] = rangeKeysMap[rule.lowercaseword] || [];
                    rangeKeysMap[rule.lowercaseword].push(rule);
                }
            }
    });
    var keys = Object.keys(keysMap);
    keys.sort(cmpLengthSort);
    var len = 0;
    keys.forEach(function (key, index) {
        if (key.length != len) {}
        len = key.length;
    });
    //   keys = keys.slice(0,2000);
    var rangeKeys = Object.keys(rangeKeysMap);
    rangeKeys.sort(cmpLengthSort);
    //console.log(` ${keys.length} keys and ${rangeKeys.length} rangekeys `);
    var low = 0;
    var high = 0;
    var lastlen = 0;
    var offsets = [0, 0, 0, 0, 0, 0];
    var len = rangeKeys.length;
    findNextLen(0, keys, offsets);
    findNextLen(1, keys, offsets);
    findNextLen(2, keys, offsets);
    rangeKeys.forEach(function (rangeKey) {
        if (rangeKey.length !== lastlen) {
            for (i = lastlen + 1; i <= rangeKey.length; ++i) {
                findNextLen(i + 2, keys, offsets);
            }
            //   console.log(` shifted to ${rangeKey.length} with offsets beeing ${offsets.join(' ')}`);
            //   console.log(` here 0 ${offsets[0]} : ${keys[Math.min(keys.length-1, offsets[0])].length}  ${keys[Math.min(keys.length-1, offsets[0])]} `);
            //  console.log(` here 5-1  ${keys[offsets[5]-1].length}  ${keys[offsets[5]-1]} `);
            //   console.log(` here 5 ${offsets[5]} : ${keys[Math.min(keys.length-1, offsets[5])].length}  ${keys[Math.min(keys.length-1, offsets[5])]} `);
            lastlen = rangeKey.length;
        }
        for (var i = offsets[0]; i < offsets[5]; ++i) {
            var d = Distance.calcDistanceAdjusted(rangeKey, keys[i]);
            // console.log(`${rangeKey.length-keys[i].length} ${d} ${rangeKey} and ${keys[i]}  `);
            if (d !== 1.0 && d >= Algol.Cutoff_rangeCloseMatch) {
                //console.log(`would add ${rangeKey} for ${keys[i]} ${d}`);
                var cnt = rules.length;
                // we only have to add if there is not yet a match rule here which points to the same
                addRangeRulesUnlessPresent(rules, keys[i], rangeKeysMap[rangeKey], keysMap[keys[i]], seenRules);
                if (rules.length > cnt) {}
            }
        }
    });
    /*
    [
        ['aEFG','aEFGH'],
        ['aEFGH','aEFGHI'],
        ['Odata','ODatas'],
    ['Odata','Odatas'],
    ['Odata','Odatb'],
    ['Odata','UData'],
    ['service','services'],
    ['this isfunny and more','this isfunny and mores'],
    ].forEach(rec => {
        console.log(`distance ${rec[0]} ${rec[1]} : ${Distance.calcDistance(rec[0],rec[1])}  adf ${Distance.calcDistanceAdjusted(rec[0],rec[1])} `);
     });
    console.log("distance Odata Udata"+ Distance.calcDistance('OData','UData'));
    console.log("distance Odata Odatb"+ Distance.calcDistance('OData','ODatb'));
    console.log("distance Odatas Odata"+ Distance.calcDistance('OData','ODataa'));
    console.log("distance Odatas abcde"+ Distance.calcDistance('abcde','abcdef'));
    console.log("distance services "+ Distance.calcDistance('services','service'));
    */
}
exports.addCloseExactRangeRules = addCloseExactRangeRules;
var n = 0;
function loadModels(modelPath, addSplits) {
    var oModel;
    oModel = {
        full: { domain: {} },
        rawModels: {},
        domains: [],
        tools: [],
        rules: undefined,
        category: [],
        operators: {},
        mRules: [],
        seenRules: {},
        records: [],
        meta: { t3: {} }
    };
    exports.global_AddSplits = true; // addSplits || !process.env.ABOT_OLDMATCH;
    modelPath = modelPath || envModelPath;
    try {
        var a = CircularSer.load('./' + modelPath + '/_cache' + !!addSplits + '.js');
        //console.log("found a cache ?  " + !!a);
        //a = undefined;
        if (a) {
            debuglog(" return preparese model ");
            return a;
        }
    } catch (e) {}
    var smdls = fs.readFileSync('./' + modelPath + '/models.json', 'utf-8');
    var mdls = JSON.parse("" + smdls);
    mdls.forEach(function (sModelName) {
        loadModel(modelPath, sModelName, oModel);
    });
    // add the categories to the model:
    /*
    oModel.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: IMatch.EnumRuleType.WORD,
            word: category,
            lowercaseword: category.toLowerCase(),
            bitindex : oMdl.
            _ranking: 0.95
        }, oModel.seenRules);
    });
    */
    var metaBitIndex = getDomainBitIndex('meta', oModel);
    // add the domain meta rule
    insertRuleIfNotPresent(oModel.mRules, {
        category: "meta",
        matchedString: "domain",
        type: 0 /* WORD */
        , word: "domain",
        bitindex: metaBitIndex,
        _ranking: 0.95
    }, oModel.seenRules);
    var fillerBitIndex = getDomainBitIndex('meta', oModel);
    //add a filler rule
    var sfillers = fs.readFileSync('./' + modelPath + '/filler.json', 'utf-8');
    var fillers = JSON.parse(sfillers);
    var re = "^((" + fillers.join(")|(") + "))$";
    oModel.mRules.push({
        category: "filler",
        type: 1 /* REGEXP */
        , regexp: new RegExp(re, "i"),
        matchedString: "filler",
        bitindex: fillerBitIndex,
        _ranking: 0.9
    });
    //add operators
    var sOperators = fs.readFileSync('./resources/model/operators.json', 'utf-8');
    var operators = JSON.parse(sOperators);
    var operatorBitIndex = getDomainBitIndex('operators', oModel);
    Object.keys(operators.operators).forEach(function (operator) {
        if (IMatch.aOperatorNames.indexOf(operator) < 0) {
            debuglog("unknown operator " + operator);
            throw new Error("unknown operator " + operator);
        }
        oModel.operators[operator] = operators.operators[operator];
        oModel.operators[operator].operator = operator;
        Object.freeze(oModel.operators[operator]);
        var word = operator;
        insertRuleIfNotPresent(oModel.mRules, {
            category: "operator",
            word: word.toLowerCase(),
            lowercaseword: word.toLowerCase(),
            type: 0 /* WORD */
            , matchedString: word,
            bitindex: operatorBitIndex,
            _ranking: 0.9
        }, oModel.seenRules);
        // add all synonyms
        if (operators.synonyms[operator]) {
            Object.keys(operators.synonyms[operator]).forEach(function (synonym) {
                insertRuleIfNotPresent(oModel.mRules, {
                    category: "operator",
                    word: synonym.toLowerCase(),
                    lowercaseword: synonym.toLowerCase(),
                    type: 0 /* WORD */
                    , matchedString: operator,
                    bitindex: operatorBitIndex,
                    _ranking: 0.9
                }, oModel.seenRules);
            });
        }
    });
    /*
        })
            {
          category: "filler",
          type: 1,
          regexp: /^((start)|(show)|(from)|(in))$/i,
          matchedString: "filler",
          _ranking: 0.9
        },
    */
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    addCloseExactRangeRules(oModel.mRules, oModel.seenRules);
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    oModel.rules = splitRules(oModel.mRules);
    oModel.tools = oModel.tools.sort(Tools.cmpTools);
    delete oModel.seenRules;
    debuglog('saving');
    CircularSer.save('./' + modelPath + '/_cache' + !!addSplits + '.js', oModel);
    return oModel;
}
exports.loadModels = loadModels;
function sortCategoriesByImportance(map, cats) {
    var res = cats.slice(0);
    res.sort(rankCategoryByImportance.bind(undefined, map));
    return res;
}
exports.sortCategoriesByImportance = sortCategoriesByImportance;
function rankCategoryByImportance(map, cata, catb) {
    var catADesc = map[cata];
    var catBDesc = map[catb];
    if (cata === catb) {
        return 0;
    }
    // if a is before b, return -1
    if (catADesc && !catBDesc) {
        return -1;
    }
    if (!catADesc && catBDesc) {
        return +1;
    }
    var prioA = catADesc && catADesc.importance || 99;
    var prioB = catBDesc && catBDesc.importance || 99;
    // lower prio goes to front
    var r = prioA - prioB;
    if (r) {
        return r;
    }
    return cata.localeCompare(catb);
}
exports.rankCategoryByImportance = rankCategoryByImportance;
var MetaF = Meta.getMetaFactory();
function getOperator(mdl, operator) {
    return mdl.operators[operator];
}
exports.getOperator = getOperator;
function getResultAsArray(mdl, a, rel) {
    if (rel.toType() !== 'relation') {
        throw new Error("expect relation as 2nd arg");
    }
    var res = mdl.meta.t3[a.toFullString()] && mdl.meta.t3[a.toFullString()][rel.toFullString()];
    if (!res) {
        return [];
    }
    return Object.getOwnPropertyNames(res).sort().map(MetaF.parseIMeta);
}
exports.getResultAsArray = getResultAsArray;
function getCategoriesForDomain(theModel, domain) {
    if (theModel.domains.indexOf(domain) < 0) {
        throw new Error("Domain \"" + domain + "\" not part of model");
    }
    var res = getResultAsArray(theModel, MetaF.Domain(domain), MetaF.Relation(Meta.RELATION_hasCategory));
    return Meta.getStringArray(res);
}
exports.getCategoriesForDomain = getCategoriesForDomain;
function getTableColumns(theModel, domain) {
    if (theModel.domains.indexOf(domain) < 0) {
        throw new Error("Domain \"" + domain + "\" not part of model");
    }
    return theModel.rawModels[domain].columns.slice(0);
}
exports.getTableColumns = getTableColumns;
/**
 * Return all categories of a domain which can appear on a word,
 * these are typically the wordindex domains + entries generated by generic rules
 *
 * The current implementation is a simplification
 */
function getPotentialWordCategoriesForDomain(theModel, domain) {
    // this is a simplified version
    return getCategoriesForDomain(theModel, domain);
}
exports.getPotentialWordCategoriesForDomain = getPotentialWordCategoriesForDomain;
function getDomainsForCategory(theModel, category) {
    if (theModel.category.indexOf(category) < 0) {
        throw new Error("Category \"" + category + "\" not part of model");
    }
    var res = getResultAsArray(theModel, MetaF.Category(category), MetaF.Relation(Meta.RELATION_isCategoryOf));
    return Meta.getStringArray(res);
}
exports.getDomainsForCategory = getDomainsForCategory;
function getAllRecordCategoriesForTargetCategory(model, category, wordsonly) {
    var res = {};
    //
    var fn = wordsonly ? getPotentialWordCategoriesForDomain : getCategoriesForDomain;
    var domains = getDomainsForCategory(model, category);
    domains.forEach(function (domain) {
        fn(model, domain).forEach(function (wordcat) {
            res[wordcat] = true;
        });
    });
    Object.freeze(res);
    return res;
}
exports.getAllRecordCategoriesForTargetCategory = getAllRecordCategoriesForTargetCategory;
function getAllRecordCategoriesForTargetCategories(model, categories, wordsonly) {
    var res = {};
    //
    var fn = wordsonly ? getPotentialWordCategoriesForDomain : getCategoriesForDomain;
    var domains = undefined;
    categories.forEach(function (category) {
        var catdomains = getDomainsForCategory(model, category);
        if (!domains) {
            domains = catdomains;
        } else {
            domains = _.intersection(domains, catdomains);
        }
    });
    if (domains.length === 0) {
        throw new Error('categories ' + Utils.listToQuotedCommaAnd(categories) + ' have no common domain.');
    }
    domains.forEach(function (domain) {
        fn(model, domain).forEach(function (wordcat) {
            res[wordcat] = true;
        });
    });
    Object.freeze(res);
    return res;
}
exports.getAllRecordCategoriesForTargetCategories = getAllRecordCategoriesForTargetCategories;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwibG9nZ2VyIiwibG9hZGxvZyIsIklNYXRjaCIsIklucHV0RmlsdGVyUnVsZXMiLCJUb29scyIsImZzIiwiTWV0YSIsIlV0aWxzIiwiQ2lyY3VsYXJTZXIiLCJwcm9jZXNzIiwiXyIsImV4cG9ydHMiLCJnbG9iYWxfQWRkU3BsaXRzIiwiZW52TW9kZWxQYXRoIiwiZW52IiwiQVJSX01PREVMX1BST1BFUlRJRVMiLCJhZGRTeW5vbnltcyIsInN5bm9ueW1zIiwiY2F0ZWdvcnkiLCJzeW5vbnltRm9yIiwiYml0aW5kZXgiLCJtUnVsZXMiLCJzZWVuIiwiZm9yRWFjaCIsInN5biIsIm9SdWxlIiwibWF0Y2hlZFN0cmluZyIsInR5cGUiLCJ3b3JkIiwiX3JhbmtpbmciLCJlbmFibGVkIiwiSlNPTiIsInN0cmluZ2lmeSIsImluc2VydFJ1bGVJZk5vdFByZXNlbnQiLCJnZXRSdWxlS2V5IiwicnVsZSIsInIxIiwicmFuZ2UiLCJyMiIsImxvdyIsImhpZ2giLCJCcmVha2Rvd24iLCJhZGRCZXN0U3BsaXQiLCJzZWVuUnVsZXMiLCJiZXN0IiwibWFrZU1hdGNoUGF0dGVybiIsImxvd2VyY2FzZXdvcmQiLCJuZXdSdWxlIiwibG9uZ2VzdFRva2VuIiwic3BhbiIsImV4YWN0T25seSIsInB1c2giLCJ1bmRlZmluZWQiLCJFcnJvciIsInIiLCJ0b0xvd2VyQ2FzZSIsImR1cGxpY2F0ZXMiLCJmaWx0ZXIiLCJvRW50cnkiLCJjb21wYXJlTVJ1bGVGdWxsIiwibGVuZ3RoIiwibG9hZE1vZGVsRGF0YSIsIm1vZGVsUGF0aCIsIm9NZGwiLCJzTW9kZWxOYW1lIiwib01vZGVsIiwic0ZpbGVOYW1lIiwibWRsZGF0YSIsInJlYWRGaWxlU3luYyIsIm9NZGxEYXRhIiwicGFyc2UiLCJ0b29sIiwiX2RvbWFpbiIsImRvbWFpbiIsIm5hbWUiLCJyZWNvcmRzIiwiY2F0IiwiYnVnIiwid29yZGluZGV4Iiwic1N0cmluZyIsImV4YWN0bWF0Y2giLCJpbmRleE9mIiwibG9hZE1vZGVsIiwibWRsIiwibWVyZ2VNb2RlbEpzb24iLCJnZXREb21haW5CaXRJbmRleCIsImluZGV4IiwiZG9tYWlucyIsImNhdGVnb3J5RGVzY3JpYmVkTWFwIiwiY2F0ZWdvcnlEZXNjcmliZWQiLCJtYXAiLCJjb25zb2xlIiwibG9nIiwiZXhpdCIsIk9iamVjdCIsImtleXMiLCJzb3J0Iiwic1Byb3BlcnR5IiwicmF3TW9kZWxzIiwiZnVsbCIsImRlc2NyaXB0aW9uIiwiY2F0ZWdvcmllcyIsInNXb3JkSW5kZXgiLCJzRXhhY3RNYXRjaCIsImRvbWFpblN0ciIsIk1ldGFGIiwiRG9tYWluIiwidG9GdWxsU3RyaW5nIiwicmVsYXRpb25TdHIiLCJSZWxhdGlvbiIsIlJFTEFUSU9OX2hhc0NhdGVnb3J5IiwicmV2ZXJzZVJlbGF0aW9uU3RyIiwiUkVMQVRJT05faXNDYXRlZ29yeU9mIiwic0NhdGVnb3J5IiwiQ2F0ZWdvcnlTdHJpbmciLCJDYXRlZ29yeSIsIm1ldGEiLCJ0MyIsInJlcXVpcmVzIiwiZGlmZiIsImRpZmZlcmVuY2UiLCJqb2luIiwib3B0aW9uYWwiLCJzZXRzIiwic2V0SUQiLCJzZXQiLCJ0b29scyIsInRvb2xoaWRkZW4iLCJzc3lua2V5IiwiY29uY2F0Iiwic3RyaW5nIiwic3BsaXRSdWxlcyIsInJ1bGVzIiwicmVzIiwibm9uV29yZFJ1bGVzIiwid29yZE1hcCIsImFsbFJ1bGVzIiwiY21wTGVuZ3RoU29ydCIsImEiLCJiIiwiZCIsImxvY2FsZUNvbXBhcmUiLCJEaXN0YW5jZSIsIkFsZ29sIiwiZmluZE5leHRMZW4iLCJ0YXJnZXRMZW4iLCJhcnIiLCJvZmZzZXRzIiwic2hpZnQiLCJpIiwiYWRkUmFuZ2VSdWxlc1VubGVzc1ByZXNlbnQiLCJsY3dvcmQiLCJyYW5nZVJ1bGVzIiwicHJlc2VudFJ1bGVzRm9yS2V5IiwicmFuZ2VSdWxlIiwiYXNzaWduIiwiY250IiwiYWRkQ2xvc2VFeGFjdFJhbmdlUnVsZXMiLCJrZXlzTWFwIiwicmFuZ2VLZXlzTWFwIiwibGVuIiwia2V5IiwicmFuZ2VLZXlzIiwibGFzdGxlbiIsInJhbmdlS2V5IiwiY2FsY0Rpc3RhbmNlQWRqdXN0ZWQiLCJDdXRvZmZfcmFuZ2VDbG9zZU1hdGNoIiwibiIsImxvYWRNb2RlbHMiLCJhZGRTcGxpdHMiLCJvcGVyYXRvcnMiLCJsb2FkIiwiZSIsInNtZGxzIiwibWRscyIsIm1ldGFCaXRJbmRleCIsImZpbGxlckJpdEluZGV4Iiwic2ZpbGxlcnMiLCJmaWxsZXJzIiwicmUiLCJyZWdleHAiLCJSZWdFeHAiLCJzT3BlcmF0b3JzIiwib3BlcmF0b3JCaXRJbmRleCIsIm9wZXJhdG9yIiwiYU9wZXJhdG9yTmFtZXMiLCJmcmVlemUiLCJzeW5vbnltIiwiY21wTVJ1bGUiLCJjbXBUb29scyIsInNhdmUiLCJzb3J0Q2F0ZWdvcmllc0J5SW1wb3J0YW5jZSIsImNhdHMiLCJzbGljZSIsInJhbmtDYXRlZ29yeUJ5SW1wb3J0YW5jZSIsImJpbmQiLCJjYXRhIiwiY2F0YiIsImNhdEFEZXNjIiwiY2F0QkRlc2MiLCJwcmlvQSIsImltcG9ydGFuY2UiLCJwcmlvQiIsImdldE1ldGFGYWN0b3J5IiwiZ2V0T3BlcmF0b3IiLCJnZXRSZXN1bHRBc0FycmF5IiwicmVsIiwidG9UeXBlIiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsInBhcnNlSU1ldGEiLCJnZXRDYXRlZ29yaWVzRm9yRG9tYWluIiwidGhlTW9kZWwiLCJnZXRTdHJpbmdBcnJheSIsImdldFRhYmxlQ29sdW1ucyIsImNvbHVtbnMiLCJnZXRQb3RlbnRpYWxXb3JkQ2F0ZWdvcmllc0ZvckRvbWFpbiIsImdldERvbWFpbnNGb3JDYXRlZ29yeSIsImdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yeSIsIm1vZGVsIiwid29yZHNvbmx5IiwiZm4iLCJ3b3JkY2F0IiwiZ2V0QWxsUmVjb3JkQ2F0ZWdvcmllc0ZvclRhcmdldENh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O0FBQ0Y7QUF2QkQxSCxRQUFBbU4seUNBQUEsR0FBQUEseUNBQUEiLCJmaWxlIjoibW9kZWwvbW9kZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRnVuY3Rpb25hbGl0eSBtYW5hZ2luZyB0aGUgbWF0Y2ggbW9kZWxzXHJcbiAqXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcblxyXG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9kZWwnKTtcclxuXHJcbmltcG9ydCAqIGFzIGxvZ2dlciBmcm9tICcuLi91dGlscy9sb2dnZXInO1xyXG5cclxuY29uc3QgbG9hZGxvZyA9IGxvZ2dlci5sb2dnZXIoJ21vZGVsbG9hZCcsICcnKTtcclxuXHJcbmltcG9ydCAqICBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XHJcbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4uL21hdGNoL21hdGNoJztcclxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXJSdWxlcyBmcm9tICcuLi9tYXRjaC9pbnB1dEZpbHRlclJ1bGVzJztcclxuaW1wb3J0ICogYXMgVG9vbHMgZnJvbSAnLi4vbWF0Y2gvdG9vbHMnO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XHJcbmltcG9ydCAqIGFzIE1ldGEgZnJvbSAnLi9tZXRhJztcclxuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xyXG5pbXBvcnQgKiBhcyBDaXJjdWxhclNlciBmcm9tICcuLi91dGlscy9jaXJjdWxhcnNlcic7XHJcblxyXG5pbXBvcnQgKiBhcyBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XHJcblxyXG5leHBvcnQgdmFyIGdsb2JhbF9BZGRTcGxpdHMgPSB0cnVlOyAvLyBmYWxzZTtcclxuLyoqXHJcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcclxuICovXHJcbnZhciBlbnZNb2RlbFBhdGggPSBwcm9jZXNzLmVudltcIkFCT1RfTU9ERUxQQVRIXCJdIHx8IFwidGVzdG1vZGVsXCI7XHJcblxyXG4vL2V4cG9ydCBpbnRlcmZhY2UgSU1vZGVscyA9IE1hdGNoLklNb2RlbHM7XHJcblxyXG4vKlxyXG5leHBvcnQgaW50ZXJmYWNlIElNb2RlbHMge1xyXG4gICAgZG9tYWluczogc3RyaW5nW10sXHJcbiAgICB0b29sczogSU1hdGNoLklUb29sW10sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW10sXHJcbiAgICBtUnVsZXM6IElNYXRjaC5tUnVsZVtdLFxyXG4gICAgcmVjb3JkczogYW55W11cclxuICAgIHNlZW5SdWxlcz86IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlIH0sXHJcbiAgICBtZXRhIDoge1xyXG4gICAgICAgIC8vIGVudGl0eSAtPiByZWxhdGlvbiAtPiB0YXJnZXRcclxuICAgICAgICB0MyA6IHsgW2tleTogc3RyaW5nXSA6IHsgW2tleSA6IHN0cmluZ10gOiBhbnkgfX1cclxuICAgIH1cclxufSovXHJcblxyXG50eXBlIElNb2RlbCA9IElNYXRjaC5JTW9kZWw7XHJcblxyXG5jb25zdCBBUlJfTU9ERUxfUFJPUEVSVElFUyA9IFtcImRvbWFpblwiLCBcImJpdGluZGV4XCIsIFwiZGVmYXVsdGtleWNvbHVtblwiLCBcImRlZmF1bHR1cmlcIiwgXCJjYXRlZ29yeURlc2NyaWJlZFwiLCBcImNvbHVtbnNcIiwgXCJkZXNjcmlwdGlvblwiLCBcInRvb2xcIiwgXCJ0b29saGlkZGVuXCIsIFwic3lub255bXNcIiwgXCJjYXRlZ29yeVwiLCBcIndvcmRpbmRleFwiLCBcImV4YWN0bWF0Y2hcIiwgXCJoaWRkZW5cIl07XHJcblxyXG5mdW5jdGlvbiBhZGRTeW5vbnltcyhzeW5vbnltczogc3RyaW5nW10sIGNhdGVnb3J5OiBzdHJpbmcsIHN5bm9ueW1Gb3I6IHN0cmluZywgYml0aW5kZXggOiBudW1iZXIsIG1SdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgc2VlbjogeyBba2V5OiBzdHJpbmddOiBJTWF0Y2gubVJ1bGVbXSB9KSB7XHJcbiAgICBzeW5vbnltcy5mb3JFYWNoKGZ1bmN0aW9uIChzeW4pIHtcclxuICAgICAgICB2YXIgb1J1bGUgPSB7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc3lub255bUZvcixcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBzeW4sXHJcbiAgICAgICAgICAgIGJpdGluZGV4IDogYml0aW5kZXgsXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfTtcclxuICAgICAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkPyAoXCJpbnNlcnRpbmcgc3lub255bVwiICsgSlNPTi5zdHJpbmdpZnkob1J1bGUpKTonLScpO1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQobVJ1bGVzLCBvUnVsZSwgc2Vlbik7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0UnVsZUtleShydWxlKSB7XHJcbiAgICB2YXIgcjEgPSBydWxlLm1hdGNoZWRTdHJpbmcgKyBcIi18LVwiICsgcnVsZS5jYXRlZ29yeSArIFwiIC18LSBcIiArIHJ1bGUudHlwZSAgKyBcIiAtfC0gXCIgKyBydWxlLndvcmQgKyBcIiBcIjtcclxuICAgIGlmKHJ1bGUucmFuZ2UpIHtcclxuICAgICAgICB2YXIgcjIgPSBnZXRSdWxlS2V5KHJ1bGUucmFuZ2UucnVsZSk7XHJcbiAgICAgICAgcjEgKz0gXCIgLXwtIFwiICsgcnVsZS5yYW5nZS5sb3cgKyBcIi9cIiArIHJ1bGUucmFuZ2UuaGlnaCArIFwiIC18LSBcIiArIHIyO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHIxO1xyXG59XHJcblxyXG5cclxuaW1wb3J0ICogYXMgQnJlYWtkb3duIGZyb20gJy4uL21hdGNoL2JyZWFrZG93bic7XHJcblxyXG4vKiBnaXZlbiBhIHJ1bGUgd2hpY2ggcmVwcmVzZW50cyBhIHdvcmQgc2VxdWVuY2Ugd2hpY2ggaXMgc3BsaXQgZHVyaW5nIHRva2VuaXphdGlvbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gYWRkQmVzdFNwbGl0KG1SdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgcnVsZTogSU1hdGNoLm1SdWxlLCBzZWVuUnVsZXM6IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlW10gfSkge1xyXG4gICAgaWYoIWdsb2JhbF9BZGRTcGxpdHMpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYocnVsZS50eXBlICE9PSBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYmVzdCA9IEJyZWFrZG93bi5tYWtlTWF0Y2hQYXR0ZXJuKHJ1bGUubG93ZXJjYXNld29yZCk7XHJcbiAgICAgICAgaWYoIWJlc3QpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbmV3UnVsZSA9IHtcclxuICAgICAgICAgICAgY2F0ZWdvcnkgOiBydWxlLmNhdGVnb3J5LFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nIDogcnVsZS5tYXRjaGVkU3RyaW5nLFxyXG4gICAgICAgICAgICBiaXRpbmRleCA6IHJ1bGUuYml0aW5kZXgsXHJcbiAgICAgICAgICAgIHdvcmQgOiBiZXN0Lmxvbmdlc3RUb2tlbixcclxuICAgICAgICAgICAgdHlwZSA6IDAsXHJcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQgOiBiZXN0Lmxvbmdlc3RUb2tlbixcclxuICAgICAgICAgICAgX3JhbmtpbmcgOiAwLjk1LFxyXG4gICAgICAgIC8vICAgIGV4YWN0T25seSA6IHJ1bGUuZXhhY3RPbmx5LFxyXG4gICAgICAgICAgICByYW5nZSA6IGJlc3Quc3BhblxyXG4gICAgICAgIH0gYXMgSU1hdGNoLm1SdWxlO1xyXG4gICAgICAgIGlmKHJ1bGUuZXhhY3RPbmx5KSB7XHJcbiAgICAgICAgICAgIG5ld1J1bGUuZXhhY3RPbmx5ID0gcnVsZS5leGFjdE9ubHlcclxuICAgICAgICB9O1xyXG4gICAgICAgIG5ld1J1bGUucmFuZ2UucnVsZSA9IHJ1bGU7XHJcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsbmV3UnVsZSAsc2VlblJ1bGVzKTtcclxuIH1cclxuXHJcblxyXG5mdW5jdGlvbiBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgcnVsZTogSU1hdGNoLm1SdWxlLFxyXG4gICAgc2VlblJ1bGVzOiB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5tUnVsZVtdIH0pIHtcclxuXHJcbiAgICBpZiAocnVsZS50eXBlICE9PSBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQpIHtcclxuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbGxlZ2FsIHJ1bGUnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICB9XHJcbiAgICB2YXIgciA9IGdldFJ1bGVLZXkocnVsZSk7XHJcbiAgIC8qIGlmKCAocnVsZS53b3JkID09PSBcInNlcnZpY2VcIiB8fCBydWxlLndvcmQ9PT0gXCJzZXJ2aWNlc1wiKSAmJiByLmluZGV4T2YoJ09EYXRhJykgPj0gMCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwicnVsZWtleSBpc1wiICsgcik7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJwcmVzZW5jZSBpcyBcIiArIEpTT04uc3RyaW5naWZ5KHNlZW5SdWxlc1tyXSkpO1xyXG4gICAgfSovXHJcbiAgICBydWxlLmxvd2VyY2FzZXdvcmQgPSBydWxlLndvcmQudG9Mb3dlckNhc2UoKTtcclxuICAgIGlmIChzZWVuUnVsZXNbcl0pIHtcclxuICAgICAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKFwiQXR0ZW1wdGluZyB0byBpbnNlcnQgZHVwbGljYXRlXCIgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKSA6IFwiLVwiKTtcclxuICAgICAgICB2YXIgZHVwbGljYXRlcyA9IHNlZW5SdWxlc1tyXS5maWx0ZXIoZnVuY3Rpb24oIG9FbnRyeSkge1xyXG4gICAgICAgICAgICByZXR1cm4gMCA9PT0gSW5wdXRGaWx0ZXJSdWxlcy5jb21wYXJlTVJ1bGVGdWxsKG9FbnRyeSxydWxlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZihkdXBsaWNhdGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHNlZW5SdWxlc1tyXSA9IChzZWVuUnVsZXNbcl0gfHwgW10pO1xyXG4gICAgc2VlblJ1bGVzW3JdLnB1c2gocnVsZSk7XHJcbiAgICBpZiAocnVsZS53b3JkID09PSBcIlwiKSB7XHJcbiAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZD8gKCdTa2lwcGluZyBydWxlIHdpdGggZW10cHkgd29yZCAnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk6ICctJyk7XHJcbiAgICAgICAgbG9hZGxvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xyXG4gICAgYWRkQmVzdFNwbGl0KG1SdWxlcywgcnVsZSwgc2VlblJ1bGVzKTtcclxuICAgIHJldHVybjtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZE1vZGVsRGF0YShtb2RlbFBhdGg6IHN0cmluZywgb01kbDogSU1vZGVsLCBzTW9kZWxOYW1lOiBzdHJpbmcsIG9Nb2RlbDogSU1hdGNoLklNb2RlbHMpIHtcclxuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cclxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxyXG4gICAgdmFyIGJpdGluZGV4ID0gb01kbC5iaXRpbmRleDtcclxuICAgIGNvbnN0IHNGaWxlTmFtZSA9ICgnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLmRhdGEuanNvblwiKTtcclxuICAgIHZhciBtZGxkYXRhID0gZnMucmVhZEZpbGVTeW5jKHNGaWxlTmFtZSwgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgb01kbERhdGEgPSBKU09OLnBhcnNlKG1kbGRhdGEpO1xyXG4gICAgb01kbERhdGEuZm9yRWFjaChmdW5jdGlvbiAob0VudHJ5KSB7XHJcbiAgICAgICAgaWYoIW9FbnRyeS50b29sKSB7XHJcbiAgICAgICAgICAgIG9FbnRyeS5fZG9tYWluID0gb01kbC5kb21haW47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghb0VudHJ5LnRvb2wgJiYgb01kbC50b29sLm5hbWUpIHtcclxuICAgICAgICAgICAgb0VudHJ5LnRvb2wgPSBvTWRsLnRvb2wubmFtZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb01vZGVsLnJlY29yZHMucHVzaChvRW50cnkpO1xyXG4gICAgICAgIG9NZGwuY2F0ZWdvcnkuZm9yRWFjaChmdW5jdGlvbihjYXQpIHtcclxuICAgICAgICAgICAgaWYob0VudHJ5W2NhdF0gPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgICAgICBvRW50cnlbY2F0XSA9IFwibi9hXCI7XHJcbiAgICAgICAgICAgICAgICB2YXIgYnVnID1cclxuICAgICAgICAgICAgICAgICAgICBcIklOQ09OU0lTVEVOVCo+IE1vZGVsRGF0YSBcIiArIHNGaWxlTmFtZSArIFwiIGRvZXMgbm90IGNvbnRhaW4gY2F0ZWdvcnkgXCIgKyBjYXQgKyBcIiB3aXRoIHZhbHVlICd1bmRlZmluZWQnLCB1bmRlZmluZWQgaXMgaWxsZWdhbCB2YWx1ZSwgdXNlIG4vYSBcIiArIEpTT04uc3RyaW5naWZ5KG9FbnRyeSkgKyBcIlwiO1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coYnVnKTtcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYnVnKTtcclxuICAgICAgICAgICAgICAgIC8vcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIG9NZGwud29yZGluZGV4LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5KSB7XHJcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwiSU5DT05TSVNURU5UKj4gTW9kZWxEYXRhIFwiICsgc0ZpbGVOYW1lICsgXCIgZG9lcyBub3QgY29udGFpbiBjYXRlZ29yeSBcIiArIGNhdGVnb3J5ICsgXCIgb2Ygd29yZGluZGV4XCIgKyBKU09OLnN0cmluZ2lmeShvRW50cnkpICsgXCJcIilcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAob0VudHJ5W2NhdGVnb3J5XSAhPT0gXCIqXCIpIHtcclxuICAgICAgICAgICAgICAgIHZhciBzU3RyaW5nID0gb0VudHJ5W2NhdGVnb3J5XTtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwicHVzaGluZyBydWxlIHdpdGggXCIgKyBjYXRlZ29yeSArIFwiIC0+IFwiICsgc1N0cmluZyk7XHJcbiAgICAgICAgICAgICAgICB2YXIgb1J1bGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc1N0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JkOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBiaXRpbmRleCA6IGJpdGluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgICAgICAgICAgICAgIH0gYXMgSU1hdGNoLm1SdWxlO1xyXG4gICAgICAgICAgICAgICAgaWYob01kbC5leGFjdG1hdGNoICYmIG9NZGwuZXhhY3RtYXRjaC5pbmRleE9mKGNhdGVnb3J5KSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb1J1bGUuZXhhY3RPbmx5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcyxvUnVsZSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgICAgICBpZiAob01kbERhdGEuc3lub255bXMgJiYgb01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgYml0aW5kZXgsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG9FbnRyeS5zeW5vbnltcyAmJiBvRW50cnkuc3lub255bXNbY2F0ZWdvcnldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob0VudHJ5LnN5bm9ueW1zW2NhdGVnb3J5XSwgY2F0ZWdvcnksIHNTdHJpbmcsIGJpdGluZGV4LCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcblxyXG5cclxuXHJcbmZ1bmN0aW9uIGxvYWRNb2RlbChtb2RlbFBhdGggOiBzdHJpbmcsIHNNb2RlbE5hbWU6IHN0cmluZywgb01vZGVsOiBJTWF0Y2guSU1vZGVscykge1xyXG4gICAgZGVidWdsb2coXCIgbG9hZGluZyBcIiArIHNNb2RlbE5hbWUgKyBcIiAuLi4uXCIpO1xyXG4gICAgdmFyIG1kbCA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLm1vZGVsLmpzb25cIiwgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgb01kbCA9IEpTT04ucGFyc2UobWRsKSBhcyBJTW9kZWw7XHJcbiAgICBtZXJnZU1vZGVsSnNvbihzTW9kZWxOYW1lLCBvTWRsLCBvTW9kZWwpO1xyXG4gICAgbG9hZE1vZGVsRGF0YShtb2RlbFBhdGgsIG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREb21haW5CaXRJbmRleChkb21haW46IHN0cmluZywgb01vZGVsOiBJTWF0Y2guSU1vZGVscykgOiBudW1iZXIge1xyXG4gICAgdmFyIGluZGV4ID0gb01vZGVsLmRvbWFpbnMuaW5kZXhPZihkb21haW4pO1xyXG4gICAgaWYoaW5kZXggPCAwKSB7XHJcbiAgICAgICAgaW5kZXggPSBvTW9kZWwuZG9tYWlucy5sZW5ndGg7XHJcbiAgICB9XHJcbiAgICBpZihpbmRleCA+PSAzMikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInRvbyBtYW55IGRvbWFpbiBmb3Igc2luZ2xlIDMyIGJpdCBpbmRleFwiKTtcclxuICAgIH1cclxuICAgIHJldHVybiAweDAwMDEgPDwgaW5kZXg7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1lcmdlTW9kZWxKc29uKHNNb2RlbE5hbWU6IHN0cmluZywgb01kbDogSU1vZGVsLCBvTW9kZWw6IElNYXRjaC5JTW9kZWxzKSB7XHJcbiAgICB2YXIgY2F0ZWdvcnlEZXNjcmliZWRNYXAgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ10gOiBJTWF0Y2guSUNhdGVnb3J5RGVzYyB9O1xyXG4gICAgb01kbC5iaXRpbmRleCA9IGdldERvbWFpbkJpdEluZGV4KG9NZGwuZG9tYWluLCBvTW9kZWwpO1xyXG4gICAgb01kbC5jYXRlZ29yeURlc2NyaWJlZCA9IFtdO1xyXG4gICAgLy8gcmVjdGlmeSBjYXRlZ29yeVxyXG4gICAgb01kbC5jYXRlZ29yeSA9IG9NZGwuY2F0ZWdvcnkubWFwKGZ1bmN0aW9uKGNhdCA6IGFueSkge1xyXG4gICAgICAgIGlmKHR5cGVvZiBjYXQgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNhdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYodHlwZW9mIGNhdC5uYW1lICE9PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTWlzc2luZyBuYW1lIGluIG9iamVjdCB0eXBlZCBjYXRlZ29yeSBpbiBcIiArIEpTT04uc3RyaW5naWZ5KGNhdCkgKyBcIiBpbiBtb2RlbCBcIiArIHNNb2RlbE5hbWUgKTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiAnICsgb01kbC5kb21haW4gKyAnIGFscmVhZHkgbG9hZGVkIHdoaWxlIGxvYWRpbmcgJyArIHNNb2RlbE5hbWUgKyAnPycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRlZ29yeURlc2NyaWJlZE1hcFtjYXQubmFtZV0gPSBjYXQ7XHJcbiAgICAgICAgb01kbC5jYXRlZ29yeURlc2NyaWJlZC5wdXNoKGNhdCk7XHJcbiAgICAgICAgcmV0dXJuIGNhdC5uYW1lO1xyXG4gICAgfSk7XHJcblxyXG4gICAgICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcclxuICAgIG9NZGwuY2F0ZWdvcnkuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiY2F0ZWdvcnlcIixcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IGNhdGVnb3J5LnRvTG93ZXJDYXNlKCksXHJcbiAgICAgICAgICAgIGJpdGluZGV4IDogb01kbC5iaXRpbmRleCxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChvTW9kZWwuZG9tYWlucy5pbmRleE9mKG9NZGwuZG9tYWluKSA+PSAwKSB7XHJcbiAgICAgICAgZGVidWdsb2coXCIqKioqKioqKioqKmhlcmUgbWRsXCIgKyBKU09OLnN0cmluZ2lmeShvTWRsLCB1bmRlZmluZWQsIDIpKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiAnICsgb01kbC5kb21haW4gKyAnIGFscmVhZHkgbG9hZGVkIHdoaWxlIGxvYWRpbmcgJyArIHNNb2RlbE5hbWUgKyAnPycpO1xyXG4gICAgfVxyXG4gICAgLy8gY2hlY2sgcHJvcGVydGllcyBvZiBtb2RlbFxyXG4gICAgT2JqZWN0LmtleXMob01kbCkuc29ydCgpLmZvckVhY2goZnVuY3Rpb24oc1Byb3BlcnR5KSB7XHJcbiAgICAgICAgaWYoQVJSX01PREVMX1BST1BFUlRJRVMuaW5kZXhPZihzUHJvcGVydHkpIDwgMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIHByb3BlcnR5IFwiJyArIHNQcm9wZXJ0eSArICdcIiBub3QgYSBrbm93biBtb2RlbCBwcm9wZXJ0eSBpbiBtb2RlbCBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8vIGNvbnNpZGVyIHN0cmVhbWxpbmluZyB0aGUgY2F0ZWdvcmllc1xyXG4gICAgb01vZGVsLnJhd01vZGVsc1tvTWRsLmRvbWFpbl0gPSBvTWRsO1xyXG5cclxuICAgIG9Nb2RlbC5mdWxsLmRvbWFpbltvTWRsLmRvbWFpbl0gPSB7XHJcbiAgICAgICAgZGVzY3JpcHRpb24gOiBvTWRsLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgIGNhdGVnb3JpZXMgOiBjYXRlZ29yeURlc2NyaWJlZE1hcCxcclxuICAgICAgICBiaXRpbmRleCA6IG9NZGwuYml0aW5kZXhcclxuICAgIH07XHJcblxyXG5cclxuICAgIC8vIGNoZWNrIHRoYXQgbWVtYmVycyBvZiB3b3JkaW5kZXggYXJlIGluIGNhdGVnb3JpZXMsXHJcbiAgICBvTWRsLndvcmRpbmRleCA9IG9NZGwud29yZGluZGV4IHx8IFtdO1xyXG4gICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChmdW5jdGlvbihzV29yZEluZGV4KSB7XHJcbiAgICAgICAgaWYob01kbC5jYXRlZ29yeS5pbmRleE9mKHNXb3JkSW5kZXgpIDwgMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIHdvcmRpbmRleCBcIicgKyBzV29yZEluZGV4ICsgJ1wiIG5vdCBhIGNhdGVnb3J5IG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgb01kbC5leGFjdG1hdGNoID0gb01kbC5leGFjdG1hdGNoIHx8IFtdO1xyXG4gICAgb01kbC5leGFjdG1hdGNoLmZvckVhY2goZnVuY3Rpb24oc0V4YWN0TWF0Y2gpIHtcclxuICAgICAgICBpZihvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc0V4YWN0TWF0Y2gpIDwgMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIGV4YWN0bWF0Y2ggXCInICsgc0V4YWN0TWF0Y2ggKyAnXCIgbm90IGEgY2F0ZWdvcnkgb2YgZG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG5cclxuICAgIC8vIGFkZCByZWxhdGlvbiBkb21haW4gLT4gY2F0ZWdvcnlcclxuICAgIHZhciBkb21haW5TdHIgPSBNZXRhRi5Eb21haW4ob01kbC5kb21haW4pLnRvRnVsbFN0cmluZygpO1xyXG4gICAgdmFyIHJlbGF0aW9uU3RyID0gTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9oYXNDYXRlZ29yeSkudG9GdWxsU3RyaW5nKCk7XHJcbiAgICB2YXIgcmV2ZXJzZVJlbGF0aW9uU3RyID0gTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9pc0NhdGVnb3J5T2YpLnRvRnVsbFN0cmluZygpO1xyXG4gICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uKHNDYXRlZ29yeSkge1xyXG5cclxuICAgICAgICB2YXIgQ2F0ZWdvcnlTdHJpbmcgPSBNZXRhRi5DYXRlZ29yeShzQ2F0ZWdvcnkpLnRvRnVsbFN0cmluZygpO1xyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl0gPSBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdIHx8IHt9O1xyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdID0gb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl0gfHwge307XHJcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl1bQ2F0ZWdvcnlTdHJpbmddICA9IHt9O1xyXG5cclxuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ10gPSBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ10gfHwge307XHJcbiAgICAgICAgb01vZGVsLm1ldGEudDNbQ2F0ZWdvcnlTdHJpbmddW3JldmVyc2VSZWxhdGlvblN0cl0gPSBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ11bcmV2ZXJzZVJlbGF0aW9uU3RyXSB8fCB7fTtcclxuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ11bcmV2ZXJzZVJlbGF0aW9uU3RyXVtkb21haW5TdHJdICA9IHt9O1xyXG5cclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGFkZCBhIHByZWNpY2UgZG9tYWluIG1hdGNocnVsZVxyXG4gICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcImRvbWFpblwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLmRvbWFpbixcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBvTWRsLmRvbWFpbixcclxuICAgICAgICAgICAgYml0aW5kZXggOiBvTWRsLmJpdGluZGV4LFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG5cclxuICAgIC8vIGNoZWNrIHRoZSB0b29sXHJcbiAgICBpZihvTWRsLnRvb2wgJiYgb01kbC50b29sLnJlcXVpcmVzKSB7XHJcbiAgICAgICAgdmFyIHJlcXVpcmVzID0gT2JqZWN0LmtleXMob01kbC50b29sLnJlcXVpcmVzIHx8IHt9KTtcclxuICAgICAgICB2YXIgZGlmZiA9IF8uZGlmZmVyZW5jZShyZXF1aXJlcywgb01kbC5jYXRlZ29yeSk7XHJcbiAgICAgICAgICAgIGlmKGRpZmYubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCAke29NZGwuZG9tYWlufSA6IFVua293biBjYXRlZ29yeSBpbiByZXF1aXJlcyBvZiB0b29sOiBcImAgKyBkaWZmLmpvaW4oJ1wiJykgKyAnXCInKTtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB2YXIgb3B0aW9uYWwgPSBPYmplY3Qua2V5cyhvTWRsLnRvb2wub3B0aW9uYWwpO1xyXG4gICAgICAgIGRpZmYgPSBfLmRpZmZlcmVuY2Uob3B0aW9uYWwsIG9NZGwuY2F0ZWdvcnkpO1xyXG4gICAgICAgICAgICBpZihkaWZmLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAgJHtvTWRsLmRvbWFpbn0gOiBVbmtvd24gY2F0ZWdvcnkgb3B0aW9uYWwgb2YgdG9vbDogXCJgICsgZGlmZi5qb2luKCdcIicpICsgJ1wiJyk7XHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC50b29sLnNldHMgfHwge30pLmZvckVhY2goZnVuY3Rpb24oc2V0SUQpIHtcclxuICAgICAgICAgICAgdmFyIGRpZmYgPSBfLmRpZmZlcmVuY2Uob01kbC50b29sLnNldHNbc2V0SURdLnNldCwgb01kbC5jYXRlZ29yeSk7XHJcbiAgICAgICAgICAgIGlmKGRpZmYubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCAke29NZGwuZG9tYWlufSA6IFVua293biBjYXRlZ29yeSBpbiBzZXRJZCAke3NldElEfSBvZiB0b29sOiBcImAgKyBkaWZmLmpvaW4oJ1wiJykgKyAnXCInKTtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gZXh0cmFjdCB0b29scyBhbiBhZGQgdG8gdG9vbHM6XHJcbiAgICAgICAgb01vZGVsLnRvb2xzLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XHJcbiAgICAgICAgICAgIGlmIChvRW50cnkubmFtZSA9PT0gKG9NZGwudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVG9vbCBcIiArIG9NZGwudG9vbC5uYW1lICsgXCIgYWxyZWFkeSBwcmVzZW50IHdoZW4gbG9hZGluZyBcIiArIHNNb2RlbE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiBhbHJlYWR5IGxvYWRlZD8nKTtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgb01kbC50b29saGlkZGVuID0gdHJ1ZTtcclxuICAgICAgICBvTWRsLnRvb2wucmVxdWlyZXMgPSB7IFwiaW1wb3NzaWJsZVwiIDoge319O1xyXG4gICAgfVxyXG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXHJcbiAgICBpZiAoIW9NZGwudG9vbGhpZGRlbiAmJiBvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpIHtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwidG9vbFwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgYml0aW5kZXggOiBvTWRsLmJpdGluZGV4LFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgfTtcclxuICAgIGlmIChvTWRsLnN5bm9ueW1zICYmIG9NZGwuc3lub255bXNbXCJ0b29sXCJdKSB7XHJcbiAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tcInRvb2xcIl0sIFwidG9vbFwiLCBvTWRsLnRvb2wubmFtZSwgb01kbC5iaXRpbmRleCwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICB9O1xyXG4gICAgaWYgKG9NZGwuc3lub255bXMpIHtcclxuICAgICAgICBPYmplY3Qua2V5cyhvTWRsLnN5bm9ueW1zKS5mb3JFYWNoKGZ1bmN0aW9uIChzc3lua2V5KSB7XHJcbiAgICAgICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc3N5bmtleSkgPj0gMCAmJiBzc3lua2V5ICE9PSBcInRvb2xcIikge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9Nb2RlbC5mdWxsLmRvbWFpbltvTWRsLmRvbWFpbl0uY2F0ZWdvcmllc1tzc3lua2V5XSkgIHtcclxuICAgICAgICAgICAgICAgICAgIG9Nb2RlbC5mdWxsLmRvbWFpbltvTWRsLmRvbWFpbl0uY2F0ZWdvcmllc1tzc3lua2V5XS5zeW5vbnltcyA9IG9NZGwuc3lub255bXNbc3N5bmtleV07XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tzc3lua2V5XSwgXCJjYXRlZ29yeVwiLCBzc3lua2V5LCBvTWRsLmJpdGluZGV4LCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgb01vZGVsLmRvbWFpbnMucHVzaChvTWRsLmRvbWFpbik7XHJcbiAgICBpZihvTWRsLnRvb2wubmFtZSkge1xyXG4gICAgICBvTW9kZWwudG9vbHMucHVzaChvTWRsLnRvb2wpO1xyXG4gICAgfVxyXG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmNvbmNhdChvTWRsLmNhdGVnb3J5KTtcclxuICAgIG9Nb2RlbC5jYXRlZ29yeS5zb3J0KCk7XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuZmlsdGVyKGZ1bmN0aW9uIChzdHJpbmcsIGluZGV4KSB7XHJcbiAgICAgICAgcmV0dXJuIG9Nb2RlbC5jYXRlZ29yeVtpbmRleF0gIT09IG9Nb2RlbC5jYXRlZ29yeVtpbmRleCArIDFdO1xyXG4gICAgfSk7XHJcblxyXG59IC8vIGxvYWRtb2RlbFxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNwbGl0UnVsZXMocnVsZXMgOiBJTWF0Y2gubVJ1bGVbXSkgOiBJTWF0Y2guU3BsaXRSdWxlcyB7XHJcbiAgICB2YXIgcmVzID0ge307XHJcbiAgICB2YXIgbm9uV29yZFJ1bGVzID0gW107XHJcbiAgICBydWxlcy5mb3JFYWNoKGZ1bmN0aW9uKHJ1bGUpIHtcclxuICAgICAgICBpZihydWxlLnR5cGUgPT09IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCkge1xyXG4gICAgICAgICAgICBpZighcnVsZS5sb3dlcmNhc2V3b3JkKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSdWxlIGhhcyBubyBtZW1iZXIgbG93ZXJjYXNld29yZFwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdID0gcmVzW3J1bGUubG93ZXJjYXNld29yZF0gfHwgeyBiaXRpbmRleCA6IDAsIHJ1bGVzIDpbXSB9O1xyXG4gICAgICAgICAgICByZXNbcnVsZS5sb3dlcmNhc2V3b3JkXS5iaXRpbmRleCA9IHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdLmJpdGluZGV4IHwgcnVsZS5iaXRpbmRleDtcclxuICAgICAgICAgICAgcmVzW3J1bGUubG93ZXJjYXNld29yZF0ucnVsZXMucHVzaChydWxlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBub25Xb3JkUnVsZXMucHVzaChydWxlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgd29yZE1hcDogcmVzLFxyXG4gICAgICAgIG5vbldvcmRSdWxlcyA6IG5vbldvcmRSdWxlcyxcclxuICAgICAgICBhbGxSdWxlcyA6IHJ1bGVzXHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBjbXBMZW5ndGhTb3J0KGE6IHN0cmluZywgYiA6IHN0cmluZykge1xyXG4gICAgdmFyIGQ9IGEubGVuZ3RoIC0gYi5sZW5ndGg7XHJcbiAgICBpZihkKSB7XHJcbiAgICAgICAgcmV0dXJuIGQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYS5sb2NhbGVDb21wYXJlKGIpO1xyXG59XHJcblxyXG5pbXBvcnQgKiBhcyBEaXN0YW5jZSBmcm9tICcuLi91dGlscy9kYW1lcmF1TGV2ZW5zaHRlaW4nO1xyXG5pbXBvcnQgKiBhcyBBbGdvbCBmcm9tICcuLi9tYXRjaC9hbGdvbCc7XHJcbi8vIG9mZnNldFswXSA6IGxlbi0yXHJcbi8vICAgICAgICAgICAgIGxlbiAtMVxyXG4vLyAgICAgICAgICAgICBsZW5cclxuLy8gICAgICAgICAgICAgbGVuICsxXHJcbi8vICAgICAgICAgICAgIGxlbiArMlxyXG4vLyAgICAgICAgICAgICBsZW4gKzNcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kTmV4dExlbih0YXJnZXRMZW4gOiBudW1iZXIsIGFyciA6IHN0cmluZ1tdLCBvZmZzZXRzOiBudW1iZXJbXSkge1xyXG4gICAgb2Zmc2V0cy5zaGlmdCgpO1xyXG4gICAgZm9yKHZhciBpID0gb2Zmc2V0c1s0XTsgIChpIDwgYXJyLmxlbmd0aCkgJiYgKGFycltpXS5sZW5ndGggPD0gdGFyZ2V0TGVuKTsgKytpKSB7XHJcbiAgICAgICAgLyogZW1wdHkqL1xyXG4gICAgfVxyXG4gICAgLy9jb25zb2xlLmxvZyhcInB1c2hpbmcgXCIgKyBpKTtcclxuICAgIG9mZnNldHMucHVzaChpKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZFJhbmdlUnVsZXNVbmxlc3NQcmVzZW50KHJ1bGVzIDogSU1hdGNoLm1SdWxlW10sIGxjd29yZDogc3RyaW5nLCByYW5nZVJ1bGVzIDogSU1hdGNoLm1SdWxlW10sIHByZXNlbnRSdWxlc0ZvcktleTogSU1hdGNoLm1SdWxlW10sIHNlZW5SdWxlcykge1xyXG4gICAgcmFuZ2VSdWxlcy5mb3JFYWNoKHJhbmdlUnVsZSA9PiB7XHJcbiAgICAgICAgdmFyIG5ld1J1bGUgPSBPYmplY3QuYXNzaWduKHt9LHJhbmdlUnVsZSk7XHJcbiAgICAgICAgbmV3UnVsZS5sb3dlcmNhc2V3b3JkID0gbGN3b3JkO1xyXG4gICAgICAgIG5ld1J1bGUud29yZCA9IGxjd29yZDtcclxuICAgICAgICAvL2lmKChsY3dvcmQgPT09ICdzZXJ2aWNlcycgfHwgbGN3b3JkID09PSAnc2VydmljZScpICYmIG5ld1J1bGUucmFuZ2UucnVsZS5sb3dlcmNhc2V3b3JkLmluZGV4T2YoJ29kYXRhJyk+PTApIHtcclxuICAgICAgICAvLyAgICBjb25zb2xlLmxvZyhcImFkZGluZyBcIisgSlNPTi5zdHJpbmdpZnkobmV3UnVsZSkgKyBcIlxcblwiKTtcclxuICAgICAgICAvL31cclxuICAgICAgICAvL3RvZG86IGNoZWNrIHdoZXRoZXIgYW4gZXF1aXZhbGVudCBydWxlIGlzIGFscmVhZHkgcHJlc2VudD9cclxuICAgICAgICB2YXIgY250ID0gcnVsZXMubGVuZ3RoO1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQocnVsZXMsIG5ld1J1bGUsIHNlZW5SdWxlcyk7XHJcbiAgICB9KVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZENsb3NlRXhhY3RSYW5nZVJ1bGVzKHJ1bGVzIDogSU1hdGNoLm1SdWxlW10sIHNlZW5SdWxlcykge1xyXG4gICAgdmFyIGtleXNNYXAgPSB7fSBhcyB7IFtrZXkgOiBzdHJpbmddIDogSU1hdGNoLm1SdWxlW119IDtcclxuICAgIHZhciByYW5nZUtleXNNYXAgPSB7fSBhcyB7IFtrZXkgOiBzdHJpbmddIDogSU1hdGNoLm1SdWxlW119IDtcclxuICAgIHJ1bGVzLmZvckVhY2gocnVsZSA9PiB7XHJcbiAgICAgICAgaWYgKHJ1bGUudHlwZSA9PT0gSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JEKSB7XHJcbiAgICAgICAgICAgIC8va2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdID0gMTtcclxuICAgICAgICAgICAga2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdID0ga2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdIHx8IFtdO1xyXG4gICAgICAgICAgICBrZXlzTWFwW3J1bGUubG93ZXJjYXNld29yZF0ucHVzaChydWxlKTtcclxuICAgICAgICAgICAgaWYoIXJ1bGUuZXhhY3RPbmx5ICYmIHJ1bGUucmFuZ2UpIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlS2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdID0gcmFuZ2VLZXlzTWFwW3J1bGUubG93ZXJjYXNld29yZF0gfHwgW107XHJcbiAgICAgICAgICAgICAgICByYW5nZUtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXS5wdXNoKHJ1bGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGtleXNNYXApO1xyXG4gICAga2V5cy5zb3J0KGNtcExlbmd0aFNvcnQpO1xyXG4gICAgdmFyIGxlbiA9IDA7XHJcbiAgICBrZXlzLmZvckVhY2goIChrZXksaW5kZXgpID0+IHtcclxuICAgICAgICBpZihrZXkubGVuZ3RoICE9IGxlbikge1xyXG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwic2hpZnQgdG8gbGVuXCIgKyBrZXkubGVuZ3RoICsgJyBhdCAnICsgaW5kZXggKyAnICcgKyBrZXkgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGVuID0ga2V5Lmxlbmd0aDtcclxuICAgIH0pO1xyXG4gICAgIC8vICAga2V5cyA9IGtleXMuc2xpY2UoMCwyMDAwKTtcclxuICAgIHZhciByYW5nZUtleXMgPSBPYmplY3Qua2V5cyhyYW5nZUtleXNNYXApO1xyXG4gICAgcmFuZ2VLZXlzLnNvcnQoY21wTGVuZ3RoU29ydCk7XHJcbiAgICAvL2NvbnNvbGUubG9nKGAgJHtrZXlzLmxlbmd0aH0ga2V5cyBhbmQgJHtyYW5nZUtleXMubGVuZ3RofSByYW5nZWtleXMgYCk7XHJcbiAgICB2YXIgbG93ID0gMDtcclxuICAgIHZhciBoaWdoID0gMDtcclxuICAgIHZhciBsYXN0bGVuID0gMDtcclxuICAgIHZhciBvZmZzZXRzID0gWzAsMCwwLDAsMCwwXTtcclxuICAgIHZhciBsZW4gPSByYW5nZUtleXMubGVuZ3RoO1xyXG4gICAgZmluZE5leHRMZW4oMCxrZXlzLCBvZmZzZXRzKTtcclxuICAgIGZpbmROZXh0TGVuKDEsa2V5cywgb2Zmc2V0cyk7XHJcbiAgICBmaW5kTmV4dExlbigyLGtleXMsIG9mZnNldHMpO1xyXG5cclxuICAgIHJhbmdlS2V5cy5mb3JFYWNoKGZ1bmN0aW9uKHJhbmdlS2V5KSB7XHJcbiAgICAgICAgaWYocmFuZ2VLZXkubGVuZ3RoICE9PSBsYXN0bGVuKSB7XHJcbiAgICAgICAgICAgIGZvcihpID0gbGFzdGxlbisxOyBpIDw9IHJhbmdlS2V5Lmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICBmaW5kTmV4dExlbihpKzIsa2V5cyxvZmZzZXRzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAvLyAgIGNvbnNvbGUubG9nKGAgc2hpZnRlZCB0byAke3JhbmdlS2V5Lmxlbmd0aH0gd2l0aCBvZmZzZXRzIGJlZWluZyAke29mZnNldHMuam9pbignICcpfWApO1xyXG4gICAgICAgICAvLyAgIGNvbnNvbGUubG9nKGAgaGVyZSAwICR7b2Zmc2V0c1swXX0gOiAke2tleXNbTWF0aC5taW4oa2V5cy5sZW5ndGgtMSwgb2Zmc2V0c1swXSldLmxlbmd0aH0gICR7a2V5c1tNYXRoLm1pbihrZXlzLmxlbmd0aC0xLCBvZmZzZXRzWzBdKV19IGApO1xyXG4gICAgICAgICAvLyAgY29uc29sZS5sb2coYCBoZXJlIDUtMSAgJHtrZXlzW29mZnNldHNbNV0tMV0ubGVuZ3RofSAgJHtrZXlzW29mZnNldHNbNV0tMV19IGApO1xyXG4gICAgICAgICAvLyAgIGNvbnNvbGUubG9nKGAgaGVyZSA1ICR7b2Zmc2V0c1s1XX0gOiAke2tleXNbTWF0aC5taW4oa2V5cy5sZW5ndGgtMSwgb2Zmc2V0c1s1XSldLmxlbmd0aH0gICR7a2V5c1tNYXRoLm1pbihrZXlzLmxlbmd0aC0xLCBvZmZzZXRzWzVdKV19IGApO1xyXG4gICAgICAgICAgICBsYXN0bGVuID0gcmFuZ2VLZXkubGVuZ3RoO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IodmFyIGkgPSBvZmZzZXRzWzBdOyBpIDwgb2Zmc2V0c1s1XTsgKytpKSB7XHJcbiAgICAgICAgICAgIHZhciBkID0gRGlzdGFuY2UuY2FsY0Rpc3RhbmNlQWRqdXN0ZWQocmFuZ2VLZXksIGtleXNbaV0pO1xyXG4gICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3JhbmdlS2V5Lmxlbmd0aC1rZXlzW2ldLmxlbmd0aH0gJHtkfSAke3JhbmdlS2V5fSBhbmQgJHtrZXlzW2ldfSAgYCk7XHJcbiAgICAgICAgICAgIGlmICgoZCAhPT0gMS4wKSAmJiAoZCA+PSBBbGdvbC5DdXRvZmZfcmFuZ2VDbG9zZU1hdGNoKSkge1xyXG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgd291bGQgYWRkICR7cmFuZ2VLZXl9IGZvciAke2tleXNbaV19ICR7ZH1gKTtcclxuICAgICAgICAgICAgICAgIHZhciBjbnQgPSBydWxlcy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAvLyB3ZSBvbmx5IGhhdmUgdG8gYWRkIGlmIHRoZXJlIGlzIG5vdCB5ZXQgYSBtYXRjaCBydWxlIGhlcmUgd2hpY2ggcG9pbnRzIHRvIHRoZSBzYW1lXHJcbiAgICAgICAgICAgICAgICBhZGRSYW5nZVJ1bGVzVW5sZXNzUHJlc2VudChydWxlcyxrZXlzW2ldLHJhbmdlS2V5c01hcFtyYW5nZUtleV0sa2V5c01hcFtrZXlzW2ldXSxzZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICAgICAgaWYocnVsZXMubGVuZ3RoID4gY250KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgIGFkZGVkICR7KHJ1bGVzLmxlbmd0aCAtIGNudCl9IHJlY29yZHMgYXQke3JhbmdlS2V5fSBmb3IgJHtrZXlzW2ldfSAke2R9YCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvKlxyXG4gICAgW1xyXG4gICAgICAgIFsnYUVGRycsJ2FFRkdIJ10sXHJcbiAgICAgICAgWydhRUZHSCcsJ2FFRkdISSddLFxyXG4gICAgICAgIFsnT2RhdGEnLCdPRGF0YXMnXSxcclxuICAgWydPZGF0YScsJ09kYXRhcyddLFxyXG4gICBbJ09kYXRhJywnT2RhdGInXSxcclxuICAgWydPZGF0YScsJ1VEYXRhJ10sXHJcbiAgIFsnc2VydmljZScsJ3NlcnZpY2VzJ10sXHJcbiAgIFsndGhpcyBpc2Z1bm55IGFuZCBtb3JlJywndGhpcyBpc2Z1bm55IGFuZCBtb3JlcyddLFxyXG4gICAgXS5mb3JFYWNoKHJlYyA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYGRpc3RhbmNlICR7cmVjWzBdfSAke3JlY1sxXX0gOiAke0Rpc3RhbmNlLmNhbGNEaXN0YW5jZShyZWNbMF0scmVjWzFdKX0gIGFkZiAke0Rpc3RhbmNlLmNhbGNEaXN0YW5jZUFkanVzdGVkKHJlY1swXSxyZWNbMV0pfSBgKTtcclxuXHJcbiAgICB9KTtcclxuICAgIGNvbnNvbGUubG9nKFwiZGlzdGFuY2UgT2RhdGEgVWRhdGFcIisgRGlzdGFuY2UuY2FsY0Rpc3RhbmNlKCdPRGF0YScsJ1VEYXRhJykpO1xyXG4gICAgY29uc29sZS5sb2coXCJkaXN0YW5jZSBPZGF0YSBPZGF0YlwiKyBEaXN0YW5jZS5jYWxjRGlzdGFuY2UoJ09EYXRhJywnT0RhdGInKSk7XHJcbiAgICBjb25zb2xlLmxvZyhcImRpc3RhbmNlIE9kYXRhcyBPZGF0YVwiKyBEaXN0YW5jZS5jYWxjRGlzdGFuY2UoJ09EYXRhJywnT0RhdGFhJykpO1xyXG4gICAgY29uc29sZS5sb2coXCJkaXN0YW5jZSBPZGF0YXMgYWJjZGVcIisgRGlzdGFuY2UuY2FsY0Rpc3RhbmNlKCdhYmNkZScsJ2FiY2RlZicpKTtcclxuICAgIGNvbnNvbGUubG9nKFwiZGlzdGFuY2Ugc2VydmljZXMgXCIrIERpc3RhbmNlLmNhbGNEaXN0YW5jZSgnc2VydmljZXMnLCdzZXJ2aWNlJykpO1xyXG4gICAgKi9cclxufVxyXG52YXIgbiA9IDA7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbG9hZE1vZGVscyhtb2RlbFBhdGg/IDogc3RyaW5nLCBhZGRTcGxpdHM/IDogYm9vbGVhbikgOiBJTWF0Y2guSU1vZGVscyB7XHJcbiAgICB2YXIgb01vZGVsOiBJTWF0Y2guSU1vZGVscztcclxuICAgIG9Nb2RlbCA9IHtcclxuICAgICAgICBmdWxsIDogeyBkb21haW4gOiB7fX0sXHJcbiAgICAgICAgcmF3TW9kZWxzIDoge30sXHJcbiAgICAgICAgZG9tYWluczogW10sXHJcbiAgICAgICAgdG9vbHM6IFtdLFxyXG4gICAgICAgIHJ1bGVzIDogdW5kZWZpbmVkLFxyXG4gICAgICAgIGNhdGVnb3J5OiBbXSxcclxuICAgICAgICBvcGVyYXRvcnMgOiB7fSxcclxuICAgICAgICBtUnVsZXM6IFtdLFxyXG4gICAgICAgIHNlZW5SdWxlcyA6IHt9LFxyXG4gICAgICAgIHJlY29yZHM6IFtdLFxyXG4gICAgICAgIG1ldGEgOiB7IHQzIDoge30gfVxyXG4gICAgfVxyXG4gICAgZ2xvYmFsX0FkZFNwbGl0cyA9IHRydWU7IC8vIGFkZFNwbGl0cyB8fCAhcHJvY2Vzcy5lbnYuQUJPVF9PTERNQVRDSDtcclxuICAgIG1vZGVsUGF0aCA9IG1vZGVsUGF0aCB8fCBlbnZNb2RlbFBhdGg7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgIHZhciBhID0gQ2lyY3VsYXJTZXIubG9hZCgnLi8nICsgbW9kZWxQYXRoICsgJy9fY2FjaGUnICsgISFhZGRTcGxpdHMgKyAnLmpzJyk7XHJcbiAgICAgICAvL2NvbnNvbGUubG9nKFwiZm91bmQgYSBjYWNoZSA/ICBcIiArICEhYSk7XHJcbiAgICAgICAvL2EgPSB1bmRlZmluZWQ7XHJcbiAgICAgICBpZihhKSB7XHJcbiAgICAgICAgICAgZGVidWdsb2coXCIgcmV0dXJuIHByZXBhcmVzZSBtb2RlbCBcIik7XHJcbiAgICAgICAgICAgcmV0dXJuIGE7XHJcbiAgICAgICB9XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgLy9jb25zb2xlLmxvZygnZXJyb3InICsgZSk7XHJcbiAgICAgICAgLy8gbm8gY2FjaGUgZmlsZSxcclxuICAgIH1cclxuICAgIHZhciBzbWRscyA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy9tb2RlbHMuanNvbicsICd1dGYtOCcpO1xyXG4gICAgdmFyIG1kbHMgPSBKU09OLnBhcnNlKFwiXCIgKyBzbWRscyk7XHJcbiAgICBtZGxzLmZvckVhY2goZnVuY3Rpb24gKHNNb2RlbE5hbWUpIHtcclxuICAgICAgICBsb2FkTW9kZWwobW9kZWxQYXRoLCBzTW9kZWxOYW1lLCBvTW9kZWwpXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGNhdGVnb3JpZXMgdG8gdGhlIG1vZGVsOlxyXG4gICAgLypcclxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgYml0aW5kZXggOiBvTWRsLlxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgfSk7XHJcbiAgICAqL1xyXG5cclxuICAgIHZhciBtZXRhQml0SW5kZXggPSBnZXREb21haW5CaXRJbmRleCgnbWV0YScsb01vZGVsKTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGRvbWFpbiBtZXRhIHJ1bGVcclxuICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJtZXRhXCIsXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZG9tYWluXCIsXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogXCJkb21haW5cIixcclxuICAgICAgICAgICAgYml0aW5kZXggOiBtZXRhQml0SW5kZXgsXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcblxyXG5cclxuICAgIHZhciBmaWxsZXJCaXRJbmRleCA9IGdldERvbWFpbkJpdEluZGV4KCdtZXRhJyxvTW9kZWwpO1xyXG4gICAgLy9hZGQgYSBmaWxsZXIgcnVsZVxyXG4gICAgdmFyIHNmaWxsZXJzID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnL2ZpbGxlci5qc29uJywgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgZmlsbGVycyA9IEpTT04ucGFyc2Uoc2ZpbGxlcnMpO1xyXG4gICAgdmFyIHJlID0gXCJeKChcIiArIGZpbGxlcnMuam9pbihcIil8KFwiKSArIFwiKSkkXCI7XHJcbiAgICBvTW9kZWwubVJ1bGVzLnB1c2goe1xyXG4gICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxyXG4gICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuUkVHRVhQLFxyXG4gICAgICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChyZSwgXCJpXCIpLFxyXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXHJcbiAgICAgICAgYml0aW5kZXggOiBmaWxsZXJCaXRJbmRleCxcclxuICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICB9KTtcclxuXHJcbiAgICAvL2FkZCBvcGVyYXRvcnNcclxuICAgIHZhciBzT3BlcmF0b3JzID0gZnMucmVhZEZpbGVTeW5jKCcuL3Jlc291cmNlcy9tb2RlbC9vcGVyYXRvcnMuanNvbicsICd1dGYtOCcpO1xyXG4gICAgdmFyIG9wZXJhdG9ycyA9IEpTT04ucGFyc2Uoc09wZXJhdG9ycyk7XHJcbiAgICB2YXIgb3BlcmF0b3JCaXRJbmRleCA9IGdldERvbWFpbkJpdEluZGV4KCdvcGVyYXRvcnMnLG9Nb2RlbCk7XHJcbiAgICBPYmplY3Qua2V5cyhvcGVyYXRvcnMub3BlcmF0b3JzKS5mb3JFYWNoKGZ1bmN0aW9uKG9wZXJhdG9yKSB7XHJcbiAgICAgICAgaWYoSU1hdGNoLmFPcGVyYXRvck5hbWVzLmluZGV4T2Yob3BlcmF0b3IpIDwgMCkge1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZyhcInVua25vd24gb3BlcmF0b3IgXCIgKyBvcGVyYXRvcik7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInVua25vd24gb3BlcmF0b3IgXCIgKyBvcGVyYXRvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9Nb2RlbC5vcGVyYXRvcnNbb3BlcmF0b3JdID0gb3BlcmF0b3JzLm9wZXJhdG9yc1tvcGVyYXRvcl07XHJcbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0ub3BlcmF0b3IgPSA8SU1hdGNoLk9wZXJhdG9yTmFtZT4gb3BlcmF0b3I7XHJcbiAgICAgICAgT2JqZWN0LmZyZWV6ZShvTW9kZWwub3BlcmF0b3JzW29wZXJhdG9yXSk7XHJcbiAgICAgICAgdmFyIHdvcmQgPSBvcGVyYXRvcjtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwib3BlcmF0b3JcIixcclxuICAgICAgICAgICAgd29yZCA6IHdvcmQudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgbG93ZXJjYXNld29yZCA6IHdvcmQudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nIDogd29yZCxcclxuICAgICAgICAgICAgYml0aW5kZXggOiBvcGVyYXRvckJpdEluZGV4LFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgLy8gYWRkIGFsbCBzeW5vbnltc1xyXG4gICAgICAgIGlmKG9wZXJhdG9ycy5zeW5vbnltc1tvcGVyYXRvcl0pIHtcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMob3BlcmF0b3JzLnN5bm9ueW1zW29wZXJhdG9yXSkuZm9yRWFjaChmdW5jdGlvbihzeW5vbnltKSB7XHJcbiAgICAgICAgICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMse1xyXG4gICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBcIm9wZXJhdG9yXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgd29yZCA6IHN5bm9ueW0udG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgICAgICAgICBsb3dlcmNhc2V3b3JkIDogc3lub255bS50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nIDogb3BlcmF0b3IsXHJcbiAgICAgICAgICAgICAgICAgICAgYml0aW5kZXggOiBvcGVyYXRvckJpdEluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjlcclxuICAgICAgICAgICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8qXHJcbiAgICAgICAgfSlcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXHJcbiAgICAgICAgICB0eXBlOiAxLFxyXG4gICAgICAgICAgcmVnZXhwOiAvXigoc3RhcnQpfChzaG93KXwoZnJvbSl8KGluKSkkL2ksXHJcbiAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxyXG4gICAgICAgICAgX3Jhbmtpbmc6IDAuOVxyXG4gICAgICAgIH0sXHJcbiAgICAqL1xyXG4gICAgb01vZGVsLm1SdWxlcyA9IG9Nb2RlbC5tUnVsZXMuc29ydChJbnB1dEZpbHRlclJ1bGVzLmNtcE1SdWxlKTtcclxuICAgIGFkZENsb3NlRXhhY3RSYW5nZVJ1bGVzKG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgb01vZGVsLm1SdWxlcyA9IG9Nb2RlbC5tUnVsZXMuc29ydChJbnB1dEZpbHRlclJ1bGVzLmNtcE1SdWxlKTtcclxuXHJcbiAgICBvTW9kZWwucnVsZXMgPSBzcGxpdFJ1bGVzKG9Nb2RlbC5tUnVsZXMpO1xyXG4gICAgb01vZGVsLnRvb2xzID0gb01vZGVsLnRvb2xzLnNvcnQoVG9vbHMuY21wVG9vbHMpO1xyXG4gICAgZGVsZXRlIG9Nb2RlbC5zZWVuUnVsZXM7XHJcbiAgICBkZWJ1Z2xvZygnc2F2aW5nJyk7XHJcbiAgICBDaXJjdWxhclNlci5zYXZlKCcuLycgKyBtb2RlbFBhdGggKyAnL19jYWNoZScgKyAhIWFkZFNwbGl0cyArICcuanMnLG9Nb2RlbCk7XHJcbiAgICByZXR1cm4gb01vZGVsO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc29ydENhdGVnb3JpZXNCeUltcG9ydGFuY2UoIG1hcCA6IHtba2V5IDogc3RyaW5nXSA6IElNYXRjaC5JQ2F0ZWdvcnlEZXNjIH0sIGNhdHMgOiBzdHJpbmdbXSkgOiBzdHJpbmdbXSB7XHJcbiAgICB2YXIgcmVzID0gY2F0cy5zbGljZSgwKTtcclxuICAgIHJlcy5zb3J0KHJhbmtDYXRlZ29yeUJ5SW1wb3J0YW5jZS5iaW5kKHVuZGVmaW5lZCxtYXApKTtcclxuICAgIHJldHVybiByZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByYW5rQ2F0ZWdvcnlCeUltcG9ydGFuY2UobWFwIDoge1trZXkgOiBzdHJpbmddIDogSU1hdGNoLklDYXRlZ29yeURlc2MgfSwgY2F0YSA6IHN0cmluZywgY2F0YiA6IHN0cmluZykgOiBudW1iZXIge1xyXG4gICAgdmFyIGNhdEFEZXNjID0gbWFwW2NhdGFdO1xyXG4gICAgdmFyIGNhdEJEZXNjID0gbWFwW2NhdGJdO1xyXG4gICAgaWYgKGNhdGEgPT09IGNhdGIpIHtcclxuICAgICAgICByZXR1cm4gMDtcclxuICAgIH1cclxuICAgIC8vIGlmIGEgaXMgYmVmb3JlIGIsIHJldHVybiAtMVxyXG4gICAgaWYoY2F0QURlc2MgJiYgIWNhdEJEZXNjKSB7XHJcbiAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgfVxyXG4gICAgaWYoIWNhdEFEZXNjICYmIGNhdEJEZXNjKSB7XHJcbiAgICAgICAgcmV0dXJuICsxO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBwcmlvQSA9IChjYXRBRGVzYyAmJiBjYXRBRGVzYy5pbXBvcnRhbmNlKSB8fCA5OTtcclxuICAgIHZhciBwcmlvQiA9IChjYXRCRGVzYyAmJiBjYXRCRGVzYy5pbXBvcnRhbmNlKSB8fCA5OTtcclxuICAgIC8vIGxvd2VyIHByaW8gZ29lcyB0byBmcm9udFxyXG4gICAgdmFyIHIgPSBwcmlvQSAtIHByaW9CO1xyXG4gICAgaWYocikge1xyXG4gICAgICAgIHJldHVybiByO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGNhdGEubG9jYWxlQ29tcGFyZShjYXRiKTtcclxufVxyXG5cclxuY29uc3QgTWV0YUYgPSBNZXRhLmdldE1ldGFGYWN0b3J5KCk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0T3BlcmF0b3IobWRsOiBJTWF0Y2guSU1vZGVscywgb3BlcmF0b3IgOiBzdHJpbmcpIDogSU1hdGNoLklPcGVyYXRvciB7XHJcbiAgICByZXR1cm4gbWRsLm9wZXJhdG9yc1tvcGVyYXRvcl07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRSZXN1bHRBc0FycmF5KG1kbCA6IElNYXRjaC5JTW9kZWxzLCBhIDogTWV0YS5JTWV0YSwgcmVsIDogTWV0YS5JTWV0YSkgOiBNZXRhLklNZXRhW10ge1xyXG4gICAgaWYocmVsLnRvVHlwZSgpICE9PSAncmVsYXRpb24nKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZXhwZWN0IHJlbGF0aW9uIGFzIDJuZCBhcmdcIik7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHJlcyA9IG1kbC5tZXRhLnQzW2EudG9GdWxsU3RyaW5nKCldICYmXHJcbiAgICBtZGwubWV0YS50M1thLnRvRnVsbFN0cmluZygpXVtyZWwudG9GdWxsU3RyaW5nKCldO1xyXG4gICAgaWYoIXJlcykge1xyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhyZXMpLnNvcnQoKS5tYXAoTWV0YUYucGFyc2VJTWV0YSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRDYXRlZ29yaWVzRm9yRG9tYWluKHRoZU1vZGVsIDogSU1hdGNoLklNb2RlbHMsIGRvbWFpbiA6IHN0cmluZykgOiBzdHJpbmdbXSB7XHJcbiAgICBpZih0aGVNb2RlbC5kb21haW5zLmluZGV4T2YoZG9tYWluKSA8IDApIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEb21haW4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlcyA9IGdldFJlc3VsdEFzQXJyYXkodGhlTW9kZWwsIE1ldGFGLkRvbWFpbihkb21haW4pLCBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2hhc0NhdGVnb3J5KSk7XHJcbiAgICByZXR1cm4gTWV0YS5nZXRTdHJpbmdBcnJheShyZXMpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGFibGVDb2x1bW5zKHRoZU1vZGVsOiBJTWF0Y2guSU1vZGVscywgZG9tYWluIDogc3RyaW5nKSA6IHN0cmluZ1tdIHtcclxuICAgIGlmKHRoZU1vZGVsLmRvbWFpbnMuaW5kZXhPZihkb21haW4pIDwgMCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRvbWFpbiBcXFwiXCIgKyBkb21haW4gKyBcIlxcXCIgbm90IHBhcnQgb2YgbW9kZWxcIik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhlTW9kZWwucmF3TW9kZWxzW2RvbWFpbl0uY29sdW1ucy5zbGljZSgwKTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiBSZXR1cm4gYWxsIGNhdGVnb3JpZXMgb2YgYSBkb21haW4gd2hpY2ggY2FuIGFwcGVhciBvbiBhIHdvcmQsXHJcbiAqIHRoZXNlIGFyZSB0eXBpY2FsbHkgdGhlIHdvcmRpbmRleCBkb21haW5zICsgZW50cmllcyBnZW5lcmF0ZWQgYnkgZ2VuZXJpYyBydWxlc1xyXG4gKlxyXG4gKiBUaGUgY3VycmVudCBpbXBsZW1lbnRhdGlvbiBpcyBhIHNpbXBsaWZpY2F0aW9uXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4odGhlTW9kZWwgOiBJTWF0Y2guSU1vZGVscywgZG9tYWluIDogc3RyaW5nKSA6IHN0cmluZ1tdIHtcclxuICAgIC8vIHRoaXMgaXMgYSBzaW1wbGlmaWVkIHZlcnNpb25cclxuICAgIHJldHVybiBnZXRDYXRlZ29yaWVzRm9yRG9tYWluKHRoZU1vZGVsLCBkb21haW4pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RG9tYWluc0ZvckNhdGVnb3J5KHRoZU1vZGVsIDogSU1hdGNoLklNb2RlbHMsIGNhdGVnb3J5IDogc3RyaW5nKSA6IHN0cmluZ1tdIHtcclxuICAgIGlmKHRoZU1vZGVsLmNhdGVnb3J5LmluZGV4T2YoY2F0ZWdvcnkpIDwgMCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhdGVnb3J5IFxcXCJcIiArIGNhdGVnb3J5ICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlcyA9IGdldFJlc3VsdEFzQXJyYXkodGhlTW9kZWwsIE1ldGFGLkNhdGVnb3J5KGNhdGVnb3J5KSwgTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9pc0NhdGVnb3J5T2YpKTtcclxuICAgIHJldHVybiBNZXRhLmdldFN0cmluZ0FycmF5KHJlcyk7XHJcbn1cclxuXHJcblxyXG4gZXhwb3J0IGZ1bmN0aW9uIGdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yeShtb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBjYXRlZ29yeSA6IHN0cmluZywgd29yZHNvbmx5IDogYm9vbGVhbikgOiB7W2tleTogc3RyaW5nXSA6IGJvb2xlYW59IHtcclxuICAgIHZhciByZXMgPSB7fTtcclxuICAgIC8vXHJcbiAgICB2YXIgZm4gPSB3b3Jkc29ubHkgPyBnZXRQb3RlbnRpYWxXb3JkQ2F0ZWdvcmllc0ZvckRvbWFpbiA6IGdldENhdGVnb3JpZXNGb3JEb21haW47XHJcbiAgICB2YXIgZG9tYWlucyA9IGdldERvbWFpbnNGb3JDYXRlZ29yeShtb2RlbCwgY2F0ZWdvcnkpO1xyXG4gICAgZG9tYWlucy5mb3JFYWNoKGZ1bmN0aW9uKGRvbWFpbikge1xyXG4gICAgICAgIGZuKG1vZGVsLCBkb21haW4pLmZvckVhY2goZnVuY3Rpb24od29yZGNhdCkge1xyXG4gICAgICAgICAgICByZXNbd29yZGNhdF0gPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBPYmplY3QuZnJlZXplKHJlcyk7XHJcbiAgICByZXR1cm4gcmVzO1xyXG4gfVxyXG5cclxuIGV4cG9ydCBmdW5jdGlvbiBnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcmllcyhtb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBjYXRlZ29yaWVzIDogc3RyaW5nW10sIHdvcmRzb25seSA6IGJvb2xlYW4pIDoge1trZXk6IHN0cmluZ10gOiBib29sZWFufSB7XHJcbiAgICB2YXIgcmVzID0ge307XHJcbiAgICAvL1xyXG4gICAgdmFyIGZuID0gd29yZHNvbmx5ID8gZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4gOiBnZXRDYXRlZ29yaWVzRm9yRG9tYWluO1xyXG4gICAgdmFyIGRvbWFpbnMgPSB1bmRlZmluZWQ7XHJcbiAgICBjYXRlZ29yaWVzLmZvckVhY2goZnVuY3Rpb24oY2F0ZWdvcnkpIHtcclxuICAgICAgICB2YXIgY2F0ZG9tYWlucyA9IGdldERvbWFpbnNGb3JDYXRlZ29yeShtb2RlbCwgY2F0ZWdvcnkpXHJcbiAgICAgICAgaWYoIWRvbWFpbnMpIHtcclxuICAgICAgICAgICAgZG9tYWlucyA9IGNhdGRvbWFpbnM7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZG9tYWlucyA9IF8uaW50ZXJzZWN0aW9uKGRvbWFpbnMsIGNhdGRvbWFpbnMpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgaWYoZG9tYWlucy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhdGVnb3JpZXMgJyArIFV0aWxzLmxpc3RUb1F1b3RlZENvbW1hQW5kKGNhdGVnb3JpZXMpICsgJyBoYXZlIG5vIGNvbW1vbiBkb21haW4uJylcclxuICAgIH1cclxuICAgIGRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbihkb21haW4pIHtcclxuICAgICAgICBmbihtb2RlbCwgZG9tYWluKS5mb3JFYWNoKGZ1bmN0aW9uKHdvcmRjYXQpIHtcclxuICAgICAgICAgICAgcmVzW3dvcmRjYXRdID0gdHJ1ZTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgT2JqZWN0LmZyZWV6ZShyZXMpO1xyXG4gICAgcmV0dXJuIHJlcztcclxuIH1cclxuXHJcblxyXG4iLCIvKipcbiAqIEZ1bmN0aW9uYWxpdHkgbWFuYWdpbmcgdGhlIG1hdGNoIG1vZGVsc1xuICpcbiAqIEBmaWxlXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vZGVsJyk7XG52YXIgbG9nZ2VyID0gcmVxdWlyZShcIi4uL3V0aWxzL2xvZ2dlclwiKTtcbnZhciBsb2FkbG9nID0gbG9nZ2VyLmxvZ2dlcignbW9kZWxsb2FkJywgJycpO1xudmFyIElNYXRjaCA9IHJlcXVpcmUoXCIuLi9tYXRjaC9pZm1hdGNoXCIpO1xudmFyIElucHV0RmlsdGVyUnVsZXMgPSByZXF1aXJlKFwiLi4vbWF0Y2gvaW5wdXRGaWx0ZXJSdWxlc1wiKTtcbnZhciBUb29scyA9IHJlcXVpcmUoXCIuLi9tYXRjaC90b29sc1wiKTtcbnZhciBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcbnZhciBNZXRhID0gcmVxdWlyZShcIi4vbWV0YVwiKTtcbnZhciBVdGlscyA9IHJlcXVpcmUoXCIuLi91dGlscy91dGlsc1wiKTtcbnZhciBDaXJjdWxhclNlciA9IHJlcXVpcmUoXCIuLi91dGlscy9jaXJjdWxhcnNlclwiKTtcbnZhciBwcm9jZXNzID0gcmVxdWlyZShcInByb2Nlc3NcIik7XG52YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5leHBvcnRzLmdsb2JhbF9BZGRTcGxpdHMgPSB0cnVlOyAvLyBmYWxzZTtcbi8qKlxuICogdGhlIG1vZGVsIHBhdGgsIG1heSBiZSBjb250cm9sbGVkIHZpYSBlbnZpcm9ubWVudCB2YXJpYWJsZVxuICovXG52YXIgZW52TW9kZWxQYXRoID0gcHJvY2Vzcy5lbnZbXCJBQk9UX01PREVMUEFUSFwiXSB8fCBcInRlc3Rtb2RlbFwiO1xudmFyIEFSUl9NT0RFTF9QUk9QRVJUSUVTID0gW1wiZG9tYWluXCIsIFwiYml0aW5kZXhcIiwgXCJkZWZhdWx0a2V5Y29sdW1uXCIsIFwiZGVmYXVsdHVyaVwiLCBcImNhdGVnb3J5RGVzY3JpYmVkXCIsIFwiY29sdW1uc1wiLCBcImRlc2NyaXB0aW9uXCIsIFwidG9vbFwiLCBcInRvb2xoaWRkZW5cIiwgXCJzeW5vbnltc1wiLCBcImNhdGVnb3J5XCIsIFwid29yZGluZGV4XCIsIFwiZXhhY3RtYXRjaFwiLCBcImhpZGRlblwiXTtcbmZ1bmN0aW9uIGFkZFN5bm9ueW1zKHN5bm9ueW1zLCBjYXRlZ29yeSwgc3lub255bUZvciwgYml0aW5kZXgsIG1SdWxlcywgc2Vlbikge1xuICAgIHN5bm9ueW1zLmZvckVhY2goZnVuY3Rpb24gKHN5bikge1xuICAgICAgICB2YXIgb1J1bGUgPSB7XG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzeW5vbnltRm9yLFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogc3luLFxuICAgICAgICAgICAgYml0aW5kZXg6IGJpdGluZGV4LFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfTtcbiAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcImluc2VydGluZyBzeW5vbnltXCIgKyBKU09OLnN0cmluZ2lmeShvUnVsZSkpIDogJy0nKTtcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIG9SdWxlLCBzZWVuKTtcbiAgICB9KTtcbn1cbmZ1bmN0aW9uIGdldFJ1bGVLZXkocnVsZSkge1xuICAgIHZhciByMSA9IHJ1bGUubWF0Y2hlZFN0cmluZyArIFwiLXwtXCIgKyBydWxlLmNhdGVnb3J5ICsgXCIgLXwtIFwiICsgcnVsZS50eXBlICsgXCIgLXwtIFwiICsgcnVsZS53b3JkICsgXCIgXCI7XG4gICAgaWYgKHJ1bGUucmFuZ2UpIHtcbiAgICAgICAgdmFyIHIyID0gZ2V0UnVsZUtleShydWxlLnJhbmdlLnJ1bGUpO1xuICAgICAgICByMSArPSBcIiAtfC0gXCIgKyBydWxlLnJhbmdlLmxvdyArIFwiL1wiICsgcnVsZS5yYW5nZS5oaWdoICsgXCIgLXwtIFwiICsgcjI7XG4gICAgfVxuICAgIHJldHVybiByMTtcbn1cbnZhciBCcmVha2Rvd24gPSByZXF1aXJlKFwiLi4vbWF0Y2gvYnJlYWtkb3duXCIpO1xuLyogZ2l2ZW4gYSBydWxlIHdoaWNoIHJlcHJlc2VudHMgYSB3b3JkIHNlcXVlbmNlIHdoaWNoIGlzIHNwbGl0IGR1cmluZyB0b2tlbml6YXRpb24gKi9cbmZ1bmN0aW9uIGFkZEJlc3RTcGxpdChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcykge1xuICAgIGlmICghZXhwb3J0cy5nbG9iYWxfQWRkU3BsaXRzKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHJ1bGUudHlwZSAhPT0gMCAvKiBXT1JEICovKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIGJlc3QgPSBCcmVha2Rvd24ubWFrZU1hdGNoUGF0dGVybihydWxlLmxvd2VyY2FzZXdvcmQpO1xuICAgIGlmICghYmVzdCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBuZXdSdWxlID0ge1xuICAgICAgICBjYXRlZ29yeTogcnVsZS5jYXRlZ29yeSxcbiAgICAgICAgbWF0Y2hlZFN0cmluZzogcnVsZS5tYXRjaGVkU3RyaW5nLFxuICAgICAgICBiaXRpbmRleDogcnVsZS5iaXRpbmRleCxcbiAgICAgICAgd29yZDogYmVzdC5sb25nZXN0VG9rZW4sXG4gICAgICAgIHR5cGU6IDAsXG4gICAgICAgIGxvd2VyY2FzZXdvcmQ6IGJlc3QubG9uZ2VzdFRva2VuLFxuICAgICAgICBfcmFua2luZzogMC45NSxcbiAgICAgICAgLy8gICAgZXhhY3RPbmx5IDogcnVsZS5leGFjdE9ubHksXG4gICAgICAgIHJhbmdlOiBiZXN0LnNwYW5cbiAgICB9O1xuICAgIGlmIChydWxlLmV4YWN0T25seSkge1xuICAgICAgICBuZXdSdWxlLmV4YWN0T25seSA9IHJ1bGUuZXhhY3RPbmx5O1xuICAgIH1cbiAgICA7XG4gICAgbmV3UnVsZS5yYW5nZS5ydWxlID0gcnVsZTtcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgbmV3UnVsZSwgc2VlblJ1bGVzKTtcbn1cbmV4cG9ydHMuYWRkQmVzdFNwbGl0ID0gYWRkQmVzdFNwbGl0O1xuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcykge1xuICAgIGlmIChydWxlLnR5cGUgIT09IDAgLyogV09SRCAqLykge1xuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICB2YXIgciA9IGdldFJ1bGVLZXkocnVsZSk7XG4gICAgLyogaWYoIChydWxlLndvcmQgPT09IFwic2VydmljZVwiIHx8IHJ1bGUud29yZD09PSBcInNlcnZpY2VzXCIpICYmIHIuaW5kZXhPZignT0RhdGEnKSA+PSAwKSB7XG4gICAgICAgICBjb25zb2xlLmxvZyhcInJ1bGVrZXkgaXNcIiArIHIpO1xuICAgICAgICAgY29uc29sZS5sb2coXCJwcmVzZW5jZSBpcyBcIiArIEpTT04uc3RyaW5naWZ5KHNlZW5SdWxlc1tyXSkpO1xuICAgICB9Ki9cbiAgICBydWxlLmxvd2VyY2FzZXdvcmQgPSBydWxlLndvcmQudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAoc2VlblJ1bGVzW3JdKSB7XG4gICAgICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJBdHRlbXB0aW5nIHRvIGluc2VydCBkdXBsaWNhdGVcIiArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpIDogXCItXCIpO1xuICAgICAgICB2YXIgZHVwbGljYXRlcyA9IHNlZW5SdWxlc1tyXS5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICAgICAgcmV0dXJuIDAgPT09IElucHV0RmlsdGVyUnVsZXMuY29tcGFyZU1SdWxlRnVsbChvRW50cnksIHJ1bGUpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGR1cGxpY2F0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuICAgIHNlZW5SdWxlc1tyXSA9IChzZWVuUnVsZXNbcl0gfHwgW10pO1xuICAgIHNlZW5SdWxlc1tyXS5wdXNoKHJ1bGUpO1xuICAgIGlmIChydWxlLndvcmQgPT09IFwiXCIpIHtcbiAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/ICgnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpIDogJy0nKTtcbiAgICAgICAgbG9hZGxvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xuICAgIGFkZEJlc3RTcGxpdChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcyk7XG4gICAgcmV0dXJuO1xufVxuZnVuY3Rpb24gbG9hZE1vZGVsRGF0YShtb2RlbFBhdGgsIG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCkge1xuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cbiAgICAvLyBkYXRhIGlzIHByb2Nlc3NlZCBpbnRvIG1SdWxlcyBkaXJlY3RseSxcbiAgICB2YXIgYml0aW5kZXggPSBvTWRsLmJpdGluZGV4O1xuICAgIHZhciBzRmlsZU5hbWUgPSAoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5kYXRhLmpzb25cIik7XG4gICAgdmFyIG1kbGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoc0ZpbGVOYW1lLCAndXRmLTgnKTtcbiAgICB2YXIgb01kbERhdGEgPSBKU09OLnBhcnNlKG1kbGRhdGEpO1xuICAgIG9NZGxEYXRhLmZvckVhY2goZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICBpZiAoIW9FbnRyeS50b29sKSB7XG4gICAgICAgICAgICBvRW50cnkuX2RvbWFpbiA9IG9NZGwuZG9tYWluO1xuICAgICAgICB9XG4gICAgICAgIGlmICghb0VudHJ5LnRvb2wgJiYgb01kbC50b29sLm5hbWUpIHtcbiAgICAgICAgICAgIG9FbnRyeS50b29sID0gb01kbC50b29sLm5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgb01vZGVsLnJlY29yZHMucHVzaChvRW50cnkpO1xuICAgICAgICBvTWRsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24gKGNhdCkge1xuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRdID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIG9FbnRyeVtjYXRdID0gXCJuL2FcIjtcbiAgICAgICAgICAgICAgICB2YXIgYnVnID0gXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiICsgY2F0ICsgXCIgd2l0aCB2YWx1ZSAndW5kZWZpbmVkJywgdW5kZWZpbmVkIGlzIGlsbGVnYWwgdmFsdWUsIHVzZSBuL2EgXCIgKyBKU09OLnN0cmluZ2lmeShvRW50cnkpICsgXCJcIjtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhidWcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIklOQ09OU0lTVEVOVCo+IE1vZGVsRGF0YSBcIiArIHNGaWxlTmFtZSArIFwiIGRvZXMgbm90IGNvbnRhaW4gY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIG9mIHdvcmRpbmRleFwiICsgSlNPTi5zdHJpbmdpZnkob0VudHJ5KSArIFwiXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xuICAgICAgICAgICAgICAgIHZhciBzU3RyaW5nID0gb0VudHJ5W2NhdGVnb3J5XTtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcInB1c2hpbmcgcnVsZSB3aXRoIFwiICsgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xuICAgICAgICAgICAgICAgIHZhciBvUnVsZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICAgICAgICAgIHdvcmQ6IHNTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIGJpdGluZGV4OiBiaXRpbmRleCxcbiAgICAgICAgICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGlmIChvTWRsLmV4YWN0bWF0Y2ggJiYgb01kbC5leGFjdG1hdGNoLmluZGV4T2YoY2F0ZWdvcnkpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgb1J1bGUuZXhhY3RPbmx5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCBvUnVsZSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICAgICAgaWYgKG9NZGxEYXRhLnN5bm9ueW1zICYmIG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSkge1xuICAgICAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0sIGNhdGVnb3J5LCBzU3RyaW5nLCBiaXRpbmRleCwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChvRW50cnkuc3lub255bXMgJiYgb0VudHJ5LnN5bm9ueW1zW2NhdGVnb3J5XSkge1xuICAgICAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvRW50cnkuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgYml0aW5kZXgsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5mdW5jdGlvbiBsb2FkTW9kZWwobW9kZWxQYXRoLCBzTW9kZWxOYW1lLCBvTW9kZWwpIHtcbiAgICBkZWJ1Z2xvZyhcIiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSArIFwiIC4uLi5cIik7XG4gICAgdmFyIG1kbCA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLm1vZGVsLmpzb25cIiwgJ3V0Zi04Jyk7XG4gICAgdmFyIG9NZGwgPSBKU09OLnBhcnNlKG1kbCk7XG4gICAgbWVyZ2VNb2RlbEpzb24oc01vZGVsTmFtZSwgb01kbCwgb01vZGVsKTtcbiAgICBsb2FkTW9kZWxEYXRhKG1vZGVsUGF0aCwgb01kbCwgc01vZGVsTmFtZSwgb01vZGVsKTtcbn1cbmZ1bmN0aW9uIGdldERvbWFpbkJpdEluZGV4KGRvbWFpbiwgb01vZGVsKSB7XG4gICAgdmFyIGluZGV4ID0gb01vZGVsLmRvbWFpbnMuaW5kZXhPZihkb21haW4pO1xuICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgICAgaW5kZXggPSBvTW9kZWwuZG9tYWlucy5sZW5ndGg7XG4gICAgfVxuICAgIGlmIChpbmRleCA+PSAzMikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJ0b28gbWFueSBkb21haW4gZm9yIHNpbmdsZSAzMiBiaXQgaW5kZXhcIik7XG4gICAgfVxuICAgIHJldHVybiAweDAwMDEgPDwgaW5kZXg7XG59XG5leHBvcnRzLmdldERvbWFpbkJpdEluZGV4ID0gZ2V0RG9tYWluQml0SW5kZXg7XG5mdW5jdGlvbiBtZXJnZU1vZGVsSnNvbihzTW9kZWxOYW1lLCBvTWRsLCBvTW9kZWwpIHtcbiAgICB2YXIgY2F0ZWdvcnlEZXNjcmliZWRNYXAgPSB7fTtcbiAgICBvTWRsLmJpdGluZGV4ID0gZ2V0RG9tYWluQml0SW5kZXgob01kbC5kb21haW4sIG9Nb2RlbCk7XG4gICAgb01kbC5jYXRlZ29yeURlc2NyaWJlZCA9IFtdO1xuICAgIC8vIHJlY3RpZnkgY2F0ZWdvcnlcbiAgICBvTWRsLmNhdGVnb3J5ID0gb01kbC5jYXRlZ29yeS5tYXAoZnVuY3Rpb24gKGNhdCkge1xuICAgICAgICBpZiAodHlwZW9mIGNhdCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgcmV0dXJuIGNhdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIGNhdC5uYW1lICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk1pc3NpbmcgbmFtZSBpbiBvYmplY3QgdHlwZWQgY2F0ZWdvcnkgaW4gXCIgKyBKU09OLnN0cmluZ2lmeShjYXQpICsgXCIgaW4gbW9kZWwgXCIgKyBzTW9kZWxOYW1lKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0ZWdvcnlEZXNjcmliZWRNYXBbY2F0Lm5hbWVdID0gY2F0O1xuICAgICAgICBvTWRsLmNhdGVnb3J5RGVzY3JpYmVkLnB1c2goY2F0KTtcbiAgICAgICAgcmV0dXJuIGNhdC5uYW1lO1xuICAgIH0pO1xuICAgIC8vIGFkZCB0aGUgY2F0ZWdvcmllcyB0byB0aGUgbW9kZWw6XG4gICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcImNhdGVnb3J5XCIsXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIHdvcmQ6IGNhdGVnb3J5LFxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIGJpdGluZGV4OiBvTWRsLmJpdGluZGV4LFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgfSk7XG4gICAgaWYgKG9Nb2RlbC5kb21haW5zLmluZGV4T2Yob01kbC5kb21haW4pID49IDApIHtcbiAgICAgICAgZGVidWdsb2coXCIqKioqKioqKioqKmhlcmUgbWRsXCIgKyBKU09OLnN0cmluZ2lmeShvTWRsLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb21haW4gJyArIG9NZGwuZG9tYWluICsgJyBhbHJlYWR5IGxvYWRlZCB3aGlsZSBsb2FkaW5nICcgKyBzTW9kZWxOYW1lICsgJz8nKTtcbiAgICB9XG4gICAgLy8gY2hlY2sgcHJvcGVydGllcyBvZiBtb2RlbFxuICAgIE9iamVjdC5rZXlzKG9NZGwpLnNvcnQoKS5mb3JFYWNoKGZ1bmN0aW9uIChzUHJvcGVydHkpIHtcbiAgICAgICAgaWYgKEFSUl9NT0RFTF9QUk9QRVJUSUVTLmluZGV4T2Yoc1Byb3BlcnR5KSA8IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgcHJvcGVydHkgXCInICsgc1Byb3BlcnR5ICsgJ1wiIG5vdCBhIGtub3duIG1vZGVsIHByb3BlcnR5IGluIG1vZGVsIG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gY29uc2lkZXIgc3RyZWFtbGluaW5nIHRoZSBjYXRlZ29yaWVzXG4gICAgb01vZGVsLnJhd01vZGVsc1tvTWRsLmRvbWFpbl0gPSBvTWRsO1xuICAgIG9Nb2RlbC5mdWxsLmRvbWFpbltvTWRsLmRvbWFpbl0gPSB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiBvTWRsLmRlc2NyaXB0aW9uLFxuICAgICAgICBjYXRlZ29yaWVzOiBjYXRlZ29yeURlc2NyaWJlZE1hcCxcbiAgICAgICAgYml0aW5kZXg6IG9NZGwuYml0aW5kZXhcbiAgICB9O1xuICAgIC8vIGNoZWNrIHRoYXQgbWVtYmVycyBvZiB3b3JkaW5kZXggYXJlIGluIGNhdGVnb3JpZXMsXG4gICAgb01kbC53b3JkaW5kZXggPSBvTWRsLndvcmRpbmRleCB8fCBbXTtcbiAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uIChzV29yZEluZGV4KSB7XG4gICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc1dvcmRJbmRleCkgPCAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIHdvcmRpbmRleCBcIicgKyBzV29yZEluZGV4ICsgJ1wiIG5vdCBhIGNhdGVnb3J5IG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgb01kbC5leGFjdG1hdGNoID0gb01kbC5leGFjdG1hdGNoIHx8IFtdO1xuICAgIG9NZGwuZXhhY3RtYXRjaC5mb3JFYWNoKGZ1bmN0aW9uIChzRXhhY3RNYXRjaCkge1xuICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNFeGFjdE1hdGNoKSA8IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgZXhhY3RtYXRjaCBcIicgKyBzRXhhY3RNYXRjaCArICdcIiBub3QgYSBjYXRlZ29yeSBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vIGFkZCByZWxhdGlvbiBkb21haW4gLT4gY2F0ZWdvcnlcbiAgICB2YXIgZG9tYWluU3RyID0gTWV0YUYuRG9tYWluKG9NZGwuZG9tYWluKS50b0Z1bGxTdHJpbmcoKTtcbiAgICB2YXIgcmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2hhc0NhdGVnb3J5KS50b0Z1bGxTdHJpbmcoKTtcbiAgICB2YXIgcmV2ZXJzZVJlbGF0aW9uU3RyID0gTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9pc0NhdGVnb3J5T2YpLnRvRnVsbFN0cmluZygpO1xuICAgIG9NZGwuY2F0ZWdvcnkuZm9yRWFjaChmdW5jdGlvbiAoc0NhdGVnb3J5KSB7XG4gICAgICAgIHZhciBDYXRlZ29yeVN0cmluZyA9IE1ldGFGLkNhdGVnb3J5KHNDYXRlZ29yeSkudG9GdWxsU3RyaW5nKCk7XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl0gPSBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdIHx8IHt9O1xuICAgICAgICBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdW3JlbGF0aW9uU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdIHx8IHt9O1xuICAgICAgICBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdW3JlbGF0aW9uU3RyXVtDYXRlZ29yeVN0cmluZ10gPSB7fTtcbiAgICAgICAgb01vZGVsLm1ldGEudDNbQ2F0ZWdvcnlTdHJpbmddID0gb01vZGVsLm1ldGEudDNbQ2F0ZWdvcnlTdHJpbmddIHx8IHt9O1xuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ11bcmV2ZXJzZVJlbGF0aW9uU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdIHx8IHt9O1xuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ11bcmV2ZXJzZVJlbGF0aW9uU3RyXVtkb21haW5TdHJdID0ge307XG4gICAgfSk7XG4gICAgLy8gYWRkIGEgcHJlY2ljZSBkb21haW4gbWF0Y2hydWxlXG4gICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XG4gICAgICAgIGNhdGVnb3J5OiBcImRvbWFpblwiLFxuICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLmRvbWFpbixcbiAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICB3b3JkOiBvTWRsLmRvbWFpbixcbiAgICAgICAgYml0aW5kZXg6IG9NZGwuYml0aW5kZXgsXG4gICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgLy8gY2hlY2sgdGhlIHRvb2xcbiAgICBpZiAob01kbC50b29sICYmIG9NZGwudG9vbC5yZXF1aXJlcykge1xuICAgICAgICB2YXIgcmVxdWlyZXMgPSBPYmplY3Qua2V5cyhvTWRsLnRvb2wucmVxdWlyZXMgfHwge30pO1xuICAgICAgICB2YXIgZGlmZiA9IF8uZGlmZmVyZW5jZShyZXF1aXJlcywgb01kbC5jYXRlZ29yeSk7XG4gICAgICAgIGlmIChkaWZmLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIFwiICsgb01kbC5kb21haW4gKyBcIiA6IFVua293biBjYXRlZ29yeSBpbiByZXF1aXJlcyBvZiB0b29sOiBcXFwiXCIgKyBkaWZmLmpvaW4oJ1wiJykgKyAnXCInKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG9wdGlvbmFsID0gT2JqZWN0LmtleXMob01kbC50b29sLm9wdGlvbmFsKTtcbiAgICAgICAgZGlmZiA9IF8uZGlmZmVyZW5jZShvcHRpb25hbCwgb01kbC5jYXRlZ29yeSk7XG4gICAgICAgIGlmIChkaWZmLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIFwiICsgb01kbC5kb21haW4gKyBcIiA6IFVua293biBjYXRlZ29yeSBvcHRpb25hbCBvZiB0b29sOiBcXFwiXCIgKyBkaWZmLmpvaW4oJ1wiJykgKyAnXCInKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgICAgIH1cbiAgICAgICAgT2JqZWN0LmtleXMob01kbC50b29sLnNldHMgfHwge30pLmZvckVhY2goZnVuY3Rpb24gKHNldElEKSB7XG4gICAgICAgICAgICB2YXIgZGlmZiA9IF8uZGlmZmVyZW5jZShvTWRsLnRvb2wuc2V0c1tzZXRJRF0uc2V0LCBvTWRsLmNhdGVnb3J5KTtcbiAgICAgICAgICAgIGlmIChkaWZmLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIiBcIiArIG9NZGwuZG9tYWluICsgXCIgOiBVbmtvd24gY2F0ZWdvcnkgaW4gc2V0SWQgXCIgKyBzZXRJRCArIFwiIG9mIHRvb2w6IFxcXCJcIiArIGRpZmYuam9pbignXCInKSArICdcIicpO1xuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBleHRyYWN0IHRvb2xzIGFuIGFkZCB0byB0b29sczpcbiAgICAgICAgb01vZGVsLnRvb2xzLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IChvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJUb29sIFwiICsgb01kbC50b29sLm5hbWUgKyBcIiBhbHJlYWR5IHByZXNlbnQgd2hlbiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSk7XG4gICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiBhbHJlYWR5IGxvYWRlZD8nKTtcbiAgICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIG9NZGwudG9vbGhpZGRlbiA9IHRydWU7XG4gICAgICAgIG9NZGwudG9vbC5yZXF1aXJlcyA9IHsgXCJpbXBvc3NpYmxlXCI6IHt9IH07XG4gICAgfVxuICAgIC8vIGFkZCB0aGUgdG9vbCBuYW1lIGFzIHJ1bGUgdW5sZXNzIGhpZGRlblxuICAgIGlmICghb01kbC50b29saGlkZGVuICYmIG9NZGwudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkge1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcInRvb2xcIixcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwudG9vbC5uYW1lLFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogb01kbC50b29sLm5hbWUsXG4gICAgICAgICAgICBiaXRpbmRleDogb01kbC5iaXRpbmRleCxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH1cbiAgICA7XG4gICAgaWYgKG9NZGwuc3lub255bXMgJiYgb01kbC5zeW5vbnltc1tcInRvb2xcIl0pIHtcbiAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tcInRvb2xcIl0sIFwidG9vbFwiLCBvTWRsLnRvb2wubmFtZSwgb01kbC5iaXRpbmRleCwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgfVxuICAgIDtcbiAgICBpZiAob01kbC5zeW5vbnltcykge1xuICAgICAgICBPYmplY3Qua2V5cyhvTWRsLnN5bm9ueW1zKS5mb3JFYWNoKGZ1bmN0aW9uIChzc3lua2V5KSB7XG4gICAgICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNzeW5rZXkpID49IDAgJiYgc3N5bmtleSAhPT0gXCJ0b29sXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAob01vZGVsLmZ1bGwuZG9tYWluW29NZGwuZG9tYWluXS5jYXRlZ29yaWVzW3NzeW5rZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIG9Nb2RlbC5mdWxsLmRvbWFpbltvTWRsLmRvbWFpbl0uY2F0ZWdvcmllc1tzc3lua2V5XS5zeW5vbnltcyA9IG9NZGwuc3lub255bXNbc3N5bmtleV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbc3N5bmtleV0sIFwiY2F0ZWdvcnlcIiwgc3N5bmtleSwgb01kbC5iaXRpbmRleCwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBvTW9kZWwuZG9tYWlucy5wdXNoKG9NZGwuZG9tYWluKTtcbiAgICBpZiAob01kbC50b29sLm5hbWUpIHtcbiAgICAgICAgb01vZGVsLnRvb2xzLnB1c2gob01kbC50b29sKTtcbiAgICB9XG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmNvbmNhdChvTWRsLmNhdGVnb3J5KTtcbiAgICBvTW9kZWwuY2F0ZWdvcnkuc29ydCgpO1xuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5maWx0ZXIoZnVuY3Rpb24gKHN0cmluZywgaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIG9Nb2RlbC5jYXRlZ29yeVtpbmRleF0gIT09IG9Nb2RlbC5jYXRlZ29yeVtpbmRleCArIDFdO1xuICAgIH0pO1xufSAvLyBsb2FkbW9kZWxcbmZ1bmN0aW9uIHNwbGl0UnVsZXMocnVsZXMpIHtcbiAgICB2YXIgcmVzID0ge307XG4gICAgdmFyIG5vbldvcmRSdWxlcyA9IFtdO1xuICAgIHJ1bGVzLmZvckVhY2goZnVuY3Rpb24gKHJ1bGUpIHtcbiAgICAgICAgaWYgKHJ1bGUudHlwZSA9PT0gMCAvKiBXT1JEICovKSB7XG4gICAgICAgICAgICBpZiAoIXJ1bGUubG93ZXJjYXNld29yZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlJ1bGUgaGFzIG5vIG1lbWJlciBsb3dlcmNhc2V3b3JkXCIgKyBKU09OLnN0cmluZ2lmeShydWxlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXNbcnVsZS5sb3dlcmNhc2V3b3JkXSA9IHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdIHx8IHsgYml0aW5kZXg6IDAsIHJ1bGVzOiBbXSB9O1xuICAgICAgICAgICAgcmVzW3J1bGUubG93ZXJjYXNld29yZF0uYml0aW5kZXggPSByZXNbcnVsZS5sb3dlcmNhc2V3b3JkXS5iaXRpbmRleCB8IHJ1bGUuYml0aW5kZXg7XG4gICAgICAgICAgICByZXNbcnVsZS5sb3dlcmNhc2V3b3JkXS5ydWxlcy5wdXNoKHJ1bGUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgbm9uV29yZFJ1bGVzLnB1c2gocnVsZSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgICB3b3JkTWFwOiByZXMsXG4gICAgICAgIG5vbldvcmRSdWxlczogbm9uV29yZFJ1bGVzLFxuICAgICAgICBhbGxSdWxlczogcnVsZXNcbiAgICB9O1xufVxuZXhwb3J0cy5zcGxpdFJ1bGVzID0gc3BsaXRSdWxlcztcbmZ1bmN0aW9uIGNtcExlbmd0aFNvcnQoYSwgYikge1xuICAgIHZhciBkID0gYS5sZW5ndGggLSBiLmxlbmd0aDtcbiAgICBpZiAoZCkge1xuICAgICAgICByZXR1cm4gZDtcbiAgICB9XG4gICAgcmV0dXJuIGEubG9jYWxlQ29tcGFyZShiKTtcbn1cbnZhciBEaXN0YW5jZSA9IHJlcXVpcmUoXCIuLi91dGlscy9kYW1lcmF1TGV2ZW5zaHRlaW5cIik7XG52YXIgQWxnb2wgPSByZXF1aXJlKFwiLi4vbWF0Y2gvYWxnb2xcIik7XG4vLyBvZmZzZXRbMF0gOiBsZW4tMlxuLy8gICAgICAgICAgICAgbGVuIC0xXG4vLyAgICAgICAgICAgICBsZW5cbi8vICAgICAgICAgICAgIGxlbiArMVxuLy8gICAgICAgICAgICAgbGVuICsyXG4vLyAgICAgICAgICAgICBsZW4gKzNcbmZ1bmN0aW9uIGZpbmROZXh0TGVuKHRhcmdldExlbiwgYXJyLCBvZmZzZXRzKSB7XG4gICAgb2Zmc2V0cy5zaGlmdCgpO1xuICAgIGZvciAodmFyIGkgPSBvZmZzZXRzWzRdOyAoaSA8IGFyci5sZW5ndGgpICYmIChhcnJbaV0ubGVuZ3RoIDw9IHRhcmdldExlbik7ICsraSkge1xuICAgIH1cbiAgICAvL2NvbnNvbGUubG9nKFwicHVzaGluZyBcIiArIGkpO1xuICAgIG9mZnNldHMucHVzaChpKTtcbn1cbmV4cG9ydHMuZmluZE5leHRMZW4gPSBmaW5kTmV4dExlbjtcbmZ1bmN0aW9uIGFkZFJhbmdlUnVsZXNVbmxlc3NQcmVzZW50KHJ1bGVzLCBsY3dvcmQsIHJhbmdlUnVsZXMsIHByZXNlbnRSdWxlc0ZvcktleSwgc2VlblJ1bGVzKSB7XG4gICAgcmFuZ2VSdWxlcy5mb3JFYWNoKGZ1bmN0aW9uIChyYW5nZVJ1bGUpIHtcbiAgICAgICAgdmFyIG5ld1J1bGUgPSBPYmplY3QuYXNzaWduKHt9LCByYW5nZVJ1bGUpO1xuICAgICAgICBuZXdSdWxlLmxvd2VyY2FzZXdvcmQgPSBsY3dvcmQ7XG4gICAgICAgIG5ld1J1bGUud29yZCA9IGxjd29yZDtcbiAgICAgICAgLy9pZigobGN3b3JkID09PSAnc2VydmljZXMnIHx8IGxjd29yZCA9PT0gJ3NlcnZpY2UnKSAmJiBuZXdSdWxlLnJhbmdlLnJ1bGUubG93ZXJjYXNld29yZC5pbmRleE9mKCdvZGF0YScpPj0wKSB7XG4gICAgICAgIC8vICAgIGNvbnNvbGUubG9nKFwiYWRkaW5nIFwiKyBKU09OLnN0cmluZ2lmeShuZXdSdWxlKSArIFwiXFxuXCIpO1xuICAgICAgICAvL31cbiAgICAgICAgLy90b2RvOiBjaGVjayB3aGV0aGVyIGFuIGVxdWl2YWxlbnQgcnVsZSBpcyBhbHJlYWR5IHByZXNlbnQ/XG4gICAgICAgIHZhciBjbnQgPSBydWxlcy5sZW5ndGg7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQocnVsZXMsIG5ld1J1bGUsIHNlZW5SdWxlcyk7XG4gICAgfSk7XG59XG5leHBvcnRzLmFkZFJhbmdlUnVsZXNVbmxlc3NQcmVzZW50ID0gYWRkUmFuZ2VSdWxlc1VubGVzc1ByZXNlbnQ7XG5mdW5jdGlvbiBhZGRDbG9zZUV4YWN0UmFuZ2VSdWxlcyhydWxlcywgc2VlblJ1bGVzKSB7XG4gICAgdmFyIGtleXNNYXAgPSB7fTtcbiAgICB2YXIgcmFuZ2VLZXlzTWFwID0ge307XG4gICAgcnVsZXMuZm9yRWFjaChmdW5jdGlvbiAocnVsZSkge1xuICAgICAgICBpZiAocnVsZS50eXBlID09PSAwIC8qIFdPUkQgKi8pIHtcbiAgICAgICAgICAgIC8va2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdID0gMTtcbiAgICAgICAgICAgIGtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXSA9IGtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXSB8fCBbXTtcbiAgICAgICAgICAgIGtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXS5wdXNoKHJ1bGUpO1xuICAgICAgICAgICAgaWYgKCFydWxlLmV4YWN0T25seSAmJiBydWxlLnJhbmdlKSB7XG4gICAgICAgICAgICAgICAgcmFuZ2VLZXlzTWFwW3J1bGUubG93ZXJjYXNld29yZF0gPSByYW5nZUtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXSB8fCBbXTtcbiAgICAgICAgICAgICAgICByYW5nZUtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXS5wdXNoKHJ1bGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhrZXlzTWFwKTtcbiAgICBrZXlzLnNvcnQoY21wTGVuZ3RoU29ydCk7XG4gICAgdmFyIGxlbiA9IDA7XG4gICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uIChrZXksIGluZGV4KSB7XG4gICAgICAgIGlmIChrZXkubGVuZ3RoICE9IGxlbikge1xuICAgICAgICB9XG4gICAgICAgIGxlbiA9IGtleS5sZW5ndGg7XG4gICAgfSk7XG4gICAgLy8gICBrZXlzID0ga2V5cy5zbGljZSgwLDIwMDApO1xuICAgIHZhciByYW5nZUtleXMgPSBPYmplY3Qua2V5cyhyYW5nZUtleXNNYXApO1xuICAgIHJhbmdlS2V5cy5zb3J0KGNtcExlbmd0aFNvcnQpO1xuICAgIC8vY29uc29sZS5sb2coYCAke2tleXMubGVuZ3RofSBrZXlzIGFuZCAke3JhbmdlS2V5cy5sZW5ndGh9IHJhbmdla2V5cyBgKTtcbiAgICB2YXIgbG93ID0gMDtcbiAgICB2YXIgaGlnaCA9IDA7XG4gICAgdmFyIGxhc3RsZW4gPSAwO1xuICAgIHZhciBvZmZzZXRzID0gWzAsIDAsIDAsIDAsIDAsIDBdO1xuICAgIHZhciBsZW4gPSByYW5nZUtleXMubGVuZ3RoO1xuICAgIGZpbmROZXh0TGVuKDAsIGtleXMsIG9mZnNldHMpO1xuICAgIGZpbmROZXh0TGVuKDEsIGtleXMsIG9mZnNldHMpO1xuICAgIGZpbmROZXh0TGVuKDIsIGtleXMsIG9mZnNldHMpO1xuICAgIHJhbmdlS2V5cy5mb3JFYWNoKGZ1bmN0aW9uIChyYW5nZUtleSkge1xuICAgICAgICBpZiAocmFuZ2VLZXkubGVuZ3RoICE9PSBsYXN0bGVuKSB7XG4gICAgICAgICAgICBmb3IgKGkgPSBsYXN0bGVuICsgMTsgaSA8PSByYW5nZUtleS5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgIGZpbmROZXh0TGVuKGkgKyAyLCBrZXlzLCBvZmZzZXRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vICAgY29uc29sZS5sb2coYCBzaGlmdGVkIHRvICR7cmFuZ2VLZXkubGVuZ3RofSB3aXRoIG9mZnNldHMgYmVlaW5nICR7b2Zmc2V0cy5qb2luKCcgJyl9YCk7XG4gICAgICAgICAgICAvLyAgIGNvbnNvbGUubG9nKGAgaGVyZSAwICR7b2Zmc2V0c1swXX0gOiAke2tleXNbTWF0aC5taW4oa2V5cy5sZW5ndGgtMSwgb2Zmc2V0c1swXSldLmxlbmd0aH0gICR7a2V5c1tNYXRoLm1pbihrZXlzLmxlbmd0aC0xLCBvZmZzZXRzWzBdKV19IGApO1xuICAgICAgICAgICAgLy8gIGNvbnNvbGUubG9nKGAgaGVyZSA1LTEgICR7a2V5c1tvZmZzZXRzWzVdLTFdLmxlbmd0aH0gICR7a2V5c1tvZmZzZXRzWzVdLTFdfSBgKTtcbiAgICAgICAgICAgIC8vICAgY29uc29sZS5sb2coYCBoZXJlIDUgJHtvZmZzZXRzWzVdfSA6ICR7a2V5c1tNYXRoLm1pbihrZXlzLmxlbmd0aC0xLCBvZmZzZXRzWzVdKV0ubGVuZ3RofSAgJHtrZXlzW01hdGgubWluKGtleXMubGVuZ3RoLTEsIG9mZnNldHNbNV0pXX0gYCk7XG4gICAgICAgICAgICBsYXN0bGVuID0gcmFuZ2VLZXkubGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGkgPSBvZmZzZXRzWzBdOyBpIDwgb2Zmc2V0c1s1XTsgKytpKSB7XG4gICAgICAgICAgICB2YXIgZCA9IERpc3RhbmNlLmNhbGNEaXN0YW5jZUFkanVzdGVkKHJhbmdlS2V5LCBrZXlzW2ldKTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3JhbmdlS2V5Lmxlbmd0aC1rZXlzW2ldLmxlbmd0aH0gJHtkfSAke3JhbmdlS2V5fSBhbmQgJHtrZXlzW2ldfSAgYCk7XG4gICAgICAgICAgICBpZiAoKGQgIT09IDEuMCkgJiYgKGQgPj0gQWxnb2wuQ3V0b2ZmX3JhbmdlQ2xvc2VNYXRjaCkpIHtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGB3b3VsZCBhZGQgJHtyYW5nZUtleX0gZm9yICR7a2V5c1tpXX0gJHtkfWApO1xuICAgICAgICAgICAgICAgIHZhciBjbnQgPSBydWxlcy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgLy8gd2Ugb25seSBoYXZlIHRvIGFkZCBpZiB0aGVyZSBpcyBub3QgeWV0IGEgbWF0Y2ggcnVsZSBoZXJlIHdoaWNoIHBvaW50cyB0byB0aGUgc2FtZVxuICAgICAgICAgICAgICAgIGFkZFJhbmdlUnVsZXNVbmxlc3NQcmVzZW50KHJ1bGVzLCBrZXlzW2ldLCByYW5nZUtleXNNYXBbcmFuZ2VLZXldLCBrZXlzTWFwW2tleXNbaV1dLCBzZWVuUnVsZXMpO1xuICAgICAgICAgICAgICAgIGlmIChydWxlcy5sZW5ndGggPiBjbnQpIHtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICAvKlxuICAgIFtcbiAgICAgICAgWydhRUZHJywnYUVGR0gnXSxcbiAgICAgICAgWydhRUZHSCcsJ2FFRkdISSddLFxuICAgICAgICBbJ09kYXRhJywnT0RhdGFzJ10sXG4gICBbJ09kYXRhJywnT2RhdGFzJ10sXG4gICBbJ09kYXRhJywnT2RhdGInXSxcbiAgIFsnT2RhdGEnLCdVRGF0YSddLFxuICAgWydzZXJ2aWNlJywnc2VydmljZXMnXSxcbiAgIFsndGhpcyBpc2Z1bm55IGFuZCBtb3JlJywndGhpcyBpc2Z1bm55IGFuZCBtb3JlcyddLFxuICAgIF0uZm9yRWFjaChyZWMgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhgZGlzdGFuY2UgJHtyZWNbMF19ICR7cmVjWzFdfSA6ICR7RGlzdGFuY2UuY2FsY0Rpc3RhbmNlKHJlY1swXSxyZWNbMV0pfSAgYWRmICR7RGlzdGFuY2UuY2FsY0Rpc3RhbmNlQWRqdXN0ZWQocmVjWzBdLHJlY1sxXSl9IGApO1xuXG4gICAgfSk7XG4gICAgY29uc29sZS5sb2coXCJkaXN0YW5jZSBPZGF0YSBVZGF0YVwiKyBEaXN0YW5jZS5jYWxjRGlzdGFuY2UoJ09EYXRhJywnVURhdGEnKSk7XG4gICAgY29uc29sZS5sb2coXCJkaXN0YW5jZSBPZGF0YSBPZGF0YlwiKyBEaXN0YW5jZS5jYWxjRGlzdGFuY2UoJ09EYXRhJywnT0RhdGInKSk7XG4gICAgY29uc29sZS5sb2coXCJkaXN0YW5jZSBPZGF0YXMgT2RhdGFcIisgRGlzdGFuY2UuY2FsY0Rpc3RhbmNlKCdPRGF0YScsJ09EYXRhYScpKTtcbiAgICBjb25zb2xlLmxvZyhcImRpc3RhbmNlIE9kYXRhcyBhYmNkZVwiKyBEaXN0YW5jZS5jYWxjRGlzdGFuY2UoJ2FiY2RlJywnYWJjZGVmJykpO1xuICAgIGNvbnNvbGUubG9nKFwiZGlzdGFuY2Ugc2VydmljZXMgXCIrIERpc3RhbmNlLmNhbGNEaXN0YW5jZSgnc2VydmljZXMnLCdzZXJ2aWNlJykpO1xuICAgICovXG59XG5leHBvcnRzLmFkZENsb3NlRXhhY3RSYW5nZVJ1bGVzID0gYWRkQ2xvc2VFeGFjdFJhbmdlUnVsZXM7XG52YXIgbiA9IDA7XG5mdW5jdGlvbiBsb2FkTW9kZWxzKG1vZGVsUGF0aCwgYWRkU3BsaXRzKSB7XG4gICAgdmFyIG9Nb2RlbDtcbiAgICBvTW9kZWwgPSB7XG4gICAgICAgIGZ1bGw6IHsgZG9tYWluOiB7fSB9LFxuICAgICAgICByYXdNb2RlbHM6IHt9LFxuICAgICAgICBkb21haW5zOiBbXSxcbiAgICAgICAgdG9vbHM6IFtdLFxuICAgICAgICBydWxlczogdW5kZWZpbmVkLFxuICAgICAgICBjYXRlZ29yeTogW10sXG4gICAgICAgIG9wZXJhdG9yczoge30sXG4gICAgICAgIG1SdWxlczogW10sXG4gICAgICAgIHNlZW5SdWxlczoge30sXG4gICAgICAgIHJlY29yZHM6IFtdLFxuICAgICAgICBtZXRhOiB7IHQzOiB7fSB9XG4gICAgfTtcbiAgICBleHBvcnRzLmdsb2JhbF9BZGRTcGxpdHMgPSB0cnVlOyAvLyBhZGRTcGxpdHMgfHwgIXByb2Nlc3MuZW52LkFCT1RfT0xETUFUQ0g7XG4gICAgbW9kZWxQYXRoID0gbW9kZWxQYXRoIHx8IGVudk1vZGVsUGF0aDtcbiAgICB0cnkge1xuICAgICAgICB2YXIgYSA9IENpcmN1bGFyU2VyLmxvYWQoJy4vJyArIG1vZGVsUGF0aCArICcvX2NhY2hlJyArICEhYWRkU3BsaXRzICsgJy5qcycpO1xuICAgICAgICAvL2NvbnNvbGUubG9nKFwiZm91bmQgYSBjYWNoZSA/ICBcIiArICEhYSk7XG4gICAgICAgIC8vYSA9IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKGEpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIHJldHVybiBwcmVwYXJlc2UgbW9kZWwgXCIpO1xuICAgICAgICAgICAgcmV0dXJuIGE7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICB9XG4gICAgdmFyIHNtZGxzID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnL21vZGVscy5qc29uJywgJ3V0Zi04Jyk7XG4gICAgdmFyIG1kbHMgPSBKU09OLnBhcnNlKFwiXCIgKyBzbWRscyk7XG4gICAgbWRscy5mb3JFYWNoKGZ1bmN0aW9uIChzTW9kZWxOYW1lKSB7XG4gICAgICAgIGxvYWRNb2RlbChtb2RlbFBhdGgsIHNNb2RlbE5hbWUsIG9Nb2RlbCk7XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcbiAgICAvKlxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcImNhdGVnb3J5XCIsXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcbiAgICAgICAgICAgIHdvcmQ6IGNhdGVnb3J5LFxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIGJpdGluZGV4IDogb01kbC5cbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH0pO1xuICAgICovXG4gICAgdmFyIG1ldGFCaXRJbmRleCA9IGdldERvbWFpbkJpdEluZGV4KCdtZXRhJywgb01vZGVsKTtcbiAgICAvLyBhZGQgdGhlIGRvbWFpbiBtZXRhIHJ1bGVcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgY2F0ZWdvcnk6IFwibWV0YVwiLFxuICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImRvbWFpblwiLFxuICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgIHdvcmQ6IFwiZG9tYWluXCIsXG4gICAgICAgIGJpdGluZGV4OiBtZXRhQml0SW5kZXgsXG4gICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgdmFyIGZpbGxlckJpdEluZGV4ID0gZ2V0RG9tYWluQml0SW5kZXgoJ21ldGEnLCBvTW9kZWwpO1xuICAgIC8vYWRkIGEgZmlsbGVyIHJ1bGVcbiAgICB2YXIgc2ZpbGxlcnMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvZmlsbGVyLmpzb24nLCAndXRmLTgnKTtcbiAgICB2YXIgZmlsbGVycyA9IEpTT04ucGFyc2Uoc2ZpbGxlcnMpO1xuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xuICAgIG9Nb2RlbC5tUnVsZXMucHVzaCh7XG4gICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxuICAgICAgICB0eXBlOiAxIC8qIFJFR0VYUCAqLyxcbiAgICAgICAgcmVnZXhwOiBuZXcgUmVnRXhwKHJlLCBcImlcIiksXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXG4gICAgICAgIGJpdGluZGV4OiBmaWxsZXJCaXRJbmRleCxcbiAgICAgICAgX3Jhbmtpbmc6IDAuOVxuICAgIH0pO1xuICAgIC8vYWRkIG9wZXJhdG9yc1xuICAgIHZhciBzT3BlcmF0b3JzID0gZnMucmVhZEZpbGVTeW5jKCcuL3Jlc291cmNlcy9tb2RlbC9vcGVyYXRvcnMuanNvbicsICd1dGYtOCcpO1xuICAgIHZhciBvcGVyYXRvcnMgPSBKU09OLnBhcnNlKHNPcGVyYXRvcnMpO1xuICAgIHZhciBvcGVyYXRvckJpdEluZGV4ID0gZ2V0RG9tYWluQml0SW5kZXgoJ29wZXJhdG9ycycsIG9Nb2RlbCk7XG4gICAgT2JqZWN0LmtleXMob3BlcmF0b3JzLm9wZXJhdG9ycykuZm9yRWFjaChmdW5jdGlvbiAob3BlcmF0b3IpIHtcbiAgICAgICAgaWYgKElNYXRjaC5hT3BlcmF0b3JOYW1lcy5pbmRleE9mKG9wZXJhdG9yKSA8IDApIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwidW5rbm93biBvcGVyYXRvciBcIiArIG9wZXJhdG9yKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInVua25vd24gb3BlcmF0b3IgXCIgKyBvcGVyYXRvcik7XG4gICAgICAgIH1cbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0gPSBvcGVyYXRvcnMub3BlcmF0b3JzW29wZXJhdG9yXTtcbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0ub3BlcmF0b3IgPSBvcGVyYXRvcjtcbiAgICAgICAgT2JqZWN0LmZyZWV6ZShvTW9kZWwub3BlcmF0b3JzW29wZXJhdG9yXSk7XG4gICAgICAgIHZhciB3b3JkID0gb3BlcmF0b3I7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFwib3BlcmF0b3JcIixcbiAgICAgICAgICAgIHdvcmQ6IHdvcmQudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IHdvcmQudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHdvcmQsXG4gICAgICAgICAgICBiaXRpbmRleDogb3BlcmF0b3JCaXRJbmRleCxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgIC8vIGFkZCBhbGwgc3lub255bXNcbiAgICAgICAgaWYgKG9wZXJhdG9ycy5zeW5vbnltc1tvcGVyYXRvcl0pIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKG9wZXJhdG9ycy5zeW5vbnltc1tvcGVyYXRvcl0pLmZvckVhY2goZnVuY3Rpb24gKHN5bm9ueW0pIHtcbiAgICAgICAgICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IFwib3BlcmF0b3JcIixcbiAgICAgICAgICAgICAgICAgICAgd29yZDogc3lub255bS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgICAgICAgICBsb3dlcmNhc2V3b3JkOiBzeW5vbnltLnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogb3BlcmF0b3IsXG4gICAgICAgICAgICAgICAgICAgIGJpdGluZGV4OiBvcGVyYXRvckJpdEluZGV4LFxuICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogMC45XG4gICAgICAgICAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8qXG4gICAgICAgIH0pXG4gICAgICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXG4gICAgICAgICAgdHlwZTogMSxcbiAgICAgICAgICByZWdleHA6IC9eKChzdGFydCl8KHNob3cpfChmcm9tKXwoaW4pKSQvaSxcbiAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxuICAgICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICAgICAgfSxcbiAgICAqL1xuICAgIG9Nb2RlbC5tUnVsZXMgPSBvTW9kZWwubVJ1bGVzLnNvcnQoSW5wdXRGaWx0ZXJSdWxlcy5jbXBNUnVsZSk7XG4gICAgYWRkQ2xvc2VFeGFjdFJhbmdlUnVsZXMob01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgb01vZGVsLm1SdWxlcyA9IG9Nb2RlbC5tUnVsZXMuc29ydChJbnB1dEZpbHRlclJ1bGVzLmNtcE1SdWxlKTtcbiAgICBvTW9kZWwucnVsZXMgPSBzcGxpdFJ1bGVzKG9Nb2RlbC5tUnVsZXMpO1xuICAgIG9Nb2RlbC50b29scyA9IG9Nb2RlbC50b29scy5zb3J0KFRvb2xzLmNtcFRvb2xzKTtcbiAgICBkZWxldGUgb01vZGVsLnNlZW5SdWxlcztcbiAgICBkZWJ1Z2xvZygnc2F2aW5nJyk7XG4gICAgQ2lyY3VsYXJTZXIuc2F2ZSgnLi8nICsgbW9kZWxQYXRoICsgJy9fY2FjaGUnICsgISFhZGRTcGxpdHMgKyAnLmpzJywgb01vZGVsKTtcbiAgICByZXR1cm4gb01vZGVsO1xufVxuZXhwb3J0cy5sb2FkTW9kZWxzID0gbG9hZE1vZGVscztcbmZ1bmN0aW9uIHNvcnRDYXRlZ29yaWVzQnlJbXBvcnRhbmNlKG1hcCwgY2F0cykge1xuICAgIHZhciByZXMgPSBjYXRzLnNsaWNlKDApO1xuICAgIHJlcy5zb3J0KHJhbmtDYXRlZ29yeUJ5SW1wb3J0YW5jZS5iaW5kKHVuZGVmaW5lZCwgbWFwKSk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuc29ydENhdGVnb3JpZXNCeUltcG9ydGFuY2UgPSBzb3J0Q2F0ZWdvcmllc0J5SW1wb3J0YW5jZTtcbmZ1bmN0aW9uIHJhbmtDYXRlZ29yeUJ5SW1wb3J0YW5jZShtYXAsIGNhdGEsIGNhdGIpIHtcbiAgICB2YXIgY2F0QURlc2MgPSBtYXBbY2F0YV07XG4gICAgdmFyIGNhdEJEZXNjID0gbWFwW2NhdGJdO1xuICAgIGlmIChjYXRhID09PSBjYXRiKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICAvLyBpZiBhIGlzIGJlZm9yZSBiLCByZXR1cm4gLTFcbiAgICBpZiAoY2F0QURlc2MgJiYgIWNhdEJEZXNjKSB7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICB9XG4gICAgaWYgKCFjYXRBRGVzYyAmJiBjYXRCRGVzYykge1xuICAgICAgICByZXR1cm4gKzE7XG4gICAgfVxuICAgIHZhciBwcmlvQSA9IChjYXRBRGVzYyAmJiBjYXRBRGVzYy5pbXBvcnRhbmNlKSB8fCA5OTtcbiAgICB2YXIgcHJpb0IgPSAoY2F0QkRlc2MgJiYgY2F0QkRlc2MuaW1wb3J0YW5jZSkgfHwgOTk7XG4gICAgLy8gbG93ZXIgcHJpbyBnb2VzIHRvIGZyb250XG4gICAgdmFyIHIgPSBwcmlvQSAtIHByaW9CO1xuICAgIGlmIChyKSB7XG4gICAgICAgIHJldHVybiByO1xuICAgIH1cbiAgICByZXR1cm4gY2F0YS5sb2NhbGVDb21wYXJlKGNhdGIpO1xufVxuZXhwb3J0cy5yYW5rQ2F0ZWdvcnlCeUltcG9ydGFuY2UgPSByYW5rQ2F0ZWdvcnlCeUltcG9ydGFuY2U7XG52YXIgTWV0YUYgPSBNZXRhLmdldE1ldGFGYWN0b3J5KCk7XG5mdW5jdGlvbiBnZXRPcGVyYXRvcihtZGwsIG9wZXJhdG9yKSB7XG4gICAgcmV0dXJuIG1kbC5vcGVyYXRvcnNbb3BlcmF0b3JdO1xufVxuZXhwb3J0cy5nZXRPcGVyYXRvciA9IGdldE9wZXJhdG9yO1xuZnVuY3Rpb24gZ2V0UmVzdWx0QXNBcnJheShtZGwsIGEsIHJlbCkge1xuICAgIGlmIChyZWwudG9UeXBlKCkgIT09ICdyZWxhdGlvbicpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZXhwZWN0IHJlbGF0aW9uIGFzIDJuZCBhcmdcIik7XG4gICAgfVxuICAgIHZhciByZXMgPSBtZGwubWV0YS50M1thLnRvRnVsbFN0cmluZygpXSAmJlxuICAgICAgICBtZGwubWV0YS50M1thLnRvRnVsbFN0cmluZygpXVtyZWwudG9GdWxsU3RyaW5nKCldO1xuICAgIGlmICghcmVzKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHJlcykuc29ydCgpLm1hcChNZXRhRi5wYXJzZUlNZXRhKTtcbn1cbmV4cG9ydHMuZ2V0UmVzdWx0QXNBcnJheSA9IGdldFJlc3VsdEFzQXJyYXk7XG5mdW5jdGlvbiBnZXRDYXRlZ29yaWVzRm9yRG9tYWluKHRoZU1vZGVsLCBkb21haW4pIHtcbiAgICBpZiAodGhlTW9kZWwuZG9tYWlucy5pbmRleE9mKGRvbWFpbikgPCAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRvbWFpbiBcXFwiXCIgKyBkb21haW4gKyBcIlxcXCIgbm90IHBhcnQgb2YgbW9kZWxcIik7XG4gICAgfVxuICAgIHZhciByZXMgPSBnZXRSZXN1bHRBc0FycmF5KHRoZU1vZGVsLCBNZXRhRi5Eb21haW4oZG9tYWluKSwgTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9oYXNDYXRlZ29yeSkpO1xuICAgIHJldHVybiBNZXRhLmdldFN0cmluZ0FycmF5KHJlcyk7XG59XG5leHBvcnRzLmdldENhdGVnb3JpZXNGb3JEb21haW4gPSBnZXRDYXRlZ29yaWVzRm9yRG9tYWluO1xuZnVuY3Rpb24gZ2V0VGFibGVDb2x1bW5zKHRoZU1vZGVsLCBkb21haW4pIHtcbiAgICBpZiAodGhlTW9kZWwuZG9tYWlucy5pbmRleE9mKGRvbWFpbikgPCAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRvbWFpbiBcXFwiXCIgKyBkb21haW4gKyBcIlxcXCIgbm90IHBhcnQgb2YgbW9kZWxcIik7XG4gICAgfVxuICAgIHJldHVybiB0aGVNb2RlbC5yYXdNb2RlbHNbZG9tYWluXS5jb2x1bW5zLnNsaWNlKDApO1xufVxuZXhwb3J0cy5nZXRUYWJsZUNvbHVtbnMgPSBnZXRUYWJsZUNvbHVtbnM7XG4vKipcbiAqIFJldHVybiBhbGwgY2F0ZWdvcmllcyBvZiBhIGRvbWFpbiB3aGljaCBjYW4gYXBwZWFyIG9uIGEgd29yZCxcbiAqIHRoZXNlIGFyZSB0eXBpY2FsbHkgdGhlIHdvcmRpbmRleCBkb21haW5zICsgZW50cmllcyBnZW5lcmF0ZWQgYnkgZ2VuZXJpYyBydWxlc1xuICpcbiAqIFRoZSBjdXJyZW50IGltcGxlbWVudGF0aW9uIGlzIGEgc2ltcGxpZmljYXRpb25cbiAqL1xuZnVuY3Rpb24gZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4odGhlTW9kZWwsIGRvbWFpbikge1xuICAgIC8vIHRoaXMgaXMgYSBzaW1wbGlmaWVkIHZlcnNpb25cbiAgICByZXR1cm4gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbih0aGVNb2RlbCwgZG9tYWluKTtcbn1cbmV4cG9ydHMuZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4gPSBnZXRQb3RlbnRpYWxXb3JkQ2F0ZWdvcmllc0ZvckRvbWFpbjtcbmZ1bmN0aW9uIGdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbCwgY2F0ZWdvcnkpIHtcbiAgICBpZiAodGhlTW9kZWwuY2F0ZWdvcnkuaW5kZXhPZihjYXRlZ29yeSkgPCAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhdGVnb3J5IFxcXCJcIiArIGNhdGVnb3J5ICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xuICAgIH1cbiAgICB2YXIgcmVzID0gZ2V0UmVzdWx0QXNBcnJheSh0aGVNb2RlbCwgTWV0YUYuQ2F0ZWdvcnkoY2F0ZWdvcnkpLCBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikpO1xuICAgIHJldHVybiBNZXRhLmdldFN0cmluZ0FycmF5KHJlcyk7XG59XG5leHBvcnRzLmdldERvbWFpbnNGb3JDYXRlZ29yeSA9IGdldERvbWFpbnNGb3JDYXRlZ29yeTtcbmZ1bmN0aW9uIGdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yeShtb2RlbCwgY2F0ZWdvcnksIHdvcmRzb25seSkge1xuICAgIHZhciByZXMgPSB7fTtcbiAgICAvL1xuICAgIHZhciBmbiA9IHdvcmRzb25seSA/IGdldFBvdGVudGlhbFdvcmRDYXRlZ29yaWVzRm9yRG9tYWluIDogZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbjtcbiAgICB2YXIgZG9tYWlucyA9IGdldERvbWFpbnNGb3JDYXRlZ29yeShtb2RlbCwgY2F0ZWdvcnkpO1xuICAgIGRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoZG9tYWluKSB7XG4gICAgICAgIGZuKG1vZGVsLCBkb21haW4pLmZvckVhY2goZnVuY3Rpb24gKHdvcmRjYXQpIHtcbiAgICAgICAgICAgIHJlc1t3b3JkY2F0XSA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIE9iamVjdC5mcmVlemUocmVzKTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5nZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcnkgPSBnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcnk7XG5mdW5jdGlvbiBnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcmllcyhtb2RlbCwgY2F0ZWdvcmllcywgd29yZHNvbmx5KSB7XG4gICAgdmFyIHJlcyA9IHt9O1xuICAgIC8vXG4gICAgdmFyIGZuID0gd29yZHNvbmx5ID8gZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4gOiBnZXRDYXRlZ29yaWVzRm9yRG9tYWluO1xuICAgIHZhciBkb21haW5zID0gdW5kZWZpbmVkO1xuICAgIGNhdGVnb3JpZXMuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIGNhdGRvbWFpbnMgPSBnZXREb21haW5zRm9yQ2F0ZWdvcnkobW9kZWwsIGNhdGVnb3J5KTtcbiAgICAgICAgaWYgKCFkb21haW5zKSB7XG4gICAgICAgICAgICBkb21haW5zID0gY2F0ZG9tYWlucztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGRvbWFpbnMgPSBfLmludGVyc2VjdGlvbihkb21haW5zLCBjYXRkb21haW5zKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChkb21haW5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhdGVnb3JpZXMgJyArIFV0aWxzLmxpc3RUb1F1b3RlZENvbW1hQW5kKGNhdGVnb3JpZXMpICsgJyBoYXZlIG5vIGNvbW1vbiBkb21haW4uJyk7XG4gICAgfVxuICAgIGRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoZG9tYWluKSB7XG4gICAgICAgIGZuKG1vZGVsLCBkb21haW4pLmZvckVhY2goZnVuY3Rpb24gKHdvcmRjYXQpIHtcbiAgICAgICAgICAgIHJlc1t3b3JkY2F0XSA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIE9iamVjdC5mcmVlemUocmVzKTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5nZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcmllcyA9IGdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yaWVzO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
