/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require('debug');
var debuglog = debug('model');
var IMatch = require('../match/ifmatch');
var InputFilterRules = require('../match/inputFilterRules');
var Tools = require('../match/tools');
var fs = require('fs');
var process = require('process');
var modelPath = process.env["MODELPATH"] || "testmodel";
;
function addSynonyms(synonyms, category, synonymFor, mRules, seen) {
    synonyms.forEach(function (syn) {
        var oRule = {
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            _ranking: 0.95
        };
        debuglog("inserting synonym" + JSON.stringify(oRule));
        insertRuleIfNotPresent(mRules, oRule, seen);
    });
}
function insertRuleIfNotPresent(mRules, rule, seenRules) {
    if (rule.type !== 0 /* WORD */) {
            mRules.push(rule);
            return;
        }
    if (rule.word === undefined || rule.matchedString === undefined) {
        throw new Error('illegal rule' + JSON.stringify(rule, undefined, 2));
    }
    var seenRules = seenRules || {};
    var r = JSON.stringify(rule);
    if (seenRules[r]) {
        debuglog("Attempting to insert duplicate" + JSON.stringify(rule, undefined, 2));
        var duplicates = mRules.filter(function (oEntry) {
            return !InputFilterRules.cmpMRule(oEntry, rule);
        });
        if (duplicates.length > 0) {
            return;
        }
    }
    seenRules[r] = rule;
    mRules.push(rule);
    return;
}
function loadModelData(oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var sFileName = './' + modelPath + '/' + sModelName + ".data.json";
    var mdldata = fs.readFileSync(sFileName, 'utf-8');
    var oMdlData = JSON.parse(mdldata);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.tool) {
            oEntry.tool = oMdl.tool.name;
        }
        oModel.records.push(oEntry);
        oMdl.wordindex.forEach(function (category) {
            if (oEntry[category] === undefined) {
                debuglog("INCONSISTENT*> ModelData " + sFileName + " does not contain category " + category + " of wordindex" + JSON.stringify(oEntry) + "");
                return;
            }
            if (oEntry[category] !== "*") {
                var sString = oEntry[category];
                debuglog("pushing rule with " + category + " -> " + sString);
                insertRuleIfNotPresent(oModel.mRules, {
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    _ranking: 0.95
                }, oModel.seenRules);
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, oModel.mRules, oModel.seenRules);
                }
            }
        });
    });
}
function loadModel(sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var mdl = fs.readFileSync('./' + modelPath + '/' + sModelName + ".model.json", 'utf-8');
    var oMdl = JSON.parse(mdl);
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // extract tools an add to tools:
    oModel.tools.filter(function (oEntry) {
        if (oEntry.name === oMdl.tool.name) {
            console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
            //throw new Error('Domain already loaded?');
            process.exit(-1);
        }
    });
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden) {
        oModel.mRules.push({
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            _ranking: 0.95
        });
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oModel.mRules, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oModel.mRules, oModel.seenRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    oModel.tools.push(oMdl.tool);
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
    loadModelData(oMdl, sModelName, oModel);
} // loadmodel
function loadModels() {
    var oModel;
    oModel = {
        domains: [],
        tools: [],
        category: [],
        mRules: [],
        records: []
    };
    var smdls = fs.readFileSync('./' + modelPath + '/models.json', 'utf-8');
    var mdls = JSON.parse("" + smdls);
    mdls.forEach(function (sModelName) {
        loadModel(sModelName, oModel);
    });
    // add the categories to the model:
    oModel.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            _ranking: 0.95
        }, oModel.seenRules);
    });
    //add a filler rule
    var sfillers = fs.readFileSync('./' + modelPath + '/filler.json', 'utf-8');
    var fillers = JSON.parse(sfillers);
    var re = "^((" + fillers.join(")|(") + "))$";
    oModel.mRules.push({
        category: "filler",
        type: 1 /* REGEXP */
        , regexp: new RegExp(re, "i"),
        matchedString: "filler",
        _ranking: 0.9
    });
    /*
        })
            {
          category: "filler",
          type: 1,
          regexp: /^((start)|(show)|(from)|(in))$/i,
          matchedString: "filler",
          _ranking: 0.9
        },
    */
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    oModel.tools = oModel.tools.sort(Tools.cmpTools);
    delete oModel.seenRules;
    return oModel;
}
exports.loadModels = loadModels;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwiSU1hdGNoIiwiSW5wdXRGaWx0ZXJSdWxlcyIsIlRvb2xzIiwiZnMiLCJwcm9jZXNzIiwibW9kZWxQYXRoIiwiZW52IiwiYWRkU3lub255bXMiLCJzeW5vbnltcyIsImNhdGVnb3J5Iiwic3lub255bUZvciIsIm1SdWxlcyIsInNlZW4iLCJmb3JFYWNoIiwic3luIiwib1J1bGUiLCJtYXRjaGVkU3RyaW5nIiwidHlwZSIsIndvcmQiLCJfcmFua2luZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJpbnNlcnRSdWxlSWZOb3RQcmVzZW50IiwicnVsZSIsInNlZW5SdWxlcyIsInB1c2giLCJ1bmRlZmluZWQiLCJFcnJvciIsInIiLCJkdXBsaWNhdGVzIiwiZmlsdGVyIiwib0VudHJ5IiwiY21wTVJ1bGUiLCJsZW5ndGgiLCJsb2FkTW9kZWxEYXRhIiwib01kbCIsInNNb2RlbE5hbWUiLCJvTW9kZWwiLCJzRmlsZU5hbWUiLCJtZGxkYXRhIiwicmVhZEZpbGVTeW5jIiwib01kbERhdGEiLCJwYXJzZSIsInRvb2wiLCJuYW1lIiwicmVjb3JkcyIsIndvcmRpbmRleCIsInNTdHJpbmciLCJsb2FkTW9kZWwiLCJtZGwiLCJkb21haW5zIiwiaW5kZXhPZiIsImRvbWFpbiIsInRvb2xzIiwiY29uc29sZSIsImxvZyIsImV4aXQiLCJ0b29saGlkZGVuIiwiT2JqZWN0Iiwia2V5cyIsInNzeW5rZXkiLCJjb25jYXQiLCJzb3J0Iiwic3RyaW5nIiwiaW5kZXgiLCJsb2FkTW9kZWxzIiwic21kbHMiLCJtZGxzIiwic2ZpbGxlcnMiLCJmaWxsZXJzIiwicmUiLCJqb2luIiwicmVnZXhwIiwiUmVnRXhwIiwiY21wVG9vbHMiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUNLQTs7QURHQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4s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a0JBQVU7QUFMTyxLQUFuQjtBQU9KOzs7Ozs7Ozs7O0FBVUlrQixXQUFPMUIsTUFBUCxHQUFnQjBCLE9BQU8xQixNQUFQLENBQWNtRCxJQUFkLENBQW1CN0QsaUJBQWlCK0IsUUFBcEMsQ0FBaEI7QUFDQUssV0FBT2dCLEtBQVAsR0FBZWhCLE9BQU9nQixLQUFQLENBQWFTLElBQWIsQ0FBa0I1RCxNQUFNd0UsUUFBeEIsQ0FBZjtBQUNBLFdBQU9yQyxPQUFPYixTQUFkO0FBQ0EsV0FBT2EsTUFBUDtBQUNIO0FBbkRlc0MsUUFBQVYsVUFBQSxHQUFVQSxVQUFWIiwiZmlsZSI6Im1vZGVsL21vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEZ1bmN0aW9uYWxpdHkgbWFuYWdpbmcgdGhlIG1hdGNoIG1vZGVsc1xyXG4gKlxyXG4gKiBAZmlsZVxyXG4gKi9cclxuXHJcbmltcG9ydCAqIGFzIGludGYgZnJvbSAnY29uc3RhbnRzJztcclxuXHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcclxuXHJcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdtb2RlbCcpO1xyXG5cclxuaW1wb3J0ICogIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuXHJcbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4uL21hdGNoL21hdGNoJztcclxuXHJcbmltcG9ydCAqIGFzIElucHV0RmlsdGVyUnVsZXMgZnJvbSAnLi4vbWF0Y2gvaW5wdXRGaWx0ZXJSdWxlcyc7XHJcblxyXG5pbXBvcnQgKiBhcyBUb29scyBmcm9tICcuLi9tYXRjaC90b29scyc7XHJcblxyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XHJcblxyXG5pbXBvcnQgKiBhcyBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xyXG5cclxudmFyIG1vZGVsUGF0aCA9IHByb2Nlc3MuZW52W1wiTU9ERUxQQVRIXCJdIHx8IFwidGVzdG1vZGVsXCI7XHJcblxyXG5cclxuaW50ZXJmYWNlIElNb2RlbHMge1xyXG4gICAgZG9tYWluczogc3RyaW5nW10sXHJcbiAgICB0b29sczogSU1hdGNoLklUb29sW10sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW10sXHJcbiAgICBtUnVsZXM6IElNYXRjaC5tUnVsZVtdLFxyXG4gICAgcmVjb3JkcyA6IGFueVtdXHJcbiAgICBzZWVuUnVsZXM/IDoge1trZXkgOiBzdHJpbmddIDogSU1hdGNoLm1SdWxlIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIElNb2RlbCB7XHJcbiAgICBkb21haW46IHN0cmluZyxcclxuICAgIHRvb2w6IElNYXRjaC5JVG9vbCxcclxuICAgIHRvb2xoaWRkZW4/OiBib29sZWFuLFxyXG4gICAgc3lub255bXM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZ1tdIH0sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW10sXHJcbiAgICB3b3JkaW5kZXg6IHN0cmluZ1tdLFxyXG4gICAgaGlkZGVuOiBzdHJpbmdbXVxyXG59O1xyXG5cclxuZnVuY3Rpb24gYWRkU3lub255bXMoc3lub255bXM6IHN0cmluZ1tdLCBjYXRlZ29yeTogc3RyaW5nLCBzeW5vbnltRm9yOiBzdHJpbmcsIG1SdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgc2VlbiA6IHsgW2tleTpzdHJpbmddIDogSU1hdGNoLm1SdWxlfSkge1xyXG4gICAgc3lub255bXMuZm9yRWFjaChmdW5jdGlvbihzeW4pIHtcclxuICAgICAgICB2YXIgb1J1bGUgPSAge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHN5bm9ueW1Gb3IsXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogc3luLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgZGVidWdsb2coXCJpbnNlcnRpbmcgc3lub255bVwiICsgSlNPTi5zdHJpbmdpZnkob1J1bGUpKTtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcyxvUnVsZSwgc2Vlbik7XHJcbiAgICAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMgOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCBydWxlOiBJTWF0Y2gubVJ1bGUsXHJcbnNlZW5SdWxlcyA6IHsgW2tleSA6IHN0cmluZ10gOiBJTWF0Y2gubVJ1bGV9ICApIHtcclxuICAgIGlmIChydWxlLnR5cGUgIT09IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCkge1xyXG4gICAgICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmKChydWxlLndvcmQgPT09IHVuZGVmaW5lZCkgfHwgKHJ1bGUubWF0Y2hlZFN0cmluZyA9PT0gdW5kZWZpbmVkKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsdW5kZWZpbmVkLDIpKTtcclxuICAgIH1cclxuICAgIHZhciBzZWVuUnVsZXMgPSBzZWVuUnVsZXMgfHwge307XHJcbiAgICB2YXIgciA9IEpTT04uc3RyaW5naWZ5KHJ1bGUpO1xyXG4gICAgaWYoc2VlblJ1bGVzW3JdKSB7XHJcbiAgICAgICAgZGVidWdsb2coXCJBdHRlbXB0aW5nIHRvIGluc2VydCBkdXBsaWNhdGVcIiArIEpTT04uc3RyaW5naWZ5KHJ1bGUsdW5kZWZpbmVkLDIpKTtcclxuICAgICAgICB2YXIgZHVwbGljYXRlcyA9IG1SdWxlcy5maWx0ZXIoZnVuY3Rpb24ob0VudHJ5KSB7XHJcbiAgICAgICAgcmV0dXJuICFJbnB1dEZpbHRlclJ1bGVzLmNtcE1SdWxlKG9FbnRyeSxydWxlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZihkdXBsaWNhdGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHNlZW5SdWxlc1tyXSA9IHJ1bGU7XHJcbiAgICBtUnVsZXMucHVzaChydWxlKTtcclxuICAgIHJldHVybjtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZE1vZGVsRGF0YShvTWRsOiBJTW9kZWwsIHNNb2RlbE5hbWU6IHN0cmluZywgb01vZGVsOiBJTW9kZWxzKSB7XHJcbiAgICAvLyByZWFkIHRoZSBkYXRhIC0+XHJcbiAgICAvLyBkYXRhIGlzIHByb2Nlc3NlZCBpbnRvIG1SdWxlcyBkaXJlY3RseSxcclxuICAgIGNvbnN0IHNGaWxlTmFtZSA9ICgnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLmRhdGEuanNvblwiKTtcclxuICAgIHZhciBtZGxkYXRhID0gZnMucmVhZEZpbGVTeW5jKHNGaWxlTmFtZSwgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgb01kbERhdGEgPSBKU09OLnBhcnNlKG1kbGRhdGEpO1xyXG4gICAgb01kbERhdGEuZm9yRWFjaChmdW5jdGlvbihvRW50cnkpIHtcclxuXHJcbiAgICAgICAgaWYgKCFvRW50cnkudG9vbCkge1xyXG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgb01vZGVsLnJlY29yZHMucHVzaChvRW50cnkpO1xyXG5cclxuICAgICAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiKyBjYXRlZ29yeStcIiBvZiB3b3JkaW5kZXhcIiArIEpTT04uc3RyaW5naWZ5KG9FbnRyeSkgKyBcIlwiKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNTdHJpbmcgPSBvRW50cnlbY2F0ZWdvcnldO1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJwdXNoaW5nIHJ1bGUgd2l0aCBcIisgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xyXG4gICAgICAgICAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmQ6IHNTdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgICAgICBpZiAob01kbERhdGEuc3lub255bXMgJiYgb01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkTW9kZWwoc01vZGVsTmFtZTogc3RyaW5nLCBvTW9kZWw6IElNb2RlbHMpIHtcclxuICAgIGRlYnVnbG9nKFwiIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lICsgXCIgLi4uLlwiKTtcclxuICAgIHZhciBtZGwgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5tb2RlbC5qc29uXCIsICd1dGYtOCcpO1xyXG4gICAgdmFyIG9NZGwgPSBKU09OLnBhcnNlKG1kbCkgYXMgSU1vZGVsO1xyXG5cclxuICAgIGlmIChvTW9kZWwuZG9tYWlucy5pbmRleE9mKG9NZGwuZG9tYWluKT49IDApIHtcclxuICAgICAgICBkZWJ1Z2xvZyhcIioqKioqKioqKioqaGVyZSBtZGxcIiArIEpTT04uc3RyaW5naWZ5KG9NZGwsdW5kZWZpbmVkLCAyKSk7XHJcblxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgYWxyZWFkeSBsb2FkZWQgd2hpbGUgbG9hZGluZyAnICsgc01vZGVsTmFtZSArICc/Jyk7XHJcbiAgICB9XHJcbiAgICAvLyBleHRyYWN0IHRvb2xzIGFuIGFkZCB0byB0b29sczpcclxuICAgIG9Nb2RlbC50b29scy5maWx0ZXIoZnVuY3Rpb24ob0VudHJ5KSB7XHJcbiAgICAgICAgaWYgKG9FbnRyeS5uYW1lID09PSBvTWRsLnRvb2wubmFtZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRvb2wgXCIgKyBvTWRsLnRvb2wubmFtZSArIFwiIGFscmVhZHkgcHJlc2VudCB3aGVuIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lKTtcclxuICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiBhbHJlYWR5IGxvYWRlZD8nKTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8vIGFkZCB0aGUgdG9vbCBuYW1lIGFzIHJ1bGUgdW5sZXNzIGhpZGRlblxyXG4gICAgaWYgKCFvTWRsLnRvb2xoaWRkZW4pIHtcclxuICAgICAgICBvTW9kZWwubVJ1bGVzLnB1c2goe1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJ0b29sXCIsXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwudG9vbC5uYW1lLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIHdvcmQ6IG9NZGwudG9vbC5uYW1lLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIGlmIChvTWRsLnN5bm9ueW1zICYmIG9NZGwuc3lub255bXNbXCJ0b29sXCJdKSB7XHJcbiAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tcInRvb2xcIl0sIFwidG9vbFwiLCBvTWRsLnRvb2wubmFtZSwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICB9O1xyXG4gICAgaWYgKG9NZGwuc3lub255bXMpIHtcclxuICAgICAgICBPYmplY3Qua2V5cyhvTWRsLnN5bm9ueW1zKS5mb3JFYWNoKGZ1bmN0aW9uKHNzeW5rZXkpIHtcclxuICAgICAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzc3lua2V5KSA+PSAwICYmIHNzeW5rZXkgIT09IFwidG9vbFwiKSB7XHJcbiAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW3NzeW5rZXldLCBcImNhdGVnb3J5XCIsIHNzeW5rZXksIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBvTW9kZWwuZG9tYWlucy5wdXNoKG9NZGwuZG9tYWluKTtcclxuICAgIG9Nb2RlbC50b29scy5wdXNoKG9NZGwudG9vbCk7XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuY29uY2F0KG9NZGwuY2F0ZWdvcnkpO1xyXG4gICAgb01vZGVsLmNhdGVnb3J5LnNvcnQoKTtcclxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5maWx0ZXIoZnVuY3Rpb24oc3RyaW5nLCBpbmRleCkge1xyXG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcclxuICAgIH0pO1xyXG4gICAgbG9hZE1vZGVsRGF0YShvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpO1xyXG59IC8vIGxvYWRtb2RlbFxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkTW9kZWxzKCkge1xyXG4gICAgdmFyIG9Nb2RlbDogSU1vZGVscztcclxuICAgIG9Nb2RlbCA9IHtcclxuICAgICAgICBkb21haW5zOiBbXSxcclxuICAgICAgICB0b29sczogW10sXHJcbiAgICAgICAgY2F0ZWdvcnk6IFtdLFxyXG4gICAgICAgIG1SdWxlczogW10sXHJcbiAgICAgICAgcmVjb3JkcyA6IFtdXHJcbiAgICB9XHJcbiAgICB2YXIgc21kbHMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvbW9kZWxzLmpzb24nLCAndXRmLTgnKTtcclxuICAgIHZhciBtZGxzID0gSlNPTi5wYXJzZShcIlwiICsgc21kbHMpO1xyXG4gICAgbWRscy5mb3JFYWNoKGZ1bmN0aW9uKHNNb2RlbE5hbWUpIHtcclxuICAgICAgICBsb2FkTW9kZWwoc01vZGVsTmFtZSwgb01vZGVsKVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcclxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiY2F0ZWdvcnlcIixcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvL2FkZCBhIGZpbGxlciBydWxlXHJcbiAgICB2YXIgc2ZpbGxlcnMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvZmlsbGVyLmpzb24nLCd1dGYtOCcpO1xyXG4gICAgdmFyIGZpbGxlcnMgPSBKU09OLnBhcnNlKHNmaWxsZXJzKTtcclxuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xyXG4gICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcclxuICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXHJcbiAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuUkVHRVhQLFxyXG4gICAgICByZWdleHA6IG5ldyBSZWdFeHAocmUsXCJpXCIpLFxyXG4gICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxyXG4gICAgICBfcmFua2luZzogMC45XHJcbiAgICB9KTtcclxuLypcclxuICAgIH0pXHJcbiAgICAgICAge1xyXG4gICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcclxuICAgICAgdHlwZTogMSxcclxuICAgICAgcmVnZXhwOiAvXigoc3RhcnQpfChzaG93KXwoZnJvbSl8KGluKSkkL2ksXHJcbiAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXHJcbiAgICAgIF9yYW5raW5nOiAwLjlcclxuICAgIH0sXHJcbiovXHJcbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xyXG4gICAgb01vZGVsLnRvb2xzID0gb01vZGVsLnRvb2xzLnNvcnQoVG9vbHMuY21wVG9vbHMpO1xyXG4gICAgZGVsZXRlIG9Nb2RlbC5zZWVuUnVsZXM7XHJcbiAgICByZXR1cm4gb01vZGVsO1xyXG59XHJcblxyXG5cclxuIiwiLyoqXG4gKiBGdW5jdGlvbmFsaXR5IG1hbmFnaW5nIHRoZSBtYXRjaCBtb2RlbHNcbiAqXG4gKiBAZmlsZVxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9kZWwnKTtcbnZhciBJTWF0Y2ggPSByZXF1aXJlKCcuLi9tYXRjaC9pZm1hdGNoJyk7XG52YXIgSW5wdXRGaWx0ZXJSdWxlcyA9IHJlcXVpcmUoJy4uL21hdGNoL2lucHV0RmlsdGVyUnVsZXMnKTtcbnZhciBUb29scyA9IHJlcXVpcmUoJy4uL21hdGNoL3Rvb2xzJyk7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIHByb2Nlc3MgPSByZXF1aXJlKCdwcm9jZXNzJyk7XG52YXIgbW9kZWxQYXRoID0gcHJvY2Vzcy5lbnZbXCJNT0RFTFBBVEhcIl0gfHwgXCJ0ZXN0bW9kZWxcIjtcbjtcbmZ1bmN0aW9uIGFkZFN5bm9ueW1zKHN5bm9ueW1zLCBjYXRlZ29yeSwgc3lub255bUZvciwgbVJ1bGVzLCBzZWVuKSB7XG4gICAgc3lub255bXMuZm9yRWFjaChmdW5jdGlvbiAoc3luKSB7XG4gICAgICAgIHZhciBvUnVsZSA9IHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHN5bm9ueW1Gb3IsXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBzeW4sXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICB9O1xuICAgICAgICBkZWJ1Z2xvZyhcImluc2VydGluZyBzeW5vbnltXCIgKyBKU09OLnN0cmluZ2lmeShvUnVsZSkpO1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgb1J1bGUsIHNlZW4pO1xuICAgIH0pO1xufVxuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcykge1xuICAgIGlmIChydWxlLnR5cGUgIT09IDAgLyogV09SRCAqLykge1xuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICB2YXIgc2VlblJ1bGVzID0gc2VlblJ1bGVzIHx8IHt9O1xuICAgIHZhciByID0gSlNPTi5zdHJpbmdpZnkocnVsZSk7XG4gICAgaWYgKHNlZW5SdWxlc1tyXSkge1xuICAgICAgICBkZWJ1Z2xvZyhcIkF0dGVtcHRpbmcgdG8gaW5zZXJ0IGR1cGxpY2F0ZVwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHZhciBkdXBsaWNhdGVzID0gbVJ1bGVzLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgICAgICByZXR1cm4gIUlucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUob0VudHJ5LCBydWxlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChkdXBsaWNhdGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBzZWVuUnVsZXNbcl0gPSBydWxlO1xuICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xuICAgIHJldHVybjtcbn1cbmZ1bmN0aW9uIGxvYWRNb2RlbERhdGEob01kbCwgc01vZGVsTmFtZSwgb01vZGVsKSB7XG4gICAgLy8gcmVhZCB0aGUgZGF0YSAtPlxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxuICAgIHZhciBzRmlsZU5hbWUgPSAoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5kYXRhLmpzb25cIik7XG4gICAgdmFyIG1kbGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoc0ZpbGVOYW1lLCAndXRmLTgnKTtcbiAgICB2YXIgb01kbERhdGEgPSBKU09OLnBhcnNlKG1kbGRhdGEpO1xuICAgIG9NZGxEYXRhLmZvckVhY2goZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICBpZiAoIW9FbnRyeS50b29sKSB7XG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xuICAgICAgICB9XG4gICAgICAgIG9Nb2RlbC5yZWNvcmRzLnB1c2gob0VudHJ5KTtcbiAgICAgICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIklOQ09OU0lTVEVOVCo+IE1vZGVsRGF0YSBcIiArIHNGaWxlTmFtZSArIFwiIGRvZXMgbm90IGNvbnRhaW4gY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIG9mIHdvcmRpbmRleFwiICsgSlNPTi5zdHJpbmdpZnkob0VudHJ5KSArIFwiXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xuICAgICAgICAgICAgICAgIHZhciBzU3RyaW5nID0gb0VudHJ5W2NhdGVnb3J5XTtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcInB1c2hpbmcgcnVsZSB3aXRoIFwiICsgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHNTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgICAgICAgICAgd29yZDogc1N0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICAgICAgICAgICAgICBpZiAob01kbERhdGEuc3lub255bXMgJiYgb01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldKSB7XG4gICAgICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSwgY2F0ZWdvcnksIHNTdHJpbmcsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5mdW5jdGlvbiBsb2FkTW9kZWwoc01vZGVsTmFtZSwgb01vZGVsKSB7XG4gICAgZGVidWdsb2coXCIgbG9hZGluZyBcIiArIHNNb2RlbE5hbWUgKyBcIiAuLi4uXCIpO1xuICAgIHZhciBtZGwgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5tb2RlbC5qc29uXCIsICd1dGYtOCcpO1xuICAgIHZhciBvTWRsID0gSlNPTi5wYXJzZShtZGwpO1xuICAgIGlmIChvTW9kZWwuZG9tYWlucy5pbmRleE9mKG9NZGwuZG9tYWluKSA+PSAwKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiKioqKioqKioqKipoZXJlIG1kbFwiICsgSlNPTi5zdHJpbmdpZnkob01kbCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgYWxyZWFkeSBsb2FkZWQgd2hpbGUgbG9hZGluZyAnICsgc01vZGVsTmFtZSArICc/Jyk7XG4gICAgfVxuICAgIC8vIGV4dHJhY3QgdG9vbHMgYW4gYWRkIHRvIHRvb2xzOlxuICAgIG9Nb2RlbC50b29scy5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRvb2wgXCIgKyBvTWRsLnRvb2wubmFtZSArIFwiIGFscmVhZHkgcHJlc2VudCB3aGVuIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lKTtcbiAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdEb21haW4gYWxyZWFkeSBsb2FkZWQ/Jyk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXG4gICAgaWYgKCFvTWRsLnRvb2xoaWRkZW4pIHtcbiAgICAgICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcInRvb2xcIixcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwudG9vbC5uYW1lLFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogb01kbC50b29sLm5hbWUsXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgO1xuICAgIGlmIChvTWRsLnN5bm9ueW1zICYmIG9NZGwuc3lub255bXNbXCJ0b29sXCJdKSB7XG4gICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbXCJ0b29sXCJdLCBcInRvb2xcIiwgb01kbC50b29sLm5hbWUsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH1cbiAgICA7XG4gICAgaWYgKG9NZGwuc3lub255bXMpIHtcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC5zeW5vbnltcykuZm9yRWFjaChmdW5jdGlvbiAoc3N5bmtleSkge1xuICAgICAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzc3lua2V5KSA+PSAwICYmIHNzeW5rZXkgIT09IFwidG9vbFwiKSB7XG4gICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tzc3lua2V5XSwgXCJjYXRlZ29yeVwiLCBzc3lua2V5LCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIG9Nb2RlbC5kb21haW5zLnB1c2gob01kbC5kb21haW4pO1xuICAgIG9Nb2RlbC50b29scy5wdXNoKG9NZGwudG9vbCk7XG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmNvbmNhdChvTWRsLmNhdGVnb3J5KTtcbiAgICBvTW9kZWwuY2F0ZWdvcnkuc29ydCgpO1xuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5maWx0ZXIoZnVuY3Rpb24gKHN0cmluZywgaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIG9Nb2RlbC5jYXRlZ29yeVtpbmRleF0gIT09IG9Nb2RlbC5jYXRlZ29yeVtpbmRleCArIDFdO1xuICAgIH0pO1xuICAgIGxvYWRNb2RlbERhdGEob01kbCwgc01vZGVsTmFtZSwgb01vZGVsKTtcbn0gLy8gbG9hZG1vZGVsXG5mdW5jdGlvbiBsb2FkTW9kZWxzKCkge1xuICAgIHZhciBvTW9kZWw7XG4gICAgb01vZGVsID0ge1xuICAgICAgICBkb21haW5zOiBbXSxcbiAgICAgICAgdG9vbHM6IFtdLFxuICAgICAgICBjYXRlZ29yeTogW10sXG4gICAgICAgIG1SdWxlczogW10sXG4gICAgICAgIHJlY29yZHM6IFtdXG4gICAgfTtcbiAgICB2YXIgc21kbHMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvbW9kZWxzLmpzb24nLCAndXRmLTgnKTtcbiAgICB2YXIgbWRscyA9IEpTT04ucGFyc2UoXCJcIiArIHNtZGxzKTtcbiAgICBtZGxzLmZvckVhY2goZnVuY3Rpb24gKHNNb2RlbE5hbWUpIHtcbiAgICAgICAgbG9hZE1vZGVsKHNNb2RlbE5hbWUsIG9Nb2RlbCk7XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcbiAgICBvTW9kZWwuY2F0ZWdvcnkuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH0pO1xuICAgIC8vYWRkIGEgZmlsbGVyIHJ1bGVcbiAgICB2YXIgc2ZpbGxlcnMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvZmlsbGVyLmpzb24nLCAndXRmLTgnKTtcbiAgICB2YXIgZmlsbGVycyA9IEpTT04ucGFyc2Uoc2ZpbGxlcnMpO1xuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xuICAgIG9Nb2RlbC5tUnVsZXMucHVzaCh7XG4gICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxuICAgICAgICB0eXBlOiAxIC8qIFJFR0VYUCAqLyxcbiAgICAgICAgcmVnZXhwOiBuZXcgUmVnRXhwKHJlLCBcImlcIiksXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXG4gICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICB9KTtcbiAgICAvKlxuICAgICAgICB9KVxuICAgICAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxuICAgICAgICAgIHR5cGU6IDEsXG4gICAgICAgICAgcmVnZXhwOiAvXigoc3RhcnQpfChzaG93KXwoZnJvbSl8KGluKSkkL2ksXG4gICAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJmaWxsZXJcIixcbiAgICAgICAgICBfcmFua2luZzogMC45XG4gICAgICAgIH0sXG4gICAgKi9cbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xuICAgIG9Nb2RlbC50b29scyA9IG9Nb2RlbC50b29scy5zb3J0KFRvb2xzLmNtcFRvb2xzKTtcbiAgICBkZWxldGUgb01vZGVsLnNlZW5SdWxlcztcbiAgICByZXR1cm4gb01vZGVsO1xufVxuZXhwb3J0cy5sb2FkTW9kZWxzID0gbG9hZE1vZGVscztcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
