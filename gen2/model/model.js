/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require('debug');
var debuglog = debug('model');
var logger = require('../utils/logger');
var loadlog = logger.logger('modelload', '');
var IMatch = require('../match/ifmatch');
var InputFilterRules = require('../match/inputFilterRules');
var Tools = require('../match/tools');
var fs = require('fs');
var process = require('process');
/**
 * the model path, may be controlled via environment variable
 */
var modelPath = process.env["ABOT_MODELPATH"] || "testmodel";
;
function addSynonyms(synonyms, category, synonymFor, mRules, seen) {
    synonyms.forEach(function (syn) {
        var oRule = {
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            _ranking: 0.95
        };
        debuglog("inserting synonym" + JSON.stringify(oRule));
        insertRuleIfNotPresent(mRules, oRule, seen);
    });
}
function insertRuleIfNotPresent(mRules, rule, seenRules) {
    if (rule.type !== 0 /* WORD */) {
            mRules.push(rule);
            return;
        }
    if (rule.word === undefined || rule.matchedString === undefined) {
        throw new Error('illegal rule' + JSON.stringify(rule, undefined, 2));
    }
    var seenRules = seenRules || {};
    var r = JSON.stringify(rule);
    if (seenRules[r]) {
        debuglog("Attempting to insert duplicate" + JSON.stringify(rule, undefined, 2));
        var duplicates = mRules.filter(function (oEntry) {
            return !InputFilterRules.cmpMRule(oEntry, rule);
        });
        if (duplicates.length > 0) {
            return;
        }
    }
    seenRules[r] = rule;
    rule.lowercaseword = rule.word.toLowerCase();
    if (rule.word === "") {
        debuglog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        loadlog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        return;
    }
    mRules.push(rule);
    return;
}
function loadModelData(oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var sFileName = './' + modelPath + '/' + sModelName + ".data.json";
    var mdldata = fs.readFileSync(sFileName, 'utf-8');
    var oMdlData = JSON.parse(mdldata);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.tool && oMdl.tool.name) {
            oEntry.tool = oMdl.tool.name;
        }
        oModel.records.push(oEntry);
        oMdl.wordindex.forEach(function (category) {
            if (oEntry[category] === undefined) {
                debuglog("INCONSISTENT*> ModelData " + sFileName + " does not contain category " + category + " of wordindex" + JSON.stringify(oEntry) + "");
                return;
            }
            if (oEntry[category] !== "*") {
                var sString = oEntry[category];
                debuglog("pushing rule with " + category + " -> " + sString);
                var oRule = {
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    _ranking: 0.95
                };
                if (oMdl.exactmatch && oMdl.exactmatch.indexOf(category) >= 0) {
                    oRule.exactOnly = true;
                }
                insertRuleIfNotPresent(oModel.mRules, oRule, oModel.seenRules);
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, oModel.mRules, oModel.seenRules);
                }
            }
        });
    });
}
function loadModel(sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var mdl = fs.readFileSync('./' + modelPath + '/' + sModelName + ".model.json", 'utf-8');
    var oMdl = JSON.parse(mdl);
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // extract tools an add to tools:
    oModel.tools.filter(function (oEntry) {
        if (oEntry.name === (oMdl.tool && oMdl.tool.name)) {
            console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
            //throw new Error('Domain already loaded?');
            process.exit(-1);
        }
    });
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden && oMdl.tool && oMdl.tool.name) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            _ranking: 0.95
        }, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oModel.mRules, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oModel.mRules, oModel.seenRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    if (oMdl.tool.name) {
        oModel.tools.push(oMdl.tool);
    }
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
    loadModelData(oMdl, sModelName, oModel);
} // loadmodel
function loadModels() {
    var oModel;
    oModel = {
        domains: [],
        tools: [],
        category: [],
        mRules: [],
        records: []
    };
    var smdls = fs.readFileSync('./' + modelPath + '/models.json', 'utf-8');
    var mdls = JSON.parse("" + smdls);
    mdls.forEach(function (sModelName) {
        loadModel(sModelName, oModel);
    });
    // add the categories to the model:
    oModel.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            lowercaseword: category.toLowerCase(),
            _ranking: 0.95
        }, oModel.seenRules);
    });
    //add a filler rule
    var sfillers = fs.readFileSync('./' + modelPath + '/filler.json', 'utf-8');
    var fillers = JSON.parse(sfillers);
    var re = "^((" + fillers.join(")|(") + "))$";
    oModel.mRules.push({
        category: "filler",
        type: 1 /* REGEXP */
        , regexp: new RegExp(re, "i"),
        matchedString: "filler",
        _ranking: 0.9
    });
    /*
        })
            {
          category: "filler",
          type: 1,
          regexp: /^((start)|(show)|(from)|(in))$/i,
          matchedString: "filler",
          _ranking: 0.9
        },
    */
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    oModel.tools = oModel.tools.sort(Tools.cmpTools);
    delete oModel.seenRules;
    return oModel;
}
exports.loadModels = loadModels;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwibG9nZ2VyIiwibG9hZGxvZyIsIklNYXRjaCIsIklucHV0RmlsdGVyUnVsZXMiLCJUb29scyIsImZzIiwicHJvY2VzcyIsIm1vZGVsUGF0aCIsImVudiIsImFkZFN5bm9ueW1zIiwic3lub255bXMiLCJjYXRlZ29yeSIsInN5bm9ueW1Gb3IiLCJtUnVsZXMiLCJzZWVuIiwiZm9yRWFjaCIsInN5biIsIm9SdWxlIiwibWF0Y2hlZFN0cmluZyIsInR5cGUiLCJ3b3JkIiwiX3JhbmtpbmciLCJKU09OIiwic3RyaW5naWZ5IiwiaW5zZXJ0UnVsZUlmTm90UHJlc2VudCIsInJ1bGUiLCJzZWVuUnVsZXMiLCJwdXNoIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJyIiwiZHVwbGljYXRlcyIsImZpbHRlciIsIm9FbnRyeSIsImNtcE1SdWxlIiwibGVuZ3RoIiwibG93ZXJjYXNld29yZCIsInRvTG93ZXJDYXNlIiwibG9hZE1vZGVsRGF0YSIsIm9NZGwiLCJzTW9kZWxOYW1lIiwib01vZGVsIiwic0ZpbGVOYW1lIiwibWRsZGF0YSIsInJlYWRGaWxlU3luYyIsIm9NZGxEYXRhIiwicGFyc2UiLCJ0b29sIiwibmFtZSIsInJlY29yZHMiLCJ3b3JkaW5kZXgiLCJzU3RyaW5nIiwiZXhhY3RtYXRjaCIsImluZGV4T2YiLCJleGFjdE9ubHkiLCJsb2FkTW9kZWwiLCJtZGwiLCJkb21haW5zIiwiZG9tYWluIiwidG9vbHMiLCJjb25zb2xlIiwibG9nIiwiZXhpdCIsInRvb2xoaWRkZW4iLCJPYmplY3QiLCJrZXlzIiwic3N5bmtleSIsImNvbmNhdCIsInNvcnQiLCJzdHJpbmciLCJpbmRleCIsImxvYWRNb2RlbHMiLCJzbWRscyIsIm1kbHMiLCJzZmlsbGVycyIsImZpbGxlcnMiLCJyZSIsImpvaW4iLCJyZWdleHAiLCJSZWdFeHAiLCJj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QjtBQUNBTyxXQUFPa0IsS0FBUCxHQUFlbEIsT0FBT2tCLEtBQVAsQ0FBYVMsSUFBYixDQUFrQmhFLE1BQU00RSxRQUF4QixDQUFmO0FBQ0EsV0FBT3ZDLE9BQU9mLFNBQWQ7QUFDQSxXQUFPZSxNQUFQO0FBQ0g7QUFwRGV3QyxRQUFBVixVQUFBLEdBQVVBLFVBQVYiLCJmaWxlIjoibW9kZWwvbW9kZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRnVuY3Rpb25hbGl0eSBtYW5hZ2luZyB0aGUgbWF0Y2ggbW9kZWxzXHJcbiAqXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5cclxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xyXG5cclxudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vZGVsJyk7XHJcblxyXG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcclxuXHJcblxyXG5jb25zdCBsb2FkbG9nID0gbG9nZ2VyLmxvZ2dlcignbW9kZWxsb2FkJywgJycpO1xyXG5cclxuaW1wb3J0ICogIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuXHJcbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4uL21hdGNoL21hdGNoJztcclxuXHJcbmltcG9ydCAqIGFzIElucHV0RmlsdGVyUnVsZXMgZnJvbSAnLi4vbWF0Y2gvaW5wdXRGaWx0ZXJSdWxlcyc7XHJcblxyXG5pbXBvcnQgKiBhcyBUb29scyBmcm9tICcuLi9tYXRjaC90b29scyc7XHJcblxyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XHJcblxyXG5pbXBvcnQgKiBhcyBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xyXG5cclxuLyoqXHJcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcclxuICovXHJcbnZhciBtb2RlbFBhdGggPSBwcm9jZXNzLmVudltcIkFCT1RfTU9ERUxQQVRIXCJdIHx8IFwidGVzdG1vZGVsXCI7XHJcblxyXG5cclxuaW50ZXJmYWNlIElNb2RlbHMge1xyXG4gICAgZG9tYWluczogc3RyaW5nW10sXHJcbiAgICB0b29sczogSU1hdGNoLklUb29sW10sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW10sXHJcbiAgICBtUnVsZXM6IElNYXRjaC5tUnVsZVtdLFxyXG4gICAgcmVjb3JkczogYW55W11cclxuICAgIHNlZW5SdWxlcz86IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIElNb2RlbCB7XHJcbiAgICBkb21haW46IHN0cmluZyxcclxuICAgIHRvb2w6IElNYXRjaC5JVG9vbCxcclxuICAgIHRvb2xoaWRkZW4/OiBib29sZWFuLFxyXG4gICAgc3lub255bXM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZ1tdIH0sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW10sXHJcbiAgICB3b3JkaW5kZXg6IHN0cmluZ1tdLFxyXG4gICAgZXhhY3RtYXRjaD8gOiBzdHJpbmdbXSxcclxuICAgIGhpZGRlbjogc3RyaW5nW11cclxufTtcclxuXHJcbmZ1bmN0aW9uIGFkZFN5bm9ueW1zKHN5bm9ueW1zOiBzdHJpbmdbXSwgY2F0ZWdvcnk6IHN0cmluZywgc3lub255bUZvcjogc3RyaW5nLCBtUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4sIHNlZW46IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlIH0pIHtcclxuICAgIHN5bm9ueW1zLmZvckVhY2goZnVuY3Rpb24gKHN5bikge1xyXG4gICAgICAgIHZhciBvUnVsZSA9IHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzeW5vbnltRm9yLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIHdvcmQ6IHN5bixcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9O1xyXG4gICAgICAgIGRlYnVnbG9nKFwiaW5zZXJ0aW5nIHN5bm9ueW1cIiArIEpTT04uc3RyaW5naWZ5KG9SdWxlKSk7XHJcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIG9SdWxlLCBzZWVuKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgcnVsZTogSU1hdGNoLm1SdWxlLFxyXG4gICAgc2VlblJ1bGVzOiB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5tUnVsZSB9KSB7XHJcbiAgICBpZiAocnVsZS50eXBlICE9PSBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQpIHtcclxuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbGxlZ2FsIHJ1bGUnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICB9XHJcbiAgICB2YXIgc2VlblJ1bGVzID0gc2VlblJ1bGVzIHx8IHt9O1xyXG4gICAgdmFyIHIgPSBKU09OLnN0cmluZ2lmeShydWxlKTtcclxuICAgIGlmIChzZWVuUnVsZXNbcl0pIHtcclxuICAgICAgICBkZWJ1Z2xvZyhcIkF0dGVtcHRpbmcgdG8gaW5zZXJ0IGR1cGxpY2F0ZVwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgdmFyIGR1cGxpY2F0ZXMgPSBtUnVsZXMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICAgICAgcmV0dXJuICFJbnB1dEZpbHRlclJ1bGVzLmNtcE1SdWxlKG9FbnRyeSwgcnVsZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGR1cGxpY2F0ZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc2VlblJ1bGVzW3JdID0gcnVsZTtcclxuICAgIHJ1bGUubG93ZXJjYXNld29yZCA9IHJ1bGUud29yZC50b0xvd2VyQ2FzZSgpO1xyXG4gICAgaWYgKHJ1bGUud29yZCA9PT0gXCJcIikge1xyXG4gICAgICAgIGRlYnVnbG9nKCdTa2lwcGluZyBydWxlIHdpdGggZW10cHkgd29yZCAnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgbG9hZGxvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xyXG4gICAgcmV0dXJuO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkTW9kZWxEYXRhKG9NZGw6IElNb2RlbCwgc01vZGVsTmFtZTogc3RyaW5nLCBvTW9kZWw6IElNb2RlbHMpIHtcclxuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cclxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxyXG4gICAgY29uc3Qgc0ZpbGVOYW1lID0gKCcuLycgKyBtb2RlbFBhdGggKyAnLycgKyBzTW9kZWxOYW1lICsgXCIuZGF0YS5qc29uXCIpO1xyXG4gICAgdmFyIG1kbGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoc0ZpbGVOYW1lLCAndXRmLTgnKTtcclxuICAgIHZhciBvTWRsRGF0YSA9IEpTT04ucGFyc2UobWRsZGF0YSk7XHJcbiAgICBvTWRsRGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICBpZiAoIW9FbnRyeS50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XHJcbiAgICAgICAgICAgIG9FbnRyeS50b29sID0gb01kbC50b29sLm5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9Nb2RlbC5yZWNvcmRzLnB1c2gob0VudHJ5KTtcclxuXHJcbiAgICAgICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcclxuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiICsgY2F0ZWdvcnkgKyBcIiBvZiB3b3JkaW5kZXhcIiArIEpTT04uc3RyaW5naWZ5KG9FbnRyeSkgKyBcIlwiKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNTdHJpbmcgPSBvRW50cnlbY2F0ZWdvcnldO1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJwdXNoaW5nIHJ1bGUgd2l0aCBcIiArIGNhdGVnb3J5ICsgXCIgLT4gXCIgKyBzU3RyaW5nKTtcclxuICAgICAgICAgICAgICAgIHZhciBvUnVsZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmQ6IHNTdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgICAgICAgICAgICAgfSBhcyBJTWF0Y2gubVJ1bGU7XHJcbiAgICAgICAgICAgICAgICBpZihvTWRsLmV4YWN0bWF0Y2ggJiYgb01kbC5leGFjdG1hdGNoLmluZGV4T2YoY2F0ZWdvcnkpID49IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBvUnVsZS5leGFjdE9ubHkgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLG9SdWxlLCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgICAgICAgICAgICAgIGlmIChvTWRsRGF0YS5zeW5vbnltcyAmJiBvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0pIHtcclxuICAgICAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0sIGNhdGVnb3J5LCBzU3RyaW5nLCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRNb2RlbChzTW9kZWxOYW1lOiBzdHJpbmcsIG9Nb2RlbDogSU1vZGVscykge1xyXG4gICAgZGVidWdsb2coXCIgbG9hZGluZyBcIiArIHNNb2RlbE5hbWUgKyBcIiAuLi4uXCIpO1xyXG4gICAgdmFyIG1kbCA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLm1vZGVsLmpzb25cIiwgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgb01kbCA9IEpTT04ucGFyc2UobWRsKSBhcyBJTW9kZWw7XHJcblxyXG4gICAgaWYgKG9Nb2RlbC5kb21haW5zLmluZGV4T2Yob01kbC5kb21haW4pID49IDApIHtcclxuICAgICAgICBkZWJ1Z2xvZyhcIioqKioqKioqKioqaGVyZSBtZGxcIiArIEpTT04uc3RyaW5naWZ5KG9NZGwsIHVuZGVmaW5lZCwgMikpO1xyXG5cclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiAnICsgb01kbC5kb21haW4gKyAnIGFscmVhZHkgbG9hZGVkIHdoaWxlIGxvYWRpbmcgJyArIHNNb2RlbE5hbWUgKyAnPycpO1xyXG4gICAgfVxyXG4gICAgLy8gZXh0cmFjdCB0b29scyBhbiBhZGQgdG8gdG9vbHM6XHJcbiAgICBvTW9kZWwudG9vbHMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IChvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVG9vbCBcIiArIG9NZGwudG9vbC5uYW1lICsgXCIgYWxyZWFkeSBwcmVzZW50IHdoZW4gbG9hZGluZyBcIiArIHNNb2RlbE5hbWUpO1xyXG4gICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluIGFscmVhZHkgbG9hZGVkPycpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXHJcbiAgICBpZiAoIW9NZGwudG9vbGhpZGRlbiAmJiBvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpIHtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwidG9vbFwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgIH07XHJcbiAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW1widG9vbFwiXSkge1xyXG4gICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbXCJ0b29sXCJdLCBcInRvb2xcIiwgb01kbC50b29sLm5hbWUsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgfTtcclxuICAgIGlmIChvTWRsLnN5bm9ueW1zKSB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC5zeW5vbnltcykuZm9yRWFjaChmdW5jdGlvbiAoc3N5bmtleSkge1xyXG4gICAgICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNzeW5rZXkpID49IDAgJiYgc3N5bmtleSAhPT0gXCJ0b29sXCIpIHtcclxuICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbc3N5bmtleV0sIFwiY2F0ZWdvcnlcIiwgc3N5bmtleSwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIG9Nb2RlbC5kb21haW5zLnB1c2gob01kbC5kb21haW4pO1xyXG4gICAgaWYob01kbC50b29sLm5hbWUpIHtcclxuICAgICAgb01vZGVsLnRvb2xzLnB1c2gob01kbC50b29sKTtcclxuICAgIH1cclxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5jb25jYXQob01kbC5jYXRlZ29yeSk7XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkuc29ydCgpO1xyXG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmZpbHRlcihmdW5jdGlvbiAoc3RyaW5nLCBpbmRleCkge1xyXG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcclxuICAgIH0pO1xyXG4gICAgbG9hZE1vZGVsRGF0YShvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpO1xyXG59IC8vIGxvYWRtb2RlbFxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkTW9kZWxzKCkge1xyXG4gICAgdmFyIG9Nb2RlbDogSU1vZGVscztcclxuICAgIG9Nb2RlbCA9IHtcclxuICAgICAgICBkb21haW5zOiBbXSxcclxuICAgICAgICB0b29sczogW10sXHJcbiAgICAgICAgY2F0ZWdvcnk6IFtdLFxyXG4gICAgICAgIG1SdWxlczogW10sXHJcbiAgICAgICAgcmVjb3JkczogW11cclxuICAgIH1cclxuICAgIHZhciBzbWRscyA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy9tb2RlbHMuanNvbicsICd1dGYtOCcpO1xyXG4gICAgdmFyIG1kbHMgPSBKU09OLnBhcnNlKFwiXCIgKyBzbWRscyk7XHJcbiAgICBtZGxzLmZvckVhY2goZnVuY3Rpb24gKHNNb2RlbE5hbWUpIHtcclxuICAgICAgICBsb2FkTW9kZWwoc01vZGVsTmFtZSwgb01vZGVsKVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcclxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vYWRkIGEgZmlsbGVyIHJ1bGVcclxuICAgIHZhciBzZmlsbGVycyA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy9maWxsZXIuanNvbicsICd1dGYtOCcpO1xyXG4gICAgdmFyIGZpbGxlcnMgPSBKU09OLnBhcnNlKHNmaWxsZXJzKTtcclxuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xyXG4gICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcclxuICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcclxuICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLlJFR0VYUCxcclxuICAgICAgICByZWdleHA6IG5ldyBSZWdFeHAocmUsIFwiaVwiKSxcclxuICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxyXG4gICAgICAgIF9yYW5raW5nOiAwLjlcclxuICAgIH0pO1xyXG4gICAgLypcclxuICAgICAgICB9KVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcclxuICAgICAgICAgIHR5cGU6IDEsXHJcbiAgICAgICAgICByZWdleHA6IC9eKChzdGFydCl8KHNob3cpfChmcm9tKXwoaW4pKSQvaSxcclxuICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXHJcbiAgICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICAgICAgfSxcclxuICAgICovXHJcbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xyXG4gICAgb01vZGVsLnRvb2xzID0gb01vZGVsLnRvb2xzLnNvcnQoVG9vbHMuY21wVG9vbHMpO1xyXG4gICAgZGVsZXRlIG9Nb2RlbC5zZWVuUnVsZXM7XHJcbiAgICByZXR1cm4gb01vZGVsO1xyXG59XHJcblxyXG5cclxuIiwiLyoqXG4gKiBGdW5jdGlvbmFsaXR5IG1hbmFnaW5nIHRoZSBtYXRjaCBtb2RlbHNcbiAqXG4gKiBAZmlsZVxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9kZWwnKTtcbnZhciBsb2dnZXIgPSByZXF1aXJlKCcuLi91dGlscy9sb2dnZXInKTtcbnZhciBsb2FkbG9nID0gbG9nZ2VyLmxvZ2dlcignbW9kZWxsb2FkJywgJycpO1xudmFyIElNYXRjaCA9IHJlcXVpcmUoJy4uL21hdGNoL2lmbWF0Y2gnKTtcbnZhciBJbnB1dEZpbHRlclJ1bGVzID0gcmVxdWlyZSgnLi4vbWF0Y2gvaW5wdXRGaWx0ZXJSdWxlcycpO1xudmFyIFRvb2xzID0gcmVxdWlyZSgnLi4vbWF0Y2gvdG9vbHMnKTtcbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG52YXIgcHJvY2VzcyA9IHJlcXVpcmUoJ3Byb2Nlc3MnKTtcbi8qKlxuICogdGhlIG1vZGVsIHBhdGgsIG1heSBiZSBjb250cm9sbGVkIHZpYSBlbnZpcm9ubWVudCB2YXJpYWJsZVxuICovXG52YXIgbW9kZWxQYXRoID0gcHJvY2Vzcy5lbnZbXCJBQk9UX01PREVMUEFUSFwiXSB8fCBcInRlc3Rtb2RlbFwiO1xuO1xuZnVuY3Rpb24gYWRkU3lub255bXMoc3lub255bXMsIGNhdGVnb3J5LCBzeW5vbnltRm9yLCBtUnVsZXMsIHNlZW4pIHtcbiAgICBzeW5vbnltcy5mb3JFYWNoKGZ1bmN0aW9uIChzeW4pIHtcbiAgICAgICAgdmFyIG9SdWxlID0ge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc3lub255bUZvcixcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIHdvcmQ6IHN5bixcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH07XG4gICAgICAgIGRlYnVnbG9nKFwiaW5zZXJ0aW5nIHN5bm9ueW1cIiArIEpTT04uc3RyaW5naWZ5KG9SdWxlKSk7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQobVJ1bGVzLCBvUnVsZSwgc2Vlbik7XG4gICAgfSk7XG59XG5mdW5jdGlvbiBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgcnVsZSwgc2VlblJ1bGVzKSB7XG4gICAgaWYgKHJ1bGUudHlwZSAhPT0gMCAvKiBXT1JEICovKSB7XG4gICAgICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICgocnVsZS53b3JkID09PSB1bmRlZmluZWQpIHx8IChydWxlLm1hdGNoZWRTdHJpbmcgPT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbGxlZ2FsIHJ1bGUnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHZhciBzZWVuUnVsZXMgPSBzZWVuUnVsZXMgfHwge307XG4gICAgdmFyIHIgPSBKU09OLnN0cmluZ2lmeShydWxlKTtcbiAgICBpZiAoc2VlblJ1bGVzW3JdKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiQXR0ZW1wdGluZyB0byBpbnNlcnQgZHVwbGljYXRlXCIgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgdmFyIGR1cGxpY2F0ZXMgPSBtUnVsZXMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcbiAgICAgICAgICAgIHJldHVybiAhSW5wdXRGaWx0ZXJSdWxlcy5jbXBNUnVsZShvRW50cnksIHJ1bGUpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGR1cGxpY2F0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuICAgIHNlZW5SdWxlc1tyXSA9IHJ1bGU7XG4gICAgcnVsZS5sb3dlcmNhc2V3b3JkID0gcnVsZS53b3JkLnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKHJ1bGUud29yZCA9PT0gXCJcIikge1xuICAgICAgICBkZWJ1Z2xvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICBsb2FkbG9nKCdTa2lwcGluZyBydWxlIHdpdGggZW10cHkgd29yZCAnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbVJ1bGVzLnB1c2gocnVsZSk7XG4gICAgcmV0dXJuO1xufVxuZnVuY3Rpb24gbG9hZE1vZGVsRGF0YShvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpIHtcbiAgICAvLyByZWFkIHRoZSBkYXRhIC0+XG4gICAgLy8gZGF0YSBpcyBwcm9jZXNzZWQgaW50byBtUnVsZXMgZGlyZWN0bHksXG4gICAgdmFyIHNGaWxlTmFtZSA9ICgnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLmRhdGEuanNvblwiKTtcbiAgICB2YXIgbWRsZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhzRmlsZU5hbWUsICd1dGYtOCcpO1xuICAgIHZhciBvTWRsRGF0YSA9IEpTT04ucGFyc2UobWRsZGF0YSk7XG4gICAgb01kbERhdGEuZm9yRWFjaChmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgIGlmICghb0VudHJ5LnRvb2wgJiYgb01kbC50b29sLm5hbWUpIHtcbiAgICAgICAgICAgIG9FbnRyeS50b29sID0gb01kbC50b29sLm5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgb01vZGVsLnJlY29yZHMucHVzaChvRW50cnkpO1xuICAgICAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwiSU5DT05TSVNURU5UKj4gTW9kZWxEYXRhIFwiICsgc0ZpbGVOYW1lICsgXCIgZG9lcyBub3QgY29udGFpbiBjYXRlZ29yeSBcIiArIGNhdGVnb3J5ICsgXCIgb2Ygd29yZGluZGV4XCIgKyBKU09OLnN0cmluZ2lmeShvRW50cnkpICsgXCJcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gIT09IFwiKlwiKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNTdHJpbmcgPSBvRW50cnlbY2F0ZWdvcnldO1xuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwicHVzaGluZyBydWxlIHdpdGggXCIgKyBjYXRlZ29yeSArIFwiIC0+IFwiICsgc1N0cmluZyk7XG4gICAgICAgICAgICAgICAgdmFyIG9SdWxlID0ge1xuICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHNTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgICAgICAgICAgd29yZDogc1N0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGlmIChvTWRsLmV4YWN0bWF0Y2ggJiYgb01kbC5leGFjdG1hdGNoLmluZGV4T2YoY2F0ZWdvcnkpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgb1J1bGUuZXhhY3RPbmx5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCBvUnVsZSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICAgICAgaWYgKG9NZGxEYXRhLnN5bm9ueW1zICYmIG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSkge1xuICAgICAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0sIGNhdGVnb3J5LCBzU3RyaW5nLCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuZnVuY3Rpb24gbG9hZE1vZGVsKHNNb2RlbE5hbWUsIG9Nb2RlbCkge1xuICAgIGRlYnVnbG9nKFwiIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lICsgXCIgLi4uLlwiKTtcbiAgICB2YXIgbWRsID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnLycgKyBzTW9kZWxOYW1lICsgXCIubW9kZWwuanNvblwiLCAndXRmLTgnKTtcbiAgICB2YXIgb01kbCA9IEpTT04ucGFyc2UobWRsKTtcbiAgICBpZiAob01vZGVsLmRvbWFpbnMuaW5kZXhPZihvTWRsLmRvbWFpbikgPj0gMCkge1xuICAgICAgICBkZWJ1Z2xvZyhcIioqKioqKioqKioqaGVyZSBtZGxcIiArIEpTT04uc3RyaW5naWZ5KG9NZGwsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiAnICsgb01kbC5kb21haW4gKyAnIGFscmVhZHkgbG9hZGVkIHdoaWxlIGxvYWRpbmcgJyArIHNNb2RlbE5hbWUgKyAnPycpO1xuICAgIH1cbiAgICAvLyBleHRyYWN0IHRvb2xzIGFuIGFkZCB0byB0b29sczpcbiAgICBvTW9kZWwudG9vbHMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcbiAgICAgICAgaWYgKG9FbnRyeS5uYW1lID09PSAob01kbC50b29sICYmIG9NZGwudG9vbC5uYW1lKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUb29sIFwiICsgb01kbC50b29sLm5hbWUgKyBcIiBhbHJlYWR5IHByZXNlbnQgd2hlbiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSk7XG4gICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluIGFscmVhZHkgbG9hZGVkPycpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vIGFkZCB0aGUgdG9vbCBuYW1lIGFzIHJ1bGUgdW5sZXNzIGhpZGRlblxuICAgIGlmICghb01kbC50b29saGlkZGVuICYmIG9NZGwudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkge1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcInRvb2xcIixcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwudG9vbC5uYW1lLFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogb01kbC50b29sLm5hbWUsXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICB9XG4gICAgO1xuICAgIGlmIChvTWRsLnN5bm9ueW1zICYmIG9NZGwuc3lub255bXNbXCJ0b29sXCJdKSB7XG4gICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbXCJ0b29sXCJdLCBcInRvb2xcIiwgb01kbC50b29sLm5hbWUsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH1cbiAgICA7XG4gICAgaWYgKG9NZGwuc3lub255bXMpIHtcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC5zeW5vbnltcykuZm9yRWFjaChmdW5jdGlvbiAoc3N5bmtleSkge1xuICAgICAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzc3lua2V5KSA+PSAwICYmIHNzeW5rZXkgIT09IFwidG9vbFwiKSB7XG4gICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tzc3lua2V5XSwgXCJjYXRlZ29yeVwiLCBzc3lua2V5LCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIG9Nb2RlbC5kb21haW5zLnB1c2gob01kbC5kb21haW4pO1xuICAgIGlmIChvTWRsLnRvb2wubmFtZSkge1xuICAgICAgICBvTW9kZWwudG9vbHMucHVzaChvTWRsLnRvb2wpO1xuICAgIH1cbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuY29uY2F0KG9NZGwuY2F0ZWdvcnkpO1xuICAgIG9Nb2RlbC5jYXRlZ29yeS5zb3J0KCk7XG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmZpbHRlcihmdW5jdGlvbiAoc3RyaW5nLCBpbmRleCkge1xuICAgICAgICByZXR1cm4gb01vZGVsLmNhdGVnb3J5W2luZGV4XSAhPT0gb01vZGVsLmNhdGVnb3J5W2luZGV4ICsgMV07XG4gICAgfSk7XG4gICAgbG9hZE1vZGVsRGF0YShvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpO1xufSAvLyBsb2FkbW9kZWxcbmZ1bmN0aW9uIGxvYWRNb2RlbHMoKSB7XG4gICAgdmFyIG9Nb2RlbDtcbiAgICBvTW9kZWwgPSB7XG4gICAgICAgIGRvbWFpbnM6IFtdLFxuICAgICAgICB0b29sczogW10sXG4gICAgICAgIGNhdGVnb3J5OiBbXSxcbiAgICAgICAgbVJ1bGVzOiBbXSxcbiAgICAgICAgcmVjb3JkczogW11cbiAgICB9O1xuICAgIHZhciBzbWRscyA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy9tb2RlbHMuanNvbicsICd1dGYtOCcpO1xuICAgIHZhciBtZGxzID0gSlNPTi5wYXJzZShcIlwiICsgc21kbHMpO1xuICAgIG1kbHMuZm9yRWFjaChmdW5jdGlvbiAoc01vZGVsTmFtZSkge1xuICAgICAgICBsb2FkTW9kZWwoc01vZGVsTmFtZSwgb01vZGVsKTtcbiAgICB9KTtcbiAgICAvLyBhZGQgdGhlIGNhdGVnb3JpZXMgdG8gdGhlIG1vZGVsOlxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcImNhdGVnb3J5XCIsXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIHdvcmQ6IGNhdGVnb3J5LFxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH0pO1xuICAgIC8vYWRkIGEgZmlsbGVyIHJ1bGVcbiAgICB2YXIgc2ZpbGxlcnMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvZmlsbGVyLmpzb24nLCAndXRmLTgnKTtcbiAgICB2YXIgZmlsbGVycyA9IEpTT04ucGFyc2Uoc2ZpbGxlcnMpO1xuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xuICAgIG9Nb2RlbC5tUnVsZXMucHVzaCh7XG4gICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxuICAgICAgICB0eXBlOiAxIC8qIFJFR0VYUCAqLyxcbiAgICAgICAgcmVnZXhwOiBuZXcgUmVnRXhwKHJlLCBcImlcIiksXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXG4gICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICB9KTtcbiAgICAvKlxuICAgICAgICB9KVxuICAgICAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxuICAgICAgICAgIHR5cGU6IDEsXG4gICAgICAgICAgcmVnZXhwOiAvXigoc3RhcnQpfChzaG93KXwoZnJvbSl8KGluKSkkL2ksXG4gICAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJmaWxsZXJcIixcbiAgICAgICAgICBfcmFua2luZzogMC45XG4gICAgICAgIH0sXG4gICAgKi9cbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xuICAgIG9Nb2RlbC50b29scyA9IG9Nb2RlbC50b29scy5zb3J0KFRvb2xzLmNtcFRvb2xzKTtcbiAgICBkZWxldGUgb01vZGVsLnNlZW5SdWxlcztcbiAgICByZXR1cm4gb01vZGVsO1xufVxuZXhwb3J0cy5sb2FkTW9kZWxzID0gbG9hZE1vZGVscztcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
