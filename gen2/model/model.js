/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require('debug');
var debuglog = debug('model');
var logger = require('../utils/logger');
var loadlog = logger.logger('modelload', '');
var IMatch = require('../match/ifmatch');
var InputFilterRules = require('../match/inputFilterRules');
var Tools = require('../match/tools');
var fs = require('fs');
var process = require('process');
var modelPath = process.env["MODELPATH"] || "testmodel";
;
function addSynonyms(synonyms, category, synonymFor, mRules, seen) {
    synonyms.forEach(function (syn) {
        var oRule = {
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            _ranking: 0.95
        };
        debuglog("inserting synonym" + JSON.stringify(oRule));
        insertRuleIfNotPresent(mRules, oRule, seen);
    });
}
function insertRuleIfNotPresent(mRules, rule, seenRules) {
    if (rule.type !== 0 /* WORD */) {
            mRules.push(rule);
            return;
        }
    if (rule.word === undefined || rule.matchedString === undefined) {
        throw new Error('illegal rule' + JSON.stringify(rule, undefined, 2));
    }
    var seenRules = seenRules || {};
    var r = JSON.stringify(rule);
    if (seenRules[r]) {
        debuglog("Attempting to insert duplicate" + JSON.stringify(rule, undefined, 2));
        var duplicates = mRules.filter(function (oEntry) {
            return !InputFilterRules.cmpMRule(oEntry, rule);
        });
        if (duplicates.length > 0) {
            return;
        }
    }
    seenRules[r] = rule;
    rule.lowercaseword = rule.word.toLowerCase();
    if (rule.word === "") {
        debuglog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        loadlog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        return;
    }
    mRules.push(rule);
    return;
}
function loadModelData(oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var sFileName = './' + modelPath + '/' + sModelName + ".data.json";
    var mdldata = fs.readFileSync(sFileName, 'utf-8');
    var oMdlData = JSON.parse(mdldata);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.tool && oMdl.tool.name) {
            oEntry.tool = oMdl.tool.name;
        }
        oModel.records.push(oEntry);
        oMdl.wordindex.forEach(function (category) {
            if (oEntry[category] === undefined) {
                debuglog("INCONSISTENT*> ModelData " + sFileName + " does not contain category " + category + " of wordindex" + JSON.stringify(oEntry) + "");
                return;
            }
            if (oEntry[category] !== "*") {
                var sString = oEntry[category];
                debuglog("pushing rule with " + category + " -> " + sString);
                var oRule = {
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    _ranking: 0.95
                };
                if (oMdl.exactmatch && oMdl.exactmatch.indexOf(category) >= 0) {
                    oRule.exactOnly = true;
                }
                insertRuleIfNotPresent(oModel.mRules, oRule, oModel.seenRules);
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, oModel.mRules, oModel.seenRules);
                }
            }
        });
    });
}
function loadModel(sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var mdl = fs.readFileSync('./' + modelPath + '/' + sModelName + ".model.json", 'utf-8');
    var oMdl = JSON.parse(mdl);
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // extract tools an add to tools:
    oModel.tools.filter(function (oEntry) {
        if (oEntry.name === (oMdl.tool && oMdl.tool.name)) {
            console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
            //throw new Error('Domain already loaded?');
            process.exit(-1);
        }
    });
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden && oMdl.tool && oMdl.tool.name) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            _ranking: 0.95
        }, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oModel.mRules, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oModel.mRules, oModel.seenRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    if (oMdl.tool.name) {
        oModel.tools.push(oMdl.tool);
    }
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
    loadModelData(oMdl, sModelName, oModel);
} // loadmodel
function loadModels() {
    var oModel;
    oModel = {
        domains: [],
        tools: [],
        category: [],
        mRules: [],
        records: []
    };
    var smdls = fs.readFileSync('./' + modelPath + '/models.json', 'utf-8');
    var mdls = JSON.parse("" + smdls);
    mdls.forEach(function (sModelName) {
        loadModel(sModelName, oModel);
    });
    // add the categories to the model:
    oModel.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            lowercaseword: category.toLowerCase(),
            _ranking: 0.95
        }, oModel.seenRules);
    });
    //add a filler rule
    var sfillers = fs.readFileSync('./' + modelPath + '/filler.json', 'utf-8');
    var fillers = JSON.parse(sfillers);
    var re = "^((" + fillers.join(")|(") + "))$";
    oModel.mRules.push({
        category: "filler",
        type: 1 /* REGEXP */
        , regexp: new RegExp(re, "i"),
        matchedString: "filler",
        _ranking: 0.9
    });
    /*
        })
            {
          category: "filler",
          type: 1,
          regexp: /^((start)|(show)|(from)|(in))$/i,
          matchedString: "filler",
          _ranking: 0.9
        },
    */
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    oModel.tools = oModel.tools.sort(Tools.cmpTools);
    delete oModel.seenRules;
    return oModel;
}
exports.loadModels = loadModels;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwibG9nZ2VyIiwibG9hZGxvZyIsIklNYXRjaCIsIklucHV0RmlsdGVyUnVsZXMiLCJUb29scyIsImZzIiwicHJvY2VzcyIsIm1vZGVsUGF0aCIsImVudiIsImFkZFN5bm9ueW1zIiwic3lub255bXMiLCJjYXRlZ29yeSIsInN5bm9ueW1Gb3IiLCJtUnVsZXMiLCJzZWVuIiwiZm9yRWFjaCIsInN5biIsIm9SdWxlIiwibWF0Y2hlZFN0cmluZyIsInR5cGUiLCJ3b3JkIiwiX3JhbmtpbmciLCJKU09OIiwic3RyaW5naWZ5IiwiaW5zZXJ0UnVsZUlmTm90UHJlc2VudCIsInJ1bGUiLCJzZWVuUnVsZXMiLCJwdXNoIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJyIiwiZHVwbGljYXRlcyIsImZpbHRlciIsIm9FbnRyeSIsImNtcE1SdWxlIiwibGVuZ3RoIiwibG93ZXJjYXNld29yZCIsInRvTG93ZXJDYXNlIiwibG9hZE1vZGVsRGF0YSIsIm9NZGwiLCJzTW9kZWxOYW1lIiwib01vZGVsIiwic0ZpbGVOYW1lIiwibWRsZGF0YSIsInJlYWRGaWxlU3luYyIsIm9NZGxEYXRhIiwicGFyc2UiLCJ0b29sIiwibmFtZSIsInJlY29yZHMiLCJ3b3JkaW5kZXgiLCJzU3RyaW5nIiwiZXhhY3RtYXRjaCIsImluZGV4T2YiLCJleGFjdE9ubHkiLCJsb2FkTW9kZWwiLCJtZGwiLCJkb21haW5zIiwiZG9tYWluIiwidG9vbHMiLCJjb25zb2xlIiwibG9nIiwiZXhpdCIsInRvb2xoaWRkZW4iLCJPYmplY3QiLCJrZXlzIiwic3N5bmtleSIsImNvbmNhdCIsInNvcnQiLCJzdHJpbmciLCJpbmRleCIsImxvYWRNb2RlbHMiLCJzbWRscyIsIm1kbHMiLCJzZmlsbGVycyIsImZpbGxlcnMiLCJyZSIsImpvaW4iLCJyZWdleHAiLCJSZWdFeHAiLCJjbXBUb29scyIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQ0tBOztBREdBLElBQVlBLFFBQUtDLFFBQU0sT0FBTixDQUFqQjtBQUVBLElBQUlDLFdBQVdGLE1BQU0sT0FBTixDQUFmO0FBRUEsSUFBWUcsU0FBTUYsUUFBTSxpQkFBTixDQUFsQjtBQUdBLElBQU1HLFVBQVVELE9BQU9BLE1BQVAsQ0FBYyxXQUFkLEVBQTJCLEVBQTNCLENBQWhCO0FBRUEsSUFBYUUsU0FBTUosUUFBTSxrQkFBTixDQUFuQjtBQUlBLElBQVlLLG1CQUFnQkwsUUFBTSwyQkFBTixDQUE1QjtBQUVBLElBQVlNLFFBQUtOLFFBQU0sZ0JBQU4sQ0FBakI7QUFFQSxJQUFZTyxLQUFFUCxRQUFNLElBQU4sQ0FBZDtBQUVBLElBQVlRLFVBQU9SLFFBQU0sU0FBTixDQUFuQjtBQUVBLElBQUlTLFlBQVlELFFBQVFFLEdBQVIsQ0FBWSxXQUFaLEtBQTRCLFdBQTVDO0FBcUJDO0FBRUQsU0FBQUMsV0FBQSxDQUFxQkMsUUFBckIsRUFBeUNDLFFBQXpDLEVBQTJEQyxVQUEzRCxFQUErRUMsTUFBL0UsRUFBNEdDLElBQTVHLEVBQWlKO0FBQzdJSixhQUFTSyxPQUFULENBQWlCLFVBQVVDLEdBQVYsRUFBYTtBQUMxQixZQUFJQyxRQUFRO0FBQ1JOLHNCQUFVQSxRQURGO0FBRVJPLDJCQUFlTixVQUZQO0FBR1JPLGtCQUFNLENBSEUsQ0FHRjtBQUhFLGNBSVJDLE1BQU1KLEdBSkU7QUFLUkssc0JBQVU7QUFMRixTQUFaO0FBT0F0QixpQkFBUyxzQkFBc0J1QixLQUFLQyxTQUFMLENBQWVOLEtBQWYsQ0FBL0I7QUFDQU8sK0JBQXVCWCxNQUF2QixFQUErQkksS0FBL0IsRUFBc0NILElBQXRDO0FBQ0gsS0FWRDtBQVdIO0FBRUQsU0FBQVUsc0JBQUEsQ0FBZ0NYLE1BQWhDLEVBQTZEWSxJQUE3RCxFQUNJQyxTQURKLEVBQzhDO0FBQzFDLFFBQUlELEtBQUtOLElBQUwsS0FBYyxDQUFsQixDQUFrQixVQUFsQixFQUE0QztBQUN4Q04sbUJBQU9jLElBQVAsQ0FBWUYsSUFBWjtBQUNBO0FBQ0g7QUFDRCxRQUFLQSxLQUFLTCxJQUFMLEtBQWNRLFNBQWYsSUFBOEJILEtBQUtQLGFBQUwsS0FBdUJVLFNBQXpELEVBQXFFO0FBQ2pFLGNBQU0sSUFBSUMsS0FBSixDQUFVLGlCQUFpQlAsS0FBS0MsU0FBTCxDQUFlRSxJQUFmLEVBQXFCRyxTQUFyQixFQUFnQyxDQUFoQyxDQUEzQixDQUFOO0FBQ0g7QUFDRCxRQUFJRixZQUFZQSxhQUFhLEVBQTdCO0FBQ0EsUUFBSUksSUFBSVIsS0FBS0MsU0FBTCxDQUFlRSxJQUFmLENBQVI7QUFDQSxRQUFJQyxVQUFVSSxDQUFWLENBQUosRUFBa0I7QUFDZC9CLGlCQUFTLG1DQUFtQ3VCLEtBQUtDLFNBQUwsQ0FBZUUsSUFBZixFQUFxQkcsU0FBckIsRUFBZ0MsQ0FBaEMsQ0FBNUM7QUFDQSxZQUFJRyxhQUFhbEIsT0FBT21CLE1BQVAsQ0FBYyxVQUFVQyxNQUFWLEVBQWdCO0FBQzNDLG1CQUFPLENBQUM5QixpQkFBaUIrQixRQUFqQixDQUEwQkQsTUFBMUIsRUFBa0NSLElBQWxDLENBQVI7QUFDSCxTQUZnQixDQUFqQjtBQUdBLFlBQUlNLFdBQVdJLE1BQVgsR0FBb0IsQ0FBeEIsRUFBMkI7QUFDdkI7QUFDSDtBQUNKO0FBQ0RULGNBQVVJLENBQVYsSUFBZUwsSUFBZjtBQUNBQSxTQUFLVyxhQUFMLEdBQXFCWCxLQUFLTCxJQUFMLENBQVVpQixXQUFWLEVBQXJCO0FBQ0EsUUFBSVosS0FBS0wsSUFBTCxLQUFjLEVBQWxCLEVBQXNCO0FBQ2xCckIsaUJBQVMsbUNBQW1DdUIsS0FBS0MsU0FBTCxDQUFlRSxJQUFmLEVBQXFCRyxTQUFyQixFQUFnQyxDQUFoQyxDQUE1QztBQUNBM0IsZ0JBQVEsbUNBQW1DcUIsS0FBS0MsU0FBTCxDQUFlRSxJQUFmLEVBQXFCRyxTQUFyQixFQUFnQyxDQUFoQyxDQUEzQztBQUNBO0FBQ0g7QUFDRGYsV0FBT2MsSUFBUCxDQUFZRixJQUFaO0FBQ0E7QUFDSDtBQUVELFNBQUFhLGFBQUEsQ0FBdUJDLElBQXZCLEVBQXFDQyxVQUFyQyxFQUF5REMsTUFBekQsRUFBd0U7QUFDcEU7QUFDQTtBQUNBLFFBQU1DLFlBQWEsT0FBT25DLFNBQVAsR0FBbUIsR0FBbkIsR0FBeUJpQyxVQUF6QixHQUFzQyxZQUF6RDtBQUNBLFFBQUlHLFVBQVV0QyxHQUFHdUMsWUFBSCxDQUFnQkYsU0FBaEIsRUFBMkIsT0FBM0IsQ0FBZDtBQUNBLFFBQUlHLFdBQVd2QixLQUFLd0IsS0FBTCxDQUFXSCxPQUFYLENBQWY7QUFDQUUsYUFBUzlCLE9BQVQsQ0FBaUIsVUFBVWtCLE1BQVYsRUFBZ0I7QUFDN0IsWUFBSSxDQUFDQSxPQUFPYyxJQUFSLElBQWdCUixLQUFLUSxJQUFMLENBQVVDLElBQTlCLEVBQW9DO0FBQ2hDZixtQkFBT2MsSUFBUCxHQUFjUixLQUFLUSxJQUFMLENBQVVDLElBQXhCO0FBQ0g7QUFDRFAsZUFBT1EsT0FBUCxDQUFldEIsSUFBZixDQUFvQk0sTUFBcEI7QUFFQU0sYUFBS1csU0FBTCxDQUFlbkMsT0FBZixDQUF1QixVQUFVSixRQUFWLEVBQWtCO0FBQ3JDLGdCQUFJc0IsT0FBT3RCLFFBQVAsTUFBcUJpQixTQUF6QixFQUFvQztBQUNoQzdCLHlCQUFTLDhCQUE4QjJDLFNBQTlCLEdBQTBDLDZCQUExQyxHQUEwRS9CLFFBQTFFLEdBQXFGLGVBQXJGLEdBQXVHVyxLQUFLQyxTQUFMLENBQWVVLE1BQWYsQ0FBdkcsR0FBZ0ksRUFBekk7QUFDQTtBQUNIO0FBQ0QsZ0JBQUlBLE9BQU90QixRQUFQLE1BQXFCLEdBQXpCLEVBQThCO0FBQzFCLG9CQUFJd0MsVUFBVWxCLE9BQU90QixRQUFQLENBQWQ7QUFDQVoseUJBQVMsdUJBQXVCWSxRQUF2QixHQUFrQyxNQUFsQyxHQUEyQ3dDLE9BQXBEO0FBQ0Esb0JBQUlsQyxRQUFRO0FBQ0pOLDhCQUFVQSxRQUROO0FBRUpPLG1DQUFlaUMsT0FGWDtBQUdKaEMsMEJBQU0sQ0FIRixDQUdFO0FBSEYsc0JBSUpDLE1BQU0rQixPQUpGO0FBS0o5Qiw4QkFBVTtBQUxOLGlCQUFaO0FBT0Esb0JBQUdrQixLQUFLYSxVQUFMLElBQW1CYixLQUFLYSxVQUFMLENBQWdCQyxPQUFoQixDQUF3QjFDLFFBQXhCLEtBQXFDLENBQTNELEVBQThEO0FBQzFETSwwQkFBTXFDLFNBQU4sR0FBa0IsSUFBbEI7QUFDSDtBQUNEOUIsdUNBQXVCaUIsT0FBTzVCLE1BQTlCLEVBQXFDSSxLQUFyQyxFQUE0Q3dCLE9BQU9mLFNBQW5EO0FBQ0Esb0JBQUltQixTQUFTbkMsUUFBVCxJQUFxQm1DLFNBQVNuQyxRQUFULENBQWtCQyxRQUFsQixDQUF6QixFQUFzRDtBQUNsREYsZ0NBQVlvQyxTQUFTbkMsUUFBVCxDQUFrQkMsUUFBbEIsQ0FBWixFQUF5Q0EsUUFBekMsRUFBbUR3QyxPQUFuRCxFQUE0RFYsT0FBTzVCLE1BQW5FLEVBQTJFNEIsT0FBT2YsU0FBbEY7QUFDSDtBQUNKO0FBQ0osU0F2QkQ7QUF3QkgsS0E5QkQ7QUErQkg7QUFFRCxTQUFBNkIsU0FBQSxDQUFtQmYsVUFBbkIsRUFBdUNDLE1BQXZDLEVBQXNEO0FBQ2xEMUMsYUFBUyxjQUFjeUMsVUFBZCxHQUEyQixPQUFwQztBQUNBLFFBQUlnQixNQUFNbkQsR0FBR3VDLFlBQUgsQ0FBZ0IsT0FBT3JDLFNBQVAsR0FBbUIsR0FBbkIsR0FBeUJpQyxVQUF6QixHQUFzQyxhQUF0RCxFQUFxRSxPQUFyRSxDQUFWO0FBQ0EsUUFBSUQsT0FBT2pCLEtBQUt3QixLQUFMLENBQVdVLEdBQVgsQ0FBWDtBQUVBLFFBQUlmLE9BQU9nQixPQUFQLENBQWVKLE9BQWYsQ0FBdUJkLEtBQUttQixNQUE1QixLQUF1QyxDQUEzQyxFQUE4QztBQUMxQzNELGlCQUFTLHdCQUF3QnVCLEtBQUtDLFNBQUwsQ0FBZWdCLElBQWYsRUFBcUJYLFNBQXJCLEVBQWdDLENBQWhDLENBQWpDO0FBRUEsY0FBTSxJQUFJQyxLQUFKLENBQVUsWUFBWVUsS0FBS21CLE1BQWpCLEdBQTBCLGdDQUExQixHQUE2RGxCLFVBQTdELEdBQTBFLEdBQXBGLENBQU47QUFDSDtBQUNEO0FBQ0FDLFdBQU9rQixLQUFQLENBQWEzQixNQUFiLENBQW9CLFVBQVVDLE1BQVYsRUFBZ0I7QUFDaEMsWUFBSUEsT0FBT2UsSUFBUCxNQUFpQlQsS0FBS1EsSUFBTCxJQUFhUixLQUFLUSxJQUFMLENBQVVDLElBQXhDLENBQUosRUFBbUQ7QUFDL0NZLG9CQUFRQyxHQUFSLENBQVksVUFBVXRCLEtBQUtRLElBQUwsQ0FBVUMsSUFBcEIsR0FBMkIsZ0NBQTNCLEdBQThEUixVQUExRTtBQUNBO0FBQ0FsQyxvQkFBUXdELElBQVIsQ0FBYSxDQUFDLENBQWQ7QUFDSDtBQUNKLEtBTkQ7QUFPQTtBQUNBLFFBQUksQ0FBQ3ZCLEtBQUt3QixVQUFOLElBQW9CeEIsS0FBS1EsSUFBekIsSUFBaUNSLEtBQUtRLElBQUwsQ0FBVUMsSUFBL0MsRUFBcUQ7QUFDakR4QiwrQkFBdUJpQixPQUFPNUIsTUFBOUIsRUFBc0M7QUFDbENGLHNCQUFVLE1BRHdCO0FBRWxDTywyQkFBZXFCLEtBQUtRLElBQUwsQ0FBVUMsSUFGUztBQUdsQzdCLGtCQUFNLENBSDRCLENBRzVCO0FBSDRCLGNBSWxDQyxNQUFNbUIsS0FBS1EsSUFBTCxDQUFVQyxJQUprQjtBQUtsQzNCLHNCQUFVO0FBTHdCLFNBQXRDLEVBTUdvQixPQUFPZixTQU5WO0FBT0g7QUFBQTtBQUNELFFBQUlhLEtBQUs3QixRQUFMLElBQWlCNkIsS0FBSzdCLFFBQUwsQ0FBYyxNQUFkLENBQXJCLEVBQTRDO0FBQ3hDRCxvQkFBWThCLEtBQUs3QixRQUFMLENBQWMsTUFBZCxDQUFaLEVBQW1DLE1BQW5DLEVBQTJDNkIsS0FBS1EsSUFBTCxDQUFVQyxJQUFyRCxFQUEyRFAsT0FBTzVCLE1BQWxFLEVBQTBFNEIsT0FBT2YsU0FBakY7QUFDSDtBQUFBO0FBQ0QsUUFBSWEsS0FBSzdCLFFBQVQsRUFBbUI7QUFDZnNELGVBQU9DLElBQVAsQ0FBWTFCLEtBQUs3QixRQUFqQixFQUEyQkssT0FBM0IsQ0FBbUMsVUFBVW1ELE9BQVYsRUFBaUI7QUFDaEQsZ0JBQUkzQixLQUFLNUIsUUFBTCxDQUFjMEMsT0FBZCxDQUFzQmEsT0FBdEIsS0FBa0MsQ0FBbEMsSUFBdUNBLFlBQVksTUFBdkQsRUFBK0Q7QUFDM0R6RCw0QkFBWThCLEtBQUs3QixRQUFMLENBQWN3RCxPQUFkLENBQVosRUFBb0MsVUFBcEMsRUFBZ0RBLE9BQWhELEVBQXlEekIsT0FBTzVCLE1BQWhFLEVBQXdFNEIsT0FBT2YsU0FBL0U7QUFDSDtBQUNKLFNBSkQ7QUFLSDtBQUNEZSxXQUFPZ0IsT0FBUCxDQUFlOUIsSUFBZixDQUFvQlksS0FBS21CLE1BQXpCO0FBQ0EsUUFBR25CLEtBQUtRLElBQUwsQ0FBVUMsSUFBYixFQUFtQjtBQUNqQlAsZUFBT2tCLEtBQVAsQ0FBYWhDLElBQWIsQ0FBa0JZLEtBQUtRLElBQXZCO0FBQ0Q7QUFDRE4sV0FBTzlCLFFBQVAsR0FBa0I4QixPQUFPOUIsUUFBUCxDQUFnQndELE1BQWhCLENBQXVCNUIsS0FBSzVCLFFBQTVCLENBQWxCO0FBQ0E4QixXQUFPOUIsUUFBUCxDQUFnQnlELElBQWhCO0FBQ0EzQixXQUFPOUIsUUFBUCxHQUFrQjhCLE9BQU85QixRQUFQLENBQWdCcUIsTUFBaEIsQ0FBdUIsVUFBVXFDLE1BQVYsRUFBa0JDLEtBQWxCLEVBQXVCO0FBQzVELGVBQU83QixPQUFPOUIsUUFBUCxDQUFnQjJELEtBQWhCLE1BQTJCN0IsT0FBTzlCLFFBQVAsQ0FBZ0IyRCxRQUFRLENBQXhCLENBQWxDO0FBQ0gsS0FGaUIsQ0FBbEI7QUFHQWhDLGtCQUFjQyxJQUFkLEVBQW9CQyxVQUFwQixFQUFnQ0MsTUFBaEM7QUFDSCxDLENBQUM7QUFHRixTQUFBOEIsVUFBQSxHQUFBO0FBQ0ksUUFBSTlCLE1BQUo7QUFDQUEsYUFBUztBQUNMZ0IsaUJBQVMsRUFESjtBQUVMRSxlQUFPLEVBRkY7QUFHTGhELGtCQUFVLEVBSEw7QUFJTEUsZ0JBQVEsRUFKSDtBQUtMb0MsaUJBQVM7QUFMSixLQUFUO0FBT0EsUUFBSXVCLFFBQVFuRSxHQUFHdUMsWUFBSCxDQUFnQixPQUFPckMsU0FBUCxHQUFtQixjQUFuQyxFQUFtRCxPQUFuRCxDQUFaO0FBQ0EsUUFBSWtFLE9BQU9uRCxLQUFLd0IsS0FBTCxDQUFXLEtBQUswQixLQUFoQixDQUFYO0FBQ0FDLFNBQUsxRCxPQUFMLENBQWEsVUFBVXlCLFVBQVYsRUFBb0I7QUFDN0JlLGtCQUFVZixVQUFWLEVBQXNCQyxNQUF0QjtBQUNILEtBRkQ7QUFJQTtBQUNBQSxXQUFPOUIsUUFBUCxDQUFnQkksT0FBaEIsQ0FBd0IsVUFBVUosUUFBVixFQUFrQjtBQUN0Q2EsK0JBQXVCaUIsT0FBTzVCLE1BQTlCLEVBQXNDO0FBQ2xDRixzQkFBVSxVQUR3QjtBQUVsQ08sMkJBQWVQLFFBRm1CO0FBR2xDUSxrQkFBTSxDQUg0QixDQUc1QjtBQUg0QixjQUlsQ0MsTUFBTVQsUUFKNEI7QUFLbEN5QiwyQkFBZXpCLFNBQVMwQixXQUFULEVBTG1CO0FBTWxDaEIsc0JBQVU7QUFOd0IsU0FBdEMsRUFPR29CLE9BQU9mLFNBUFY7QUFRSCxLQVREO0FBV0E7QUFDQSxRQUFJZ0QsV0FBV3JFLEdBQUd1QyxZQUFILENBQWdCLE9BQU9yQyxTQUFQLEdBQW1CLGNBQW5DLEVBQW1ELE9BQW5ELENBQWY7QUFDQSxRQUFJb0UsVUFBVXJELEtBQUt3QixLQUFMLENBQVc0QixRQUFYLENBQWQ7QUFDQSxRQUFJRSxLQUFLLFFBQVFELFFBQVFFLElBQVIsQ0FBYSxLQUFiLENBQVIsR0FBOEIsS0FBdkM7QUFDQXBDLFdBQU81QixNQUFQLENBQWNjLElBQWQsQ0FBbUI7QUFDZmhCLGtCQUFVLFFBREs7QUFFZlEsY0FBTSxDQUZTLENBRVQ7QUFGUyxVQUdmMkQsUUFBUSxJQUFJQyxNQUFKLENBQVdILEVBQVgsRUFBZSxHQUFmLENBSE87QUFJZjFELHVCQUFlLFFBSkE7QUFLZkcsa0JBQVU7QUFMSyxLQUFuQjtBQU9BOzs7Ozs7Ozs7O0FBVUFvQixXQUFPNUIsTUFBUCxHQUFnQjRCLE9BQU81QixNQUFQLENBQWN1RCxJQUFkLENBQW1CakUsaUJBQWlCK0IsUUFBcEMsQ0FBaEI7QUFDQU8sV0FBT2tCLEtBQVAsR0FBZWxCLE9BQU9rQixLQUFQLENBQWFTLElBQWIsQ0FBa0JoRSxNQUFNNEUsUUFBeEIsQ0FBZjtBQUNBLFdBQU92QyxPQUFPZixTQUFkO0FBQ0EsV0FBT2UsTUFBUDtBQUNIO0FBcERld0MsUUFBQVYsVUFBQSxHQUFVQSxVQUFWIiwiZmlsZSI6Im1vZGVsL21vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEZ1bmN0aW9uYWxpdHkgbWFuYWdpbmcgdGhlIG1hdGNoIG1vZGVsc1xyXG4gKlxyXG4gKiBAZmlsZVxyXG4gKi9cclxuXHJcbmltcG9ydCAqIGFzIGludGYgZnJvbSAnY29uc3RhbnRzJztcclxuXHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcclxuXHJcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdtb2RlbCcpO1xyXG5cclxuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XHJcblxyXG5cclxuY29uc3QgbG9hZGxvZyA9IGxvZ2dlci5sb2dnZXIoJ21vZGVsbG9hZCcsICcnKTtcclxuXHJcbmltcG9ydCAqICBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XHJcblxyXG5pbXBvcnQgKiBhcyBNYXRjaCBmcm9tICcuLi9tYXRjaC9tYXRjaCc7XHJcblxyXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlclJ1bGVzIGZyb20gJy4uL21hdGNoL2lucHV0RmlsdGVyUnVsZXMnO1xyXG5cclxuaW1wb3J0ICogYXMgVG9vbHMgZnJvbSAnLi4vbWF0Y2gvdG9vbHMnO1xyXG5cclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5cclxuaW1wb3J0ICogYXMgcHJvY2VzcyBmcm9tICdwcm9jZXNzJztcclxuXHJcbnZhciBtb2RlbFBhdGggPSBwcm9jZXNzLmVudltcIk1PREVMUEFUSFwiXSB8fCBcInRlc3Rtb2RlbFwiO1xyXG5cclxuXHJcbmludGVyZmFjZSBJTW9kZWxzIHtcclxuICAgIGRvbWFpbnM6IHN0cmluZ1tdLFxyXG4gICAgdG9vbHM6IElNYXRjaC5JVG9vbFtdLFxyXG4gICAgY2F0ZWdvcnk6IHN0cmluZ1tdLFxyXG4gICAgbVJ1bGVzOiBJTWF0Y2gubVJ1bGVbXSxcclxuICAgIHJlY29yZHM6IGFueVtdXHJcbiAgICBzZWVuUnVsZXM/OiB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5tUnVsZSB9XHJcbn1cclxuXHJcbmludGVyZmFjZSBJTW9kZWwge1xyXG4gICAgZG9tYWluOiBzdHJpbmcsXHJcbiAgICB0b29sOiBJTWF0Y2guSVRvb2wsXHJcbiAgICB0b29saGlkZGVuPzogYm9vbGVhbixcclxuICAgIHN5bm9ueW1zPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmdbXSB9LFxyXG4gICAgY2F0ZWdvcnk6IHN0cmluZ1tdLFxyXG4gICAgd29yZGluZGV4OiBzdHJpbmdbXSxcclxuICAgIGV4YWN0bWF0Y2g/IDogc3RyaW5nW10sXHJcbiAgICBoaWRkZW46IHN0cmluZ1tdXHJcbn07XHJcblxyXG5mdW5jdGlvbiBhZGRTeW5vbnltcyhzeW5vbnltczogc3RyaW5nW10sIGNhdGVnb3J5OiBzdHJpbmcsIHN5bm9ueW1Gb3I6IHN0cmluZywgbVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCBzZWVuOiB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5tUnVsZSB9KSB7XHJcbiAgICBzeW5vbnltcy5mb3JFYWNoKGZ1bmN0aW9uIChzeW4pIHtcclxuICAgICAgICB2YXIgb1J1bGUgPSB7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc3lub255bUZvcixcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBzeW4sXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfTtcclxuICAgICAgICBkZWJ1Z2xvZyhcImluc2VydGluZyBzeW5vbnltXCIgKyBKU09OLnN0cmluZ2lmeShvUnVsZSkpO1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQobVJ1bGVzLCBvUnVsZSwgc2Vlbik7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4sIHJ1bGU6IElNYXRjaC5tUnVsZSxcclxuICAgIHNlZW5SdWxlczogeyBba2V5OiBzdHJpbmddOiBJTWF0Y2gubVJ1bGUgfSkge1xyXG4gICAgaWYgKHJ1bGUudHlwZSAhPT0gSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JEKSB7XHJcbiAgICAgICAgbVJ1bGVzLnB1c2gocnVsZSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKChydWxlLndvcmQgPT09IHVuZGVmaW5lZCkgfHwgKHJ1bGUubWF0Y2hlZFN0cmluZyA9PT0gdW5kZWZpbmVkKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgfVxyXG4gICAgdmFyIHNlZW5SdWxlcyA9IHNlZW5SdWxlcyB8fCB7fTtcclxuICAgIHZhciByID0gSlNPTi5zdHJpbmdpZnkocnVsZSk7XHJcbiAgICBpZiAoc2VlblJ1bGVzW3JdKSB7XHJcbiAgICAgICAgZGVidWdsb2coXCJBdHRlbXB0aW5nIHRvIGluc2VydCBkdXBsaWNhdGVcIiArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgICAgIHZhciBkdXBsaWNhdGVzID0gbVJ1bGVzLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiAhSW5wdXRGaWx0ZXJSdWxlcy5jbXBNUnVsZShvRW50cnksIHJ1bGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChkdXBsaWNhdGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHNlZW5SdWxlc1tyXSA9IHJ1bGU7XHJcbiAgICBydWxlLmxvd2VyY2FzZXdvcmQgPSBydWxlLndvcmQudG9Mb3dlckNhc2UoKTtcclxuICAgIGlmIChydWxlLndvcmQgPT09IFwiXCIpIHtcclxuICAgICAgICBkZWJ1Z2xvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgICAgIGxvYWRsb2coJ1NraXBwaW5nIHJ1bGUgd2l0aCBlbXRweSB3b3JkICcgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBtUnVsZXMucHVzaChydWxlKTtcclxuICAgIHJldHVybjtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZE1vZGVsRGF0YShvTWRsOiBJTW9kZWwsIHNNb2RlbE5hbWU6IHN0cmluZywgb01vZGVsOiBJTW9kZWxzKSB7XHJcbiAgICAvLyByZWFkIHRoZSBkYXRhIC0+XHJcbiAgICAvLyBkYXRhIGlzIHByb2Nlc3NlZCBpbnRvIG1SdWxlcyBkaXJlY3RseSxcclxuICAgIGNvbnN0IHNGaWxlTmFtZSA9ICgnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLmRhdGEuanNvblwiKTtcclxuICAgIHZhciBtZGxkYXRhID0gZnMucmVhZEZpbGVTeW5jKHNGaWxlTmFtZSwgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgb01kbERhdGEgPSBKU09OLnBhcnNlKG1kbGRhdGEpO1xyXG4gICAgb01kbERhdGEuZm9yRWFjaChmdW5jdGlvbiAob0VudHJ5KSB7XHJcbiAgICAgICAgaWYgKCFvRW50cnkudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkge1xyXG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvTW9kZWwucmVjb3Jkcy5wdXNoKG9FbnRyeSk7XHJcblxyXG4gICAgICAgIG9NZGwud29yZGluZGV4LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5KSB7XHJcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwiSU5DT05TSVNURU5UKj4gTW9kZWxEYXRhIFwiICsgc0ZpbGVOYW1lICsgXCIgZG9lcyBub3QgY29udGFpbiBjYXRlZ29yeSBcIiArIGNhdGVnb3J5ICsgXCIgb2Ygd29yZGluZGV4XCIgKyBKU09OLnN0cmluZ2lmeShvRW50cnkpICsgXCJcIilcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAob0VudHJ5W2NhdGVnb3J5XSAhPT0gXCIqXCIpIHtcclxuICAgICAgICAgICAgICAgIHZhciBzU3RyaW5nID0gb0VudHJ5W2NhdGVnb3J5XTtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwicHVzaGluZyBydWxlIHdpdGggXCIgKyBjYXRlZ29yeSArIFwiIC0+IFwiICsgc1N0cmluZyk7XHJcbiAgICAgICAgICAgICAgICB2YXIgb1J1bGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc1N0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JkOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgICAgICAgICAgICAgIH0gYXMgSU1hdGNoLm1SdWxlO1xyXG4gICAgICAgICAgICAgICAgaWYob01kbC5leGFjdG1hdGNoICYmIG9NZGwuZXhhY3RtYXRjaC5pbmRleE9mKGNhdGVnb3J5KSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb1J1bGUuZXhhY3RPbmx5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcyxvUnVsZSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgICAgICBpZiAob01kbERhdGEuc3lub255bXMgJiYgb01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkTW9kZWwoc01vZGVsTmFtZTogc3RyaW5nLCBvTW9kZWw6IElNb2RlbHMpIHtcclxuICAgIGRlYnVnbG9nKFwiIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lICsgXCIgLi4uLlwiKTtcclxuICAgIHZhciBtZGwgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5tb2RlbC5qc29uXCIsICd1dGYtOCcpO1xyXG4gICAgdmFyIG9NZGwgPSBKU09OLnBhcnNlKG1kbCkgYXMgSU1vZGVsO1xyXG5cclxuICAgIGlmIChvTW9kZWwuZG9tYWlucy5pbmRleE9mKG9NZGwuZG9tYWluKSA+PSAwKSB7XHJcbiAgICAgICAgZGVidWdsb2coXCIqKioqKioqKioqKmhlcmUgbWRsXCIgKyBKU09OLnN0cmluZ2lmeShvTWRsLCB1bmRlZmluZWQsIDIpKTtcclxuXHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb21haW4gJyArIG9NZGwuZG9tYWluICsgJyBhbHJlYWR5IGxvYWRlZCB3aGlsZSBsb2FkaW5nICcgKyBzTW9kZWxOYW1lICsgJz8nKTtcclxuICAgIH1cclxuICAgIC8vIGV4dHJhY3QgdG9vbHMgYW4gYWRkIHRvIHRvb2xzOlxyXG4gICAgb01vZGVsLnRvb2xzLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XHJcbiAgICAgICAgaWYgKG9FbnRyeS5uYW1lID09PSAob01kbC50b29sICYmIG9NZGwudG9vbC5uYW1lKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRvb2wgXCIgKyBvTWRsLnRvb2wubmFtZSArIFwiIGFscmVhZHkgcHJlc2VudCB3aGVuIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lKTtcclxuICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiBhbHJlYWR5IGxvYWRlZD8nKTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8vIGFkZCB0aGUgdG9vbCBuYW1lIGFzIHJ1bGUgdW5sZXNzIGhpZGRlblxyXG4gICAgaWYgKCFvTWRsLnRvb2xoaWRkZW4gJiYgb01kbC50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XHJcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcInRvb2xcIixcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogb01kbC50b29sLm5hbWUsXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogb01kbC50b29sLm5hbWUsXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICB9O1xyXG4gICAgaWYgKG9NZGwuc3lub255bXMgJiYgb01kbC5zeW5vbnltc1tcInRvb2xcIl0pIHtcclxuICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW1widG9vbFwiXSwgXCJ0b29sXCIsIG9NZGwudG9vbC5uYW1lLCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgIH07XHJcbiAgICBpZiAob01kbC5zeW5vbnltcykge1xyXG4gICAgICAgIE9iamVjdC5rZXlzKG9NZGwuc3lub255bXMpLmZvckVhY2goZnVuY3Rpb24gKHNzeW5rZXkpIHtcclxuICAgICAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzc3lua2V5KSA+PSAwICYmIHNzeW5rZXkgIT09IFwidG9vbFwiKSB7XHJcbiAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW3NzeW5rZXldLCBcImNhdGVnb3J5XCIsIHNzeW5rZXksIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBvTW9kZWwuZG9tYWlucy5wdXNoKG9NZGwuZG9tYWluKTtcclxuICAgIGlmKG9NZGwudG9vbC5uYW1lKSB7XHJcbiAgICAgIG9Nb2RlbC50b29scy5wdXNoKG9NZGwudG9vbCk7XHJcbiAgICB9XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuY29uY2F0KG9NZGwuY2F0ZWdvcnkpO1xyXG4gICAgb01vZGVsLmNhdGVnb3J5LnNvcnQoKTtcclxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5maWx0ZXIoZnVuY3Rpb24gKHN0cmluZywgaW5kZXgpIHtcclxuICAgICAgICByZXR1cm4gb01vZGVsLmNhdGVnb3J5W2luZGV4XSAhPT0gb01vZGVsLmNhdGVnb3J5W2luZGV4ICsgMV07XHJcbiAgICB9KTtcclxuICAgIGxvYWRNb2RlbERhdGEob01kbCwgc01vZGVsTmFtZSwgb01vZGVsKTtcclxufSAvLyBsb2FkbW9kZWxcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbG9hZE1vZGVscygpIHtcclxuICAgIHZhciBvTW9kZWw6IElNb2RlbHM7XHJcbiAgICBvTW9kZWwgPSB7XHJcbiAgICAgICAgZG9tYWluczogW10sXHJcbiAgICAgICAgdG9vbHM6IFtdLFxyXG4gICAgICAgIGNhdGVnb3J5OiBbXSxcclxuICAgICAgICBtUnVsZXM6IFtdLFxyXG4gICAgICAgIHJlY29yZHM6IFtdXHJcbiAgICB9XHJcbiAgICB2YXIgc21kbHMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvbW9kZWxzLmpzb24nLCAndXRmLTgnKTtcclxuICAgIHZhciBtZGxzID0gSlNPTi5wYXJzZShcIlwiICsgc21kbHMpO1xyXG4gICAgbWRscy5mb3JFYWNoKGZ1bmN0aW9uIChzTW9kZWxOYW1lKSB7XHJcbiAgICAgICAgbG9hZE1vZGVsKHNNb2RlbE5hbWUsIG9Nb2RlbClcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGFkZCB0aGUgY2F0ZWdvcmllcyB0byB0aGUgbW9kZWw6XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiY2F0ZWdvcnlcIixcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IGNhdGVnb3J5LnRvTG93ZXJDYXNlKCksXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvL2FkZCBhIGZpbGxlciBydWxlXHJcbiAgICB2YXIgc2ZpbGxlcnMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvZmlsbGVyLmpzb24nLCAndXRmLTgnKTtcclxuICAgIHZhciBmaWxsZXJzID0gSlNPTi5wYXJzZShzZmlsbGVycyk7XHJcbiAgICB2YXIgcmUgPSBcIl4oKFwiICsgZmlsbGVycy5qb2luKFwiKXwoXCIpICsgXCIpKSRcIjtcclxuICAgIG9Nb2RlbC5tUnVsZXMucHVzaCh7XHJcbiAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXHJcbiAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5SRUdFWFAsXHJcbiAgICAgICAgcmVnZXhwOiBuZXcgUmVnRXhwKHJlLCBcImlcIiksXHJcbiAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJmaWxsZXJcIixcclxuICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICB9KTtcclxuICAgIC8qXHJcbiAgICAgICAgfSlcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXHJcbiAgICAgICAgICB0eXBlOiAxLFxyXG4gICAgICAgICAgcmVnZXhwOiAvXigoc3RhcnQpfChzaG93KXwoZnJvbSl8KGluKSkkL2ksXHJcbiAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxyXG4gICAgICAgICAgX3Jhbmtpbmc6IDAuOVxyXG4gICAgICAgIH0sXHJcbiAgICAqL1xyXG4gICAgb01vZGVsLm1SdWxlcyA9IG9Nb2RlbC5tUnVsZXMuc29ydChJbnB1dEZpbHRlclJ1bGVzLmNtcE1SdWxlKTtcclxuICAgIG9Nb2RlbC50b29scyA9IG9Nb2RlbC50b29scy5zb3J0KFRvb2xzLmNtcFRvb2xzKTtcclxuICAgIGRlbGV0ZSBvTW9kZWwuc2VlblJ1bGVzO1xyXG4gICAgcmV0dXJuIG9Nb2RlbDtcclxufVxyXG5cclxuXHJcbiIsIi8qKlxuICogRnVuY3Rpb25hbGl0eSBtYW5hZ2luZyB0aGUgbWF0Y2ggbW9kZWxzXG4gKlxuICogQGZpbGVcbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vZGVsJyk7XG52YXIgbG9nZ2VyID0gcmVxdWlyZSgnLi4vdXRpbHMvbG9nZ2VyJyk7XG52YXIgbG9hZGxvZyA9IGxvZ2dlci5sb2dnZXIoJ21vZGVsbG9hZCcsICcnKTtcbnZhciBJTWF0Y2ggPSByZXF1aXJlKCcuLi9tYXRjaC9pZm1hdGNoJyk7XG52YXIgSW5wdXRGaWx0ZXJSdWxlcyA9IHJlcXVpcmUoJy4uL21hdGNoL2lucHV0RmlsdGVyUnVsZXMnKTtcbnZhciBUb29scyA9IHJlcXVpcmUoJy4uL21hdGNoL3Rvb2xzJyk7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIHByb2Nlc3MgPSByZXF1aXJlKCdwcm9jZXNzJyk7XG52YXIgbW9kZWxQYXRoID0gcHJvY2Vzcy5lbnZbXCJNT0RFTFBBVEhcIl0gfHwgXCJ0ZXN0bW9kZWxcIjtcbjtcbmZ1bmN0aW9uIGFkZFN5bm9ueW1zKHN5bm9ueW1zLCBjYXRlZ29yeSwgc3lub255bUZvciwgbVJ1bGVzLCBzZWVuKSB7XG4gICAgc3lub255bXMuZm9yRWFjaChmdW5jdGlvbiAoc3luKSB7XG4gICAgICAgIHZhciBvUnVsZSA9IHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHN5bm9ueW1Gb3IsXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBzeW4sXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICB9O1xuICAgICAgICBkZWJ1Z2xvZyhcImluc2VydGluZyBzeW5vbnltXCIgKyBKU09OLnN0cmluZ2lmeShvUnVsZSkpO1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgb1J1bGUsIHNlZW4pO1xuICAgIH0pO1xufVxuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcykge1xuICAgIGlmIChydWxlLnR5cGUgIT09IDAgLyogV09SRCAqLykge1xuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICB2YXIgc2VlblJ1bGVzID0gc2VlblJ1bGVzIHx8IHt9O1xuICAgIHZhciByID0gSlNPTi5zdHJpbmdpZnkocnVsZSk7XG4gICAgaWYgKHNlZW5SdWxlc1tyXSkge1xuICAgICAgICBkZWJ1Z2xvZyhcIkF0dGVtcHRpbmcgdG8gaW5zZXJ0IGR1cGxpY2F0ZVwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHZhciBkdXBsaWNhdGVzID0gbVJ1bGVzLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgICAgICByZXR1cm4gIUlucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUob0VudHJ5LCBydWxlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChkdXBsaWNhdGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBzZWVuUnVsZXNbcl0gPSBydWxlO1xuICAgIHJ1bGUubG93ZXJjYXNld29yZCA9IHJ1bGUud29yZC50b0xvd2VyQ2FzZSgpO1xuICAgIGlmIChydWxlLndvcmQgPT09IFwiXCIpIHtcbiAgICAgICAgZGVidWdsb2coJ1NraXBwaW5nIHJ1bGUgd2l0aCBlbXRweSB3b3JkICcgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgbG9hZGxvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xuICAgIHJldHVybjtcbn1cbmZ1bmN0aW9uIGxvYWRNb2RlbERhdGEob01kbCwgc01vZGVsTmFtZSwgb01vZGVsKSB7XG4gICAgLy8gcmVhZCB0aGUgZGF0YSAtPlxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxuICAgIHZhciBzRmlsZU5hbWUgPSAoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5kYXRhLmpzb25cIik7XG4gICAgdmFyIG1kbGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoc0ZpbGVOYW1lLCAndXRmLTgnKTtcbiAgICB2YXIgb01kbERhdGEgPSBKU09OLnBhcnNlKG1kbGRhdGEpO1xuICAgIG9NZGxEYXRhLmZvckVhY2goZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICBpZiAoIW9FbnRyeS50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xuICAgICAgICB9XG4gICAgICAgIG9Nb2RlbC5yZWNvcmRzLnB1c2gob0VudHJ5KTtcbiAgICAgICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIklOQ09OU0lTVEVOVCo+IE1vZGVsRGF0YSBcIiArIHNGaWxlTmFtZSArIFwiIGRvZXMgbm90IGNvbnRhaW4gY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIG9mIHdvcmRpbmRleFwiICsgSlNPTi5zdHJpbmdpZnkob0VudHJ5KSArIFwiXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xuICAgICAgICAgICAgICAgIHZhciBzU3RyaW5nID0gb0VudHJ5W2NhdGVnb3J5XTtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcInB1c2hpbmcgcnVsZSB3aXRoIFwiICsgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xuICAgICAgICAgICAgICAgIHZhciBvUnVsZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICAgICAgICAgIHdvcmQ6IHNTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAob01kbC5leGFjdG1hdGNoICYmIG9NZGwuZXhhY3RtYXRjaC5pbmRleE9mKGNhdGVnb3J5KSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9SdWxlLmV4YWN0T25seSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywgb1J1bGUsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgICAgIGlmIChvTWRsRGF0YS5zeW5vbnltcyAmJiBvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0pIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn1cbmZ1bmN0aW9uIGxvYWRNb2RlbChzTW9kZWxOYW1lLCBvTW9kZWwpIHtcbiAgICBkZWJ1Z2xvZyhcIiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSArIFwiIC4uLi5cIik7XG4gICAgdmFyIG1kbCA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLm1vZGVsLmpzb25cIiwgJ3V0Zi04Jyk7XG4gICAgdmFyIG9NZGwgPSBKU09OLnBhcnNlKG1kbCk7XG4gICAgaWYgKG9Nb2RlbC5kb21haW5zLmluZGV4T2Yob01kbC5kb21haW4pID49IDApIHtcbiAgICAgICAgZGVidWdsb2coXCIqKioqKioqKioqKmhlcmUgbWRsXCIgKyBKU09OLnN0cmluZ2lmeShvTWRsLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb21haW4gJyArIG9NZGwuZG9tYWluICsgJyBhbHJlYWR5IGxvYWRlZCB3aGlsZSBsb2FkaW5nICcgKyBzTW9kZWxOYW1lICsgJz8nKTtcbiAgICB9XG4gICAgLy8gZXh0cmFjdCB0b29scyBhbiBhZGQgdG8gdG9vbHM6XG4gICAgb01vZGVsLnRvb2xzLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgIGlmIChvRW50cnkubmFtZSA9PT0gKG9NZGwudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVG9vbCBcIiArIG9NZGwudG9vbC5uYW1lICsgXCIgYWxyZWFkeSBwcmVzZW50IHdoZW4gbG9hZGluZyBcIiArIHNNb2RlbE5hbWUpO1xuICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiBhbHJlYWR5IGxvYWRlZD8nKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICAvLyBhZGQgdGhlIHRvb2wgbmFtZSBhcyBydWxlIHVubGVzcyBoaWRkZW5cbiAgICBpZiAoIW9NZGwudG9vbGhpZGRlbiAmJiBvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpIHtcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XG4gICAgICAgICAgICBjYXRlZ29yeTogXCJ0b29sXCIsXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLnRvb2wubmFtZSxcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIHdvcmQ6IG9NZGwudG9vbC5uYW1lLFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgfVxuICAgIDtcbiAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW1widG9vbFwiXSkge1xuICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW1widG9vbFwiXSwgXCJ0b29sXCIsIG9NZGwudG9vbC5uYW1lLCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICB9XG4gICAgO1xuICAgIGlmIChvTWRsLnN5bm9ueW1zKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKG9NZGwuc3lub255bXMpLmZvckVhY2goZnVuY3Rpb24gKHNzeW5rZXkpIHtcbiAgICAgICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc3N5bmtleSkgPj0gMCAmJiBzc3lua2V5ICE9PSBcInRvb2xcIikge1xuICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbc3N5bmtleV0sIFwiY2F0ZWdvcnlcIiwgc3N5bmtleSwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBvTW9kZWwuZG9tYWlucy5wdXNoKG9NZGwuZG9tYWluKTtcbiAgICBpZiAob01kbC50b29sLm5hbWUpIHtcbiAgICAgICAgb01vZGVsLnRvb2xzLnB1c2gob01kbC50b29sKTtcbiAgICB9XG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmNvbmNhdChvTWRsLmNhdGVnb3J5KTtcbiAgICBvTW9kZWwuY2F0ZWdvcnkuc29ydCgpO1xuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5maWx0ZXIoZnVuY3Rpb24gKHN0cmluZywgaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIG9Nb2RlbC5jYXRlZ29yeVtpbmRleF0gIT09IG9Nb2RlbC5jYXRlZ29yeVtpbmRleCArIDFdO1xuICAgIH0pO1xuICAgIGxvYWRNb2RlbERhdGEob01kbCwgc01vZGVsTmFtZSwgb01vZGVsKTtcbn0gLy8gbG9hZG1vZGVsXG5mdW5jdGlvbiBsb2FkTW9kZWxzKCkge1xuICAgIHZhciBvTW9kZWw7XG4gICAgb01vZGVsID0ge1xuICAgICAgICBkb21haW5zOiBbXSxcbiAgICAgICAgdG9vbHM6IFtdLFxuICAgICAgICBjYXRlZ29yeTogW10sXG4gICAgICAgIG1SdWxlczogW10sXG4gICAgICAgIHJlY29yZHM6IFtdXG4gICAgfTtcbiAgICB2YXIgc21kbHMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvbW9kZWxzLmpzb24nLCAndXRmLTgnKTtcbiAgICB2YXIgbWRscyA9IEpTT04ucGFyc2UoXCJcIiArIHNtZGxzKTtcbiAgICBtZGxzLmZvckVhY2goZnVuY3Rpb24gKHNNb2RlbE5hbWUpIHtcbiAgICAgICAgbG9hZE1vZGVsKHNNb2RlbE5hbWUsIG9Nb2RlbCk7XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcbiAgICBvTW9kZWwuY2F0ZWdvcnkuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IGNhdGVnb3J5LnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICB9KTtcbiAgICAvL2FkZCBhIGZpbGxlciBydWxlXG4gICAgdmFyIHNmaWxsZXJzID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnL2ZpbGxlci5qc29uJywgJ3V0Zi04Jyk7XG4gICAgdmFyIGZpbGxlcnMgPSBKU09OLnBhcnNlKHNmaWxsZXJzKTtcbiAgICB2YXIgcmUgPSBcIl4oKFwiICsgZmlsbGVycy5qb2luKFwiKXwoXCIpICsgXCIpKSRcIjtcbiAgICBvTW9kZWwubVJ1bGVzLnB1c2goe1xuICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcbiAgICAgICAgdHlwZTogMSAvKiBSRUdFWFAgKi8sXG4gICAgICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChyZSwgXCJpXCIpLFxuICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxuICAgICAgICBfcmFua2luZzogMC45XG4gICAgfSk7XG4gICAgLypcbiAgICAgICAgfSlcbiAgICAgICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcbiAgICAgICAgICB0eXBlOiAxLFxuICAgICAgICAgIHJlZ2V4cDogL14oKHN0YXJ0KXwoc2hvdyl8KGZyb20pfChpbikpJC9pLFxuICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXG4gICAgICAgICAgX3Jhbmtpbmc6IDAuOVxuICAgICAgICB9LFxuICAgICovXG4gICAgb01vZGVsLm1SdWxlcyA9IG9Nb2RlbC5tUnVsZXMuc29ydChJbnB1dEZpbHRlclJ1bGVzLmNtcE1SdWxlKTtcbiAgICBvTW9kZWwudG9vbHMgPSBvTW9kZWwudG9vbHMuc29ydChUb29scy5jbXBUb29scyk7XG4gICAgZGVsZXRlIG9Nb2RlbC5zZWVuUnVsZXM7XG4gICAgcmV0dXJuIG9Nb2RlbDtcbn1cbmV4cG9ydHMubG9hZE1vZGVscyA9IGxvYWRNb2RlbHM7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
