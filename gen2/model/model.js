/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require('debug');
var debuglog = debug('model');
var IMatch = require('../match/ifmatch');
var Match = require('../match/match');
var fs = require('fs');
var process = require('process');
;
function addSynonyms(synonyms, category, synonymFor, mRules) {
    synonyms.forEach(function (syn) {
        mRules.push({
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            _ranking: 0.95
        });
    });
}
function loadModelData(oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var mdldata = fs.readFileSync('./sensitive/' + sModelName + ".data.json", 'utf-8');
    var oMdlData = JSON.parse(mdldata);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.tool) {
            oEntry.tool = oMdl.tool.name;
        }
        oMdl.wordindex.forEach(function (category) {
            if (oMdlData[category] !== "*") {
                var sString = oMdlData[category];
                oModel.mRules.push({
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    _ranking: 0.95
                });
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, oModel.mRules);
                }
            }
        });
    });
}
function loadModel(sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var mdl = fs.readFileSync('./sensitive/' + sModelName + ".model.json", 'utf-8');
    var oMdl = JSON.parse(mdl);
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // extract tools an add to tools:
    oModel.tools.filter(function (oEntry) {
        if (oEntry.name === oMdl.tool.name) {
            console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
            //throw new Error('Domain already loaded?');
            process.exit(-1);
        }
    });
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden) {
        oModel.mRules.push({
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            _ranking: 0.95
        });
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oModel.mRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oModel.mRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    oModel.tools.push(oMdl.tool);
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
    loadModelData(oMdl, sModelName, oModel);
} // loadmodel
function loadModels() {
    var oModel;
    oModel = {
        domains: [],
        tools: [],
        category: [],
        mRules: []
    };
    var smdls = fs.readFileSync('./sensitive/models.json', 'utf-8');
    var mdls = JSON.parse("" + smdls);
    mdls.forEach(function (sModelName) {
        loadModel(sModelName, oModel);
    });
    // add the categories to the model:
    oModel.category.forEach(function (category) {
        oModel.mRules.push({
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            _ranking: 0.95
        });
    });
    return oModel;
}
exports.loadModels = loadModels;
function expandParametersInURL(oMergedContextResult) {
    var ptn = oMergedContextResult.result.pattern;
    Object.keys(oMergedContextResult.context).forEach(function (sKey) {
        var regex = new RegExp('{' + sKey + '}', 'g');
        ptn = ptn.replace(regex, oMergedContextResult.context[sKey]);
        ptn = ptn.replace(regex, oMergedContextResult.context[sKey]);
    });
    return ptn;
}
var inputFilterRules = require('../match/inputFilterRules');
var toolExecutors = {
    "xFLP": {},
    "xFLPD": {},
    "unit test": function unitTest(match) {
        var unittest = match.toolmatchresult.required["unit test"].matchedString;
        var url = inputFilterRules.getUnitTestUrl(unittest);
        return {
            text: "starting unit test \"" + unittest + "\"" + (url ? ' with url ' + url : 'no url :-('),
            action: { url: url }
        };
    },
    "wiki": function wiki(match) {
        var wiki = match.toolmatchresult.required["wiki"].matchedString;
        var url = inputFilterRules.getWikiUrl(wiki);
        return {
            text: "starting wiki " + wiki + (url ? ' with url ' + url : 'no url :-('),
            action: { url: url }
        };
    }
};
function execTool(match, bExplain) {
    //
    var exec = undefined;
    if (toolExecutors[match.tool.name]) {
        exec = toolExecutors[match.tool.name](match);
    }
    if (!exec) {
        exec = {
            text: "don't know how to execute " + match.tool.name + '\n'
        };
    }
    if (bExplain) {
        exec.text = exec.text + "\n" + Match.ToolMatch.dumpNice(match);
    }
    return exec;
    // TODO invoke tool specific starter
    /* if (oMergedContextResult.result.type === 'URL') {
      var ptn = expandParametersInURL(oMergedContextResult)
      startBrowser(ptn)
      return ptn
    } else {
      var s = ("Don't know how to start " + oMergedContextResult.result.type + '\n for "' + oMergedContextResult.query + '"')
      debuglog(s)
      return s
    }*/
}
exports.execTool = execTool;
//  executeStartup: executeStartup
//}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwiSU1hdGNoIiwiTWF0Y2giLCJmcyIsInByb2Nlc3MiLCJhZGRTeW5vbnltcyIsInN5bm9ueW1zIiwiY2F0ZWdvcnkiLCJzeW5vbnltRm9yIiwibVJ1bGVzIiwiZm9yRWFjaCIsInN5biIsInB1c2giLCJtYXRjaGVkU3RyaW5nIiwidHlwZSIsIndvcmQiLCJfcmFua2luZyIsImxvYWRNb2RlbERhdGEiLCJvTWRsIiwic01vZGVsTmFtZSIsIm9Nb2RlbCIsIm1kbGRhdGEiLCJyZWFkRmlsZVN5bmMiLCJvTWRsRGF0YSIsIkpTT04iLCJwYXJzZSIsIm9FbnRyeSIsInRvb2wiLCJuYW1lIiwid29yZGluZGV4Iiwic1N0cmluZyIsImxvYWRNb2RlbCIsIm1kbCIsImRvbWFpbnMiLCJpbmRleE9mIiwiZG9tYWluIiwic3RyaW5naWZ5IiwidW5kZWZpbmVkIiwiRXJyb3IiLCJ0b29scyIsImZpbHRlciIsImNvbnNvbGUiLCJsb2ciLCJleGl0IiwidG9vbGhpZGRlbiIsIk9iamVjdCIsImtleXMiLCJzc3lua2V5IiwiY29uY2F0Iiwic29ydCIsInN0cmluZyIsImluZGV4IiwibG9hZE1vZGVscyIsInNtZGxzIiwibWRscyIsImV4cG9ydHMiLCJleHBhbmRQYXJhbWV0ZXJzSW5VUkwiLCJvTWVyZ2VkQ29udGV4dFJlc3VsdCIsInB0biIsInJlc3VsdCIsInBhdHRlcm4iLCJjb250ZXh0Iiwic0tleSIsInJlZ2V4IiwiUmVnRXhwIiwicmVwbGFjZSIsImlucHV0RmlsdGVyUnVsZXMiLCJ0b29sRXhlY3V0b3JzIiwibWF0Y2giLCJ1bml0dGVzdCIsInRvb2xtYXRjaHJlc3VsdCIsInJlcXVpcmVkIiwidXJsIiwiZ2V0VW5pdFRlc3RVcmwiLCJ0ZXh0IiwiYWN0aW9uIiwid2lraSIsImdldFdpa2lVcmwiLCJleGVjVG9vbCIsImJF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R0FBUDtBQUZMLFNBQVA7QUFJSCxLQVZlO0FBV2hCLFlBQVEsY0FBU0osS0FBVCxFQUFpQztBQUNyQyxZQUFJUSxPQUFPUixNQUFNRSxlQUFOLENBQXNCQyxRQUF0QixDQUErQixNQUEvQixFQUF1QzFELGFBQWxEO0FBQ0EsWUFBSTJELE1BQU1OLGlCQUFpQlcsVUFBakIsQ0FBNEJELElBQTVCLENBQVY7QUFDQSxlQUFPO0FBQ0hGLGtCQUFNLG1CQUFtQkUsSUFBbkIsSUFBMkJKLE1BQU8sZUFBZUEsR0FBdEIsR0FBNkIsWUFBeEQsQ0FESDtBQUVIRyxvQkFBUSxFQUFFSCxLQUFLQSxHQUFQO0FBRkwsU0FBUDtBQUlIO0FBbEJlLENBQXBCO0FBcUJBLFNBQUFNLFFBQUEsQ0FBeUJWLEtBQXpCLEVBQW1EVyxRQUFuRCxFQUFxRTtBQUlqRTtBQUNBLFFBQUlDLE9BQU8zQyxTQUFYO0FBQ0EsUUFBSThCLGNBQWNDLE1BQU16QyxJQUFOLENBQVdDLElBQXpCLENBQUosRUFBb0M7QUFDaENvRCxlQUFPYixjQUFjQyxNQUFNekMsSUFBTixDQUFXQyxJQUF6QixFQUErQndDLEtBQS9CLENBQVA7QUFFSDtBQUNELFFBQUksQ0FBQ1ksSUFBTCxFQUFXO0FBQ1BBLGVBQU87QUFDSE4sa0JBQU0sK0JBQStCTixNQUFNekMsSUFBTixDQUFXQyxJQUExQyxHQUFpRDtBQURwRCxTQUFQO0FBR0g7QUFDRCxRQUFJbUQsUUFBSixFQUFjO0FBQ1ZDLGFBQUtOLElBQUwsR0FBWU0sS0FBS04sSUFBTCxHQUFZLElBQVosR0FBbUJ4RSxNQUFNK0UsU0FBTixDQUFnQkMsUUFBaEIsQ0FBeUJkLEtBQXpCLENBQS9CO0FBQ0g7QUFDRCxXQUFPWSxJQUFQO0FBRUE7QUFDQTs7Ozs7Ozs7O0FBU0g7QUE5QmV6QixRQUFBdUIsUUFBQSxHQUFRQSxRQUFSO0FBaUNoQjtBQUNBIiwiZmlsZSI6Im1vZGVsL21vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEZ1bmN0aW9uYWxpdHkgbWFuYWdpbmcgdGhlIG1hdGNoIG1vZGVsc1xyXG4gKlxyXG4gKiBAZmlsZVxyXG4gKi9cclxuXHJcbmltcG9ydCAqIGFzIGludGYgZnJvbSAnY29uc3RhbnRzJztcclxuXHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcclxuXHJcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdtb2RlbCcpO1xyXG5cclxuaW1wb3J0ICogIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuXHJcbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4uL21hdGNoL21hdGNoJztcclxuXHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuXHJcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XHJcblxyXG5pbnRlcmZhY2UgSU1vZGVscyB7XHJcbiAgICBkb21haW5zOiBzdHJpbmdbXSxcclxuICAgIHRvb2xzOiBJTWF0Y2guSVRvb2xbXSxcclxuICAgIGNhdGVnb3J5OiBzdHJpbmdbXSxcclxuICAgIG1SdWxlczogSU1hdGNoLm1SdWxlW11cclxufVxyXG5cclxuXHJcbmludGVyZmFjZSBJTW9kZWwge1xyXG4gICAgZG9tYWluOiBzdHJpbmcsXHJcbiAgICB0b29sOiBJTWF0Y2guSVRvb2wsXHJcbiAgICB0b29saGlkZGVuPzogYm9vbGVhbixcclxuICAgIHN5bm9ueW1zPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmdbXSB9LFxyXG4gICAgY2F0ZWdvcnk6IHN0cmluZ1tdLFxyXG4gICAgd29yZGluZGV4OiBzdHJpbmdbXSxcclxuICAgIGhpZGRlbjogc3RyaW5nW11cclxufTtcclxuXHJcbmZ1bmN0aW9uIGFkZFN5bm9ueW1zKHN5bm9ueW1zOiBzdHJpbmdbXSwgY2F0ZWdvcnk6IHN0cmluZywgc3lub255bUZvcjogc3RyaW5nLCBtUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4pIHtcclxuICAgIHN5bm9ueW1zLmZvckVhY2goZnVuY3Rpb24oc3luKSB7XHJcbiAgICAgICAgbVJ1bGVzLnB1c2goe1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHN5bm9ueW1Gb3IsXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogc3luLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBsb2FkTW9kZWxEYXRhKG9NZGw6IElNb2RlbCwgc01vZGVsTmFtZTogc3RyaW5nLCBvTW9kZWw6IElNb2RlbHMpIHtcclxuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cclxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxyXG4gICAgdmFyIG1kbGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoJy4vc2Vuc2l0aXZlLycgKyBzTW9kZWxOYW1lICsgXCIuZGF0YS5qc29uXCIsICd1dGYtOCcpO1xyXG4gICAgdmFyIG9NZGxEYXRhID0gSlNPTi5wYXJzZShtZGxkYXRhKTtcclxuICAgIG9NZGxEYXRhLmZvckVhY2goZnVuY3Rpb24ob0VudHJ5KSB7XHJcbiAgICAgICAgaWYgKCFvRW50cnkudG9vbCkge1xyXG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICAgICAgICAgIGlmIChvTWRsRGF0YVtjYXRlZ29yeV0gIT09IFwiKlwiKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc1N0cmluZyA9IG9NZGxEYXRhW2NhdGVnb3J5XTtcclxuICAgICAgICAgICAgICAgIG9Nb2RlbC5tUnVsZXMucHVzaChcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc1N0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JkOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9NZGxEYXRhLnN5bm9ueW1zICYmIG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSwgY2F0ZWdvcnksIHNTdHJpbmcsIG9Nb2RlbC5tUnVsZXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZE1vZGVsKHNNb2RlbE5hbWU6IHN0cmluZywgb01vZGVsOiBJTW9kZWxzKSB7XHJcbiAgICBkZWJ1Z2xvZyhcIiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSArIFwiIC4uLi5cIik7XHJcbiAgICB2YXIgbWRsID0gZnMucmVhZEZpbGVTeW5jKCcuL3NlbnNpdGl2ZS8nICsgc01vZGVsTmFtZSArIFwiLm1vZGVsLmpzb25cIiwgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgb01kbCA9IEpTT04ucGFyc2UobWRsKSBhcyBJTW9kZWw7XHJcblxyXG4gICAgaWYgKG9Nb2RlbC5kb21haW5zLmluZGV4T2Yob01kbC5kb21haW4pPj0gMCkge1xyXG4gICAgICAgIGRlYnVnbG9nKFwiKioqKioqKioqKipoZXJlIG1kbFwiICsgSlNPTi5zdHJpbmdpZnkob01kbCx1bmRlZmluZWQsIDIpKTtcclxuXHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb21haW4gJyArIG9NZGwuZG9tYWluICsgJyBhbHJlYWR5IGxvYWRlZCB3aGlsZSBsb2FkaW5nICcgKyBzTW9kZWxOYW1lICsgJz8nKTtcclxuICAgIH1cclxuICAgIC8vIGV4dHJhY3QgdG9vbHMgYW4gYWRkIHRvIHRvb2xzOlxyXG4gICAgb01vZGVsLnRvb2xzLmZpbHRlcihmdW5jdGlvbihvRW50cnkpIHtcclxuICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IG9NZGwudG9vbC5uYW1lKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVG9vbCBcIiArIG9NZGwudG9vbC5uYW1lICsgXCIgYWxyZWFkeSBwcmVzZW50IHdoZW4gbG9hZGluZyBcIiArIHNNb2RlbE5hbWUpO1xyXG4gICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluIGFscmVhZHkgbG9hZGVkPycpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXHJcbiAgICBpZiAoIW9NZGwudG9vbGhpZGRlbikge1xyXG4gICAgICAgIG9Nb2RlbC5tUnVsZXMucHVzaCh7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcInRvb2xcIixcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogb01kbC50b29sLm5hbWUsXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogb01kbC50b29sLm5hbWUsXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgaWYgKG9NZGwuc3lub255bXMgJiYgb01kbC5zeW5vbnltc1tcInRvb2xcIl0pIHtcclxuICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW1widG9vbFwiXSwgXCJ0b29sXCIsIG9NZGwudG9vbC5uYW1lLCBvTW9kZWwubVJ1bGVzKTtcclxuICAgIH07XHJcbiAgICBpZiAob01kbC5zeW5vbnltcykge1xyXG4gICAgICAgIE9iamVjdC5rZXlzKG9NZGwuc3lub255bXMpLmZvckVhY2goZnVuY3Rpb24oc3N5bmtleSkge1xyXG4gICAgICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNzeW5rZXkpID49IDAgJiYgc3N5bmtleSAhPT0gXCJ0b29sXCIpIHtcclxuICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbc3N5bmtleV0sIFwiY2F0ZWdvcnlcIiwgc3N5bmtleSwgb01vZGVsLm1SdWxlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBvTW9kZWwuZG9tYWlucy5wdXNoKG9NZGwuZG9tYWluKTtcclxuICAgIG9Nb2RlbC50b29scy5wdXNoKG9NZGwudG9vbCk7XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuY29uY2F0KG9NZGwuY2F0ZWdvcnkpO1xyXG4gICAgb01vZGVsLmNhdGVnb3J5LnNvcnQoKTtcclxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5maWx0ZXIoZnVuY3Rpb24oc3RyaW5nLCBpbmRleCkge1xyXG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcclxuICAgIH0pO1xyXG4gICAgbG9hZE1vZGVsRGF0YShvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpO1xyXG59IC8vIGxvYWRtb2RlbFxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkTW9kZWxzKCkge1xyXG4gICAgdmFyIG9Nb2RlbDogSU1vZGVscztcclxuICAgIG9Nb2RlbCA9IHtcclxuICAgICAgICBkb21haW5zOiBbXSxcclxuICAgICAgICB0b29sczogW10sXHJcbiAgICAgICAgY2F0ZWdvcnk6IFtdLFxyXG4gICAgICAgIG1SdWxlczogW11cclxuICAgIH1cclxuICAgIHZhciBzbWRscyA9IGZzLnJlYWRGaWxlU3luYygnLi9zZW5zaXRpdmUvbW9kZWxzLmpzb24nLCAndXRmLTgnKTtcclxuICAgIHZhciBtZGxzID0gSlNPTi5wYXJzZShcIlwiICsgc21kbHMpO1xyXG4gICAgbWRscy5mb3JFYWNoKGZ1bmN0aW9uKHNNb2RlbE5hbWUpIHtcclxuICAgICAgICBsb2FkTW9kZWwoc01vZGVsTmFtZSwgb01vZGVsKVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcclxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICAgICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiY2F0ZWdvcnlcIixcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBvTW9kZWw7XHJcbn1cclxuXHJcblxyXG5cclxuZnVuY3Rpb24gZXhwYW5kUGFyYW1ldGVyc0luVVJMKG9NZXJnZWRDb250ZXh0UmVzdWx0KSB7XHJcbiAgICB2YXIgcHRuID0gb01lcmdlZENvbnRleHRSZXN1bHQucmVzdWx0LnBhdHRlcm5cclxuICAgIE9iamVjdC5rZXlzKG9NZXJnZWRDb250ZXh0UmVzdWx0LmNvbnRleHQpLmZvckVhY2goZnVuY3Rpb24oc0tleSkge1xyXG4gICAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAoJ3snICsgc0tleSArICd9JywgJ2cnKVxyXG4gICAgICAgIHB0biA9IHB0bi5yZXBsYWNlKHJlZ2V4LCBvTWVyZ2VkQ29udGV4dFJlc3VsdC5jb250ZXh0W3NLZXldKVxyXG4gICAgICAgIHB0biA9IHB0bi5yZXBsYWNlKHJlZ2V4LCBvTWVyZ2VkQ29udGV4dFJlc3VsdC5jb250ZXh0W3NLZXldKVxyXG4gICAgfSlcclxuICAgIHJldHVybiBwdG5cclxufVxyXG5cclxuXHJcbmltcG9ydCAqIGFzIGlucHV0RmlsdGVyUnVsZXMgZnJvbSAnLi4vbWF0Y2gvaW5wdXRGaWx0ZXJSdWxlcyc7XHJcblxyXG52YXIgdG9vbEV4ZWN1dG9ycyA9IHtcclxuICAgIFwieEZMUFwiOiB7fSxcclxuICAgIFwieEZMUERcIjoge30sXHJcbiAgICBcInVuaXQgdGVzdFwiOiBmdW5jdGlvbihtYXRjaDogSU1hdGNoLklUb29sTWF0Y2gpIHtcclxuICAgICAgICB2YXIgdW5pdHRlc3QgPSBtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbXCJ1bml0IHRlc3RcIl0ubWF0Y2hlZFN0cmluZztcclxuICAgICAgICB2YXIgdXJsID0gaW5wdXRGaWx0ZXJSdWxlcy5nZXRVbml0VGVzdFVybCh1bml0dGVzdCk7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdGV4dDogXCJzdGFydGluZyB1bml0IHRlc3QgXFxcIlwiICsgdW5pdHRlc3QgKyBcIlxcXCJcIiArICh1cmwgPyAoJyB3aXRoIHVybCAnICsgdXJsKSA6ICdubyB1cmwgOi0oJyksXHJcbiAgICAgICAgICAgIGFjdGlvbjogeyB1cmw6IHVybCB9XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIFwid2lraVwiOiBmdW5jdGlvbihtYXRjaDogSU1hdGNoLklUb29sTWF0Y2gpIHtcclxuICAgICAgICB2YXIgd2lraSA9IG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtcIndpa2lcIl0ubWF0Y2hlZFN0cmluZztcclxuICAgICAgICB2YXIgdXJsID0gaW5wdXRGaWx0ZXJSdWxlcy5nZXRXaWtpVXJsKHdpa2kpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRleHQ6IFwic3RhcnRpbmcgd2lraSBcIiArIHdpa2kgKyAodXJsID8gKCcgd2l0aCB1cmwgJyArIHVybCkgOiAnbm8gdXJsIDotKCcpLFxyXG4gICAgICAgICAgICBhY3Rpb246IHsgdXJsOiB1cmwgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBleGVjVG9vbChtYXRjaDogSU1hdGNoLklUb29sTWF0Y2gsIGJFeHBsYWluPzogYm9vbGVhbik6IHtcclxuICAgIHRleHQ6IHN0cmluZyxcclxuICAgIGFjdGlvbjogYW55XHJcbn0ge1xyXG4gICAgLy9cclxuICAgIHZhciBleGVjID0gdW5kZWZpbmVkO1xyXG4gICAgaWYgKHRvb2xFeGVjdXRvcnNbbWF0Y2gudG9vbC5uYW1lXSkge1xyXG4gICAgICAgIGV4ZWMgPSB0b29sRXhlY3V0b3JzW21hdGNoLnRvb2wubmFtZV0obWF0Y2gpO1xyXG5cclxuICAgIH1cclxuICAgIGlmICghZXhlYykge1xyXG4gICAgICAgIGV4ZWMgPSB7XHJcbiAgICAgICAgICAgIHRleHQ6IFwiZG9uJ3Qga25vdyBob3cgdG8gZXhlY3V0ZSBcIiArIG1hdGNoLnRvb2wubmFtZSArICdcXG4nXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKGJFeHBsYWluKSB7XHJcbiAgICAgICAgZXhlYy50ZXh0ID0gZXhlYy50ZXh0ICsgXCJcXG5cIiArIE1hdGNoLlRvb2xNYXRjaC5kdW1wTmljZShtYXRjaCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZXhlYztcclxuXHJcbiAgICAvLyBUT0RPIGludm9rZSB0b29sIHNwZWNpZmljIHN0YXJ0ZXJcclxuICAgIC8qIGlmIChvTWVyZ2VkQ29udGV4dFJlc3VsdC5yZXN1bHQudHlwZSA9PT0gJ1VSTCcpIHtcclxuICAgICAgdmFyIHB0biA9IGV4cGFuZFBhcmFtZXRlcnNJblVSTChvTWVyZ2VkQ29udGV4dFJlc3VsdClcclxuICAgICAgc3RhcnRCcm93c2VyKHB0bilcclxuICAgICAgcmV0dXJuIHB0blxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFyIHMgPSAoXCJEb24ndCBrbm93IGhvdyB0byBzdGFydCBcIiArIG9NZXJnZWRDb250ZXh0UmVzdWx0LnJlc3VsdC50eXBlICsgJ1xcbiBmb3IgXCInICsgb01lcmdlZENvbnRleHRSZXN1bHQucXVlcnkgKyAnXCInKVxyXG4gICAgICBkZWJ1Z2xvZyhzKVxyXG4gICAgICByZXR1cm4gc1xyXG4gICAgfSovXHJcbn1cclxuXHJcblxyXG4vLyAgZXhlY3V0ZVN0YXJ0dXA6IGV4ZWN1dGVTdGFydHVwXHJcbi8vfVxyXG4iLCIvKipcbiAqIEZ1bmN0aW9uYWxpdHkgbWFuYWdpbmcgdGhlIG1hdGNoIG1vZGVsc1xuICpcbiAqIEBmaWxlXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdtb2RlbCcpO1xudmFyIElNYXRjaCA9IHJlcXVpcmUoJy4uL21hdGNoL2lmbWF0Y2gnKTtcbnZhciBNYXRjaCA9IHJlcXVpcmUoJy4uL21hdGNoL21hdGNoJyk7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIHByb2Nlc3MgPSByZXF1aXJlKCdwcm9jZXNzJyk7XG47XG5mdW5jdGlvbiBhZGRTeW5vbnltcyhzeW5vbnltcywgY2F0ZWdvcnksIHN5bm9ueW1Gb3IsIG1SdWxlcykge1xuICAgIHN5bm9ueW1zLmZvckVhY2goZnVuY3Rpb24gKHN5bikge1xuICAgICAgICBtUnVsZXMucHVzaCh7XG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzeW5vbnltRm9yLFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogc3luLFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5mdW5jdGlvbiBsb2FkTW9kZWxEYXRhKG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCkge1xuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cbiAgICAvLyBkYXRhIGlzIHByb2Nlc3NlZCBpbnRvIG1SdWxlcyBkaXJlY3RseSxcbiAgICB2YXIgbWRsZGF0YSA9IGZzLnJlYWRGaWxlU3luYygnLi9zZW5zaXRpdmUvJyArIHNNb2RlbE5hbWUgKyBcIi5kYXRhLmpzb25cIiwgJ3V0Zi04Jyk7XG4gICAgdmFyIG9NZGxEYXRhID0gSlNPTi5wYXJzZShtZGxkYXRhKTtcbiAgICBvTWRsRGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChvRW50cnkpIHtcbiAgICAgICAgaWYgKCFvRW50cnkudG9vbCkge1xuICAgICAgICAgICAgb0VudHJ5LnRvb2wgPSBvTWRsLnRvb2wubmFtZTtcbiAgICAgICAgfVxuICAgICAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICAgICAgaWYgKG9NZGxEYXRhW2NhdGVnb3J5XSAhPT0gXCIqXCIpIHtcbiAgICAgICAgICAgICAgICB2YXIgc1N0cmluZyA9IG9NZGxEYXRhW2NhdGVnb3J5XTtcbiAgICAgICAgICAgICAgICBvTW9kZWwubVJ1bGVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHNTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgICAgICAgICAgd29yZDogc1N0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAob01kbERhdGEuc3lub255bXMgJiYgb01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldKSB7XG4gICAgICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSwgY2F0ZWdvcnksIHNTdHJpbmcsIG9Nb2RlbC5tUnVsZXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5mdW5jdGlvbiBsb2FkTW9kZWwoc01vZGVsTmFtZSwgb01vZGVsKSB7XG4gICAgZGVidWdsb2coXCIgbG9hZGluZyBcIiArIHNNb2RlbE5hbWUgKyBcIiAuLi4uXCIpO1xuICAgIHZhciBtZGwgPSBmcy5yZWFkRmlsZVN5bmMoJy4vc2Vuc2l0aXZlLycgKyBzTW9kZWxOYW1lICsgXCIubW9kZWwuanNvblwiLCAndXRmLTgnKTtcbiAgICB2YXIgb01kbCA9IEpTT04ucGFyc2UobWRsKTtcbiAgICBpZiAob01vZGVsLmRvbWFpbnMuaW5kZXhPZihvTWRsLmRvbWFpbikgPj0gMCkge1xuICAgICAgICBkZWJ1Z2xvZyhcIioqKioqKioqKioqaGVyZSBtZGxcIiArIEpTT04uc3RyaW5naWZ5KG9NZGwsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiAnICsgb01kbC5kb21haW4gKyAnIGFscmVhZHkgbG9hZGVkIHdoaWxlIGxvYWRpbmcgJyArIHNNb2RlbE5hbWUgKyAnPycpO1xuICAgIH1cbiAgICAvLyBleHRyYWN0IHRvb2xzIGFuIGFkZCB0byB0b29sczpcbiAgICBvTW9kZWwudG9vbHMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcbiAgICAgICAgaWYgKG9FbnRyeS5uYW1lID09PSBvTWRsLnRvb2wubmFtZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUb29sIFwiICsgb01kbC50b29sLm5hbWUgKyBcIiBhbHJlYWR5IHByZXNlbnQgd2hlbiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSk7XG4gICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluIGFscmVhZHkgbG9hZGVkPycpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vIGFkZCB0aGUgdG9vbCBuYW1lIGFzIHJ1bGUgdW5sZXNzIGhpZGRlblxuICAgIGlmICghb01kbC50b29saGlkZGVuKSB7XG4gICAgICAgIG9Nb2RlbC5tUnVsZXMucHVzaCh7XG4gICAgICAgICAgICBjYXRlZ29yeTogXCJ0b29sXCIsXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLnRvb2wubmFtZSxcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIHdvcmQ6IG9NZGwudG9vbC5uYW1lLFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIDtcbiAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW1widG9vbFwiXSkge1xuICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW1widG9vbFwiXSwgXCJ0b29sXCIsIG9NZGwudG9vbC5uYW1lLCBvTW9kZWwubVJ1bGVzKTtcbiAgICB9XG4gICAgO1xuICAgIGlmIChvTWRsLnN5bm9ueW1zKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKG9NZGwuc3lub255bXMpLmZvckVhY2goZnVuY3Rpb24gKHNzeW5rZXkpIHtcbiAgICAgICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc3N5bmtleSkgPj0gMCAmJiBzc3lua2V5ICE9PSBcInRvb2xcIikge1xuICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbc3N5bmtleV0sIFwiY2F0ZWdvcnlcIiwgc3N5bmtleSwgb01vZGVsLm1SdWxlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBvTW9kZWwuZG9tYWlucy5wdXNoKG9NZGwuZG9tYWluKTtcbiAgICBvTW9kZWwudG9vbHMucHVzaChvTWRsLnRvb2wpO1xuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5jb25jYXQob01kbC5jYXRlZ29yeSk7XG4gICAgb01vZGVsLmNhdGVnb3J5LnNvcnQoKTtcbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuZmlsdGVyKGZ1bmN0aW9uIChzdHJpbmcsIGluZGV4KSB7XG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcbiAgICB9KTtcbiAgICBsb2FkTW9kZWxEYXRhKG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCk7XG59IC8vIGxvYWRtb2RlbFxuZnVuY3Rpb24gbG9hZE1vZGVscygpIHtcbiAgICB2YXIgb01vZGVsO1xuICAgIG9Nb2RlbCA9IHtcbiAgICAgICAgZG9tYWluczogW10sXG4gICAgICAgIHRvb2xzOiBbXSxcbiAgICAgICAgY2F0ZWdvcnk6IFtdLFxuICAgICAgICBtUnVsZXM6IFtdXG4gICAgfTtcbiAgICB2YXIgc21kbHMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vc2Vuc2l0aXZlL21vZGVscy5qc29uJywgJ3V0Zi04Jyk7XG4gICAgdmFyIG1kbHMgPSBKU09OLnBhcnNlKFwiXCIgKyBzbWRscyk7XG4gICAgbWRscy5mb3JFYWNoKGZ1bmN0aW9uIChzTW9kZWxOYW1lKSB7XG4gICAgICAgIGxvYWRNb2RlbChzTW9kZWxOYW1lLCBvTW9kZWwpO1xuICAgIH0pO1xuICAgIC8vIGFkZCB0aGUgY2F0ZWdvcmllcyB0byB0aGUgbW9kZWw6XG4gICAgb01vZGVsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG4gICAgICAgIG9Nb2RlbC5tUnVsZXMucHVzaCh7XG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBvTW9kZWw7XG59XG5leHBvcnRzLmxvYWRNb2RlbHMgPSBsb2FkTW9kZWxzO1xuZnVuY3Rpb24gZXhwYW5kUGFyYW1ldGVyc0luVVJMKG9NZXJnZWRDb250ZXh0UmVzdWx0KSB7XG4gICAgdmFyIHB0biA9IG9NZXJnZWRDb250ZXh0UmVzdWx0LnJlc3VsdC5wYXR0ZXJuO1xuICAgIE9iamVjdC5rZXlzKG9NZXJnZWRDb250ZXh0UmVzdWx0LmNvbnRleHQpLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgneycgKyBzS2V5ICsgJ30nLCAnZycpO1xuICAgICAgICBwdG4gPSBwdG4ucmVwbGFjZShyZWdleCwgb01lcmdlZENvbnRleHRSZXN1bHQuY29udGV4dFtzS2V5XSk7XG4gICAgICAgIHB0biA9IHB0bi5yZXBsYWNlKHJlZ2V4LCBvTWVyZ2VkQ29udGV4dFJlc3VsdC5jb250ZXh0W3NLZXldKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcHRuO1xufVxudmFyIGlucHV0RmlsdGVyUnVsZXMgPSByZXF1aXJlKCcuLi9tYXRjaC9pbnB1dEZpbHRlclJ1bGVzJyk7XG52YXIgdG9vbEV4ZWN1dG9ycyA9IHtcbiAgICBcInhGTFBcIjoge30sXG4gICAgXCJ4RkxQRFwiOiB7fSxcbiAgICBcInVuaXQgdGVzdFwiOiBmdW5jdGlvbiAobWF0Y2gpIHtcbiAgICAgICAgdmFyIHVuaXR0ZXN0ID0gbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW1widW5pdCB0ZXN0XCJdLm1hdGNoZWRTdHJpbmc7XG4gICAgICAgIHZhciB1cmwgPSBpbnB1dEZpbHRlclJ1bGVzLmdldFVuaXRUZXN0VXJsKHVuaXR0ZXN0KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQ6IFwic3RhcnRpbmcgdW5pdCB0ZXN0IFxcXCJcIiArIHVuaXR0ZXN0ICsgXCJcXFwiXCIgKyAodXJsID8gKCcgd2l0aCB1cmwgJyArIHVybCkgOiAnbm8gdXJsIDotKCcpLFxuICAgICAgICAgICAgYWN0aW9uOiB7IHVybDogdXJsIH1cbiAgICAgICAgfTtcbiAgICB9LFxuICAgIFwid2lraVwiOiBmdW5jdGlvbiAobWF0Y2gpIHtcbiAgICAgICAgdmFyIHdpa2kgPSBtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbXCJ3aWtpXCJdLm1hdGNoZWRTdHJpbmc7XG4gICAgICAgIHZhciB1cmwgPSBpbnB1dEZpbHRlclJ1bGVzLmdldFdpa2lVcmwod2lraSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0ZXh0OiBcInN0YXJ0aW5nIHdpa2kgXCIgKyB3aWtpICsgKHVybCA/ICgnIHdpdGggdXJsICcgKyB1cmwpIDogJ25vIHVybCA6LSgnKSxcbiAgICAgICAgICAgIGFjdGlvbjogeyB1cmw6IHVybCB9XG4gICAgICAgIH07XG4gICAgfVxufTtcbmZ1bmN0aW9uIGV4ZWNUb29sKG1hdGNoLCBiRXhwbGFpbikge1xuICAgIC8vXG4gICAgdmFyIGV4ZWMgPSB1bmRlZmluZWQ7XG4gICAgaWYgKHRvb2xFeGVjdXRvcnNbbWF0Y2gudG9vbC5uYW1lXSkge1xuICAgICAgICBleGVjID0gdG9vbEV4ZWN1dG9yc1ttYXRjaC50b29sLm5hbWVdKG1hdGNoKTtcbiAgICB9XG4gICAgaWYgKCFleGVjKSB7XG4gICAgICAgIGV4ZWMgPSB7XG4gICAgICAgICAgICB0ZXh0OiBcImRvbid0IGtub3cgaG93IHRvIGV4ZWN1dGUgXCIgKyBtYXRjaC50b29sLm5hbWUgKyAnXFxuJ1xuICAgICAgICB9O1xuICAgIH1cbiAgICBpZiAoYkV4cGxhaW4pIHtcbiAgICAgICAgZXhlYy50ZXh0ID0gZXhlYy50ZXh0ICsgXCJcXG5cIiArIE1hdGNoLlRvb2xNYXRjaC5kdW1wTmljZShtYXRjaCk7XG4gICAgfVxuICAgIHJldHVybiBleGVjO1xuICAgIC8vIFRPRE8gaW52b2tlIHRvb2wgc3BlY2lmaWMgc3RhcnRlclxuICAgIC8qIGlmIChvTWVyZ2VkQ29udGV4dFJlc3VsdC5yZXN1bHQudHlwZSA9PT0gJ1VSTCcpIHtcbiAgICAgIHZhciBwdG4gPSBleHBhbmRQYXJhbWV0ZXJzSW5VUkwob01lcmdlZENvbnRleHRSZXN1bHQpXG4gICAgICBzdGFydEJyb3dzZXIocHRuKVxuICAgICAgcmV0dXJuIHB0blxuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgcyA9IChcIkRvbid0IGtub3cgaG93IHRvIHN0YXJ0IFwiICsgb01lcmdlZENvbnRleHRSZXN1bHQucmVzdWx0LnR5cGUgKyAnXFxuIGZvciBcIicgKyBvTWVyZ2VkQ29udGV4dFJlc3VsdC5xdWVyeSArICdcIicpXG4gICAgICBkZWJ1Z2xvZyhzKVxuICAgICAgcmV0dXJuIHNcbiAgICB9Ki9cbn1cbmV4cG9ydHMuZXhlY1Rvb2wgPSBleGVjVG9vbDtcbi8vICBleGVjdXRlU3RhcnR1cDogZXhlY3V0ZVN0YXJ0dXBcbi8vfVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
