/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require('debug');
var debuglog = debug('model');
var IMatch = require('../match/ifmatch');
var InputFilterRules = require('../match/inputFilterRules');
var Tools = require('../match/tools');
var fs = require('fs');
var process = require('process');
;
function addSynonyms(synonyms, category, synonymFor, mRules) {
    synonyms.forEach(function (syn) {
        var oRule = {
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            _ranking: 0.95
        };
        debuglog("inserting synonym" + JSON.stringify(oRule));
        insertRuleIfNotPresent(mRules, oRule);
    });
}
function insertRuleIfNotPresent(mRules, rule) {
    if (rule.type !== 0 /* WORD */) {
            mRules.push(rule);
            return;
        }
    if (rule.word === undefined || rule.matchedString === undefined) {
        throw new Error('illegal rule' + JSON.stringify(rule, undefined, 2));
    }
    var duplicates = mRules.filter(function (oEntry) {
        return !InputFilterRules.cmpMRule(oEntry, rule);
    });
    if (!duplicates.length) {
        mRules.push(rule);
    }
    debuglog("Attempting to insert duplicate" + JSON.stringify(rule, undefined, 2));
}
function loadModelData(oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var sFileName = './sensitive/' + sModelName + ".data.json";
    var mdldata = fs.readFileSync(sFileName, 'utf-8');
    var oMdlData = JSON.parse(mdldata);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.tool) {
            oEntry.tool = oMdl.tool.name;
        }
        oModel.records.push(oEntry);
        oMdl.wordindex.forEach(function (category) {
            if (oEntry[category] === undefined) {
                debuglog("INCONSISTENT*> ModelData " + sFileName + " does not contain category " + category + " of wordindex" + JSON.stringify(oEntry) + "");
                return;
            }
            if (oEntry[category] !== "*") {
                var sString = oEntry[category];
                debuglog("pushing rule with " + category + " -> " + sString);
                insertRuleIfNotPresent(oModel.mRules, {
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    _ranking: 0.95
                });
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, oModel.mRules);
                }
            }
        });
    });
}
function loadModel(sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var mdl = fs.readFileSync('./sensitive/' + sModelName + ".model.json", 'utf-8');
    var oMdl = JSON.parse(mdl);
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // extract tools an add to tools:
    oModel.tools.filter(function (oEntry) {
        if (oEntry.name === oMdl.tool.name) {
            console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
            //throw new Error('Domain already loaded?');
            process.exit(-1);
        }
    });
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden) {
        oModel.mRules.push({
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            _ranking: 0.95
        });
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oModel.mRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oModel.mRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    oModel.tools.push(oMdl.tool);
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
    loadModelData(oMdl, sModelName, oModel);
} // loadmodel
function loadModels() {
    var oModel;
    oModel = {
        domains: [],
        tools: [],
        category: [],
        mRules: [],
        records: []
    };
    var smdls = fs.readFileSync('./sensitive/models.json', 'utf-8');
    var mdls = JSON.parse("" + smdls);
    mdls.forEach(function (sModelName) {
        loadModel(sModelName, oModel);
    });
    // add the categories to the model:
    oModel.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            _ranking: 0.95
        });
    });
    //add a filler rule
    var sfillers = fs.readFileSync('./sensitive/filler.json', 'utf-8');
    var fillers = JSON.parse(sfillers);
    var re = "^((" + fillers.join(")|(") + "))$";
    oModel.mRules.push({
        category: "filler",
        type: 1 /* REGEXP */
        , regexp: new RegExp(re, "i"),
        matchedString: "filler",
        _ranking: 0.9
    });
    /*
        })
            {
          category: "filler",
          type: 1,
          regexp: /^((start)|(show)|(from)|(in))$/i,
          matchedString: "filler",
          _ranking: 0.9
        },
    */
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    oModel.tools = oModel.tools.sort(Tools.cmpTools);
    return oModel;
}
exports.loadModels = loadModels;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwiSU1hdGNoIiwiSW5wdXRGaWx0ZXJSdWxlcyIsIlRvb2xzIiwiZnMiLCJwcm9jZXNzIiwiYWRkU3lub255bXMiLCJzeW5vbnltcyIsImNhdGVnb3J5Iiwic3lub255bUZvciIsIm1SdWxlcyIsImZvckVhY2giLCJzeW4iLCJvUnVsZSIsIm1hdGNoZWRTdHJpbmciLCJ0eXBlIiwid29yZCIsIl9yYW5raW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImluc2VydFJ1bGVJZk5vdFByZXNlbnQiLCJydWxlIiwicHVzaCIsInVuZGVmaW5lZCIsIkVycm9yIiwiZHVwbGljYXRlcyIsImZpbHRlciIsIm9FbnRyeSIsImNtcE1SdWxlIiwibGVuZ3RoIiwibG9hZE1vZGVsRGF0YSIsIm9NZGwiLCJzTW9kZWxOYW1lIiwib01vZGVsIiwic0ZpbGVOYW1lIiwibWRsZGF0YSIsInJlYWRGaWxlU3luYyIsIm9NZGxEYXRhIiwicGFyc2UiLCJ0b29sIiwibmFtZSIsInJlY29yZHMiLCJ3b3JkaW5kZXgiLCJzU3RyaW5nIiwibG9hZE1vZGVsIiwibWRsIiwiZG9tYWlucyIsImluZGV4T2YiLCJkb21haW4iLCJ0b29scyIsImNvbnNvbGUiLCJsb2ciLCJleGl0IiwidG9vbGhpZGRlbiIsIk9iamVjdCIsImtleXMiLCJzc3lua2V5IiwiY29uY2F0Iiwic29ydCIsInN0cmluZyIsImluZGV4IiwibG9hZE1vZGVscyIsInNtZGxzIiwibWRscyIsInNmaWxsZXJzIiwiZmlsbGVycyIsInJlIiwiam9pbiIsInJlZ2V4cCIsIlJlZ0V4cCIsImNtcFRvb2xzIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0FDS0E7O0FER0EsSUFBWUEsUUFBS0MsUUFBTSxPQUFOLENBQWpCO0FBRUEsSUFBSUMsV0FBV0YsTUFBTSxPQUFOLENBQWY7QUFF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RWpDTSwyQkFBZU4sUUFGa0I7QUFHakNPLGtCQUFNLENBSDJCLENBRzNCO0FBSDJCLGNBSWpDQyxNQUFNUixRQUoyQjtBQUtqQ1Msc0JBQVU7QUFMdUIsU0FBckM7QUFPSCxLQVJEO0FBVUE7QUFDQSxRQUFJK0MsV0FBVzVELEdBQUdnQyxZQUFILENBQWdCLHlCQUFoQixFQUEwQyxPQUExQyxDQUFmO0FBQ0EsUUFBSTZCLFVBQVUvQyxLQUFLb0IsS0FBTCxDQUFXMEIsUUFBWCxDQUFkO0FBQ0EsUUFBSUUsS0FBSyxRQUFRRCxRQUFRRSxJQUFSLENBQWEsS0FBYixDQUFSLEdBQThCLEtBQXZDO0FBQ0FsQyxXQUFPdkIsTUFBUCxDQUFjWSxJQUFkLENBQW1CO0FBQ2pCZCxrQkFBVSxRQURPO0FBRWpCTyxjQUFNLENBRlcsQ0FFWDtBQUZXLFVBR2pCcUQsUUFBUSxJQUFJQyxNQUFKLENBQVdILEVBQVgsRUFBYyxHQUFkLENBSFM7QUFJakJwRCx1QkFBZSxRQUpFO0FBS2pCRyxrQkFBVTtBQUxPLEtBQW5CO0FBT0o7Ozs7Ozs7Ozs7QUFVSWdCLFdBQU92QixNQUFQLEdBQWdCdUIsT0FBT3ZCLE1BQVAsQ0FBY2dELElBQWQsQ0FBbUJ4RCxpQkFBaUIwQixRQUFwQyxDQUFoQjtBQUNBSyxXQUFPZ0IsS0FBUCxHQUFlaEIsT0FBT2dCLEtBQVAsQ0FBYVMsSUFBYixDQUFrQnZELE1BQU1tRSxRQUF4QixDQUFmO0FBQ0EsV0FBT3JDLE1BQVA7QUFDSDtBQWxEZXNDLFFBQUFWLFVBQUEsR0FBVUEsVUFBViIsImZpbGUiOiJtb2RlbC9tb2RlbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBGdW5jdGlvbmFsaXR5IG1hbmFnaW5nIHRoZSBtYXRjaCBtb2RlbHNcclxuICpcclxuICogQGZpbGVcclxuICovXHJcblxyXG5pbXBvcnQgKiBhcyBpbnRmIGZyb20gJ2NvbnN0YW50cyc7XHJcblxyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcblxyXG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9kZWwnKTtcclxuXHJcbmltcG9ydCAqICBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XHJcblxyXG5pbXBvcnQgKiBhcyBNYXRjaCBmcm9tICcuLi9tYXRjaC9tYXRjaCc7XHJcblxyXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlclJ1bGVzIGZyb20gJy4uL21hdGNoL2lucHV0RmlsdGVyUnVsZXMnO1xyXG5cclxuaW1wb3J0ICogYXMgVG9vbHMgZnJvbSAnLi4vbWF0Y2gvdG9vbHMnO1xyXG5cclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5cclxuaW1wb3J0ICogYXMgcHJvY2VzcyBmcm9tICdwcm9jZXNzJztcclxuXHJcbmludGVyZmFjZSBJTW9kZWxzIHtcclxuICAgIGRvbWFpbnM6IHN0cmluZ1tdLFxyXG4gICAgdG9vbHM6IElNYXRjaC5JVG9vbFtdLFxyXG4gICAgY2F0ZWdvcnk6IHN0cmluZ1tdLFxyXG4gICAgbVJ1bGVzOiBJTWF0Y2gubVJ1bGVbXSxcclxuICAgIHJlY29yZHMgOiBhbnlbXTtcclxufVxyXG5cclxuaW50ZXJmYWNlIElNb2RlbCB7XHJcbiAgICBkb21haW46IHN0cmluZyxcclxuICAgIHRvb2w6IElNYXRjaC5JVG9vbCxcclxuICAgIHRvb2xoaWRkZW4/OiBib29sZWFuLFxyXG4gICAgc3lub255bXM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZ1tdIH0sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW10sXHJcbiAgICB3b3JkaW5kZXg6IHN0cmluZ1tdLFxyXG4gICAgaGlkZGVuOiBzdHJpbmdbXVxyXG59O1xyXG5cclxuZnVuY3Rpb24gYWRkU3lub255bXMoc3lub255bXM6IHN0cmluZ1tdLCBjYXRlZ29yeTogc3RyaW5nLCBzeW5vbnltRm9yOiBzdHJpbmcsIG1SdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPikge1xyXG4gICAgc3lub255bXMuZm9yRWFjaChmdW5jdGlvbihzeW4pIHtcclxuICAgICAgICB2YXIgb1J1bGUgPSAge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHN5bm9ueW1Gb3IsXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogc3luLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgZGVidWdsb2coXCJpbnNlcnRpbmcgc3lub255bVwiICsgSlNPTi5zdHJpbmdpZnkob1J1bGUpKTtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcyxvUnVsZSk7XHJcbiAgICAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMgOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCBydWxlOiBJTWF0Y2gubVJ1bGUpIHtcclxuICAgIGlmIChydWxlLnR5cGUgIT09IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCkge1xyXG4gICAgICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmKChydWxlLndvcmQgPT09IHVuZGVmaW5lZCkgfHwgKHJ1bGUubWF0Y2hlZFN0cmluZyA9PT0gdW5kZWZpbmVkKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsdW5kZWZpbmVkLDIpKTtcclxuICAgIH1cclxuICAgIHZhciBkdXBsaWNhdGVzID0gbVJ1bGVzLmZpbHRlcihmdW5jdGlvbihvRW50cnkpIHtcclxuICAgICAgICByZXR1cm4gIUlucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUob0VudHJ5LHJ1bGUpO1xyXG4gICAgfSk7XHJcbiAgICBpZighZHVwbGljYXRlcy5sZW5ndGgpIHtcclxuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcclxuICAgIH1cclxuICAgIGRlYnVnbG9nKFwiQXR0ZW1wdGluZyB0byBpbnNlcnQgZHVwbGljYXRlXCIgKyBKU09OLnN0cmluZ2lmeShydWxlLHVuZGVmaW5lZCwyKSk7XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBsb2FkTW9kZWxEYXRhKG9NZGw6IElNb2RlbCwgc01vZGVsTmFtZTogc3RyaW5nLCBvTW9kZWw6IElNb2RlbHMpIHtcclxuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cclxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxyXG4gICAgY29uc3Qgc0ZpbGVOYW1lID0gKCcuL3NlbnNpdGl2ZS8nICsgc01vZGVsTmFtZSArIFwiLmRhdGEuanNvblwiKTtcclxuICAgIHZhciBtZGxkYXRhID0gZnMucmVhZEZpbGVTeW5jKHNGaWxlTmFtZSwgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgb01kbERhdGEgPSBKU09OLnBhcnNlKG1kbGRhdGEpO1xyXG4gICAgb01kbERhdGEuZm9yRWFjaChmdW5jdGlvbihvRW50cnkpIHtcclxuXHJcbiAgICAgICAgaWYgKCFvRW50cnkudG9vbCkge1xyXG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgb01vZGVsLnJlY29yZHMucHVzaChvRW50cnkpO1xyXG5cclxuICAgICAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiKyBjYXRlZ29yeStcIiBvZiB3b3JkaW5kZXhcIiArIEpTT04uc3RyaW5naWZ5KG9FbnRyeSkgKyBcIlwiKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNTdHJpbmcgPSBvRW50cnlbY2F0ZWdvcnldO1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJwdXNoaW5nIHJ1bGUgd2l0aCBcIisgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xyXG4gICAgICAgICAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmQ6IHNTdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAob01kbERhdGEuc3lub255bXMgJiYgb01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgb01vZGVsLm1SdWxlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkTW9kZWwoc01vZGVsTmFtZTogc3RyaW5nLCBvTW9kZWw6IElNb2RlbHMpIHtcclxuICAgIGRlYnVnbG9nKFwiIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lICsgXCIgLi4uLlwiKTtcclxuICAgIHZhciBtZGwgPSBmcy5yZWFkRmlsZVN5bmMoJy4vc2Vuc2l0aXZlLycgKyBzTW9kZWxOYW1lICsgXCIubW9kZWwuanNvblwiLCAndXRmLTgnKTtcclxuICAgIHZhciBvTWRsID0gSlNPTi5wYXJzZShtZGwpIGFzIElNb2RlbDtcclxuXHJcbiAgICBpZiAob01vZGVsLmRvbWFpbnMuaW5kZXhPZihvTWRsLmRvbWFpbik+PSAwKSB7XHJcbiAgICAgICAgZGVidWdsb2coXCIqKioqKioqKioqKmhlcmUgbWRsXCIgKyBKU09OLnN0cmluZ2lmeShvTWRsLHVuZGVmaW5lZCwgMikpO1xyXG5cclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiAnICsgb01kbC5kb21haW4gKyAnIGFscmVhZHkgbG9hZGVkIHdoaWxlIGxvYWRpbmcgJyArIHNNb2RlbE5hbWUgKyAnPycpO1xyXG4gICAgfVxyXG4gICAgLy8gZXh0cmFjdCB0b29scyBhbiBhZGQgdG8gdG9vbHM6XHJcbiAgICBvTW9kZWwudG9vbHMuZmlsdGVyKGZ1bmN0aW9uKG9FbnRyeSkge1xyXG4gICAgICAgIGlmIChvRW50cnkubmFtZSA9PT0gb01kbC50b29sLm5hbWUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUb29sIFwiICsgb01kbC50b29sLm5hbWUgKyBcIiBhbHJlYWR5IHByZXNlbnQgd2hlbiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSk7XHJcbiAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdEb21haW4gYWxyZWFkeSBsb2FkZWQ/Jyk7XHJcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyBhZGQgdGhlIHRvb2wgbmFtZSBhcyBydWxlIHVubGVzcyBoaWRkZW5cclxuICAgIGlmICghb01kbC50b29saGlkZGVuKSB7XHJcbiAgICAgICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwidG9vbFwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW1widG9vbFwiXSkge1xyXG4gICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbXCJ0b29sXCJdLCBcInRvb2xcIiwgb01kbC50b29sLm5hbWUsIG9Nb2RlbC5tUnVsZXMpO1xyXG4gICAgfTtcclxuICAgIGlmIChvTWRsLnN5bm9ueW1zKSB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC5zeW5vbnltcykuZm9yRWFjaChmdW5jdGlvbihzc3lua2V5KSB7XHJcbiAgICAgICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc3N5bmtleSkgPj0gMCAmJiBzc3lua2V5ICE9PSBcInRvb2xcIikge1xyXG4gICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tzc3lua2V5XSwgXCJjYXRlZ29yeVwiLCBzc3lua2V5LCBvTW9kZWwubVJ1bGVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgb01vZGVsLmRvbWFpbnMucHVzaChvTWRsLmRvbWFpbik7XHJcbiAgICBvTW9kZWwudG9vbHMucHVzaChvTWRsLnRvb2wpO1xyXG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmNvbmNhdChvTWRsLmNhdGVnb3J5KTtcclxuICAgIG9Nb2RlbC5jYXRlZ29yeS5zb3J0KCk7XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuZmlsdGVyKGZ1bmN0aW9uKHN0cmluZywgaW5kZXgpIHtcclxuICAgICAgICByZXR1cm4gb01vZGVsLmNhdGVnb3J5W2luZGV4XSAhPT0gb01vZGVsLmNhdGVnb3J5W2luZGV4ICsgMV07XHJcbiAgICB9KTtcclxuICAgIGxvYWRNb2RlbERhdGEob01kbCwgc01vZGVsTmFtZSwgb01vZGVsKTtcclxufSAvLyBsb2FkbW9kZWxcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbG9hZE1vZGVscygpIHtcclxuICAgIHZhciBvTW9kZWw6IElNb2RlbHM7XHJcbiAgICBvTW9kZWwgPSB7XHJcbiAgICAgICAgZG9tYWluczogW10sXHJcbiAgICAgICAgdG9vbHM6IFtdLFxyXG4gICAgICAgIGNhdGVnb3J5OiBbXSxcclxuICAgICAgICBtUnVsZXM6IFtdLFxyXG4gICAgICAgIHJlY29yZHMgOiBbXVxyXG4gICAgfVxyXG4gICAgdmFyIHNtZGxzID0gZnMucmVhZEZpbGVTeW5jKCcuL3NlbnNpdGl2ZS9tb2RlbHMuanNvbicsICd1dGYtOCcpO1xyXG4gICAgdmFyIG1kbHMgPSBKU09OLnBhcnNlKFwiXCIgKyBzbWRscyk7XHJcbiAgICBtZGxzLmZvckVhY2goZnVuY3Rpb24oc01vZGVsTmFtZSkge1xyXG4gICAgICAgIGxvYWRNb2RlbChzTW9kZWxOYW1lLCBvTW9kZWwpXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGNhdGVnb3JpZXMgdG8gdGhlIG1vZGVsOlxyXG4gICAgb01vZGVsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24oY2F0ZWdvcnkpIHtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMse1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vYWRkIGEgZmlsbGVyIHJ1bGVcclxuICAgIHZhciBzZmlsbGVycyA9IGZzLnJlYWRGaWxlU3luYygnLi9zZW5zaXRpdmUvZmlsbGVyLmpzb24nLCd1dGYtOCcpO1xyXG4gICAgdmFyIGZpbGxlcnMgPSBKU09OLnBhcnNlKHNmaWxsZXJzKTtcclxuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xyXG4gICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcclxuICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXHJcbiAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuUkVHRVhQLFxyXG4gICAgICByZWdleHA6IG5ldyBSZWdFeHAocmUsXCJpXCIpLFxyXG4gICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxyXG4gICAgICBfcmFua2luZzogMC45XHJcbiAgICB9KTtcclxuLypcclxuICAgIH0pXHJcbiAgICAgICAge1xyXG4gICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcclxuICAgICAgdHlwZTogMSxcclxuICAgICAgcmVnZXhwOiAvXigoc3RhcnQpfChzaG93KXwoZnJvbSl8KGluKSkkL2ksXHJcbiAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXHJcbiAgICAgIF9yYW5raW5nOiAwLjlcclxuICAgIH0sXHJcbiovXHJcbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xyXG4gICAgb01vZGVsLnRvb2xzID0gb01vZGVsLnRvb2xzLnNvcnQoVG9vbHMuY21wVG9vbHMpO1xyXG4gICAgcmV0dXJuIG9Nb2RlbDtcclxufVxyXG5cclxuXHJcbiIsIi8qKlxuICogRnVuY3Rpb25hbGl0eSBtYW5hZ2luZyB0aGUgbWF0Y2ggbW9kZWxzXG4gKlxuICogQGZpbGVcbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vZGVsJyk7XG52YXIgSU1hdGNoID0gcmVxdWlyZSgnLi4vbWF0Y2gvaWZtYXRjaCcpO1xudmFyIElucHV0RmlsdGVyUnVsZXMgPSByZXF1aXJlKCcuLi9tYXRjaC9pbnB1dEZpbHRlclJ1bGVzJyk7XG52YXIgVG9vbHMgPSByZXF1aXJlKCcuLi9tYXRjaC90b29scycpO1xudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciBwcm9jZXNzID0gcmVxdWlyZSgncHJvY2VzcycpO1xuO1xuZnVuY3Rpb24gYWRkU3lub255bXMoc3lub255bXMsIGNhdGVnb3J5LCBzeW5vbnltRm9yLCBtUnVsZXMpIHtcbiAgICBzeW5vbnltcy5mb3JFYWNoKGZ1bmN0aW9uIChzeW4pIHtcbiAgICAgICAgdmFyIG9SdWxlID0ge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc3lub255bUZvcixcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIHdvcmQ6IHN5bixcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH07XG4gICAgICAgIGRlYnVnbG9nKFwiaW5zZXJ0aW5nIHN5bm9ueW1cIiArIEpTT04uc3RyaW5naWZ5KG9SdWxlKSk7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQobVJ1bGVzLCBvUnVsZSk7XG4gICAgfSk7XG59XG5mdW5jdGlvbiBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgcnVsZSkge1xuICAgIGlmIChydWxlLnR5cGUgIT09IDAgLyogV09SRCAqLykge1xuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICB2YXIgZHVwbGljYXRlcyA9IG1SdWxlcy5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICByZXR1cm4gIUlucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUob0VudHJ5LCBydWxlKTtcbiAgICB9KTtcbiAgICBpZiAoIWR1cGxpY2F0ZXMubGVuZ3RoKSB7XG4gICAgICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xuICAgIH1cbiAgICBkZWJ1Z2xvZyhcIkF0dGVtcHRpbmcgdG8gaW5zZXJ0IGR1cGxpY2F0ZVwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XG59XG5mdW5jdGlvbiBsb2FkTW9kZWxEYXRhKG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCkge1xuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cbiAgICAvLyBkYXRhIGlzIHByb2Nlc3NlZCBpbnRvIG1SdWxlcyBkaXJlY3RseSxcbiAgICB2YXIgc0ZpbGVOYW1lID0gKCcuL3NlbnNpdGl2ZS8nICsgc01vZGVsTmFtZSArIFwiLmRhdGEuanNvblwiKTtcbiAgICB2YXIgbWRsZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhzRmlsZU5hbWUsICd1dGYtOCcpO1xuICAgIHZhciBvTWRsRGF0YSA9IEpTT04ucGFyc2UobWRsZGF0YSk7XG4gICAgb01kbERhdGEuZm9yRWFjaChmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgIGlmICghb0VudHJ5LnRvb2wpIHtcbiAgICAgICAgICAgIG9FbnRyeS50b29sID0gb01kbC50b29sLm5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgb01vZGVsLnJlY29yZHMucHVzaChvRW50cnkpO1xuICAgICAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwiSU5DT05TSVNURU5UKj4gTW9kZWxEYXRhIFwiICsgc0ZpbGVOYW1lICsgXCIgZG9lcyBub3QgY29udGFpbiBjYXRlZ29yeSBcIiArIGNhdGVnb3J5ICsgXCIgb2Ygd29yZGluZGV4XCIgKyBKU09OLnN0cmluZ2lmeShvRW50cnkpICsgXCJcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gIT09IFwiKlwiKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNTdHJpbmcgPSBvRW50cnlbY2F0ZWdvcnldO1xuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwicHVzaGluZyBydWxlIHdpdGggXCIgKyBjYXRlZ29yeSArIFwiIC0+IFwiICsgc1N0cmluZyk7XG4gICAgICAgICAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XG4gICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc1N0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgICAgICAgICB3b3JkOiBzU3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmIChvTWRsRGF0YS5zeW5vbnltcyAmJiBvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0pIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgb01vZGVsLm1SdWxlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn1cbmZ1bmN0aW9uIGxvYWRNb2RlbChzTW9kZWxOYW1lLCBvTW9kZWwpIHtcbiAgICBkZWJ1Z2xvZyhcIiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSArIFwiIC4uLi5cIik7XG4gICAgdmFyIG1kbCA9IGZzLnJlYWRGaWxlU3luYygnLi9zZW5zaXRpdmUvJyArIHNNb2RlbE5hbWUgKyBcIi5tb2RlbC5qc29uXCIsICd1dGYtOCcpO1xuICAgIHZhciBvTWRsID0gSlNPTi5wYXJzZShtZGwpO1xuICAgIGlmIChvTW9kZWwuZG9tYWlucy5pbmRleE9mKG9NZGwuZG9tYWluKSA+PSAwKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiKioqKioqKioqKipoZXJlIG1kbFwiICsgSlNPTi5zdHJpbmdpZnkob01kbCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgYWxyZWFkeSBsb2FkZWQgd2hpbGUgbG9hZGluZyAnICsgc01vZGVsTmFtZSArICc/Jyk7XG4gICAgfVxuICAgIC8vIGV4dHJhY3QgdG9vbHMgYW4gYWRkIHRvIHRvb2xzOlxuICAgIG9Nb2RlbC50b29scy5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRvb2wgXCIgKyBvTWRsLnRvb2wubmFtZSArIFwiIGFscmVhZHkgcHJlc2VudCB3aGVuIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lKTtcbiAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdEb21haW4gYWxyZWFkeSBsb2FkZWQ/Jyk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXG4gICAgaWYgKCFvTWRsLnRvb2xoaWRkZW4pIHtcbiAgICAgICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcInRvb2xcIixcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwudG9vbC5uYW1lLFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogb01kbC50b29sLm5hbWUsXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgO1xuICAgIGlmIChvTWRsLnN5bm9ueW1zICYmIG9NZGwuc3lub255bXNbXCJ0b29sXCJdKSB7XG4gICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbXCJ0b29sXCJdLCBcInRvb2xcIiwgb01kbC50b29sLm5hbWUsIG9Nb2RlbC5tUnVsZXMpO1xuICAgIH1cbiAgICA7XG4gICAgaWYgKG9NZGwuc3lub255bXMpIHtcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC5zeW5vbnltcykuZm9yRWFjaChmdW5jdGlvbiAoc3N5bmtleSkge1xuICAgICAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzc3lua2V5KSA+PSAwICYmIHNzeW5rZXkgIT09IFwidG9vbFwiKSB7XG4gICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tzc3lua2V5XSwgXCJjYXRlZ29yeVwiLCBzc3lua2V5LCBvTW9kZWwubVJ1bGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIG9Nb2RlbC5kb21haW5zLnB1c2gob01kbC5kb21haW4pO1xuICAgIG9Nb2RlbC50b29scy5wdXNoKG9NZGwudG9vbCk7XG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmNvbmNhdChvTWRsLmNhdGVnb3J5KTtcbiAgICBvTW9kZWwuY2F0ZWdvcnkuc29ydCgpO1xuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5maWx0ZXIoZnVuY3Rpb24gKHN0cmluZywgaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIG9Nb2RlbC5jYXRlZ29yeVtpbmRleF0gIT09IG9Nb2RlbC5jYXRlZ29yeVtpbmRleCArIDFdO1xuICAgIH0pO1xuICAgIGxvYWRNb2RlbERhdGEob01kbCwgc01vZGVsTmFtZSwgb01vZGVsKTtcbn0gLy8gbG9hZG1vZGVsXG5mdW5jdGlvbiBsb2FkTW9kZWxzKCkge1xuICAgIHZhciBvTW9kZWw7XG4gICAgb01vZGVsID0ge1xuICAgICAgICBkb21haW5zOiBbXSxcbiAgICAgICAgdG9vbHM6IFtdLFxuICAgICAgICBjYXRlZ29yeTogW10sXG4gICAgICAgIG1SdWxlczogW10sXG4gICAgICAgIHJlY29yZHM6IFtdXG4gICAgfTtcbiAgICB2YXIgc21kbHMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vc2Vuc2l0aXZlL21vZGVscy5qc29uJywgJ3V0Zi04Jyk7XG4gICAgdmFyIG1kbHMgPSBKU09OLnBhcnNlKFwiXCIgKyBzbWRscyk7XG4gICAgbWRscy5mb3JFYWNoKGZ1bmN0aW9uIChzTW9kZWxOYW1lKSB7XG4gICAgICAgIGxvYWRNb2RlbChzTW9kZWxOYW1lLCBvTW9kZWwpO1xuICAgIH0pO1xuICAgIC8vIGFkZCB0aGUgY2F0ZWdvcmllcyB0byB0aGUgbW9kZWw6XG4gICAgb01vZGVsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiY2F0ZWdvcnlcIixcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IGNhdGVnb3J5LFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogY2F0ZWdvcnksXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICAvL2FkZCBhIGZpbGxlciBydWxlXG4gICAgdmFyIHNmaWxsZXJzID0gZnMucmVhZEZpbGVTeW5jKCcuL3NlbnNpdGl2ZS9maWxsZXIuanNvbicsICd1dGYtOCcpO1xuICAgIHZhciBmaWxsZXJzID0gSlNPTi5wYXJzZShzZmlsbGVycyk7XG4gICAgdmFyIHJlID0gXCJeKChcIiArIGZpbGxlcnMuam9pbihcIil8KFwiKSArIFwiKSkkXCI7XG4gICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXG4gICAgICAgIHR5cGU6IDEgLyogUkVHRVhQICovLFxuICAgICAgICByZWdleHA6IG5ldyBSZWdFeHAocmUsIFwiaVwiKSxcbiAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJmaWxsZXJcIixcbiAgICAgICAgX3Jhbmtpbmc6IDAuOVxuICAgIH0pO1xuICAgIC8qXG4gICAgICAgIH0pXG4gICAgICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXG4gICAgICAgICAgdHlwZTogMSxcbiAgICAgICAgICByZWdleHA6IC9eKChzdGFydCl8KHNob3cpfChmcm9tKXwoaW4pKSQvaSxcbiAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxuICAgICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICAgICAgfSxcbiAgICAqL1xuICAgIG9Nb2RlbC5tUnVsZXMgPSBvTW9kZWwubVJ1bGVzLnNvcnQoSW5wdXRGaWx0ZXJSdWxlcy5jbXBNUnVsZSk7XG4gICAgb01vZGVsLnRvb2xzID0gb01vZGVsLnRvb2xzLnNvcnQoVG9vbHMuY21wVG9vbHMpO1xuICAgIHJldHVybiBvTW9kZWw7XG59XG5leHBvcnRzLmxvYWRNb2RlbHMgPSBsb2FkTW9kZWxzO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
