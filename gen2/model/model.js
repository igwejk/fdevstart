/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require('debug');
var debuglog = debug('model');
var logger = require('../utils/logger');
var loadlog = logger.logger('modelload', '');
var IMatch = require('../match/ifmatch');
var InputFilterRules = require('../match/inputFilterRules');
var Tools = require('../match/tools');
var fs = require('fs');
var Meta = require('./meta');
var process = require('process');
/**
 * the model path, may be controlled via environment variable
 */
var modelPath = process.env["ABOT_MODELPATH"] || "testmodel";
;
function addSynonyms(synonyms, category, synonymFor, mRules, seen) {
    synonyms.forEach(function (syn) {
        var oRule = {
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            _ranking: 0.95
        };
        debuglog("inserting synonym" + JSON.stringify(oRule));
        insertRuleIfNotPresent(mRules, oRule, seen);
    });
}
function insertRuleIfNotPresent(mRules, rule, seenRules) {
    if (rule.type !== 0 /* WORD */) {
            mRules.push(rule);
            return;
        }
    if (rule.word === undefined || rule.matchedString === undefined) {
        throw new Error('illegal rule' + JSON.stringify(rule, undefined, 2));
    }
    var seenRules = seenRules || {};
    var r = JSON.stringify(rule);
    if (seenRules[r]) {
        debuglog("Attempting to insert duplicate" + JSON.stringify(rule, undefined, 2));
        var duplicates = mRules.filter(function (oEntry) {
            return !InputFilterRules.cmpMRule(oEntry, rule);
        });
        if (duplicates.length > 0) {
            return;
        }
    }
    seenRules[r] = rule;
    rule.lowercaseword = rule.word.toLowerCase();
    if (rule.word === "") {
        debuglog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        loadlog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        return;
    }
    mRules.push(rule);
    return;
}
function loadModelData(oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var sFileName = './' + modelPath + '/' + sModelName + ".data.json";
    var mdldata = fs.readFileSync(sFileName, 'utf-8');
    var oMdlData = JSON.parse(mdldata);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.tool && oMdl.tool.name) {
            oEntry.tool = oMdl.tool.name;
        }
        oModel.records.push(oEntry);
        oMdl.wordindex.forEach(function (category) {
            if (oEntry[category] === undefined) {
                debuglog("INCONSISTENT*> ModelData " + sFileName + " does not contain category " + category + " of wordindex" + JSON.stringify(oEntry) + "");
                return;
            }
            if (oEntry[category] !== "*") {
                var sString = oEntry[category];
                debuglog("pushing rule with " + category + " -> " + sString);
                var oRule = {
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    _ranking: 0.95
                };
                if (oMdl.exactmatch && oMdl.exactmatch.indexOf(category) >= 0) {
                    oRule.exactOnly = true;
                }
                insertRuleIfNotPresent(oModel.mRules, oRule, oModel.seenRules);
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, oModel.mRules, oModel.seenRules);
                }
            }
        });
    });
}
function loadModel(sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var mdl = fs.readFileSync('./' + modelPath + '/' + sModelName + ".model.json", 'utf-8');
    var oMdl = JSON.parse(mdl);
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // add relation domain -> category
    var domainStr = MetaF.Domain(oMdl.domain).toFullString();
    var relationStr = MetaF.Relation(Meta.RELATION_hasCategory).toFullString();
    var reverseRelationStr = MetaF.Relation(Meta.RELATION_isCategoryOf).toFullString();
    oMdl.category.forEach(function (sCategory) {
        var CategoryString = MetaF.Category(sCategory).toFullString();
        oModel.meta.t3[domainStr] = oModel.meta.t3[domainStr] || {};
        oModel.meta.t3[domainStr][relationStr] = oModel.meta.t3[domainStr][relationStr] || {};
        oModel.meta.t3[domainStr][relationStr][CategoryString] = {};
        oModel.meta.t3[CategoryString] = oModel.meta.t3[CategoryString] || {};
        oModel.meta.t3[CategoryString][reverseRelationStr] = oModel.meta.t3[CategoryString][reverseRelationStr] || {};
        oModel.meta.t3[CategoryString][reverseRelationStr][domainStr] = {};
    });
    // add a precice domain matchrule
    insertRuleIfNotPresent(oModel.mRules, {
        category: "domain",
        matchedString: oMdl.domain,
        type: 0 /* WORD */
        , word: oMdl.domain,
        _ranking: 0.95
    }, oModel.seenRules);
    // extract tools an add to tools:
    oModel.tools.filter(function (oEntry) {
        if (oEntry.name === (oMdl.tool && oMdl.tool.name)) {
            console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
            //throw new Error('Domain already loaded?');
            process.exit(-1);
        }
    });
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden && oMdl.tool && oMdl.tool.name) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            _ranking: 0.95
        }, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oModel.mRules, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oModel.mRules, oModel.seenRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    if (oMdl.tool.name) {
        oModel.tools.push(oMdl.tool);
    }
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
    loadModelData(oMdl, sModelName, oModel);
} // loadmodel
function loadModels() {
    var oModel;
    oModel = {
        domains: [],
        tools: [],
        category: [],
        mRules: [],
        records: [],
        meta: { t3: {} }
    };
    var smdls = fs.readFileSync('./' + modelPath + '/models.json', 'utf-8');
    var mdls = JSON.parse("" + smdls);
    mdls.forEach(function (sModelName) {
        loadModel(sModelName, oModel);
    });
    // add the categories to the model:
    oModel.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            lowercaseword: category.toLowerCase(),
            _ranking: 0.95
        }, oModel.seenRules);
    });
    // add the domain meta rule
    insertRuleIfNotPresent(oModel.mRules, {
        category: "meta",
        matchedString: "domain",
        type: 0 /* WORD */
        , word: "domain",
        _ranking: 0.95
    }, oModel.seenRules);
    //add a filler rule
    var sfillers = fs.readFileSync('./' + modelPath + '/filler.json', 'utf-8');
    var fillers = JSON.parse(sfillers);
    var re = "^((" + fillers.join(")|(") + "))$";
    oModel.mRules.push({
        category: "filler",
        type: 1 /* REGEXP */
        , regexp: new RegExp(re, "i"),
        matchedString: "filler",
        _ranking: 0.9
    });
    /*
        })
            {
          category: "filler",
          type: 1,
          regexp: /^((start)|(show)|(from)|(in))$/i,
          matchedString: "filler",
          _ranking: 0.9
        },
    */
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    oModel.tools = oModel.tools.sort(Tools.cmpTools);
    delete oModel.seenRules;
    return oModel;
}
exports.loadModels = loadModels;
var MetaF = Meta.getMetaFactory();
function getResultAsArray(mdl, a, rel) {
    if (rel.toType() !== 'relation') {
        throw new Error("expect relation as 2nd arg");
    }
    var res = mdl.meta.t3[a.toFullString()] && mdl.meta.t3[a.toFullString()][rel.toFullString()];
    if (!res) {
        return [];
    }
    return Object.getOwnPropertyNames(res).sort().map(MetaF.parseIMeta);
}
exports.getResultAsArray = getResultAsArray;
function getCategoriesForDomain(theModel, domain) {
    if (theModel.domains.indexOf(domain) < 0) {
        throw new Error("Domain \"" + domain + "\" not part of model");
    }
    var res = getResultAsArray(theModel, MetaF.Domain(domain), MetaF.Relation(Meta.RELATION_hasCategory));
    return Meta.getStringArray(res);
}
exports.getCategoriesForDomain = getCategoriesForDomain;
function getDomainsForCategory(theModel, category) {
    if (theModel.category.indexOf(category) < 0) {
        throw new Error("Category \"" + category + "\" not part of model");
    }
    var res = getResultAsArray(theModel, MetaF.Category(category), MetaF.Relation(Meta.RELATION_isCategoryOf));
    return Meta.getStringArray(res);
}
exports.getDomainsForCategory = getDomainsForCategory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwibG9nZ2VyIiwibG9hZGxvZyIsIklNYXRjaCIsIklucHV0RmlsdGVyUnVsZXMiLCJUb29scyIsImZzIiwiTWV0YSIsInByb2Nlc3MiLCJtb2RlbFBhdGgiLCJlbnYiLCJhZGRTeW5vbnltcyIsInN5bm9ueW1zIiwiY2F0ZWdvcnkiLCJzeW5vbnltRm9yIiwibVJ1bGVzIiwic2VlbiIsImZvckVhY2giLCJzeW4iLCJvUnVsZSIsIm1hdGNoZWRTdHJpbmciLCJ0eXBlIiwid29yZCIsIl9yYW5raW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImluc2VydFJ1bGVJZk5vdFByZXNlbnQiLCJydWxlIiwic2VlblJ1bGVzIiwicHVzaCIsInVuZGVmaW5lZCIsIkVycm9yIiwiciIsImR1cGxpY2F0ZXMiLCJmaWx0ZXIiLCJvRW50cnkiLCJjbXBNUnVsZSIsImxlbmd0aCIsImxvd2VyY2FzZXdvcmQiLCJ0b0xvd2VyQ2FzZSIsImxvYWRNb2RlbERhdGEiLCJvTWRsIiwic01vZGVsTmFtZSIsIm9Nb2RlbCIsInNGaWxlTmFtZSIsIm1kbGRhdGEiLCJyZWFkRmlsZVN5bmMiLCJvTWRsRGF0YSIsInBhcnNlIiwidG9vbCIsIm5hbWUiLCJyZWNvcmRzIiwid29yZGluZGV4Iiwic1N0cmluZyIsImV4YWN0bWF0Y2giLCJpbmRleE9mIiwiZXhhY3RPbmx5IiwibG9hZE1vZGVsIiwibWRsIiwiZG9tYWlucyIsImRvbWFpbiIsImRvbWFpblN0ciIsIk1ldGFGIiwiRG9tYWluIiwidG9GdWxsU3RyaW5nIiwicmVsYXRpb25TdHIiLCJSZWxhdGlvbiIsIlJFTEFUSU9OX2hhc0NhdGVnb3J5IiwicmV2ZXJzZVJlbGF0aW9uU3RyIiwiUkVMQVRJT05faXNDYXRlZ29yeU9mIiwic0NhdGVnb3J5IiwiQ2F0ZWdvcnlTdHJpbmciLCJDYXRlZ29yeSIsIm1ldGEiLCJ0MyIsInRvb2xzIiwiY29uc29sZSIsImxvZyIsImV4aXQiLCJ0b29saGlkZGVuIiwiT2JqZWN0Iiwia2V5cyIsInNzeW5rZXkiLCJjb25jYXQiLCJzb3J0Iiwic3RyaW5nIiwiaW5kZXgiLCJsb2FkTW9kZWxzIiwic21kbHMiLCJtZGxzIiwic2ZpbGxlcnMiLCJmaWxsZXJzIiwicmUiLCJqb2luIiwicmVnZXhwIiwiUmVnRXhwIiwiY21wVG9vbHMiLCJleHBvcnRzIiwiZ2V0TWV0YUZhY3RvcnkiLCJnZXRSZXN1bHRBc0FycmF5IiwiYSIsInJlbCIsInRvVHlwZSIsInJlcyIsImdldE93blByb3BlcnR5TmFtZXMiLCJtYXAiLCJwYXJzZUlNZXRhIiwiZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbiIsInRoZU1vZGVsIiwiZ2V0U3RyaW5nQXJyYXkiLCJnZXREb21haW5zRm9yQ2F0ZWdvcnkiXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQ0tBOztBREVBLElBQVlBLFFBQUtDLFFBQU0sT0FBTixDQUFqQjtBQUVBLElBQUlDLFdBQVdGLE1BQU0sT0FBTixDQUFmO0FBRUEsSUFBWUcsU0FBTUYsUUFBTSxpQkFBTixDQUFsQjtBQUVBLElBQU1HLFVBQVVELE9BQU9BLE1BQVAsQ0FBYyxXQUFkLEVBQTJCLEVBQTNCLENBQWhCO0FBRUEsSUFBYUUsU0FBTUosUUFBTSxrQkFBTixDQUFuQjtBQUVBLElBQVlLLG1CQUFnQkwsUUFBTSwyQkFBTixDQUE1QjtBQUNBLElBQVlNLFFBQUtOLFFBQU0sZ0JBQU4sQ0FBakI7QUFDQSxJQUFZTyxLQUFFUCxRQUFNLElBQU4sQ0FBZDtBQUNBLElBQVlRLE9BQUlSLFFBQU0sUUFBTixDQUFoQjtBQUNBLElBQVlTLFVBQU9ULFFBQU0sU0FBTixDQUFuQjtBQUVBOzs7QUFHQSxJQUFJVSxZQUFZRCxRQUFRRSxHQUFSLENBQVksZ0JBQVosS0FBaUMsV0FBakQ7QUEyQkM7QUFFRCxTQUFBQyxXQUFBLENBQXFCQyxRQUFyQixFQUF5Q0MsUUFBekMsRUFBMkRDLFVBQTNELEVB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LEtBQUtzRyxjQUFMLENBQW9CTixHQUFwQixDQUFQO0FBQ0g7QUFOZU4sUUFBQVUsc0JBQUEsR0FBc0JBLHNCQUF0QjtBQVFoQixTQUFBRyxxQkFBQSxDQUFzQ0YsUUFBdEMsRUFBaUUvRixRQUFqRSxFQUFrRjtBQUM5RSxRQUFHK0YsU0FBUy9GLFFBQVQsQ0FBa0IwQyxPQUFsQixDQUEwQjFDLFFBQTFCLElBQXNDLENBQXpDLEVBQTRDO0FBQ3hDLGNBQU0sSUFBSWtCLEtBQUosQ0FBVSxnQkFBZ0JsQixRQUFoQixHQUEyQixzQkFBckMsQ0FBTjtBQUNIO0FBQ0QsUUFBSTBGLE1BQU1KLGlCQUFpQlMsUUFBakIsRUFBMkI5QyxNQUFNVSxRQUFOLENBQWUzRCxRQUFmLENBQTNCLEVBQXFEaUQsTUFBTUksUUFBTixDQUFlM0QsS0FBSzhELHFCQUFwQixDQUFyRCxDQUFWO0FBQ0EsV0FBTzlELEtBQUtzRyxjQUFMLENBQW9CTixHQUFwQixDQUFQO0FBQ0g7QUFOZU4sUUFBQWEscUJBQUEsR0FBcUJBLHFCQUFyQiIsImZpbGUiOiJtb2RlbC9tb2RlbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBGdW5jdGlvbmFsaXR5IG1hbmFnaW5nIHRoZSBtYXRjaCBtb2RlbHNcclxuICpcclxuICogQGZpbGVcclxuICovXHJcblxyXG5pbXBvcnQgKiBhcyBpbnRmIGZyb20gJ2NvbnN0YW50cyc7XHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcclxuXHJcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdtb2RlbCcpO1xyXG5cclxuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XHJcblxyXG5jb25zdCBsb2FkbG9nID0gbG9nZ2VyLmxvZ2dlcignbW9kZWxsb2FkJywgJycpO1xyXG5cclxuaW1wb3J0ICogIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvbWF0Y2gnO1xyXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlclJ1bGVzIGZyb20gJy4uL21hdGNoL2lucHV0RmlsdGVyUnVsZXMnO1xyXG5pbXBvcnQgKiBhcyBUb29scyBmcm9tICcuLi9tYXRjaC90b29scyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgTWV0YSBmcm9tICcuL21ldGEnO1xyXG5pbXBvcnQgKiBhcyBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xyXG5cclxuLyoqXHJcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcclxuICovXHJcbnZhciBtb2RlbFBhdGggPSBwcm9jZXNzLmVudltcIkFCT1RfTU9ERUxQQVRIXCJdIHx8IFwidGVzdG1vZGVsXCI7XHJcblxyXG4vL2V4cG9ydCBpbnRlcmZhY2UgSU1vZGVscyA9IE1hdGNoLklNb2RlbHM7XHJcblxyXG4vKlxyXG5leHBvcnQgaW50ZXJmYWNlIElNb2RlbHMge1xyXG4gICAgZG9tYWluczogc3RyaW5nW10sXHJcbiAgICB0b29sczogSU1hdGNoLklUb29sW10sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW10sXHJcbiAgICBtUnVsZXM6IElNYXRjaC5tUnVsZVtdLFxyXG4gICAgcmVjb3JkczogYW55W11cclxuICAgIHNlZW5SdWxlcz86IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlIH0sXHJcbiAgICBtZXRhIDoge1xyXG4gICAgICAgIC8vIGVudGl0eSAtPiByZWxhdGlvbiAtPiB0YXJnZXRcclxuICAgICAgICB0MyA6IHsgW2tleTogc3RyaW5nXSA6IHsgW2tleSA6IHN0cmluZ10gOiBhbnkgfX1cclxuICAgIH1cclxufSovXHJcblxyXG5pbnRlcmZhY2UgSU1vZGVsIHtcclxuICAgIGRvbWFpbjogc3RyaW5nLFxyXG4gICAgdG9vbDogSU1hdGNoLklUb29sLFxyXG4gICAgdG9vbGhpZGRlbj86IGJvb2xlYW4sXHJcbiAgICBzeW5vbnltcz86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nW10gfSxcclxuICAgIGNhdGVnb3J5OiBzdHJpbmdbXSxcclxuICAgIHdvcmRpbmRleDogc3RyaW5nW10sXHJcbiAgICBleGFjdG1hdGNoPyA6IHN0cmluZ1tdLFxyXG4gICAgaGlkZGVuOiBzdHJpbmdbXVxyXG59O1xyXG5cclxuZnVuY3Rpb24gYWRkU3lub255bXMoc3lub255bXM6IHN0cmluZ1tdLCBjYXRlZ29yeTogc3RyaW5nLCBzeW5vbnltRm9yOiBzdHJpbmcsIG1SdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgc2VlbjogeyBba2V5OiBzdHJpbmddOiBJTWF0Y2gubVJ1bGUgfSkge1xyXG4gICAgc3lub255bXMuZm9yRWFjaChmdW5jdGlvbiAoc3luKSB7XHJcbiAgICAgICAgdmFyIG9SdWxlID0ge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHN5bm9ueW1Gb3IsXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogc3luLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgZGVidWdsb2coXCJpbnNlcnRpbmcgc3lub255bVwiICsgSlNPTi5zdHJpbmdpZnkob1J1bGUpKTtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgb1J1bGUsIHNlZW4pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluc2VydFJ1bGVJZk5vdFByZXNlbnQobVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCBydWxlOiBJTWF0Y2gubVJ1bGUsXHJcbiAgICBzZWVuUnVsZXM6IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlIH0pIHtcclxuICAgIGlmIChydWxlLnR5cGUgIT09IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCkge1xyXG4gICAgICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICgocnVsZS53b3JkID09PSB1bmRlZmluZWQpIHx8IChydWxlLm1hdGNoZWRTdHJpbmcgPT09IHVuZGVmaW5lZCkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lsbGVnYWwgcnVsZScgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcclxuICAgIH1cclxuICAgIHZhciBzZWVuUnVsZXMgPSBzZWVuUnVsZXMgfHwge307XHJcbiAgICB2YXIgciA9IEpTT04uc3RyaW5naWZ5KHJ1bGUpO1xyXG4gICAgaWYgKHNlZW5SdWxlc1tyXSkge1xyXG4gICAgICAgIGRlYnVnbG9nKFwiQXR0ZW1wdGluZyB0byBpbnNlcnQgZHVwbGljYXRlXCIgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcclxuICAgICAgICB2YXIgZHVwbGljYXRlcyA9IG1SdWxlcy5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xyXG4gICAgICAgICAgICByZXR1cm4gIUlucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUob0VudHJ5LCBydWxlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoZHVwbGljYXRlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzZWVuUnVsZXNbcl0gPSBydWxlO1xyXG4gICAgcnVsZS5sb3dlcmNhc2V3b3JkID0gcnVsZS53b3JkLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBpZiAocnVsZS53b3JkID09PSBcIlwiKSB7XHJcbiAgICAgICAgZGVidWdsb2coJ1NraXBwaW5nIHJ1bGUgd2l0aCBlbXRweSB3b3JkICcgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcclxuICAgICAgICBsb2FkbG9nKCdTa2lwcGluZyBydWxlIHdpdGggZW10cHkgd29yZCAnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbVJ1bGVzLnB1c2gocnVsZSk7XHJcbiAgICByZXR1cm47XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRNb2RlbERhdGEob01kbDogSU1vZGVsLCBzTW9kZWxOYW1lOiBzdHJpbmcsIG9Nb2RlbDogSU1hdGNoLklNb2RlbHMpIHtcclxuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cclxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxyXG4gICAgY29uc3Qgc0ZpbGVOYW1lID0gKCcuLycgKyBtb2RlbFBhdGggKyAnLycgKyBzTW9kZWxOYW1lICsgXCIuZGF0YS5qc29uXCIpO1xyXG4gICAgdmFyIG1kbGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoc0ZpbGVOYW1lLCAndXRmLTgnKTtcclxuICAgIHZhciBvTWRsRGF0YSA9IEpTT04ucGFyc2UobWRsZGF0YSk7XHJcbiAgICBvTWRsRGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICBpZiAoIW9FbnRyeS50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XHJcbiAgICAgICAgICAgIG9FbnRyeS50b29sID0gb01kbC50b29sLm5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9Nb2RlbC5yZWNvcmRzLnB1c2gob0VudHJ5KTtcclxuXHJcbiAgICAgICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcclxuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiICsgY2F0ZWdvcnkgKyBcIiBvZiB3b3JkaW5kZXhcIiArIEpTT04uc3RyaW5naWZ5KG9FbnRyeSkgKyBcIlwiKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNTdHJpbmcgPSBvRW50cnlbY2F0ZWdvcnldO1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJwdXNoaW5nIHJ1bGUgd2l0aCBcIiArIGNhdGVnb3J5ICsgXCIgLT4gXCIgKyBzU3RyaW5nKTtcclxuICAgICAgICAgICAgICAgIHZhciBvUnVsZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmQ6IHNTdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgICAgICAgICAgICAgfSBhcyBJTWF0Y2gubVJ1bGU7XHJcbiAgICAgICAgICAgICAgICBpZihvTWRsLmV4YWN0bWF0Y2ggJiYgb01kbC5leGFjdG1hdGNoLmluZGV4T2YoY2F0ZWdvcnkpID49IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBvUnVsZS5leGFjdE9ubHkgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLG9SdWxlLCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgICAgICAgICAgICAgIGlmIChvTWRsRGF0YS5zeW5vbnltcyAmJiBvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0pIHtcclxuICAgICAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0sIGNhdGVnb3J5LCBzU3RyaW5nLCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRNb2RlbChzTW9kZWxOYW1lOiBzdHJpbmcsIG9Nb2RlbDogSU1hdGNoLklNb2RlbHMpIHtcclxuICAgIGRlYnVnbG9nKFwiIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lICsgXCIgLi4uLlwiKTtcclxuICAgIHZhciBtZGwgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5tb2RlbC5qc29uXCIsICd1dGYtOCcpO1xyXG4gICAgdmFyIG9NZGwgPSBKU09OLnBhcnNlKG1kbCkgYXMgSU1vZGVsO1xyXG5cclxuICAgIGlmIChvTW9kZWwuZG9tYWlucy5pbmRleE9mKG9NZGwuZG9tYWluKSA+PSAwKSB7XHJcbiAgICAgICAgZGVidWdsb2coXCIqKioqKioqKioqKmhlcmUgbWRsXCIgKyBKU09OLnN0cmluZ2lmeShvTWRsLCB1bmRlZmluZWQsIDIpKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiAnICsgb01kbC5kb21haW4gKyAnIGFscmVhZHkgbG9hZGVkIHdoaWxlIGxvYWRpbmcgJyArIHNNb2RlbE5hbWUgKyAnPycpO1xyXG4gICAgfVxyXG4gICAgLy8gYWRkIHJlbGF0aW9uIGRvbWFpbiAtPiBjYXRlZ29yeVxyXG4gICAgdmFyIGRvbWFpblN0ciA9IE1ldGFGLkRvbWFpbihvTWRsLmRvbWFpbikudG9GdWxsU3RyaW5nKCk7XHJcbiAgICB2YXIgcmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2hhc0NhdGVnb3J5KS50b0Z1bGxTdHJpbmcoKTtcclxuICAgIHZhciByZXZlcnNlUmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikudG9GdWxsU3RyaW5nKCk7XHJcbiAgICBvTWRsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24oc0NhdGVnb3J5KSB7XHJcblxyXG4gICAgICAgIHZhciBDYXRlZ29yeVN0cmluZyA9IE1ldGFGLkNhdGVnb3J5KHNDYXRlZ29yeSkudG9GdWxsU3RyaW5nKCk7XHJcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl0gfHwge307XHJcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl0gPSBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdW3JlbGF0aW9uU3RyXSB8fCB7fTtcclxuICAgICAgICBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdW3JlbGF0aW9uU3RyXVtDYXRlZ29yeVN0cmluZ10gID0ge307XHJcblxyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXSA9IG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXSB8fCB7fTtcclxuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ11bcmV2ZXJzZVJlbGF0aW9uU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdIHx8IHt9O1xyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdW2RvbWFpblN0cl0gID0ge307XHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gYWRkIGEgcHJlY2ljZSBkb21haW4gbWF0Y2hydWxlXHJcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiZG9tYWluXCIsXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwuZG9tYWluLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIHdvcmQ6IG9NZGwuZG9tYWluLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG5cclxuXHJcblxyXG4gICAgLy8gZXh0cmFjdCB0b29scyBhbiBhZGQgdG8gdG9vbHM6XHJcbiAgICBvTW9kZWwudG9vbHMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IChvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVG9vbCBcIiArIG9NZGwudG9vbC5uYW1lICsgXCIgYWxyZWFkeSBwcmVzZW50IHdoZW4gbG9hZGluZyBcIiArIHNNb2RlbE5hbWUpO1xyXG4gICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluIGFscmVhZHkgbG9hZGVkPycpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXHJcbiAgICBpZiAoIW9NZGwudG9vbGhpZGRlbiAmJiBvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpIHtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwidG9vbFwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgIH07XHJcbiAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW1widG9vbFwiXSkge1xyXG4gICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbXCJ0b29sXCJdLCBcInRvb2xcIiwgb01kbC50b29sLm5hbWUsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgfTtcclxuICAgIGlmIChvTWRsLnN5bm9ueW1zKSB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC5zeW5vbnltcykuZm9yRWFjaChmdW5jdGlvbiAoc3N5bmtleSkge1xyXG4gICAgICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNzeW5rZXkpID49IDAgJiYgc3N5bmtleSAhPT0gXCJ0b29sXCIpIHtcclxuICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbc3N5bmtleV0sIFwiY2F0ZWdvcnlcIiwgc3N5bmtleSwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIG9Nb2RlbC5kb21haW5zLnB1c2gob01kbC5kb21haW4pO1xyXG4gICAgaWYob01kbC50b29sLm5hbWUpIHtcclxuICAgICAgb01vZGVsLnRvb2xzLnB1c2gob01kbC50b29sKTtcclxuICAgIH1cclxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5jb25jYXQob01kbC5jYXRlZ29yeSk7XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkuc29ydCgpO1xyXG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmZpbHRlcihmdW5jdGlvbiAoc3RyaW5nLCBpbmRleCkge1xyXG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcclxuICAgIH0pO1xyXG4gICAgbG9hZE1vZGVsRGF0YShvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpO1xyXG59IC8vIGxvYWRtb2RlbFxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRNb2RlbHMoKSA6IElNYXRjaC5JTW9kZWxzIHtcclxuICAgIHZhciBvTW9kZWw6IElNYXRjaC5JTW9kZWxzO1xyXG4gICAgb01vZGVsID0ge1xyXG4gICAgICAgIGRvbWFpbnM6IFtdLFxyXG4gICAgICAgIHRvb2xzOiBbXSxcclxuICAgICAgICBjYXRlZ29yeTogW10sXHJcbiAgICAgICAgbVJ1bGVzOiBbXSxcclxuICAgICAgICByZWNvcmRzOiBbXSxcclxuICAgICAgICBtZXRhIDogeyB0MyA6IHt9IH1cclxuICAgIH1cclxuICAgIHZhciBzbWRscyA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy9tb2RlbHMuanNvbicsICd1dGYtOCcpO1xyXG4gICAgdmFyIG1kbHMgPSBKU09OLnBhcnNlKFwiXCIgKyBzbWRscyk7XHJcbiAgICBtZGxzLmZvckVhY2goZnVuY3Rpb24gKHNNb2RlbE5hbWUpIHtcclxuICAgICAgICBsb2FkTW9kZWwoc01vZGVsTmFtZSwgb01vZGVsKVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcclxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGFkZCB0aGUgZG9tYWluIG1ldGEgcnVsZVxyXG4gICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcIm1ldGFcIixcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJkb21haW5cIixcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBcImRvbWFpblwiLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG5cclxuXHJcblxyXG4gICAgLy9hZGQgYSBmaWxsZXIgcnVsZVxyXG4gICAgdmFyIHNmaWxsZXJzID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnL2ZpbGxlci5qc29uJywgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgZmlsbGVycyA9IEpTT04ucGFyc2Uoc2ZpbGxlcnMpO1xyXG4gICAgdmFyIHJlID0gXCJeKChcIiArIGZpbGxlcnMuam9pbihcIil8KFwiKSArIFwiKSkkXCI7XHJcbiAgICBvTW9kZWwubVJ1bGVzLnB1c2goe1xyXG4gICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxyXG4gICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuUkVHRVhQLFxyXG4gICAgICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChyZSwgXCJpXCIpLFxyXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXHJcbiAgICAgICAgX3Jhbmtpbmc6IDAuOVxyXG4gICAgfSk7XHJcbiAgICAvKlxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxyXG4gICAgICAgICAgdHlwZTogMSxcclxuICAgICAgICAgIHJlZ2V4cDogL14oKHN0YXJ0KXwoc2hvdyl8KGZyb20pfChpbikpJC9pLFxyXG4gICAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJmaWxsZXJcIixcclxuICAgICAgICAgIF9yYW5raW5nOiAwLjlcclxuICAgICAgICB9LFxyXG4gICAgKi9cclxuICAgIG9Nb2RlbC5tUnVsZXMgPSBvTW9kZWwubVJ1bGVzLnNvcnQoSW5wdXRGaWx0ZXJSdWxlcy5jbXBNUnVsZSk7XHJcbiAgICBvTW9kZWwudG9vbHMgPSBvTW9kZWwudG9vbHMuc29ydChUb29scy5jbXBUb29scyk7XHJcbiAgICBkZWxldGUgb01vZGVsLnNlZW5SdWxlcztcclxuICAgIHJldHVybiBvTW9kZWw7XHJcbn1cclxuXHJcblxyXG5jb25zdCBNZXRhRiA9IE1ldGEuZ2V0TWV0YUZhY3RvcnkoKTtcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVzdWx0QXNBcnJheShtZGwgOiBJTWF0Y2guSU1vZGVscywgYSA6IE1ldGEuSU1ldGEsIHJlbCA6IE1ldGEuSU1ldGEpIDogTWV0YS5JTWV0YVtdIHtcclxuICAgIGlmKHJlbC50b1R5cGUoKSAhPT0gJ3JlbGF0aW9uJykge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImV4cGVjdCByZWxhdGlvbiBhcyAybmQgYXJnXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciByZXMgPSBtZGwubWV0YS50M1thLnRvRnVsbFN0cmluZygpXSAmJlxyXG4gICAgbWRsLm1ldGEudDNbYS50b0Z1bGxTdHJpbmcoKV1bcmVsLnRvRnVsbFN0cmluZygpXTtcclxuICAgIGlmKCFyZXMpIHtcclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocmVzKS5zb3J0KCkubWFwKE1ldGFGLnBhcnNlSU1ldGEpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbih0aGVNb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBkb21haW4gOiBzdHJpbmcpIDogc3RyaW5nW10ge1xyXG4gICAgaWYodGhlTW9kZWwuZG9tYWlucy5pbmRleE9mKGRvbWFpbikgPCAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRG9tYWluIFxcXCJcIiArIGRvbWFpbiArIFwiXFxcIiBub3QgcGFydCBvZiBtb2RlbFwiKTtcclxuICAgIH1cclxuICAgIHZhciByZXMgPSBnZXRSZXN1bHRBc0FycmF5KHRoZU1vZGVsLCBNZXRhRi5Eb21haW4oZG9tYWluKSwgTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9oYXNDYXRlZ29yeSkpO1xyXG4gICAgcmV0dXJuIE1ldGEuZ2V0U3RyaW5nQXJyYXkocmVzKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBjYXRlZ29yeSA6IHN0cmluZykgOiBzdHJpbmdbXSB7XHJcbiAgICBpZih0aGVNb2RlbC5jYXRlZ29yeS5pbmRleE9mKGNhdGVnb3J5KSA8IDApIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYXRlZ29yeSBcXFwiXCIgKyBjYXRlZ29yeSArIFwiXFxcIiBub3QgcGFydCBvZiBtb2RlbFwiKTtcclxuICAgIH1cclxuICAgIHZhciByZXMgPSBnZXRSZXN1bHRBc0FycmF5KHRoZU1vZGVsLCBNZXRhRi5DYXRlZ29yeShjYXRlZ29yeSksIE1ldGFGLlJlbGF0aW9uKE1ldGEuUkVMQVRJT05faXNDYXRlZ29yeU9mKSk7XHJcbiAgICByZXR1cm4gTWV0YS5nZXRTdHJpbmdBcnJheShyZXMpO1xyXG59IiwiLyoqXG4gKiBGdW5jdGlvbmFsaXR5IG1hbmFnaW5nIHRoZSBtYXRjaCBtb2RlbHNcbiAqXG4gKiBAZmlsZVxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9kZWwnKTtcbnZhciBsb2dnZXIgPSByZXF1aXJlKCcuLi91dGlscy9sb2dnZXInKTtcbnZhciBsb2FkbG9nID0gbG9nZ2VyLmxvZ2dlcignbW9kZWxsb2FkJywgJycpO1xudmFyIElNYXRjaCA9IHJlcXVpcmUoJy4uL21hdGNoL2lmbWF0Y2gnKTtcbnZhciBJbnB1dEZpbHRlclJ1bGVzID0gcmVxdWlyZSgnLi4vbWF0Y2gvaW5wdXRGaWx0ZXJSdWxlcycpO1xudmFyIFRvb2xzID0gcmVxdWlyZSgnLi4vbWF0Y2gvdG9vbHMnKTtcbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG52YXIgTWV0YSA9IHJlcXVpcmUoJy4vbWV0YScpO1xudmFyIHByb2Nlc3MgPSByZXF1aXJlKCdwcm9jZXNzJyk7XG4vKipcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcbiAqL1xudmFyIG1vZGVsUGF0aCA9IHByb2Nlc3MuZW52W1wiQUJPVF9NT0RFTFBBVEhcIl0gfHwgXCJ0ZXN0bW9kZWxcIjtcbjtcbmZ1bmN0aW9uIGFkZFN5bm9ueW1zKHN5bm9ueW1zLCBjYXRlZ29yeSwgc3lub255bUZvciwgbVJ1bGVzLCBzZWVuKSB7XG4gICAgc3lub255bXMuZm9yRWFjaChmdW5jdGlvbiAoc3luKSB7XG4gICAgICAgIHZhciBvUnVsZSA9IHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHN5bm9ueW1Gb3IsXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBzeW4sXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxuICAgICAgICB9O1xuICAgICAgICBkZWJ1Z2xvZyhcImluc2VydGluZyBzeW5vbnltXCIgKyBKU09OLnN0cmluZ2lmeShvUnVsZSkpO1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgb1J1bGUsIHNlZW4pO1xuICAgIH0pO1xufVxuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcykge1xuICAgIGlmIChydWxlLnR5cGUgIT09IDAgLyogV09SRCAqLykge1xuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICB2YXIgc2VlblJ1bGVzID0gc2VlblJ1bGVzIHx8IHt9O1xuICAgIHZhciByID0gSlNPTi5zdHJpbmdpZnkocnVsZSk7XG4gICAgaWYgKHNlZW5SdWxlc1tyXSkge1xuICAgICAgICBkZWJ1Z2xvZyhcIkF0dGVtcHRpbmcgdG8gaW5zZXJ0IGR1cGxpY2F0ZVwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHZhciBkdXBsaWNhdGVzID0gbVJ1bGVzLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgICAgICByZXR1cm4gIUlucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUob0VudHJ5LCBydWxlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChkdXBsaWNhdGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBzZWVuUnVsZXNbcl0gPSBydWxlO1xuICAgIHJ1bGUubG93ZXJjYXNld29yZCA9IHJ1bGUud29yZC50b0xvd2VyQ2FzZSgpO1xuICAgIGlmIChydWxlLndvcmQgPT09IFwiXCIpIHtcbiAgICAgICAgZGVidWdsb2coJ1NraXBwaW5nIHJ1bGUgd2l0aCBlbXRweSB3b3JkICcgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgbG9hZGxvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xuICAgIHJldHVybjtcbn1cbmZ1bmN0aW9uIGxvYWRNb2RlbERhdGEob01kbCwgc01vZGVsTmFtZSwgb01vZGVsKSB7XG4gICAgLy8gcmVhZCB0aGUgZGF0YSAtPlxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxuICAgIHZhciBzRmlsZU5hbWUgPSAoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5kYXRhLmpzb25cIik7XG4gICAgdmFyIG1kbGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoc0ZpbGVOYW1lLCAndXRmLTgnKTtcbiAgICB2YXIgb01kbERhdGEgPSBKU09OLnBhcnNlKG1kbGRhdGEpO1xuICAgIG9NZGxEYXRhLmZvckVhY2goZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICBpZiAoIW9FbnRyeS50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xuICAgICAgICB9XG4gICAgICAgIG9Nb2RlbC5yZWNvcmRzLnB1c2gob0VudHJ5KTtcbiAgICAgICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIklOQ09OU0lTVEVOVCo+IE1vZGVsRGF0YSBcIiArIHNGaWxlTmFtZSArIFwiIGRvZXMgbm90IGNvbnRhaW4gY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIG9mIHdvcmRpbmRleFwiICsgSlNPTi5zdHJpbmdpZnkob0VudHJ5KSArIFwiXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xuICAgICAgICAgICAgICAgIHZhciBzU3RyaW5nID0gb0VudHJ5W2NhdGVnb3J5XTtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcInB1c2hpbmcgcnVsZSB3aXRoIFwiICsgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xuICAgICAgICAgICAgICAgIHZhciBvUnVsZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICAgICAgICAgIHdvcmQ6IHNTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAob01kbC5leGFjdG1hdGNoICYmIG9NZGwuZXhhY3RtYXRjaC5pbmRleE9mKGNhdGVnb3J5KSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9SdWxlLmV4YWN0T25seSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywgb1J1bGUsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgICAgIGlmIChvTWRsRGF0YS5zeW5vbnltcyAmJiBvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0pIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn1cbmZ1bmN0aW9uIGxvYWRNb2RlbChzTW9kZWxOYW1lLCBvTW9kZWwpIHtcbiAgICBkZWJ1Z2xvZyhcIiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSArIFwiIC4uLi5cIik7XG4gICAgdmFyIG1kbCA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLm1vZGVsLmpzb25cIiwgJ3V0Zi04Jyk7XG4gICAgdmFyIG9NZGwgPSBKU09OLnBhcnNlKG1kbCk7XG4gICAgaWYgKG9Nb2RlbC5kb21haW5zLmluZGV4T2Yob01kbC5kb21haW4pID49IDApIHtcbiAgICAgICAgZGVidWdsb2coXCIqKioqKioqKioqKmhlcmUgbWRsXCIgKyBKU09OLnN0cmluZ2lmeShvTWRsLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb21haW4gJyArIG9NZGwuZG9tYWluICsgJyBhbHJlYWR5IGxvYWRlZCB3aGlsZSBsb2FkaW5nICcgKyBzTW9kZWxOYW1lICsgJz8nKTtcbiAgICB9XG4gICAgLy8gYWRkIHJlbGF0aW9uIGRvbWFpbiAtPiBjYXRlZ29yeVxuICAgIHZhciBkb21haW5TdHIgPSBNZXRhRi5Eb21haW4ob01kbC5kb21haW4pLnRvRnVsbFN0cmluZygpO1xuICAgIHZhciByZWxhdGlvblN0ciA9IE1ldGFGLlJlbGF0aW9uKE1ldGEuUkVMQVRJT05faGFzQ2F0ZWdvcnkpLnRvRnVsbFN0cmluZygpO1xuICAgIHZhciByZXZlcnNlUmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikudG9GdWxsU3RyaW5nKCk7XG4gICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChzQ2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIENhdGVnb3J5U3RyaW5nID0gTWV0YUYuQ2F0ZWdvcnkoc0NhdGVnb3J5KS50b0Z1bGxTdHJpbmcoKTtcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdID0gb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdW0NhdGVnb3J5U3RyaW5nXSA9IHt9O1xuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ10gPSBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ10gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdID0gb01vZGVsLm1ldGEudDNbQ2F0ZWdvcnlTdHJpbmddW3JldmVyc2VSZWxhdGlvblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdW2RvbWFpblN0cl0gPSB7fTtcbiAgICB9KTtcbiAgICAvLyBhZGQgYSBwcmVjaWNlIGRvbWFpbiBtYXRjaHJ1bGVcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiZG9tYWluXCIsXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwuZG9tYWluLFxuICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgIHdvcmQ6IG9NZGwuZG9tYWluLFxuICAgICAgICBfcmFua2luZzogMC45NVxuICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIC8vIGV4dHJhY3QgdG9vbHMgYW4gYWRkIHRvIHRvb2xzOlxuICAgIG9Nb2RlbC50b29scy5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IChvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRvb2wgXCIgKyBvTWRsLnRvb2wubmFtZSArIFwiIGFscmVhZHkgcHJlc2VudCB3aGVuIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lKTtcbiAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdEb21haW4gYWxyZWFkeSBsb2FkZWQ/Jyk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXG4gICAgaWYgKCFvTWRsLnRvb2xoaWRkZW4gJiYgb01kbC50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFwidG9vbFwiLFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogb01kbC50b29sLm5hbWUsXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBvTWRsLnRvb2wubmFtZSxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH1cbiAgICA7XG4gICAgaWYgKG9NZGwuc3lub255bXMgJiYgb01kbC5zeW5vbnltc1tcInRvb2xcIl0pIHtcbiAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tcInRvb2xcIl0sIFwidG9vbFwiLCBvTWRsLnRvb2wubmFtZSwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgfVxuICAgIDtcbiAgICBpZiAob01kbC5zeW5vbnltcykge1xuICAgICAgICBPYmplY3Qua2V5cyhvTWRsLnN5bm9ueW1zKS5mb3JFYWNoKGZ1bmN0aW9uIChzc3lua2V5KSB7XG4gICAgICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNzeW5rZXkpID49IDAgJiYgc3N5bmtleSAhPT0gXCJ0b29sXCIpIHtcbiAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW3NzeW5rZXldLCBcImNhdGVnb3J5XCIsIHNzeW5rZXksIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgb01vZGVsLmRvbWFpbnMucHVzaChvTWRsLmRvbWFpbik7XG4gICAgaWYgKG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgIG9Nb2RlbC50b29scy5wdXNoKG9NZGwudG9vbCk7XG4gICAgfVxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5jb25jYXQob01kbC5jYXRlZ29yeSk7XG4gICAgb01vZGVsLmNhdGVnb3J5LnNvcnQoKTtcbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuZmlsdGVyKGZ1bmN0aW9uIChzdHJpbmcsIGluZGV4KSB7XG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcbiAgICB9KTtcbiAgICBsb2FkTW9kZWxEYXRhKG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCk7XG59IC8vIGxvYWRtb2RlbFxuZnVuY3Rpb24gbG9hZE1vZGVscygpIHtcbiAgICB2YXIgb01vZGVsO1xuICAgIG9Nb2RlbCA9IHtcbiAgICAgICAgZG9tYWluczogW10sXG4gICAgICAgIHRvb2xzOiBbXSxcbiAgICAgICAgY2F0ZWdvcnk6IFtdLFxuICAgICAgICBtUnVsZXM6IFtdLFxuICAgICAgICByZWNvcmRzOiBbXSxcbiAgICAgICAgbWV0YTogeyB0Mzoge30gfVxuICAgIH07XG4gICAgdmFyIHNtZGxzID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnL21vZGVscy5qc29uJywgJ3V0Zi04Jyk7XG4gICAgdmFyIG1kbHMgPSBKU09OLnBhcnNlKFwiXCIgKyBzbWRscyk7XG4gICAgbWRscy5mb3JFYWNoKGZ1bmN0aW9uIChzTW9kZWxOYW1lKSB7XG4gICAgICAgIGxvYWRNb2RlbChzTW9kZWxOYW1lLCBvTW9kZWwpO1xuICAgIH0pO1xuICAgIC8vIGFkZCB0aGUgY2F0ZWdvcmllcyB0byB0aGUgbW9kZWw6XG4gICAgb01vZGVsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiY2F0ZWdvcnlcIixcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IGNhdGVnb3J5LFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogY2F0ZWdvcnksXG4gICAgICAgICAgICBsb3dlcmNhc2V3b3JkOiBjYXRlZ29yeS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSBkb21haW4gbWV0YSBydWxlXG4gICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XG4gICAgICAgIGNhdGVnb3J5OiBcIm1ldGFcIixcbiAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJkb21haW5cIixcbiAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICB3b3JkOiBcImRvbWFpblwiLFxuICAgICAgICBfcmFua2luZzogMC45NVxuICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIC8vYWRkIGEgZmlsbGVyIHJ1bGVcbiAgICB2YXIgc2ZpbGxlcnMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvZmlsbGVyLmpzb24nLCAndXRmLTgnKTtcbiAgICB2YXIgZmlsbGVycyA9IEpTT04ucGFyc2Uoc2ZpbGxlcnMpO1xuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xuICAgIG9Nb2RlbC5tUnVsZXMucHVzaCh7XG4gICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxuICAgICAgICB0eXBlOiAxIC8qIFJFR0VYUCAqLyxcbiAgICAgICAgcmVnZXhwOiBuZXcgUmVnRXhwKHJlLCBcImlcIiksXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXG4gICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICB9KTtcbiAgICAvKlxuICAgICAgICB9KVxuICAgICAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiBcImZpbGxlclwiLFxuICAgICAgICAgIHR5cGU6IDEsXG4gICAgICAgICAgcmVnZXhwOiAvXigoc3RhcnQpfChzaG93KXwoZnJvbSl8KGluKSkkL2ksXG4gICAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJmaWxsZXJcIixcbiAgICAgICAgICBfcmFua2luZzogMC45XG4gICAgICAgIH0sXG4gICAgKi9cbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xuICAgIG9Nb2RlbC50b29scyA9IG9Nb2RlbC50b29scy5zb3J0KFRvb2xzLmNtcFRvb2xzKTtcbiAgICBkZWxldGUgb01vZGVsLnNlZW5SdWxlcztcbiAgICByZXR1cm4gb01vZGVsO1xufVxuZXhwb3J0cy5sb2FkTW9kZWxzID0gbG9hZE1vZGVscztcbnZhciBNZXRhRiA9IE1ldGEuZ2V0TWV0YUZhY3RvcnkoKTtcbmZ1bmN0aW9uIGdldFJlc3VsdEFzQXJyYXkobWRsLCBhLCByZWwpIHtcbiAgICBpZiAocmVsLnRvVHlwZSgpICE9PSAncmVsYXRpb24nKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImV4cGVjdCByZWxhdGlvbiBhcyAybmQgYXJnXCIpO1xuICAgIH1cbiAgICB2YXIgcmVzID0gbWRsLm1ldGEudDNbYS50b0Z1bGxTdHJpbmcoKV0gJiZcbiAgICAgICAgbWRsLm1ldGEudDNbYS50b0Z1bGxTdHJpbmcoKV1bcmVsLnRvRnVsbFN0cmluZygpXTtcbiAgICBpZiAoIXJlcykge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhyZXMpLnNvcnQoKS5tYXAoTWV0YUYucGFyc2VJTWV0YSk7XG59XG5leHBvcnRzLmdldFJlc3VsdEFzQXJyYXkgPSBnZXRSZXN1bHRBc0FycmF5O1xuZnVuY3Rpb24gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbih0aGVNb2RlbCwgZG9tYWluKSB7XG4gICAgaWYgKHRoZU1vZGVsLmRvbWFpbnMuaW5kZXhPZihkb21haW4pIDwgMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEb21haW4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xuICAgIH1cbiAgICB2YXIgcmVzID0gZ2V0UmVzdWx0QXNBcnJheSh0aGVNb2RlbCwgTWV0YUYuRG9tYWluKGRvbWFpbiksIE1ldGFGLlJlbGF0aW9uKE1ldGEuUkVMQVRJT05faGFzQ2F0ZWdvcnkpKTtcbiAgICByZXR1cm4gTWV0YS5nZXRTdHJpbmdBcnJheShyZXMpO1xufVxuZXhwb3J0cy5nZXRDYXRlZ29yaWVzRm9yRG9tYWluID0gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbjtcbmZ1bmN0aW9uIGdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbCwgY2F0ZWdvcnkpIHtcbiAgICBpZiAodGhlTW9kZWwuY2F0ZWdvcnkuaW5kZXhPZihjYXRlZ29yeSkgPCAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhdGVnb3J5IFxcXCJcIiArIGNhdGVnb3J5ICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xuICAgIH1cbiAgICB2YXIgcmVzID0gZ2V0UmVzdWx0QXNBcnJheSh0aGVNb2RlbCwgTWV0YUYuQ2F0ZWdvcnkoY2F0ZWdvcnkpLCBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikpO1xuICAgIHJldHVybiBNZXRhLmdldFN0cmluZ0FycmF5KHJlcyk7XG59XG5leHBvcnRzLmdldERvbWFpbnNGb3JDYXRlZ29yeSA9IGdldERvbWFpbnNGb3JDYXRlZ29yeTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
