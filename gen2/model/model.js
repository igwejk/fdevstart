/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require('debug');
var debuglog = debug('model');
var logger = require('../utils/logger');
var loadlog = logger.logger('modelload', '');
var IMatch = require('../match/ifmatch');
var InputFilterRules = require('../match/inputFilterRules');
var Tools = require('../match/tools');
var fs = require('fs');
var Meta = require('./meta');
var Utils = require('../utils/utils');
var process = require('process');
var _ = require('lodash');
/**
 * the model path, may be controlled via environment variable
 */
var envModelPath = process.env["ABOT_MODELPATH"] || "testmodel";
;
var ARR_MODEL_PROPERTIES = ["domain", "tool", "toolhidden", "synonyms", "category", "wordindex", "exactmatch", "hidden"];
function addSynonyms(synonyms, category, synonymFor, mRules, seen) {
    synonyms.forEach(function (syn) {
        var oRule = {
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            _ranking: 0.95
        };
        debuglog("inserting synonym" + JSON.stringify(oRule));
        insertRuleIfNotPresent(mRules, oRule, seen);
    });
}
function getRuleKey(rule) {
    return rule.matchedString + "-|-" + rule.category + " -|- " + rule.type + " -|- " + rule.word + " ";
}
function insertRuleIfNotPresent(mRules, rule, seenRules) {
    if (rule.type !== 0 /* WORD */) {
            mRules.push(rule);
            return;
        }
    if (rule.word === undefined || rule.matchedString === undefined) {
        throw new Error('illegal rule' + JSON.stringify(rule, undefined, 2));
    }
    var r = getRuleKey(rule);
    rule.lowercaseword = rule.word.toLowerCase();
    if (seenRules[r]) {
        debuglog("Attempting to insert duplicate" + JSON.stringify(rule, undefined, 2));
        var duplicates = seenRules[r].filter(function (oEntry) {
            return 0 === InputFilterRules.compareMRuleFull(oEntry, rule);
        });
        if (duplicates.length > 0) {
            return;
        }
    }
    seenRules[r] = seenRules[r] || [];
    seenRules[r].push(rule);
    if (rule.word === "") {
        debuglog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        loadlog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        return;
    }
    mRules.push(rule);
    return;
}
function loadModelData(modelPath, oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var sFileName = './' + modelPath + '/' + sModelName + ".data.json";
    var mdldata = fs.readFileSync(sFileName, 'utf-8');
    var oMdlData = JSON.parse(mdldata);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.tool && oMdl.tool.name) {
            oEntry.tool = oMdl.tool.name;
            oEntry._domain = oMdl.domain;
        }
        oModel.records.push(oEntry);
        oMdl.category.forEach(function (cat) {
            if (oEntry[cat] === 'undefined') {
                oEntry[cat] = "n/a";
                var bug = "INCONSISTENT*> ModelData " + sFileName + " does not contain category " + cat + " with value 'undefined', undefined is illegal value, use n/a " + JSON.stringify(oEntry) + "";
                debuglog(bug);
            }
        });
        oMdl.wordindex.forEach(function (category) {
            if (oEntry[category] === undefined) {
                debuglog("INCONSISTENT*> ModelData " + sFileName + " does not contain category " + category + " of wordindex" + JSON.stringify(oEntry) + "");
                return;
            }
            if (oEntry[category] !== "*") {
                var sString = oEntry[category];
                debuglog("pushing rule with " + category + " -> " + sString);
                var oRule = {
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    _ranking: 0.95
                };
                if (oMdl.exactmatch && oMdl.exactmatch.indexOf(category) >= 0) {
                    oRule.exactOnly = true;
                }
                insertRuleIfNotPresent(oModel.mRules, oRule, oModel.seenRules);
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, oModel.mRules, oModel.seenRules);
                }
                if (oEntry.synonyms && oEntry.synonyms[category]) {
                    addSynonyms(oEntry.synonyms[category], category, sString, oModel.mRules, oModel.seenRules);
                }
            }
        });
    });
}
function loadModel(modelPath, sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var mdl = fs.readFileSync('./' + modelPath + '/' + sModelName + ".model.json", 'utf-8');
    var oMdl = JSON.parse(mdl);
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // check properties of model
    Object.keys(oMdl).sort().forEach(function (sProperty) {
        if (ARR_MODEL_PROPERTIES.indexOf(sProperty) < 0) {
            throw new Error('Model property "' + sProperty + '" not a known model propperty in model of domain ' + oMdl.domain + ' ');
        }
    });
    // check that members of wordindex are in categories,
    oMdl.wordindex = oMdl.wordindex || [];
    oMdl.wordindex.forEach(function (sWordIndex) {
        if (oMdl.category.indexOf(sWordIndex) < 0) {
            throw new Error('Model wordindex "' + sWordIndex + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    oMdl.exactmatch = oMdl.exactmatch || [];
    oMdl.exactmatch.forEach(function (sExactMatch) {
        if (oMdl.category.indexOf(sExactMatch) < 0) {
            throw new Error('Model exactmatch "' + sExactMatch + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    // add relation domain -> category
    var domainStr = MetaF.Domain(oMdl.domain).toFullString();
    var relationStr = MetaF.Relation(Meta.RELATION_hasCategory).toFullString();
    var reverseRelationStr = MetaF.Relation(Meta.RELATION_isCategoryOf).toFullString();
    oMdl.category.forEach(function (sCategory) {
        var CategoryString = MetaF.Category(sCategory).toFullString();
        oModel.meta.t3[domainStr] = oModel.meta.t3[domainStr] || {};
        oModel.meta.t3[domainStr][relationStr] = oModel.meta.t3[domainStr][relationStr] || {};
        oModel.meta.t3[domainStr][relationStr][CategoryString] = {};
        oModel.meta.t3[CategoryString] = oModel.meta.t3[CategoryString] || {};
        oModel.meta.t3[CategoryString][reverseRelationStr] = oModel.meta.t3[CategoryString][reverseRelationStr] || {};
        oModel.meta.t3[CategoryString][reverseRelationStr][domainStr] = {};
    });
    // add a precice domain matchrule
    insertRuleIfNotPresent(oModel.mRules, {
        category: "domain",
        matchedString: oMdl.domain,
        type: 0 /* WORD */
        , word: oMdl.domain,
        _ranking: 0.95
    }, oModel.seenRules);
    // extract tools an add to tools:
    oModel.tools.filter(function (oEntry) {
        if (oEntry.name === (oMdl.tool && oMdl.tool.name)) {
            console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
            //throw new Error('Domain already loaded?');
            process.exit(-1);
        }
    });
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden && oMdl.tool && oMdl.tool.name) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            _ranking: 0.95
        }, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oModel.mRules, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oModel.mRules, oModel.seenRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    if (oMdl.tool.name) {
        oModel.tools.push(oMdl.tool);
    }
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
    loadModelData(modelPath, oMdl, sModelName, oModel);
} // loadmodel
function splitRules(rules) {
    var res = {};
    var nonWordRules = [];
    rules.forEach(function (rule) {
        if (rule.type === 0 /* WORD */) {
                if (!rule.lowercaseword) {
                    throw new Error("Rule has no member lowercaseword" + JSON.stringify(rule));
                }
                res[rule.lowercaseword] = res[rule.lowercaseword] || [];
                res[rule.lowercaseword].push(rule);
            } else {
            nonWordRules.push(rule);
        }
    });
    return {
        wordMap: res,
        nonWordRules: nonWordRules,
        allRules: rules
    };
}
exports.splitRules = splitRules;
function loadModels(modelPath) {
    var oModel;
    oModel = {
        domains: [],
        tools: [],
        rules: undefined,
        category: [],
        operators: {},
        mRules: [],
        seenRules: {},
        records: [],
        meta: { t3: {} }
    };
    modelPath = modelPath || envModelPath;
    var smdls = fs.readFileSync('./' + modelPath + '/models.json', 'utf-8');
    var mdls = JSON.parse("" + smdls);
    mdls.forEach(function (sModelName) {
        loadModel(modelPath, sModelName, oModel);
    });
    // add the categories to the model:
    oModel.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            lowercaseword: category.toLowerCase(),
            _ranking: 0.95
        }, oModel.seenRules);
    });
    // add the domain meta rule
    insertRuleIfNotPresent(oModel.mRules, {
        category: "meta",
        matchedString: "domain",
        type: 0 /* WORD */
        , word: "domain",
        _ranking: 0.95
    }, oModel.seenRules);
    //add a filler rule
    var sfillers = fs.readFileSync('./' + modelPath + '/filler.json', 'utf-8');
    var fillers = JSON.parse(sfillers);
    var re = "^((" + fillers.join(")|(") + "))$";
    oModel.mRules.push({
        category: "filler",
        type: 1 /* REGEXP */
        , regexp: new RegExp(re, "i"),
        matchedString: "filler",
        _ranking: 0.9
    });
    //add operators
    var sOperators = fs.readFileSync('./resources/model/operators.json', 'utf-8');
    var operators = JSON.parse(sOperators);
    Object.keys(operators.operators).forEach(function (operator) {
        if (IMatch.aOperatorNames.indexOf(operator) < 0) {
            debuglog("unknown operator " + operator);
            throw new Error("unknown operator " + operator);
        }
        oModel.operators[operator] = operators.operators[operator];
        oModel.operators[operator].operator = operator;
        Object.freeze(oModel.operators[operator]);
        var word = operator;
        insertRuleIfNotPresent(oModel.mRules, {
            category: "operator",
            word: word.toLowerCase(),
            lowercaseword: word.toLowerCase(),
            type: 0 /* WORD */
            , matchedString: word,
            _ranking: 0.9
        }, oModel.seenRules);
        // add all synonyms
        if (operators.synonyms[operator]) {
            Object.keys(operators.synonyms[operator]).forEach(function (synonym) {
                insertRuleIfNotPresent(oModel.mRules, {
                    category: "operator",
                    word: synonym.toLowerCase(),
                    lowercaseword: synonym.toLowerCase(),
                    type: 0 /* WORD */
                    , matchedString: operator,
                    _ranking: 0.9
                }, oModel.seenRules);
            });
        }
    });
    /*
        })
            {
          category: "filler",
          type: 1,
          regexp: /^((start)|(show)|(from)|(in))$/i,
          matchedString: "filler",
          _ranking: 0.9
        },
    */
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    oModel.rules = splitRules(oModel.mRules);
    oModel.tools = oModel.tools.sort(Tools.cmpTools);
    delete oModel.seenRules;
    return oModel;
}
exports.loadModels = loadModels;
var MetaF = Meta.getMetaFactory();
function getOperator(mdl, operator) {
    return mdl.operators[operator];
}
exports.getOperator = getOperator;
function getResultAsArray(mdl, a, rel) {
    if (rel.toType() !== 'relation') {
        throw new Error("expect relation as 2nd arg");
    }
    var res = mdl.meta.t3[a.toFullString()] && mdl.meta.t3[a.toFullString()][rel.toFullString()];
    if (!res) {
        return [];
    }
    return Object.getOwnPropertyNames(res).sort().map(MetaF.parseIMeta);
}
exports.getResultAsArray = getResultAsArray;
function getCategoriesForDomain(theModel, domain) {
    if (theModel.domains.indexOf(domain) < 0) {
        throw new Error("Domain \"" + domain + "\" not part of model");
    }
    var res = getResultAsArray(theModel, MetaF.Domain(domain), MetaF.Relation(Meta.RELATION_hasCategory));
    return Meta.getStringArray(res);
}
exports.getCategoriesForDomain = getCategoriesForDomain;
/**
 * Return all categories of a domain which can appear on a word,
 * these are typically the wordindex domains + entries generated by generic rules
 *
 * The current implementation is a simplification
 */
function getPotentialWordCategoriesForDomain(theModel, domain) {
    // this is a simplified version
    return getCategoriesForDomain(theModel, domain);
}
exports.getPotentialWordCategoriesForDomain = getPotentialWordCategoriesForDomain;
function getDomainsForCategory(theModel, category) {
    if (theModel.category.indexOf(category) < 0) {
        throw new Error("Category \"" + category + "\" not part of model");
    }
    var res = getResultAsArray(theModel, MetaF.Category(category), MetaF.Relation(Meta.RELATION_isCategoryOf));
    return Meta.getStringArray(res);
}
exports.getDomainsForCategory = getDomainsForCategory;
function getAllRecordCategoriesForTargetCategory(model, category, wordsonly) {
    var res = {};
    //
    var fn = wordsonly ? getPotentialWordCategoriesForDomain : getCategoriesForDomain;
    var domains = getDomainsForCategory(model, category);
    domains.forEach(function (domain) {
        fn(model, domain).forEach(function (wordcat) {
            res[wordcat] = true;
        });
    });
    Object.freeze(res);
    return res;
}
exports.getAllRecordCategoriesForTargetCategory = getAllRecordCategoriesForTargetCategory;
function getAllRecordCategoriesForTargetCategories(model, categories, wordsonly) {
    var res = {};
    //
    var fn = wordsonly ? getPotentialWordCategoriesForDomain : getCategoriesForDomain;
    var domains = undefined;
    categories.forEach(function (category) {
        var catdomains = getDomainsForCategory(model, category);
        if (!domains) {
            domains = catdomains;
        } else {
            domains = _.intersection(domains, catdomains);
        }
    });
    if (domains.length === 0) {
        throw new Error('categories ' + Utils.listToQuotedCommaAnd(categories) + ' have no common domain.');
    }
    domains.forEach(function (domain) {
        fn(model, domain).forEach(function (wordcat) {
            res[wordcat] = true;
        });
    });
    Object.freeze(res);
    return res;
}
exports.getAllRecordCategoriesForTargetCategories = getAllRecordCategoriesForTargetCategories;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwibG9nZ2VyIiwibG9hZGxvZyIsIklNYXRjaCIsIklucHV0RmlsdGVyUnVsZXMiLCJUb29scyIsImZzIiwiTWV0YSIsIlV0aWxzIiwicHJvY2VzcyIsIl8iLCJlbnZNb2RlbFBhdGgiLCJlbnYiLCJBUlJfTU9ERUxfUFJPUEVSVElFUyIsImFkZFN5bm9ueW1zIiwic3lub255bXMiLCJjYXRlZ29yeSIsInN5bm9ueW1Gb3IiLCJtUnVsZXMiLCJzZWVuIiwiZm9yRWFjaCIsInN5biIsIm9SdWxlIiwibWF0Y2hlZFN0cmluZyIsInR5cGUiLCJ3b3JkIiwiX3JhbmtpbmciLCJKU09OIiwic3RyaW5naWZ5IiwiaW5zZXJ0UnVsZUlmTm90UHJlc2VudCIsImdldFJ1bGVLZXkiLCJydWxlIiwic2VlblJ1bGVzIiwicHVzaCIsInVuZGVmaW5lZCIsIkVycm9yIiwiciIsImxvd2VyY2FzZXdvcmQiLCJ0b0xvd2VyQ2FzZSIsImR1cGxpY2F0ZXMiLCJmaWx0ZXIiLCJvRW50cnkiLCJjb21wYXJlTVJ1bGVGdWxsIiwibGVuZ3RoIiwibG9hZE1vZGVsRGF0YSIsIm1vZGVsUGF0aCIsIm9NZGwiLCJzTW9kZWxOYW1lIiwib01vZGVsIiwic0ZpbGVOYW1lIiwibWRsZGF0YSIsInJlYWRGaWxlU3luYyIsIm9NZGxEYXRhIiwicGFyc2UiLCJ0b29sIiwibmFtZSIsIl9kb21haW4iLCJkb21haW4iLCJyZWNvcmRzIiwiY2F0IiwiYnVnIiwid29yZGluZGV4Iiwic1N0cmluZyIsImV4YWN0bWF0Y2giLCJpbmRleE9mIiwiZXhhY3RPbmx5IiwibG9hZE1vZGVsIiwibWRsIiwiZG9tYWlucyIsIk9iamVjdCIsImtleXMiLCJzb3J0Iiwic1Byb3BlcnR5Iiwic1dvcmRJbmRleCIsInNFeGFjdE1hdGNoIiwiZG9tYWluU3RyIiwiTWV0YUYiLCJEb21haW4iLCJ0b0Z1bGxTdHJpbmciLCJyZWxhdGlvblN0ciIsIlJlbGF0aW9uIiwiUkVMQVRJT05faGFzQ2F0ZWdvcnkiLCJyZXZlcnNlUmVsYXRpb25TdHIiLCJSRUxBVElPTl9pc0NhdGVnb3J5T2YiLCJzQ2F0ZWdvcnkiLCJDYXRlZ29yeVN0cmluZyIsIkNhdGVnb3J5IiwibWV0YSIsInQzIiwidG9vbHMiLCJjb25zb2xlIiwibG9nIiwiZXhpdCIsInRvb2xoaWRkZW4iLCJzc3lua2V5IiwiY29uY2F0Iiwic3RyaW5nIiwiaW5kZXgiLCJzcGxpdFJ1bGVzIiwicnVsZXMiLCJyZXMiLCJub25Xb3JkUnVsZXMiLCJ3b3JkTWFwIiwiYWxsUnVsZXMiLCJleHBvcnRzIiwibG9hZE1vZGVscyIsIm9wZXJhdG9ycyIsInNtZGxzIiwibWRscyIsInNmaWxsZXJzIiwiZmlsbGVycyIsInJlIiwiam9pbiIsInJlZ2V4cCIsIlJlZ0V4cCIsInNPcGVyYXRvcnMiLCJvcGVyYXRvciIsImFPcGVyYXRvck5hbWVzIiwiZnJlZXplIiwic3lub255bSIsImNtcE1SdWxlIiwiY21wVG9vbHMiLCJnZXRNZXRhRmFjdG9yeSIsImdldE9wZXJhdG9yIiwiZ2V0UmVzdWx0QXNBcnJheSIsImEiLCJyZWwiLCJ0b1R5cGUiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwibWFwIiwicGFyc2VJTWV0YSIsImdldENhdGVnb3JpZXNGb3JEb21haW4iLCJ0aGVNb2RlbCIsImdldFN0cmluZ0FycmF5IiwiZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4iLCJnZXREb21haW5zRm9yQ2F0ZWdvcnkiLCJnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcnkiLCJtb2RlbCIsIndvcmRzb25seSIsImZuIiwid29yZGNhdCIsImdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yaWVzIiwiY2F0ZWdvcmllcyIsImNhdGRvbWFpbnMiLCJpbnRlcnNlY3Rpb24iLCJsaXN0VG9RdW90ZWRDb21tYUFu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QUFJdEMsTUFBTSxFQUFWO0FBQ0E7QUFDQSxRQUFJdUMsS0FBS0QsWUFBWUosbUNBQVosR0FBa0RILHNCQUEzRDtBQUNBLFFBQUkvRCxVQUFVbEMsU0FBZDtBQUNBNEcsZUFBVzFILE9BQVgsQ0FBbUIsVUFBU0osUUFBVCxFQUFpQjtBQUNoQyxZQUFJK0gsYUFBYVIsc0JBQXNCRSxLQUF0QixFQUE2QnpILFFBQTdCLENBQWpCO0FBQ0EsWUFBRyxDQUFDb0QsT0FBSixFQUFhO0FBQ1RBLHNCQUFVMkUsVUFBVjtBQUNILFNBRkQsTUFFTztBQUNIM0Usc0JBQVUxRCxFQUFFc0ksWUFBRixDQUFlNUUsT0FBZixFQUF3QjJFLFVBQXhCLENBQVY7QUFDSDtBQUNKLEtBUEQ7QUFRQSxRQUFHM0UsUUFBUXpCLE1BQVIsS0FBbUIsQ0FBdEIsRUFBeUI7QUFDckIsY0FBTSxJQUFJUixLQUFKLENBQVUsZ0JBQWdCM0IsTUFBTXlJLG9CQUFOLENBQTJCSCxVQUEzQixDQUFoQixHQUF5RCx5QkFBbkUsQ0FBTjtBQUNIO0FBQ0QxRSxZQUFRaEQsT0FBUixDQUFnQixVQUFTcUMsTUFBVCxFQUFlO0FBQzNCa0YsV0FBR0YsS0FBSCxFQUFVaEYsTUFBVixFQUFrQnJDLE9BQWxCLENBQTBCLFVBQVN3SCxPQUFULEVBQWdCO0FBQ3RDeEMsZ0JBQUl3QyxPQUFKLElBQWUsSUFBZjtBQUNILFNBRkQ7QUFHSCxLQUpEO0FBS0F2RSxXQUFPaUQsTUFBUCxDQUFjbEIsR0FBZDtBQUNBLFdBQU9BLEdBQVA7QUFDRjtBQXZCZUksUUFBQXFDLHlDQUFBLEdBQXlDQSx5Q0FBekMiLCJmaWxlIjoibW9kZWwvbW9kZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRnVuY3Rpb25hbGl0eSBtYW5hZ2luZyB0aGUgbWF0Y2ggbW9kZWxzXHJcbiAqXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcblxyXG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9kZWwnKTtcclxuXHJcbmltcG9ydCAqIGFzIGxvZ2dlciBmcm9tICcuLi91dGlscy9sb2dnZXInO1xyXG5cclxuY29uc3QgbG9hZGxvZyA9IGxvZ2dlci5sb2dnZXIoJ21vZGVsbG9hZCcsICcnKTtcclxuXHJcbmltcG9ydCAqICBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XHJcbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4uL21hdGNoL21hdGNoJztcclxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXJSdWxlcyBmcm9tICcuLi9tYXRjaC9pbnB1dEZpbHRlclJ1bGVzJztcclxuaW1wb3J0ICogYXMgVG9vbHMgZnJvbSAnLi4vbWF0Y2gvdG9vbHMnO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XHJcbmltcG9ydCAqIGFzIE1ldGEgZnJvbSAnLi9tZXRhJztcclxuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xyXG5pbXBvcnQgKiBhcyBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XHJcblxyXG4vKipcclxuICogdGhlIG1vZGVsIHBhdGgsIG1heSBiZSBjb250cm9sbGVkIHZpYSBlbnZpcm9ubWVudCB2YXJpYWJsZVxyXG4gKi9cclxudmFyIGVudk1vZGVsUGF0aCA9IHByb2Nlc3MuZW52W1wiQUJPVF9NT0RFTFBBVEhcIl0gfHwgXCJ0ZXN0bW9kZWxcIjtcclxuXHJcbi8vZXhwb3J0IGludGVyZmFjZSBJTW9kZWxzID0gTWF0Y2guSU1vZGVscztcclxuXHJcbi8qXHJcbmV4cG9ydCBpbnRlcmZhY2UgSU1vZGVscyB7XHJcbiAgICBkb21haW5zOiBzdHJpbmdbXSxcclxuICAgIHRvb2xzOiBJTWF0Y2guSVRvb2xbXSxcclxuICAgIGNhdGVnb3J5OiBzdHJpbmdbXSxcclxuICAgIG1SdWxlczogSU1hdGNoLm1SdWxlW10sXHJcbiAgICByZWNvcmRzOiBhbnlbXVxyXG4gICAgc2VlblJ1bGVzPzogeyBba2V5OiBzdHJpbmddOiBJTWF0Y2gubVJ1bGUgfSxcclxuICAgIG1ldGEgOiB7XHJcbiAgICAgICAgLy8gZW50aXR5IC0+IHJlbGF0aW9uIC0+IHRhcmdldFxyXG4gICAgICAgIHQzIDogeyBba2V5OiBzdHJpbmddIDogeyBba2V5IDogc3RyaW5nXSA6IGFueSB9fVxyXG4gICAgfVxyXG59Ki9cclxuXHJcbmludGVyZmFjZSBJTW9kZWwge1xyXG4gICAgZG9tYWluOiBzdHJpbmcsXHJcbiAgICB0b29sOiBJTWF0Y2guSVRvb2wsXHJcbiAgICB0b29saGlkZGVuPzogYm9vbGVhbixcclxuICAgIHN5bm9ueW1zPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmdbXSB9LFxyXG4gICAgY2F0ZWdvcnk6IHN0cmluZ1tdLFxyXG4gICAgd29yZGluZGV4OiBzdHJpbmdbXSxcclxuICAgIGV4YWN0bWF0Y2g/IDogc3RyaW5nW10sXHJcbiAgICBoaWRkZW46IHN0cmluZ1tdXHJcbn07XHJcblxyXG5jb25zdCBBUlJfTU9ERUxfUFJPUEVSVElFUyA9IFtcImRvbWFpblwiLCBcInRvb2xcIiwgXCJ0b29saGlkZGVuXCIsIFwic3lub255bXNcIiwgXCJjYXRlZ29yeVwiLCBcIndvcmRpbmRleFwiLCBcImV4YWN0bWF0Y2hcIiwgXCJoaWRkZW5cIl07XHJcblxyXG5mdW5jdGlvbiBhZGRTeW5vbnltcyhzeW5vbnltczogc3RyaW5nW10sIGNhdGVnb3J5OiBzdHJpbmcsIHN5bm9ueW1Gb3I6IHN0cmluZywgbVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCBzZWVuOiB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5tUnVsZVtdIH0pIHtcclxuICAgIHN5bm9ueW1zLmZvckVhY2goZnVuY3Rpb24gKHN5bikge1xyXG4gICAgICAgIHZhciBvUnVsZSA9IHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzeW5vbnltRm9yLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIHdvcmQ6IHN5bixcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9O1xyXG4gICAgICAgIGRlYnVnbG9nKFwiaW5zZXJ0aW5nIHN5bm9ueW1cIiArIEpTT04uc3RyaW5naWZ5KG9SdWxlKSk7XHJcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIG9SdWxlLCBzZWVuKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRSdWxlS2V5KHJ1bGUpIHtcclxuICAgIHJldHVybiBydWxlLm1hdGNoZWRTdHJpbmcgKyBcIi18LVwiICsgcnVsZS5jYXRlZ29yeSArIFwiIC18LSBcIiArIHJ1bGUudHlwZSAgKyBcIiAtfC0gXCIgKyBydWxlLndvcmQgKyBcIiBcIjtcclxufVxyXG5cclxuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4sIHJ1bGU6IElNYXRjaC5tUnVsZSxcclxuICAgIHNlZW5SdWxlczogeyBba2V5OiBzdHJpbmddOiBJTWF0Y2gubVJ1bGVbXSB9KSB7XHJcblxyXG4gICAgaWYgKHJ1bGUudHlwZSAhPT0gSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JEKSB7XHJcbiAgICAgICAgbVJ1bGVzLnB1c2gocnVsZSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKChydWxlLndvcmQgPT09IHVuZGVmaW5lZCkgfHwgKHJ1bGUubWF0Y2hlZFN0cmluZyA9PT0gdW5kZWZpbmVkKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgfVxyXG4gICAgdmFyIHIgPSBnZXRSdWxlS2V5KHJ1bGUpO1xyXG4gICAgcnVsZS5sb3dlcmNhc2V3b3JkID0gcnVsZS53b3JkLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBpZiAoc2VlblJ1bGVzW3JdKSB7XHJcbiAgICAgICAgZGVidWdsb2coXCJBdHRlbXB0aW5nIHRvIGluc2VydCBkdXBsaWNhdGVcIiArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgICAgIHZhciBkdXBsaWNhdGVzID0gc2VlblJ1bGVzW3JdLmZpbHRlcihmdW5jdGlvbiggb0VudHJ5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwID09PSBJbnB1dEZpbHRlclJ1bGVzLmNvbXBhcmVNUnVsZUZ1bGwob0VudHJ5LHJ1bGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmKGR1cGxpY2F0ZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc2VlblJ1bGVzW3JdID0gKHNlZW5SdWxlc1tyXSB8fCBbXSk7XHJcbiAgICBzZWVuUnVsZXNbcl0ucHVzaChydWxlKTtcclxuICAgIGlmIChydWxlLndvcmQgPT09IFwiXCIpIHtcclxuICAgICAgICBkZWJ1Z2xvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgICAgIGxvYWRsb2coJ1NraXBwaW5nIHJ1bGUgd2l0aCBlbXRweSB3b3JkICcgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBtUnVsZXMucHVzaChydWxlKTtcclxuICAgIHJldHVybjtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZE1vZGVsRGF0YShtb2RlbFBhdGg6IHN0cmluZywgb01kbDogSU1vZGVsLCBzTW9kZWxOYW1lOiBzdHJpbmcsIG9Nb2RlbDogSU1hdGNoLklNb2RlbHMpIHtcclxuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cclxuICAgIC8vIGRhdGEgaXMgcHJvY2Vzc2VkIGludG8gbVJ1bGVzIGRpcmVjdGx5LFxyXG4gICAgY29uc3Qgc0ZpbGVOYW1lID0gKCcuLycgKyBtb2RlbFBhdGggKyAnLycgKyBzTW9kZWxOYW1lICsgXCIuZGF0YS5qc29uXCIpO1xyXG4gICAgdmFyIG1kbGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoc0ZpbGVOYW1lLCAndXRmLTgnKTtcclxuICAgIHZhciBvTWRsRGF0YSA9IEpTT04ucGFyc2UobWRsZGF0YSk7XHJcbiAgICBvTWRsRGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICBpZiAoIW9FbnRyeS50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XHJcbiAgICAgICAgICAgIG9FbnRyeS50b29sID0gb01kbC50b29sLm5hbWU7XHJcbiAgICAgICAgICAgIG9FbnRyeS5fZG9tYWluID0gb01kbC5kb21haW47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9Nb2RlbC5yZWNvcmRzLnB1c2gob0VudHJ5KTtcclxuICAgICAgICBvTWRsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24oY2F0KSB7XHJcbiAgICAgICAgICAgIGlmKG9FbnRyeVtjYXRdID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgICAgICAgb0VudHJ5W2NhdF0gPSBcIm4vYVwiO1xyXG4gICAgICAgICAgICAgICAgdmFyIGJ1ZyA9XHJcbiAgICAgICAgICAgICAgICAgICAgXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiICsgY2F0ICsgXCIgd2l0aCB2YWx1ZSAndW5kZWZpbmVkJywgdW5kZWZpbmVkIGlzIGlsbGVnYWwgdmFsdWUsIHVzZSBuL2EgXCIgKyBKU09OLnN0cmluZ2lmeShvRW50cnkpICsgXCJcIjtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKGJ1Zyk7XHJcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGJ1Zyk7XHJcbiAgICAgICAgICAgICAgICAvL3Byb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xyXG4gICAgICAgICAgICBpZiAob0VudHJ5W2NhdGVnb3J5XSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIklOQ09OU0lTVEVOVCo+IE1vZGVsRGF0YSBcIiArIHNGaWxlTmFtZSArIFwiIGRvZXMgbm90IGNvbnRhaW4gY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIG9mIHdvcmRpbmRleFwiICsgSlNPTi5zdHJpbmdpZnkob0VudHJ5KSArIFwiXCIpXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gIT09IFwiKlwiKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc1N0cmluZyA9IG9FbnRyeVtjYXRlZ29yeV07XHJcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcInB1c2hpbmcgcnVsZSB3aXRoIFwiICsgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xyXG4gICAgICAgICAgICAgICAgdmFyIG9SdWxlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHNTdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgd29yZDogc1N0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICAgICAgICAgICAgICB9IGFzIElNYXRjaC5tUnVsZTtcclxuICAgICAgICAgICAgICAgIGlmKG9NZGwuZXhhY3RtYXRjaCAmJiBvTWRsLmV4YWN0bWF0Y2guaW5kZXhPZihjYXRlZ29yeSkgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG9SdWxlLmV4YWN0T25seSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsb1J1bGUsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9NZGxEYXRhLnN5bm9ueW1zICYmIG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSwgY2F0ZWdvcnksIHNTdHJpbmcsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG9FbnRyeS5zeW5vbnltcyAmJiBvRW50cnkuc3lub255bXNbY2F0ZWdvcnldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob0VudHJ5LnN5bm9ueW1zW2NhdGVnb3J5XSwgY2F0ZWdvcnksIHNTdHJpbmcsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZE1vZGVsKG1vZGVsUGF0aCA6IHN0cmluZywgc01vZGVsTmFtZTogc3RyaW5nLCBvTW9kZWw6IElNYXRjaC5JTW9kZWxzKSB7XHJcbiAgICBkZWJ1Z2xvZyhcIiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSArIFwiIC4uLi5cIik7XHJcbiAgICB2YXIgbWRsID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnLycgKyBzTW9kZWxOYW1lICsgXCIubW9kZWwuanNvblwiLCAndXRmLTgnKTtcclxuICAgIHZhciBvTWRsID0gSlNPTi5wYXJzZShtZGwpIGFzIElNb2RlbDtcclxuXHJcbiAgICBpZiAob01vZGVsLmRvbWFpbnMuaW5kZXhPZihvTWRsLmRvbWFpbikgPj0gMCkge1xyXG4gICAgICAgIGRlYnVnbG9nKFwiKioqKioqKioqKipoZXJlIG1kbFwiICsgSlNPTi5zdHJpbmdpZnkob01kbCwgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb21haW4gJyArIG9NZGwuZG9tYWluICsgJyBhbHJlYWR5IGxvYWRlZCB3aGlsZSBsb2FkaW5nICcgKyBzTW9kZWxOYW1lICsgJz8nKTtcclxuICAgIH1cclxuICAgIC8vIGNoZWNrIHByb3BlcnRpZXMgb2YgbW9kZWxcclxuICAgIE9iamVjdC5rZXlzKG9NZGwpLnNvcnQoKS5mb3JFYWNoKGZ1bmN0aW9uKHNQcm9wZXJ0eSkge1xyXG4gICAgICAgIGlmKEFSUl9NT0RFTF9QUk9QRVJUSUVTLmluZGV4T2Yoc1Byb3BlcnR5KSA8IDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNb2RlbCBwcm9wZXJ0eSBcIicgKyBzUHJvcGVydHkgKyAnXCIgbm90IGEga25vd24gbW9kZWwgcHJvcHBlcnR5IGluIG1vZGVsIG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8gY2hlY2sgdGhhdCBtZW1iZXJzIG9mIHdvcmRpbmRleCBhcmUgaW4gY2F0ZWdvcmllcyxcclxuICAgIG9NZGwud29yZGluZGV4ID0gb01kbC53b3JkaW5kZXggfHwgW107XHJcbiAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uKHNXb3JkSW5kZXgpIHtcclxuICAgICAgICBpZihvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc1dvcmRJbmRleCkgPCAwKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgd29yZGluZGV4IFwiJyArIHNXb3JkSW5kZXggKyAnXCIgbm90IGEgY2F0ZWdvcnkgb2YgZG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBvTWRsLmV4YWN0bWF0Y2ggPSBvTWRsLmV4YWN0bWF0Y2ggfHwgW107XHJcbiAgICBvTWRsLmV4YWN0bWF0Y2guZm9yRWFjaChmdW5jdGlvbihzRXhhY3RNYXRjaCkge1xyXG4gICAgICAgIGlmKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzRXhhY3RNYXRjaCkgPCAwKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgZXhhY3RtYXRjaCBcIicgKyBzRXhhY3RNYXRjaCArICdcIiBub3QgYSBjYXRlZ29yeSBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcblxyXG4gICAgLy8gYWRkIHJlbGF0aW9uIGRvbWFpbiAtPiBjYXRlZ29yeVxyXG4gICAgdmFyIGRvbWFpblN0ciA9IE1ldGFGLkRvbWFpbihvTWRsLmRvbWFpbikudG9GdWxsU3RyaW5nKCk7XHJcbiAgICB2YXIgcmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2hhc0NhdGVnb3J5KS50b0Z1bGxTdHJpbmcoKTtcclxuICAgIHZhciByZXZlcnNlUmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikudG9GdWxsU3RyaW5nKCk7XHJcbiAgICBvTWRsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24oc0NhdGVnb3J5KSB7XHJcblxyXG4gICAgICAgIHZhciBDYXRlZ29yeVN0cmluZyA9IE1ldGFGLkNhdGVnb3J5KHNDYXRlZ29yeSkudG9GdWxsU3RyaW5nKCk7XHJcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl0gfHwge307XHJcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl0gPSBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdW3JlbGF0aW9uU3RyXSB8fCB7fTtcclxuICAgICAgICBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdW3JlbGF0aW9uU3RyXVtDYXRlZ29yeVN0cmluZ10gID0ge307XHJcblxyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXSA9IG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXSB8fCB7fTtcclxuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ11bcmV2ZXJzZVJlbGF0aW9uU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdIHx8IHt9O1xyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdW2RvbWFpblN0cl0gID0ge307XHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gYWRkIGEgcHJlY2ljZSBkb21haW4gbWF0Y2hydWxlXHJcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiZG9tYWluXCIsXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwuZG9tYWluLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIHdvcmQ6IG9NZGwuZG9tYWluLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG5cclxuXHJcblxyXG4gICAgLy8gZXh0cmFjdCB0b29scyBhbiBhZGQgdG8gdG9vbHM6XHJcbiAgICBvTW9kZWwudG9vbHMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IChvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVG9vbCBcIiArIG9NZGwudG9vbC5uYW1lICsgXCIgYWxyZWFkeSBwcmVzZW50IHdoZW4gbG9hZGluZyBcIiArIHNNb2RlbE5hbWUpO1xyXG4gICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluIGFscmVhZHkgbG9hZGVkPycpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXHJcbiAgICBpZiAoIW9NZGwudG9vbGhpZGRlbiAmJiBvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpIHtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwidG9vbFwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBvTWRsLnRvb2wubmFtZSxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgIH07XHJcbiAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW1widG9vbFwiXSkge1xyXG4gICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbXCJ0b29sXCJdLCBcInRvb2xcIiwgb01kbC50b29sLm5hbWUsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgfTtcclxuICAgIGlmIChvTWRsLnN5bm9ueW1zKSB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC5zeW5vbnltcykuZm9yRWFjaChmdW5jdGlvbiAoc3N5bmtleSkge1xyXG4gICAgICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNzeW5rZXkpID49IDAgJiYgc3N5bmtleSAhPT0gXCJ0b29sXCIpIHtcclxuICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbc3N5bmtleV0sIFwiY2F0ZWdvcnlcIiwgc3N5bmtleSwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIG9Nb2RlbC5kb21haW5zLnB1c2gob01kbC5kb21haW4pO1xyXG4gICAgaWYob01kbC50b29sLm5hbWUpIHtcclxuICAgICAgb01vZGVsLnRvb2xzLnB1c2gob01kbC50b29sKTtcclxuICAgIH1cclxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5jb25jYXQob01kbC5jYXRlZ29yeSk7XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkuc29ydCgpO1xyXG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmZpbHRlcihmdW5jdGlvbiAoc3RyaW5nLCBpbmRleCkge1xyXG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcclxuICAgIH0pO1xyXG4gICAgbG9hZE1vZGVsRGF0YShtb2RlbFBhdGgsIG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCk7XHJcbn0gLy8gbG9hZG1vZGVsXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNwbGl0UnVsZXMocnVsZXMgOiBJTWF0Y2gubVJ1bGVbXSkgOiBJTWF0Y2guU3BsaXRSdWxlcyB7XHJcbiAgICB2YXIgcmVzID0ge307XHJcbiAgICB2YXIgbm9uV29yZFJ1bGVzID0gW107XHJcbiAgICBydWxlcy5mb3JFYWNoKGZ1bmN0aW9uKHJ1bGUpIHtcclxuICAgICAgICBpZihydWxlLnR5cGUgPT09IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCkge1xyXG4gICAgICAgICAgICBpZighcnVsZS5sb3dlcmNhc2V3b3JkKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSdWxlIGhhcyBubyBtZW1iZXIgbG93ZXJjYXNld29yZFwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdID0gcmVzW3J1bGUubG93ZXJjYXNld29yZF0gfHwgW107XHJcbiAgICAgICAgICAgIHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdLnB1c2gocnVsZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbm9uV29yZFJ1bGVzLnB1c2gocnVsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHdvcmRNYXA6IHJlcyxcclxuICAgICAgICBub25Xb3JkUnVsZXMgOiBub25Xb3JkUnVsZXMsXHJcbiAgICAgICAgYWxsUnVsZXMgOiBydWxlc1xyXG4gICAgfTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRNb2RlbHMobW9kZWxQYXRoPyA6IHN0cmluZykgOiBJTWF0Y2guSU1vZGVscyB7XHJcbiAgICB2YXIgb01vZGVsOiBJTWF0Y2guSU1vZGVscztcclxuICAgIG9Nb2RlbCA9IHtcclxuICAgICAgICBkb21haW5zOiBbXSxcclxuICAgICAgICB0b29sczogW10sXHJcbiAgICAgICAgcnVsZXMgOiB1bmRlZmluZWQsXHJcbiAgICAgICAgY2F0ZWdvcnk6IFtdLFxyXG4gICAgICAgIG9wZXJhdG9ycyA6IHt9LFxyXG4gICAgICAgIG1SdWxlczogW10sXHJcbiAgICAgICAgc2VlblJ1bGVzIDoge30sXHJcbiAgICAgICAgcmVjb3JkczogW10sXHJcbiAgICAgICAgbWV0YSA6IHsgdDMgOiB7fSB9XHJcbiAgICB9XHJcbiAgICBtb2RlbFBhdGggPSBtb2RlbFBhdGggfHwgZW52TW9kZWxQYXRoO1xyXG4gICAgdmFyIHNtZGxzID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnL21vZGVscy5qc29uJywgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgbWRscyA9IEpTT04ucGFyc2UoXCJcIiArIHNtZGxzKTtcclxuICAgIG1kbHMuZm9yRWFjaChmdW5jdGlvbiAoc01vZGVsTmFtZSkge1xyXG4gICAgICAgIGxvYWRNb2RlbChtb2RlbFBhdGgsIHNNb2RlbE5hbWUsIG9Nb2RlbClcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGFkZCB0aGUgY2F0ZWdvcmllcyB0byB0aGUgbW9kZWw6XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiY2F0ZWdvcnlcIixcclxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IGNhdGVnb3J5LnRvTG93ZXJDYXNlKCksXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGRvbWFpbiBtZXRhIHJ1bGVcclxuICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJtZXRhXCIsXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZG9tYWluXCIsXHJcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgd29yZDogXCJkb21haW5cIixcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuXHJcblxyXG5cclxuICAgIC8vYWRkIGEgZmlsbGVyIHJ1bGVcclxuICAgIHZhciBzZmlsbGVycyA9IGZzLnJlYWRGaWxlU3luYygnLi8nICsgbW9kZWxQYXRoICsgJy9maWxsZXIuanNvbicsICd1dGYtOCcpO1xyXG4gICAgdmFyIGZpbGxlcnMgPSBKU09OLnBhcnNlKHNmaWxsZXJzKTtcclxuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xyXG4gICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcclxuICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcclxuICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLlJFR0VYUCxcclxuICAgICAgICByZWdleHA6IG5ldyBSZWdFeHAocmUsIFwiaVwiKSxcclxuICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxyXG4gICAgICAgIF9yYW5raW5nOiAwLjlcclxuICAgIH0pO1xyXG5cclxuICAgIC8vYWRkIG9wZXJhdG9yc1xyXG4gICAgdmFyIHNPcGVyYXRvcnMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vcmVzb3VyY2VzL21vZGVsL29wZXJhdG9ycy5qc29uJywgJ3V0Zi04Jyk7XHJcbiAgICB2YXIgb3BlcmF0b3JzID0gSlNPTi5wYXJzZShzT3BlcmF0b3JzKTtcclxuICAgIE9iamVjdC5rZXlzKG9wZXJhdG9ycy5vcGVyYXRvcnMpLmZvckVhY2goZnVuY3Rpb24ob3BlcmF0b3IpIHtcclxuICAgICAgICBpZihJTWF0Y2guYU9wZXJhdG9yTmFtZXMuaW5kZXhPZihvcGVyYXRvcikgPCAwKSB7XHJcbiAgICAgICAgICAgIGRlYnVnbG9nKFwidW5rbm93biBvcGVyYXRvciBcIiArIG9wZXJhdG9yKTtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidW5rbm93biBvcGVyYXRvciBcIiArIG9wZXJhdG9yKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0gPSBvcGVyYXRvcnMub3BlcmF0b3JzW29wZXJhdG9yXTtcclxuICAgICAgICBvTW9kZWwub3BlcmF0b3JzW29wZXJhdG9yXS5vcGVyYXRvciA9IDxJTWF0Y2guT3BlcmF0b3JOYW1lPiBvcGVyYXRvcjtcclxuICAgICAgICBPYmplY3QuZnJlZXplKG9Nb2RlbC5vcGVyYXRvcnNbb3BlcmF0b3JdKTtcclxuICAgICAgICB2YXIgd29yZCA9IG9wZXJhdG9yO1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJvcGVyYXRvclwiLFxyXG4gICAgICAgICAgICB3b3JkIDogd29yZC50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgICAgICBsb3dlcmNhc2V3b3JkIDogd29yZC50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmcgOiB3b3JkLFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgLy8gYWRkIGFsbCBzeW5vbnltc1xyXG4gICAgICAgIGlmKG9wZXJhdG9ycy5zeW5vbnltc1tvcGVyYXRvcl0pIHtcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMob3BlcmF0b3JzLnN5bm9ueW1zW29wZXJhdG9yXSkuZm9yRWFjaChmdW5jdGlvbihzeW5vbnltKSB7XHJcbiAgICAgICAgICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMse1xyXG4gICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBcIm9wZXJhdG9yXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgd29yZCA6IHN5bm9ueW0udG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgICAgICAgICBsb3dlcmNhc2V3b3JkIDogc3lub255bS50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nIDogb3BlcmF0b3IsXHJcbiAgICAgICAgICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOVxyXG4gICAgICAgICAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLypcclxuICAgICAgICB9KVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcclxuICAgICAgICAgIHR5cGU6IDEsXHJcbiAgICAgICAgICByZWdleHA6IC9eKChzdGFydCl8KHNob3cpfChmcm9tKXwoaW4pKSQvaSxcclxuICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXHJcbiAgICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICAgICAgfSxcclxuICAgICovXHJcbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xyXG4gICAgb01vZGVsLnJ1bGVzID0gc3BsaXRSdWxlcyhvTW9kZWwubVJ1bGVzKTtcclxuICAgIG9Nb2RlbC50b29scyA9IG9Nb2RlbC50b29scy5zb3J0KFRvb2xzLmNtcFRvb2xzKTtcclxuICAgIGRlbGV0ZSBvTW9kZWwuc2VlblJ1bGVzO1xyXG4gICAgcmV0dXJuIG9Nb2RlbDtcclxufVxyXG5cclxuXHJcbmNvbnN0IE1ldGFGID0gTWV0YS5nZXRNZXRhRmFjdG9yeSgpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldE9wZXJhdG9yKG1kbDogSU1hdGNoLklNb2RlbHMsIG9wZXJhdG9yIDogc3RyaW5nKSA6IElNYXRjaC5JT3BlcmF0b3Ige1xyXG4gICAgcmV0dXJuIG1kbC5vcGVyYXRvcnNbb3BlcmF0b3JdO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVzdWx0QXNBcnJheShtZGwgOiBJTWF0Y2guSU1vZGVscywgYSA6IE1ldGEuSU1ldGEsIHJlbCA6IE1ldGEuSU1ldGEpIDogTWV0YS5JTWV0YVtdIHtcclxuICAgIGlmKHJlbC50b1R5cGUoKSAhPT0gJ3JlbGF0aW9uJykge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImV4cGVjdCByZWxhdGlvbiBhcyAybmQgYXJnXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciByZXMgPSBtZGwubWV0YS50M1thLnRvRnVsbFN0cmluZygpXSAmJlxyXG4gICAgbWRsLm1ldGEudDNbYS50b0Z1bGxTdHJpbmcoKV1bcmVsLnRvRnVsbFN0cmluZygpXTtcclxuICAgIGlmKCFyZXMpIHtcclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocmVzKS5zb3J0KCkubWFwKE1ldGFGLnBhcnNlSU1ldGEpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbih0aGVNb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBkb21haW4gOiBzdHJpbmcpIDogc3RyaW5nW10ge1xyXG4gICAgaWYodGhlTW9kZWwuZG9tYWlucy5pbmRleE9mKGRvbWFpbikgPCAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRG9tYWluIFxcXCJcIiArIGRvbWFpbiArIFwiXFxcIiBub3QgcGFydCBvZiBtb2RlbFwiKTtcclxuICAgIH1cclxuICAgIHZhciByZXMgPSBnZXRSZXN1bHRBc0FycmF5KHRoZU1vZGVsLCBNZXRhRi5Eb21haW4oZG9tYWluKSwgTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9oYXNDYXRlZ29yeSkpO1xyXG4gICAgcmV0dXJuIE1ldGEuZ2V0U3RyaW5nQXJyYXkocmVzKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFJldHVybiBhbGwgY2F0ZWdvcmllcyBvZiBhIGRvbWFpbiB3aGljaCBjYW4gYXBwZWFyIG9uIGEgd29yZCxcclxuICogdGhlc2UgYXJlIHR5cGljYWxseSB0aGUgd29yZGluZGV4IGRvbWFpbnMgKyBlbnRyaWVzIGdlbmVyYXRlZCBieSBnZW5lcmljIHJ1bGVzXHJcbiAqXHJcbiAqIFRoZSBjdXJyZW50IGltcGxlbWVudGF0aW9uIGlzIGEgc2ltcGxpZmljYXRpb25cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRQb3RlbnRpYWxXb3JkQ2F0ZWdvcmllc0ZvckRvbWFpbih0aGVNb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBkb21haW4gOiBzdHJpbmcpIDogc3RyaW5nW10ge1xyXG4gICAgLy8gdGhpcyBpcyBhIHNpbXBsaWZpZWQgdmVyc2lvblxyXG4gICAgcmV0dXJuIGdldENhdGVnb3JpZXNGb3JEb21haW4odGhlTW9kZWwsIGRvbWFpbik7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwgOiBJTWF0Y2guSU1vZGVscywgY2F0ZWdvcnkgOiBzdHJpbmcpIDogc3RyaW5nW10ge1xyXG4gICAgaWYodGhlTW9kZWwuY2F0ZWdvcnkuaW5kZXhPZihjYXRlZ29yeSkgPCAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2F0ZWdvcnkgXFxcIlwiICsgY2F0ZWdvcnkgKyBcIlxcXCIgbm90IHBhcnQgb2YgbW9kZWxcIik7XHJcbiAgICB9XHJcbiAgICB2YXIgcmVzID0gZ2V0UmVzdWx0QXNBcnJheSh0aGVNb2RlbCwgTWV0YUYuQ2F0ZWdvcnkoY2F0ZWdvcnkpLCBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikpO1xyXG4gICAgcmV0dXJuIE1ldGEuZ2V0U3RyaW5nQXJyYXkocmVzKTtcclxufVxyXG5cclxuXHJcbiBleHBvcnQgZnVuY3Rpb24gZ2V0QWxsUmVjb3JkQ2F0ZWdvcmllc0ZvclRhcmdldENhdGVnb3J5KG1vZGVsIDogSU1hdGNoLklNb2RlbHMsIGNhdGVnb3J5IDogc3RyaW5nLCB3b3Jkc29ubHkgOiBib29sZWFuKSA6IHtba2V5OiBzdHJpbmddIDogYm9vbGVhbn0ge1xyXG4gICAgdmFyIHJlcyA9IHt9O1xyXG4gICAgLy9cclxuICAgIHZhciBmbiA9IHdvcmRzb25seSA/IGdldFBvdGVudGlhbFdvcmRDYXRlZ29yaWVzRm9yRG9tYWluIDogZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbjtcclxuICAgIHZhciBkb21haW5zID0gZ2V0RG9tYWluc0ZvckNhdGVnb3J5KG1vZGVsLCBjYXRlZ29yeSk7XHJcbiAgICBkb21haW5zLmZvckVhY2goZnVuY3Rpb24oZG9tYWluKSB7XHJcbiAgICAgICAgZm4obW9kZWwsIGRvbWFpbikuZm9yRWFjaChmdW5jdGlvbih3b3JkY2F0KSB7XHJcbiAgICAgICAgICAgIHJlc1t3b3JkY2F0XSA9IHRydWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIE9iamVjdC5mcmVlemUocmVzKTtcclxuICAgIHJldHVybiByZXM7XHJcbiB9XHJcblxyXG4gZXhwb3J0IGZ1bmN0aW9uIGdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yaWVzKG1vZGVsIDogSU1hdGNoLklNb2RlbHMsIGNhdGVnb3JpZXMgOiBzdHJpbmdbXSwgd29yZHNvbmx5IDogYm9vbGVhbikgOiB7W2tleTogc3RyaW5nXSA6IGJvb2xlYW59IHtcclxuICAgIHZhciByZXMgPSB7fTtcclxuICAgIC8vXHJcbiAgICB2YXIgZm4gPSB3b3Jkc29ubHkgPyBnZXRQb3RlbnRpYWxXb3JkQ2F0ZWdvcmllc0ZvckRvbWFpbiA6IGdldENhdGVnb3JpZXNGb3JEb21haW47XHJcbiAgICB2YXIgZG9tYWlucyA9IHVuZGVmaW5lZDtcclxuICAgIGNhdGVnb3JpZXMuZm9yRWFjaChmdW5jdGlvbihjYXRlZ29yeSkge1xyXG4gICAgICAgIHZhciBjYXRkb21haW5zID0gZ2V0RG9tYWluc0ZvckNhdGVnb3J5KG1vZGVsLCBjYXRlZ29yeSlcclxuICAgICAgICBpZighZG9tYWlucykge1xyXG4gICAgICAgICAgICBkb21haW5zID0gY2F0ZG9tYWlucztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBkb21haW5zID0gXy5pbnRlcnNlY3Rpb24oZG9tYWlucywgY2F0ZG9tYWlucyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBpZihkb21haW5zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignY2F0ZWdvcmllcyAnICsgVXRpbHMubGlzdFRvUXVvdGVkQ29tbWFBbmQoY2F0ZWdvcmllcykgKyAnIGhhdmUgbm8gY29tbW9uIGRvbWFpbi4nKVxyXG4gICAgfVxyXG4gICAgZG9tYWlucy5mb3JFYWNoKGZ1bmN0aW9uKGRvbWFpbikge1xyXG4gICAgICAgIGZuKG1vZGVsLCBkb21haW4pLmZvckVhY2goZnVuY3Rpb24od29yZGNhdCkge1xyXG4gICAgICAgICAgICByZXNbd29yZGNhdF0gPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBPYmplY3QuZnJlZXplKHJlcyk7XHJcbiAgICByZXR1cm4gcmVzO1xyXG4gfVxyXG5cclxuXHJcbiIsIi8qKlxuICogRnVuY3Rpb25hbGl0eSBtYW5hZ2luZyB0aGUgbWF0Y2ggbW9kZWxzXG4gKlxuICogQGZpbGVcbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vZGVsJyk7XG52YXIgbG9nZ2VyID0gcmVxdWlyZSgnLi4vdXRpbHMvbG9nZ2VyJyk7XG52YXIgbG9hZGxvZyA9IGxvZ2dlci5sb2dnZXIoJ21vZGVsbG9hZCcsICcnKTtcbnZhciBJTWF0Y2ggPSByZXF1aXJlKCcuLi9tYXRjaC9pZm1hdGNoJyk7XG52YXIgSW5wdXRGaWx0ZXJSdWxlcyA9IHJlcXVpcmUoJy4uL21hdGNoL2lucHV0RmlsdGVyUnVsZXMnKTtcbnZhciBUb29scyA9IHJlcXVpcmUoJy4uL21hdGNoL3Rvb2xzJyk7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIE1ldGEgPSByZXF1aXJlKCcuL21ldGEnKTtcbnZhciBVdGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzJyk7XG52YXIgcHJvY2VzcyA9IHJlcXVpcmUoJ3Byb2Nlc3MnKTtcbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG4vKipcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcbiAqL1xudmFyIGVudk1vZGVsUGF0aCA9IHByb2Nlc3MuZW52W1wiQUJPVF9NT0RFTFBBVEhcIl0gfHwgXCJ0ZXN0bW9kZWxcIjtcbjtcbnZhciBBUlJfTU9ERUxfUFJPUEVSVElFUyA9IFtcImRvbWFpblwiLCBcInRvb2xcIiwgXCJ0b29saGlkZGVuXCIsIFwic3lub255bXNcIiwgXCJjYXRlZ29yeVwiLCBcIndvcmRpbmRleFwiLCBcImV4YWN0bWF0Y2hcIiwgXCJoaWRkZW5cIl07XG5mdW5jdGlvbiBhZGRTeW5vbnltcyhzeW5vbnltcywgY2F0ZWdvcnksIHN5bm9ueW1Gb3IsIG1SdWxlcywgc2Vlbikge1xuICAgIHN5bm9ueW1zLmZvckVhY2goZnVuY3Rpb24gKHN5bikge1xuICAgICAgICB2YXIgb1J1bGUgPSB7XG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzeW5vbnltRm9yLFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogc3luLFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfTtcbiAgICAgICAgZGVidWdsb2coXCJpbnNlcnRpbmcgc3lub255bVwiICsgSlNPTi5zdHJpbmdpZnkob1J1bGUpKTtcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIG9SdWxlLCBzZWVuKTtcbiAgICB9KTtcbn1cbmZ1bmN0aW9uIGdldFJ1bGVLZXkocnVsZSkge1xuICAgIHJldHVybiBydWxlLm1hdGNoZWRTdHJpbmcgKyBcIi18LVwiICsgcnVsZS5jYXRlZ29yeSArIFwiIC18LSBcIiArIHJ1bGUudHlwZSArIFwiIC18LSBcIiArIHJ1bGUud29yZCArIFwiIFwiO1xufVxuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcykge1xuICAgIGlmIChydWxlLnR5cGUgIT09IDAgLyogV09SRCAqLykge1xuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICB2YXIgciA9IGdldFJ1bGVLZXkocnVsZSk7XG4gICAgcnVsZS5sb3dlcmNhc2V3b3JkID0gcnVsZS53b3JkLnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKHNlZW5SdWxlc1tyXSkge1xuICAgICAgICBkZWJ1Z2xvZyhcIkF0dGVtcHRpbmcgdG8gaW5zZXJ0IGR1cGxpY2F0ZVwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHZhciBkdXBsaWNhdGVzID0gc2VlblJ1bGVzW3JdLmZpbHRlcihmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgICAgICByZXR1cm4gMCA9PT0gSW5wdXRGaWx0ZXJSdWxlcy5jb21wYXJlTVJ1bGVGdWxsKG9FbnRyeSwgcnVsZSk7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoZHVwbGljYXRlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG4gICAgc2VlblJ1bGVzW3JdID0gKHNlZW5SdWxlc1tyXSB8fCBbXSk7XG4gICAgc2VlblJ1bGVzW3JdLnB1c2gocnVsZSk7XG4gICAgaWYgKHJ1bGUud29yZCA9PT0gXCJcIikge1xuICAgICAgICBkZWJ1Z2xvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICBsb2FkbG9nKCdTa2lwcGluZyBydWxlIHdpdGggZW10cHkgd29yZCAnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbVJ1bGVzLnB1c2gocnVsZSk7XG4gICAgcmV0dXJuO1xufVxuZnVuY3Rpb24gbG9hZE1vZGVsRGF0YShtb2RlbFBhdGgsIG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCkge1xuICAgIC8vIHJlYWQgdGhlIGRhdGEgLT5cbiAgICAvLyBkYXRhIGlzIHByb2Nlc3NlZCBpbnRvIG1SdWxlcyBkaXJlY3RseSxcbiAgICB2YXIgc0ZpbGVOYW1lID0gKCcuLycgKyBtb2RlbFBhdGggKyAnLycgKyBzTW9kZWxOYW1lICsgXCIuZGF0YS5qc29uXCIpO1xuICAgIHZhciBtZGxkYXRhID0gZnMucmVhZEZpbGVTeW5jKHNGaWxlTmFtZSwgJ3V0Zi04Jyk7XG4gICAgdmFyIG9NZGxEYXRhID0gSlNPTi5wYXJzZShtZGxkYXRhKTtcbiAgICBvTWRsRGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChvRW50cnkpIHtcbiAgICAgICAgaWYgKCFvRW50cnkudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkge1xuICAgICAgICAgICAgb0VudHJ5LnRvb2wgPSBvTWRsLnRvb2wubmFtZTtcbiAgICAgICAgICAgIG9FbnRyeS5fZG9tYWluID0gb01kbC5kb21haW47XG4gICAgICAgIH1cbiAgICAgICAgb01vZGVsLnJlY29yZHMucHVzaChvRW50cnkpO1xuICAgICAgICBvTWRsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24gKGNhdCkge1xuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRdID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIG9FbnRyeVtjYXRdID0gXCJuL2FcIjtcbiAgICAgICAgICAgICAgICB2YXIgYnVnID0gXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiICsgY2F0ICsgXCIgd2l0aCB2YWx1ZSAndW5kZWZpbmVkJywgdW5kZWZpbmVkIGlzIGlsbGVnYWwgdmFsdWUsIHVzZSBuL2EgXCIgKyBKU09OLnN0cmluZ2lmeShvRW50cnkpICsgXCJcIjtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhidWcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIklOQ09OU0lTVEVOVCo+IE1vZGVsRGF0YSBcIiArIHNGaWxlTmFtZSArIFwiIGRvZXMgbm90IGNvbnRhaW4gY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIG9mIHdvcmRpbmRleFwiICsgSlNPTi5zdHJpbmdpZnkob0VudHJ5KSArIFwiXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldICE9PSBcIipcIikge1xuICAgICAgICAgICAgICAgIHZhciBzU3RyaW5nID0gb0VudHJ5W2NhdGVnb3J5XTtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcInB1c2hpbmcgcnVsZSB3aXRoIFwiICsgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xuICAgICAgICAgICAgICAgIHZhciBvUnVsZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICAgICAgICAgIHdvcmQ6IHNTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAob01kbC5leGFjdG1hdGNoICYmIG9NZGwuZXhhY3RtYXRjaC5pbmRleE9mKGNhdGVnb3J5KSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9SdWxlLmV4YWN0T25seSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywgb1J1bGUsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgICAgIGlmIChvTWRsRGF0YS5zeW5vbnltcyAmJiBvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0pIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChvRW50cnkuc3lub255bXMgJiYgb0VudHJ5LnN5bm9ueW1zW2NhdGVnb3J5XSkge1xuICAgICAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvRW50cnkuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn1cbmZ1bmN0aW9uIGxvYWRNb2RlbChtb2RlbFBhdGgsIHNNb2RlbE5hbWUsIG9Nb2RlbCkge1xuICAgIGRlYnVnbG9nKFwiIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lICsgXCIgLi4uLlwiKTtcbiAgICB2YXIgbWRsID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnLycgKyBzTW9kZWxOYW1lICsgXCIubW9kZWwuanNvblwiLCAndXRmLTgnKTtcbiAgICB2YXIgb01kbCA9IEpTT04ucGFyc2UobWRsKTtcbiAgICBpZiAob01vZGVsLmRvbWFpbnMuaW5kZXhPZihvTWRsLmRvbWFpbikgPj0gMCkge1xuICAgICAgICBkZWJ1Z2xvZyhcIioqKioqKioqKioqaGVyZSBtZGxcIiArIEpTT04uc3RyaW5naWZ5KG9NZGwsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiAnICsgb01kbC5kb21haW4gKyAnIGFscmVhZHkgbG9hZGVkIHdoaWxlIGxvYWRpbmcgJyArIHNNb2RlbE5hbWUgKyAnPycpO1xuICAgIH1cbiAgICAvLyBjaGVjayBwcm9wZXJ0aWVzIG9mIG1vZGVsXG4gICAgT2JqZWN0LmtleXMob01kbCkuc29ydCgpLmZvckVhY2goZnVuY3Rpb24gKHNQcm9wZXJ0eSkge1xuICAgICAgICBpZiAoQVJSX01PREVMX1BST1BFUlRJRVMuaW5kZXhPZihzUHJvcGVydHkpIDwgMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNb2RlbCBwcm9wZXJ0eSBcIicgKyBzUHJvcGVydHkgKyAnXCIgbm90IGEga25vd24gbW9kZWwgcHJvcHBlcnR5IGluIG1vZGVsIG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gY2hlY2sgdGhhdCBtZW1iZXJzIG9mIHdvcmRpbmRleCBhcmUgaW4gY2F0ZWdvcmllcyxcbiAgICBvTWRsLndvcmRpbmRleCA9IG9NZGwud29yZGluZGV4IHx8IFtdO1xuICAgIG9NZGwud29yZGluZGV4LmZvckVhY2goZnVuY3Rpb24gKHNXb3JkSW5kZXgpIHtcbiAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzV29yZEluZGV4KSA8IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgd29yZGluZGV4IFwiJyArIHNXb3JkSW5kZXggKyAnXCIgbm90IGEgY2F0ZWdvcnkgb2YgZG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgJyk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBvTWRsLmV4YWN0bWF0Y2ggPSBvTWRsLmV4YWN0bWF0Y2ggfHwgW107XG4gICAgb01kbC5leGFjdG1hdGNoLmZvckVhY2goZnVuY3Rpb24gKHNFeGFjdE1hdGNoKSB7XG4gICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc0V4YWN0TWF0Y2gpIDwgMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNb2RlbCBleGFjdG1hdGNoIFwiJyArIHNFeGFjdE1hdGNoICsgJ1wiIG5vdCBhIGNhdGVnb3J5IG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gYWRkIHJlbGF0aW9uIGRvbWFpbiAtPiBjYXRlZ29yeVxuICAgIHZhciBkb21haW5TdHIgPSBNZXRhRi5Eb21haW4ob01kbC5kb21haW4pLnRvRnVsbFN0cmluZygpO1xuICAgIHZhciByZWxhdGlvblN0ciA9IE1ldGFGLlJlbGF0aW9uKE1ldGEuUkVMQVRJT05faGFzQ2F0ZWdvcnkpLnRvRnVsbFN0cmluZygpO1xuICAgIHZhciByZXZlcnNlUmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikudG9GdWxsU3RyaW5nKCk7XG4gICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChzQ2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIENhdGVnb3J5U3RyaW5nID0gTWV0YUYuQ2F0ZWdvcnkoc0NhdGVnb3J5KS50b0Z1bGxTdHJpbmcoKTtcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdID0gb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdW0NhdGVnb3J5U3RyaW5nXSA9IHt9O1xuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ10gPSBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ10gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdID0gb01vZGVsLm1ldGEudDNbQ2F0ZWdvcnlTdHJpbmddW3JldmVyc2VSZWxhdGlvblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdW2RvbWFpblN0cl0gPSB7fTtcbiAgICB9KTtcbiAgICAvLyBhZGQgYSBwcmVjaWNlIGRvbWFpbiBtYXRjaHJ1bGVcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiZG9tYWluXCIsXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwuZG9tYWluLFxuICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgIHdvcmQ6IG9NZGwuZG9tYWluLFxuICAgICAgICBfcmFua2luZzogMC45NVxuICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIC8vIGV4dHJhY3QgdG9vbHMgYW4gYWRkIHRvIHRvb2xzOlxuICAgIG9Nb2RlbC50b29scy5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICBpZiAob0VudHJ5Lm5hbWUgPT09IChvTWRsLnRvb2wgJiYgb01kbC50b29sLm5hbWUpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRvb2wgXCIgKyBvTWRsLnRvb2wubmFtZSArIFwiIGFscmVhZHkgcHJlc2VudCB3aGVuIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lKTtcbiAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdEb21haW4gYWxyZWFkeSBsb2FkZWQ/Jyk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXG4gICAgaWYgKCFvTWRsLnRvb2xoaWRkZW4gJiYgb01kbC50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFwidG9vbFwiLFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogb01kbC50b29sLm5hbWUsXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBvTWRsLnRvb2wubmFtZSxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH1cbiAgICA7XG4gICAgaWYgKG9NZGwuc3lub255bXMgJiYgb01kbC5zeW5vbnltc1tcInRvb2xcIl0pIHtcbiAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tcInRvb2xcIl0sIFwidG9vbFwiLCBvTWRsLnRvb2wubmFtZSwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgfVxuICAgIDtcbiAgICBpZiAob01kbC5zeW5vbnltcykge1xuICAgICAgICBPYmplY3Qua2V5cyhvTWRsLnN5bm9ueW1zKS5mb3JFYWNoKGZ1bmN0aW9uIChzc3lua2V5KSB7XG4gICAgICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNzeW5rZXkpID49IDAgJiYgc3N5bmtleSAhPT0gXCJ0b29sXCIpIHtcbiAgICAgICAgICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW3NzeW5rZXldLCBcImNhdGVnb3J5XCIsIHNzeW5rZXksIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgb01vZGVsLmRvbWFpbnMucHVzaChvTWRsLmRvbWFpbik7XG4gICAgaWYgKG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgIG9Nb2RlbC50b29scy5wdXNoKG9NZGwudG9vbCk7XG4gICAgfVxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5jb25jYXQob01kbC5jYXRlZ29yeSk7XG4gICAgb01vZGVsLmNhdGVnb3J5LnNvcnQoKTtcbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuZmlsdGVyKGZ1bmN0aW9uIChzdHJpbmcsIGluZGV4KSB7XG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcbiAgICB9KTtcbiAgICBsb2FkTW9kZWxEYXRhKG1vZGVsUGF0aCwgb01kbCwgc01vZGVsTmFtZSwgb01vZGVsKTtcbn0gLy8gbG9hZG1vZGVsXG5mdW5jdGlvbiBzcGxpdFJ1bGVzKHJ1bGVzKSB7XG4gICAgdmFyIHJlcyA9IHt9O1xuICAgIHZhciBub25Xb3JkUnVsZXMgPSBbXTtcbiAgICBydWxlcy5mb3JFYWNoKGZ1bmN0aW9uIChydWxlKSB7XG4gICAgICAgIGlmIChydWxlLnR5cGUgPT09IDAgLyogV09SRCAqLykge1xuICAgICAgICAgICAgaWYgKCFydWxlLmxvd2VyY2FzZXdvcmQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSdWxlIGhhcyBubyBtZW1iZXIgbG93ZXJjYXNld29yZFwiICsgSlNPTi5zdHJpbmdpZnkocnVsZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzW3J1bGUubG93ZXJjYXNld29yZF0gPSByZXNbcnVsZS5sb3dlcmNhc2V3b3JkXSB8fCBbXTtcbiAgICAgICAgICAgIHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdLnB1c2gocnVsZSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBub25Xb3JkUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB7XG4gICAgICAgIHdvcmRNYXA6IHJlcyxcbiAgICAgICAgbm9uV29yZFJ1bGVzOiBub25Xb3JkUnVsZXMsXG4gICAgICAgIGFsbFJ1bGVzOiBydWxlc1xuICAgIH07XG59XG5leHBvcnRzLnNwbGl0UnVsZXMgPSBzcGxpdFJ1bGVzO1xuZnVuY3Rpb24gbG9hZE1vZGVscyhtb2RlbFBhdGgpIHtcbiAgICB2YXIgb01vZGVsO1xuICAgIG9Nb2RlbCA9IHtcbiAgICAgICAgZG9tYWluczogW10sXG4gICAgICAgIHRvb2xzOiBbXSxcbiAgICAgICAgcnVsZXM6IHVuZGVmaW5lZCxcbiAgICAgICAgY2F0ZWdvcnk6IFtdLFxuICAgICAgICBvcGVyYXRvcnM6IHt9LFxuICAgICAgICBtUnVsZXM6IFtdLFxuICAgICAgICBzZWVuUnVsZXM6IHt9LFxuICAgICAgICByZWNvcmRzOiBbXSxcbiAgICAgICAgbWV0YTogeyB0Mzoge30gfVxuICAgIH07XG4gICAgbW9kZWxQYXRoID0gbW9kZWxQYXRoIHx8IGVudk1vZGVsUGF0aDtcbiAgICB2YXIgc21kbHMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vJyArIG1vZGVsUGF0aCArICcvbW9kZWxzLmpzb24nLCAndXRmLTgnKTtcbiAgICB2YXIgbWRscyA9IEpTT04ucGFyc2UoXCJcIiArIHNtZGxzKTtcbiAgICBtZGxzLmZvckVhY2goZnVuY3Rpb24gKHNNb2RlbE5hbWUpIHtcbiAgICAgICAgbG9hZE1vZGVsKG1vZGVsUGF0aCwgc01vZGVsTmFtZSwgb01vZGVsKTtcbiAgICB9KTtcbiAgICAvLyBhZGQgdGhlIGNhdGVnb3JpZXMgdG8gdGhlIG1vZGVsOlxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcImNhdGVnb3J5XCIsXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIHdvcmQ6IGNhdGVnb3J5LFxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH0pO1xuICAgIC8vIGFkZCB0aGUgZG9tYWluIG1ldGEgcnVsZVxuICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICBjYXRlZ29yeTogXCJtZXRhXCIsXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZG9tYWluXCIsXG4gICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgd29yZDogXCJkb21haW5cIixcbiAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICAvL2FkZCBhIGZpbGxlciBydWxlXG4gICAgdmFyIHNmaWxsZXJzID0gZnMucmVhZEZpbGVTeW5jKCcuLycgKyBtb2RlbFBhdGggKyAnL2ZpbGxlci5qc29uJywgJ3V0Zi04Jyk7XG4gICAgdmFyIGZpbGxlcnMgPSBKU09OLnBhcnNlKHNmaWxsZXJzKTtcbiAgICB2YXIgcmUgPSBcIl4oKFwiICsgZmlsbGVycy5qb2luKFwiKXwoXCIpICsgXCIpKSRcIjtcbiAgICBvTW9kZWwubVJ1bGVzLnB1c2goe1xuICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcbiAgICAgICAgdHlwZTogMSAvKiBSRUdFWFAgKi8sXG4gICAgICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChyZSwgXCJpXCIpLFxuICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxuICAgICAgICBfcmFua2luZzogMC45XG4gICAgfSk7XG4gICAgLy9hZGQgb3BlcmF0b3JzXG4gICAgdmFyIHNPcGVyYXRvcnMgPSBmcy5yZWFkRmlsZVN5bmMoJy4vcmVzb3VyY2VzL21vZGVsL29wZXJhdG9ycy5qc29uJywgJ3V0Zi04Jyk7XG4gICAgdmFyIG9wZXJhdG9ycyA9IEpTT04ucGFyc2Uoc09wZXJhdG9ycyk7XG4gICAgT2JqZWN0LmtleXMob3BlcmF0b3JzLm9wZXJhdG9ycykuZm9yRWFjaChmdW5jdGlvbiAob3BlcmF0b3IpIHtcbiAgICAgICAgaWYgKElNYXRjaC5hT3BlcmF0b3JOYW1lcy5pbmRleE9mKG9wZXJhdG9yKSA8IDApIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwidW5rbm93biBvcGVyYXRvciBcIiArIG9wZXJhdG9yKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInVua25vd24gb3BlcmF0b3IgXCIgKyBvcGVyYXRvcik7XG4gICAgICAgIH1cbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0gPSBvcGVyYXRvcnMub3BlcmF0b3JzW29wZXJhdG9yXTtcbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0ub3BlcmF0b3IgPSBvcGVyYXRvcjtcbiAgICAgICAgT2JqZWN0LmZyZWV6ZShvTW9kZWwub3BlcmF0b3JzW29wZXJhdG9yXSk7XG4gICAgICAgIHZhciB3b3JkID0gb3BlcmF0b3I7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFwib3BlcmF0b3JcIixcbiAgICAgICAgICAgIHdvcmQ6IHdvcmQudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IHdvcmQudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHdvcmQsXG4gICAgICAgICAgICBfcmFua2luZzogMC45XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAvLyBhZGQgYWxsIHN5bm9ueW1zXG4gICAgICAgIGlmIChvcGVyYXRvcnMuc3lub255bXNbb3BlcmF0b3JdKSB7XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhvcGVyYXRvcnMuc3lub255bXNbb3BlcmF0b3JdKS5mb3JFYWNoKGZ1bmN0aW9uIChzeW5vbnltKSB7XG4gICAgICAgICAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XG4gICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBcIm9wZXJhdG9yXCIsXG4gICAgICAgICAgICAgICAgICAgIHdvcmQ6IHN5bm9ueW0udG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgICAgICAgICAgbG93ZXJjYXNld29yZDogc3lub255bS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9wZXJhdG9yLFxuICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogMC45XG4gICAgICAgICAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8qXG4gICAgICAgIH0pXG4gICAgICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXG4gICAgICAgICAgdHlwZTogMSxcbiAgICAgICAgICByZWdleHA6IC9eKChzdGFydCl8KHNob3cpfChmcm9tKXwoaW4pKSQvaSxcbiAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxuICAgICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICAgICAgfSxcbiAgICAqL1xuICAgIG9Nb2RlbC5tUnVsZXMgPSBvTW9kZWwubVJ1bGVzLnNvcnQoSW5wdXRGaWx0ZXJSdWxlcy5jbXBNUnVsZSk7XG4gICAgb01vZGVsLnJ1bGVzID0gc3BsaXRSdWxlcyhvTW9kZWwubVJ1bGVzKTtcbiAgICBvTW9kZWwudG9vbHMgPSBvTW9kZWwudG9vbHMuc29ydChUb29scy5jbXBUb29scyk7XG4gICAgZGVsZXRlIG9Nb2RlbC5zZWVuUnVsZXM7XG4gICAgcmV0dXJuIG9Nb2RlbDtcbn1cbmV4cG9ydHMubG9hZE1vZGVscyA9IGxvYWRNb2RlbHM7XG52YXIgTWV0YUYgPSBNZXRhLmdldE1ldGFGYWN0b3J5KCk7XG5mdW5jdGlvbiBnZXRPcGVyYXRvcihtZGwsIG9wZXJhdG9yKSB7XG4gICAgcmV0dXJuIG1kbC5vcGVyYXRvcnNbb3BlcmF0b3JdO1xufVxuZXhwb3J0cy5nZXRPcGVyYXRvciA9IGdldE9wZXJhdG9yO1xuZnVuY3Rpb24gZ2V0UmVzdWx0QXNBcnJheShtZGwsIGEsIHJlbCkge1xuICAgIGlmIChyZWwudG9UeXBlKCkgIT09ICdyZWxhdGlvbicpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZXhwZWN0IHJlbGF0aW9uIGFzIDJuZCBhcmdcIik7XG4gICAgfVxuICAgIHZhciByZXMgPSBtZGwubWV0YS50M1thLnRvRnVsbFN0cmluZygpXSAmJlxuICAgICAgICBtZGwubWV0YS50M1thLnRvRnVsbFN0cmluZygpXVtyZWwudG9GdWxsU3RyaW5nKCldO1xuICAgIGlmICghcmVzKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHJlcykuc29ydCgpLm1hcChNZXRhRi5wYXJzZUlNZXRhKTtcbn1cbmV4cG9ydHMuZ2V0UmVzdWx0QXNBcnJheSA9IGdldFJlc3VsdEFzQXJyYXk7XG5mdW5jdGlvbiBnZXRDYXRlZ29yaWVzRm9yRG9tYWluKHRoZU1vZGVsLCBkb21haW4pIHtcbiAgICBpZiAodGhlTW9kZWwuZG9tYWlucy5pbmRleE9mKGRvbWFpbikgPCAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRvbWFpbiBcXFwiXCIgKyBkb21haW4gKyBcIlxcXCIgbm90IHBhcnQgb2YgbW9kZWxcIik7XG4gICAgfVxuICAgIHZhciByZXMgPSBnZXRSZXN1bHRBc0FycmF5KHRoZU1vZGVsLCBNZXRhRi5Eb21haW4oZG9tYWluKSwgTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9oYXNDYXRlZ29yeSkpO1xuICAgIHJldHVybiBNZXRhLmdldFN0cmluZ0FycmF5KHJlcyk7XG59XG5leHBvcnRzLmdldENhdGVnb3JpZXNGb3JEb21haW4gPSBnZXRDYXRlZ29yaWVzRm9yRG9tYWluO1xuLyoqXG4gKiBSZXR1cm4gYWxsIGNhdGVnb3JpZXMgb2YgYSBkb21haW4gd2hpY2ggY2FuIGFwcGVhciBvbiBhIHdvcmQsXG4gKiB0aGVzZSBhcmUgdHlwaWNhbGx5IHRoZSB3b3JkaW5kZXggZG9tYWlucyArIGVudHJpZXMgZ2VuZXJhdGVkIGJ5IGdlbmVyaWMgcnVsZXNcbiAqXG4gKiBUaGUgY3VycmVudCBpbXBsZW1lbnRhdGlvbiBpcyBhIHNpbXBsaWZpY2F0aW9uXG4gKi9cbmZ1bmN0aW9uIGdldFBvdGVudGlhbFdvcmRDYXRlZ29yaWVzRm9yRG9tYWluKHRoZU1vZGVsLCBkb21haW4pIHtcbiAgICAvLyB0aGlzIGlzIGEgc2ltcGxpZmllZCB2ZXJzaW9uXG4gICAgcmV0dXJuIGdldENhdGVnb3JpZXNGb3JEb21haW4odGhlTW9kZWwsIGRvbWFpbik7XG59XG5leHBvcnRzLmdldFBvdGVudGlhbFdvcmRDYXRlZ29yaWVzRm9yRG9tYWluID0gZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW47XG5mdW5jdGlvbiBnZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsIGNhdGVnb3J5KSB7XG4gICAgaWYgKHRoZU1vZGVsLmNhdGVnb3J5LmluZGV4T2YoY2F0ZWdvcnkpIDwgMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYXRlZ29yeSBcXFwiXCIgKyBjYXRlZ29yeSArIFwiXFxcIiBub3QgcGFydCBvZiBtb2RlbFwiKTtcbiAgICB9XG4gICAgdmFyIHJlcyA9IGdldFJlc3VsdEFzQXJyYXkodGhlTW9kZWwsIE1ldGFGLkNhdGVnb3J5KGNhdGVnb3J5KSwgTWV0YUYuUmVsYXRpb24oTWV0YS5SRUxBVElPTl9pc0NhdGVnb3J5T2YpKTtcbiAgICByZXR1cm4gTWV0YS5nZXRTdHJpbmdBcnJheShyZXMpO1xufVxuZXhwb3J0cy5nZXREb21haW5zRm9yQ2F0ZWdvcnkgPSBnZXREb21haW5zRm9yQ2F0ZWdvcnk7XG5mdW5jdGlvbiBnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcnkobW9kZWwsIGNhdGVnb3J5LCB3b3Jkc29ubHkpIHtcbiAgICB2YXIgcmVzID0ge307XG4gICAgLy9cbiAgICB2YXIgZm4gPSB3b3Jkc29ubHkgPyBnZXRQb3RlbnRpYWxXb3JkQ2F0ZWdvcmllc0ZvckRvbWFpbiA6IGdldENhdGVnb3JpZXNGb3JEb21haW47XG4gICAgdmFyIGRvbWFpbnMgPSBnZXREb21haW5zRm9yQ2F0ZWdvcnkobW9kZWwsIGNhdGVnb3J5KTtcbiAgICBkb21haW5zLmZvckVhY2goZnVuY3Rpb24gKGRvbWFpbikge1xuICAgICAgICBmbihtb2RlbCwgZG9tYWluKS5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkY2F0KSB7XG4gICAgICAgICAgICByZXNbd29yZGNhdF0gPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICBPYmplY3QuZnJlZXplKHJlcyk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuZ2V0QWxsUmVjb3JkQ2F0ZWdvcmllc0ZvclRhcmdldENhdGVnb3J5ID0gZ2V0QWxsUmVjb3JkQ2F0ZWdvcmllc0ZvclRhcmdldENhdGVnb3J5O1xuZnVuY3Rpb24gZ2V0QWxsUmVjb3JkQ2F0ZWdvcmllc0ZvclRhcmdldENhdGVnb3JpZXMobW9kZWwsIGNhdGVnb3JpZXMsIHdvcmRzb25seSkge1xuICAgIHZhciByZXMgPSB7fTtcbiAgICAvL1xuICAgIHZhciBmbiA9IHdvcmRzb25seSA/IGdldFBvdGVudGlhbFdvcmRDYXRlZ29yaWVzRm9yRG9tYWluIDogZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbjtcbiAgICB2YXIgZG9tYWlucyA9IHVuZGVmaW5lZDtcbiAgICBjYXRlZ29yaWVzLmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG4gICAgICAgIHZhciBjYXRkb21haW5zID0gZ2V0RG9tYWluc0ZvckNhdGVnb3J5KG1vZGVsLCBjYXRlZ29yeSk7XG4gICAgICAgIGlmICghZG9tYWlucykge1xuICAgICAgICAgICAgZG9tYWlucyA9IGNhdGRvbWFpbnM7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBkb21haW5zID0gXy5pbnRlcnNlY3Rpb24oZG9tYWlucywgY2F0ZG9tYWlucyk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoZG9tYWlucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYXRlZ29yaWVzICcgKyBVdGlscy5saXN0VG9RdW90ZWRDb21tYUFuZChjYXRlZ29yaWVzKSArICcgaGF2ZSBubyBjb21tb24gZG9tYWluLicpO1xuICAgIH1cbiAgICBkb21haW5zLmZvckVhY2goZnVuY3Rpb24gKGRvbWFpbikge1xuICAgICAgICBmbihtb2RlbCwgZG9tYWluKS5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkY2F0KSB7XG4gICAgICAgICAgICByZXNbd29yZGNhdF0gPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICBPYmplY3QuZnJlZXplKHJlcyk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuZ2V0QWxsUmVjb3JkQ2F0ZWdvcmllc0ZvclRhcmdldENhdGVnb3JpZXMgPSBnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcmllcztcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
