/**
 * Functionality managing the match models
 *
 * @file
 */
"use strict";

var debug = require("debug");
var debuglog = debug('model');
var logger = require("../utils/logger");
var loadlog = logger.logger('modelload', '');
var IMatch = require("../match/ifmatch");
var InputFilterRules = require("../match/inputFilterRules");
var Tools = require("../match/tools");
var fs = require("fs");
var Meta = require("./meta");
var Utils = require("../utils/utils");
var CircularSer = require("../utils/circularser");
var process = require("process");
var _ = require("lodash");
/**
 * the model path, may be controlled via environment variable
 */
var envModelPath = process.env["ABOT_MODELPATH"] || "testmodel";
var ARR_MODEL_PROPERTIES = ["domain", "bitindex", "defaultkeycolumn", "defaulturi", "categoryDescribed", "columns", "description", "tool", "toolhidden", "synonyms", "category", "wordindex", "exactmatch", "hidden"];
function addSynonyms(synonyms, category, synonymFor, bitindex, mRules, seen) {
    synonyms.forEach(function (syn) {
        var oRule = {
            category: category,
            matchedString: synonymFor,
            type: 0 /* WORD */
            , word: syn,
            bitindex: bitindex,
            _ranking: 0.95
        };
        debuglog(debuglog.enabled ? "inserting synonym" + JSON.stringify(oRule) : '-');
        insertRuleIfNotPresent(mRules, oRule, seen);
    });
}
function getRuleKey(rule) {
    var r1 = rule.matchedString + "-|-" + rule.category + " -|- " + rule.type + " -|- " + rule.word + " ";
    if (rule.range) {
        var r2 = getRuleKey(rule.range.rule);
        r1 += " -|- " + rule.range.low + "/" + rule.range.high + " -|- " + r2;
    }
    return r1;
}
var Breakdown = require("../match/breakdown");
/* given a rule which represents a word sequence which is split during tokenization */
function addBestSplit(mRules, rule, seenRules) {
    //if(!global_AddSplits) {
    //    return;
    //}
    if (rule.type !== 0 /* WORD */) {
            return;
        }
    var best = Breakdown.makeMatchPattern(rule.lowercaseword);
    if (!best) {
        return;
    }
    var newRule = {
        category: rule.category,
        matchedString: rule.matchedString,
        bitindex: rule.bitindex,
        word: best.longestToken,
        type: 0,
        lowercaseword: best.longestToken,
        _ranking: 0.95,
        //    exactOnly : rule.exactOnly,
        range: best.span
    };
    if (rule.exactOnly) {
        newRule.exactOnly = rule.exactOnly;
    }
    ;
    newRule.range.rule = rule;
    insertRuleIfNotPresent(mRules, newRule, seenRules);
}
exports.addBestSplit = addBestSplit;
function insertRuleIfNotPresent(mRules, rule, seenRules) {
    if (rule.type !== 0 /* WORD */) {
            mRules.push(rule);
            return;
        }
    if (rule.word === undefined || rule.matchedString === undefined) {
        throw new Error('illegal rule' + JSON.stringify(rule, undefined, 2));
    }
    var r = getRuleKey(rule);
    /* if( (rule.word === "service" || rule.word=== "services") && r.indexOf('OData') >= 0) {
         console.log("rulekey is" + r);
         console.log("presence is " + JSON.stringify(seenRules[r]));
     }*/
    rule.lowercaseword = rule.word.toLowerCase();
    if (seenRules[r]) {
        debuglog(debuglog.enabled ? "Attempting to insert duplicate" + JSON.stringify(rule, undefined, 2) : "-");
        var duplicates = seenRules[r].filter(function (oEntry) {
            return 0 === InputFilterRules.compareMRuleFull(oEntry, rule);
        });
        if (duplicates.length > 0) {
            return;
        }
    }
    seenRules[r] = seenRules[r] || [];
    seenRules[r].push(rule);
    if (rule.word === "") {
        debuglog(debuglog.enabled ? 'Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2) : '-');
        loadlog('Skipping rule with emtpy word ' + JSON.stringify(rule, undefined, 2));
        return;
    }
    mRules.push(rule);
    addBestSplit(mRules, rule, seenRules);
    return;
}
function readFileAsJSON(filename) {
    var data = fs.readFileSync(filename, 'utf-8');
    try {
        return JSON.parse(data);
    } catch (e) {
        console.log("Content of file " + filename + " is no json" + e);
        process.exit(-1);
    }
    return undefined;
}
function loadModelData(modelPath, oMdl, sModelName, oModel) {
    // read the data ->
    // data is processed into mRules directly,
    var bitindex = oMdl.bitindex;
    var sFileName = './' + modelPath + '/' + sModelName + ".data.json";
    var oMdlData = readFileAsJSON(sFileName);
    oMdlData.forEach(function (oEntry) {
        if (!oEntry.domain) {
            oEntry._domain = oMdl.domain;
        }
        if (!oEntry.tool && oMdl.tool.name) {
            oEntry.tool = oMdl.tool.name;
        }
        oModel.records.push(oEntry);
        oMdl.category.forEach(function (cat) {
            if (oEntry[cat] === 'undefined') {
                oEntry[cat] = "n/a";
                var bug = "INCONSISTENT*> ModelData " + sFileName + " does not contain category " + cat + " with value 'undefined', undefined is illegal value, use n/a " + JSON.stringify(oEntry) + "";
                debuglog(bug);
            }
        });
        oMdl.wordindex.forEach(function (category) {
            if (oEntry[category] === undefined) {
                debuglog("INCONSISTENT*> ModelData " + sFileName + " does not contain category " + category + " of wordindex" + JSON.stringify(oEntry) + "");
                return;
            }
            if (oEntry[category] !== "*") {
                var sString = oEntry[category];
                debuglog("pushing rule with " + category + " -> " + sString);
                var oRule = {
                    category: category,
                    matchedString: sString,
                    type: 0 /* WORD */
                    , word: sString,
                    bitindex: bitindex,
                    _ranking: 0.95
                };
                if (oMdl.exactmatch && oMdl.exactmatch.indexOf(category) >= 0) {
                    oRule.exactOnly = true;
                }
                insertRuleIfNotPresent(oModel.mRules, oRule, oModel.seenRules);
                if (oMdlData.synonyms && oMdlData.synonyms[category]) {
                    addSynonyms(oMdlData.synonyms[category], category, sString, bitindex, oModel.mRules, oModel.seenRules);
                }
                if (oEntry.synonyms && oEntry.synonyms[category]) {
                    addSynonyms(oEntry.synonyms[category], category, sString, bitindex, oModel.mRules, oModel.seenRules);
                }
            }
        });
    });
}
function loadModel(modelPath, sModelName, oModel) {
    debuglog(" loading " + sModelName + " ....");
    var oMdl = readFileAsJSON('./' + modelPath + '/' + sModelName + ".model.json");
    mergeModelJson(sModelName, oMdl, oModel);
    loadModelData(modelPath, oMdl, sModelName, oModel);
}
function getDomainBitIndex(domain, oModel) {
    var index = oModel.domains.indexOf(domain);
    if (index < 0) {
        index = oModel.domains.length;
    }
    if (index >= 32) {
        throw new Error("too many domain for single 32 bit index");
    }
    return 0x0001 << index;
}
exports.getDomainBitIndex = getDomainBitIndex;
function mergeModelJson(sModelName, oMdl, oModel) {
    var categoryDescribedMap = {};
    oMdl.bitindex = getDomainBitIndex(oMdl.domain, oModel);
    oMdl.categoryDescribed = [];
    // rectify category
    oMdl.category = oMdl.category.map(function (cat) {
        if (typeof cat === "string") {
            return cat;
        }
        if (typeof cat.name !== "string") {
            console.log("Missing name in object typed category in " + JSON.stringify(cat) + " in model " + sModelName);
            process.exit(-1);
        }
        categoryDescribedMap[cat.name] = cat;
        oMdl.categoryDescribed.push(cat);
        return cat.name;
    });
    // add the categories to the model:
    oMdl.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: 0 /* WORD */
            , word: category,
            lowercaseword: category.toLowerCase(),
            bitindex: oMdl.bitindex,
            _ranking: 0.95
        }, oModel.seenRules);
    });
    if (oModel.domains.indexOf(oMdl.domain) >= 0) {
        debuglog("***********here mdl" + JSON.stringify(oMdl, undefined, 2));
        throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
    }
    // check properties of model
    Object.keys(oMdl).sort().forEach(function (sProperty) {
        if (ARR_MODEL_PROPERTIES.indexOf(sProperty) < 0) {
            throw new Error('Model property "' + sProperty + '" not a known model property in model of domain ' + oMdl.domain + ' ');
        }
    });
    // consider streamlining the categories
    oModel.rawModels[oMdl.domain] = oMdl;
    oModel.full.domain[oMdl.domain] = {
        description: oMdl.description,
        categories: categoryDescribedMap,
        bitindex: oMdl.bitindex
    };
    // check that
    // check that members of wordindex are in categories,
    oMdl.wordindex = oMdl.wordindex || [];
    oMdl.wordindex.forEach(function (sWordIndex) {
        if (oMdl.category.indexOf(sWordIndex) < 0) {
            throw new Error('Model wordindex "' + sWordIndex + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    oMdl.exactmatch = oMdl.exactmatch || [];
    oMdl.exactmatch.forEach(function (sExactMatch) {
        if (oMdl.category.indexOf(sExactMatch) < 0) {
            throw new Error('Model exactmatch "' + sExactMatch + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    oMdl.columns = oMdl.columns || [];
    oMdl.columns.forEach(function (sExactMatch) {
        if (oMdl.category.indexOf(sExactMatch) < 0) {
            throw new Error('Model column "' + sExactMatch + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    // add relation domain -> category
    var domainStr = MetaF.Domain(oMdl.domain).toFullString();
    var relationStr = MetaF.Relation(Meta.RELATION_hasCategory).toFullString();
    var reverseRelationStr = MetaF.Relation(Meta.RELATION_isCategoryOf).toFullString();
    oMdl.category.forEach(function (sCategory) {
        var CategoryString = MetaF.Category(sCategory).toFullString();
        oModel.meta.t3[domainStr] = oModel.meta.t3[domainStr] || {};
        oModel.meta.t3[domainStr][relationStr] = oModel.meta.t3[domainStr][relationStr] || {};
        oModel.meta.t3[domainStr][relationStr][CategoryString] = {};
        oModel.meta.t3[CategoryString] = oModel.meta.t3[CategoryString] || {};
        oModel.meta.t3[CategoryString][reverseRelationStr] = oModel.meta.t3[CategoryString][reverseRelationStr] || {};
        oModel.meta.t3[CategoryString][reverseRelationStr][domainStr] = {};
    });
    // add a precice domain matchrule
    insertRuleIfNotPresent(oModel.mRules, {
        category: "domain",
        matchedString: oMdl.domain,
        type: 0 /* WORD */
        , word: oMdl.domain,
        bitindex: oMdl.bitindex,
        _ranking: 0.95
    }, oModel.seenRules);
    // check the tool
    if (oMdl.tool && oMdl.tool.requires) {
        var requires = Object.keys(oMdl.tool.requires || {});
        var diff = _.difference(requires, oMdl.category);
        if (diff.length > 0) {
            console.log(" " + oMdl.domain + " : Unkown category in requires of tool: \"" + diff.join('"') + '"');
            process.exit(-1);
        }
        var optional = Object.keys(oMdl.tool.optional);
        diff = _.difference(optional, oMdl.category);
        if (diff.length > 0) {
            console.log(" " + oMdl.domain + " : Unkown category optional of tool: \"" + diff.join('"') + '"');
            process.exit(-1);
        }
        Object.keys(oMdl.tool.sets || {}).forEach(function (setID) {
            var diff = _.difference(oMdl.tool.sets[setID].set, oMdl.category);
            if (diff.length > 0) {
                console.log(" " + oMdl.domain + " : Unkown category in setId " + setID + " of tool: \"" + diff.join('"') + '"');
                process.exit(-1);
            }
        });
        // extract tools an add to tools:
        oModel.tools.filter(function (oEntry) {
            if (oEntry.name === (oMdl.tool && oMdl.tool.name)) {
                console.log("Tool " + oMdl.tool.name + " already present when loading " + sModelName);
                //throw new Error('Domain already loaded?');
                process.exit(-1);
            }
        });
    } else {
        oMdl.toolhidden = true;
        oMdl.tool.requires = { "impossible": {} };
    }
    // add the tool name as rule unless hidden
    if (!oMdl.toolhidden && oMdl.tool && oMdl.tool.name) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "tool",
            matchedString: oMdl.tool.name,
            type: 0 /* WORD */
            , word: oMdl.tool.name,
            bitindex: oMdl.bitindex,
            _ranking: 0.95
        }, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms && oMdl.synonyms["tool"]) {
        addSynonyms(oMdl.synonyms["tool"], "tool", oMdl.tool.name, oMdl.bitindex, oModel.mRules, oModel.seenRules);
    }
    ;
    if (oMdl.synonyms) {
        Object.keys(oMdl.synonyms).forEach(function (ssynkey) {
            if (oMdl.category.indexOf(ssynkey) >= 0 && ssynkey !== "tool") {
                if (oModel.full.domain[oMdl.domain].categories[ssynkey]) {
                    oModel.full.domain[oMdl.domain].categories[ssynkey].synonyms = oMdl.synonyms[ssynkey];
                }
                addSynonyms(oMdl.synonyms[ssynkey], "category", ssynkey, oMdl.bitindex, oModel.mRules, oModel.seenRules);
            }
        });
    }
    oModel.domains.push(oMdl.domain);
    if (oMdl.tool.name) {
        oModel.tools.push(oMdl.tool);
    }
    oModel.category = oModel.category.concat(oMdl.category);
    oModel.category.sort();
    oModel.category = oModel.category.filter(function (string, index) {
        return oModel.category[index] !== oModel.category[index + 1];
    });
} // loadmodel
function splitRules(rules) {
    var res = {};
    var nonWordRules = [];
    rules.forEach(function (rule) {
        if (rule.type === 0 /* WORD */) {
                if (!rule.lowercaseword) {
                    throw new Error("Rule has no member lowercaseword" + JSON.stringify(rule));
                }
                res[rule.lowercaseword] = res[rule.lowercaseword] || { bitindex: 0, rules: [] };
                res[rule.lowercaseword].bitindex = res[rule.lowercaseword].bitindex | rule.bitindex;
                res[rule.lowercaseword].rules.push(rule);
            } else {
            nonWordRules.push(rule);
        }
    });
    return {
        wordMap: res,
        nonWordRules: nonWordRules,
        allRules: rules,
        wordCache: {}
    };
}
exports.splitRules = splitRules;
function cmpLengthSort(a, b) {
    var d = a.length - b.length;
    if (d) {
        return d;
    }
    return a.localeCompare(b);
}
var Distance = require("../utils/damerauLevenshtein");
var Algol = require("../match/algol");
// offset[0] : len-2
//             len -1
//             len
//             len +1
//             len +2
//             len +3
function findNextLen(targetLen, arr, offsets) {
    offsets.shift();
    for (var i = offsets[4]; i < arr.length && arr[i].length <= targetLen; ++i) {}
    //console.log("pushing " + i);
    offsets.push(i);
}
exports.findNextLen = findNextLen;
function addRangeRulesUnlessPresent(rules, lcword, rangeRules, presentRulesForKey, seenRules) {
    rangeRules.forEach(function (rangeRule) {
        var newRule = Object.assign({}, rangeRule);
        newRule.lowercaseword = lcword;
        newRule.word = lcword;
        //if((lcword === 'services' || lcword === 'service') && newRule.range.rule.lowercaseword.indexOf('odata')>=0) {
        //    console.log("adding "+ JSON.stringify(newRule) + "\n");
        //}
        //todo: check whether an equivalent rule is already present?
        var cnt = rules.length;
        insertRuleIfNotPresent(rules, newRule, seenRules);
    });
}
exports.addRangeRulesUnlessPresent = addRangeRulesUnlessPresent;
function addCloseExactRangeRules(rules, seenRules) {
    var keysMap = {};
    var rangeKeysMap = {};
    rules.forEach(function (rule) {
        if (rule.type === 0 /* WORD */) {
                //keysMap[rule.lowercaseword] = 1;
                keysMap[rule.lowercaseword] = keysMap[rule.lowercaseword] || [];
                keysMap[rule.lowercaseword].push(rule);
                if (!rule.exactOnly && rule.range) {
                    rangeKeysMap[rule.lowercaseword] = rangeKeysMap[rule.lowercaseword] || [];
                    rangeKeysMap[rule.lowercaseword].push(rule);
                }
            }
    });
    var keys = Object.keys(keysMap);
    keys.sort(cmpLengthSort);
    var len = 0;
    keys.forEach(function (key, index) {
        if (key.length != len) {}
        len = key.length;
    });
    //   keys = keys.slice(0,2000);
    var rangeKeys = Object.keys(rangeKeysMap);
    rangeKeys.sort(cmpLengthSort);
    //console.log(` ${keys.length} keys and ${rangeKeys.length} rangekeys `);
    var low = 0;
    var high = 0;
    var lastlen = 0;
    var offsets = [0, 0, 0, 0, 0, 0];
    var len = rangeKeys.length;
    findNextLen(0, keys, offsets);
    findNextLen(1, keys, offsets);
    findNextLen(2, keys, offsets);
    rangeKeys.forEach(function (rangeKey) {
        if (rangeKey.length !== lastlen) {
            for (i = lastlen + 1; i <= rangeKey.length; ++i) {
                findNextLen(i + 2, keys, offsets);
            }
            //   console.log(` shifted to ${rangeKey.length} with offsets beeing ${offsets.join(' ')}`);
            //   console.log(` here 0 ${offsets[0]} : ${keys[Math.min(keys.length-1, offsets[0])].length}  ${keys[Math.min(keys.length-1, offsets[0])]} `);
            //  console.log(` here 5-1  ${keys[offsets[5]-1].length}  ${keys[offsets[5]-1]} `);
            //   console.log(` here 5 ${offsets[5]} : ${keys[Math.min(keys.length-1, offsets[5])].length}  ${keys[Math.min(keys.length-1, offsets[5])]} `);
            lastlen = rangeKey.length;
        }
        for (var i = offsets[0]; i < offsets[5]; ++i) {
            var d = Distance.calcDistanceAdjusted(rangeKey, keys[i]);
            // console.log(`${rangeKey.length-keys[i].length} ${d} ${rangeKey} and ${keys[i]}  `);
            if (d !== 1.0 && d >= Algol.Cutoff_rangeCloseMatch) {
                //console.log(`would add ${rangeKey} for ${keys[i]} ${d}`);
                var cnt = rules.length;
                // we only have to add if there is not yet a match rule here which points to the same
                addRangeRulesUnlessPresent(rules, keys[i], rangeKeysMap[rangeKey], keysMap[keys[i]], seenRules);
                if (rules.length > cnt) {}
            }
        }
    });
    /*
    [
        ['aEFG','aEFGH'],
        ['aEFGH','aEFGHI'],
        ['Odata','ODatas'],
    ['Odata','Odatas'],
    ['Odata','Odatb'],
    ['Odata','UData'],
    ['service','services'],
    ['this isfunny and more','this isfunny and mores'],
    ].forEach(rec => {
        console.log(`distance ${rec[0]} ${rec[1]} : ${Distance.calcDistance(rec[0],rec[1])}  adf ${Distance.calcDistanceAdjusted(rec[0],rec[1])} `);
     });
    console.log("distance Odata Udata"+ Distance.calcDistance('OData','UData'));
    console.log("distance Odata Odatb"+ Distance.calcDistance('OData','ODatb'));
    console.log("distance Odatas Odata"+ Distance.calcDistance('OData','ODataa'));
    console.log("distance Odatas abcde"+ Distance.calcDistance('abcde','abcdef'));
    console.log("distance services "+ Distance.calcDistance('services','service'));
    */
}
exports.addCloseExactRangeRules = addCloseExactRangeRules;
var n = 0;
function loadModels(modelPath) {
    var oModel;
    oModel = {
        full: { domain: {} },
        rawModels: {},
        domains: [],
        tools: [],
        rules: undefined,
        category: [],
        operators: {},
        mRules: [],
        seenRules: {},
        records: [],
        meta: { t3: {} }
    };
    var t = Date.now();
    modelPath = modelPath || envModelPath;
    try {
        var a = CircularSer.load('./' + modelPath + '/_cachefalse.js');
        //console.log("found a cache ?  " + !!a);
        //a = undefined;
        if (a) {
            debuglog(" return preparese model ");
            if (process.env.ABOT_EMAIL_USER) {
                console.log("loaded models from cache in " + (Date.now() - t) + " ");
            }
            return a;
        }
    } catch (e) {}
    var mdls = readFileAsJSON('./' + modelPath + '/models.json');
    mdls.forEach(function (sModelName) {
        loadModel(modelPath, sModelName, oModel);
    });
    // add the categories to the model:
    /*
    oModel.category.forEach(function (category) {
        insertRuleIfNotPresent(oModel.mRules, {
            category: "category",
            matchedString: category,
            type: IMatch.EnumRuleType.WORD,
            word: category,
            lowercaseword: category.toLowerCase(),
            bitindex : oMdl.
            _ranking: 0.95
        }, oModel.seenRules);
    });
    */
    var metaBitIndex = getDomainBitIndex('meta', oModel);
    // add the domain meta rule
    insertRuleIfNotPresent(oModel.mRules, {
        category: "meta",
        matchedString: "domain",
        type: 0 /* WORD */
        , word: "domain",
        bitindex: metaBitIndex,
        _ranking: 0.95
    }, oModel.seenRules);
    var fillerBitIndex = getDomainBitIndex('meta', oModel);
    //add a filler rule
    var fillers = readFileAsJSON('./' + modelPath + '/filler.json');
    var re = "^((" + fillers.join(")|(") + "))$";
    oModel.mRules.push({
        category: "filler",
        type: 1 /* REGEXP */
        , regexp: new RegExp(re, "i"),
        matchedString: "filler",
        bitindex: fillerBitIndex,
        _ranking: 0.9
    });
    //add operators
    var operators = readFileAsJSON('./resources/model/operators.json');
    var operatorBitIndex = getDomainBitIndex('operators', oModel);
    Object.keys(operators.operators).forEach(function (operator) {
        if (IMatch.aOperatorNames.indexOf(operator) < 0) {
            debuglog("unknown operator " + operator);
            throw new Error("unknown operator " + operator);
        }
        oModel.operators[operator] = operators.operators[operator];
        oModel.operators[operator].operator = operator;
        Object.freeze(oModel.operators[operator]);
        var word = operator;
        insertRuleIfNotPresent(oModel.mRules, {
            category: "operator",
            word: word.toLowerCase(),
            lowercaseword: word.toLowerCase(),
            type: 0 /* WORD */
            , matchedString: word,
            bitindex: operatorBitIndex,
            _ranking: 0.9
        }, oModel.seenRules);
        // add all synonyms
        if (operators.synonyms[operator]) {
            Object.keys(operators.synonyms[operator]).forEach(function (synonym) {
                insertRuleIfNotPresent(oModel.mRules, {
                    category: "operator",
                    word: synonym.toLowerCase(),
                    lowercaseword: synonym.toLowerCase(),
                    type: 0 /* WORD */
                    , matchedString: operator,
                    bitindex: operatorBitIndex,
                    _ranking: 0.9
                }, oModel.seenRules);
            });
        }
    });
    /*
        })
            {
          category: "filler",
          type: 1,
          regexp: /^((start)|(show)|(from)|(in))$/i,
          matchedString: "filler",
          _ranking: 0.9
        },
    */
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    addCloseExactRangeRules(oModel.mRules, oModel.seenRules);
    oModel.mRules = oModel.mRules.sort(InputFilterRules.cmpMRule);
    forceGC();
    oModel.rules = splitRules(oModel.mRules);
    forceGC();
    oModel.tools = oModel.tools.sort(Tools.cmpTools);
    delete oModel.seenRules;
    debuglog('saving');
    forceGC();
    CircularSer.save('./' + modelPath + '/_cachefalse.js', oModel);
    forceGC();
    if (process.env.ABOT_EMAIL_USER) {
        console.log("loaded models by calculation in " + (Date.now() - t) + " ");
    }
    return oModel;
}
exports.loadModels = loadModels;
function sortCategoriesByImportance(map, cats) {
    var res = cats.slice(0);
    res.sort(rankCategoryByImportance.bind(undefined, map));
    return res;
}
exports.sortCategoriesByImportance = sortCategoriesByImportance;
function rankCategoryByImportance(map, cata, catb) {
    var catADesc = map[cata];
    var catBDesc = map[catb];
    if (cata === catb) {
        return 0;
    }
    // if a is before b, return -1
    if (catADesc && !catBDesc) {
        return -1;
    }
    if (!catADesc && catBDesc) {
        return +1;
    }
    var prioA = catADesc && catADesc.importance || 99;
    var prioB = catBDesc && catBDesc.importance || 99;
    // lower prio goes to front
    var r = prioA - prioB;
    if (r) {
        return r;
    }
    return cata.localeCompare(catb);
}
exports.rankCategoryByImportance = rankCategoryByImportance;
var MetaF = Meta.getMetaFactory();
function getOperator(mdl, operator) {
    return mdl.operators[operator];
}
exports.getOperator = getOperator;
function getResultAsArray(mdl, a, rel) {
    if (rel.toType() !== 'relation') {
        throw new Error("expect relation as 2nd arg");
    }
    var res = mdl.meta.t3[a.toFullString()] && mdl.meta.t3[a.toFullString()][rel.toFullString()];
    if (!res) {
        return [];
    }
    return Object.getOwnPropertyNames(res).sort().map(MetaF.parseIMeta);
}
exports.getResultAsArray = getResultAsArray;
function getCategoriesForDomain(theModel, domain) {
    if (theModel.domains.indexOf(domain) < 0) {
        throw new Error("Domain \"" + domain + "\" not part of model");
    }
    var res = getResultAsArray(theModel, MetaF.Domain(domain), MetaF.Relation(Meta.RELATION_hasCategory));
    return Meta.getStringArray(res);
}
exports.getCategoriesForDomain = getCategoriesForDomain;
function getTableColumns(theModel, domain) {
    if (theModel.domains.indexOf(domain) < 0) {
        throw new Error("Domain \"" + domain + "\" not part of model");
    }
    return theModel.rawModels[domain].columns.slice(0);
}
exports.getTableColumns = getTableColumns;
function forceGC() {
    if (global && global.gc) {
        global.gc();
    }
}
/**
 * Return all categories of a domain which can appear on a word,
 * these are typically the wordindex domains + entries generated by generic rules
 *
 * The current implementation is a simplification
 */
function getPotentialWordCategoriesForDomain(theModel, domain) {
    // this is a simplified version
    return getCategoriesForDomain(theModel, domain);
}
exports.getPotentialWordCategoriesForDomain = getPotentialWordCategoriesForDomain;
function getDomainsForCategory(theModel, category) {
    if (theModel.category.indexOf(category) < 0) {
        throw new Error("Category \"" + category + "\" not part of model");
    }
    var res = getResultAsArray(theModel, MetaF.Category(category), MetaF.Relation(Meta.RELATION_isCategoryOf));
    return Meta.getStringArray(res);
}
exports.getDomainsForCategory = getDomainsForCategory;
function getAllRecordCategoriesForTargetCategory(model, category, wordsonly) {
    var res = {};
    //
    var fn = wordsonly ? getPotentialWordCategoriesForDomain : getCategoriesForDomain;
    var domains = getDomainsForCategory(model, category);
    domains.forEach(function (domain) {
        fn(model, domain).forEach(function (wordcat) {
            res[wordcat] = true;
        });
    });
    Object.freeze(res);
    return res;
}
exports.getAllRecordCategoriesForTargetCategory = getAllRecordCategoriesForTargetCategory;
function getAllRecordCategoriesForTargetCategories(model, categories, wordsonly) {
    var res = {};
    //
    var fn = wordsonly ? getPotentialWordCategoriesForDomain : getCategoriesForDomain;
    var domains = undefined;
    categories.forEach(function (category) {
        var catdomains = getDomainsForCategory(model, category);
        if (!domains) {
            domains = catdomains;
        } else {
            domains = _.intersection(domains, catdomains);
        }
    });
    if (domains.length === 0) {
        throw new Error('categories ' + Utils.listToQuotedCommaAnd(categories) + ' have no common domain.');
    }
    domains.forEach(function (domain) {
        fn(model, domain).forEach(function (wordcat) {
            res[wordcat] = true;
        });
    });
    Object.freeze(res);
    return res;
}
exports.getAllRecordCategoriesForTargetCategories = getAllRecordCategoriesForTargetCategories;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb2RlbC50cyIsIm1vZGVsL21vZGVsLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwibG9nZ2VyIiwibG9hZGxvZyIsIklNYXRjaCIsIklucHV0RmlsdGVyUnVsZXMiLCJUb29scyIsImZzIiwiTWV0YSIsIlV0aWxzIiwiQ2lyY3VsYXJTZXIiLCJwcm9jZXNzIiwiXyIsImVudk1vZGVsUGF0aCIsImVudiIsIkFSUl9NT0RFTF9QUk9QRVJUSUVTIiwiYWRkU3lub255bXMiLCJzeW5vbnltcyIsImNhdGVnb3J5Iiwic3lub255bUZvciIsImJpdGluZGV4IiwibVJ1bGVzIiwic2VlbiIsImZvckVhY2giLCJzeW4iLCJvUnVsZSIsIm1hdGNoZWRTdHJpbmciLCJ0eXBlIiwid29yZCIsIl9yYW5raW5nIiwiZW5hYmxlZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJpbnNlcnRSdWxlSWZOb3RQcmVzZW50IiwiZ2V0UnVsZUtleSIsInJ1bGUiLCJyMSIsInJhbmdlIiwicjIiLCJsb3ciLCJoaWdoIiwiQnJlYWtkb3duIiwiYWRkQmVzdFNwbGl0Iiwic2VlblJ1bGVzIiwiYmVzdCIsIm1ha2VNYXRjaFBhdHRlcm4iLCJsb3dlcmNhc2V3b3JkIiwibmV3UnVsZSIsImxvbmdlc3RUb2tlbiIsInNwYW4iLCJleGFjdE9ubHkiLCJleHBvcnRzIiwicHVzaCIsInVuZGVmaW5lZCIsIkVycm9yIiwiciIsInRvTG93ZXJDYXNlIiwiZHVwbGljYXRlcyIsImZpbHRlciIsIm9FbnRyeSIsImNvbXBhcmVNUnVsZUZ1bGwiLCJsZW5ndGgiLCJyZWFkRmlsZUFzSlNPTiIsImZpbGVuYW1lIiwiZGF0YSIsInJlYWRGaWxlU3luYyIsInBhcnNlIiwiZSIsImNvbnNvbGUiLCJsb2ciLCJleGl0IiwibG9hZE1vZGVsRGF0YSIsIm1vZGVsUGF0aCIsIm9NZGwiLCJzTW9kZWxOYW1lIiwib01vZGVsIiwic0ZpbGVOYW1lIiwib01kbERhdGEiLCJkb21haW4iLCJfZG9tYWluIiwidG9vbCIsIm5hbWUiLCJyZWNvcmRzIiwiY2F0IiwiYnVnIiwid29yZGluZGV4Iiwic1N0cmluZyIsImV4YWN0bWF0Y2giLCJpbmRleE9mIiwibG9hZE1vZGVsIiwibWVyZ2VNb2RlbEpzb24iLCJnZXREb21haW5CaXRJbmRleCIsImluZGV4IiwiZG9tYWlucyIsImNhdGVnb3J5RGVzY3JpYmVkTWFwIiwiY2F0ZWdvcnlEZXNjcmliZWQiLCJtYXAiLCJPYmplY3QiLCJrZXlzIiwic29ydCIsInNQcm9wZXJ0eSIsInJhd01vZGVscyIsImZ1bGwiLCJkZXNjcmlwdGlvbiIsImNhdGVnb3JpZXMiLCJzV29yZEluZGV4Iiwic0V4YWN0TWF0Y2giLCJjb2x1bW5zIiwiZG9tYWluU3RyIiwiTWV0YUYiLCJEb21haW4iLCJ0b0Z1bGxTdHJpbmciLCJyZWxhdGlvblN0ciIsIlJlbGF0aW9uIiwiUkVMQVRJT05faGFzQ2F0ZWdvcnkiLCJyZXZlcnNlUmVsYXRpb25TdHIiLCJSRUxBVElPTl9pc0NhdGVnb3J5T2YiLCJzQ2F0ZWdvcnkiLCJDYXRlZ29yeVN0cmluZyIsIkNhdGVnb3J5IiwibWV0YSIsInQzIiwicmVxdWlyZXMiLCJkaWZmIiwiZGlmZmVyZW5jZSIsImpvaW4iLCJvcHRpb25hbCIsInNldHMiLCJzZXRJRCIsInNldCIsInRvb2xzIiwidG9vbGhpZGRlbiIsInNzeW5rZXkiLCJjb25jYXQiLCJzdHJpbmciLCJzcGxpdFJ1bGVzIiwicnVsZXMiLCJyZXMiLCJub25Xb3JkUnVsZXMiLCJ3b3JkTWFwIiwiYWxsUnVsZXMiLCJ3b3JkQ2FjaGUiLCJjbXBMZW5ndGhTb3J0IiwiYSIsImIiLCJkIiwibG9jYWxlQ29tcGFyZSIsIkRpc3RhbmNlIiwiQWxnb2wiLCJmaW5kTmV4dExlbiIsInRhcmdldExlbiIsImFyciIsIm9mZnNldHMiLCJzaGlmdCIsImkiLCJhZGRSYW5nZVJ1bGVzVW5sZXNzUHJlc2VudCIsImxjd29yZCIsInJhbmdlUnVsZXMiLCJwcmVzZW50UnVsZXNGb3JLZXkiLCJyYW5nZVJ1bGUiLCJhc3NpZ24iLCJjbnQiLCJhZGRDbG9zZUV4YWN0UmFuZ2VSdWxlcyIsImtleXNNYXAiLCJyYW5nZUtleXNNYXAiLCJsZW4iLCJrZXkiLCJyYW5nZUtleXMiLCJsYXN0bGVuIiwicmFuZ2VLZXkiLCJjYWxjRGlzdGFuY2VBZGp1c3RlZCIsIkN1dG9mZl9yYW5nZUNsb3NlTWF0Y2giLCJuIiwibG9hZE1vZGVscyIsIm9wZXJhdG9ycyIsInQiLCJEYXRlIiwibm93IiwibG9hZCIsIkFCT1RfRU1BSUxfVVNFUiIsIm1kbHMiLCJtZXRhQml0SW5kZXgiLCJmaWxsZXJCaXRJbmRleCIsImZpbGxlcnMiLCJyZSIsInJlZ2V4cCIsIlJlZ0V4cCIsIm9wZXJhdG9yQml0SW5kZXgiLCJvcGVyYXRvciIsImFPcGVyYXRvck5hbWVzIiwiZnJlZXplIiwic3lub255bSIsImNtcE1SdWxlIiwiZm9yY2VHQyIsImNtcFRvb2xzIiwic2F2ZSIsInNvcnRDYXRlZ29yaWVzQnlJbXBvcnRhbmNlIiwiY2F0cyIsInNsaWNlIiwicmFua0NhdGVnb3J5QnlJbXBvcnRhbmNlIiwiYmluZCIsImNhdGEiLCJjYXRiIiwiY2F0QURlc2MiLCJjYXRCRGVzYyIsInByaW9BIiwiaW1wb3J0YW5jZSIsInByaW9CIiwiZ2V0TWV0YUZhY3RvcnkiLCJnZXRPcGVyYXRvciIsIm1kbCIsImdldFJlc3VsdEFzQXJyYXkiLCJyZWwiLCJ0b1R5cGUiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwicGFyc2VJTWV0YSIsImdldENhdGVnb3JpZXNGb3JEb21haW4iLCJ0aGVNb2RlbCIsImdldFN0cmluZ0FycmF5IiwiZ2V0VGFibGVDb2x1bW5zIiwiZ2xvYmFsIiwiZ2MiLCJnZXRQb3RlbnRpYWxXb3JkQ2F0ZWdvcmllc0ZvckRvbWFpbiIsImdldERvbWFpbnNGb3JDYXRlZ29yeSIsImdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yeSIsIm1vZGVsIiwid29yZHNvbmx5IiwiZm4iLCJ3b3JkY2F0IiwiZ2V0QWxsUmVjb3JkQ2F0ZWdvcmllc0ZvclRhcmdldENhdGVnb3JpZXMiLCJjYXRkb21haW5zIiwiaW50ZXJzZWN0aW9uIiwibGlzdFRvUXVvdGVkQ29tbWFBbmQiXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQ0tBOztBREVBLElBQUFBLFFBQUFDLFFBQUEsT0FBQSxDQUFBO0FBRUEsSUFBSUMsV0FBV0YsTUFBTSxPQUFOLENBQWY7QUFFQSxJQUFBRyxTQUFBRixRQUFBLGlCQUFBLENBQUE7QUFFQSxJQUFNRyxVQUFVRCxPQUFPQSxNQUFQLENBQWMsV0FBZCxFQUEyQixFQUEzQixDQUFoQjtBQUVBLElBQUFFLFNBQUFKLFFBQUEsa0JBQUEsQ0FBQTtBQUVBLElBQUFLLG1CQUFBTCxRQUFBLDJCQUFBLENBQUE7QUFDQSxJQUFBTSxRQUFBTixRQUFBLGdCQUFBLENBQUE7QUFDQSxJQUFBTyxLQUFBUCxRQUFBLElBQUEsQ0FBQTtBQUNBLElBQUFRLE9BQUFSLFFBQUEsUUFBQSxDQUFBO0FBQ0EsSUFBQVMsUUFBQVQsUUFBQSxnQkFBQSxDQUFBO0FBQ0EsSUFBQVUsY0FBQVYsUUFBQSxzQkFBQSxDQUFBO0FBRUEsSUFBQVcsVUFBQVgsUUFBQSxTQUFBLENBQUE7QUFDQSxJQUFBWSxJQUFBWixRQUFBLFFBQUEsQ0FBQTtBQUNBOzs7QUFHQSxJQUFJYSxlQUFlRixRQUFRRyxHQUFSLENBQVksZ0JBQVosS0FBaUMsV0FBcEQ7QUFvQkEsSUFBTUMsdUJBQXVCLENBQUMsUUFBRCxFQUFXLFVBQVgsRUFBdUIsa0JBQXZCLEVBQTJDLFlBQTNDLEVBQXlELG1CQUF6RCxFQUE4RSxTQUE5RSxFQUF5RixhQUF6RixFQUF3RyxNQUF4RyxFQUFnSCxZQUFoSCxFQUE4SCxVQUE5SCxFQUEwSSxVQUExSSxFQUFzSixXQUF0SixFQUFtSyxZQUFuSyxFQUFpTCxRQUFqTCxDQUE3QjtBQUVBLFNBQUFDLFdBQUEsQ0FBcUJDLFFBQXJCLEVBQXlDQyxRQUF6QyxFQUEyREMsVUFBM0QsRUFBK0VDLFFBQS9FLEVBQWlHQyxNQUFqRyxF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QVV5SSxVQUFWO0FBQ0gsU0FGRCxNQUVPO0FBQ0h6SSxzQkFBVWpGLEVBQUUyTixZQUFGLENBQWUxSSxPQUFmLEVBQXdCeUksVUFBeEIsQ0FBVjtBQUNIO0FBQ0osS0FQRDtBQVFBLFFBQUl6SSxRQUFRaEMsTUFBUixLQUFtQixDQUF2QixFQUEwQjtBQUN0QixjQUFNLElBQUlQLEtBQUosQ0FBVSxnQkFBZ0I3QyxNQUFNK04sb0JBQU4sQ0FBMkJoSSxVQUEzQixDQUFoQixHQUF5RCx5QkFBbkUsQ0FBTjtBQUNIO0FBQ0RYLFlBQVF0RSxPQUFSLENBQWdCLFVBQVV1RCxNQUFWLEVBQWdCO0FBQzVCcUosV0FBR0YsS0FBSCxFQUFVbkosTUFBVixFQUFrQnZELE9BQWxCLENBQTBCLFVBQVU2TSxPQUFWLEVBQWlCO0FBQ3ZDM0YsZ0JBQUkyRixPQUFKLElBQWUsSUFBZjtBQUNILFNBRkQ7QUFHSCxLQUpEO0FBS0FuSSxXQUFPNkYsTUFBUCxDQUFjckQsR0FBZDtBQUNBLFdBQU9BLEdBQVA7QUFDSDtBQXZCRHRGLFFBQUFrTCx5Q0FBQSxHQUFBQSx5Q0FBQSIsImZpbGUiOiJtb2RlbC9tb2RlbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBGdW5jdGlvbmFsaXR5IG1hbmFnaW5nIHRoZSBtYXRjaCBtb2RlbHNcclxuICpcclxuICogQGZpbGVcclxuICovXHJcblxyXG5pbXBvcnQgKiBhcyBpbnRmIGZyb20gJ2NvbnN0YW50cyc7XHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcclxuXHJcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdtb2RlbCcpO1xyXG5cclxuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XHJcblxyXG5jb25zdCBsb2FkbG9nID0gbG9nZ2VyLmxvZ2dlcignbW9kZWxsb2FkJywgJycpO1xyXG5cclxuaW1wb3J0ICogIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvbWF0Y2gnO1xyXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlclJ1bGVzIGZyb20gJy4uL21hdGNoL2lucHV0RmlsdGVyUnVsZXMnO1xyXG5pbXBvcnQgKiBhcyBUb29scyBmcm9tICcuLi9tYXRjaC90b29scyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgTWV0YSBmcm9tICcuL21ldGEnO1xyXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICcuLi91dGlscy91dGlscyc7XHJcbmltcG9ydCAqIGFzIENpcmN1bGFyU2VyIGZyb20gJy4uL3V0aWxzL2NpcmN1bGFyc2VyJztcclxuXHJcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuLyoqXHJcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcclxuICovXHJcbnZhciBlbnZNb2RlbFBhdGggPSBwcm9jZXNzLmVudltcIkFCT1RfTU9ERUxQQVRIXCJdIHx8IFwidGVzdG1vZGVsXCI7XHJcblxyXG4vL2V4cG9ydCBpbnRlcmZhY2UgSU1vZGVscyA9IE1hdGNoLklNb2RlbHM7XHJcblxyXG4vKlxyXG5leHBvcnQgaW50ZXJmYWNlIElNb2RlbHMge1xyXG4gICAgZG9tYWluczogc3RyaW5nW10sXHJcbiAgICB0b29sczogSU1hdGNoLklUb29sW10sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW10sXHJcbiAgICBtUnVsZXM6IElNYXRjaC5tUnVsZVtdLFxyXG4gICAgcmVjb3JkczogYW55W11cclxuICAgIHNlZW5SdWxlcz86IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlIH0sXHJcbiAgICBtZXRhIDoge1xyXG4gICAgICAgIC8vIGVudGl0eSAtPiByZWxhdGlvbiAtPiB0YXJnZXRcclxuICAgICAgICB0MyA6IHsgW2tleTogc3RyaW5nXSA6IHsgW2tleSA6IHN0cmluZ10gOiBhbnkgfX1cclxuICAgIH1cclxufSovXHJcblxyXG50eXBlIElNb2RlbCA9IElNYXRjaC5JTW9kZWw7XHJcblxyXG5jb25zdCBBUlJfTU9ERUxfUFJPUEVSVElFUyA9IFtcImRvbWFpblwiLCBcImJpdGluZGV4XCIsIFwiZGVmYXVsdGtleWNvbHVtblwiLCBcImRlZmF1bHR1cmlcIiwgXCJjYXRlZ29yeURlc2NyaWJlZFwiLCBcImNvbHVtbnNcIiwgXCJkZXNjcmlwdGlvblwiLCBcInRvb2xcIiwgXCJ0b29saGlkZGVuXCIsIFwic3lub255bXNcIiwgXCJjYXRlZ29yeVwiLCBcIndvcmRpbmRleFwiLCBcImV4YWN0bWF0Y2hcIiwgXCJoaWRkZW5cIl07XHJcblxyXG5mdW5jdGlvbiBhZGRTeW5vbnltcyhzeW5vbnltczogc3RyaW5nW10sIGNhdGVnb3J5OiBzdHJpbmcsIHN5bm9ueW1Gb3I6IHN0cmluZywgYml0aW5kZXg6IG51bWJlciwgbVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCBzZWVuOiB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5tUnVsZVtdIH0pIHtcclxuICAgIHN5bm9ueW1zLmZvckVhY2goZnVuY3Rpb24gKHN5bikge1xyXG4gICAgICAgIHZhciBvUnVsZSA9IHtcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzeW5vbnltRm9yLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIHdvcmQ6IHN5bixcclxuICAgICAgICAgICAgYml0aW5kZXg6IGJpdGluZGV4LFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcImluc2VydGluZyBzeW5vbnltXCIgKyBKU09OLnN0cmluZ2lmeShvUnVsZSkpIDogJy0nKTtcclxuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgb1J1bGUsIHNlZW4pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFJ1bGVLZXkocnVsZSkge1xyXG4gICAgdmFyIHIxID0gcnVsZS5tYXRjaGVkU3RyaW5nICsgXCItfC1cIiArIHJ1bGUuY2F0ZWdvcnkgKyBcIiAtfC0gXCIgKyBydWxlLnR5cGUgKyBcIiAtfC0gXCIgKyBydWxlLndvcmQgKyBcIiBcIjtcclxuICAgIGlmIChydWxlLnJhbmdlKSB7XHJcbiAgICAgICAgdmFyIHIyID0gZ2V0UnVsZUtleShydWxlLnJhbmdlLnJ1bGUpO1xyXG4gICAgICAgIHIxICs9IFwiIC18LSBcIiArIHJ1bGUucmFuZ2UubG93ICsgXCIvXCIgKyBydWxlLnJhbmdlLmhpZ2ggKyBcIiAtfC0gXCIgKyByMjtcclxuICAgIH1cclxuICAgIHJldHVybiByMTtcclxufVxyXG5cclxuXHJcbmltcG9ydCAqIGFzIEJyZWFrZG93biBmcm9tICcuLi9tYXRjaC9icmVha2Rvd24nO1xyXG5cclxuLyogZ2l2ZW4gYSBydWxlIHdoaWNoIHJlcHJlc2VudHMgYSB3b3JkIHNlcXVlbmNlIHdoaWNoIGlzIHNwbGl0IGR1cmluZyB0b2tlbml6YXRpb24gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZEJlc3RTcGxpdChtUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4sIHJ1bGU6IElNYXRjaC5tUnVsZSwgc2VlblJ1bGVzOiB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5tUnVsZVtdIH0pIHtcclxuICAgIC8vaWYoIWdsb2JhbF9BZGRTcGxpdHMpIHtcclxuICAgIC8vICAgIHJldHVybjtcclxuICAgIC8vfVxyXG5cclxuICAgIGlmIChydWxlLnR5cGUgIT09IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHZhciBiZXN0ID0gQnJlYWtkb3duLm1ha2VNYXRjaFBhdHRlcm4ocnVsZS5sb3dlcmNhc2V3b3JkKTtcclxuICAgIGlmICghYmVzdCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHZhciBuZXdSdWxlID0ge1xyXG4gICAgICAgIGNhdGVnb3J5OiBydWxlLmNhdGVnb3J5LFxyXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IHJ1bGUubWF0Y2hlZFN0cmluZyxcclxuICAgICAgICBiaXRpbmRleDogcnVsZS5iaXRpbmRleCxcclxuICAgICAgICB3b3JkOiBiZXN0Lmxvbmdlc3RUb2tlbixcclxuICAgICAgICB0eXBlOiAwLFxyXG4gICAgICAgIGxvd2VyY2FzZXdvcmQ6IGJlc3QubG9uZ2VzdFRva2VuLFxyXG4gICAgICAgIF9yYW5raW5nOiAwLjk1LFxyXG4gICAgICAgIC8vICAgIGV4YWN0T25seSA6IHJ1bGUuZXhhY3RPbmx5LFxyXG4gICAgICAgIHJhbmdlOiBiZXN0LnNwYW5cclxuICAgIH0gYXMgSU1hdGNoLm1SdWxlO1xyXG4gICAgaWYgKHJ1bGUuZXhhY3RPbmx5KSB7XHJcbiAgICAgICAgbmV3UnVsZS5leGFjdE9ubHkgPSBydWxlLmV4YWN0T25seVxyXG4gICAgfTtcclxuICAgIG5ld1J1bGUucmFuZ2UucnVsZSA9IHJ1bGU7XHJcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgbmV3UnVsZSwgc2VlblJ1bGVzKTtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGluc2VydFJ1bGVJZk5vdFByZXNlbnQobVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCBydWxlOiBJTWF0Y2gubVJ1bGUsXHJcbiAgICBzZWVuUnVsZXM6IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlW10gfSkge1xyXG5cclxuICAgIGlmIChydWxlLnR5cGUgIT09IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCkge1xyXG4gICAgICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICgocnVsZS53b3JkID09PSB1bmRlZmluZWQpIHx8IChydWxlLm1hdGNoZWRTdHJpbmcgPT09IHVuZGVmaW5lZCkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lsbGVnYWwgcnVsZScgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcclxuICAgIH1cclxuICAgIHZhciByID0gZ2V0UnVsZUtleShydWxlKTtcclxuICAgIC8qIGlmKCAocnVsZS53b3JkID09PSBcInNlcnZpY2VcIiB8fCBydWxlLndvcmQ9PT0gXCJzZXJ2aWNlc1wiKSAmJiByLmluZGV4T2YoJ09EYXRhJykgPj0gMCkge1xyXG4gICAgICAgICBjb25zb2xlLmxvZyhcInJ1bGVrZXkgaXNcIiArIHIpO1xyXG4gICAgICAgICBjb25zb2xlLmxvZyhcInByZXNlbmNlIGlzIFwiICsgSlNPTi5zdHJpbmdpZnkoc2VlblJ1bGVzW3JdKSk7XHJcbiAgICAgfSovXHJcbiAgICBydWxlLmxvd2VyY2FzZXdvcmQgPSBydWxlLndvcmQudG9Mb3dlckNhc2UoKTtcclxuICAgIGlmIChzZWVuUnVsZXNbcl0pIHtcclxuICAgICAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKFwiQXR0ZW1wdGluZyB0byBpbnNlcnQgZHVwbGljYXRlXCIgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKSA6IFwiLVwiKTtcclxuICAgICAgICB2YXIgZHVwbGljYXRlcyA9IHNlZW5SdWxlc1tyXS5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xyXG4gICAgICAgICAgICByZXR1cm4gMCA9PT0gSW5wdXRGaWx0ZXJSdWxlcy5jb21wYXJlTVJ1bGVGdWxsKG9FbnRyeSwgcnVsZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGR1cGxpY2F0ZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc2VlblJ1bGVzW3JdID0gKHNlZW5SdWxlc1tyXSB8fCBbXSk7XHJcbiAgICBzZWVuUnVsZXNbcl0ucHVzaChydWxlKTtcclxuICAgIGlmIChydWxlLndvcmQgPT09IFwiXCIpIHtcclxuICAgICAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKCdTa2lwcGluZyBydWxlIHdpdGggZW10cHkgd29yZCAnICsgSlNPTi5zdHJpbmdpZnkocnVsZSwgdW5kZWZpbmVkLCAyKSkgOiAnLScpO1xyXG4gICAgICAgIGxvYWRsb2coJ1NraXBwaW5nIHJ1bGUgd2l0aCBlbXRweSB3b3JkICcgKyBKU09OLnN0cmluZ2lmeShydWxlLCB1bmRlZmluZWQsIDIpKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBtUnVsZXMucHVzaChydWxlKTtcclxuICAgIGFkZEJlc3RTcGxpdChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcyk7XHJcbiAgICByZXR1cm47XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlYWRGaWxlQXNKU09OKGZpbGVuYW1lIDogc3RyaW5nKSA6IGFueSB7XHJcbiAgICB2YXIgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlbmFtZSwgJ3V0Zi04Jyk7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpO1xyXG4gICAgfSBjYXRjaChlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJDb250ZW50IG9mIGZpbGUgXCIrIGZpbGVuYW1lICsgXCIgaXMgbm8ganNvblwiICsgZSk7XHJcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRNb2RlbERhdGEobW9kZWxQYXRoOiBzdHJpbmcsIG9NZGw6IElNb2RlbCwgc01vZGVsTmFtZTogc3RyaW5nLCBvTW9kZWw6IElNYXRjaC5JTW9kZWxzKSB7XHJcbiAgICAvLyByZWFkIHRoZSBkYXRhIC0+XHJcbiAgICAvLyBkYXRhIGlzIHByb2Nlc3NlZCBpbnRvIG1SdWxlcyBkaXJlY3RseSxcclxuICAgIHZhciBiaXRpbmRleCA9IG9NZGwuYml0aW5kZXg7XHJcbiAgICBjb25zdCBzRmlsZU5hbWUgPSAoJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5kYXRhLmpzb25cIik7XHJcbiAgICB2YXIgb01kbERhdGE9IHJlYWRGaWxlQXNKU09OKHNGaWxlTmFtZSk7XHJcbiAgICBvTWRsRGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICBpZiAoIW9FbnRyeS5kb21haW4pIHtcclxuICAgICAgICAgICAgb0VudHJ5Ll9kb21haW4gPSBvTWRsLmRvbWFpbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFvRW50cnkudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkge1xyXG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvTW9kZWwucmVjb3Jkcy5wdXNoKG9FbnRyeSk7XHJcbiAgICAgICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXQpIHtcclxuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRdID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgICAgICAgb0VudHJ5W2NhdF0gPSBcIm4vYVwiO1xyXG4gICAgICAgICAgICAgICAgdmFyIGJ1ZyA9XHJcbiAgICAgICAgICAgICAgICAgICAgXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiICsgY2F0ICsgXCIgd2l0aCB2YWx1ZSAndW5kZWZpbmVkJywgdW5kZWZpbmVkIGlzIGlsbGVnYWwgdmFsdWUsIHVzZSBuL2EgXCIgKyBKU09OLnN0cmluZ2lmeShvRW50cnkpICsgXCJcIjtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKGJ1Zyk7XHJcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGJ1Zyk7XHJcbiAgICAgICAgICAgICAgICAvL3Byb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICBvTWRsLndvcmRpbmRleC5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xyXG4gICAgICAgICAgICBpZiAob0VudHJ5W2NhdGVnb3J5XSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIklOQ09OU0lTVEVOVCo+IE1vZGVsRGF0YSBcIiArIHNGaWxlTmFtZSArIFwiIGRvZXMgbm90IGNvbnRhaW4gY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIG9mIHdvcmRpbmRleFwiICsgSlNPTi5zdHJpbmdpZnkob0VudHJ5KSArIFwiXCIpXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0gIT09IFwiKlwiKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc1N0cmluZyA9IG9FbnRyeVtjYXRlZ29yeV07XHJcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcInB1c2hpbmcgcnVsZSB3aXRoIFwiICsgY2F0ZWdvcnkgKyBcIiAtPiBcIiArIHNTdHJpbmcpO1xyXG4gICAgICAgICAgICAgICAgdmFyIG9SdWxlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICAgICAgICAgICAgICB3b3JkOiBzU3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgIGJpdGluZGV4OiBiaXRpbmRleCxcclxuICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgICAgICAgICAgfSBhcyBJTWF0Y2gubVJ1bGU7XHJcbiAgICAgICAgICAgICAgICBpZiAob01kbC5leGFjdG1hdGNoICYmIG9NZGwuZXhhY3RtYXRjaC5pbmRleE9mKGNhdGVnb3J5KSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb1J1bGUuZXhhY3RPbmx5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywgb1J1bGUsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9NZGxEYXRhLnN5bm9ueW1zICYmIG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGxEYXRhLnN5bm9ueW1zW2NhdGVnb3J5XSwgY2F0ZWdvcnksIHNTdHJpbmcsIGJpdGluZGV4LCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChvRW50cnkuc3lub255bXMgJiYgb0VudHJ5LnN5bm9ueW1zW2NhdGVnb3J5XSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9FbnRyeS5zeW5vbnltc1tjYXRlZ29yeV0sIGNhdGVnb3J5LCBzU3RyaW5nLCBiaXRpbmRleCwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5cclxuXHJcblxyXG5mdW5jdGlvbiBsb2FkTW9kZWwobW9kZWxQYXRoOiBzdHJpbmcsIHNNb2RlbE5hbWU6IHN0cmluZywgb01vZGVsOiBJTWF0Y2guSU1vZGVscykge1xyXG4gICAgZGVidWdsb2coXCIgbG9hZGluZyBcIiArIHNNb2RlbE5hbWUgKyBcIiAuLi4uXCIpO1xyXG4gICAgdmFyIG9NZGwgPSByZWFkRmlsZUFzSlNPTignLi8nICsgbW9kZWxQYXRoICsgJy8nICsgc01vZGVsTmFtZSArIFwiLm1vZGVsLmpzb25cIikgYXMgSU1vZGVsO1xyXG4gICAgbWVyZ2VNb2RlbEpzb24oc01vZGVsTmFtZSwgb01kbCwgb01vZGVsKTtcclxuICAgIGxvYWRNb2RlbERhdGEobW9kZWxQYXRoLCBvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RG9tYWluQml0SW5kZXgoZG9tYWluOiBzdHJpbmcsIG9Nb2RlbDogSU1hdGNoLklNb2RlbHMpOiBudW1iZXIge1xyXG4gICAgdmFyIGluZGV4ID0gb01vZGVsLmRvbWFpbnMuaW5kZXhPZihkb21haW4pO1xyXG4gICAgaWYgKGluZGV4IDwgMCkge1xyXG4gICAgICAgIGluZGV4ID0gb01vZGVsLmRvbWFpbnMubGVuZ3RoO1xyXG4gICAgfVxyXG4gICAgaWYgKGluZGV4ID49IDMyKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidG9vIG1hbnkgZG9tYWluIGZvciBzaW5nbGUgMzIgYml0IGluZGV4XCIpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIDB4MDAwMSA8PCBpbmRleDtcclxufVxyXG5cclxuZnVuY3Rpb24gbWVyZ2VNb2RlbEpzb24oc01vZGVsTmFtZTogc3RyaW5nLCBvTWRsOiBJTW9kZWwsIG9Nb2RlbDogSU1hdGNoLklNb2RlbHMpIHtcclxuICAgIHZhciBjYXRlZ29yeURlc2NyaWJlZE1hcCA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSU1hdGNoLklDYXRlZ29yeURlc2MgfTtcclxuICAgIG9NZGwuYml0aW5kZXggPSBnZXREb21haW5CaXRJbmRleChvTWRsLmRvbWFpbiwgb01vZGVsKTtcclxuICAgIG9NZGwuY2F0ZWdvcnlEZXNjcmliZWQgPSBbXTtcclxuICAgIC8vIHJlY3RpZnkgY2F0ZWdvcnlcclxuICAgIG9NZGwuY2F0ZWdvcnkgPSBvTWRsLmNhdGVnb3J5Lm1hcChmdW5jdGlvbiAoY2F0OiBhbnkpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGNhdCA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICByZXR1cm4gY2F0O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIGNhdC5uYW1lICE9PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTWlzc2luZyBuYW1lIGluIG9iamVjdCB0eXBlZCBjYXRlZ29yeSBpbiBcIiArIEpTT04uc3RyaW5naWZ5KGNhdCkgKyBcIiBpbiBtb2RlbCBcIiArIHNNb2RlbE5hbWUpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgYWxyZWFkeSBsb2FkZWQgd2hpbGUgbG9hZGluZyAnICsgc01vZGVsTmFtZSArICc/Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGVnb3J5RGVzY3JpYmVkTWFwW2NhdC5uYW1lXSA9IGNhdDtcclxuICAgICAgICBvTWRsLmNhdGVnb3J5RGVzY3JpYmVkLnB1c2goY2F0KTtcclxuICAgICAgICByZXR1cm4gY2F0Lm5hbWU7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGNhdGVnb3JpZXMgdG8gdGhlIG1vZGVsOlxyXG4gICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgYml0aW5kZXg6IG9NZGwuYml0aW5kZXgsXHJcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAob01vZGVsLmRvbWFpbnMuaW5kZXhPZihvTWRsLmRvbWFpbikgPj0gMCkge1xyXG4gICAgICAgIGRlYnVnbG9nKFwiKioqKioqKioqKipoZXJlIG1kbFwiICsgSlNPTi5zdHJpbmdpZnkob01kbCwgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb21haW4gJyArIG9NZGwuZG9tYWluICsgJyBhbHJlYWR5IGxvYWRlZCB3aGlsZSBsb2FkaW5nICcgKyBzTW9kZWxOYW1lICsgJz8nKTtcclxuICAgIH1cclxuICAgIC8vIGNoZWNrIHByb3BlcnRpZXMgb2YgbW9kZWxcclxuICAgIE9iamVjdC5rZXlzKG9NZGwpLnNvcnQoKS5mb3JFYWNoKGZ1bmN0aW9uIChzUHJvcGVydHkpIHtcclxuICAgICAgICBpZiAoQVJSX01PREVMX1BST1BFUlRJRVMuaW5kZXhPZihzUHJvcGVydHkpIDwgMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIHByb3BlcnR5IFwiJyArIHNQcm9wZXJ0eSArICdcIiBub3QgYSBrbm93biBtb2RlbCBwcm9wZXJ0eSBpbiBtb2RlbCBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8vIGNvbnNpZGVyIHN0cmVhbWxpbmluZyB0aGUgY2F0ZWdvcmllc1xyXG4gICAgb01vZGVsLnJhd01vZGVsc1tvTWRsLmRvbWFpbl0gPSBvTWRsO1xyXG5cclxuICAgIG9Nb2RlbC5mdWxsLmRvbWFpbltvTWRsLmRvbWFpbl0gPSB7XHJcbiAgICAgICAgZGVzY3JpcHRpb246IG9NZGwuZGVzY3JpcHRpb24sXHJcbiAgICAgICAgY2F0ZWdvcmllczogY2F0ZWdvcnlEZXNjcmliZWRNYXAsXHJcbiAgICAgICAgYml0aW5kZXg6IG9NZGwuYml0aW5kZXhcclxuICAgIH07XHJcblxyXG4gICAgLy8gY2hlY2sgdGhhdFxyXG5cclxuXHJcbiAgICAvLyBjaGVjayB0aGF0IG1lbWJlcnMgb2Ygd29yZGluZGV4IGFyZSBpbiBjYXRlZ29yaWVzLFxyXG4gICAgb01kbC53b3JkaW5kZXggPSBvTWRsLndvcmRpbmRleCB8fCBbXTtcclxuICAgIG9NZGwud29yZGluZGV4LmZvckVhY2goZnVuY3Rpb24gKHNXb3JkSW5kZXgpIHtcclxuICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNXb3JkSW5kZXgpIDwgMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIHdvcmRpbmRleCBcIicgKyBzV29yZEluZGV4ICsgJ1wiIG5vdCBhIGNhdGVnb3J5IG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgb01kbC5leGFjdG1hdGNoID0gb01kbC5leGFjdG1hdGNoIHx8IFtdO1xyXG4gICAgb01kbC5leGFjdG1hdGNoLmZvckVhY2goZnVuY3Rpb24gKHNFeGFjdE1hdGNoKSB7XHJcbiAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzRXhhY3RNYXRjaCkgPCAwKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgZXhhY3RtYXRjaCBcIicgKyBzRXhhY3RNYXRjaCArICdcIiBub3QgYSBjYXRlZ29yeSBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIG9NZGwuY29sdW1ucyA9IG9NZGwuY29sdW1ucyB8fCBbXTtcclxuICAgIG9NZGwuY29sdW1ucy5mb3JFYWNoKGZ1bmN0aW9uIChzRXhhY3RNYXRjaCkge1xyXG4gICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc0V4YWN0TWF0Y2gpIDwgMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIGNvbHVtbiBcIicgKyBzRXhhY3RNYXRjaCArICdcIiBub3QgYSBjYXRlZ29yeSBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcblxyXG4gICAgLy8gYWRkIHJlbGF0aW9uIGRvbWFpbiAtPiBjYXRlZ29yeVxyXG4gICAgdmFyIGRvbWFpblN0ciA9IE1ldGFGLkRvbWFpbihvTWRsLmRvbWFpbikudG9GdWxsU3RyaW5nKCk7XHJcbiAgICB2YXIgcmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2hhc0NhdGVnb3J5KS50b0Z1bGxTdHJpbmcoKTtcclxuICAgIHZhciByZXZlcnNlUmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikudG9GdWxsU3RyaW5nKCk7XHJcbiAgICBvTWRsLmNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24gKHNDYXRlZ29yeSkge1xyXG5cclxuICAgICAgICB2YXIgQ2F0ZWdvcnlTdHJpbmcgPSBNZXRhRi5DYXRlZ29yeShzQ2F0ZWdvcnkpLnRvRnVsbFN0cmluZygpO1xyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl0gPSBvTW9kZWwubWV0YS50M1tkb21haW5TdHJdIHx8IHt9O1xyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdID0gb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl0gfHwge307XHJcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl1bQ2F0ZWdvcnlTdHJpbmddID0ge307XHJcblxyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXSA9IG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXSB8fCB7fTtcclxuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ11bcmV2ZXJzZVJlbGF0aW9uU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdIHx8IHt9O1xyXG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdW2RvbWFpblN0cl0gPSB7fTtcclxuXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBhZGQgYSBwcmVjaWNlIGRvbWFpbiBtYXRjaHJ1bGVcclxuICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgIGNhdGVnb3J5OiBcImRvbWFpblwiLFxyXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwuZG9tYWluLFxyXG4gICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcclxuICAgICAgICB3b3JkOiBvTWRsLmRvbWFpbixcclxuICAgICAgICBiaXRpbmRleDogb01kbC5iaXRpbmRleCxcclxuICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcblxyXG4gICAgLy8gY2hlY2sgdGhlIHRvb2xcclxuICAgIGlmIChvTWRsLnRvb2wgJiYgb01kbC50b29sLnJlcXVpcmVzKSB7XHJcbiAgICAgICAgdmFyIHJlcXVpcmVzID0gT2JqZWN0LmtleXMob01kbC50b29sLnJlcXVpcmVzIHx8IHt9KTtcclxuICAgICAgICB2YXIgZGlmZiA9IF8uZGlmZmVyZW5jZShyZXF1aXJlcywgb01kbC5jYXRlZ29yeSk7XHJcbiAgICAgICAgaWYgKGRpZmYubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgICR7b01kbC5kb21haW59IDogVW5rb3duIGNhdGVnb3J5IGluIHJlcXVpcmVzIG9mIHRvb2w6IFwiYCArIGRpZmYuam9pbignXCInKSArICdcIicpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgb3B0aW9uYWwgPSBPYmplY3Qua2V5cyhvTWRsLnRvb2wub3B0aW9uYWwpO1xyXG4gICAgICAgIGRpZmYgPSBfLmRpZmZlcmVuY2Uob3B0aW9uYWwsIG9NZGwuY2F0ZWdvcnkpO1xyXG4gICAgICAgIGlmIChkaWZmLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYCAke29NZGwuZG9tYWlufSA6IFVua293biBjYXRlZ29yeSBvcHRpb25hbCBvZiB0b29sOiBcImAgKyBkaWZmLmpvaW4oJ1wiJykgKyAnXCInKTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC50b29sLnNldHMgfHwge30pLmZvckVhY2goZnVuY3Rpb24gKHNldElEKSB7XHJcbiAgICAgICAgICAgIHZhciBkaWZmID0gXy5kaWZmZXJlbmNlKG9NZGwudG9vbC5zZXRzW3NldElEXS5zZXQsIG9NZGwuY2F0ZWdvcnkpO1xyXG4gICAgICAgICAgICBpZiAoZGlmZi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgICR7b01kbC5kb21haW59IDogVW5rb3duIGNhdGVnb3J5IGluIHNldElkICR7c2V0SUR9IG9mIHRvb2w6IFwiYCArIGRpZmYuam9pbignXCInKSArICdcIicpO1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBleHRyYWN0IHRvb2xzIGFuIGFkZCB0byB0b29sczpcclxuICAgICAgICBvTW9kZWwudG9vbHMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcclxuICAgICAgICAgICAgaWYgKG9FbnRyeS5uYW1lID09PSAob01kbC50b29sICYmIG9NZGwudG9vbC5uYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJUb29sIFwiICsgb01kbC50b29sLm5hbWUgKyBcIiBhbHJlYWR5IHByZXNlbnQgd2hlbiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluIGFscmVhZHkgbG9hZGVkPycpO1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBvTWRsLnRvb2xoaWRkZW4gPSB0cnVlO1xyXG4gICAgICAgIG9NZGwudG9vbC5yZXF1aXJlcyA9IHsgXCJpbXBvc3NpYmxlXCI6IHt9IH07XHJcbiAgICB9XHJcbiAgICAvLyBhZGQgdGhlIHRvb2wgbmFtZSBhcyBydWxlIHVubGVzcyBoaWRkZW5cclxuICAgIGlmICghb01kbC50b29saGlkZGVuICYmIG9NZGwudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkge1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJ0b29sXCIsXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwudG9vbC5uYW1lLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIHdvcmQ6IG9NZGwudG9vbC5uYW1lLFxyXG4gICAgICAgICAgICBiaXRpbmRleDogb01kbC5iaXRpbmRleCxcclxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcclxuICAgICAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuICAgIH07XHJcbiAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW1widG9vbFwiXSkge1xyXG4gICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbXCJ0b29sXCJdLCBcInRvb2xcIiwgb01kbC50b29sLm5hbWUsIG9NZGwuYml0aW5kZXgsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgfTtcclxuICAgIGlmIChvTWRsLnN5bm9ueW1zKSB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMob01kbC5zeW5vbnltcykuZm9yRWFjaChmdW5jdGlvbiAoc3N5bmtleSkge1xyXG4gICAgICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNzeW5rZXkpID49IDAgJiYgc3N5bmtleSAhPT0gXCJ0b29sXCIpIHtcclxuICAgICAgICAgICAgICAgIGlmIChvTW9kZWwuZnVsbC5kb21haW5bb01kbC5kb21haW5dLmNhdGVnb3JpZXNbc3N5bmtleV0pIHtcclxuICAgICAgICAgICAgICAgICAgICBvTW9kZWwuZnVsbC5kb21haW5bb01kbC5kb21haW5dLmNhdGVnb3JpZXNbc3N5bmtleV0uc3lub255bXMgPSBvTWRsLnN5bm9ueW1zW3NzeW5rZXldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGFkZFN5bm9ueW1zKG9NZGwuc3lub255bXNbc3N5bmtleV0sIFwiY2F0ZWdvcnlcIiwgc3N5bmtleSwgb01kbC5iaXRpbmRleCwgb01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIG9Nb2RlbC5kb21haW5zLnB1c2gob01kbC5kb21haW4pO1xyXG4gICAgaWYgKG9NZGwudG9vbC5uYW1lKSB7XHJcbiAgICAgICAgb01vZGVsLnRvb2xzLnB1c2gob01kbC50b29sKTtcclxuICAgIH1cclxuICAgIG9Nb2RlbC5jYXRlZ29yeSA9IG9Nb2RlbC5jYXRlZ29yeS5jb25jYXQob01kbC5jYXRlZ29yeSk7XHJcbiAgICBvTW9kZWwuY2F0ZWdvcnkuc29ydCgpO1xyXG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmZpbHRlcihmdW5jdGlvbiAoc3RyaW5nLCBpbmRleCkge1xyXG4gICAgICAgIHJldHVybiBvTW9kZWwuY2F0ZWdvcnlbaW5kZXhdICE9PSBvTW9kZWwuY2F0ZWdvcnlbaW5kZXggKyAxXTtcclxuICAgIH0pO1xyXG5cclxufSAvLyBsb2FkbW9kZWxcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzcGxpdFJ1bGVzKHJ1bGVzOiBJTWF0Y2gubVJ1bGVbXSk6IElNYXRjaC5TcGxpdFJ1bGVzIHtcclxuICAgIHZhciByZXMgPSB7fTtcclxuICAgIHZhciBub25Xb3JkUnVsZXMgPSBbXTtcclxuICAgIHJ1bGVzLmZvckVhY2goZnVuY3Rpb24gKHJ1bGUpIHtcclxuICAgICAgICBpZiAocnVsZS50eXBlID09PSBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQpIHtcclxuICAgICAgICAgICAgaWYgKCFydWxlLmxvd2VyY2FzZXdvcmQpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlJ1bGUgaGFzIG5vIG1lbWJlciBsb3dlcmNhc2V3b3JkXCIgKyBKU09OLnN0cmluZ2lmeShydWxlKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzW3J1bGUubG93ZXJjYXNld29yZF0gPSByZXNbcnVsZS5sb3dlcmNhc2V3b3JkXSB8fCB7IGJpdGluZGV4OiAwLCBydWxlczogW10gfTtcclxuICAgICAgICAgICAgcmVzW3J1bGUubG93ZXJjYXNld29yZF0uYml0aW5kZXggPSByZXNbcnVsZS5sb3dlcmNhc2V3b3JkXS5iaXRpbmRleCB8IHJ1bGUuYml0aW5kZXg7XHJcbiAgICAgICAgICAgIHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdLnJ1bGVzLnB1c2gocnVsZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbm9uV29yZFJ1bGVzLnB1c2gocnVsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHdvcmRNYXA6IHJlcyxcclxuICAgICAgICBub25Xb3JkUnVsZXM6IG5vbldvcmRSdWxlcyxcclxuICAgICAgICBhbGxSdWxlczogcnVsZXMsXHJcbiAgICAgICAgd29yZENhY2hlIDoge31cclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNtcExlbmd0aFNvcnQoYTogc3RyaW5nLCBiOiBzdHJpbmcpIHtcclxuICAgIHZhciBkID0gYS5sZW5ndGggLSBiLmxlbmd0aDtcclxuICAgIGlmIChkKSB7XHJcbiAgICAgICAgcmV0dXJuIGQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYS5sb2NhbGVDb21wYXJlKGIpO1xyXG59XHJcblxyXG5pbXBvcnQgKiBhcyBEaXN0YW5jZSBmcm9tICcuLi91dGlscy9kYW1lcmF1TGV2ZW5zaHRlaW4nO1xyXG5pbXBvcnQgKiBhcyBBbGdvbCBmcm9tICcuLi9tYXRjaC9hbGdvbCc7XHJcbi8vIG9mZnNldFswXSA6IGxlbi0yXHJcbi8vICAgICAgICAgICAgIGxlbiAtMVxyXG4vLyAgICAgICAgICAgICBsZW5cclxuLy8gICAgICAgICAgICAgbGVuICsxXHJcbi8vICAgICAgICAgICAgIGxlbiArMlxyXG4vLyAgICAgICAgICAgICBsZW4gKzNcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kTmV4dExlbih0YXJnZXRMZW46IG51bWJlciwgYXJyOiBzdHJpbmdbXSwgb2Zmc2V0czogbnVtYmVyW10pIHtcclxuICAgIG9mZnNldHMuc2hpZnQoKTtcclxuICAgIGZvciAodmFyIGkgPSBvZmZzZXRzWzRdOyAoaSA8IGFyci5sZW5ndGgpICYmIChhcnJbaV0ubGVuZ3RoIDw9IHRhcmdldExlbik7ICsraSkge1xyXG4gICAgICAgIC8qIGVtcHR5Ki9cclxuICAgIH1cclxuICAgIC8vY29uc29sZS5sb2coXCJwdXNoaW5nIFwiICsgaSk7XHJcbiAgICBvZmZzZXRzLnB1c2goaSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhZGRSYW5nZVJ1bGVzVW5sZXNzUHJlc2VudChydWxlczogSU1hdGNoLm1SdWxlW10sIGxjd29yZDogc3RyaW5nLCByYW5nZVJ1bGVzOiBJTWF0Y2gubVJ1bGVbXSwgcHJlc2VudFJ1bGVzRm9yS2V5OiBJTWF0Y2gubVJ1bGVbXSwgc2VlblJ1bGVzKSB7XHJcbiAgICByYW5nZVJ1bGVzLmZvckVhY2gocmFuZ2VSdWxlID0+IHtcclxuICAgICAgICB2YXIgbmV3UnVsZSA9IE9iamVjdC5hc3NpZ24oe30sIHJhbmdlUnVsZSk7XHJcbiAgICAgICAgbmV3UnVsZS5sb3dlcmNhc2V3b3JkID0gbGN3b3JkO1xyXG4gICAgICAgIG5ld1J1bGUud29yZCA9IGxjd29yZDtcclxuICAgICAgICAvL2lmKChsY3dvcmQgPT09ICdzZXJ2aWNlcycgfHwgbGN3b3JkID09PSAnc2VydmljZScpICYmIG5ld1J1bGUucmFuZ2UucnVsZS5sb3dlcmNhc2V3b3JkLmluZGV4T2YoJ29kYXRhJyk+PTApIHtcclxuICAgICAgICAvLyAgICBjb25zb2xlLmxvZyhcImFkZGluZyBcIisgSlNPTi5zdHJpbmdpZnkobmV3UnVsZSkgKyBcIlxcblwiKTtcclxuICAgICAgICAvL31cclxuICAgICAgICAvL3RvZG86IGNoZWNrIHdoZXRoZXIgYW4gZXF1aXZhbGVudCBydWxlIGlzIGFscmVhZHkgcHJlc2VudD9cclxuICAgICAgICB2YXIgY250ID0gcnVsZXMubGVuZ3RoO1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQocnVsZXMsIG5ld1J1bGUsIHNlZW5SdWxlcyk7XHJcbiAgICB9KVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZENsb3NlRXhhY3RSYW5nZVJ1bGVzKHJ1bGVzOiBJTWF0Y2gubVJ1bGVbXSwgc2VlblJ1bGVzKSB7XHJcbiAgICB2YXIga2V5c01hcCA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSU1hdGNoLm1SdWxlW10gfTtcclxuICAgIHZhciByYW5nZUtleXNNYXAgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IElNYXRjaC5tUnVsZVtdIH07XHJcbiAgICBydWxlcy5mb3JFYWNoKHJ1bGUgPT4ge1xyXG4gICAgICAgIGlmIChydWxlLnR5cGUgPT09IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCkge1xyXG4gICAgICAgICAgICAvL2tleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXSA9IDE7XHJcbiAgICAgICAgICAgIGtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXSA9IGtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXSB8fCBbXTtcclxuICAgICAgICAgICAga2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdLnB1c2gocnVsZSk7XHJcbiAgICAgICAgICAgIGlmICghcnVsZS5leGFjdE9ubHkgJiYgcnVsZS5yYW5nZSkge1xyXG4gICAgICAgICAgICAgICAgcmFuZ2VLZXlzTWFwW3J1bGUubG93ZXJjYXNld29yZF0gPSByYW5nZUtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXSB8fCBbXTtcclxuICAgICAgICAgICAgICAgIHJhbmdlS2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdLnB1c2gocnVsZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoa2V5c01hcCk7XHJcbiAgICBrZXlzLnNvcnQoY21wTGVuZ3RoU29ydCk7XHJcbiAgICB2YXIgbGVuID0gMDtcclxuICAgIGtleXMuZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4ge1xyXG4gICAgICAgIGlmIChrZXkubGVuZ3RoICE9IGxlbikge1xyXG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwic2hpZnQgdG8gbGVuXCIgKyBrZXkubGVuZ3RoICsgJyBhdCAnICsgaW5kZXggKyAnICcgKyBrZXkgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGVuID0ga2V5Lmxlbmd0aDtcclxuICAgIH0pO1xyXG4gICAgLy8gICBrZXlzID0ga2V5cy5zbGljZSgwLDIwMDApO1xyXG4gICAgdmFyIHJhbmdlS2V5cyA9IE9iamVjdC5rZXlzKHJhbmdlS2V5c01hcCk7XHJcbiAgICByYW5nZUtleXMuc29ydChjbXBMZW5ndGhTb3J0KTtcclxuICAgIC8vY29uc29sZS5sb2coYCAke2tleXMubGVuZ3RofSBrZXlzIGFuZCAke3JhbmdlS2V5cy5sZW5ndGh9IHJhbmdla2V5cyBgKTtcclxuICAgIHZhciBsb3cgPSAwO1xyXG4gICAgdmFyIGhpZ2ggPSAwO1xyXG4gICAgdmFyIGxhc3RsZW4gPSAwO1xyXG4gICAgdmFyIG9mZnNldHMgPSBbMCwgMCwgMCwgMCwgMCwgMF07XHJcbiAgICB2YXIgbGVuID0gcmFuZ2VLZXlzLmxlbmd0aDtcclxuICAgIGZpbmROZXh0TGVuKDAsIGtleXMsIG9mZnNldHMpO1xyXG4gICAgZmluZE5leHRMZW4oMSwga2V5cywgb2Zmc2V0cyk7XHJcbiAgICBmaW5kTmV4dExlbigyLCBrZXlzLCBvZmZzZXRzKTtcclxuXHJcbiAgICByYW5nZUtleXMuZm9yRWFjaChmdW5jdGlvbiAocmFuZ2VLZXkpIHtcclxuICAgICAgICBpZiAocmFuZ2VLZXkubGVuZ3RoICE9PSBsYXN0bGVuKSB7XHJcbiAgICAgICAgICAgIGZvciAoaSA9IGxhc3RsZW4gKyAxOyBpIDw9IHJhbmdlS2V5Lmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICBmaW5kTmV4dExlbihpICsgMiwga2V5cywgb2Zmc2V0cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gICBjb25zb2xlLmxvZyhgIHNoaWZ0ZWQgdG8gJHtyYW5nZUtleS5sZW5ndGh9IHdpdGggb2Zmc2V0cyBiZWVpbmcgJHtvZmZzZXRzLmpvaW4oJyAnKX1gKTtcclxuICAgICAgICAgICAgLy8gICBjb25zb2xlLmxvZyhgIGhlcmUgMCAke29mZnNldHNbMF19IDogJHtrZXlzW01hdGgubWluKGtleXMubGVuZ3RoLTEsIG9mZnNldHNbMF0pXS5sZW5ndGh9ICAke2tleXNbTWF0aC5taW4oa2V5cy5sZW5ndGgtMSwgb2Zmc2V0c1swXSldfSBgKTtcclxuICAgICAgICAgICAgLy8gIGNvbnNvbGUubG9nKGAgaGVyZSA1LTEgICR7a2V5c1tvZmZzZXRzWzVdLTFdLmxlbmd0aH0gICR7a2V5c1tvZmZzZXRzWzVdLTFdfSBgKTtcclxuICAgICAgICAgICAgLy8gICBjb25zb2xlLmxvZyhgIGhlcmUgNSAke29mZnNldHNbNV19IDogJHtrZXlzW01hdGgubWluKGtleXMubGVuZ3RoLTEsIG9mZnNldHNbNV0pXS5sZW5ndGh9ICAke2tleXNbTWF0aC5taW4oa2V5cy5sZW5ndGgtMSwgb2Zmc2V0c1s1XSldfSBgKTtcclxuICAgICAgICAgICAgbGFzdGxlbiA9IHJhbmdlS2V5Lmxlbmd0aDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IG9mZnNldHNbMF07IGkgPCBvZmZzZXRzWzVdOyArK2kpIHtcclxuICAgICAgICAgICAgdmFyIGQgPSBEaXN0YW5jZS5jYWxjRGlzdGFuY2VBZGp1c3RlZChyYW5nZUtleSwga2V5c1tpXSk7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3JhbmdlS2V5Lmxlbmd0aC1rZXlzW2ldLmxlbmd0aH0gJHtkfSAke3JhbmdlS2V5fSBhbmQgJHtrZXlzW2ldfSAgYCk7XHJcbiAgICAgICAgICAgIGlmICgoZCAhPT0gMS4wKSAmJiAoZCA+PSBBbGdvbC5DdXRvZmZfcmFuZ2VDbG9zZU1hdGNoKSkge1xyXG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgd291bGQgYWRkICR7cmFuZ2VLZXl9IGZvciAke2tleXNbaV19ICR7ZH1gKTtcclxuICAgICAgICAgICAgICAgIHZhciBjbnQgPSBydWxlcy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAvLyB3ZSBvbmx5IGhhdmUgdG8gYWRkIGlmIHRoZXJlIGlzIG5vdCB5ZXQgYSBtYXRjaCBydWxlIGhlcmUgd2hpY2ggcG9pbnRzIHRvIHRoZSBzYW1lXHJcbiAgICAgICAgICAgICAgICBhZGRSYW5nZVJ1bGVzVW5sZXNzUHJlc2VudChydWxlcywga2V5c1tpXSwgcmFuZ2VLZXlzTWFwW3JhbmdlS2V5XSwga2V5c01hcFtrZXlzW2ldXSwgc2VlblJ1bGVzKTtcclxuICAgICAgICAgICAgICAgIGlmIChydWxlcy5sZW5ndGggPiBjbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGAgYWRkZWQgJHsocnVsZXMubGVuZ3RoIC0gY250KX0gcmVjb3JkcyBhdCR7cmFuZ2VLZXl9IGZvciAke2tleXNbaV19ICR7ZH1gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8qXHJcbiAgICBbXHJcbiAgICAgICAgWydhRUZHJywnYUVGR0gnXSxcclxuICAgICAgICBbJ2FFRkdIJywnYUVGR0hJJ10sXHJcbiAgICAgICAgWydPZGF0YScsJ09EYXRhcyddLFxyXG4gICBbJ09kYXRhJywnT2RhdGFzJ10sXHJcbiAgIFsnT2RhdGEnLCdPZGF0YiddLFxyXG4gICBbJ09kYXRhJywnVURhdGEnXSxcclxuICAgWydzZXJ2aWNlJywnc2VydmljZXMnXSxcclxuICAgWyd0aGlzIGlzZnVubnkgYW5kIG1vcmUnLCd0aGlzIGlzZnVubnkgYW5kIG1vcmVzJ10sXHJcbiAgICBdLmZvckVhY2gocmVjID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgZGlzdGFuY2UgJHtyZWNbMF19ICR7cmVjWzFdfSA6ICR7RGlzdGFuY2UuY2FsY0Rpc3RhbmNlKHJlY1swXSxyZWNbMV0pfSAgYWRmICR7RGlzdGFuY2UuY2FsY0Rpc3RhbmNlQWRqdXN0ZWQocmVjWzBdLHJlY1sxXSl9IGApO1xyXG5cclxuICAgIH0pO1xyXG4gICAgY29uc29sZS5sb2coXCJkaXN0YW5jZSBPZGF0YSBVZGF0YVwiKyBEaXN0YW5jZS5jYWxjRGlzdGFuY2UoJ09EYXRhJywnVURhdGEnKSk7XHJcbiAgICBjb25zb2xlLmxvZyhcImRpc3RhbmNlIE9kYXRhIE9kYXRiXCIrIERpc3RhbmNlLmNhbGNEaXN0YW5jZSgnT0RhdGEnLCdPRGF0YicpKTtcclxuICAgIGNvbnNvbGUubG9nKFwiZGlzdGFuY2UgT2RhdGFzIE9kYXRhXCIrIERpc3RhbmNlLmNhbGNEaXN0YW5jZSgnT0RhdGEnLCdPRGF0YWEnKSk7XHJcbiAgICBjb25zb2xlLmxvZyhcImRpc3RhbmNlIE9kYXRhcyBhYmNkZVwiKyBEaXN0YW5jZS5jYWxjRGlzdGFuY2UoJ2FiY2RlJywnYWJjZGVmJykpO1xyXG4gICAgY29uc29sZS5sb2coXCJkaXN0YW5jZSBzZXJ2aWNlcyBcIisgRGlzdGFuY2UuY2FsY0Rpc3RhbmNlKCdzZXJ2aWNlcycsJ3NlcnZpY2UnKSk7XHJcbiAgICAqL1xyXG59XHJcbnZhciBuID0gMDtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkTW9kZWxzKG1vZGVsUGF0aD86IHN0cmluZyk6IElNYXRjaC5JTW9kZWxzIHtcclxuICAgIHZhciBvTW9kZWw6IElNYXRjaC5JTW9kZWxzO1xyXG4gICAgb01vZGVsID0ge1xyXG4gICAgICAgIGZ1bGw6IHsgZG9tYWluOiB7fSB9LFxyXG4gICAgICAgIHJhd01vZGVsczoge30sXHJcbiAgICAgICAgZG9tYWluczogW10sXHJcbiAgICAgICAgdG9vbHM6IFtdLFxyXG4gICAgICAgIHJ1bGVzOiB1bmRlZmluZWQsXHJcbiAgICAgICAgY2F0ZWdvcnk6IFtdLFxyXG4gICAgICAgIG9wZXJhdG9yczoge30sXHJcbiAgICAgICAgbVJ1bGVzOiBbXSxcclxuICAgICAgICBzZWVuUnVsZXM6IHt9LFxyXG4gICAgICAgIHJlY29yZHM6IFtdLFxyXG4gICAgICAgIG1ldGE6IHsgdDM6IHt9IH1cclxuICAgIH1cclxuICAgIHZhciB0ID0gRGF0ZS5ub3coKTtcclxuICAgIG1vZGVsUGF0aCA9IG1vZGVsUGF0aCB8fCBlbnZNb2RlbFBhdGg7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICB2YXIgYSA9IENpcmN1bGFyU2VyLmxvYWQoJy4vJyArIG1vZGVsUGF0aCArICcvX2NhY2hlZmFsc2UuanMnKTtcclxuICAgICAgICAvL2NvbnNvbGUubG9nKFwiZm91bmQgYSBjYWNoZSA/ICBcIiArICEhYSk7XHJcbiAgICAgICAgLy9hID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChhKSB7XHJcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIHJldHVybiBwcmVwYXJlc2UgbW9kZWwgXCIpO1xyXG4gICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQUJPVF9FTUFJTF9VU0VSKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImxvYWRlZCBtb2RlbHMgZnJvbSBjYWNoZSBpbiBcIiArIChEYXRlLm5vdygpIC0gdCkgKyBcIiBcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGE7XHJcbiAgICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coJ2Vycm9yJyArIGUpO1xyXG4gICAgICAgIC8vIG5vIGNhY2hlIGZpbGUsXHJcbiAgICB9XHJcbiAgICB2YXIgbWRscyA9IHJlYWRGaWxlQXNKU09OKCcuLycgKyBtb2RlbFBhdGggKyAnL21vZGVscy5qc29uJyk7XHJcbiAgICBtZGxzLmZvckVhY2goZnVuY3Rpb24gKHNNb2RlbE5hbWUpIHtcclxuICAgICAgICBsb2FkTW9kZWwobW9kZWxQYXRoLCBzTW9kZWxOYW1lLCBvTW9kZWwpXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGNhdGVnb3JpZXMgdG8gdGhlIG1vZGVsOlxyXG4gICAgLypcclxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xyXG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxyXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgdHlwZTogSU1hdGNoLkVudW1SdWxlVHlwZS5XT1JELFxyXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcclxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgYml0aW5kZXggOiBvTWRsLlxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45NVxyXG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xyXG4gICAgfSk7XHJcbiAgICAqL1xyXG5cclxuICAgIHZhciBtZXRhQml0SW5kZXggPSBnZXREb21haW5CaXRJbmRleCgnbWV0YScsIG9Nb2RlbCk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBkb21haW4gbWV0YSBydWxlXHJcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcclxuICAgICAgICBjYXRlZ29yeTogXCJtZXRhXCIsXHJcbiAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJkb21haW5cIixcclxuICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgd29yZDogXCJkb21haW5cIixcclxuICAgICAgICBiaXRpbmRleDogbWV0YUJpdEluZGV4LFxyXG4gICAgICAgIF9yYW5raW5nOiAwLjk1XHJcbiAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcclxuXHJcblxyXG4gICAgdmFyIGZpbGxlckJpdEluZGV4ID0gZ2V0RG9tYWluQml0SW5kZXgoJ21ldGEnLCBvTW9kZWwpO1xyXG4gICAgLy9hZGQgYSBmaWxsZXIgcnVsZVxyXG4gICAgdmFyIGZpbGxlcnMgPSAgcmVhZEZpbGVBc0pTT04oJy4vJyArIG1vZGVsUGF0aCArICcvZmlsbGVyLmpzb24nKTtcclxuICAgIHZhciByZSA9IFwiXigoXCIgKyBmaWxsZXJzLmpvaW4oXCIpfChcIikgKyBcIikpJFwiO1xyXG4gICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcclxuICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcclxuICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLlJFR0VYUCxcclxuICAgICAgICByZWdleHA6IG5ldyBSZWdFeHAocmUsIFwiaVwiKSxcclxuICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxyXG4gICAgICAgIGJpdGluZGV4OiBmaWxsZXJCaXRJbmRleCxcclxuICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICB9KTtcclxuXHJcbiAgICAvL2FkZCBvcGVyYXRvcnNcclxuICAgIHZhciBvcGVyYXRvcnMgPSByZWFkRmlsZUFzSlNPTignLi9yZXNvdXJjZXMvbW9kZWwvb3BlcmF0b3JzLmpzb24nKTtcclxuICAgIHZhciBvcGVyYXRvckJpdEluZGV4ID0gZ2V0RG9tYWluQml0SW5kZXgoJ29wZXJhdG9ycycsIG9Nb2RlbCk7XHJcbiAgICBPYmplY3Qua2V5cyhvcGVyYXRvcnMub3BlcmF0b3JzKS5mb3JFYWNoKGZ1bmN0aW9uIChvcGVyYXRvcikge1xyXG4gICAgICAgIGlmIChJTWF0Y2guYU9wZXJhdG9yTmFtZXMuaW5kZXhPZihvcGVyYXRvcikgPCAwKSB7XHJcbiAgICAgICAgICAgIGRlYnVnbG9nKFwidW5rbm93biBvcGVyYXRvciBcIiArIG9wZXJhdG9yKTtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidW5rbm93biBvcGVyYXRvciBcIiArIG9wZXJhdG9yKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0gPSBvcGVyYXRvcnMub3BlcmF0b3JzW29wZXJhdG9yXTtcclxuICAgICAgICBvTW9kZWwub3BlcmF0b3JzW29wZXJhdG9yXS5vcGVyYXRvciA9IDxJTWF0Y2guT3BlcmF0b3JOYW1lPm9wZXJhdG9yO1xyXG4gICAgICAgIE9iamVjdC5mcmVlemUob01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0pO1xyXG4gICAgICAgIHZhciB3b3JkID0gb3BlcmF0b3I7XHJcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcIm9wZXJhdG9yXCIsXHJcbiAgICAgICAgICAgIHdvcmQ6IHdvcmQudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogd29yZC50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHdvcmQsXHJcbiAgICAgICAgICAgIGJpdGluZGV4OiBvcGVyYXRvckJpdEluZGV4LFxyXG4gICAgICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgLy8gYWRkIGFsbCBzeW5vbnltc1xyXG4gICAgICAgIGlmIChvcGVyYXRvcnMuc3lub255bXNbb3BlcmF0b3JdKSB7XHJcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKG9wZXJhdG9ycy5zeW5vbnltc1tvcGVyYXRvcl0pLmZvckVhY2goZnVuY3Rpb24gKHN5bm9ueW0pIHtcclxuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBcIm9wZXJhdG9yXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgd29yZDogc3lub255bS50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IHN5bm9ueW0udG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBJTWF0Y2guRW51bVJ1bGVUeXBlLldPUkQsXHJcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogb3BlcmF0b3IsXHJcbiAgICAgICAgICAgICAgICAgICAgYml0aW5kZXg6IG9wZXJhdG9yQml0SW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOVxyXG4gICAgICAgICAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLypcclxuICAgICAgICB9KVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICBjYXRlZ29yeTogXCJmaWxsZXJcIixcclxuICAgICAgICAgIHR5cGU6IDEsXHJcbiAgICAgICAgICByZWdleHA6IC9eKChzdGFydCl8KHNob3cpfChmcm9tKXwoaW4pKSQvaSxcclxuICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IFwiZmlsbGVyXCIsXHJcbiAgICAgICAgICBfcmFua2luZzogMC45XHJcbiAgICAgICAgfSxcclxuICAgICovXHJcbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xyXG4gICAgYWRkQ2xvc2VFeGFjdFJhbmdlUnVsZXMob01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XHJcbiAgICBvTW9kZWwubVJ1bGVzID0gb01vZGVsLm1SdWxlcy5zb3J0KElucHV0RmlsdGVyUnVsZXMuY21wTVJ1bGUpO1xyXG4gICAgZm9yY2VHQygpO1xyXG4gICAgb01vZGVsLnJ1bGVzID0gc3BsaXRSdWxlcyhvTW9kZWwubVJ1bGVzKTtcclxuICAgIGZvcmNlR0MoKTtcclxuICAgIG9Nb2RlbC50b29scyA9IG9Nb2RlbC50b29scy5zb3J0KFRvb2xzLmNtcFRvb2xzKTtcclxuICAgIGRlbGV0ZSBvTW9kZWwuc2VlblJ1bGVzO1xyXG4gICAgZGVidWdsb2coJ3NhdmluZycpO1xyXG4gICAgZm9yY2VHQygpO1xyXG4gICAgQ2lyY3VsYXJTZXIuc2F2ZSgnLi8nICsgbW9kZWxQYXRoICsgJy9fY2FjaGVmYWxzZS5qcycsIG9Nb2RlbCk7XHJcbiAgICBmb3JjZUdDKCk7XHJcbiAgICBpZiAocHJvY2Vzcy5lbnYuQUJPVF9FTUFJTF9VU0VSKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJsb2FkZWQgbW9kZWxzIGJ5IGNhbGN1bGF0aW9uIGluIFwiICsgKERhdGUubm93KCkgLSB0KSArIFwiIFwiKTtcclxuICAgIH1cclxuICAgIHJldHVybiBvTW9kZWw7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzb3J0Q2F0ZWdvcmllc0J5SW1wb3J0YW5jZShtYXA6IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLklDYXRlZ29yeURlc2MgfSwgY2F0czogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICB2YXIgcmVzID0gY2F0cy5zbGljZSgwKTtcclxuICAgIHJlcy5zb3J0KHJhbmtDYXRlZ29yeUJ5SW1wb3J0YW5jZS5iaW5kKHVuZGVmaW5lZCwgbWFwKSk7XHJcbiAgICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmFua0NhdGVnb3J5QnlJbXBvcnRhbmNlKG1hcDogeyBba2V5OiBzdHJpbmddOiBJTWF0Y2guSUNhdGVnb3J5RGVzYyB9LCBjYXRhOiBzdHJpbmcsIGNhdGI6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICB2YXIgY2F0QURlc2MgPSBtYXBbY2F0YV07XHJcbiAgICB2YXIgY2F0QkRlc2MgPSBtYXBbY2F0Yl07XHJcbiAgICBpZiAoY2F0YSA9PT0gY2F0Yikge1xyXG4gICAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG4gICAgLy8gaWYgYSBpcyBiZWZvcmUgYiwgcmV0dXJuIC0xXHJcbiAgICBpZiAoY2F0QURlc2MgJiYgIWNhdEJEZXNjKSB7XHJcbiAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgfVxyXG4gICAgaWYgKCFjYXRBRGVzYyAmJiBjYXRCRGVzYykge1xyXG4gICAgICAgIHJldHVybiArMTtcclxuICAgIH1cclxuXHJcbiAgICB2YXIgcHJpb0EgPSAoY2F0QURlc2MgJiYgY2F0QURlc2MuaW1wb3J0YW5jZSkgfHwgOTk7XHJcbiAgICB2YXIgcHJpb0IgPSAoY2F0QkRlc2MgJiYgY2F0QkRlc2MuaW1wb3J0YW5jZSkgfHwgOTk7XHJcbiAgICAvLyBsb3dlciBwcmlvIGdvZXMgdG8gZnJvbnRcclxuICAgIHZhciByID0gcHJpb0EgLSBwcmlvQjtcclxuICAgIGlmIChyKSB7XHJcbiAgICAgICAgcmV0dXJuIHI7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY2F0YS5sb2NhbGVDb21wYXJlKGNhdGIpO1xyXG59XHJcblxyXG5jb25zdCBNZXRhRiA9IE1ldGEuZ2V0TWV0YUZhY3RvcnkoKTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRPcGVyYXRvcihtZGw6IElNYXRjaC5JTW9kZWxzLCBvcGVyYXRvcjogc3RyaW5nKTogSU1hdGNoLklPcGVyYXRvciB7XHJcbiAgICByZXR1cm4gbWRsLm9wZXJhdG9yc1tvcGVyYXRvcl07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRSZXN1bHRBc0FycmF5KG1kbDogSU1hdGNoLklNb2RlbHMsIGE6IE1ldGEuSU1ldGEsIHJlbDogTWV0YS5JTWV0YSk6IE1ldGEuSU1ldGFbXSB7XHJcbiAgICBpZiAocmVsLnRvVHlwZSgpICE9PSAncmVsYXRpb24nKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZXhwZWN0IHJlbGF0aW9uIGFzIDJuZCBhcmdcIik7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHJlcyA9IG1kbC5tZXRhLnQzW2EudG9GdWxsU3RyaW5nKCldICYmXHJcbiAgICAgICAgbWRsLm1ldGEudDNbYS50b0Z1bGxTdHJpbmcoKV1bcmVsLnRvRnVsbFN0cmluZygpXTtcclxuICAgIGlmICghcmVzKSB7XHJcbiAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHJlcykuc29ydCgpLm1hcChNZXRhRi5wYXJzZUlNZXRhKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldENhdGVnb3JpZXNGb3JEb21haW4odGhlTW9kZWw6IElNYXRjaC5JTW9kZWxzLCBkb21haW46IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIGlmICh0aGVNb2RlbC5kb21haW5zLmluZGV4T2YoZG9tYWluKSA8IDApIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEb21haW4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlcyA9IGdldFJlc3VsdEFzQXJyYXkodGhlTW9kZWwsIE1ldGFGLkRvbWFpbihkb21haW4pLCBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2hhc0NhdGVnb3J5KSk7XHJcbiAgICByZXR1cm4gTWV0YS5nZXRTdHJpbmdBcnJheShyZXMpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGFibGVDb2x1bW5zKHRoZU1vZGVsOiBJTWF0Y2guSU1vZGVscywgZG9tYWluOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBpZiAodGhlTW9kZWwuZG9tYWlucy5pbmRleE9mKGRvbWFpbikgPCAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRG9tYWluIFxcXCJcIiArIGRvbWFpbiArIFwiXFxcIiBub3QgcGFydCBvZiBtb2RlbFwiKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGVNb2RlbC5yYXdNb2RlbHNbZG9tYWluXS5jb2x1bW5zLnNsaWNlKDApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmb3JjZUdDKCkge1xyXG4gICAgaWYoZ2xvYmFsICYmIGdsb2JhbC5nYykge1xyXG4gICAgICAgIGdsb2JhbC5nYygpO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICogUmV0dXJuIGFsbCBjYXRlZ29yaWVzIG9mIGEgZG9tYWluIHdoaWNoIGNhbiBhcHBlYXIgb24gYSB3b3JkLFxyXG4gKiB0aGVzZSBhcmUgdHlwaWNhbGx5IHRoZSB3b3JkaW5kZXggZG9tYWlucyArIGVudHJpZXMgZ2VuZXJhdGVkIGJ5IGdlbmVyaWMgcnVsZXNcclxuICpcclxuICogVGhlIGN1cnJlbnQgaW1wbGVtZW50YXRpb24gaXMgYSBzaW1wbGlmaWNhdGlvblxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFBvdGVudGlhbFdvcmRDYXRlZ29yaWVzRm9yRG9tYWluKHRoZU1vZGVsOiBJTWF0Y2guSU1vZGVscywgZG9tYWluOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICAvLyB0aGlzIGlzIGEgc2ltcGxpZmllZCB2ZXJzaW9uXHJcbiAgICByZXR1cm4gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbih0aGVNb2RlbCwgZG9tYWluKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbDogSU1hdGNoLklNb2RlbHMsIGNhdGVnb3J5OiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBpZiAodGhlTW9kZWwuY2F0ZWdvcnkuaW5kZXhPZihjYXRlZ29yeSkgPCAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2F0ZWdvcnkgXFxcIlwiICsgY2F0ZWdvcnkgKyBcIlxcXCIgbm90IHBhcnQgb2YgbW9kZWxcIik7XHJcbiAgICB9XHJcbiAgICB2YXIgcmVzID0gZ2V0UmVzdWx0QXNBcnJheSh0aGVNb2RlbCwgTWV0YUYuQ2F0ZWdvcnkoY2F0ZWdvcnkpLCBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikpO1xyXG4gICAgcmV0dXJuIE1ldGEuZ2V0U3RyaW5nQXJyYXkocmVzKTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcnkobW9kZWw6IElNYXRjaC5JTW9kZWxzLCBjYXRlZ29yeTogc3RyaW5nLCB3b3Jkc29ubHk6IGJvb2xlYW4pOiB7IFtrZXk6IHN0cmluZ106IGJvb2xlYW4gfSB7XHJcbiAgICB2YXIgcmVzID0ge307XHJcbiAgICAvL1xyXG4gICAgdmFyIGZuID0gd29yZHNvbmx5ID8gZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4gOiBnZXRDYXRlZ29yaWVzRm9yRG9tYWluO1xyXG4gICAgdmFyIGRvbWFpbnMgPSBnZXREb21haW5zRm9yQ2F0ZWdvcnkobW9kZWwsIGNhdGVnb3J5KTtcclxuICAgIGRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoZG9tYWluKSB7XHJcbiAgICAgICAgZm4obW9kZWwsIGRvbWFpbikuZm9yRWFjaChmdW5jdGlvbiAod29yZGNhdCkge1xyXG4gICAgICAgICAgICByZXNbd29yZGNhdF0gPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBPYmplY3QuZnJlZXplKHJlcyk7XHJcbiAgICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0QWxsUmVjb3JkQ2F0ZWdvcmllc0ZvclRhcmdldENhdGVnb3JpZXMobW9kZWw6IElNYXRjaC5JTW9kZWxzLCBjYXRlZ29yaWVzOiBzdHJpbmdbXSwgd29yZHNvbmx5OiBib29sZWFuKTogeyBba2V5OiBzdHJpbmddOiBib29sZWFuIH0ge1xyXG4gICAgdmFyIHJlcyA9IHt9O1xyXG4gICAgLy9cclxuICAgIHZhciBmbiA9IHdvcmRzb25seSA/IGdldFBvdGVudGlhbFdvcmRDYXRlZ29yaWVzRm9yRG9tYWluIDogZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbjtcclxuICAgIHZhciBkb21haW5zID0gdW5kZWZpbmVkO1xyXG4gICAgY2F0ZWdvcmllcy5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xyXG4gICAgICAgIHZhciBjYXRkb21haW5zID0gZ2V0RG9tYWluc0ZvckNhdGVnb3J5KG1vZGVsLCBjYXRlZ29yeSlcclxuICAgICAgICBpZiAoIWRvbWFpbnMpIHtcclxuICAgICAgICAgICAgZG9tYWlucyA9IGNhdGRvbWFpbnM7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZG9tYWlucyA9IF8uaW50ZXJzZWN0aW9uKGRvbWFpbnMsIGNhdGRvbWFpbnMpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYXRlZ29yaWVzICcgKyBVdGlscy5saXN0VG9RdW90ZWRDb21tYUFuZChjYXRlZ29yaWVzKSArICcgaGF2ZSBubyBjb21tb24gZG9tYWluLicpXHJcbiAgICB9XHJcbiAgICBkb21haW5zLmZvckVhY2goZnVuY3Rpb24gKGRvbWFpbikge1xyXG4gICAgICAgIGZuKG1vZGVsLCBkb21haW4pLmZvckVhY2goZnVuY3Rpb24gKHdvcmRjYXQpIHtcclxuICAgICAgICAgICAgcmVzW3dvcmRjYXRdID0gdHJ1ZTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgT2JqZWN0LmZyZWV6ZShyZXMpO1xyXG4gICAgcmV0dXJuIHJlcztcclxufVxyXG5cclxuXHJcbiIsIi8qKlxuICogRnVuY3Rpb25hbGl0eSBtYW5hZ2luZyB0aGUgbWF0Y2ggbW9kZWxzXG4gKlxuICogQGZpbGVcbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIik7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9kZWwnKTtcbnZhciBsb2dnZXIgPSByZXF1aXJlKFwiLi4vdXRpbHMvbG9nZ2VyXCIpO1xudmFyIGxvYWRsb2cgPSBsb2dnZXIubG9nZ2VyKCdtb2RlbGxvYWQnLCAnJyk7XG52YXIgSU1hdGNoID0gcmVxdWlyZShcIi4uL21hdGNoL2lmbWF0Y2hcIik7XG52YXIgSW5wdXRGaWx0ZXJSdWxlcyA9IHJlcXVpcmUoXCIuLi9tYXRjaC9pbnB1dEZpbHRlclJ1bGVzXCIpO1xudmFyIFRvb2xzID0gcmVxdWlyZShcIi4uL21hdGNoL3Rvb2xzXCIpO1xudmFyIGZzID0gcmVxdWlyZShcImZzXCIpO1xudmFyIE1ldGEgPSByZXF1aXJlKFwiLi9tZXRhXCIpO1xudmFyIFV0aWxzID0gcmVxdWlyZShcIi4uL3V0aWxzL3V0aWxzXCIpO1xudmFyIENpcmN1bGFyU2VyID0gcmVxdWlyZShcIi4uL3V0aWxzL2NpcmN1bGFyc2VyXCIpO1xudmFyIHByb2Nlc3MgPSByZXF1aXJlKFwicHJvY2Vzc1wiKTtcbnZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbi8qKlxuICogdGhlIG1vZGVsIHBhdGgsIG1heSBiZSBjb250cm9sbGVkIHZpYSBlbnZpcm9ubWVudCB2YXJpYWJsZVxuICovXG52YXIgZW52TW9kZWxQYXRoID0gcHJvY2Vzcy5lbnZbXCJBQk9UX01PREVMUEFUSFwiXSB8fCBcInRlc3Rtb2RlbFwiO1xudmFyIEFSUl9NT0RFTF9QUk9QRVJUSUVTID0gW1wiZG9tYWluXCIsIFwiYml0aW5kZXhcIiwgXCJkZWZhdWx0a2V5Y29sdW1uXCIsIFwiZGVmYXVsdHVyaVwiLCBcImNhdGVnb3J5RGVzY3JpYmVkXCIsIFwiY29sdW1uc1wiLCBcImRlc2NyaXB0aW9uXCIsIFwidG9vbFwiLCBcInRvb2xoaWRkZW5cIiwgXCJzeW5vbnltc1wiLCBcImNhdGVnb3J5XCIsIFwid29yZGluZGV4XCIsIFwiZXhhY3RtYXRjaFwiLCBcImhpZGRlblwiXTtcbmZ1bmN0aW9uIGFkZFN5bm9ueW1zKHN5bm9ueW1zLCBjYXRlZ29yeSwgc3lub255bUZvciwgYml0aW5kZXgsIG1SdWxlcywgc2Vlbikge1xuICAgIHN5bm9ueW1zLmZvckVhY2goZnVuY3Rpb24gKHN5bikge1xuICAgICAgICB2YXIgb1J1bGUgPSB7XG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBzeW5vbnltRm9yLFxuICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgd29yZDogc3luLFxuICAgICAgICAgICAgYml0aW5kZXg6IGJpdGluZGV4LFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfTtcbiAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcImluc2VydGluZyBzeW5vbnltXCIgKyBKU09OLnN0cmluZ2lmeShvUnVsZSkpIDogJy0nKTtcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIG9SdWxlLCBzZWVuKTtcbiAgICB9KTtcbn1cbmZ1bmN0aW9uIGdldFJ1bGVLZXkocnVsZSkge1xuICAgIHZhciByMSA9IHJ1bGUubWF0Y2hlZFN0cmluZyArIFwiLXwtXCIgKyBydWxlLmNhdGVnb3J5ICsgXCIgLXwtIFwiICsgcnVsZS50eXBlICsgXCIgLXwtIFwiICsgcnVsZS53b3JkICsgXCIgXCI7XG4gICAgaWYgKHJ1bGUucmFuZ2UpIHtcbiAgICAgICAgdmFyIHIyID0gZ2V0UnVsZUtleShydWxlLnJhbmdlLnJ1bGUpO1xuICAgICAgICByMSArPSBcIiAtfC0gXCIgKyBydWxlLnJhbmdlLmxvdyArIFwiL1wiICsgcnVsZS5yYW5nZS5oaWdoICsgXCIgLXwtIFwiICsgcjI7XG4gICAgfVxuICAgIHJldHVybiByMTtcbn1cbnZhciBCcmVha2Rvd24gPSByZXF1aXJlKFwiLi4vbWF0Y2gvYnJlYWtkb3duXCIpO1xuLyogZ2l2ZW4gYSBydWxlIHdoaWNoIHJlcHJlc2VudHMgYSB3b3JkIHNlcXVlbmNlIHdoaWNoIGlzIHNwbGl0IGR1cmluZyB0b2tlbml6YXRpb24gKi9cbmZ1bmN0aW9uIGFkZEJlc3RTcGxpdChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcykge1xuICAgIC8vaWYoIWdsb2JhbF9BZGRTcGxpdHMpIHtcbiAgICAvLyAgICByZXR1cm47XG4gICAgLy99XG4gICAgaWYgKHJ1bGUudHlwZSAhPT0gMCAvKiBXT1JEICovKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIGJlc3QgPSBCcmVha2Rvd24ubWFrZU1hdGNoUGF0dGVybihydWxlLmxvd2VyY2FzZXdvcmQpO1xuICAgIGlmICghYmVzdCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBuZXdSdWxlID0ge1xuICAgICAgICBjYXRlZ29yeTogcnVsZS5jYXRlZ29yeSxcbiAgICAgICAgbWF0Y2hlZFN0cmluZzogcnVsZS5tYXRjaGVkU3RyaW5nLFxuICAgICAgICBiaXRpbmRleDogcnVsZS5iaXRpbmRleCxcbiAgICAgICAgd29yZDogYmVzdC5sb25nZXN0VG9rZW4sXG4gICAgICAgIHR5cGU6IDAsXG4gICAgICAgIGxvd2VyY2FzZXdvcmQ6IGJlc3QubG9uZ2VzdFRva2VuLFxuICAgICAgICBfcmFua2luZzogMC45NSxcbiAgICAgICAgLy8gICAgZXhhY3RPbmx5IDogcnVsZS5leGFjdE9ubHksXG4gICAgICAgIHJhbmdlOiBiZXN0LnNwYW5cbiAgICB9O1xuICAgIGlmIChydWxlLmV4YWN0T25seSkge1xuICAgICAgICBuZXdSdWxlLmV4YWN0T25seSA9IHJ1bGUuZXhhY3RPbmx5O1xuICAgIH1cbiAgICA7XG4gICAgbmV3UnVsZS5yYW5nZS5ydWxlID0gcnVsZTtcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG1SdWxlcywgbmV3UnVsZSwgc2VlblJ1bGVzKTtcbn1cbmV4cG9ydHMuYWRkQmVzdFNwbGl0ID0gYWRkQmVzdFNwbGl0O1xuZnVuY3Rpb24gaW5zZXJ0UnVsZUlmTm90UHJlc2VudChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcykge1xuICAgIGlmIChydWxlLnR5cGUgIT09IDAgLyogV09SRCAqLykge1xuICAgICAgICBtUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoKHJ1bGUud29yZCA9PT0gdW5kZWZpbmVkKSB8fCAocnVsZS5tYXRjaGVkU3RyaW5nID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaWxsZWdhbCBydWxlJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICB2YXIgciA9IGdldFJ1bGVLZXkocnVsZSk7XG4gICAgLyogaWYoIChydWxlLndvcmQgPT09IFwic2VydmljZVwiIHx8IHJ1bGUud29yZD09PSBcInNlcnZpY2VzXCIpICYmIHIuaW5kZXhPZignT0RhdGEnKSA+PSAwKSB7XG4gICAgICAgICBjb25zb2xlLmxvZyhcInJ1bGVrZXkgaXNcIiArIHIpO1xuICAgICAgICAgY29uc29sZS5sb2coXCJwcmVzZW5jZSBpcyBcIiArIEpTT04uc3RyaW5naWZ5KHNlZW5SdWxlc1tyXSkpO1xuICAgICB9Ki9cbiAgICBydWxlLmxvd2VyY2FzZXdvcmQgPSBydWxlLndvcmQudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAoc2VlblJ1bGVzW3JdKSB7XG4gICAgICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJBdHRlbXB0aW5nIHRvIGluc2VydCBkdXBsaWNhdGVcIiArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpIDogXCItXCIpO1xuICAgICAgICB2YXIgZHVwbGljYXRlcyA9IHNlZW5SdWxlc1tyXS5maWx0ZXIoZnVuY3Rpb24gKG9FbnRyeSkge1xuICAgICAgICAgICAgcmV0dXJuIDAgPT09IElucHV0RmlsdGVyUnVsZXMuY29tcGFyZU1SdWxlRnVsbChvRW50cnksIHJ1bGUpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGR1cGxpY2F0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuICAgIHNlZW5SdWxlc1tyXSA9IChzZWVuUnVsZXNbcl0gfHwgW10pO1xuICAgIHNlZW5SdWxlc1tyXS5wdXNoKHJ1bGUpO1xuICAgIGlmIChydWxlLndvcmQgPT09IFwiXCIpIHtcbiAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/ICgnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpIDogJy0nKTtcbiAgICAgICAgbG9hZGxvZygnU2tpcHBpbmcgcnVsZSB3aXRoIGVtdHB5IHdvcmQgJyArIEpTT04uc3RyaW5naWZ5KHJ1bGUsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIG1SdWxlcy5wdXNoKHJ1bGUpO1xuICAgIGFkZEJlc3RTcGxpdChtUnVsZXMsIHJ1bGUsIHNlZW5SdWxlcyk7XG4gICAgcmV0dXJuO1xufVxuZnVuY3Rpb24gcmVhZEZpbGVBc0pTT04oZmlsZW5hbWUpIHtcbiAgICB2YXIgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlbmFtZSwgJ3V0Zi04Jyk7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSk7XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ29udGVudCBvZiBmaWxlIFwiICsgZmlsZW5hbWUgKyBcIiBpcyBubyBqc29uXCIgKyBlKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cbmZ1bmN0aW9uIGxvYWRNb2RlbERhdGEobW9kZWxQYXRoLCBvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpIHtcbiAgICAvLyByZWFkIHRoZSBkYXRhIC0+XG4gICAgLy8gZGF0YSBpcyBwcm9jZXNzZWQgaW50byBtUnVsZXMgZGlyZWN0bHksXG4gICAgdmFyIGJpdGluZGV4ID0gb01kbC5iaXRpbmRleDtcbiAgICB2YXIgc0ZpbGVOYW1lID0gKCcuLycgKyBtb2RlbFBhdGggKyAnLycgKyBzTW9kZWxOYW1lICsgXCIuZGF0YS5qc29uXCIpO1xuICAgIHZhciBvTWRsRGF0YSA9IHJlYWRGaWxlQXNKU09OKHNGaWxlTmFtZSk7XG4gICAgb01kbERhdGEuZm9yRWFjaChmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgIGlmICghb0VudHJ5LmRvbWFpbikge1xuICAgICAgICAgICAgb0VudHJ5Ll9kb21haW4gPSBvTWRsLmRvbWFpbjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIW9FbnRyeS50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgICAgICBvRW50cnkudG9vbCA9IG9NZGwudG9vbC5uYW1lO1xuICAgICAgICB9XG4gICAgICAgIG9Nb2RlbC5yZWNvcmRzLnB1c2gob0VudHJ5KTtcbiAgICAgICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXQpIHtcbiAgICAgICAgICAgIGlmIChvRW50cnlbY2F0XSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBvRW50cnlbY2F0XSA9IFwibi9hXCI7XG4gICAgICAgICAgICAgICAgdmFyIGJ1ZyA9IFwiSU5DT05TSVNURU5UKj4gTW9kZWxEYXRhIFwiICsgc0ZpbGVOYW1lICsgXCIgZG9lcyBub3QgY29udGFpbiBjYXRlZ29yeSBcIiArIGNhdCArIFwiIHdpdGggdmFsdWUgJ3VuZGVmaW5lZCcsIHVuZGVmaW5lZCBpcyBpbGxlZ2FsIHZhbHVlLCB1c2Ugbi9hIFwiICsgSlNPTi5zdHJpbmdpZnkob0VudHJ5KSArIFwiXCI7XG4gICAgICAgICAgICAgICAgZGVidWdsb2coYnVnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIG9NZGwud29yZGluZGV4LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG4gICAgICAgICAgICBpZiAob0VudHJ5W2NhdGVnb3J5XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJJTkNPTlNJU1RFTlQqPiBNb2RlbERhdGEgXCIgKyBzRmlsZU5hbWUgKyBcIiBkb2VzIG5vdCBjb250YWluIGNhdGVnb3J5IFwiICsgY2F0ZWdvcnkgKyBcIiBvZiB3b3JkaW5kZXhcIiArIEpTT04uc3RyaW5naWZ5KG9FbnRyeSkgKyBcIlwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob0VudHJ5W2NhdGVnb3J5XSAhPT0gXCIqXCIpIHtcbiAgICAgICAgICAgICAgICB2YXIgc1N0cmluZyA9IG9FbnRyeVtjYXRlZ29yeV07XG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJwdXNoaW5nIHJ1bGUgd2l0aCBcIiArIGNhdGVnb3J5ICsgXCIgLT4gXCIgKyBzU3RyaW5nKTtcbiAgICAgICAgICAgICAgICB2YXIgb1J1bGUgPSB7XG4gICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSxcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogc1N0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogMCAvKiBXT1JEICovLFxuICAgICAgICAgICAgICAgICAgICB3b3JkOiBzU3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICBiaXRpbmRleDogYml0aW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAob01kbC5leGFjdG1hdGNoICYmIG9NZGwuZXhhY3RtYXRjaC5pbmRleE9mKGNhdGVnb3J5KSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9SdWxlLmV4YWN0T25seSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywgb1J1bGUsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgICAgIGlmIChvTWRsRGF0YS5zeW5vbnltcyAmJiBvTWRsRGF0YS5zeW5vbnltc1tjYXRlZ29yeV0pIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbERhdGEuc3lub255bXNbY2F0ZWdvcnldLCBjYXRlZ29yeSwgc1N0cmluZywgYml0aW5kZXgsIG9Nb2RlbC5tUnVsZXMsIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAob0VudHJ5LnN5bm9ueW1zICYmIG9FbnRyeS5zeW5vbnltc1tjYXRlZ29yeV0pIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkU3lub255bXMob0VudHJ5LnN5bm9ueW1zW2NhdGVnb3J5XSwgY2F0ZWdvcnksIHNTdHJpbmcsIGJpdGluZGV4LCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuZnVuY3Rpb24gbG9hZE1vZGVsKG1vZGVsUGF0aCwgc01vZGVsTmFtZSwgb01vZGVsKSB7XG4gICAgZGVidWdsb2coXCIgbG9hZGluZyBcIiArIHNNb2RlbE5hbWUgKyBcIiAuLi4uXCIpO1xuICAgIHZhciBvTWRsID0gcmVhZEZpbGVBc0pTT04oJy4vJyArIG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5tb2RlbC5qc29uXCIpO1xuICAgIG1lcmdlTW9kZWxKc29uKHNNb2RlbE5hbWUsIG9NZGwsIG9Nb2RlbCk7XG4gICAgbG9hZE1vZGVsRGF0YShtb2RlbFBhdGgsIG9NZGwsIHNNb2RlbE5hbWUsIG9Nb2RlbCk7XG59XG5mdW5jdGlvbiBnZXREb21haW5CaXRJbmRleChkb21haW4sIG9Nb2RlbCkge1xuICAgIHZhciBpbmRleCA9IG9Nb2RlbC5kb21haW5zLmluZGV4T2YoZG9tYWluKTtcbiAgICBpZiAoaW5kZXggPCAwKSB7XG4gICAgICAgIGluZGV4ID0gb01vZGVsLmRvbWFpbnMubGVuZ3RoO1xuICAgIH1cbiAgICBpZiAoaW5kZXggPj0gMzIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidG9vIG1hbnkgZG9tYWluIGZvciBzaW5nbGUgMzIgYml0IGluZGV4XCIpO1xuICAgIH1cbiAgICByZXR1cm4gMHgwMDAxIDw8IGluZGV4O1xufVxuZXhwb3J0cy5nZXREb21haW5CaXRJbmRleCA9IGdldERvbWFpbkJpdEluZGV4O1xuZnVuY3Rpb24gbWVyZ2VNb2RlbEpzb24oc01vZGVsTmFtZSwgb01kbCwgb01vZGVsKSB7XG4gICAgdmFyIGNhdGVnb3J5RGVzY3JpYmVkTWFwID0ge307XG4gICAgb01kbC5iaXRpbmRleCA9IGdldERvbWFpbkJpdEluZGV4KG9NZGwuZG9tYWluLCBvTW9kZWwpO1xuICAgIG9NZGwuY2F0ZWdvcnlEZXNjcmliZWQgPSBbXTtcbiAgICAvLyByZWN0aWZ5IGNhdGVnb3J5XG4gICAgb01kbC5jYXRlZ29yeSA9IG9NZGwuY2F0ZWdvcnkubWFwKGZ1bmN0aW9uIChjYXQpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBjYXQgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBjYXQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBjYXQubmFtZSAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJNaXNzaW5nIG5hbWUgaW4gb2JqZWN0IHR5cGVkIGNhdGVnb3J5IGluIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0KSArIFwiIGluIG1vZGVsIFwiICsgc01vZGVsTmFtZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGVnb3J5RGVzY3JpYmVkTWFwW2NhdC5uYW1lXSA9IGNhdDtcbiAgICAgICAgb01kbC5jYXRlZ29yeURlc2NyaWJlZC5wdXNoKGNhdCk7XG4gICAgICAgIHJldHVybiBjYXQubmFtZTtcbiAgICB9KTtcbiAgICAvLyBhZGQgdGhlIGNhdGVnb3JpZXMgdG8gdGhlIG1vZGVsOlxuICAgIG9NZGwuY2F0ZWdvcnkuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChvTW9kZWwubVJ1bGVzLCB7XG4gICAgICAgICAgICBjYXRlZ29yeTogXCJjYXRlZ29yeVwiLFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogY2F0ZWdvcnksXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IGNhdGVnb3J5LnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgICBiaXRpbmRleDogb01kbC5iaXRpbmRleCxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH0pO1xuICAgIGlmIChvTW9kZWwuZG9tYWlucy5pbmRleE9mKG9NZGwuZG9tYWluKSA+PSAwKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiKioqKioqKioqKipoZXJlIG1kbFwiICsgSlNPTi5zdHJpbmdpZnkob01kbCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgYWxyZWFkeSBsb2FkZWQgd2hpbGUgbG9hZGluZyAnICsgc01vZGVsTmFtZSArICc/Jyk7XG4gICAgfVxuICAgIC8vIGNoZWNrIHByb3BlcnRpZXMgb2YgbW9kZWxcbiAgICBPYmplY3Qua2V5cyhvTWRsKS5zb3J0KCkuZm9yRWFjaChmdW5jdGlvbiAoc1Byb3BlcnR5KSB7XG4gICAgICAgIGlmIChBUlJfTU9ERUxfUFJPUEVSVElFUy5pbmRleE9mKHNQcm9wZXJ0eSkgPCAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIHByb3BlcnR5IFwiJyArIHNQcm9wZXJ0eSArICdcIiBub3QgYSBrbm93biBtb2RlbCBwcm9wZXJ0eSBpbiBtb2RlbCBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vIGNvbnNpZGVyIHN0cmVhbWxpbmluZyB0aGUgY2F0ZWdvcmllc1xuICAgIG9Nb2RlbC5yYXdNb2RlbHNbb01kbC5kb21haW5dID0gb01kbDtcbiAgICBvTW9kZWwuZnVsbC5kb21haW5bb01kbC5kb21haW5dID0ge1xuICAgICAgICBkZXNjcmlwdGlvbjogb01kbC5kZXNjcmlwdGlvbixcbiAgICAgICAgY2F0ZWdvcmllczogY2F0ZWdvcnlEZXNjcmliZWRNYXAsXG4gICAgICAgIGJpdGluZGV4OiBvTWRsLmJpdGluZGV4XG4gICAgfTtcbiAgICAvLyBjaGVjayB0aGF0XG4gICAgLy8gY2hlY2sgdGhhdCBtZW1iZXJzIG9mIHdvcmRpbmRleCBhcmUgaW4gY2F0ZWdvcmllcyxcbiAgICBvTWRsLndvcmRpbmRleCA9IG9NZGwud29yZGluZGV4IHx8IFtdO1xuICAgIG9NZGwud29yZGluZGV4LmZvckVhY2goZnVuY3Rpb24gKHNXb3JkSW5kZXgpIHtcbiAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzV29yZEluZGV4KSA8IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgd29yZGluZGV4IFwiJyArIHNXb3JkSW5kZXggKyAnXCIgbm90IGEgY2F0ZWdvcnkgb2YgZG9tYWluICcgKyBvTWRsLmRvbWFpbiArICcgJyk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBvTWRsLmV4YWN0bWF0Y2ggPSBvTWRsLmV4YWN0bWF0Y2ggfHwgW107XG4gICAgb01kbC5leGFjdG1hdGNoLmZvckVhY2goZnVuY3Rpb24gKHNFeGFjdE1hdGNoKSB7XG4gICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc0V4YWN0TWF0Y2gpIDwgMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNb2RlbCBleGFjdG1hdGNoIFwiJyArIHNFeGFjdE1hdGNoICsgJ1wiIG5vdCBhIGNhdGVnb3J5IG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgb01kbC5jb2x1bW5zID0gb01kbC5jb2x1bW5zIHx8IFtdO1xuICAgIG9NZGwuY29sdW1ucy5mb3JFYWNoKGZ1bmN0aW9uIChzRXhhY3RNYXRjaCkge1xuICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNFeGFjdE1hdGNoKSA8IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgY29sdW1uIFwiJyArIHNFeGFjdE1hdGNoICsgJ1wiIG5vdCBhIGNhdGVnb3J5IG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gYWRkIHJlbGF0aW9uIGRvbWFpbiAtPiBjYXRlZ29yeVxuICAgIHZhciBkb21haW5TdHIgPSBNZXRhRi5Eb21haW4ob01kbC5kb21haW4pLnRvRnVsbFN0cmluZygpO1xuICAgIHZhciByZWxhdGlvblN0ciA9IE1ldGFGLlJlbGF0aW9uKE1ldGEuUkVMQVRJT05faGFzQ2F0ZWdvcnkpLnRvRnVsbFN0cmluZygpO1xuICAgIHZhciByZXZlcnNlUmVsYXRpb25TdHIgPSBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikudG9GdWxsU3RyaW5nKCk7XG4gICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChzQ2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIENhdGVnb3J5U3RyaW5nID0gTWV0YUYuQ2F0ZWdvcnkoc0NhdGVnb3J5KS50b0Z1bGxTdHJpbmcoKTtcbiAgICAgICAgb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXSA9IG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdID0gb01vZGVsLm1ldGEudDNbZG9tYWluU3RyXVtyZWxhdGlvblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW2RvbWFpblN0cl1bcmVsYXRpb25TdHJdW0NhdGVnb3J5U3RyaW5nXSA9IHt9O1xuICAgICAgICBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ10gPSBvTW9kZWwubWV0YS50M1tDYXRlZ29yeVN0cmluZ10gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdID0gb01vZGVsLm1ldGEudDNbQ2F0ZWdvcnlTdHJpbmddW3JldmVyc2VSZWxhdGlvblN0cl0gfHwge307XG4gICAgICAgIG9Nb2RlbC5tZXRhLnQzW0NhdGVnb3J5U3RyaW5nXVtyZXZlcnNlUmVsYXRpb25TdHJdW2RvbWFpblN0cl0gPSB7fTtcbiAgICB9KTtcbiAgICAvLyBhZGQgYSBwcmVjaWNlIGRvbWFpbiBtYXRjaHJ1bGVcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiZG9tYWluXCIsXG4gICAgICAgIG1hdGNoZWRTdHJpbmc6IG9NZGwuZG9tYWluLFxuICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgIHdvcmQ6IG9NZGwuZG9tYWluLFxuICAgICAgICBiaXRpbmRleDogb01kbC5iaXRpbmRleCxcbiAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICB9LCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICAvLyBjaGVjayB0aGUgdG9vbFxuICAgIGlmIChvTWRsLnRvb2wgJiYgb01kbC50b29sLnJlcXVpcmVzKSB7XG4gICAgICAgIHZhciByZXF1aXJlcyA9IE9iamVjdC5rZXlzKG9NZGwudG9vbC5yZXF1aXJlcyB8fCB7fSk7XG4gICAgICAgIHZhciBkaWZmID0gXy5kaWZmZXJlbmNlKHJlcXVpcmVzLCBvTWRsLmNhdGVnb3J5KTtcbiAgICAgICAgaWYgKGRpZmYubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIgXCIgKyBvTWRsLmRvbWFpbiArIFwiIDogVW5rb3duIGNhdGVnb3J5IGluIHJlcXVpcmVzIG9mIHRvb2w6IFxcXCJcIiArIGRpZmYuam9pbignXCInKSArICdcIicpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgb3B0aW9uYWwgPSBPYmplY3Qua2V5cyhvTWRsLnRvb2wub3B0aW9uYWwpO1xuICAgICAgICBkaWZmID0gXy5kaWZmZXJlbmNlKG9wdGlvbmFsLCBvTWRsLmNhdGVnb3J5KTtcbiAgICAgICAgaWYgKGRpZmYubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIgXCIgKyBvTWRsLmRvbWFpbiArIFwiIDogVW5rb3duIGNhdGVnb3J5IG9wdGlvbmFsIG9mIHRvb2w6IFxcXCJcIiArIGRpZmYuam9pbignXCInKSArICdcIicpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICAgICAgfVxuICAgICAgICBPYmplY3Qua2V5cyhvTWRsLnRvb2wuc2V0cyB8fCB7fSkuZm9yRWFjaChmdW5jdGlvbiAoc2V0SUQpIHtcbiAgICAgICAgICAgIHZhciBkaWZmID0gXy5kaWZmZXJlbmNlKG9NZGwudG9vbC5zZXRzW3NldElEXS5zZXQsIG9NZGwuY2F0ZWdvcnkpO1xuICAgICAgICAgICAgaWYgKGRpZmYubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIFwiICsgb01kbC5kb21haW4gKyBcIiA6IFVua293biBjYXRlZ29yeSBpbiBzZXRJZCBcIiArIHNldElEICsgXCIgb2YgdG9vbDogXFxcIlwiICsgZGlmZi5qb2luKCdcIicpICsgJ1wiJyk7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIC8vIGV4dHJhY3QgdG9vbHMgYW4gYWRkIHRvIHRvb2xzOlxuICAgICAgICBvTW9kZWwudG9vbHMuZmlsdGVyKGZ1bmN0aW9uIChvRW50cnkpIHtcbiAgICAgICAgICAgIGlmIChvRW50cnkubmFtZSA9PT0gKG9NZGwudG9vbCAmJiBvTWRsLnRvb2wubmFtZSkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRvb2wgXCIgKyBvTWRsLnRvb2wubmFtZSArIFwiIGFscmVhZHkgcHJlc2VudCB3aGVuIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lKTtcbiAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignRG9tYWluIGFscmVhZHkgbG9hZGVkPycpO1xuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgb01kbC50b29saGlkZGVuID0gdHJ1ZTtcbiAgICAgICAgb01kbC50b29sLnJlcXVpcmVzID0geyBcImltcG9zc2libGVcIjoge30gfTtcbiAgICB9XG4gICAgLy8gYWRkIHRoZSB0b29sIG5hbWUgYXMgcnVsZSB1bmxlc3MgaGlkZGVuXG4gICAgaWYgKCFvTWRsLnRvb2xoaWRkZW4gJiYgb01kbC50b29sICYmIG9NZGwudG9vbC5uYW1lKSB7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFwidG9vbFwiLFxuICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogb01kbC50b29sLm5hbWUsXG4gICAgICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgICAgICB3b3JkOiBvTWRsLnRvb2wubmFtZSxcbiAgICAgICAgICAgIGJpdGluZGV4OiBvTWRsLmJpdGluZGV4LFxuICAgICAgICAgICAgX3Jhbmtpbmc6IDAuOTVcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgfVxuICAgIDtcbiAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW1widG9vbFwiXSkge1xuICAgICAgICBhZGRTeW5vbnltcyhvTWRsLnN5bm9ueW1zW1widG9vbFwiXSwgXCJ0b29sXCIsIG9NZGwudG9vbC5uYW1lLCBvTWRsLmJpdGluZGV4LCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICB9XG4gICAgO1xuICAgIGlmIChvTWRsLnN5bm9ueW1zKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKG9NZGwuc3lub255bXMpLmZvckVhY2goZnVuY3Rpb24gKHNzeW5rZXkpIHtcbiAgICAgICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc3N5bmtleSkgPj0gMCAmJiBzc3lua2V5ICE9PSBcInRvb2xcIikge1xuICAgICAgICAgICAgICAgIGlmIChvTW9kZWwuZnVsbC5kb21haW5bb01kbC5kb21haW5dLmNhdGVnb3JpZXNbc3N5bmtleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgb01vZGVsLmZ1bGwuZG9tYWluW29NZGwuZG9tYWluXS5jYXRlZ29yaWVzW3NzeW5rZXldLnN5bm9ueW1zID0gb01kbC5zeW5vbnltc1tzc3lua2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYWRkU3lub255bXMob01kbC5zeW5vbnltc1tzc3lua2V5XSwgXCJjYXRlZ29yeVwiLCBzc3lua2V5LCBvTWRsLmJpdGluZGV4LCBvTW9kZWwubVJ1bGVzLCBvTW9kZWwuc2VlblJ1bGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIG9Nb2RlbC5kb21haW5zLnB1c2gob01kbC5kb21haW4pO1xuICAgIGlmIChvTWRsLnRvb2wubmFtZSkge1xuICAgICAgICBvTW9kZWwudG9vbHMucHVzaChvTWRsLnRvb2wpO1xuICAgIH1cbiAgICBvTW9kZWwuY2F0ZWdvcnkgPSBvTW9kZWwuY2F0ZWdvcnkuY29uY2F0KG9NZGwuY2F0ZWdvcnkpO1xuICAgIG9Nb2RlbC5jYXRlZ29yeS5zb3J0KCk7XG4gICAgb01vZGVsLmNhdGVnb3J5ID0gb01vZGVsLmNhdGVnb3J5LmZpbHRlcihmdW5jdGlvbiAoc3RyaW5nLCBpbmRleCkge1xuICAgICAgICByZXR1cm4gb01vZGVsLmNhdGVnb3J5W2luZGV4XSAhPT0gb01vZGVsLmNhdGVnb3J5W2luZGV4ICsgMV07XG4gICAgfSk7XG59IC8vIGxvYWRtb2RlbFxuZnVuY3Rpb24gc3BsaXRSdWxlcyhydWxlcykge1xuICAgIHZhciByZXMgPSB7fTtcbiAgICB2YXIgbm9uV29yZFJ1bGVzID0gW107XG4gICAgcnVsZXMuZm9yRWFjaChmdW5jdGlvbiAocnVsZSkge1xuICAgICAgICBpZiAocnVsZS50eXBlID09PSAwIC8qIFdPUkQgKi8pIHtcbiAgICAgICAgICAgIGlmICghcnVsZS5sb3dlcmNhc2V3b3JkKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUnVsZSBoYXMgbm8gbWVtYmVyIGxvd2VyY2FzZXdvcmRcIiArIEpTT04uc3RyaW5naWZ5KHJ1bGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdID0gcmVzW3J1bGUubG93ZXJjYXNld29yZF0gfHwgeyBiaXRpbmRleDogMCwgcnVsZXM6IFtdIH07XG4gICAgICAgICAgICByZXNbcnVsZS5sb3dlcmNhc2V3b3JkXS5iaXRpbmRleCA9IHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdLmJpdGluZGV4IHwgcnVsZS5iaXRpbmRleDtcbiAgICAgICAgICAgIHJlc1tydWxlLmxvd2VyY2FzZXdvcmRdLnJ1bGVzLnB1c2gocnVsZSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBub25Xb3JkUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB7XG4gICAgICAgIHdvcmRNYXA6IHJlcyxcbiAgICAgICAgbm9uV29yZFJ1bGVzOiBub25Xb3JkUnVsZXMsXG4gICAgICAgIGFsbFJ1bGVzOiBydWxlcyxcbiAgICAgICAgd29yZENhY2hlOiB7fVxuICAgIH07XG59XG5leHBvcnRzLnNwbGl0UnVsZXMgPSBzcGxpdFJ1bGVzO1xuZnVuY3Rpb24gY21wTGVuZ3RoU29ydChhLCBiKSB7XG4gICAgdmFyIGQgPSBhLmxlbmd0aCAtIGIubGVuZ3RoO1xuICAgIGlmIChkKSB7XG4gICAgICAgIHJldHVybiBkO1xuICAgIH1cbiAgICByZXR1cm4gYS5sb2NhbGVDb21wYXJlKGIpO1xufVxudmFyIERpc3RhbmNlID0gcmVxdWlyZShcIi4uL3V0aWxzL2RhbWVyYXVMZXZlbnNodGVpblwiKTtcbnZhciBBbGdvbCA9IHJlcXVpcmUoXCIuLi9tYXRjaC9hbGdvbFwiKTtcbi8vIG9mZnNldFswXSA6IGxlbi0yXG4vLyAgICAgICAgICAgICBsZW4gLTFcbi8vICAgICAgICAgICAgIGxlblxuLy8gICAgICAgICAgICAgbGVuICsxXG4vLyAgICAgICAgICAgICBsZW4gKzJcbi8vICAgICAgICAgICAgIGxlbiArM1xuZnVuY3Rpb24gZmluZE5leHRMZW4odGFyZ2V0TGVuLCBhcnIsIG9mZnNldHMpIHtcbiAgICBvZmZzZXRzLnNoaWZ0KCk7XG4gICAgZm9yICh2YXIgaSA9IG9mZnNldHNbNF07IChpIDwgYXJyLmxlbmd0aCkgJiYgKGFycltpXS5sZW5ndGggPD0gdGFyZ2V0TGVuKTsgKytpKSB7XG4gICAgfVxuICAgIC8vY29uc29sZS5sb2coXCJwdXNoaW5nIFwiICsgaSk7XG4gICAgb2Zmc2V0cy5wdXNoKGkpO1xufVxuZXhwb3J0cy5maW5kTmV4dExlbiA9IGZpbmROZXh0TGVuO1xuZnVuY3Rpb24gYWRkUmFuZ2VSdWxlc1VubGVzc1ByZXNlbnQocnVsZXMsIGxjd29yZCwgcmFuZ2VSdWxlcywgcHJlc2VudFJ1bGVzRm9yS2V5LCBzZWVuUnVsZXMpIHtcbiAgICByYW5nZVJ1bGVzLmZvckVhY2goZnVuY3Rpb24gKHJhbmdlUnVsZSkge1xuICAgICAgICB2YXIgbmV3UnVsZSA9IE9iamVjdC5hc3NpZ24oe30sIHJhbmdlUnVsZSk7XG4gICAgICAgIG5ld1J1bGUubG93ZXJjYXNld29yZCA9IGxjd29yZDtcbiAgICAgICAgbmV3UnVsZS53b3JkID0gbGN3b3JkO1xuICAgICAgICAvL2lmKChsY3dvcmQgPT09ICdzZXJ2aWNlcycgfHwgbGN3b3JkID09PSAnc2VydmljZScpICYmIG5ld1J1bGUucmFuZ2UucnVsZS5sb3dlcmNhc2V3b3JkLmluZGV4T2YoJ29kYXRhJyk+PTApIHtcbiAgICAgICAgLy8gICAgY29uc29sZS5sb2coXCJhZGRpbmcgXCIrIEpTT04uc3RyaW5naWZ5KG5ld1J1bGUpICsgXCJcXG5cIik7XG4gICAgICAgIC8vfVxuICAgICAgICAvL3RvZG86IGNoZWNrIHdoZXRoZXIgYW4gZXF1aXZhbGVudCBydWxlIGlzIGFscmVhZHkgcHJlc2VudD9cbiAgICAgICAgdmFyIGNudCA9IHJ1bGVzLmxlbmd0aDtcbiAgICAgICAgaW5zZXJ0UnVsZUlmTm90UHJlc2VudChydWxlcywgbmV3UnVsZSwgc2VlblJ1bGVzKTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuYWRkUmFuZ2VSdWxlc1VubGVzc1ByZXNlbnQgPSBhZGRSYW5nZVJ1bGVzVW5sZXNzUHJlc2VudDtcbmZ1bmN0aW9uIGFkZENsb3NlRXhhY3RSYW5nZVJ1bGVzKHJ1bGVzLCBzZWVuUnVsZXMpIHtcbiAgICB2YXIga2V5c01hcCA9IHt9O1xuICAgIHZhciByYW5nZUtleXNNYXAgPSB7fTtcbiAgICBydWxlcy5mb3JFYWNoKGZ1bmN0aW9uIChydWxlKSB7XG4gICAgICAgIGlmIChydWxlLnR5cGUgPT09IDAgLyogV09SRCAqLykge1xuICAgICAgICAgICAgLy9rZXlzTWFwW3J1bGUubG93ZXJjYXNld29yZF0gPSAxO1xuICAgICAgICAgICAga2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdID0ga2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdIHx8IFtdO1xuICAgICAgICAgICAga2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdLnB1c2gocnVsZSk7XG4gICAgICAgICAgICBpZiAoIXJ1bGUuZXhhY3RPbmx5ICYmIHJ1bGUucmFuZ2UpIHtcbiAgICAgICAgICAgICAgICByYW5nZUtleXNNYXBbcnVsZS5sb3dlcmNhc2V3b3JkXSA9IHJhbmdlS2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdIHx8IFtdO1xuICAgICAgICAgICAgICAgIHJhbmdlS2V5c01hcFtydWxlLmxvd2VyY2FzZXdvcmRdLnB1c2gocnVsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGtleXNNYXApO1xuICAgIGtleXMuc29ydChjbXBMZW5ndGhTb3J0KTtcbiAgICB2YXIgbGVuID0gMDtcbiAgICBrZXlzLmZvckVhY2goZnVuY3Rpb24gKGtleSwgaW5kZXgpIHtcbiAgICAgICAgaWYgKGtleS5sZW5ndGggIT0gbGVuKSB7XG4gICAgICAgIH1cbiAgICAgICAgbGVuID0ga2V5Lmxlbmd0aDtcbiAgICB9KTtcbiAgICAvLyAgIGtleXMgPSBrZXlzLnNsaWNlKDAsMjAwMCk7XG4gICAgdmFyIHJhbmdlS2V5cyA9IE9iamVjdC5rZXlzKHJhbmdlS2V5c01hcCk7XG4gICAgcmFuZ2VLZXlzLnNvcnQoY21wTGVuZ3RoU29ydCk7XG4gICAgLy9jb25zb2xlLmxvZyhgICR7a2V5cy5sZW5ndGh9IGtleXMgYW5kICR7cmFuZ2VLZXlzLmxlbmd0aH0gcmFuZ2VrZXlzIGApO1xuICAgIHZhciBsb3cgPSAwO1xuICAgIHZhciBoaWdoID0gMDtcbiAgICB2YXIgbGFzdGxlbiA9IDA7XG4gICAgdmFyIG9mZnNldHMgPSBbMCwgMCwgMCwgMCwgMCwgMF07XG4gICAgdmFyIGxlbiA9IHJhbmdlS2V5cy5sZW5ndGg7XG4gICAgZmluZE5leHRMZW4oMCwga2V5cywgb2Zmc2V0cyk7XG4gICAgZmluZE5leHRMZW4oMSwga2V5cywgb2Zmc2V0cyk7XG4gICAgZmluZE5leHRMZW4oMiwga2V5cywgb2Zmc2V0cyk7XG4gICAgcmFuZ2VLZXlzLmZvckVhY2goZnVuY3Rpb24gKHJhbmdlS2V5KSB7XG4gICAgICAgIGlmIChyYW5nZUtleS5sZW5ndGggIT09IGxhc3RsZW4pIHtcbiAgICAgICAgICAgIGZvciAoaSA9IGxhc3RsZW4gKyAxOyBpIDw9IHJhbmdlS2V5Lmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgZmluZE5leHRMZW4oaSArIDIsIGtleXMsIG9mZnNldHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gICBjb25zb2xlLmxvZyhgIHNoaWZ0ZWQgdG8gJHtyYW5nZUtleS5sZW5ndGh9IHdpdGggb2Zmc2V0cyBiZWVpbmcgJHtvZmZzZXRzLmpvaW4oJyAnKX1gKTtcbiAgICAgICAgICAgIC8vICAgY29uc29sZS5sb2coYCBoZXJlIDAgJHtvZmZzZXRzWzBdfSA6ICR7a2V5c1tNYXRoLm1pbihrZXlzLmxlbmd0aC0xLCBvZmZzZXRzWzBdKV0ubGVuZ3RofSAgJHtrZXlzW01hdGgubWluKGtleXMubGVuZ3RoLTEsIG9mZnNldHNbMF0pXX0gYCk7XG4gICAgICAgICAgICAvLyAgY29uc29sZS5sb2coYCBoZXJlIDUtMSAgJHtrZXlzW29mZnNldHNbNV0tMV0ubGVuZ3RofSAgJHtrZXlzW29mZnNldHNbNV0tMV19IGApO1xuICAgICAgICAgICAgLy8gICBjb25zb2xlLmxvZyhgIGhlcmUgNSAke29mZnNldHNbNV19IDogJHtrZXlzW01hdGgubWluKGtleXMubGVuZ3RoLTEsIG9mZnNldHNbNV0pXS5sZW5ndGh9ICAke2tleXNbTWF0aC5taW4oa2V5cy5sZW5ndGgtMSwgb2Zmc2V0c1s1XSldfSBgKTtcbiAgICAgICAgICAgIGxhc3RsZW4gPSByYW5nZUtleS5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaSA9IG9mZnNldHNbMF07IGkgPCBvZmZzZXRzWzVdOyArK2kpIHtcbiAgICAgICAgICAgIHZhciBkID0gRGlzdGFuY2UuY2FsY0Rpc3RhbmNlQWRqdXN0ZWQocmFuZ2VLZXksIGtleXNbaV0pO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7cmFuZ2VLZXkubGVuZ3RoLWtleXNbaV0ubGVuZ3RofSAke2R9ICR7cmFuZ2VLZXl9IGFuZCAke2tleXNbaV19ICBgKTtcbiAgICAgICAgICAgIGlmICgoZCAhPT0gMS4wKSAmJiAoZCA+PSBBbGdvbC5DdXRvZmZfcmFuZ2VDbG9zZU1hdGNoKSkge1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYHdvdWxkIGFkZCAke3JhbmdlS2V5fSBmb3IgJHtrZXlzW2ldfSAke2R9YCk7XG4gICAgICAgICAgICAgICAgdmFyIGNudCA9IHJ1bGVzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAvLyB3ZSBvbmx5IGhhdmUgdG8gYWRkIGlmIHRoZXJlIGlzIG5vdCB5ZXQgYSBtYXRjaCBydWxlIGhlcmUgd2hpY2ggcG9pbnRzIHRvIHRoZSBzYW1lXG4gICAgICAgICAgICAgICAgYWRkUmFuZ2VSdWxlc1VubGVzc1ByZXNlbnQocnVsZXMsIGtleXNbaV0sIHJhbmdlS2V5c01hcFtyYW5nZUtleV0sIGtleXNNYXBba2V5c1tpXV0sIHNlZW5SdWxlcyk7XG4gICAgICAgICAgICAgICAgaWYgKHJ1bGVzLmxlbmd0aCA+IGNudCkge1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8qXG4gICAgW1xuICAgICAgICBbJ2FFRkcnLCdhRUZHSCddLFxuICAgICAgICBbJ2FFRkdIJywnYUVGR0hJJ10sXG4gICAgICAgIFsnT2RhdGEnLCdPRGF0YXMnXSxcbiAgIFsnT2RhdGEnLCdPZGF0YXMnXSxcbiAgIFsnT2RhdGEnLCdPZGF0YiddLFxuICAgWydPZGF0YScsJ1VEYXRhJ10sXG4gICBbJ3NlcnZpY2UnLCdzZXJ2aWNlcyddLFxuICAgWyd0aGlzIGlzZnVubnkgYW5kIG1vcmUnLCd0aGlzIGlzZnVubnkgYW5kIG1vcmVzJ10sXG4gICAgXS5mb3JFYWNoKHJlYyA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBkaXN0YW5jZSAke3JlY1swXX0gJHtyZWNbMV19IDogJHtEaXN0YW5jZS5jYWxjRGlzdGFuY2UocmVjWzBdLHJlY1sxXSl9ICBhZGYgJHtEaXN0YW5jZS5jYWxjRGlzdGFuY2VBZGp1c3RlZChyZWNbMF0scmVjWzFdKX0gYCk7XG5cbiAgICB9KTtcbiAgICBjb25zb2xlLmxvZyhcImRpc3RhbmNlIE9kYXRhIFVkYXRhXCIrIERpc3RhbmNlLmNhbGNEaXN0YW5jZSgnT0RhdGEnLCdVRGF0YScpKTtcbiAgICBjb25zb2xlLmxvZyhcImRpc3RhbmNlIE9kYXRhIE9kYXRiXCIrIERpc3RhbmNlLmNhbGNEaXN0YW5jZSgnT0RhdGEnLCdPRGF0YicpKTtcbiAgICBjb25zb2xlLmxvZyhcImRpc3RhbmNlIE9kYXRhcyBPZGF0YVwiKyBEaXN0YW5jZS5jYWxjRGlzdGFuY2UoJ09EYXRhJywnT0RhdGFhJykpO1xuICAgIGNvbnNvbGUubG9nKFwiZGlzdGFuY2UgT2RhdGFzIGFiY2RlXCIrIERpc3RhbmNlLmNhbGNEaXN0YW5jZSgnYWJjZGUnLCdhYmNkZWYnKSk7XG4gICAgY29uc29sZS5sb2coXCJkaXN0YW5jZSBzZXJ2aWNlcyBcIisgRGlzdGFuY2UuY2FsY0Rpc3RhbmNlKCdzZXJ2aWNlcycsJ3NlcnZpY2UnKSk7XG4gICAgKi9cbn1cbmV4cG9ydHMuYWRkQ2xvc2VFeGFjdFJhbmdlUnVsZXMgPSBhZGRDbG9zZUV4YWN0UmFuZ2VSdWxlcztcbnZhciBuID0gMDtcbmZ1bmN0aW9uIGxvYWRNb2RlbHMobW9kZWxQYXRoKSB7XG4gICAgdmFyIG9Nb2RlbDtcbiAgICBvTW9kZWwgPSB7XG4gICAgICAgIGZ1bGw6IHsgZG9tYWluOiB7fSB9LFxuICAgICAgICByYXdNb2RlbHM6IHt9LFxuICAgICAgICBkb21haW5zOiBbXSxcbiAgICAgICAgdG9vbHM6IFtdLFxuICAgICAgICBydWxlczogdW5kZWZpbmVkLFxuICAgICAgICBjYXRlZ29yeTogW10sXG4gICAgICAgIG9wZXJhdG9yczoge30sXG4gICAgICAgIG1SdWxlczogW10sXG4gICAgICAgIHNlZW5SdWxlczoge30sXG4gICAgICAgIHJlY29yZHM6IFtdLFxuICAgICAgICBtZXRhOiB7IHQzOiB7fSB9XG4gICAgfTtcbiAgICB2YXIgdCA9IERhdGUubm93KCk7XG4gICAgbW9kZWxQYXRoID0gbW9kZWxQYXRoIHx8IGVudk1vZGVsUGF0aDtcbiAgICB0cnkge1xuICAgICAgICB2YXIgYSA9IENpcmN1bGFyU2VyLmxvYWQoJy4vJyArIG1vZGVsUGF0aCArICcvX2NhY2hlZmFsc2UuanMnKTtcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcImZvdW5kIGEgY2FjaGUgPyAgXCIgKyAhIWEpO1xuICAgICAgICAvL2EgPSB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChhKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiByZXR1cm4gcHJlcGFyZXNlIG1vZGVsIFwiKTtcbiAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5BQk9UX0VNQUlMX1VTRVIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImxvYWRlZCBtb2RlbHMgZnJvbSBjYWNoZSBpbiBcIiArIChEYXRlLm5vdygpIC0gdCkgKyBcIiBcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgIH1cbiAgICB2YXIgbWRscyA9IHJlYWRGaWxlQXNKU09OKCcuLycgKyBtb2RlbFBhdGggKyAnL21vZGVscy5qc29uJyk7XG4gICAgbWRscy5mb3JFYWNoKGZ1bmN0aW9uIChzTW9kZWxOYW1lKSB7XG4gICAgICAgIGxvYWRNb2RlbChtb2RlbFBhdGgsIHNNb2RlbE5hbWUsIG9Nb2RlbCk7XG4gICAgfSk7XG4gICAgLy8gYWRkIHRoZSBjYXRlZ29yaWVzIHRvIHRoZSBtb2RlbDpcbiAgICAvKlxuICAgIG9Nb2RlbC5jYXRlZ29yeS5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBcImNhdGVnb3J5XCIsXG4gICAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBjYXRlZ29yeSxcbiAgICAgICAgICAgIHR5cGU6IElNYXRjaC5FbnVtUnVsZVR5cGUuV09SRCxcbiAgICAgICAgICAgIHdvcmQ6IGNhdGVnb3J5LFxuICAgICAgICAgICAgbG93ZXJjYXNld29yZDogY2F0ZWdvcnkudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIGJpdGluZGV4IDogb01kbC5cbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgICAgIH0sIG9Nb2RlbC5zZWVuUnVsZXMpO1xuICAgIH0pO1xuICAgICovXG4gICAgdmFyIG1ldGFCaXRJbmRleCA9IGdldERvbWFpbkJpdEluZGV4KCdtZXRhJywgb01vZGVsKTtcbiAgICAvLyBhZGQgdGhlIGRvbWFpbiBtZXRhIHJ1bGVcbiAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgY2F0ZWdvcnk6IFwibWV0YVwiLFxuICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImRvbWFpblwiLFxuICAgICAgICB0eXBlOiAwIC8qIFdPUkQgKi8sXG4gICAgICAgIHdvcmQ6IFwiZG9tYWluXCIsXG4gICAgICAgIGJpdGluZGV4OiBtZXRhQml0SW5kZXgsXG4gICAgICAgIF9yYW5raW5nOiAwLjk1XG4gICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgdmFyIGZpbGxlckJpdEluZGV4ID0gZ2V0RG9tYWluQml0SW5kZXgoJ21ldGEnLCBvTW9kZWwpO1xuICAgIC8vYWRkIGEgZmlsbGVyIHJ1bGVcbiAgICB2YXIgZmlsbGVycyA9IHJlYWRGaWxlQXNKU09OKCcuLycgKyBtb2RlbFBhdGggKyAnL2ZpbGxlci5qc29uJyk7XG4gICAgdmFyIHJlID0gXCJeKChcIiArIGZpbGxlcnMuam9pbihcIil8KFwiKSArIFwiKSkkXCI7XG4gICAgb01vZGVsLm1SdWxlcy5wdXNoKHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXG4gICAgICAgIHR5cGU6IDEgLyogUkVHRVhQICovLFxuICAgICAgICByZWdleHA6IG5ldyBSZWdFeHAocmUsIFwiaVwiKSxcbiAgICAgICAgbWF0Y2hlZFN0cmluZzogXCJmaWxsZXJcIixcbiAgICAgICAgYml0aW5kZXg6IGZpbGxlckJpdEluZGV4LFxuICAgICAgICBfcmFua2luZzogMC45XG4gICAgfSk7XG4gICAgLy9hZGQgb3BlcmF0b3JzXG4gICAgdmFyIG9wZXJhdG9ycyA9IHJlYWRGaWxlQXNKU09OKCcuL3Jlc291cmNlcy9tb2RlbC9vcGVyYXRvcnMuanNvbicpO1xuICAgIHZhciBvcGVyYXRvckJpdEluZGV4ID0gZ2V0RG9tYWluQml0SW5kZXgoJ29wZXJhdG9ycycsIG9Nb2RlbCk7XG4gICAgT2JqZWN0LmtleXMob3BlcmF0b3JzLm9wZXJhdG9ycykuZm9yRWFjaChmdW5jdGlvbiAob3BlcmF0b3IpIHtcbiAgICAgICAgaWYgKElNYXRjaC5hT3BlcmF0b3JOYW1lcy5pbmRleE9mKG9wZXJhdG9yKSA8IDApIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwidW5rbm93biBvcGVyYXRvciBcIiArIG9wZXJhdG9yKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInVua25vd24gb3BlcmF0b3IgXCIgKyBvcGVyYXRvcik7XG4gICAgICAgIH1cbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0gPSBvcGVyYXRvcnMub3BlcmF0b3JzW29wZXJhdG9yXTtcbiAgICAgICAgb01vZGVsLm9wZXJhdG9yc1tvcGVyYXRvcl0ub3BlcmF0b3IgPSBvcGVyYXRvcjtcbiAgICAgICAgT2JqZWN0LmZyZWV6ZShvTW9kZWwub3BlcmF0b3JzW29wZXJhdG9yXSk7XG4gICAgICAgIHZhciB3b3JkID0gb3BlcmF0b3I7XG4gICAgICAgIGluc2VydFJ1bGVJZk5vdFByZXNlbnQob01vZGVsLm1SdWxlcywge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFwib3BlcmF0b3JcIixcbiAgICAgICAgICAgIHdvcmQ6IHdvcmQudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIGxvd2VyY2FzZXdvcmQ6IHdvcmQudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgIG1hdGNoZWRTdHJpbmc6IHdvcmQsXG4gICAgICAgICAgICBiaXRpbmRleDogb3BlcmF0b3JCaXRJbmRleCxcbiAgICAgICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgIC8vIGFkZCBhbGwgc3lub255bXNcbiAgICAgICAgaWYgKG9wZXJhdG9ycy5zeW5vbnltc1tvcGVyYXRvcl0pIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKG9wZXJhdG9ycy5zeW5vbnltc1tvcGVyYXRvcl0pLmZvckVhY2goZnVuY3Rpb24gKHN5bm9ueW0pIHtcbiAgICAgICAgICAgICAgICBpbnNlcnRSdWxlSWZOb3RQcmVzZW50KG9Nb2RlbC5tUnVsZXMsIHtcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IFwib3BlcmF0b3JcIixcbiAgICAgICAgICAgICAgICAgICAgd29yZDogc3lub255bS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgICAgICAgICBsb3dlcmNhc2V3b3JkOiBzeW5vbnltLnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IDAgLyogV09SRCAqLyxcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFN0cmluZzogb3BlcmF0b3IsXG4gICAgICAgICAgICAgICAgICAgIGJpdGluZGV4OiBvcGVyYXRvckJpdEluZGV4LFxuICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogMC45XG4gICAgICAgICAgICAgICAgfSwgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8qXG4gICAgICAgIH0pXG4gICAgICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6IFwiZmlsbGVyXCIsXG4gICAgICAgICAgdHlwZTogMSxcbiAgICAgICAgICByZWdleHA6IC9eKChzdGFydCl8KHNob3cpfChmcm9tKXwoaW4pKSQvaSxcbiAgICAgICAgICBtYXRjaGVkU3RyaW5nOiBcImZpbGxlclwiLFxuICAgICAgICAgIF9yYW5raW5nOiAwLjlcbiAgICAgICAgfSxcbiAgICAqL1xuICAgIG9Nb2RlbC5tUnVsZXMgPSBvTW9kZWwubVJ1bGVzLnNvcnQoSW5wdXRGaWx0ZXJSdWxlcy5jbXBNUnVsZSk7XG4gICAgYWRkQ2xvc2VFeGFjdFJhbmdlUnVsZXMob01vZGVsLm1SdWxlcywgb01vZGVsLnNlZW5SdWxlcyk7XG4gICAgb01vZGVsLm1SdWxlcyA9IG9Nb2RlbC5tUnVsZXMuc29ydChJbnB1dEZpbHRlclJ1bGVzLmNtcE1SdWxlKTtcbiAgICBmb3JjZUdDKCk7XG4gICAgb01vZGVsLnJ1bGVzID0gc3BsaXRSdWxlcyhvTW9kZWwubVJ1bGVzKTtcbiAgICBmb3JjZUdDKCk7XG4gICAgb01vZGVsLnRvb2xzID0gb01vZGVsLnRvb2xzLnNvcnQoVG9vbHMuY21wVG9vbHMpO1xuICAgIGRlbGV0ZSBvTW9kZWwuc2VlblJ1bGVzO1xuICAgIGRlYnVnbG9nKCdzYXZpbmcnKTtcbiAgICBmb3JjZUdDKCk7XG4gICAgQ2lyY3VsYXJTZXIuc2F2ZSgnLi8nICsgbW9kZWxQYXRoICsgJy9fY2FjaGVmYWxzZS5qcycsIG9Nb2RlbCk7XG4gICAgZm9yY2VHQygpO1xuICAgIGlmIChwcm9jZXNzLmVudi5BQk9UX0VNQUlMX1VTRVIpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJsb2FkZWQgbW9kZWxzIGJ5IGNhbGN1bGF0aW9uIGluIFwiICsgKERhdGUubm93KCkgLSB0KSArIFwiIFwiKTtcbiAgICB9XG4gICAgcmV0dXJuIG9Nb2RlbDtcbn1cbmV4cG9ydHMubG9hZE1vZGVscyA9IGxvYWRNb2RlbHM7XG5mdW5jdGlvbiBzb3J0Q2F0ZWdvcmllc0J5SW1wb3J0YW5jZShtYXAsIGNhdHMpIHtcbiAgICB2YXIgcmVzID0gY2F0cy5zbGljZSgwKTtcbiAgICByZXMuc29ydChyYW5rQ2F0ZWdvcnlCeUltcG9ydGFuY2UuYmluZCh1bmRlZmluZWQsIG1hcCkpO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLnNvcnRDYXRlZ29yaWVzQnlJbXBvcnRhbmNlID0gc29ydENhdGVnb3JpZXNCeUltcG9ydGFuY2U7XG5mdW5jdGlvbiByYW5rQ2F0ZWdvcnlCeUltcG9ydGFuY2UobWFwLCBjYXRhLCBjYXRiKSB7XG4gICAgdmFyIGNhdEFEZXNjID0gbWFwW2NhdGFdO1xuICAgIHZhciBjYXRCRGVzYyA9IG1hcFtjYXRiXTtcbiAgICBpZiAoY2F0YSA9PT0gY2F0Yikge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgLy8gaWYgYSBpcyBiZWZvcmUgYiwgcmV0dXJuIC0xXG4gICAgaWYgKGNhdEFEZXNjICYmICFjYXRCRGVzYykge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIGlmICghY2F0QURlc2MgJiYgY2F0QkRlc2MpIHtcbiAgICAgICAgcmV0dXJuICsxO1xuICAgIH1cbiAgICB2YXIgcHJpb0EgPSAoY2F0QURlc2MgJiYgY2F0QURlc2MuaW1wb3J0YW5jZSkgfHwgOTk7XG4gICAgdmFyIHByaW9CID0gKGNhdEJEZXNjICYmIGNhdEJEZXNjLmltcG9ydGFuY2UpIHx8IDk5O1xuICAgIC8vIGxvd2VyIHByaW8gZ29lcyB0byBmcm9udFxuICAgIHZhciByID0gcHJpb0EgLSBwcmlvQjtcbiAgICBpZiAocikge1xuICAgICAgICByZXR1cm4gcjtcbiAgICB9XG4gICAgcmV0dXJuIGNhdGEubG9jYWxlQ29tcGFyZShjYXRiKTtcbn1cbmV4cG9ydHMucmFua0NhdGVnb3J5QnlJbXBvcnRhbmNlID0gcmFua0NhdGVnb3J5QnlJbXBvcnRhbmNlO1xudmFyIE1ldGFGID0gTWV0YS5nZXRNZXRhRmFjdG9yeSgpO1xuZnVuY3Rpb24gZ2V0T3BlcmF0b3IobWRsLCBvcGVyYXRvcikge1xuICAgIHJldHVybiBtZGwub3BlcmF0b3JzW29wZXJhdG9yXTtcbn1cbmV4cG9ydHMuZ2V0T3BlcmF0b3IgPSBnZXRPcGVyYXRvcjtcbmZ1bmN0aW9uIGdldFJlc3VsdEFzQXJyYXkobWRsLCBhLCByZWwpIHtcbiAgICBpZiAocmVsLnRvVHlwZSgpICE9PSAncmVsYXRpb24nKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImV4cGVjdCByZWxhdGlvbiBhcyAybmQgYXJnXCIpO1xuICAgIH1cbiAgICB2YXIgcmVzID0gbWRsLm1ldGEudDNbYS50b0Z1bGxTdHJpbmcoKV0gJiZcbiAgICAgICAgbWRsLm1ldGEudDNbYS50b0Z1bGxTdHJpbmcoKV1bcmVsLnRvRnVsbFN0cmluZygpXTtcbiAgICBpZiAoIXJlcykge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhyZXMpLnNvcnQoKS5tYXAoTWV0YUYucGFyc2VJTWV0YSk7XG59XG5leHBvcnRzLmdldFJlc3VsdEFzQXJyYXkgPSBnZXRSZXN1bHRBc0FycmF5O1xuZnVuY3Rpb24gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbih0aGVNb2RlbCwgZG9tYWluKSB7XG4gICAgaWYgKHRoZU1vZGVsLmRvbWFpbnMuaW5kZXhPZihkb21haW4pIDwgMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEb21haW4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xuICAgIH1cbiAgICB2YXIgcmVzID0gZ2V0UmVzdWx0QXNBcnJheSh0aGVNb2RlbCwgTWV0YUYuRG9tYWluKGRvbWFpbiksIE1ldGFGLlJlbGF0aW9uKE1ldGEuUkVMQVRJT05faGFzQ2F0ZWdvcnkpKTtcbiAgICByZXR1cm4gTWV0YS5nZXRTdHJpbmdBcnJheShyZXMpO1xufVxuZXhwb3J0cy5nZXRDYXRlZ29yaWVzRm9yRG9tYWluID0gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbjtcbmZ1bmN0aW9uIGdldFRhYmxlQ29sdW1ucyh0aGVNb2RlbCwgZG9tYWluKSB7XG4gICAgaWYgKHRoZU1vZGVsLmRvbWFpbnMuaW5kZXhPZihkb21haW4pIDwgMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEb21haW4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhlTW9kZWwucmF3TW9kZWxzW2RvbWFpbl0uY29sdW1ucy5zbGljZSgwKTtcbn1cbmV4cG9ydHMuZ2V0VGFibGVDb2x1bW5zID0gZ2V0VGFibGVDb2x1bW5zO1xuZnVuY3Rpb24gZm9yY2VHQygpIHtcbiAgICBpZiAoZ2xvYmFsICYmIGdsb2JhbC5nYykge1xuICAgICAgICBnbG9iYWwuZ2MoKTtcbiAgICB9XG59XG4vKipcbiAqIFJldHVybiBhbGwgY2F0ZWdvcmllcyBvZiBhIGRvbWFpbiB3aGljaCBjYW4gYXBwZWFyIG9uIGEgd29yZCxcbiAqIHRoZXNlIGFyZSB0eXBpY2FsbHkgdGhlIHdvcmRpbmRleCBkb21haW5zICsgZW50cmllcyBnZW5lcmF0ZWQgYnkgZ2VuZXJpYyBydWxlc1xuICpcbiAqIFRoZSBjdXJyZW50IGltcGxlbWVudGF0aW9uIGlzIGEgc2ltcGxpZmljYXRpb25cbiAqL1xuZnVuY3Rpb24gZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4odGhlTW9kZWwsIGRvbWFpbikge1xuICAgIC8vIHRoaXMgaXMgYSBzaW1wbGlmaWVkIHZlcnNpb25cbiAgICByZXR1cm4gZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbih0aGVNb2RlbCwgZG9tYWluKTtcbn1cbmV4cG9ydHMuZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4gPSBnZXRQb3RlbnRpYWxXb3JkQ2F0ZWdvcmllc0ZvckRvbWFpbjtcbmZ1bmN0aW9uIGdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbCwgY2F0ZWdvcnkpIHtcbiAgICBpZiAodGhlTW9kZWwuY2F0ZWdvcnkuaW5kZXhPZihjYXRlZ29yeSkgPCAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhdGVnb3J5IFxcXCJcIiArIGNhdGVnb3J5ICsgXCJcXFwiIG5vdCBwYXJ0IG9mIG1vZGVsXCIpO1xuICAgIH1cbiAgICB2YXIgcmVzID0gZ2V0UmVzdWx0QXNBcnJheSh0aGVNb2RlbCwgTWV0YUYuQ2F0ZWdvcnkoY2F0ZWdvcnkpLCBNZXRhRi5SZWxhdGlvbihNZXRhLlJFTEFUSU9OX2lzQ2F0ZWdvcnlPZikpO1xuICAgIHJldHVybiBNZXRhLmdldFN0cmluZ0FycmF5KHJlcyk7XG59XG5leHBvcnRzLmdldERvbWFpbnNGb3JDYXRlZ29yeSA9IGdldERvbWFpbnNGb3JDYXRlZ29yeTtcbmZ1bmN0aW9uIGdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yeShtb2RlbCwgY2F0ZWdvcnksIHdvcmRzb25seSkge1xuICAgIHZhciByZXMgPSB7fTtcbiAgICAvL1xuICAgIHZhciBmbiA9IHdvcmRzb25seSA/IGdldFBvdGVudGlhbFdvcmRDYXRlZ29yaWVzRm9yRG9tYWluIDogZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbjtcbiAgICB2YXIgZG9tYWlucyA9IGdldERvbWFpbnNGb3JDYXRlZ29yeShtb2RlbCwgY2F0ZWdvcnkpO1xuICAgIGRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoZG9tYWluKSB7XG4gICAgICAgIGZuKG1vZGVsLCBkb21haW4pLmZvckVhY2goZnVuY3Rpb24gKHdvcmRjYXQpIHtcbiAgICAgICAgICAgIHJlc1t3b3JkY2F0XSA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIE9iamVjdC5mcmVlemUocmVzKTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5nZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcnkgPSBnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcnk7XG5mdW5jdGlvbiBnZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcmllcyhtb2RlbCwgY2F0ZWdvcmllcywgd29yZHNvbmx5KSB7XG4gICAgdmFyIHJlcyA9IHt9O1xuICAgIC8vXG4gICAgdmFyIGZuID0gd29yZHNvbmx5ID8gZ2V0UG90ZW50aWFsV29yZENhdGVnb3JpZXNGb3JEb21haW4gOiBnZXRDYXRlZ29yaWVzRm9yRG9tYWluO1xuICAgIHZhciBkb21haW5zID0gdW5kZWZpbmVkO1xuICAgIGNhdGVnb3JpZXMuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIGNhdGRvbWFpbnMgPSBnZXREb21haW5zRm9yQ2F0ZWdvcnkobW9kZWwsIGNhdGVnb3J5KTtcbiAgICAgICAgaWYgKCFkb21haW5zKSB7XG4gICAgICAgICAgICBkb21haW5zID0gY2F0ZG9tYWlucztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGRvbWFpbnMgPSBfLmludGVyc2VjdGlvbihkb21haW5zLCBjYXRkb21haW5zKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChkb21haW5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhdGVnb3JpZXMgJyArIFV0aWxzLmxpc3RUb1F1b3RlZENvbW1hQW5kKGNhdGVnb3JpZXMpICsgJyBoYXZlIG5vIGNvbW1vbiBkb21haW4uJyk7XG4gICAgfVxuICAgIGRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoZG9tYWluKSB7XG4gICAgICAgIGZuKG1vZGVsLCBkb21haW4pLmZvckVhY2goZnVuY3Rpb24gKHdvcmRjYXQpIHtcbiAgICAgICAgICAgIHJlc1t3b3JkY2F0XSA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIE9iamVjdC5mcmVlemUocmVzKTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5nZXRBbGxSZWNvcmRDYXRlZ29yaWVzRm9yVGFyZ2V0Q2F0ZWdvcmllcyA9IGdldEFsbFJlY29yZENhdGVnb3JpZXNGb3JUYXJnZXRDYXRlZ29yaWVzO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
