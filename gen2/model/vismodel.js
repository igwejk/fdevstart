/**
 * visualize a model and calculate some statistics
 */
"use strict";

var fs = require("fs");
var Model = require("./model");
var Util = require("../utils/utils");
var Describe = require("../match/describe");
var _ = require("lodash");
var debug = require("debug");
var debuglog = debug('vismodel.ts');
;
function calcCategoryRecord(m, category, domain) {
    var otherdomains = Model.getDomainsForCategory(m, category);
    _.pull(otherdomains, domain);
    var res = {
        otherdomains: otherdomains,
        nrDistinctValues: 0,
        nrDistinctValuesInDomain: 0,
        nrRecords: 0,
        nrRecordsInDomain: 0,
        nrTotalRecordsInDomain: 0
    };
    var values = [];
    var valuesInDomain = [];
    var nrRecordsInDomain = 0;
    var distinctValues = m.records.forEach(function (oEntry) {
        if (oEntry._domain === domain) {
            res.nrTotalRecordsInDomain += 1;
        }
        if (oEntry[category]) {
            var value = oEntry[category];
            if (oEntry._domain === domain) {
                valuesInDomain[value] = (valuesInDomain[value] || 0) + 1;
                res.nrRecordsInDomain += 1;
            }
            values[value] = (values[value] || 0) + 1;
            res.nrRecords += 1;
        }
    });
    res.nrDistinctValues = Object.keys(values).length;
    res.nrDistinctValuesInDomain = Object.keys(valuesInDomain).length;
    return res;
}
exports.calcCategoryRecord = calcCategoryRecord;
function graphDomain(domain, m) {
    // draw a model domains
    var res = "\n    digraph sdsu {\n\tsize=\"36,36\";\n   rankdir=LR\n\tnode [color=yellow, style=filled];\n    \"" + domain + "\"\n  ";
    // add all category nodes
    res += "node [shape=record, color=yellow, style=filled];\n ";
    var cats = Model.getCategoriesForDomain(m, domain);
    var categoryResults = {};
    var otherdomains = [];
    cats.forEach(function (cat) {
        var catResult = calcCategoryRecord(m, cat, domain);
        categoryResults[cat] = catResult;
        otherdomains = _.union(otherdomains, categoryResults[cat].otherDomains);
        res += "\"" + cat + "\" [label=\"{ " + cat + " | " + catResult.nrDistinctValuesInDomain + " Values in " + catResult.nrRecordsInDomain + " ";
        if (catResult.nrRecordsInDomain !== catResult.nrRecords) {
            res += "|  " + (catResult.nrDistinctValues - catResult.nrDistinctValuesInDomain) + " other values in " + (catResult.nrRecords - catResult.nrRecordsInDomain) + " other records";
        } else {
            res += " ";
        }
        res += "}\"]\n";
    });
    // calculate other domains.
    // draw "other categories"
    res += "node [color=purple, style=filled]; \n";
    otherdomains.forEach(function (otherdomain) {
        res += "\"" + otherdomain + "\" \n";
    });
    // count records in domain :
    var nrRecords = m.records.reduce(function (prev, entry) {
        return prev + (entry._domain === domain ? 1 : 0);
    }, 0);
    res += "node [shape=record]; \n";
    res += " \"record\" [label=\"{<f0> " + domain + " | " + nrRecords + "}\"] \n";
    res += " \"r_other\" [label=\"{<f0> other | " + nrRecords + "}\"] \n ";
    res += "# relation from categories to domain\n";
    cats.forEach(function (cat) {
        res += " \"" + cat + "\" -> \"" + domain + "\" \n";
    });
    res += "# relation from categories to records\n";
    cats.forEach(function (cat) {
        var rec = categoryResults[cat];
        res += " \"" + cat + "\" -> \"record\" \n";
    });
    //other domains to this
    cats.forEach(function (cat) {});
    /*
    cats fo
      digraph sdsu {
      size="36,36";
      node [color=yellow, style=filled];
      FLPD FLP "BOM Editor", "WIKIURL" "UI5 Documentation", "UI5 Example", "STARTTA"
      BCP
      node [color=grey, style=filled];
      node [fontname="Verdana", size="30,30"];
      node [color=grey, style=filled];
      graph [ fontname = "Arial",
    */
    res += "}\n";
    return res;
}
exports.graphDomain = graphDomain;
/*
    categoryDesc : theModel.full.domain[filterdomain].categories[category],
    distinct : distinct,
    delta : delta,
    presentRecords : recordCount.presentrecords,
    percPresent : percent,
    sampleValues : valuesList
  }
*/
function replaceBr(string) {
    string = string.replace(/\n/g, "\n\t\t\t\t\t\t\t\t\t\t\tbr\n\t\t\t\t\t\t\t\t\t\t\t| ");
    return string;
}
/**
 * generate a textual representation of a domain
 */
function tabDomain(domain, m) {
    // draw a model domains
    var cats = Model.getCategoriesForDomain(m, domain);
    cats = Model.sortCategoriesByImportance(m.full.domain[domain].categories || {}, cats);
    //console.log(cats.join("\n"));
    var catdesc = Describe.getCategoryStatsInDomain(cats[0], domain, m);
    var catResult = calcCategoryRecord(m, cats[0], domain);
    var domainDescr = m.full.domain[domain].description || "";
    domainDescr = replaceBr(domainDescr);
    var res = "\n\n// preset form values if we receive a userdata object //\n- user = user\n\nextends ../layout_p\n\nblock content\n\n\tnav.navbar.navbar-default.navbar-fixed-top\n\t\t.container\n\t\t\t.navbar-header\n\t\t\t\t.navbar-brand(style='bgcolor:orange;color:darkblue;font-family:Arial Black;font-size:15.118px') wosap domain " + domain + "\n\t\t\tul.nav.navbar-nav.navbar-right #{uid}\n\t\t\t\tli\n\t\t\t\t\t.navbar-btn#btn-logout.btn.btn-default(onclick=\"location.href='/home'\")\n\t\t\t\t\t\t| back to home\n\n\tp  &nbsp;\n\tp &nbsp;\n\tp\n\n\tdiv.well\n\t\th3 domain \"" + domain + "\"\n\t\t\tspan.pull-right " + catResult.nrTotalRecordsInDomain + " records\n\t\tp\n\t\tspan " + domainDescr + "\n\n\t\ttable.table.table-condensed.table-striped\n\t\t\tthead\n\t\t\t\ttr\n\t\t\t\t\tth category\n\t\t\t\t\tth(style=\"width:10%\") count\n\t\t\t\t\tth\n\t\t\t\t\t\ttable\n\t\t\t\t\t\t\ttr\n\t\t\t\t\t\t\t\ttd synonyms\n\t\t\t\t\t\t\ttr\n\t\t\t\t\t\t\t\ttd description\n\t\t\t\t\t\t\ttr\n\t\t\t\t\t\t\t\ttd example values\n\t\t\ttbody\n";
    var categoryResults = {};
    var otherdomains = [];
    var categoryMap = m.full.domain[domain].categories || {};
    cats.forEach(function (cat) {
        var catdesc = Describe.getCategoryStatsInDomain(cat, domain, m);
        //console.log(JSON.stringify(catdesc));
        var catResult = calcCategoryRecord(m, cat, domain);
        categoryResults[cat] = catResult;
        otherdomains = _.union(otherdomains, categoryResults[cat].otherDomains);
        /*
            res += `"${cat}" [label="{ ${cat} | ${catResult.nrDistinctValuesInDomain} Values in ${catResult.nrRecordsInDomain} `;
            if(catResult.nrRecordsInDomain !== catResult.nrRecords) {
              res +=  `|  ${catResult.nrDistinctValues - catResult.nrDistinctValuesInDomain} other values in ${catResult.nrRecords - catResult.nrRecordsInDomain} other records`;
            } else {
              res += ` `;
            }
            res += `}"]\n`;
        */
        //console.log(JSON.stringify(m.full.domain[domain]));
        if (m.full.domain[domain].categories[cat]) {
            var synonymsString = Util.listToCommaAnd(catdesc.categoryDesc && catdesc.categoryDesc.synonyms && catdesc.categoryDesc.synonyms || []) || "&nbsp;";
            res += "\n\t\t\ttr\n\t\t\t\t\ttd.cat_count " + cat + "\n\t\t\t\t\ttd " + catdesc.presentRecords + " distinct values in " + catdesc.percPresent + "% of records\n\t\t\t\t\ttd\n\t\t\t\t\t\ttable\n\t\t\t\t\t\t\ttr.cat_synonyms\n\t\t\t\t\t\t\t\ttd " + synonymsString + "\n\t\t\t\t\t\t\ttr.cat_description\n\t\t\t\t\t\t\t\ttd " + replaceBr(catdesc.categoryDesc && catdesc.categoryDesc.description || "") + "\n\t\t\t\t\t\t\ttr.cat_samplevalues\n\t\t\t\t\t\t\t\ttd " + replaceBr(catdesc.sampleValues) + "\n      ";
        }
    });
    var othercats = cats.length - Object.keys(m.full.domain[domain].categories).length;
    var remainingCategories = _.difference(cats, Object.keys(m.full.domain[domain].categories));
    if (othercats > 0) {
        res += "\n\t\tp   and " + othercats + " other categories\n\t\t| " + Util.listToCommaAnd(remainingCategories) + "\n       ";
    }
    /*
      // calculate other domains.
      // draw "other categories"
      res += `node [color=purple, style=filled]; \n`
      otherdomains.forEach(function(otherdomain) {
        res += `"${otherdomain}" \n`;
      });
      // count records in domain :
      var nrRecords = m.records.reduce(function(prev,entry) {
      return prev + ((entry._domain === domain) ? 1 : 0);
      },0);
      res += `node [shape=record]; \n`
      res += ` "record" [label="{<f0> ${domain} | ${nrRecords}}"] \n`;
    
      res += ` "r_other" [label="{<f0> other | ${nrRecords}}"] \n `;
    
      res += `# relation from categories to domain\n`;
      cats.forEach(function(cat) {
        res += ` "${cat}" -> "${domain}" \n`;
      })
    
    
      res += `# relation from categories to records\n`;
      cats.forEach(function(cat) {
        var rec = categoryResults[cat];
        res += ` "${cat}" -> "record" \n`;
      })
    
    
      //other domains to this
      cats.forEach(function(cat) {
    
    
      })
    */
    /*
    cats fo
      digraph sdsu {
      size="36,36";
      node [color=yellow, style=filled];
      FLPD FLP "BOM Editor", "WIKIURL" "UI5 Documentation", "UI5 Example", "STARTTA"
      BCP
      node [color=grey, style=filled];
      node [fontname="Verdana", size="30,30"];
      node [color=grey, style=filled];
      graph [ fontname = "Arial",
    */
    res += "\n\t\th3 Version\n\t\t\ta.small(href=\"/whatsnew\")\n\n\nblock scripts\n\tscript(src='/vendor/jquery-2.2.3.min.js')\n\tscript(src='/vendor/bootstrap.min.js')\n\tscript(src='/js/views/settings.js')\n";
    return res;
}
exports.tabDomain = tabDomain;
var child_process_1 = require("child_process");
function execCmd(cmd) {
    child_process_1.exec(cmd, function (error, stdout, stderr) {
        if (error) {
            console.error("exec error: " + error);
            return;
        }
        console.log("stdout: " + stdout);
        console.log("stderr: " + stderr);
    });
}
;
function visModels(m, folderOut) {
    m.domains.forEach(function (sDomain) {
        var s = graphDomain(sDomain, m);
        var fnGraph = folderOut + "/" + sDomain.replace(/ /g, '_') + ".gv";
        fs.writeFileSync(fnGraph, s);
        if (process.env.GRAPHVIZ) {
            console.log("here the file " + fnGraph);
            execCmd(process.env.GRAPHVIZ + " -Tjpeg -O " + fnGraph);
        }
    });
}
exports.visModels = visModels;
function tabModels(m, folderOut) {
    m.domains.forEach(function (sDomain) {
        var s = tabDomain(sDomain, m);
        var fnGraph = folderOut + "/" + sDomain.replace(/ /g, '_') + ".jade";
        debuglog("here the file " + fnGraph);
        fs.writeFileSync(fnGraph, s);
    });
}
exports.tabModels = tabModels;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC92aXNtb2RlbC50cyIsIm1vZGVsL3Zpc21vZGVsLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsIk1vZGVsIiwiVXRpbCIsIkRlc2NyaWJlIiwiXyIsImRlYnVnIiwiZGVidWdsb2ciLCJjYWxjQ2F0ZWdvcnlSZWNvcmQiLCJtIiwiY2F0ZWdvcnkiLCJkb21haW4iLCJvdGhlcmRvbWFpbnMiLCJnZXREb21haW5zRm9yQ2F0ZWdvcnkiLCJwdWxsIiwicmVzIiwibnJEaXN0aW5jdFZhbHVlcyIsIm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbiIsIm5yUmVjb3JkcyIsIm5yUmVjb3Jkc0luRG9tYWluIiwibnJUb3RhbFJlY29yZHNJbkRvbWFpbiIsInZhbHVlcyIsInZhbHVlc0luRG9tYWluIiwiZGlzdGluY3RWYWx1ZXMiLCJyZWNvcmRzIiwiZm9yRWFjaCIsIm9FbnRyeSIsIl9kb21haW4iLCJ2YWx1ZSIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJleHBvcnRzIiwiZ3JhcGhEb21haW4iLCJjYXRzIiwiZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbiIsImNhdGVnb3J5UmVzdWx0cyIsImNhdCIsImNhdFJlc3VsdCIsInVuaW9uIiwib3RoZXJEb21haW5zIiwib3RoZXJkb21haW4iLCJyZWR1Y2UiLCJwcmV2IiwiZW50cnkiLCJyZWMiLCJyZXBsYWNlQnIiLCJzdHJpbmciLCJyZXBsYWNlIiwidGFiRG9tYWluIiwic29ydENhdGVnb3JpZXNCeUltcG9ydGFuY2UiLCJmdWxsIiwiY2F0ZWdvcmllcyIsImNhdGRlc2MiLCJnZXRDYXRlZ29yeVN0YXRzSW5Eb21haW4iLCJkb21haW5EZXNjciIsImRlc2NyaXB0aW9uIiwiY2F0ZWdvcnlNYXAiLCJzeW5vbnltc1N0cmluZyIsImxpc3RUb0NvbW1hQW5kIiwiY2F0ZWdvcnlEZXNjIiwic3lub255bXMiLCJwcmVzZW50UmVjb3JkcyIsInBlcmNQcmVzZW50Iiwic2FtcGxlVmFsdWVzIiwib3RoZXJjYXRzIiwicmVtYWluaW5nQ2F0ZWdvcmllcyIsImRpZmZlcmVuY2UiLCJjaGlsZF9wcm9jZXNzXzEiLCJleGVjQ21kIiwiY21kIiwiZXhlYyIsImVycm9yIiwic3Rkb3V0Iiwic3RkZXJyIiwiY29uc29sZSIsImxvZyIsInZpc01vZGVscyIsImZvbGRlck91dCIsImRvbWFpbnMiLCJzRG9tYWluIiwicyIsImZuR3JhcGgiLCJ3cml0ZUZpbGVTeW5jIiwicHJvY2VzcyIsImVudiIsIkdSQVBIVklaIiwidGFiTW9kZWxzIl0sIm1hcHBpbmdzIjoiQUFBQTs7O0FDR0E7O0FETUEsSUFBQUEsS0FBQUMsUUFBQSxJQUFBLENBQUE7QUFFQSxJQUFBQyxRQUFBRCxRQUFBLFNBQUEsQ0FBQTtBQUNBLElBQUFFLE9BQUFGLFFBQUEsZ0JBQUEsQ0FBQTtBQUVBLElBQUFHLFdBQUFILFFBQUEsbUJBQUEsQ0FBQTtBQUVBLElBQUFJLElBQUFKLFFBQUEsUUFBQSxDQUFBO0FBQ0EsSUFBQUssUUFBQUwsUUFBQSxPQUFBLENBQUE7QUFDQSxJQUFJTSxXQUFXRCxNQUFNLGFBQU4sQ0FBZjtBQVNHO0FBRUgsU0FBQUUsa0JBQUEsQ0FBbUNDLENBQW5DLEVBQXVEQyxRQUF2RCxFQUEwRUMsTUFBMUUsRUFBeUY7QUFFdkYsUUFBSUMsZUFBZVYsTUFBTVcscUJBQU4sQ0FBNEJKLENBQTVCLEVBQThCQyxRQUE5QixDQUFuQjtBQUNDTCxNQUFFUyxJQUFGLENBQU9GLFlBQVAsRUFBcUJELE1BQXJCO0FBQ0EsUUFBSUksTUFBTTtBQUNUSCxzQkFBZUEsWUFETjtBQUVUSSwwQkFBbUIsQ0FGVjtBQUdUQyxrQ0FBMkIsQ0FIbEI7QUFJVEMsbUJBQVksQ0FKSDtBQUtUQywyQkFBbUIsQ0FMVjtBQU1UQyxnQ0FBeUI7QUFOaEIsS0FBVjtBQVNBLFFBQUlDLFNBQVMsRUFBYjtBQUNBLFFBQUlDLGlCQUFpQixFQUFyQjtBQUNBLFFBQUlILG9CQUFvQixDQUF4QjtBQUNBLFFBQUlJLGlCQUFpQmQsRUFBRWUsT0FBRixDQUFVQyxPQUFW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SXlFLFVBQVVKLFlBQVksR0FBWixHQUFrQkUsUUFBUWhDLE9BQVIsQ0FBZ0IsSUFBaEIsRUFBcUIsR0FBckIsQ0FBbEIsR0FBOEMsT0FBNUQ7QUFDQXpDLGlCQUFTLG1CQUFtQjJFLE9BQTVCO0FBQ0FsRixXQUFHbUYsYUFBSCxDQUFpQkQsT0FBakIsRUFBMEJELENBQTFCO0FBQ0QsS0FMRDtBQU1EO0FBUERqRCxRQUFBdUQsU0FBQSxHQUFBQSxTQUFBIiwiZmlsZSI6Im1vZGVsL3Zpc21vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiB2aXN1YWxpemUgYSBtb2RlbCBhbmQgY2FsY3VsYXRlIHNvbWUgc3RhdGlzdGljc1xuICovXG5cblxuXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XG5cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuXG5pbXBvcnQgKiBhcyBNb2RlbCBmcm9tICcuL21vZGVsJztcbmltcG9ydCAqIGFzIFV0aWwgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5pbXBvcnQgKiBhcyBEZXNjcmliZSBmcm9tICcuLi9tYXRjaC9kZXNjcmliZSc7XG5cbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCd2aXNtb2RlbC50cycpO1xuXG5pbnRlcmZhY2UgQ2F0ZWdvcnlSZWNvcmQge1xuICAgIG90aGVyZG9tYWlucyA6IHN0cmluZ1tdLFxuICAgIG5yRGlzdGluY3RWYWx1ZXMgOiBudW1iZXIsXG4gICAgbnJEaXN0aW5jdFZhbHVlc0luRG9tYWluIDogbnVtYmVyLFxuICAgIG5yUmVjb3JkcyA6IG51bWJlcixcbiAgICBuclJlY29yZHNJbkRvbWFpbjogbnVtYmVyLFxuICAgIG5yVG90YWxSZWNvcmRzSW5Eb21haW4gOiBudW1iZXJcbiAgfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGNDYXRlZ29yeVJlY29yZChtIDogSU1hdGNoLklNb2RlbHMsIGNhdGVnb3J5IDogc3RyaW5nLCBkb21haW4gOiBzdHJpbmcpICA6IENhdGVnb3J5UmVjb3JkIHtcblxuICB2YXIgb3RoZXJkb21haW5zID0gTW9kZWwuZ2V0RG9tYWluc0ZvckNhdGVnb3J5KG0sY2F0ZWdvcnkpO1xuICAgXy5wdWxsKG90aGVyZG9tYWlucywgZG9tYWluKTtcbiAgIHZhciByZXMgPSB7XG4gICAgb3RoZXJkb21haW5zIDogb3RoZXJkb21haW5zLFxuICAgIG5yRGlzdGluY3RWYWx1ZXMgOiAwLFxuICAgIG5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbiA6IDAsXG4gICAgbnJSZWNvcmRzIDogMCxcbiAgICBuclJlY29yZHNJbkRvbWFpbjogMCxcbiAgICBuclRvdGFsUmVjb3Jkc0luRG9tYWluIDogMCxcbiAgfSBhcyBDYXRlZ29yeVJlY29yZDtcblxuICAgdmFyIHZhbHVlcyA9IFtdO1xuICAgdmFyIHZhbHVlc0luRG9tYWluID0gW107XG4gICB2YXIgbnJSZWNvcmRzSW5Eb21haW4gPSAwO1xuICAgdmFyIGRpc3RpbmN0VmFsdWVzID0gbS5yZWNvcmRzLmZvckVhY2goZnVuY3Rpb24ob0VudHJ5KSB7XG4gICAgIGlmKG9FbnRyeS5fZG9tYWluID09PSBkb21haW4pIHtcbiAgICAgICByZXMubnJUb3RhbFJlY29yZHNJbkRvbWFpbiArPSAxO1xuICAgICB9XG4gICAgIGlmIChvRW50cnlbY2F0ZWdvcnldKSB7XG4gICAgICAgdmFyIHZhbHVlID0gb0VudHJ5W2NhdGVnb3J5XTtcbiAgICAgICBpZihvRW50cnkuX2RvbWFpbiA9PT0gZG9tYWluKSB7XG4gICAgICAgICB2YWx1ZXNJbkRvbWFpblt2YWx1ZV0gPSAodmFsdWVzSW5Eb21haW5bdmFsdWVdIHx8IDApICsgMTtcbiAgICAgICAgIHJlcy5uclJlY29yZHNJbkRvbWFpbiArPSAxO1xuICAgICAgIH1cbiAgICAgIHZhbHVlc1t2YWx1ZV0gPSAodmFsdWVzW3ZhbHVlXSB8fCAwKSArIDE7XG4gICAgICAgcmVzLm5yUmVjb3JkcyArPSAxO1xuICAgICB9XG4gICB9KTtcbiAgIHJlcy5uckRpc3RpbmN0VmFsdWVzID0gT2JqZWN0LmtleXModmFsdWVzKS5sZW5ndGg7XG4gICByZXMubnJEaXN0aW5jdFZhbHVlc0luRG9tYWluID0gT2JqZWN0LmtleXModmFsdWVzSW5Eb21haW4pLmxlbmd0aDtcbiAgIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBncmFwaERvbWFpbihkb21haW4gOiBzdHJpbmcsIG0gOiBJTWF0Y2guSU1vZGVscykge1xuICAvLyBkcmF3IGEgbW9kZWwgZG9tYWluc1xuICB2YXIgcmVzID0gYFxuICAgIGRpZ3JhcGggc2RzdSB7XG5cdHNpemU9XCIzNiwzNlwiO1xuICAgcmFua2Rpcj1MUlxuXHRub2RlIFtjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XG4gICAgXCIke2RvbWFpbn1cIlxuICBgO1xuICAvLyBhZGQgYWxsIGNhdGVnb3J5IG5vZGVzXG4gIHJlcyArPSBgbm9kZSBbc2hhcGU9cmVjb3JkLCBjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XFxuIGBcbiAgdmFyIGNhdHMgPSBNb2RlbC5nZXRDYXRlZ29yaWVzRm9yRG9tYWluKG0sZG9tYWluKTtcblxuICB2YXIgY2F0ZWdvcnlSZXN1bHRzID0ge307XG4gIHZhciBvdGhlcmRvbWFpbnMgPSBbXTtcbiAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuICAgIHZhciBjYXRSZXN1bHQgPSBjYWxjQ2F0ZWdvcnlSZWNvcmQobSwgY2F0LCBkb21haW4pO1xuICAgIGNhdGVnb3J5UmVzdWx0c1tjYXRdID0gY2F0UmVzdWx0O1xuICAgIG90aGVyZG9tYWlucyA9IF8udW5pb24ob3RoZXJkb21haW5zLCBjYXRlZ29yeVJlc3VsdHNbY2F0XS5vdGhlckRvbWFpbnMpO1xuICAgIHJlcyArPSBgXCIke2NhdH1cIiBbbGFiZWw9XCJ7ICR7Y2F0fSB8ICR7Y2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbn0gVmFsdWVzIGluICR7Y2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWlufSBgO1xuICAgIGlmKGNhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbiAhPT0gY2F0UmVzdWx0Lm5yUmVjb3Jkcykge1xuICAgICAgcmVzICs9ICBgfCAgJHtjYXRSZXN1bHQubnJEaXN0aW5jdFZhbHVlcyAtIGNhdFJlc3VsdC5uckRpc3RpbmN0VmFsdWVzSW5Eb21haW59IG90aGVyIHZhbHVlcyBpbiAke2NhdFJlc3VsdC5uclJlY29yZHMgLSBjYXRSZXN1bHQubnJSZWNvcmRzSW5Eb21haW59IG90aGVyIHJlY29yZHNgO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXMgKz0gYCBgO1xuICAgIH1cbiAgICByZXMgKz0gYH1cIl1cXG5gO1xuICB9KTtcblxuICAvLyBjYWxjdWxhdGUgb3RoZXIgZG9tYWlucy5cbiAgLy8gZHJhdyBcIm90aGVyIGNhdGVnb3JpZXNcIlxuICByZXMgKz0gYG5vZGUgW2NvbG9yPXB1cnBsZSwgc3R5bGU9ZmlsbGVkXTsgXFxuYFxuICBvdGhlcmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbihvdGhlcmRvbWFpbikge1xuICAgIHJlcyArPSBgXCIke290aGVyZG9tYWlufVwiIFxcbmA7XG4gIH0pO1xuICAvLyBjb3VudCByZWNvcmRzIGluIGRvbWFpbiA6XG4gIHZhciBuclJlY29yZHMgPSBtLnJlY29yZHMucmVkdWNlKGZ1bmN0aW9uKHByZXYsZW50cnkpIHtcbiAgcmV0dXJuIHByZXYgKyAoKGVudHJ5Ll9kb21haW4gPT09IGRvbWFpbikgPyAxIDogMCk7XG4gIH0sMCk7XG4gIHJlcyArPSBgbm9kZSBbc2hhcGU9cmVjb3JkXTsgXFxuYFxuICByZXMgKz0gYCBcInJlY29yZFwiIFtsYWJlbD1cIns8ZjA+ICR7ZG9tYWlufSB8ICR7bnJSZWNvcmRzfX1cIl0gXFxuYDtcblxuICByZXMgKz0gYCBcInJfb3RoZXJcIiBbbGFiZWw9XCJ7PGYwPiBvdGhlciB8ICR7bnJSZWNvcmRzfX1cIl0gXFxuIGA7XG5cbiAgcmVzICs9IGAjIHJlbGF0aW9uIGZyb20gY2F0ZWdvcmllcyB0byBkb21haW5cXG5gO1xuICBjYXRzLmZvckVhY2goZnVuY3Rpb24oY2F0KSB7XG4gICAgcmVzICs9IGAgXCIke2NhdH1cIiAtPiBcIiR7ZG9tYWlufVwiIFxcbmA7XG4gIH0pXG5cblxuICByZXMgKz0gYCMgcmVsYXRpb24gZnJvbSBjYXRlZ29yaWVzIHRvIHJlY29yZHNcXG5gO1xuICBjYXRzLmZvckVhY2goZnVuY3Rpb24oY2F0KSB7XG4gICAgdmFyIHJlYyA9IGNhdGVnb3J5UmVzdWx0c1tjYXRdO1xuICAgIHJlcyArPSBgIFwiJHtjYXR9XCIgLT4gXCJyZWNvcmRcIiBcXG5gO1xuICB9KVxuXG5cbiAgLy9vdGhlciBkb21haW5zIHRvIHRoaXNcbiAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuXG5cbiAgfSlcblxuICAvKlxuICBjYXRzIGZvXG4gICAgZGlncmFwaCBzZHN1IHtcblx0c2l6ZT1cIjM2LDM2XCI7XG5cdG5vZGUgW2NvbG9yPXllbGxvdywgc3R5bGU9ZmlsbGVkXTtcblx0RkxQRCBGTFAgXCJCT00gRWRpdG9yXCIsIFwiV0lLSVVSTFwiIFwiVUk1IERvY3VtZW50YXRpb25cIiwgXCJVSTUgRXhhbXBsZVwiLCBcIlNUQVJUVEFcIlxuXHRCQ1Bcblx0bm9kZSBbY29sb3I9Z3JleSwgc3R5bGU9ZmlsbGVkXTtcblx0bm9kZSBbZm9udG5hbWU9XCJWZXJkYW5hXCIsIHNpemU9XCIzMCwzMFwiXTtcblx0bm9kZSBbY29sb3I9Z3JleSwgc3R5bGU9ZmlsbGVkXTtcblx0Z3JhcGggWyBmb250bmFtZSA9IFwiQXJpYWxcIixcbiAgKi9cbiAgcmVzICs9IGB9XFxuYDtcbiAgcmV0dXJuIHJlcztcbn1cbi8qXG4gICAgY2F0ZWdvcnlEZXNjIDogdGhlTW9kZWwuZnVsbC5kb21haW5bZmlsdGVyZG9tYWluXS5jYXRlZ29yaWVzW2NhdGVnb3J5XSxcbiAgICBkaXN0aW5jdCA6IGRpc3RpbmN0LFxuICAgIGRlbHRhIDogZGVsdGEsXG4gICAgcHJlc2VudFJlY29yZHMgOiByZWNvcmRDb3VudC5wcmVzZW50cmVjb3JkcyxcbiAgICBwZXJjUHJlc2VudCA6IHBlcmNlbnQsXG4gICAgc2FtcGxlVmFsdWVzIDogdmFsdWVzTGlzdFxuICB9XG4qL1xuXG5mdW5jdGlvbiByZXBsYWNlQnIoc3RyaW5nIDogc3RyaW5nICkgOiBzdHJpbmcge1xuICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvXFxuL2csXG4gICBgXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRiclxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0fCBgXG4gICApO1xuICAgcmV0dXJuIHN0cmluZztcbn1cblxuXG5cblxuLyoqXG4gKiBnZW5lcmF0ZSBhIHRleHR1YWwgcmVwcmVzZW50YXRpb24gb2YgYSBkb21haW5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRhYkRvbWFpbihkb21haW4gOiBzdHJpbmcsIG0gOiBJTWF0Y2guSU1vZGVscykge1xuICAvLyBkcmF3IGEgbW9kZWwgZG9tYWluc1xuXG4gIHZhciBjYXRzID0gTW9kZWwuZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbihtLGRvbWFpbik7XG4gIGNhdHMgPSBNb2RlbC5zb3J0Q2F0ZWdvcmllc0J5SW1wb3J0YW5jZSggbS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMgfHwge30sIGNhdHMpO1xuICAvL2NvbnNvbGUubG9nKGNhdHMuam9pbihcIlxcblwiKSk7XG4gIHZhciBjYXRkZXNjID0gRGVzY3JpYmUuZ2V0Q2F0ZWdvcnlTdGF0c0luRG9tYWluKGNhdHNbMF0sZG9tYWluLG0pO1xuICB2YXIgY2F0UmVzdWx0ID0gY2FsY0NhdGVnb3J5UmVjb3JkKG0sIGNhdHNbMF0sIGRvbWFpbik7XG5cbiAgdmFyIGRvbWFpbkRlc2NyID0gbS5mdWxsLmRvbWFpbltkb21haW5dLmRlc2NyaXB0aW9uIHx8IFwiXCI7XG4gIGRvbWFpbkRlc2NyID0gcmVwbGFjZUJyKGRvbWFpbkRlc2NyKTtcbiAgdmFyIHJlcyA9IGBcblxuLy8gcHJlc2V0IGZvcm0gdmFsdWVzIGlmIHdlIHJlY2VpdmUgYSB1c2VyZGF0YSBvYmplY3QgLy9cbi0gdXNlciA9IHVzZXJcblxuZXh0ZW5kcyAuLi9sYXlvdXRfcFxuXG5ibG9jayBjb250ZW50XG5cblx0bmF2Lm5hdmJhci5uYXZiYXItZGVmYXVsdC5uYXZiYXItZml4ZWQtdG9wXG5cdFx0LmNvbnRhaW5lclxuXHRcdFx0Lm5hdmJhci1oZWFkZXJcblx0XHRcdFx0Lm5hdmJhci1icmFuZChzdHlsZT0nYmdjb2xvcjpvcmFuZ2U7Y29sb3I6ZGFya2JsdWU7Zm9udC1mYW1pbHk6QXJpYWwgQmxhY2s7Zm9udC1zaXplOjE1LjExOHB4Jykgd29zYXAgZG9tYWluICR7ZG9tYWlufVxuXHRcdFx0dWwubmF2Lm5hdmJhci1uYXYubmF2YmFyLXJpZ2h0ICN7dWlkfVxuXHRcdFx0XHRsaVxuXHRcdFx0XHRcdC5uYXZiYXItYnRuI2J0bi1sb2dvdXQuYnRuLmJ0bi1kZWZhdWx0KG9uY2xpY2s9XCJsb2NhdGlvbi5ocmVmPScvaG9tZSdcIilcblx0XHRcdFx0XHRcdHwgYmFjayB0byBob21lXG5cblx0cCAgJm5ic3A7XG5cdHAgJm5ic3A7XG5cdHBcblxuXHRkaXYud2VsbFxuXHRcdGgzIGRvbWFpbiBcIiR7ZG9tYWlufVwiXG5cdFx0XHRzcGFuLnB1bGwtcmlnaHQgJHtjYXRSZXN1bHQubnJUb3RhbFJlY29yZHNJbkRvbWFpbn0gcmVjb3Jkc1xuXHRcdHBcblx0XHRzcGFuICR7ZG9tYWluRGVzY3J9XG5cblx0XHR0YWJsZS50YWJsZS50YWJsZS1jb25kZW5zZWQudGFibGUtc3RyaXBlZFxuXHRcdFx0dGhlYWRcblx0XHRcdFx0dHJcblx0XHRcdFx0XHR0aCBjYXRlZ29yeVxuXHRcdFx0XHRcdHRoKHN0eWxlPVwid2lkdGg6MTAlXCIpIGNvdW50XG5cdFx0XHRcdFx0dGhcblx0XHRcdFx0XHRcdHRhYmxlXG5cdFx0XHRcdFx0XHRcdHRyXG5cdFx0XHRcdFx0XHRcdFx0dGQgc3lub255bXNcblx0XHRcdFx0XHRcdFx0dHJcblx0XHRcdFx0XHRcdFx0XHR0ZCBkZXNjcmlwdGlvblxuXHRcdFx0XHRcdFx0XHR0clxuXHRcdFx0XHRcdFx0XHRcdHRkIGV4YW1wbGUgdmFsdWVzXG5cdFx0XHR0Ym9keVxuYDtcblxuICB2YXIgY2F0ZWdvcnlSZXN1bHRzID0ge307XG4gIHZhciBvdGhlcmRvbWFpbnMgPSBbXTtcbiAgdmFyIGNhdGVnb3J5TWFwID0gbS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMgfHwge307XG4gIGNhdHMuZm9yRWFjaChmdW5jdGlvbihjYXQpIHtcbiAgICB2YXIgY2F0ZGVzYyA9IERlc2NyaWJlLmdldENhdGVnb3J5U3RhdHNJbkRvbWFpbihjYXQsZG9tYWluLG0pO1xuICAgIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoY2F0ZGVzYykpO1xuICAgIHZhciBjYXRSZXN1bHQgPSBjYWxjQ2F0ZWdvcnlSZWNvcmQobSwgY2F0LCBkb21haW4pO1xuICAgIGNhdGVnb3J5UmVzdWx0c1tjYXRdID0gY2F0UmVzdWx0O1xuICAgIG90aGVyZG9tYWlucyA9IF8udW5pb24ob3RoZXJkb21haW5zLCBjYXRlZ29yeVJlc3VsdHNbY2F0XS5vdGhlckRvbWFpbnMpO1xuLypcbiAgICByZXMgKz0gYFwiJHtjYXR9XCIgW2xhYmVsPVwieyAke2NhdH0gfCAke2NhdFJlc3VsdC5uckRpc3RpbmN0VmFsdWVzSW5Eb21haW59IFZhbHVlcyBpbiAke2NhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbn0gYDtcbiAgICBpZihjYXRSZXN1bHQubnJSZWNvcmRzSW5Eb21haW4gIT09IGNhdFJlc3VsdC5uclJlY29yZHMpIHtcbiAgICAgIHJlcyArPSAgYHwgICR7Y2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXMgLSBjYXRSZXN1bHQubnJEaXN0aW5jdFZhbHVlc0luRG9tYWlufSBvdGhlciB2YWx1ZXMgaW4gJHtjYXRSZXN1bHQubnJSZWNvcmRzIC0gY2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWlufSBvdGhlciByZWNvcmRzYDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzICs9IGAgYDtcbiAgICB9XG4gICAgcmVzICs9IGB9XCJdXFxuYDtcbiovXG4gICAgLy9jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShtLmZ1bGwuZG9tYWluW2RvbWFpbl0pKTtcbiAgICBpZihtLmZ1bGwuZG9tYWluW2RvbWFpbl0uY2F0ZWdvcmllc1tjYXRdKSB7XG5cbiAgICB2YXIgc3lub255bXNTdHJpbmcgPSBVdGlsLmxpc3RUb0NvbW1hQW5kKCBjYXRkZXNjLmNhdGVnb3J5RGVzYyAmJiBjYXRkZXNjLmNhdGVnb3J5RGVzYy5zeW5vbnltcyAmJiBjYXRkZXNjLmNhdGVnb3J5RGVzYy5zeW5vbnltcyB8fCBbXSApIHx8IFwiJm5ic3A7XCI7XG5cbiAgICByZXMgKz0gYFxuXHRcdFx0dHJcblx0XHRcdFx0XHR0ZC5jYXRfY291bnQgJHtjYXR9XG5cXHRcXHRcXHRcXHRcXHR0ZCAke2NhdGRlc2MucHJlc2VudFJlY29yZHN9IGRpc3RpbmN0IHZhbHVlcyBpbiAke2NhdGRlc2MucGVyY1ByZXNlbnR9JSBvZiByZWNvcmRzXG5cXHRcXHRcXHRcXHRcXHR0ZFxuXFx0XFx0XFx0XFx0XFx0XFx0dGFibGVcblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyLmNhdF9zeW5vbnltc1xuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgJHtzeW5vbnltc1N0cmluZ31cblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyLmNhdF9kZXNjcmlwdGlvblxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgJHtyZXBsYWNlQnIoY2F0ZGVzYy5jYXRlZ29yeURlc2MgJiYgY2F0ZGVzYy5jYXRlZ29yeURlc2MuZGVzY3JpcHRpb24gfHwgXCJcIil9XG5cXHRcXHRcXHRcXHRcXHRcXHRcXHR0ci5jYXRfc2FtcGxldmFsdWVzXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHR0ZCAke3JlcGxhY2VCcihjYXRkZXNjLnNhbXBsZVZhbHVlcyl9XG4gICAgICBgO1xuICAgIH1cblxuICB9KTtcblxuICB2YXIgb3RoZXJjYXRzID0gY2F0cy5sZW5ndGggLSBPYmplY3Qua2V5cyhtLmZ1bGwuZG9tYWluW2RvbWFpbl0uY2F0ZWdvcmllcykubGVuZ3RoIDtcbiAgdmFyIHJlbWFpbmluZ0NhdGVnb3JpZXMgPSBfLmRpZmZlcmVuY2UoY2F0cywgT2JqZWN0LmtleXMobS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMpKTtcbiAgaWYgKChvdGhlcmNhdHMpID4gMCkge1xuICAgIHJlcyArPSBgXG5cXHRcXHRwICAgYW5kICR7b3RoZXJjYXRzfSBvdGhlciBjYXRlZ29yaWVzXG5cXHRcXHR8ICR7VXRpbC5saXN0VG9Db21tYUFuZChyZW1haW5pbmdDYXRlZ29yaWVzKX1cbiAgICAgICBgXG5cbiAgfVxuLypcbiAgLy8gY2FsY3VsYXRlIG90aGVyIGRvbWFpbnMuXG4gIC8vIGRyYXcgXCJvdGhlciBjYXRlZ29yaWVzXCJcbiAgcmVzICs9IGBub2RlIFtjb2xvcj1wdXJwbGUsIHN0eWxlPWZpbGxlZF07IFxcbmBcbiAgb3RoZXJkb21haW5zLmZvckVhY2goZnVuY3Rpb24ob3RoZXJkb21haW4pIHtcbiAgICByZXMgKz0gYFwiJHtvdGhlcmRvbWFpbn1cIiBcXG5gO1xuICB9KTtcbiAgLy8gY291bnQgcmVjb3JkcyBpbiBkb21haW4gOlxuICB2YXIgbnJSZWNvcmRzID0gbS5yZWNvcmRzLnJlZHVjZShmdW5jdGlvbihwcmV2LGVudHJ5KSB7XG4gIHJldHVybiBwcmV2ICsgKChlbnRyeS5fZG9tYWluID09PSBkb21haW4pID8gMSA6IDApO1xuICB9LDApO1xuICByZXMgKz0gYG5vZGUgW3NoYXBlPXJlY29yZF07IFxcbmBcbiAgcmVzICs9IGAgXCJyZWNvcmRcIiBbbGFiZWw9XCJ7PGYwPiAke2RvbWFpbn0gfCAke25yUmVjb3Jkc319XCJdIFxcbmA7XG5cbiAgcmVzICs9IGAgXCJyX290aGVyXCIgW2xhYmVsPVwiezxmMD4gb3RoZXIgfCAke25yUmVjb3Jkc319XCJdIFxcbiBgO1xuXG4gIHJlcyArPSBgIyByZWxhdGlvbiBmcm9tIGNhdGVnb3JpZXMgdG8gZG9tYWluXFxuYDtcbiAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuICAgIHJlcyArPSBgIFwiJHtjYXR9XCIgLT4gXCIke2RvbWFpbn1cIiBcXG5gO1xuICB9KVxuXG5cbiAgcmVzICs9IGAjIHJlbGF0aW9uIGZyb20gY2F0ZWdvcmllcyB0byByZWNvcmRzXFxuYDtcbiAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuICAgIHZhciByZWMgPSBjYXRlZ29yeVJlc3VsdHNbY2F0XTtcbiAgICByZXMgKz0gYCBcIiR7Y2F0fVwiIC0+IFwicmVjb3JkXCIgXFxuYDtcbiAgfSlcblxuXG4gIC8vb3RoZXIgZG9tYWlucyB0byB0aGlzXG4gIGNhdHMuZm9yRWFjaChmdW5jdGlvbihjYXQpIHtcblxuXG4gIH0pXG4qL1xuICAvKlxuICBjYXRzIGZvXG4gICAgZGlncmFwaCBzZHN1IHtcblx0c2l6ZT1cIjM2LDM2XCI7XG5cdG5vZGUgW2NvbG9yPXllbGxvdywgc3R5bGU9ZmlsbGVkXTtcblx0RkxQRCBGTFAgXCJCT00gRWRpdG9yXCIsIFwiV0lLSVVSTFwiIFwiVUk1IERvY3VtZW50YXRpb25cIiwgXCJVSTUgRXhhbXBsZVwiLCBcIlNUQVJUVEFcIlxuXHRCQ1Bcblx0bm9kZSBbY29sb3I9Z3JleSwgc3R5bGU9ZmlsbGVkXTtcblx0bm9kZSBbZm9udG5hbWU9XCJWZXJkYW5hXCIsIHNpemU9XCIzMCwzMFwiXTtcblx0bm9kZSBbY29sb3I9Z3JleSwgc3R5bGU9ZmlsbGVkXTtcblx0Z3JhcGggWyBmb250bmFtZSA9IFwiQXJpYWxcIixcbiAgKi9cbiAgcmVzICs9IGBcblx0XHRoMyBWZXJzaW9uXG5cdFx0XHRhLnNtYWxsKGhyZWY9XCIvd2hhdHNuZXdcIilcblxuXG5ibG9jayBzY3JpcHRzXG5cdHNjcmlwdChzcmM9Jy92ZW5kb3IvanF1ZXJ5LTIuMi4zLm1pbi5qcycpXG5cdHNjcmlwdChzcmM9Jy92ZW5kb3IvYm9vdHN0cmFwLm1pbi5qcycpXG5cdHNjcmlwdChzcmM9Jy9qcy92aWV3cy9zZXR0aW5ncy5qcycpXG5gO1xuICByZXR1cm4gcmVzO1xufVxuXG5cblxuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuXG5cbmZ1bmN0aW9uIGV4ZWNDbWQoY21kIDogc3RyaW5nKSB7XG4gZXhlYyhjbWQsIGZ1bmN0aW9uIChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYGV4ZWMgZXJyb3I6ICR7ZXJyb3J9YClcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zb2xlLmxvZyhgc3Rkb3V0OiAke3N0ZG91dH1gKVxuICAgIGNvbnNvbGUubG9nKGBzdGRlcnI6ICR7c3RkZXJyfWApXG4gIH0pXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gdmlzTW9kZWxzKG0gOiBJTWF0Y2guSU1vZGVscywgZm9sZGVyT3V0IDogc3RyaW5nICkge1xuICBtLmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbihzRG9tYWluKSB7XG4gICAgdmFyIHMgPSBncmFwaERvbWFpbihzRG9tYWluLG0pO1xuICAgIHZhciBmbkdyYXBoID0gZm9sZGVyT3V0ICsgXCIvXCIgKyBzRG9tYWluLnJlcGxhY2UoLyAvZywnXycpICsgXCIuZ3ZcIjtcbiAgICBmcy53cml0ZUZpbGVTeW5jKGZuR3JhcGgsIHMpO1xuICAgIGlmKHByb2Nlc3MuZW52LkdSQVBIVklaKSB7XG4gICAgICBjb25zb2xlLmxvZyhcImhlcmUgdGhlIGZpbGUgXCIgKyBmbkdyYXBoKTtcbiAgICAgIGV4ZWNDbWQocHJvY2Vzcy5lbnYuR1JBUEhWSVogKyBcIiAtVGpwZWcgLU8gXCIgKyBmbkdyYXBoKTtcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdGFiTW9kZWxzKG0gOiBJTWF0Y2guSU1vZGVscywgZm9sZGVyT3V0IDogc3RyaW5nICkge1xuICBtLmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbihzRG9tYWluKSB7XG4gICAgdmFyIHMgPSB0YWJEb21haW4oc0RvbWFpbixtKTtcbiAgICB2YXIgZm5HcmFwaCA9IGZvbGRlck91dCArIFwiL1wiICsgc0RvbWFpbi5yZXBsYWNlKC8gL2csJ18nKSArIFwiLmphZGVcIjtcbiAgICBkZWJ1Z2xvZyhcImhlcmUgdGhlIGZpbGUgXCIgKyBmbkdyYXBoKTtcbiAgICBmcy53cml0ZUZpbGVTeW5jKGZuR3JhcGgsIHMpO1xuICB9KTtcbn1cbiIsIi8qKlxuICogdmlzdWFsaXplIGEgbW9kZWwgYW5kIGNhbGN1bGF0ZSBzb21lIHN0YXRpc3RpY3NcbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgZnMgPSByZXF1aXJlKFwiZnNcIik7XG52YXIgTW9kZWwgPSByZXF1aXJlKFwiLi9tb2RlbFwiKTtcbnZhciBVdGlsID0gcmVxdWlyZShcIi4uL3V0aWxzL3V0aWxzXCIpO1xudmFyIERlc2NyaWJlID0gcmVxdWlyZShcIi4uL21hdGNoL2Rlc2NyaWJlXCIpO1xudmFyIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ3Zpc21vZGVsLnRzJyk7XG47XG5mdW5jdGlvbiBjYWxjQ2F0ZWdvcnlSZWNvcmQobSwgY2F0ZWdvcnksIGRvbWFpbikge1xuICAgIHZhciBvdGhlcmRvbWFpbnMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkobSwgY2F0ZWdvcnkpO1xuICAgIF8ucHVsbChvdGhlcmRvbWFpbnMsIGRvbWFpbik7XG4gICAgdmFyIHJlcyA9IHtcbiAgICAgICAgb3RoZXJkb21haW5zOiBvdGhlcmRvbWFpbnMsXG4gICAgICAgIG5yRGlzdGluY3RWYWx1ZXM6IDAsXG4gICAgICAgIG5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbjogMCxcbiAgICAgICAgbnJSZWNvcmRzOiAwLFxuICAgICAgICBuclJlY29yZHNJbkRvbWFpbjogMCxcbiAgICAgICAgbnJUb3RhbFJlY29yZHNJbkRvbWFpbjogMCxcbiAgICB9O1xuICAgIHZhciB2YWx1ZXMgPSBbXTtcbiAgICB2YXIgdmFsdWVzSW5Eb21haW4gPSBbXTtcbiAgICB2YXIgbnJSZWNvcmRzSW5Eb21haW4gPSAwO1xuICAgIHZhciBkaXN0aW5jdFZhbHVlcyA9IG0ucmVjb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uIChvRW50cnkpIHtcbiAgICAgICAgaWYgKG9FbnRyeS5fZG9tYWluID09PSBkb21haW4pIHtcbiAgICAgICAgICAgIHJlcy5uclRvdGFsUmVjb3Jkc0luRG9tYWluICs9IDE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9FbnRyeVtjYXRlZ29yeV0pIHtcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IG9FbnRyeVtjYXRlZ29yeV07XG4gICAgICAgICAgICBpZiAob0VudHJ5Ll9kb21haW4gPT09IGRvbWFpbikge1xuICAgICAgICAgICAgICAgIHZhbHVlc0luRG9tYWluW3ZhbHVlXSA9ICh2YWx1ZXNJbkRvbWFpblt2YWx1ZV0gfHwgMCkgKyAxO1xuICAgICAgICAgICAgICAgIHJlcy5uclJlY29yZHNJbkRvbWFpbiArPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFsdWVzW3ZhbHVlXSA9ICh2YWx1ZXNbdmFsdWVdIHx8IDApICsgMTtcbiAgICAgICAgICAgIHJlcy5uclJlY29yZHMgKz0gMTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJlcy5uckRpc3RpbmN0VmFsdWVzID0gT2JqZWN0LmtleXModmFsdWVzKS5sZW5ndGg7XG4gICAgcmVzLm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbiA9IE9iamVjdC5rZXlzKHZhbHVlc0luRG9tYWluKS5sZW5ndGg7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuY2FsY0NhdGVnb3J5UmVjb3JkID0gY2FsY0NhdGVnb3J5UmVjb3JkO1xuZnVuY3Rpb24gZ3JhcGhEb21haW4oZG9tYWluLCBtKSB7XG4gICAgLy8gZHJhdyBhIG1vZGVsIGRvbWFpbnNcbiAgICB2YXIgcmVzID0gXCJcXG4gICAgZGlncmFwaCBzZHN1IHtcXG5cXHRzaXplPVxcXCIzNiwzNlxcXCI7XFxuICAgcmFua2Rpcj1MUlxcblxcdG5vZGUgW2NvbG9yPXllbGxvdywgc3R5bGU9ZmlsbGVkXTtcXG4gICAgXFxcIlwiICsgZG9tYWluICsgXCJcXFwiXFxuICBcIjtcbiAgICAvLyBhZGQgYWxsIGNhdGVnb3J5IG5vZGVzXG4gICAgcmVzICs9IFwibm9kZSBbc2hhcGU9cmVjb3JkLCBjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XFxuIFwiO1xuICAgIHZhciBjYXRzID0gTW9kZWwuZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbihtLCBkb21haW4pO1xuICAgIHZhciBjYXRlZ29yeVJlc3VsdHMgPSB7fTtcbiAgICB2YXIgb3RoZXJkb21haW5zID0gW107XG4gICAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uIChjYXQpIHtcbiAgICAgICAgdmFyIGNhdFJlc3VsdCA9IGNhbGNDYXRlZ29yeVJlY29yZChtLCBjYXQsIGRvbWFpbik7XG4gICAgICAgIGNhdGVnb3J5UmVzdWx0c1tjYXRdID0gY2F0UmVzdWx0O1xuICAgICAgICBvdGhlcmRvbWFpbnMgPSBfLnVuaW9uKG90aGVyZG9tYWlucywgY2F0ZWdvcnlSZXN1bHRzW2NhdF0ub3RoZXJEb21haW5zKTtcbiAgICAgICAgcmVzICs9IFwiXFxcIlwiICsgY2F0ICsgXCJcXFwiIFtsYWJlbD1cXFwieyBcIiArIGNhdCArIFwiIHwgXCIgKyBjYXRSZXN1bHQubnJEaXN0aW5jdFZhbHVlc0luRG9tYWluICsgXCIgVmFsdWVzIGluIFwiICsgY2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWluICsgXCIgXCI7XG4gICAgICAgIGlmIChjYXRSZXN1bHQubnJSZWNvcmRzSW5Eb21haW4gIT09IGNhdFJlc3VsdC5uclJlY29yZHMpIHtcbiAgICAgICAgICAgIHJlcyArPSBcInwgIFwiICsgKGNhdFJlc3VsdC5uckRpc3RpbmN0VmFsdWVzIC0gY2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbikgKyBcIiBvdGhlciB2YWx1ZXMgaW4gXCIgKyAoY2F0UmVzdWx0Lm5yUmVjb3JkcyAtIGNhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbikgKyBcIiBvdGhlciByZWNvcmRzXCI7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXMgKz0gXCIgXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmVzICs9IFwifVxcXCJdXFxuXCI7XG4gICAgfSk7XG4gICAgLy8gY2FsY3VsYXRlIG90aGVyIGRvbWFpbnMuXG4gICAgLy8gZHJhdyBcIm90aGVyIGNhdGVnb3JpZXNcIlxuICAgIHJlcyArPSBcIm5vZGUgW2NvbG9yPXB1cnBsZSwgc3R5bGU9ZmlsbGVkXTsgXFxuXCI7XG4gICAgb3RoZXJkb21haW5zLmZvckVhY2goZnVuY3Rpb24gKG90aGVyZG9tYWluKSB7XG4gICAgICAgIHJlcyArPSBcIlxcXCJcIiArIG90aGVyZG9tYWluICsgXCJcXFwiIFxcblwiO1xuICAgIH0pO1xuICAgIC8vIGNvdW50IHJlY29yZHMgaW4gZG9tYWluIDpcbiAgICB2YXIgbnJSZWNvcmRzID0gbS5yZWNvcmRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgZW50cnkpIHtcbiAgICAgICAgcmV0dXJuIHByZXYgKyAoKGVudHJ5Ll9kb21haW4gPT09IGRvbWFpbikgPyAxIDogMCk7XG4gICAgfSwgMCk7XG4gICAgcmVzICs9IFwibm9kZSBbc2hhcGU9cmVjb3JkXTsgXFxuXCI7XG4gICAgcmVzICs9IFwiIFxcXCJyZWNvcmRcXFwiIFtsYWJlbD1cXFwiezxmMD4gXCIgKyBkb21haW4gKyBcIiB8IFwiICsgbnJSZWNvcmRzICsgXCJ9XFxcIl0gXFxuXCI7XG4gICAgcmVzICs9IFwiIFxcXCJyX290aGVyXFxcIiBbbGFiZWw9XFxcIns8ZjA+IG90aGVyIHwgXCIgKyBuclJlY29yZHMgKyBcIn1cXFwiXSBcXG4gXCI7XG4gICAgcmVzICs9IFwiIyByZWxhdGlvbiBmcm9tIGNhdGVnb3JpZXMgdG8gZG9tYWluXFxuXCI7XG4gICAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uIChjYXQpIHtcbiAgICAgICAgcmVzICs9IFwiIFxcXCJcIiArIGNhdCArIFwiXFxcIiAtPiBcXFwiXCIgKyBkb21haW4gKyBcIlxcXCIgXFxuXCI7XG4gICAgfSk7XG4gICAgcmVzICs9IFwiIyByZWxhdGlvbiBmcm9tIGNhdGVnb3JpZXMgdG8gcmVjb3Jkc1xcblwiO1xuICAgIGNhdHMuZm9yRWFjaChmdW5jdGlvbiAoY2F0KSB7XG4gICAgICAgIHZhciByZWMgPSBjYXRlZ29yeVJlc3VsdHNbY2F0XTtcbiAgICAgICAgcmVzICs9IFwiIFxcXCJcIiArIGNhdCArIFwiXFxcIiAtPiBcXFwicmVjb3JkXFxcIiBcXG5cIjtcbiAgICB9KTtcbiAgICAvL290aGVyIGRvbWFpbnMgdG8gdGhpc1xuICAgIGNhdHMuZm9yRWFjaChmdW5jdGlvbiAoY2F0KSB7XG4gICAgfSk7XG4gICAgLypcbiAgICBjYXRzIGZvXG4gICAgICBkaWdyYXBoIHNkc3Uge1xuICAgICAgc2l6ZT1cIjM2LDM2XCI7XG4gICAgICBub2RlIFtjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XG4gICAgICBGTFBEIEZMUCBcIkJPTSBFZGl0b3JcIiwgXCJXSUtJVVJMXCIgXCJVSTUgRG9jdW1lbnRhdGlvblwiLCBcIlVJNSBFeGFtcGxlXCIsIFwiU1RBUlRUQVwiXG4gICAgICBCQ1BcbiAgICAgIG5vZGUgW2NvbG9yPWdyZXksIHN0eWxlPWZpbGxlZF07XG4gICAgICBub2RlIFtmb250bmFtZT1cIlZlcmRhbmFcIiwgc2l6ZT1cIjMwLDMwXCJdO1xuICAgICAgbm9kZSBbY29sb3I9Z3JleSwgc3R5bGU9ZmlsbGVkXTtcbiAgICAgIGdyYXBoIFsgZm9udG5hbWUgPSBcIkFyaWFsXCIsXG4gICAgKi9cbiAgICByZXMgKz0gXCJ9XFxuXCI7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuZ3JhcGhEb21haW4gPSBncmFwaERvbWFpbjtcbi8qXG4gICAgY2F0ZWdvcnlEZXNjIDogdGhlTW9kZWwuZnVsbC5kb21haW5bZmlsdGVyZG9tYWluXS5jYXRlZ29yaWVzW2NhdGVnb3J5XSxcbiAgICBkaXN0aW5jdCA6IGRpc3RpbmN0LFxuICAgIGRlbHRhIDogZGVsdGEsXG4gICAgcHJlc2VudFJlY29yZHMgOiByZWNvcmRDb3VudC5wcmVzZW50cmVjb3JkcyxcbiAgICBwZXJjUHJlc2VudCA6IHBlcmNlbnQsXG4gICAgc2FtcGxlVmFsdWVzIDogdmFsdWVzTGlzdFxuICB9XG4qL1xuZnVuY3Rpb24gcmVwbGFjZUJyKHN0cmluZykge1xuICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXG4vZywgXCJcXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRiclxcblxcdFxcdFxcdFxcdFxcdFxcdFxcdFxcdFxcdFxcdFxcdHwgXCIpO1xuICAgIHJldHVybiBzdHJpbmc7XG59XG4vKipcbiAqIGdlbmVyYXRlIGEgdGV4dHVhbCByZXByZXNlbnRhdGlvbiBvZiBhIGRvbWFpblxuICovXG5mdW5jdGlvbiB0YWJEb21haW4oZG9tYWluLCBtKSB7XG4gICAgLy8gZHJhdyBhIG1vZGVsIGRvbWFpbnNcbiAgICB2YXIgY2F0cyA9IE1vZGVsLmdldENhdGVnb3JpZXNGb3JEb21haW4obSwgZG9tYWluKTtcbiAgICBjYXRzID0gTW9kZWwuc29ydENhdGVnb3JpZXNCeUltcG9ydGFuY2UobS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMgfHwge30sIGNhdHMpO1xuICAgIC8vY29uc29sZS5sb2coY2F0cy5qb2luKFwiXFxuXCIpKTtcbiAgICB2YXIgY2F0ZGVzYyA9IERlc2NyaWJlLmdldENhdGVnb3J5U3RhdHNJbkRvbWFpbihjYXRzWzBdLCBkb21haW4sIG0pO1xuICAgIHZhciBjYXRSZXN1bHQgPSBjYWxjQ2F0ZWdvcnlSZWNvcmQobSwgY2F0c1swXSwgZG9tYWluKTtcbiAgICB2YXIgZG9tYWluRGVzY3IgPSBtLmZ1bGwuZG9tYWluW2RvbWFpbl0uZGVzY3JpcHRpb24gfHwgXCJcIjtcbiAgICBkb21haW5EZXNjciA9IHJlcGxhY2VCcihkb21haW5EZXNjcik7XG4gICAgdmFyIHJlcyA9IFwiXFxuXFxuLy8gcHJlc2V0IGZvcm0gdmFsdWVzIGlmIHdlIHJlY2VpdmUgYSB1c2VyZGF0YSBvYmplY3QgLy9cXG4tIHVzZXIgPSB1c2VyXFxuXFxuZXh0ZW5kcyAuLi9sYXlvdXRfcFxcblxcbmJsb2NrIGNvbnRlbnRcXG5cXG5cXHRuYXYubmF2YmFyLm5hdmJhci1kZWZhdWx0Lm5hdmJhci1maXhlZC10b3BcXG5cXHRcXHQuY29udGFpbmVyXFxuXFx0XFx0XFx0Lm5hdmJhci1oZWFkZXJcXG5cXHRcXHRcXHRcXHQubmF2YmFyLWJyYW5kKHN0eWxlPSdiZ2NvbG9yOm9yYW5nZTtjb2xvcjpkYXJrYmx1ZTtmb250LWZhbWlseTpBcmlhbCBCbGFjaztmb250LXNpemU6MTUuMTE4cHgnKSB3b3NhcCBkb21haW4gXCIgKyBkb21haW4gKyBcIlxcblxcdFxcdFxcdHVsLm5hdi5uYXZiYXItbmF2Lm5hdmJhci1yaWdodCAje3VpZH1cXG5cXHRcXHRcXHRcXHRsaVxcblxcdFxcdFxcdFxcdFxcdC5uYXZiYXItYnRuI2J0bi1sb2dvdXQuYnRuLmJ0bi1kZWZhdWx0KG9uY2xpY2s9XFxcImxvY2F0aW9uLmhyZWY9Jy9ob21lJ1xcXCIpXFxuXFx0XFx0XFx0XFx0XFx0XFx0fCBiYWNrIHRvIGhvbWVcXG5cXG5cXHRwICAmbmJzcDtcXG5cXHRwICZuYnNwO1xcblxcdHBcXG5cXG5cXHRkaXYud2VsbFxcblxcdFxcdGgzIGRvbWFpbiBcXFwiXCIgKyBkb21haW4gKyBcIlxcXCJcXG5cXHRcXHRcXHRzcGFuLnB1bGwtcmlnaHQgXCIgKyBjYXRSZXN1bHQubnJUb3RhbFJlY29yZHNJbkRvbWFpbiArIFwiIHJlY29yZHNcXG5cXHRcXHRwXFxuXFx0XFx0c3BhbiBcIiArIGRvbWFpbkRlc2NyICsgXCJcXG5cXG5cXHRcXHR0YWJsZS50YWJsZS50YWJsZS1jb25kZW5zZWQudGFibGUtc3RyaXBlZFxcblxcdFxcdFxcdHRoZWFkXFxuXFx0XFx0XFx0XFx0dHJcXG5cXHRcXHRcXHRcXHRcXHR0aCBjYXRlZ29yeVxcblxcdFxcdFxcdFxcdFxcdHRoKHN0eWxlPVxcXCJ3aWR0aDoxMCVcXFwiKSBjb3VudFxcblxcdFxcdFxcdFxcdFxcdHRoXFxuXFx0XFx0XFx0XFx0XFx0XFx0dGFibGVcXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHR0clxcblxcdFxcdFxcdFxcdFxcdFxcdFxcdFxcdHRkIHN5bm9ueW1zXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0dHJcXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHR0ZCBkZXNjcmlwdGlvblxcblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgZXhhbXBsZSB2YWx1ZXNcXG5cXHRcXHRcXHR0Ym9keVxcblwiO1xuICAgIHZhciBjYXRlZ29yeVJlc3VsdHMgPSB7fTtcbiAgICB2YXIgb3RoZXJkb21haW5zID0gW107XG4gICAgdmFyIGNhdGVnb3J5TWFwID0gbS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMgfHwge307XG4gICAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uIChjYXQpIHtcbiAgICAgICAgdmFyIGNhdGRlc2MgPSBEZXNjcmliZS5nZXRDYXRlZ29yeVN0YXRzSW5Eb21haW4oY2F0LCBkb21haW4sIG0pO1xuICAgICAgICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGNhdGRlc2MpKTtcbiAgICAgICAgdmFyIGNhdFJlc3VsdCA9IGNhbGNDYXRlZ29yeVJlY29yZChtLCBjYXQsIGRvbWFpbik7XG4gICAgICAgIGNhdGVnb3J5UmVzdWx0c1tjYXRdID0gY2F0UmVzdWx0O1xuICAgICAgICBvdGhlcmRvbWFpbnMgPSBfLnVuaW9uKG90aGVyZG9tYWlucywgY2F0ZWdvcnlSZXN1bHRzW2NhdF0ub3RoZXJEb21haW5zKTtcbiAgICAgICAgLypcbiAgICAgICAgICAgIHJlcyArPSBgXCIke2NhdH1cIiBbbGFiZWw9XCJ7ICR7Y2F0fSB8ICR7Y2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbn0gVmFsdWVzIGluICR7Y2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWlufSBgO1xuICAgICAgICAgICAgaWYoY2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWluICE9PSBjYXRSZXN1bHQubnJSZWNvcmRzKSB7XG4gICAgICAgICAgICAgIHJlcyArPSAgYHwgICR7Y2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXMgLSBjYXRSZXN1bHQubnJEaXN0aW5jdFZhbHVlc0luRG9tYWlufSBvdGhlciB2YWx1ZXMgaW4gJHtjYXRSZXN1bHQubnJSZWNvcmRzIC0gY2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWlufSBvdGhlciByZWNvcmRzYDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlcyArPSBgIGA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXMgKz0gYH1cIl1cXG5gO1xuICAgICAgICAqL1xuICAgICAgICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG0uZnVsbC5kb21haW5bZG9tYWluXSkpO1xuICAgICAgICBpZiAobS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXNbY2F0XSkge1xuICAgICAgICAgICAgdmFyIHN5bm9ueW1zU3RyaW5nID0gVXRpbC5saXN0VG9Db21tYUFuZChjYXRkZXNjLmNhdGVnb3J5RGVzYyAmJiBjYXRkZXNjLmNhdGVnb3J5RGVzYy5zeW5vbnltcyAmJiBjYXRkZXNjLmNhdGVnb3J5RGVzYy5zeW5vbnltcyB8fCBbXSkgfHwgXCImbmJzcDtcIjtcbiAgICAgICAgICAgIHJlcyArPSBcIlxcblxcdFxcdFxcdHRyXFxuXFx0XFx0XFx0XFx0XFx0dGQuY2F0X2NvdW50IFwiICsgY2F0ICsgXCJcXG5cXHRcXHRcXHRcXHRcXHR0ZCBcIiArIGNhdGRlc2MucHJlc2VudFJlY29yZHMgKyBcIiBkaXN0aW5jdCB2YWx1ZXMgaW4gXCIgKyBjYXRkZXNjLnBlcmNQcmVzZW50ICsgXCIlIG9mIHJlY29yZHNcXG5cXHRcXHRcXHRcXHRcXHR0ZFxcblxcdFxcdFxcdFxcdFxcdFxcdHRhYmxlXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0dHIuY2F0X3N5bm9ueW1zXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgXCIgKyBzeW5vbnltc1N0cmluZyArIFwiXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0dHIuY2F0X2Rlc2NyaXB0aW9uXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgXCIgKyByZXBsYWNlQnIoY2F0ZGVzYy5jYXRlZ29yeURlc2MgJiYgY2F0ZGVzYy5jYXRlZ29yeURlc2MuZGVzY3JpcHRpb24gfHwgXCJcIikgKyBcIlxcblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyLmNhdF9zYW1wbGV2YWx1ZXNcXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHR0ZCBcIiArIHJlcGxhY2VCcihjYXRkZXNjLnNhbXBsZVZhbHVlcykgKyBcIlxcbiAgICAgIFwiO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgdmFyIG90aGVyY2F0cyA9IGNhdHMubGVuZ3RoIC0gT2JqZWN0LmtleXMobS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMpLmxlbmd0aDtcbiAgICB2YXIgcmVtYWluaW5nQ2F0ZWdvcmllcyA9IF8uZGlmZmVyZW5jZShjYXRzLCBPYmplY3Qua2V5cyhtLmZ1bGwuZG9tYWluW2RvbWFpbl0uY2F0ZWdvcmllcykpO1xuICAgIGlmICgob3RoZXJjYXRzKSA+IDApIHtcbiAgICAgICAgcmVzICs9IFwiXFxuXFx0XFx0cCAgIGFuZCBcIiArIG90aGVyY2F0cyArIFwiIG90aGVyIGNhdGVnb3JpZXNcXG5cXHRcXHR8IFwiICsgVXRpbC5saXN0VG9Db21tYUFuZChyZW1haW5pbmdDYXRlZ29yaWVzKSArIFwiXFxuICAgICAgIFwiO1xuICAgIH1cbiAgICAvKlxuICAgICAgLy8gY2FsY3VsYXRlIG90aGVyIGRvbWFpbnMuXG4gICAgICAvLyBkcmF3IFwib3RoZXIgY2F0ZWdvcmllc1wiXG4gICAgICByZXMgKz0gYG5vZGUgW2NvbG9yPXB1cnBsZSwgc3R5bGU9ZmlsbGVkXTsgXFxuYFxuICAgICAgb3RoZXJkb21haW5zLmZvckVhY2goZnVuY3Rpb24ob3RoZXJkb21haW4pIHtcbiAgICAgICAgcmVzICs9IGBcIiR7b3RoZXJkb21haW59XCIgXFxuYDtcbiAgICAgIH0pO1xuICAgICAgLy8gY291bnQgcmVjb3JkcyBpbiBkb21haW4gOlxuICAgICAgdmFyIG5yUmVjb3JkcyA9IG0ucmVjb3Jkcy5yZWR1Y2UoZnVuY3Rpb24ocHJldixlbnRyeSkge1xuICAgICAgcmV0dXJuIHByZXYgKyAoKGVudHJ5Ll9kb21haW4gPT09IGRvbWFpbikgPyAxIDogMCk7XG4gICAgICB9LDApO1xuICAgICAgcmVzICs9IGBub2RlIFtzaGFwZT1yZWNvcmRdOyBcXG5gXG4gICAgICByZXMgKz0gYCBcInJlY29yZFwiIFtsYWJlbD1cIns8ZjA+ICR7ZG9tYWlufSB8ICR7bnJSZWNvcmRzfX1cIl0gXFxuYDtcbiAgICBcbiAgICAgIHJlcyArPSBgIFwicl9vdGhlclwiIFtsYWJlbD1cIns8ZjA+IG90aGVyIHwgJHtuclJlY29yZHN9fVwiXSBcXG4gYDtcbiAgICBcbiAgICAgIHJlcyArPSBgIyByZWxhdGlvbiBmcm9tIGNhdGVnb3JpZXMgdG8gZG9tYWluXFxuYDtcbiAgICAgIGNhdHMuZm9yRWFjaChmdW5jdGlvbihjYXQpIHtcbiAgICAgICAgcmVzICs9IGAgXCIke2NhdH1cIiAtPiBcIiR7ZG9tYWlufVwiIFxcbmA7XG4gICAgICB9KVxuICAgIFxuICAgIFxuICAgICAgcmVzICs9IGAjIHJlbGF0aW9uIGZyb20gY2F0ZWdvcmllcyB0byByZWNvcmRzXFxuYDtcbiAgICAgIGNhdHMuZm9yRWFjaChmdW5jdGlvbihjYXQpIHtcbiAgICAgICAgdmFyIHJlYyA9IGNhdGVnb3J5UmVzdWx0c1tjYXRdO1xuICAgICAgICByZXMgKz0gYCBcIiR7Y2F0fVwiIC0+IFwicmVjb3JkXCIgXFxuYDtcbiAgICAgIH0pXG4gICAgXG4gICAgXG4gICAgICAvL290aGVyIGRvbWFpbnMgdG8gdGhpc1xuICAgICAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuICAgIFxuICAgIFxuICAgICAgfSlcbiAgICAqL1xuICAgIC8qXG4gICAgY2F0cyBmb1xuICAgICAgZGlncmFwaCBzZHN1IHtcbiAgICAgIHNpemU9XCIzNiwzNlwiO1xuICAgICAgbm9kZSBbY29sb3I9eWVsbG93LCBzdHlsZT1maWxsZWRdO1xuICAgICAgRkxQRCBGTFAgXCJCT00gRWRpdG9yXCIsIFwiV0lLSVVSTFwiIFwiVUk1IERvY3VtZW50YXRpb25cIiwgXCJVSTUgRXhhbXBsZVwiLCBcIlNUQVJUVEFcIlxuICAgICAgQkNQXG4gICAgICBub2RlIFtjb2xvcj1ncmV5LCBzdHlsZT1maWxsZWRdO1xuICAgICAgbm9kZSBbZm9udG5hbWU9XCJWZXJkYW5hXCIsIHNpemU9XCIzMCwzMFwiXTtcbiAgICAgIG5vZGUgW2NvbG9yPWdyZXksIHN0eWxlPWZpbGxlZF07XG4gICAgICBncmFwaCBbIGZvbnRuYW1lID0gXCJBcmlhbFwiLFxuICAgICovXG4gICAgcmVzICs9IFwiXFxuXFx0XFx0aDMgVmVyc2lvblxcblxcdFxcdFxcdGEuc21hbGwoaHJlZj1cXFwiL3doYXRzbmV3XFxcIilcXG5cXG5cXG5ibG9jayBzY3JpcHRzXFxuXFx0c2NyaXB0KHNyYz0nL3ZlbmRvci9qcXVlcnktMi4yLjMubWluLmpzJylcXG5cXHRzY3JpcHQoc3JjPScvdmVuZG9yL2Jvb3RzdHJhcC5taW4uanMnKVxcblxcdHNjcmlwdChzcmM9Jy9qcy92aWV3cy9zZXR0aW5ncy5qcycpXFxuXCI7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMudGFiRG9tYWluID0gdGFiRG9tYWluO1xudmFyIGNoaWxkX3Byb2Nlc3NfMSA9IHJlcXVpcmUoXCJjaGlsZF9wcm9jZXNzXCIpO1xuZnVuY3Rpb24gZXhlY0NtZChjbWQpIHtcbiAgICBjaGlsZF9wcm9jZXNzXzEuZXhlYyhjbWQsIGZ1bmN0aW9uIChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiZXhlYyBlcnJvcjogXCIgKyBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJzdGRvdXQ6IFwiICsgc3Rkb3V0KTtcbiAgICAgICAgY29uc29sZS5sb2coXCJzdGRlcnI6IFwiICsgc3RkZXJyKTtcbiAgICB9KTtcbn1cbjtcbmZ1bmN0aW9uIHZpc01vZGVscyhtLCBmb2xkZXJPdXQpIHtcbiAgICBtLmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoc0RvbWFpbikge1xuICAgICAgICB2YXIgcyA9IGdyYXBoRG9tYWluKHNEb21haW4sIG0pO1xuICAgICAgICB2YXIgZm5HcmFwaCA9IGZvbGRlck91dCArIFwiL1wiICsgc0RvbWFpbi5yZXBsYWNlKC8gL2csICdfJykgKyBcIi5ndlwiO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZuR3JhcGgsIHMpO1xuICAgICAgICBpZiAocHJvY2Vzcy5lbnYuR1JBUEhWSVopIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgZmlsZSBcIiArIGZuR3JhcGgpO1xuICAgICAgICAgICAgZXhlY0NtZChwcm9jZXNzLmVudi5HUkFQSFZJWiArIFwiIC1UanBlZyAtTyBcIiArIGZuR3JhcGgpO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5leHBvcnRzLnZpc01vZGVscyA9IHZpc01vZGVscztcbmZ1bmN0aW9uIHRhYk1vZGVscyhtLCBmb2xkZXJPdXQpIHtcbiAgICBtLmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoc0RvbWFpbikge1xuICAgICAgICB2YXIgcyA9IHRhYkRvbWFpbihzRG9tYWluLCBtKTtcbiAgICAgICAgdmFyIGZuR3JhcGggPSBmb2xkZXJPdXQgKyBcIi9cIiArIHNEb21haW4ucmVwbGFjZSgvIC9nLCAnXycpICsgXCIuamFkZVwiO1xuICAgICAgICBkZWJ1Z2xvZyhcImhlcmUgdGhlIGZpbGUgXCIgKyBmbkdyYXBoKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmbkdyYXBoLCBzKTtcbiAgICB9KTtcbn1cbmV4cG9ydHMudGFiTW9kZWxzID0gdGFiTW9kZWxzO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
