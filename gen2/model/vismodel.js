/**
 * visualize a model and calculate some statistics
 */
"use strict";

var fs = require('fs');
var Model = require('./model');
var Util = require('../utils/utils');
var Describe = require('../match/describe');
var _ = require('lodash');
var debug = require('debug');
var debuglog = debug('vismodel.ts');
;
function calcCategoryRecord(m, category, domain) {
    var otherdomains = Model.getDomainsForCategory(m, category);
    _.pull(otherdomains, domain);
    var res = {
        otherdomains: otherdomains,
        nrDistinctValues: 0,
        nrDistinctValuesInDomain: 0,
        nrRecords: 0,
        nrRecordsInDomain: 0,
        nrTotalRecordsInDomain: 0
    };
    var values = [];
    var valuesInDomain = [];
    var nrRecordsInDomain = 0;
    var distinctValues = m.records.forEach(function (oEntry) {
        if (oEntry._domain === domain) {
            res.nrTotalRecordsInDomain += 1;
        }
        if (oEntry[category]) {
            var value = oEntry[category];
            if (oEntry._domain === domain) {
                valuesInDomain[value] = (valuesInDomain[value] || 0) + 1;
                res.nrRecordsInDomain += 1;
            }
            values[value] = (values[value] || 0) + 1;
            res.nrRecords += 1;
        }
    });
    res.nrDistinctValues = Object.keys(values).length;
    res.nrDistinctValuesInDomain = Object.keys(valuesInDomain).length;
    return res;
}
exports.calcCategoryRecord = calcCategoryRecord;
function graphDomain(domain, m) {
    // draw a model domains
    var res = "\n    digraph sdsu {\n\tsize=\"36,36\";\n   rankdir=LR\n\tnode [color=yellow, style=filled];\n    \"" + domain + "\"\n  ";
    // add all category nodes
    res += "node [shape=record, color=yellow, style=filled];\n ";
    var cats = Model.getCategoriesForDomain(m, domain);
    var categoryResults = {};
    var otherdomains = [];
    cats.forEach(function (cat) {
        var catResult = calcCategoryRecord(m, cat, domain);
        categoryResults[cat] = catResult;
        otherdomains = _.union(otherdomains, categoryResults[cat].otherDomains);
        res += "\"" + cat + "\" [label=\"{ " + cat + " | " + catResult.nrDistinctValuesInDomain + " Values in " + catResult.nrRecordsInDomain + " ";
        if (catResult.nrRecordsInDomain !== catResult.nrRecords) {
            res += "|  " + (catResult.nrDistinctValues - catResult.nrDistinctValuesInDomain) + " other values in " + (catResult.nrRecords - catResult.nrRecordsInDomain) + " other records";
        } else {
            res += " ";
        }
        res += "}\"]\n";
    });
    // calculate other domains.
    // draw "other categories"
    res += "node [color=purple, style=filled]; \n";
    otherdomains.forEach(function (otherdomain) {
        res += "\"" + otherdomain + "\" \n";
    });
    // count records in domain :
    var nrRecords = m.records.reduce(function (prev, entry) {
        return prev + (entry._domain === domain ? 1 : 0);
    }, 0);
    res += "node [shape=record]; \n";
    res += " \"record\" [label=\"{<f0> " + domain + " | " + nrRecords + "}\"] \n";
    res += " \"r_other\" [label=\"{<f0> other | " + nrRecords + "}\"] \n ";
    res += "# relation from categories to domain\n";
    cats.forEach(function (cat) {
        res += " \"" + cat + "\" -> \"" + domain + "\" \n";
    });
    res += "# relation from categories to records\n";
    cats.forEach(function (cat) {
        var rec = categoryResults[cat];
        res += " \"" + cat + "\" -> \"record\" \n";
    });
    //other domains to this
    cats.forEach(function (cat) {});
    /*
    cats fo
      digraph sdsu {
      size="36,36";
      node [color=yellow, style=filled];
      FLPD FLP "BOM Editor", "WIKIURL" "UI5 Documentation", "UI5 Example", "STARTTA"
      BCP
      node [color=grey, style=filled];
      node [fontname="Verdana", size="30,30"];
      node [color=grey, style=filled];
      graph [ fontname = "Arial",
    */
    res += "}\n";
    return res;
}
exports.graphDomain = graphDomain;
/*
    categoryDesc : theModel.full.domain[filterdomain].categories[category],
    distinct : distinct,
    delta : delta,
    presentRecords : recordCount.presentrecords,
    percPresent : percent,
    sampleValues : valuesList
  }
*/
function replaceBr(string) {
    string = string.replace(/\n/g, "\n\t\t\t\t\t\t\t\t\t\t\tbr\n\t\t\t\t\t\t\t\t\t\t\t| ");
    return string;
}
/**
 * generate a textual representation of a domain
 */
function tabDomain(domain, m) {
    // draw a model domains
    var cats = Model.getCategoriesForDomain(m, domain);
    cats = Model.sortCategoriesByImportance(m.full.domain[domain].categories || {}, cats);
    //console.log(cats.join("\n"));
    var catdesc = Describe.getCategoryStatsInDomain(cats[0], domain, m);
    var catResult = calcCategoryRecord(m, cats[0], domain);
    var domainDescr = m.full.domain[domain].description || "";
    domainDescr = replaceBr(domainDescr);
    var res = "\n\n// preset form values if we receive a userdata object //\n- user = user\n\nextends ../layout_p\n\nblock content\n\n\tnav.navbar.navbar-default.navbar-fixed-top\n\t\t.container\n\t\t\t.navbar-header\n\t\t\t\t.navbar-brand(style='bgcolor:orange;color:darkblue;font-family:Arial Black;font-size:15.118px') wosap domain " + domain + "\n\t\t\tul.nav.navbar-nav.navbar-right #{uid}\n\t\t\t\tli\n\t\t\t\t\t.navbar-btn#btn-logout.btn.btn-default(onclick=\"location.href='/home'\")\n\t\t\t\t\t\t| back to home\n\n\tp  &nbsp;\n\tp &nbsp;\n\tp\n\n\tdiv.well\n\t\th3 domain \"" + domain + "\"\n\t\t\tspan.pull-right " + catResult.nrTotalRecordsInDomain + " records\n\t\tp\n\t\tspan " + domainDescr + "\n\n\t\ttable.table.table-condensed.table-striped\n\t\t\tthead\n\t\t\t\ttr\n\t\t\t\t\tth category\n\t\t\t\t\tth(style=\"width:10%\") count\n\t\t\t\t\tth\n\t\t\t\t\t\ttable\n\t\t\t\t\t\t\ttr\n\t\t\t\t\t\t\t\ttd synonyms\n\t\t\t\t\t\t\ttr\n\t\t\t\t\t\t\t\ttd description\n\t\t\t\t\t\t\ttr\n\t\t\t\t\t\t\t\ttd example values\n\t\t\ttbody\n";
    var categoryResults = {};
    var otherdomains = [];
    var categoryMap = m.full.domain[domain].categories || {};
    cats.forEach(function (cat) {
        var catdesc = Describe.getCategoryStatsInDomain(cat, domain, m);
        //console.log(JSON.stringify(catdesc));
        var catResult = calcCategoryRecord(m, cat, domain);
        categoryResults[cat] = catResult;
        otherdomains = _.union(otherdomains, categoryResults[cat].otherDomains);
        /*
            res += `"${cat}" [label="{ ${cat} | ${catResult.nrDistinctValuesInDomain} Values in ${catResult.nrRecordsInDomain} `;
            if(catResult.nrRecordsInDomain !== catResult.nrRecords) {
              res +=  `|  ${catResult.nrDistinctValues - catResult.nrDistinctValuesInDomain} other values in ${catResult.nrRecords - catResult.nrRecordsInDomain} other records`;
            } else {
              res += ` `;
            }
            res += `}"]\n`;
        */
        //console.log(JSON.stringify(m.full.domain[domain]));
        if (m.full.domain[domain].categories[cat]) {
            var synonymsString = Util.listToCommaAnd(catdesc.categoryDesc && catdesc.categoryDesc.synonyms && catdesc.categoryDesc.synonyms || []) || "&nbsp;";
            res += "\n\t\t\ttr\n\t\t\t\t\ttd.cat_count " + cat + "\n\t\t\t\t\ttd " + catdesc.presentRecords + " distinct values in " + catdesc.percPresent + "% of records\n\t\t\t\t\ttd\n\t\t\t\t\t\ttable\n\t\t\t\t\t\t\ttr.cat_synonyms\n\t\t\t\t\t\t\t\ttd " + synonymsString + "\n\t\t\t\t\t\t\ttr.cat_description\n\t\t\t\t\t\t\t\ttd " + replaceBr(catdesc.categoryDesc && catdesc.categoryDesc.description || "") + "\n\t\t\t\t\t\t\ttr.cat_samplevalues\n\t\t\t\t\t\t\t\ttd " + replaceBr(catdesc.sampleValues) + "\n      ";
        }
    });
    var othercats = cats.length - Object.keys(m.full.domain[domain].categories).length;
    var remainingCategories = _.difference(cats, Object.keys(m.full.domain[domain].categories));
    if (othercats > 0) {
        res += "\n\t\tp   and " + othercats + " other categories\n    | " + Util.listToCommaAnd(remainingCategories) + "\n       ";
    }
    /*
      // calculate other domains.
      // draw "other categories"
      res += `node [color=purple, style=filled]; \n`
      otherdomains.forEach(function(otherdomain) {
        res += `"${otherdomain}" \n`;
      });
      // count records in domain :
      var nrRecords = m.records.reduce(function(prev,entry) {
      return prev + ((entry._domain === domain) ? 1 : 0);
      },0);
      res += `node [shape=record]; \n`
      res += ` "record" [label="{<f0> ${domain} | ${nrRecords}}"] \n`;
    
      res += ` "r_other" [label="{<f0> other | ${nrRecords}}"] \n `;
    
      res += `# relation from categories to domain\n`;
      cats.forEach(function(cat) {
        res += ` "${cat}" -> "${domain}" \n`;
      })
    
    
      res += `# relation from categories to records\n`;
      cats.forEach(function(cat) {
        var rec = categoryResults[cat];
        res += ` "${cat}" -> "record" \n`;
      })
    
    
      //other domains to this
      cats.forEach(function(cat) {
    
    
      })
    */
    /*
    cats fo
      digraph sdsu {
      size="36,36";
      node [color=yellow, style=filled];
      FLPD FLP "BOM Editor", "WIKIURL" "UI5 Documentation", "UI5 Example", "STARTTA"
      BCP
      node [color=grey, style=filled];
      node [fontname="Verdana", size="30,30"];
      node [color=grey, style=filled];
      graph [ fontname = "Arial",
    */
    res += "\n\t\th3 Version\n\t\t\ta.small(href=\"/whatsnew\")\n\n\nblock scripts\n\tscript(src='/vendor/jquery-2.2.3.min.js')\n\tscript(src='/vendor/bootstrap.min.js')\n\tscript(src='/js/views/settings.js')\n";
    return res;
}
exports.tabDomain = tabDomain;
var child_process_1 = require('child_process');
function execCmd(cmd) {
    child_process_1.exec(cmd, function (error, stdout, stderr) {
        if (error) {
            console.error("exec error: " + error);
            return;
        }
        console.log("stdout: " + stdout);
        console.log("stderr: " + stderr);
    });
}
;
function visModels(m, folderOut) {
    m.domains.forEach(function (sDomain) {
        var s = graphDomain(sDomain, m);
        var fnGraph = folderOut + "/" + sDomain.replace(/ /g, '_') + ".gv";
        fs.writeFileSync(fnGraph, s);
        if (process.env.GRAPHVIZ) {
            console.log("here the file " + fnGraph);
            execCmd(process.env.GRAPHVIZ + " -Tjpeg -O " + fnGraph);
        }
    });
}
exports.visModels = visModels;
function tabModels(m, folderOut) {
    m.domains.forEach(function (sDomain) {
        var s = tabDomain(sDomain, m);
        var fnGraph = folderOut + "/" + sDomain.replace(/ /g, '_') + ".jade";
        debuglog("here the file " + fnGraph);
        fs.writeFileSync(fnGraph, s);
    });
}
exports.tabModels = tabModels;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC92aXNtb2RlbC50cyIsIm1vZGVsL3Zpc21vZGVsLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsIk1vZGVsIiwiVXRpbCIsIkRlc2NyaWJlIiwiXyIsImRlYnVnIiwiZGVidWdsb2ciLCJjYWxjQ2F0ZWdvcnlSZWNvcmQiLCJtIiwiY2F0ZWdvcnkiLCJkb21haW4iLCJvdGhlcmRvbWFpbnMiLCJnZXREb21haW5zRm9yQ2F0ZWdvcnkiLCJwdWxsIiwicmVzIiwibnJEaXN0aW5jdFZhbHVlcyIsIm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbiIsIm5yUmVjb3JkcyIsIm5yUmVjb3Jkc0luRG9tYWluIiwibnJUb3RhbFJlY29yZHNJbkRvbWFpbiIsInZhbHVlcyIsInZhbHVlc0luRG9tYWluIiwiZGlzdGluY3RWYWx1ZXMiLCJyZWNvcmRzIiwiZm9yRWFjaCIsIm9FbnRyeSIsIl9kb21haW4iLCJ2YWx1ZSIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJleHBvcnRzIiwiZ3JhcGhEb21haW4iLCJjYXRzIiwiZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbiIsImNhdGVnb3J5UmVzdWx0cyIsImNhdCIsImNhdFJlc3VsdCIsInVuaW9uIiwib3RoZXJEb21haW5zIiwib3RoZXJkb21haW4iLCJyZWR1Y2UiLCJwcmV2IiwiZW50cnkiLCJyZWMiLCJyZXBsYWNlQnIiLCJzdHJpbmciLCJyZXBsYWNlIiwidGFiRG9tYWluIiwic29ydENhdGVnb3JpZXNCeUltcG9ydGFuY2UiLCJmdWxsIiwiY2F0ZWdvcmllcyIsImNhdGRlc2MiLCJnZXRDYXRlZ29yeVN0YXRzSW5Eb21haW4iLCJkb21haW5EZXNjciIsImRlc2NyaXB0aW9uIiwiY2F0ZWdvcnlNYXAiLCJzeW5vbnltc1N0cmluZyIsImxpc3RUb0NvbW1hQW5kIiwiY2F0ZWdvcnlEZXNjIiwic3lub255bXMiLCJwcmVzZW50UmVjb3JkcyIsInBlcmNQcmVzZW50Iiwic2FtcGxlVmFsdWVzIiwib3RoZXJjYXRzIiwicmVtYWluaW5nQ2F0ZWdvcmllcyIsImRpZmZlcmVuY2UiLCJjaGlsZF9wcm9jZXNzXzEiLCJleGVjQ21kIiwiY21kIiwiZXhlYyIsImVycm9yIiwic3Rkb3V0Iiwic3RkZXJyIiwiY29uc29sZSIsImxvZyIsInZpc01vZGVscyIsImZvbGRlck91dCIsImRvbWFpbnMiLCJzRG9tYWluIiwicyIsImZuR3JhcGgiLCJ3cml0ZUZpbGVTeW5jIiwicHJvY2VzcyIsImVudiIsIkdSQVBIVklaIiwidGFiTW9kZWxzIl0sIm1hcHBpbmdzIjoiQUFBQTs7O0FDR0E7O0FETUEsSUFBWUEsS0FBRUMsUUFBTSxJQUFOLENBQWQ7QUFFQSxJQUFZQyxRQUFLRCxRQUFNLFNBQU4sQ0FBakI7QUFDQSxJQUFZRSxPQUFJRixRQUFNLGdCQUFOLENBQWhCO0FBRUEsSUFBWUcsV0FBUUgsUUFBTSxtQkFBTixDQUFwQjtBQUVBLElBQVlJLElBQUNKLFFBQU0sUUFBTixDQUFiO0FBQ0EsSUFBWUssUUFBS0wsUUFBTSxPQUFOLENBQWpCO0FBQ0EsSUFBSU0sV0FBV0QsTUFBTSxhQUFOLENBQWY7QUFTRztBQUVILFNBQUFFLGtCQUFBLENBQW1DQyxDQUFuQyxFQUF1REMsUUFBdkQsRUFBMEVDLE1BQTFFLEVBQXlGO0FBRXZGLFFBQUlDLGVBQWVWLE1BQU1XLHFCQUFOLENBQTRCSixDQUE1QixFQUE4QkMsUUFBOUIsQ0FBbkI7QUFDQ0wsTUFBRVMsSUFBRixDQUFPRixZQUFQLEVBQXFCRCxNQUFyQjtBQUNBLFFBQUlJLE1BQU07QUFDVEgsc0JBQWVBLFlBRE47QUFFVEksMEJBQW1CLENBRlY7QUFHVEMsa0NBQTJCLENBSGxCO0FBSVRDLG1CQUFZLENBSkg7QUFLVEMsMkJBQW1CLENBTFY7QUFNVEMsZ0NBQXlCO0FBTmhCLEtBQVY7QUFTQSxRQUFJQyxTQUFTLEVBQWI7QUFDQSxRQUFJQyxpQkFBaUIsRUFBckI7QUFDQSxRQUFJSCxvQkFBb0IsQ0FBeEI7QUFDQSxRQUFJSSxpQkFBaUJkLEVBQUVlLE9BQUYsQ0FBVUMs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QUFSO0FBQ0EsWUFBSXlFLFVBQVVKLFlBQVksR0FBWixHQUFrQkUsUUFBUWhDLE9BQVIsQ0FBZ0IsSUFBaEIsRUFBcUIsR0FBckIsQ0FBbEIsR0FBOEMsT0FBNUQ7QUFDQXpDLGlCQUFTLG1CQUFtQjJFLE9BQTVCO0FBQ0FsRixXQUFHbUYsYUFBSCxDQUFpQkQsT0FBakIsRUFBMEJELENBQTFCO0FBQ0QsS0FMRDtBQU1EO0FBUGVqRCxRQUFBdUQsU0FBQSxHQUFTQSxTQUFUIiwiZmlsZSI6Im1vZGVsL3Zpc21vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiB2aXN1YWxpemUgYSBtb2RlbCBhbmQgY2FsY3VsYXRlIHNvbWUgc3RhdGlzdGljc1xuICovXG5cblxuXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XG5cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuXG5pbXBvcnQgKiBhcyBNb2RlbCBmcm9tICcuL21vZGVsJztcbmltcG9ydCAqIGFzIFV0aWwgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5pbXBvcnQgKiBhcyBEZXNjcmliZSBmcm9tICcuLi9tYXRjaC9kZXNjcmliZSc7XG5cbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCd2aXNtb2RlbC50cycpO1xuXG5pbnRlcmZhY2UgQ2F0ZWdvcnlSZWNvcmQge1xuICAgIG90aGVyZG9tYWlucyA6IHN0cmluZ1tdLFxuICAgIG5yRGlzdGluY3RWYWx1ZXMgOiBudW1iZXIsXG4gICAgbnJEaXN0aW5jdFZhbHVlc0luRG9tYWluIDogbnVtYmVyLFxuICAgIG5yUmVjb3JkcyA6IG51bWJlcixcbiAgICBuclJlY29yZHNJbkRvbWFpbjogbnVtYmVyLFxuICAgIG5yVG90YWxSZWNvcmRzSW5Eb21haW4gOiBudW1iZXJcbiAgfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGNDYXRlZ29yeVJlY29yZChtIDogSU1hdGNoLklNb2RlbHMsIGNhdGVnb3J5IDogc3RyaW5nLCBkb21haW4gOiBzdHJpbmcpICA6IENhdGVnb3J5UmVjb3JkIHtcblxuICB2YXIgb3RoZXJkb21haW5zID0gTW9kZWwuZ2V0RG9tYWluc0ZvckNhdGVnb3J5KG0sY2F0ZWdvcnkpO1xuICAgXy5wdWxsKG90aGVyZG9tYWlucywgZG9tYWluKTtcbiAgIHZhciByZXMgPSB7XG4gICAgb3RoZXJkb21haW5zIDogb3RoZXJkb21haW5zLFxuICAgIG5yRGlzdGluY3RWYWx1ZXMgOiAwLFxuICAgIG5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbiA6IDAsXG4gICAgbnJSZWNvcmRzIDogMCxcbiAgICBuclJlY29yZHNJbkRvbWFpbjogMCxcbiAgICBuclRvdGFsUmVjb3Jkc0luRG9tYWluIDogMCxcbiAgfSBhcyBDYXRlZ29yeVJlY29yZDtcblxuICAgdmFyIHZhbHVlcyA9IFtdO1xuICAgdmFyIHZhbHVlc0luRG9tYWluID0gW107XG4gICB2YXIgbnJSZWNvcmRzSW5Eb21haW4gPSAwO1xuICAgdmFyIGRpc3RpbmN0VmFsdWVzID0gbS5yZWNvcmRzLmZvckVhY2goZnVuY3Rpb24ob0VudHJ5KSB7XG4gICAgIGlmKG9FbnRyeS5fZG9tYWluID09PSBkb21haW4pIHtcbiAgICAgICByZXMubnJUb3RhbFJlY29yZHNJbkRvbWFpbiArPSAxO1xuICAgICB9XG4gICAgIGlmIChvRW50cnlbY2F0ZWdvcnldKSB7XG4gICAgICAgdmFyIHZhbHVlID0gb0VudHJ5W2NhdGVnb3J5XTtcbiAgICAgICBpZihvRW50cnkuX2RvbWFpbiA9PT0gZG9tYWluKSB7XG4gICAgICAgICB2YWx1ZXNJbkRvbWFpblt2YWx1ZV0gPSAodmFsdWVzSW5Eb21haW5bdmFsdWVdIHx8IDApICsgMTtcbiAgICAgICAgIHJlcy5uclJlY29yZHNJbkRvbWFpbiArPSAxO1xuICAgICAgIH1cbiAgICAgIHZhbHVlc1t2YWx1ZV0gPSAodmFsdWVzW3ZhbHVlXSB8fCAwKSArIDE7XG4gICAgICAgcmVzLm5yUmVjb3JkcyArPSAxO1xuICAgICB9XG4gICB9KTtcbiAgIHJlcy5uckRpc3RpbmN0VmFsdWVzID0gT2JqZWN0LmtleXModmFsdWVzKS5sZW5ndGg7XG4gICByZXMubnJEaXN0aW5jdFZhbHVlc0luRG9tYWluID0gT2JqZWN0LmtleXModmFsdWVzSW5Eb21haW4pLmxlbmd0aDtcbiAgIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBncmFwaERvbWFpbihkb21haW4gOiBzdHJpbmcsIG0gOiBJTWF0Y2guSU1vZGVscykge1xuICAvLyBkcmF3IGEgbW9kZWwgZG9tYWluc1xuICB2YXIgcmVzID0gYFxuICAgIGRpZ3JhcGggc2RzdSB7XG5cdHNpemU9XCIzNiwzNlwiO1xuICAgcmFua2Rpcj1MUlxuXHRub2RlIFtjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XG4gICAgXCIke2RvbWFpbn1cIlxuICBgO1xuICAvLyBhZGQgYWxsIGNhdGVnb3J5IG5vZGVzXG4gIHJlcyArPSBgbm9kZSBbc2hhcGU9cmVjb3JkLCBjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XFxuIGBcbiAgdmFyIGNhdHMgPSBNb2RlbC5nZXRDYXRlZ29yaWVzRm9yRG9tYWluKG0sZG9tYWluKTtcblxuICB2YXIgY2F0ZWdvcnlSZXN1bHRzID0ge307XG4gIHZhciBvdGhlcmRvbWFpbnMgPSBbXTtcbiAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuICAgIHZhciBjYXRSZXN1bHQgPSBjYWxjQ2F0ZWdvcnlSZWNvcmQobSwgY2F0LCBkb21haW4pO1xuICAgIGNhdGVnb3J5UmVzdWx0c1tjYXRdID0gY2F0UmVzdWx0O1xuICAgIG90aGVyZG9tYWlucyA9IF8udW5pb24ob3RoZXJkb21haW5zLCBjYXRlZ29yeVJlc3VsdHNbY2F0XS5vdGhlckRvbWFpbnMpO1xuICAgIHJlcyArPSBgXCIke2NhdH1cIiBbbGFiZWw9XCJ7ICR7Y2F0fSB8ICR7Y2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbn0gVmFsdWVzIGluICR7Y2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWlufSBgO1xuICAgIGlmKGNhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbiAhPT0gY2F0UmVzdWx0Lm5yUmVjb3Jkcykge1xuICAgICAgcmVzICs9ICBgfCAgJHtjYXRSZXN1bHQubnJEaXN0aW5jdFZhbHVlcyAtIGNhdFJlc3VsdC5uckRpc3RpbmN0VmFsdWVzSW5Eb21haW59IG90aGVyIHZhbHVlcyBpbiAke2NhdFJlc3VsdC5uclJlY29yZHMgLSBjYXRSZXN1bHQubnJSZWNvcmRzSW5Eb21haW59IG90aGVyIHJlY29yZHNgO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXMgKz0gYCBgO1xuICAgIH1cbiAgICByZXMgKz0gYH1cIl1cXG5gO1xuICB9KTtcblxuICAvLyBjYWxjdWxhdGUgb3RoZXIgZG9tYWlucy5cbiAgLy8gZHJhdyBcIm90aGVyIGNhdGVnb3JpZXNcIlxuICByZXMgKz0gYG5vZGUgW2NvbG9yPXB1cnBsZSwgc3R5bGU9ZmlsbGVkXTsgXFxuYFxuICBvdGhlcmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbihvdGhlcmRvbWFpbikge1xuICAgIHJlcyArPSBgXCIke290aGVyZG9tYWlufVwiIFxcbmA7XG4gIH0pO1xuICAvLyBjb3VudCByZWNvcmRzIGluIGRvbWFpbiA6XG4gIHZhciBuclJlY29yZHMgPSBtLnJlY29yZHMucmVkdWNlKGZ1bmN0aW9uKHByZXYsZW50cnkpIHtcbiAgcmV0dXJuIHByZXYgKyAoKGVudHJ5Ll9kb21haW4gPT09IGRvbWFpbikgPyAxIDogMCk7XG4gIH0sMCk7XG4gIHJlcyArPSBgbm9kZSBbc2hhcGU9cmVjb3JkXTsgXFxuYFxuICByZXMgKz0gYCBcInJlY29yZFwiIFtsYWJlbD1cIns8ZjA+ICR7ZG9tYWlufSB8ICR7bnJSZWNvcmRzfX1cIl0gXFxuYDtcblxuICByZXMgKz0gYCBcInJfb3RoZXJcIiBbbGFiZWw9XCJ7PGYwPiBvdGhlciB8ICR7bnJSZWNvcmRzfX1cIl0gXFxuIGA7XG5cbiAgcmVzICs9IGAjIHJlbGF0aW9uIGZyb20gY2F0ZWdvcmllcyB0byBkb21haW5cXG5gO1xuICBjYXRzLmZvckVhY2goZnVuY3Rpb24oY2F0KSB7XG4gICAgcmVzICs9IGAgXCIke2NhdH1cIiAtPiBcIiR7ZG9tYWlufVwiIFxcbmA7XG4gIH0pXG5cblxuICByZXMgKz0gYCMgcmVsYXRpb24gZnJvbSBjYXRlZ29yaWVzIHRvIHJlY29yZHNcXG5gO1xuICBjYXRzLmZvckVhY2goZnVuY3Rpb24oY2F0KSB7XG4gICAgdmFyIHJlYyA9IGNhdGVnb3J5UmVzdWx0c1tjYXRdO1xuICAgIHJlcyArPSBgIFwiJHtjYXR9XCIgLT4gXCJyZWNvcmRcIiBcXG5gO1xuICB9KVxuXG5cbiAgLy9vdGhlciBkb21haW5zIHRvIHRoaXNcbiAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuXG5cbiAgfSlcblxuICAvKlxuICBjYXRzIGZvXG4gICAgZGlncmFwaCBzZHN1IHtcblx0c2l6ZT1cIjM2LDM2XCI7XG5cdG5vZGUgW2NvbG9yPXllbGxvdywgc3R5bGU9ZmlsbGVkXTtcblx0RkxQRCBGTFAgXCJCT00gRWRpdG9yXCIsIFwiV0lLSVVSTFwiIFwiVUk1IERvY3VtZW50YXRpb25cIiwgXCJVSTUgRXhhbXBsZVwiLCBcIlNUQVJUVEFcIlxuXHRCQ1Bcblx0bm9kZSBbY29sb3I9Z3JleSwgc3R5bGU9ZmlsbGVkXTtcblx0bm9kZSBbZm9udG5hbWU9XCJWZXJkYW5hXCIsIHNpemU9XCIzMCwzMFwiXTtcblx0bm9kZSBbY29sb3I9Z3JleSwgc3R5bGU9ZmlsbGVkXTtcblx0Z3JhcGggWyBmb250bmFtZSA9IFwiQXJpYWxcIixcbiAgKi9cbiAgcmVzICs9IGB9XFxuYDtcbiAgcmV0dXJuIHJlcztcbn1cbi8qXG4gICAgY2F0ZWdvcnlEZXNjIDogdGhlTW9kZWwuZnVsbC5kb21haW5bZmlsdGVyZG9tYWluXS5jYXRlZ29yaWVzW2NhdGVnb3J5XSxcbiAgICBkaXN0aW5jdCA6IGRpc3RpbmN0LFxuICAgIGRlbHRhIDogZGVsdGEsXG4gICAgcHJlc2VudFJlY29yZHMgOiByZWNvcmRDb3VudC5wcmVzZW50cmVjb3JkcyxcbiAgICBwZXJjUHJlc2VudCA6IHBlcmNlbnQsXG4gICAgc2FtcGxlVmFsdWVzIDogdmFsdWVzTGlzdFxuICB9XG4qL1xuXG5mdW5jdGlvbiByZXBsYWNlQnIoc3RyaW5nIDogc3RyaW5nICkgOiBzdHJpbmcge1xuICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvXFxuL2csXG4gICBgXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRiclxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0fCBgXG4gICApO1xuICAgcmV0dXJuIHN0cmluZztcbn1cblxuXG5cblxuLyoqXG4gKiBnZW5lcmF0ZSBhIHRleHR1YWwgcmVwcmVzZW50YXRpb24gb2YgYSBkb21haW5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRhYkRvbWFpbihkb21haW4gOiBzdHJpbmcsIG0gOiBJTWF0Y2guSU1vZGVscykge1xuICAvLyBkcmF3IGEgbW9kZWwgZG9tYWluc1xuXG4gIHZhciBjYXRzID0gTW9kZWwuZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbihtLGRvbWFpbik7XG4gIGNhdHMgPSBNb2RlbC5zb3J0Q2F0ZWdvcmllc0J5SW1wb3J0YW5jZSggbS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMgfHwge30sIGNhdHMpO1xuICAvL2NvbnNvbGUubG9nKGNhdHMuam9pbihcIlxcblwiKSk7XG4gIHZhciBjYXRkZXNjID0gRGVzY3JpYmUuZ2V0Q2F0ZWdvcnlTdGF0c0luRG9tYWluKGNhdHNbMF0sZG9tYWluLG0pO1xuICB2YXIgY2F0UmVzdWx0ID0gY2FsY0NhdGVnb3J5UmVjb3JkKG0sIGNhdHNbMF0sIGRvbWFpbik7XG5cbiAgdmFyIGRvbWFpbkRlc2NyID0gbS5mdWxsLmRvbWFpbltkb21haW5dLmRlc2NyaXB0aW9uIHx8IFwiXCI7XG4gIGRvbWFpbkRlc2NyID0gcmVwbGFjZUJyKGRvbWFpbkRlc2NyKTtcbiAgdmFyIHJlcyA9IGBcblxuLy8gcHJlc2V0IGZvcm0gdmFsdWVzIGlmIHdlIHJlY2VpdmUgYSB1c2VyZGF0YSBvYmplY3QgLy9cbi0gdXNlciA9IHVzZXJcblxuZXh0ZW5kcyAuLi9sYXlvdXRfcFxuXG5ibG9jayBjb250ZW50XG5cblx0bmF2Lm5hdmJhci5uYXZiYXItZGVmYXVsdC5uYXZiYXItZml4ZWQtdG9wXG5cdFx0LmNvbnRhaW5lclxuXHRcdFx0Lm5hdmJhci1oZWFkZXJcblx0XHRcdFx0Lm5hdmJhci1icmFuZChzdHlsZT0nYmdjb2xvcjpvcmFuZ2U7Y29sb3I6ZGFya2JsdWU7Zm9udC1mYW1pbHk6QXJpYWwgQmxhY2s7Zm9udC1zaXplOjE1LjExOHB4Jykgd29zYXAgZG9tYWluICR7ZG9tYWlufVxuXHRcdFx0dWwubmF2Lm5hdmJhci1uYXYubmF2YmFyLXJpZ2h0ICN7dWlkfVxuXHRcdFx0XHRsaVxuXHRcdFx0XHRcdC5uYXZiYXItYnRuI2J0bi1sb2dvdXQuYnRuLmJ0bi1kZWZhdWx0KG9uY2xpY2s9XCJsb2NhdGlvbi5ocmVmPScvaG9tZSdcIilcblx0XHRcdFx0XHRcdHwgYmFjayB0byBob21lXG5cblx0cCAgJm5ic3A7XG5cdHAgJm5ic3A7XG5cdHBcblxuXHRkaXYud2VsbFxuXHRcdGgzIGRvbWFpbiBcIiR7ZG9tYWlufVwiXG5cdFx0XHRzcGFuLnB1bGwtcmlnaHQgJHtjYXRSZXN1bHQubnJUb3RhbFJlY29yZHNJbkRvbWFpbn0gcmVjb3Jkc1xuXHRcdHBcblx0XHRzcGFuICR7ZG9tYWluRGVzY3J9XG5cblx0XHR0YWJsZS50YWJsZS50YWJsZS1jb25kZW5zZWQudGFibGUtc3RyaXBlZFxuXHRcdFx0dGhlYWRcblx0XHRcdFx0dHJcblx0XHRcdFx0XHR0aCBjYXRlZ29yeVxuXHRcdFx0XHRcdHRoKHN0eWxlPVwid2lkdGg6MTAlXCIpIGNvdW50XG5cdFx0XHRcdFx0dGhcblx0XHRcdFx0XHRcdHRhYmxlXG5cdFx0XHRcdFx0XHRcdHRyXG5cdFx0XHRcdFx0XHRcdFx0dGQgc3lub255bXNcblx0XHRcdFx0XHRcdFx0dHJcblx0XHRcdFx0XHRcdFx0XHR0ZCBkZXNjcmlwdGlvblxuXHRcdFx0XHRcdFx0XHR0clxuXHRcdFx0XHRcdFx0XHRcdHRkIGV4YW1wbGUgdmFsdWVzXG5cdFx0XHR0Ym9keVxuYDtcblxuICB2YXIgY2F0ZWdvcnlSZXN1bHRzID0ge307XG4gIHZhciBvdGhlcmRvbWFpbnMgPSBbXTtcbiAgdmFyIGNhdGVnb3J5TWFwID0gbS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMgfHwge307XG4gIGNhdHMuZm9yRWFjaChmdW5jdGlvbihjYXQpIHtcbiAgICB2YXIgY2F0ZGVzYyA9IERlc2NyaWJlLmdldENhdGVnb3J5U3RhdHNJbkRvbWFpbihjYXQsZG9tYWluLG0pO1xuICAgIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoY2F0ZGVzYykpO1xuICAgIHZhciBjYXRSZXN1bHQgPSBjYWxjQ2F0ZWdvcnlSZWNvcmQobSwgY2F0LCBkb21haW4pO1xuICAgIGNhdGVnb3J5UmVzdWx0c1tjYXRdID0gY2F0UmVzdWx0O1xuICAgIG90aGVyZG9tYWlucyA9IF8udW5pb24ob3RoZXJkb21haW5zLCBjYXRlZ29yeVJlc3VsdHNbY2F0XS5vdGhlckRvbWFpbnMpO1xuLypcbiAgICByZXMgKz0gYFwiJHtjYXR9XCIgW2xhYmVsPVwieyAke2NhdH0gfCAke2NhdFJlc3VsdC5uckRpc3RpbmN0VmFsdWVzSW5Eb21haW59IFZhbHVlcyBpbiAke2NhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbn0gYDtcbiAgICBpZihjYXRSZXN1bHQubnJSZWNvcmRzSW5Eb21haW4gIT09IGNhdFJlc3VsdC5uclJlY29yZHMpIHtcbiAgICAgIHJlcyArPSAgYHwgICR7Y2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXMgLSBjYXRSZXN1bHQubnJEaXN0aW5jdFZhbHVlc0luRG9tYWlufSBvdGhlciB2YWx1ZXMgaW4gJHtjYXRSZXN1bHQubnJSZWNvcmRzIC0gY2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWlufSBvdGhlciByZWNvcmRzYDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzICs9IGAgYDtcbiAgICB9XG4gICAgcmVzICs9IGB9XCJdXFxuYDtcbiovXG4gICAgLy9jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShtLmZ1bGwuZG9tYWluW2RvbWFpbl0pKTtcbiAgICBpZihtLmZ1bGwuZG9tYWluW2RvbWFpbl0uY2F0ZWdvcmllc1tjYXRdKSB7XG5cbiAgICB2YXIgc3lub255bXNTdHJpbmcgPSBVdGlsLmxpc3RUb0NvbW1hQW5kKCBjYXRkZXNjLmNhdGVnb3J5RGVzYyAmJiBjYXRkZXNjLmNhdGVnb3J5RGVzYy5zeW5vbnltcyAmJiBjYXRkZXNjLmNhdGVnb3J5RGVzYy5zeW5vbnltcyB8fCBbXSApIHx8IFwiJm5ic3A7XCI7XG5cbiAgICByZXMgKz0gYFxuXHRcdFx0dHJcblx0XHRcdFx0XHR0ZC5jYXRfY291bnQgJHtjYXR9XG5cXHRcXHRcXHRcXHRcXHR0ZCAke2NhdGRlc2MucHJlc2VudFJlY29yZHN9IGRpc3RpbmN0IHZhbHVlcyBpbiAke2NhdGRlc2MucGVyY1ByZXNlbnR9JSBvZiByZWNvcmRzXG5cXHRcXHRcXHRcXHRcXHR0ZFxuXFx0XFx0XFx0XFx0XFx0XFx0dGFibGVcblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyLmNhdF9zeW5vbnltc1xuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgJHtzeW5vbnltc1N0cmluZ31cblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyLmNhdF9kZXNjcmlwdGlvblxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgJHtyZXBsYWNlQnIoY2F0ZGVzYy5jYXRlZ29yeURlc2MgJiYgY2F0ZGVzYy5jYXRlZ29yeURlc2MuZGVzY3JpcHRpb24gfHwgXCJcIil9XG5cXHRcXHRcXHRcXHRcXHRcXHRcXHR0ci5jYXRfc2FtcGxldmFsdWVzXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHR0ZCAke3JlcGxhY2VCcihjYXRkZXNjLnNhbXBsZVZhbHVlcyl9XG4gICAgICBgO1xuICAgIH1cblxuICB9KTtcblxuICB2YXIgb3RoZXJjYXRzID0gY2F0cy5sZW5ndGggLSBPYmplY3Qua2V5cyhtLmZ1bGwuZG9tYWluW2RvbWFpbl0uY2F0ZWdvcmllcykubGVuZ3RoIDtcbiAgdmFyIHJlbWFpbmluZ0NhdGVnb3JpZXMgPSBfLmRpZmZlcmVuY2UoY2F0cywgT2JqZWN0LmtleXMobS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMpKTtcbiAgaWYgKChvdGhlcmNhdHMpID4gMCkge1xuICAgIHJlcyArPSBgXG5cXHRcXHRwICAgYW5kICR7b3RoZXJjYXRzfSBvdGhlciBjYXRlZ29yaWVzXG4gICAgfCAke1V0aWwubGlzdFRvQ29tbWFBbmQocmVtYWluaW5nQ2F0ZWdvcmllcyl9XG4gICAgICAgYFxuXG4gIH1cbi8qXG4gIC8vIGNhbGN1bGF0ZSBvdGhlciBkb21haW5zLlxuICAvLyBkcmF3IFwib3RoZXIgY2F0ZWdvcmllc1wiXG4gIHJlcyArPSBgbm9kZSBbY29sb3I9cHVycGxlLCBzdHlsZT1maWxsZWRdOyBcXG5gXG4gIG90aGVyZG9tYWlucy5mb3JFYWNoKGZ1bmN0aW9uKG90aGVyZG9tYWluKSB7XG4gICAgcmVzICs9IGBcIiR7b3RoZXJkb21haW59XCIgXFxuYDtcbiAgfSk7XG4gIC8vIGNvdW50IHJlY29yZHMgaW4gZG9tYWluIDpcbiAgdmFyIG5yUmVjb3JkcyA9IG0ucmVjb3Jkcy5yZWR1Y2UoZnVuY3Rpb24ocHJldixlbnRyeSkge1xuICByZXR1cm4gcHJldiArICgoZW50cnkuX2RvbWFpbiA9PT0gZG9tYWluKSA/IDEgOiAwKTtcbiAgfSwwKTtcbiAgcmVzICs9IGBub2RlIFtzaGFwZT1yZWNvcmRdOyBcXG5gXG4gIHJlcyArPSBgIFwicmVjb3JkXCIgW2xhYmVsPVwiezxmMD4gJHtkb21haW59IHwgJHtuclJlY29yZHN9fVwiXSBcXG5gO1xuXG4gIHJlcyArPSBgIFwicl9vdGhlclwiIFtsYWJlbD1cIns8ZjA+IG90aGVyIHwgJHtuclJlY29yZHN9fVwiXSBcXG4gYDtcblxuICByZXMgKz0gYCMgcmVsYXRpb24gZnJvbSBjYXRlZ29yaWVzIHRvIGRvbWFpblxcbmA7XG4gIGNhdHMuZm9yRWFjaChmdW5jdGlvbihjYXQpIHtcbiAgICByZXMgKz0gYCBcIiR7Y2F0fVwiIC0+IFwiJHtkb21haW59XCIgXFxuYDtcbiAgfSlcblxuXG4gIHJlcyArPSBgIyByZWxhdGlvbiBmcm9tIGNhdGVnb3JpZXMgdG8gcmVjb3Jkc1xcbmA7XG4gIGNhdHMuZm9yRWFjaChmdW5jdGlvbihjYXQpIHtcbiAgICB2YXIgcmVjID0gY2F0ZWdvcnlSZXN1bHRzW2NhdF07XG4gICAgcmVzICs9IGAgXCIke2NhdH1cIiAtPiBcInJlY29yZFwiIFxcbmA7XG4gIH0pXG5cblxuICAvL290aGVyIGRvbWFpbnMgdG8gdGhpc1xuICBjYXRzLmZvckVhY2goZnVuY3Rpb24oY2F0KSB7XG5cblxuICB9KVxuKi9cbiAgLypcbiAgY2F0cyBmb1xuICAgIGRpZ3JhcGggc2RzdSB7XG5cdHNpemU9XCIzNiwzNlwiO1xuXHRub2RlIFtjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XG5cdEZMUEQgRkxQIFwiQk9NIEVkaXRvclwiLCBcIldJS0lVUkxcIiBcIlVJNSBEb2N1bWVudGF0aW9uXCIsIFwiVUk1IEV4YW1wbGVcIiwgXCJTVEFSVFRBXCJcblx0QkNQXG5cdG5vZGUgW2NvbG9yPWdyZXksIHN0eWxlPWZpbGxlZF07XG5cdG5vZGUgW2ZvbnRuYW1lPVwiVmVyZGFuYVwiLCBzaXplPVwiMzAsMzBcIl07XG5cdG5vZGUgW2NvbG9yPWdyZXksIHN0eWxlPWZpbGxlZF07XG5cdGdyYXBoIFsgZm9udG5hbWUgPSBcIkFyaWFsXCIsXG4gICovXG4gIHJlcyArPSBgXG5cdFx0aDMgVmVyc2lvblxuXHRcdFx0YS5zbWFsbChocmVmPVwiL3doYXRzbmV3XCIpXG5cblxuYmxvY2sgc2NyaXB0c1xuXHRzY3JpcHQoc3JjPScvdmVuZG9yL2pxdWVyeS0yLjIuMy5taW4uanMnKVxuXHRzY3JpcHQoc3JjPScvdmVuZG9yL2Jvb3RzdHJhcC5taW4uanMnKVxuXHRzY3JpcHQoc3JjPScvanMvdmlld3Mvc2V0dGluZ3MuanMnKVxuYDtcbiAgcmV0dXJuIHJlcztcbn1cblxuXG5cbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcblxuXG5mdW5jdGlvbiBleGVjQ21kKGNtZCA6IHN0cmluZykge1xuIGV4ZWMoY21kLCBmdW5jdGlvbiAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGBleGVjIGVycm9yOiAke2Vycm9yfWApXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc29sZS5sb2coYHN0ZG91dDogJHtzdGRvdXR9YClcbiAgICBjb25zb2xlLmxvZyhgc3RkZXJyOiAke3N0ZGVycn1gKVxuICB9KVxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHZpc01vZGVscyhtIDogSU1hdGNoLklNb2RlbHMsIGZvbGRlck91dCA6IHN0cmluZyApIHtcbiAgbS5kb21haW5zLmZvckVhY2goZnVuY3Rpb24oc0RvbWFpbikge1xuICAgIHZhciBzID0gZ3JhcGhEb21haW4oc0RvbWFpbixtKTtcbiAgICB2YXIgZm5HcmFwaCA9IGZvbGRlck91dCArIFwiL1wiICsgc0RvbWFpbi5yZXBsYWNlKC8gL2csJ18nKSArIFwiLmd2XCI7XG4gICAgZnMud3JpdGVGaWxlU3luYyhmbkdyYXBoLCBzKTtcbiAgICBpZihwcm9jZXNzLmVudi5HUkFQSFZJWikge1xuICAgICAgY29uc29sZS5sb2coXCJoZXJlIHRoZSBmaWxlIFwiICsgZm5HcmFwaCk7XG4gICAgICBleGVjQ21kKHByb2Nlc3MuZW52LkdSQVBIVklaICsgXCIgLVRqcGVnIC1PIFwiICsgZm5HcmFwaCk7XG4gICAgfVxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRhYk1vZGVscyhtIDogSU1hdGNoLklNb2RlbHMsIGZvbGRlck91dCA6IHN0cmluZyApIHtcbiAgbS5kb21haW5zLmZvckVhY2goZnVuY3Rpb24oc0RvbWFpbikge1xuICAgIHZhciBzID0gdGFiRG9tYWluKHNEb21haW4sbSk7XG4gICAgdmFyIGZuR3JhcGggPSBmb2xkZXJPdXQgKyBcIi9cIiArIHNEb21haW4ucmVwbGFjZSgvIC9nLCdfJykgKyBcIi5qYWRlXCI7XG4gICAgZGVidWdsb2coXCJoZXJlIHRoZSBmaWxlIFwiICsgZm5HcmFwaCk7XG4gICAgZnMud3JpdGVGaWxlU3luYyhmbkdyYXBoLCBzKTtcbiAgfSk7XG59XG4iLCIvKipcbiAqIHZpc3VhbGl6ZSBhIG1vZGVsIGFuZCBjYWxjdWxhdGUgc29tZSBzdGF0aXN0aWNzXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciBNb2RlbCA9IHJlcXVpcmUoJy4vbW9kZWwnKTtcbnZhciBVdGlsID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbHMnKTtcbnZhciBEZXNjcmliZSA9IHJlcXVpcmUoJy4uL21hdGNoL2Rlc2NyaWJlJyk7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCd2aXNtb2RlbC50cycpO1xuO1xuZnVuY3Rpb24gY2FsY0NhdGVnb3J5UmVjb3JkKG0sIGNhdGVnb3J5LCBkb21haW4pIHtcbiAgICB2YXIgb3RoZXJkb21haW5zID0gTW9kZWwuZ2V0RG9tYWluc0ZvckNhdGVnb3J5KG0sIGNhdGVnb3J5KTtcbiAgICBfLnB1bGwob3RoZXJkb21haW5zLCBkb21haW4pO1xuICAgIHZhciByZXMgPSB7XG4gICAgICAgIG90aGVyZG9tYWluczogb3RoZXJkb21haW5zLFxuICAgICAgICBuckRpc3RpbmN0VmFsdWVzOiAwLFxuICAgICAgICBuckRpc3RpbmN0VmFsdWVzSW5Eb21haW46IDAsXG4gICAgICAgIG5yUmVjb3JkczogMCxcbiAgICAgICAgbnJSZWNvcmRzSW5Eb21haW46IDAsXG4gICAgICAgIG5yVG90YWxSZWNvcmRzSW5Eb21haW46IDAsXG4gICAgfTtcbiAgICB2YXIgdmFsdWVzID0gW107XG4gICAgdmFyIHZhbHVlc0luRG9tYWluID0gW107XG4gICAgdmFyIG5yUmVjb3Jkc0luRG9tYWluID0gMDtcbiAgICB2YXIgZGlzdGluY3RWYWx1ZXMgPSBtLnJlY29yZHMuZm9yRWFjaChmdW5jdGlvbiAob0VudHJ5KSB7XG4gICAgICAgIGlmIChvRW50cnkuX2RvbWFpbiA9PT0gZG9tYWluKSB7XG4gICAgICAgICAgICByZXMubnJUb3RhbFJlY29yZHNJbkRvbWFpbiArPSAxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvRW50cnlbY2F0ZWdvcnldKSB7XG4gICAgICAgICAgICB2YXIgdmFsdWUgPSBvRW50cnlbY2F0ZWdvcnldO1xuICAgICAgICAgICAgaWYgKG9FbnRyeS5fZG9tYWluID09PSBkb21haW4pIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXNJbkRvbWFpblt2YWx1ZV0gPSAodmFsdWVzSW5Eb21haW5bdmFsdWVdIHx8IDApICsgMTtcbiAgICAgICAgICAgICAgICByZXMubnJSZWNvcmRzSW5Eb21haW4gKz0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhbHVlc1t2YWx1ZV0gPSAodmFsdWVzW3ZhbHVlXSB8fCAwKSArIDE7XG4gICAgICAgICAgICByZXMubnJSZWNvcmRzICs9IDE7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXMubnJEaXN0aW5jdFZhbHVlcyA9IE9iamVjdC5rZXlzKHZhbHVlcykubGVuZ3RoO1xuICAgIHJlcy5uckRpc3RpbmN0VmFsdWVzSW5Eb21haW4gPSBPYmplY3Qua2V5cyh2YWx1ZXNJbkRvbWFpbikubGVuZ3RoO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmNhbGNDYXRlZ29yeVJlY29yZCA9IGNhbGNDYXRlZ29yeVJlY29yZDtcbmZ1bmN0aW9uIGdyYXBoRG9tYWluKGRvbWFpbiwgbSkge1xuICAgIC8vIGRyYXcgYSBtb2RlbCBkb21haW5zXG4gICAgdmFyIHJlcyA9IFwiXFxuICAgIGRpZ3JhcGggc2RzdSB7XFxuXFx0c2l6ZT1cXFwiMzYsMzZcXFwiO1xcbiAgIHJhbmtkaXI9TFJcXG5cXHRub2RlIFtjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XFxuICAgIFxcXCJcIiArIGRvbWFpbiArIFwiXFxcIlxcbiAgXCI7XG4gICAgLy8gYWRkIGFsbCBjYXRlZ29yeSBub2Rlc1xuICAgIHJlcyArPSBcIm5vZGUgW3NoYXBlPXJlY29yZCwgY29sb3I9eWVsbG93LCBzdHlsZT1maWxsZWRdO1xcbiBcIjtcbiAgICB2YXIgY2F0cyA9IE1vZGVsLmdldENhdGVnb3JpZXNGb3JEb21haW4obSwgZG9tYWluKTtcbiAgICB2YXIgY2F0ZWdvcnlSZXN1bHRzID0ge307XG4gICAgdmFyIG90aGVyZG9tYWlucyA9IFtdO1xuICAgIGNhdHMuZm9yRWFjaChmdW5jdGlvbiAoY2F0KSB7XG4gICAgICAgIHZhciBjYXRSZXN1bHQgPSBjYWxjQ2F0ZWdvcnlSZWNvcmQobSwgY2F0LCBkb21haW4pO1xuICAgICAgICBjYXRlZ29yeVJlc3VsdHNbY2F0XSA9IGNhdFJlc3VsdDtcbiAgICAgICAgb3RoZXJkb21haW5zID0gXy51bmlvbihvdGhlcmRvbWFpbnMsIGNhdGVnb3J5UmVzdWx0c1tjYXRdLm90aGVyRG9tYWlucyk7XG4gICAgICAgIHJlcyArPSBcIlxcXCJcIiArIGNhdCArIFwiXFxcIiBbbGFiZWw9XFxcInsgXCIgKyBjYXQgKyBcIiB8IFwiICsgY2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbiArIFwiIFZhbHVlcyBpbiBcIiArIGNhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbiArIFwiIFwiO1xuICAgICAgICBpZiAoY2F0UmVzdWx0Lm5yUmVjb3Jkc0luRG9tYWluICE9PSBjYXRSZXN1bHQubnJSZWNvcmRzKSB7XG4gICAgICAgICAgICByZXMgKz0gXCJ8ICBcIiArIChjYXRSZXN1bHQubnJEaXN0aW5jdFZhbHVlcyAtIGNhdFJlc3VsdC5uckRpc3RpbmN0VmFsdWVzSW5Eb21haW4pICsgXCIgb3RoZXIgdmFsdWVzIGluIFwiICsgKGNhdFJlc3VsdC5uclJlY29yZHMgLSBjYXRSZXN1bHQubnJSZWNvcmRzSW5Eb21haW4pICsgXCIgb3RoZXIgcmVjb3Jkc1wiO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmVzICs9IFwiIFwiO1xuICAgICAgICB9XG4gICAgICAgIHJlcyArPSBcIn1cXFwiXVxcblwiO1xuICAgIH0pO1xuICAgIC8vIGNhbGN1bGF0ZSBvdGhlciBkb21haW5zLlxuICAgIC8vIGRyYXcgXCJvdGhlciBjYXRlZ29yaWVzXCJcbiAgICByZXMgKz0gXCJub2RlIFtjb2xvcj1wdXJwbGUsIHN0eWxlPWZpbGxlZF07IFxcblwiO1xuICAgIG90aGVyZG9tYWlucy5mb3JFYWNoKGZ1bmN0aW9uIChvdGhlcmRvbWFpbikge1xuICAgICAgICByZXMgKz0gXCJcXFwiXCIgKyBvdGhlcmRvbWFpbiArIFwiXFxcIiBcXG5cIjtcbiAgICB9KTtcbiAgICAvLyBjb3VudCByZWNvcmRzIGluIGRvbWFpbiA6XG4gICAgdmFyIG5yUmVjb3JkcyA9IG0ucmVjb3Jkcy5yZWR1Y2UoZnVuY3Rpb24gKHByZXYsIGVudHJ5KSB7XG4gICAgICAgIHJldHVybiBwcmV2ICsgKChlbnRyeS5fZG9tYWluID09PSBkb21haW4pID8gMSA6IDApO1xuICAgIH0sIDApO1xuICAgIHJlcyArPSBcIm5vZGUgW3NoYXBlPXJlY29yZF07IFxcblwiO1xuICAgIHJlcyArPSBcIiBcXFwicmVjb3JkXFxcIiBbbGFiZWw9XFxcIns8ZjA+IFwiICsgZG9tYWluICsgXCIgfCBcIiArIG5yUmVjb3JkcyArIFwifVxcXCJdIFxcblwiO1xuICAgIHJlcyArPSBcIiBcXFwicl9vdGhlclxcXCIgW2xhYmVsPVxcXCJ7PGYwPiBvdGhlciB8IFwiICsgbnJSZWNvcmRzICsgXCJ9XFxcIl0gXFxuIFwiO1xuICAgIHJlcyArPSBcIiMgcmVsYXRpb24gZnJvbSBjYXRlZ29yaWVzIHRvIGRvbWFpblxcblwiO1xuICAgIGNhdHMuZm9yRWFjaChmdW5jdGlvbiAoY2F0KSB7XG4gICAgICAgIHJlcyArPSBcIiBcXFwiXCIgKyBjYXQgKyBcIlxcXCIgLT4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiIFxcblwiO1xuICAgIH0pO1xuICAgIHJlcyArPSBcIiMgcmVsYXRpb24gZnJvbSBjYXRlZ29yaWVzIHRvIHJlY29yZHNcXG5cIjtcbiAgICBjYXRzLmZvckVhY2goZnVuY3Rpb24gKGNhdCkge1xuICAgICAgICB2YXIgcmVjID0gY2F0ZWdvcnlSZXN1bHRzW2NhdF07XG4gICAgICAgIHJlcyArPSBcIiBcXFwiXCIgKyBjYXQgKyBcIlxcXCIgLT4gXFxcInJlY29yZFxcXCIgXFxuXCI7XG4gICAgfSk7XG4gICAgLy9vdGhlciBkb21haW5zIHRvIHRoaXNcbiAgICBjYXRzLmZvckVhY2goZnVuY3Rpb24gKGNhdCkge1xuICAgIH0pO1xuICAgIC8qXG4gICAgY2F0cyBmb1xuICAgICAgZGlncmFwaCBzZHN1IHtcbiAgICAgIHNpemU9XCIzNiwzNlwiO1xuICAgICAgbm9kZSBbY29sb3I9eWVsbG93LCBzdHlsZT1maWxsZWRdO1xuICAgICAgRkxQRCBGTFAgXCJCT00gRWRpdG9yXCIsIFwiV0lLSVVSTFwiIFwiVUk1IERvY3VtZW50YXRpb25cIiwgXCJVSTUgRXhhbXBsZVwiLCBcIlNUQVJUVEFcIlxuICAgICAgQkNQXG4gICAgICBub2RlIFtjb2xvcj1ncmV5LCBzdHlsZT1maWxsZWRdO1xuICAgICAgbm9kZSBbZm9udG5hbWU9XCJWZXJkYW5hXCIsIHNpemU9XCIzMCwzMFwiXTtcbiAgICAgIG5vZGUgW2NvbG9yPWdyZXksIHN0eWxlPWZpbGxlZF07XG4gICAgICBncmFwaCBbIGZvbnRuYW1lID0gXCJBcmlhbFwiLFxuICAgICovXG4gICAgcmVzICs9IFwifVxcblwiO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmdyYXBoRG9tYWluID0gZ3JhcGhEb21haW47XG4vKlxuICAgIGNhdGVnb3J5RGVzYyA6IHRoZU1vZGVsLmZ1bGwuZG9tYWluW2ZpbHRlcmRvbWFpbl0uY2F0ZWdvcmllc1tjYXRlZ29yeV0sXG4gICAgZGlzdGluY3QgOiBkaXN0aW5jdCxcbiAgICBkZWx0YSA6IGRlbHRhLFxuICAgIHByZXNlbnRSZWNvcmRzIDogcmVjb3JkQ291bnQucHJlc2VudHJlY29yZHMsXG4gICAgcGVyY1ByZXNlbnQgOiBwZXJjZW50LFxuICAgIHNhbXBsZVZhbHVlcyA6IHZhbHVlc0xpc3RcbiAgfVxuKi9cbmZ1bmN0aW9uIHJlcGxhY2VCcihzdHJpbmcpIHtcbiAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvXFxuL2csIFwiXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0YnJcXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHR8IFwiKTtcbiAgICByZXR1cm4gc3RyaW5nO1xufVxuLyoqXG4gKiBnZW5lcmF0ZSBhIHRleHR1YWwgcmVwcmVzZW50YXRpb24gb2YgYSBkb21haW5cbiAqL1xuZnVuY3Rpb24gdGFiRG9tYWluKGRvbWFpbiwgbSkge1xuICAgIC8vIGRyYXcgYSBtb2RlbCBkb21haW5zXG4gICAgdmFyIGNhdHMgPSBNb2RlbC5nZXRDYXRlZ29yaWVzRm9yRG9tYWluKG0sIGRvbWFpbik7XG4gICAgY2F0cyA9IE1vZGVsLnNvcnRDYXRlZ29yaWVzQnlJbXBvcnRhbmNlKG0uZnVsbC5kb21haW5bZG9tYWluXS5jYXRlZ29yaWVzIHx8IHt9LCBjYXRzKTtcbiAgICAvL2NvbnNvbGUubG9nKGNhdHMuam9pbihcIlxcblwiKSk7XG4gICAgdmFyIGNhdGRlc2MgPSBEZXNjcmliZS5nZXRDYXRlZ29yeVN0YXRzSW5Eb21haW4oY2F0c1swXSwgZG9tYWluLCBtKTtcbiAgICB2YXIgY2F0UmVzdWx0ID0gY2FsY0NhdGVnb3J5UmVjb3JkKG0sIGNhdHNbMF0sIGRvbWFpbik7XG4gICAgdmFyIGRvbWFpbkRlc2NyID0gbS5mdWxsLmRvbWFpbltkb21haW5dLmRlc2NyaXB0aW9uIHx8IFwiXCI7XG4gICAgZG9tYWluRGVzY3IgPSByZXBsYWNlQnIoZG9tYWluRGVzY3IpO1xuICAgIHZhciByZXMgPSBcIlxcblxcbi8vIHByZXNldCBmb3JtIHZhbHVlcyBpZiB3ZSByZWNlaXZlIGEgdXNlcmRhdGEgb2JqZWN0IC8vXFxuLSB1c2VyID0gdXNlclxcblxcbmV4dGVuZHMgLi4vbGF5b3V0X3BcXG5cXG5ibG9jayBjb250ZW50XFxuXFxuXFx0bmF2Lm5hdmJhci5uYXZiYXItZGVmYXVsdC5uYXZiYXItZml4ZWQtdG9wXFxuXFx0XFx0LmNvbnRhaW5lclxcblxcdFxcdFxcdC5uYXZiYXItaGVhZGVyXFxuXFx0XFx0XFx0XFx0Lm5hdmJhci1icmFuZChzdHlsZT0nYmdjb2xvcjpvcmFuZ2U7Y29sb3I6ZGFya2JsdWU7Zm9udC1mYW1pbHk6QXJpYWwgQmxhY2s7Zm9udC1zaXplOjE1LjExOHB4Jykgd29zYXAgZG9tYWluIFwiICsgZG9tYWluICsgXCJcXG5cXHRcXHRcXHR1bC5uYXYubmF2YmFyLW5hdi5uYXZiYXItcmlnaHQgI3t1aWR9XFxuXFx0XFx0XFx0XFx0bGlcXG5cXHRcXHRcXHRcXHRcXHQubmF2YmFyLWJ0biNidG4tbG9nb3V0LmJ0bi5idG4tZGVmYXVsdChvbmNsaWNrPVxcXCJsb2NhdGlvbi5ocmVmPScvaG9tZSdcXFwiKVxcblxcdFxcdFxcdFxcdFxcdFxcdHwgYmFjayB0byBob21lXFxuXFxuXFx0cCAgJm5ic3A7XFxuXFx0cCAmbmJzcDtcXG5cXHRwXFxuXFxuXFx0ZGl2LndlbGxcXG5cXHRcXHRoMyBkb21haW4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiXFxuXFx0XFx0XFx0c3Bhbi5wdWxsLXJpZ2h0IFwiICsgY2F0UmVzdWx0Lm5yVG90YWxSZWNvcmRzSW5Eb21haW4gKyBcIiByZWNvcmRzXFxuXFx0XFx0cFxcblxcdFxcdHNwYW4gXCIgKyBkb21haW5EZXNjciArIFwiXFxuXFxuXFx0XFx0dGFibGUudGFibGUudGFibGUtY29uZGVuc2VkLnRhYmxlLXN0cmlwZWRcXG5cXHRcXHRcXHR0aGVhZFxcblxcdFxcdFxcdFxcdHRyXFxuXFx0XFx0XFx0XFx0XFx0dGggY2F0ZWdvcnlcXG5cXHRcXHRcXHRcXHRcXHR0aChzdHlsZT1cXFwid2lkdGg6MTAlXFxcIikgY291bnRcXG5cXHRcXHRcXHRcXHRcXHR0aFxcblxcdFxcdFxcdFxcdFxcdFxcdHRhYmxlXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0dHJcXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHRcXHR0ZCBzeW5vbnltc1xcblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgZGVzY3JpcHRpb25cXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHR0clxcblxcdFxcdFxcdFxcdFxcdFxcdFxcdFxcdHRkIGV4YW1wbGUgdmFsdWVzXFxuXFx0XFx0XFx0dGJvZHlcXG5cIjtcbiAgICB2YXIgY2F0ZWdvcnlSZXN1bHRzID0ge307XG4gICAgdmFyIG90aGVyZG9tYWlucyA9IFtdO1xuICAgIHZhciBjYXRlZ29yeU1hcCA9IG0uZnVsbC5kb21haW5bZG9tYWluXS5jYXRlZ29yaWVzIHx8IHt9O1xuICAgIGNhdHMuZm9yRWFjaChmdW5jdGlvbiAoY2F0KSB7XG4gICAgICAgIHZhciBjYXRkZXNjID0gRGVzY3JpYmUuZ2V0Q2F0ZWdvcnlTdGF0c0luRG9tYWluKGNhdCwgZG9tYWluLCBtKTtcbiAgICAgICAgLy9jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShjYXRkZXNjKSk7XG4gICAgICAgIHZhciBjYXRSZXN1bHQgPSBjYWxjQ2F0ZWdvcnlSZWNvcmQobSwgY2F0LCBkb21haW4pO1xuICAgICAgICBjYXRlZ29yeVJlc3VsdHNbY2F0XSA9IGNhdFJlc3VsdDtcbiAgICAgICAgb3RoZXJkb21haW5zID0gXy51bmlvbihvdGhlcmRvbWFpbnMsIGNhdGVnb3J5UmVzdWx0c1tjYXRdLm90aGVyRG9tYWlucyk7XG4gICAgICAgIC8qXG4gICAgICAgICAgICByZXMgKz0gYFwiJHtjYXR9XCIgW2xhYmVsPVwieyAke2NhdH0gfCAke2NhdFJlc3VsdC5uckRpc3RpbmN0VmFsdWVzSW5Eb21haW59IFZhbHVlcyBpbiAke2NhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbn0gYDtcbiAgICAgICAgICAgIGlmKGNhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbiAhPT0gY2F0UmVzdWx0Lm5yUmVjb3Jkcykge1xuICAgICAgICAgICAgICByZXMgKz0gIGB8ICAke2NhdFJlc3VsdC5uckRpc3RpbmN0VmFsdWVzIC0gY2F0UmVzdWx0Lm5yRGlzdGluY3RWYWx1ZXNJbkRvbWFpbn0gb3RoZXIgdmFsdWVzIGluICR7Y2F0UmVzdWx0Lm5yUmVjb3JkcyAtIGNhdFJlc3VsdC5uclJlY29yZHNJbkRvbWFpbn0gb3RoZXIgcmVjb3Jkc2A7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXMgKz0gYCBgO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzICs9IGB9XCJdXFxuYDtcbiAgICAgICAgKi9cbiAgICAgICAgLy9jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShtLmZ1bGwuZG9tYWluW2RvbWFpbl0pKTtcbiAgICAgICAgaWYgKG0uZnVsbC5kb21haW5bZG9tYWluXS5jYXRlZ29yaWVzW2NhdF0pIHtcbiAgICAgICAgICAgIHZhciBzeW5vbnltc1N0cmluZyA9IFV0aWwubGlzdFRvQ29tbWFBbmQoY2F0ZGVzYy5jYXRlZ29yeURlc2MgJiYgY2F0ZGVzYy5jYXRlZ29yeURlc2Muc3lub255bXMgJiYgY2F0ZGVzYy5jYXRlZ29yeURlc2Muc3lub255bXMgfHwgW10pIHx8IFwiJm5ic3A7XCI7XG4gICAgICAgICAgICByZXMgKz0gXCJcXG5cXHRcXHRcXHR0clxcblxcdFxcdFxcdFxcdFxcdHRkLmNhdF9jb3VudCBcIiArIGNhdCArIFwiXFxuXFx0XFx0XFx0XFx0XFx0dGQgXCIgKyBjYXRkZXNjLnByZXNlbnRSZWNvcmRzICsgXCIgZGlzdGluY3QgdmFsdWVzIGluIFwiICsgY2F0ZGVzYy5wZXJjUHJlc2VudCArIFwiJSBvZiByZWNvcmRzXFxuXFx0XFx0XFx0XFx0XFx0dGRcXG5cXHRcXHRcXHRcXHRcXHRcXHR0YWJsZVxcblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyLmNhdF9zeW5vbnltc1xcblxcdFxcdFxcdFxcdFxcdFxcdFxcdFxcdHRkIFwiICsgc3lub255bXNTdHJpbmcgKyBcIlxcblxcdFxcdFxcdFxcdFxcdFxcdFxcdHRyLmNhdF9kZXNjcmlwdGlvblxcblxcdFxcdFxcdFxcdFxcdFxcdFxcdFxcdHRkIFwiICsgcmVwbGFjZUJyKGNhdGRlc2MuY2F0ZWdvcnlEZXNjICYmIGNhdGRlc2MuY2F0ZWdvcnlEZXNjLmRlc2NyaXB0aW9uIHx8IFwiXCIpICsgXCJcXG5cXHRcXHRcXHRcXHRcXHRcXHRcXHR0ci5jYXRfc2FtcGxldmFsdWVzXFxuXFx0XFx0XFx0XFx0XFx0XFx0XFx0XFx0dGQgXCIgKyByZXBsYWNlQnIoY2F0ZGVzYy5zYW1wbGVWYWx1ZXMpICsgXCJcXG4gICAgICBcIjtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHZhciBvdGhlcmNhdHMgPSBjYXRzLmxlbmd0aCAtIE9iamVjdC5rZXlzKG0uZnVsbC5kb21haW5bZG9tYWluXS5jYXRlZ29yaWVzKS5sZW5ndGg7XG4gICAgdmFyIHJlbWFpbmluZ0NhdGVnb3JpZXMgPSBfLmRpZmZlcmVuY2UoY2F0cywgT2JqZWN0LmtleXMobS5mdWxsLmRvbWFpbltkb21haW5dLmNhdGVnb3JpZXMpKTtcbiAgICBpZiAoKG90aGVyY2F0cykgPiAwKSB7XG4gICAgICAgIHJlcyArPSBcIlxcblxcdFxcdHAgICBhbmQgXCIgKyBvdGhlcmNhdHMgKyBcIiBvdGhlciBjYXRlZ29yaWVzXFxuICAgIHwgXCIgKyBVdGlsLmxpc3RUb0NvbW1hQW5kKHJlbWFpbmluZ0NhdGVnb3JpZXMpICsgXCJcXG4gICAgICAgXCI7XG4gICAgfVxuICAgIC8qXG4gICAgICAvLyBjYWxjdWxhdGUgb3RoZXIgZG9tYWlucy5cbiAgICAgIC8vIGRyYXcgXCJvdGhlciBjYXRlZ29yaWVzXCJcbiAgICAgIHJlcyArPSBgbm9kZSBbY29sb3I9cHVycGxlLCBzdHlsZT1maWxsZWRdOyBcXG5gXG4gICAgICBvdGhlcmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbihvdGhlcmRvbWFpbikge1xuICAgICAgICByZXMgKz0gYFwiJHtvdGhlcmRvbWFpbn1cIiBcXG5gO1xuICAgICAgfSk7XG4gICAgICAvLyBjb3VudCByZWNvcmRzIGluIGRvbWFpbiA6XG4gICAgICB2YXIgbnJSZWNvcmRzID0gbS5yZWNvcmRzLnJlZHVjZShmdW5jdGlvbihwcmV2LGVudHJ5KSB7XG4gICAgICByZXR1cm4gcHJldiArICgoZW50cnkuX2RvbWFpbiA9PT0gZG9tYWluKSA/IDEgOiAwKTtcbiAgICAgIH0sMCk7XG4gICAgICByZXMgKz0gYG5vZGUgW3NoYXBlPXJlY29yZF07IFxcbmBcbiAgICAgIHJlcyArPSBgIFwicmVjb3JkXCIgW2xhYmVsPVwiezxmMD4gJHtkb21haW59IHwgJHtuclJlY29yZHN9fVwiXSBcXG5gO1xuICAgIFxuICAgICAgcmVzICs9IGAgXCJyX290aGVyXCIgW2xhYmVsPVwiezxmMD4gb3RoZXIgfCAke25yUmVjb3Jkc319XCJdIFxcbiBgO1xuICAgIFxuICAgICAgcmVzICs9IGAjIHJlbGF0aW9uIGZyb20gY2F0ZWdvcmllcyB0byBkb21haW5cXG5gO1xuICAgICAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuICAgICAgICByZXMgKz0gYCBcIiR7Y2F0fVwiIC0+IFwiJHtkb21haW59XCIgXFxuYDtcbiAgICAgIH0pXG4gICAgXG4gICAgXG4gICAgICByZXMgKz0gYCMgcmVsYXRpb24gZnJvbSBjYXRlZ29yaWVzIHRvIHJlY29yZHNcXG5gO1xuICAgICAgY2F0cy5mb3JFYWNoKGZ1bmN0aW9uKGNhdCkge1xuICAgICAgICB2YXIgcmVjID0gY2F0ZWdvcnlSZXN1bHRzW2NhdF07XG4gICAgICAgIHJlcyArPSBgIFwiJHtjYXR9XCIgLT4gXCJyZWNvcmRcIiBcXG5gO1xuICAgICAgfSlcbiAgICBcbiAgICBcbiAgICAgIC8vb3RoZXIgZG9tYWlucyB0byB0aGlzXG4gICAgICBjYXRzLmZvckVhY2goZnVuY3Rpb24oY2F0KSB7XG4gICAgXG4gICAgXG4gICAgICB9KVxuICAgICovXG4gICAgLypcbiAgICBjYXRzIGZvXG4gICAgICBkaWdyYXBoIHNkc3Uge1xuICAgICAgc2l6ZT1cIjM2LDM2XCI7XG4gICAgICBub2RlIFtjb2xvcj15ZWxsb3csIHN0eWxlPWZpbGxlZF07XG4gICAgICBGTFBEIEZMUCBcIkJPTSBFZGl0b3JcIiwgXCJXSUtJVVJMXCIgXCJVSTUgRG9jdW1lbnRhdGlvblwiLCBcIlVJNSBFeGFtcGxlXCIsIFwiU1RBUlRUQVwiXG4gICAgICBCQ1BcbiAgICAgIG5vZGUgW2NvbG9yPWdyZXksIHN0eWxlPWZpbGxlZF07XG4gICAgICBub2RlIFtmb250bmFtZT1cIlZlcmRhbmFcIiwgc2l6ZT1cIjMwLDMwXCJdO1xuICAgICAgbm9kZSBbY29sb3I9Z3JleSwgc3R5bGU9ZmlsbGVkXTtcbiAgICAgIGdyYXBoIFsgZm9udG5hbWUgPSBcIkFyaWFsXCIsXG4gICAgKi9cbiAgICByZXMgKz0gXCJcXG5cXHRcXHRoMyBWZXJzaW9uXFxuXFx0XFx0XFx0YS5zbWFsbChocmVmPVxcXCIvd2hhdHNuZXdcXFwiKVxcblxcblxcbmJsb2NrIHNjcmlwdHNcXG5cXHRzY3JpcHQoc3JjPScvdmVuZG9yL2pxdWVyeS0yLjIuMy5taW4uanMnKVxcblxcdHNjcmlwdChzcmM9Jy92ZW5kb3IvYm9vdHN0cmFwLm1pbi5qcycpXFxuXFx0c2NyaXB0KHNyYz0nL2pzL3ZpZXdzL3NldHRpbmdzLmpzJylcXG5cIjtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy50YWJEb21haW4gPSB0YWJEb21haW47XG52YXIgY2hpbGRfcHJvY2Vzc18xID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuZnVuY3Rpb24gZXhlY0NtZChjbWQpIHtcbiAgICBjaGlsZF9wcm9jZXNzXzEuZXhlYyhjbWQsIGZ1bmN0aW9uIChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiZXhlYyBlcnJvcjogXCIgKyBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJzdGRvdXQ6IFwiICsgc3Rkb3V0KTtcbiAgICAgICAgY29uc29sZS5sb2coXCJzdGRlcnI6IFwiICsgc3RkZXJyKTtcbiAgICB9KTtcbn1cbjtcbmZ1bmN0aW9uIHZpc01vZGVscyhtLCBmb2xkZXJPdXQpIHtcbiAgICBtLmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoc0RvbWFpbikge1xuICAgICAgICB2YXIgcyA9IGdyYXBoRG9tYWluKHNEb21haW4sIG0pO1xuICAgICAgICB2YXIgZm5HcmFwaCA9IGZvbGRlck91dCArIFwiL1wiICsgc0RvbWFpbi5yZXBsYWNlKC8gL2csICdfJykgKyBcIi5ndlwiO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZuR3JhcGgsIHMpO1xuICAgICAgICBpZiAocHJvY2Vzcy5lbnYuR1JBUEhWSVopIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgZmlsZSBcIiArIGZuR3JhcGgpO1xuICAgICAgICAgICAgZXhlY0NtZChwcm9jZXNzLmVudi5HUkFQSFZJWiArIFwiIC1UanBlZyAtTyBcIiArIGZuR3JhcGgpO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5leHBvcnRzLnZpc01vZGVscyA9IHZpc01vZGVscztcbmZ1bmN0aW9uIHRhYk1vZGVscyhtLCBmb2xkZXJPdXQpIHtcbiAgICBtLmRvbWFpbnMuZm9yRWFjaChmdW5jdGlvbiAoc0RvbWFpbikge1xuICAgICAgICB2YXIgcyA9IHRhYkRvbWFpbihzRG9tYWluLCBtKTtcbiAgICAgICAgdmFyIGZuR3JhcGggPSBmb2xkZXJPdXQgKyBcIi9cIiArIHNEb21haW4ucmVwbGFjZSgvIC9nLCAnXycpICsgXCIuamFkZVwiO1xuICAgICAgICBkZWJ1Z2xvZyhcImhlcmUgdGhlIGZpbGUgXCIgKyBmbkdyYXBoKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmbkdyYXBoLCBzKTtcbiAgICB9KTtcbn1cbmV4cG9ydHMudGFiTW9kZWxzID0gdGFiTW9kZWxzO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
