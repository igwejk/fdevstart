/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var InputFilter = require('./inputFilter');
var Algol = require('./algol');
var debug = require('debug');
var debuglog = debug('listall');
var logger = require('../utils/logger');
var logPerf = logger.perf("perflistall");
var perflog = debug('perf');
var BreakDown = require('./breakdown');
var Sentence = require('./sentence');
var Operator = require('./operator');
var WhatIs = require('./whatis');
var Model = require('../model/model');
var sWords = {};
function matchRecordHavingCategory(category, records) {
    debuglog(debuglog.enabled ? JSON.stringify(records, undefined, 2) : "-");
    var relevantRecords = records.filter(function (record) {
        return record[category] !== undefined && record[category] !== null;
    });
    var res = [];
    debuglog("relevant records nr:" + relevantRecords.length);
    return relevantRecords;
}
exports.matchRecordHavingCategory = matchRecordHavingCategory;
function analyzeContextString(contextQueryString, rules) {
    var matched = InputFilter.analyzeString(contextQueryString, rules, sWords);
    if (debuglog.enabled) {
        debuglog("After matched " + JSON.stringify(matched));
    }
    var aSentences = InputFilter.expandMatchArr(matched);
    if (debuglog.enabled) {
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    var aSentencesReinforced = InputFilter.reinForce(aSentences);
    if (debuglog.enabled) {
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    // we limit analysis to n sentences
    var aSentencesReinforced = aSentencesReinforced.slice(0, Algol.Cutoff_Sentences);
    return aSentencesReinforced;
}
exports.analyzeContextString = analyzeContextString;
// const result = WhatIs.resolveCategory(cat, a1.entity,
//   theModel.mRules, theModel.tools, theModel.records);
function listAllWithContext(category, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        logPerf('listAllWithContext');
        perflog("totalListAllWithContext");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records (s=" + aSentencesReinforced.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsQuick(aSentencesReinforced, category, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filtering topRanked (a=" + matchedAnswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllWithContext (a=" + matchedFiltered.length + ")");
        logPerf('listAllWithContext');
        return matchedFiltered; // ??? Answers;
    }
}
exports.listAllWithContext = listAllWithContext;
function listAllHavingContext(category, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        perflog("analyzeContextString ...");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records having (s=" + aSentencesReinforced.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsHavingContext(aSentencesReinforced, category, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filteringTopRanked (a=" + matchedAnswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllHavingContext (a=" + matchedFiltered.length + ")");
        return matchedFiltered;
    }
}
exports.listAllHavingContext = listAllHavingContext;
function filterStringListByOp(operator, fragment, srcarr) {
    var fragmentLC = BreakDown.trimQuotedSpaced(fragment.toLowerCase());
    return srcarr.filter(function (str) {
        return Operator.matches(operator, fragmentLC, str.toLowerCase());
    }).sort();
}
exports.filterStringListByOp = filterStringListByOp;
function compareCaseInsensitive(a, b) {
    var r = a.toLowerCase().localeCompare(b.toLowerCase());
    if (r) {
        return r;
    }
    return -a.localeCompare(b);
}
/**
 * Sort string list case insensitive, then remove duplicates retaining
 * "largest" match
 */
function removeCaseDuplicates(arr) {
    arr.sort(compareCaseInsensitive);
    debuglog('sorted arr' + JSON.stringify(arr));
    return arr.filter(function (s, index) {
        return index === 0 || 0 !== arr[index - 1].toLowerCase().localeCompare(s.toLowerCase());
    });
}
exports.removeCaseDuplicates = removeCaseDuplicates;
;
function getCategoryOpFilterAsDistinctStrings(operator, fragment, category, records) {
    var fragmentLC = BreakDown.trimQuoted(fragment.toLowerCase());
    var res = [];
    var seen = {};
    records.forEach(function (record) {
        if (record[category] && Operator.matches(operator, fragmentLC, record[category].toLowerCase())) {
            if (!seen[record[category]]) {
                seen[record[category]] = true;
                res.push(record[category]);
            }
        }
    });
    return removeCaseDuplicates(res);
}
exports.getCategoryOpFilterAsDistinctStrings = getCategoryOpFilterAsDistinctStrings;
;
function likelyPluralDiff(a, pluralOfa) {
    var aLC = BreakDown.trimQuoted(a.toLowerCase()) || "";
    var pluralOfALC = BreakDown.trimQuoted((pluralOfa || "").toLowerCase()) || "";
    if (aLC === pluralOfALC) {
        return true;
    }
    if (aLC + 's' === pluralOfALC) {
        return true;
    }
    return false;
}
exports.likelyPluralDiff = likelyPluralDiff;
;
function listAllWithCategory(category, records) {
    var matchedAnswers = matchRecordHavingCategory(category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
    debuglog(" listAllWithCategory:" + JSON.stringify(matchedAnswers, undefined, 2));
    return matchedAnswers;
}
exports.listAllWithCategory = listAllWithCategory;
function joinSortedQuoted(strings) {
    if (strings.length === 0) {
        return "";
    }
    return '"' + strings.sort().join('"; "') + '"';
}
exports.joinSortedQuoted = joinSortedQuoted;
function joinDistinct(category, records) {
    var res = records.reduce(function (prev, oRecord) {
        prev[oRecord[category]] = 1;
        return prev;
    }, {});
    return joinSortedQuoted(Object.keys(res));
}
exports.joinDistinct = joinDistinct;
function formatDistinctFromWhatIfResult(answers) {
    return joinSortedQuoted(answers.map(function (oAnswer) {
        return oAnswer.result;
    }));
}
exports.formatDistinctFromWhatIfResult = formatDistinctFromWhatIfResult;
function joinResults(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            if (res.indexOf(result.result) < 0) {
                res.push(result.result);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResults = joinResults;
function inferDomain(theModel, contextQueryString) {
    // console.log("here the string" + contextQueryString);
    //  console.log("here the rules" + JSON.stringify(theModel.mRules));
    var res = analyzeContextString(contextQueryString, theModel.rules);
    //console.log(JSON.stringify(res,undefined,2));
    // run through the string, search for a category
    if (!res.length) {
        return undefined;
    }
    var domains = [];
    // do we have a domain ?
    res[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "domain") {
            domains.push(oWordGroup.matchedString);
        }
    });
    if (domains.length === 1) {
        return domains[0];
    }
    if (domains.length > 0) {
        return undefined;
    }
    // try a category reverse map
    res[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "category") {
            var sCat = oWordGroup.matchedString;
            var doms = Model.getDomainsForCategory(theModel, sCat);
            doms.forEach(function (sDom) {
                if (domains.indexOf(sDom) < 0) {
                    domains.push(sDom);
                }
            });
        }
    });
    if (domains.length === 1) {
        return domains[0];
    }
    return undefined;
}
exports.inferDomain = inferDomain;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9saXN0YWxsLnRzIiwibWF0Y2gvbGlzdGFsbC5qcyJdLCJuYW1lcyI6WyJJbnB1dEZpbHRlciIsInJlcXVpcmUiLCJBbGdvbCIsImRlYnVnIiwiZGVidWdsb2ciLCJsb2dnZXIiLCJsb2dQZXJmIiwicGVyZiIsInBlcmZsb2ciLCJCcmVha0Rvd24iLCJTZW50ZW5jZSIsIk9wZXJhdG9yIiwiV2hhdElzIiwiTW9kZWwiLCJzV29yZHMiLCJtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5IiwiY2F0ZWdvcnkiLCJyZWNvcmRzIiwiZW5hYmxlZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJ1bmRlZmluZWQiLCJyZWxldmFudFJlY29yZHMiLCJmaWx0ZXIiLCJyZWNvcmQiLCJyZXMiLCJsZW5ndGgiLCJleHBvcnRzIiwiYW5hbHl6ZUNvbnRleHRTdHJpbmciLCJjb250ZXh0UXVlcnlTdHJpbmciLCJydWxlcyIsIm1hdGNoZWQiLCJhbmFseXplU3RyaW5nIiwiYVNlbnRlbmNlcyIsImV4cGFuZE1hdGNoQXJyIiwibWFwIiwib1NlbnRlbmNlIiwicmFua2luZ1Byb2R1Y3QiLCJqb2luIiwiYVNlbnRlbmNlc1JlaW5mb3JjZWQiLCJyZWluRm9yY2UiLCJzbGljZSIsIkN1dG9mZl9TZW50ZW5jZXMiLCJsaXN0QWxsV2l0aENvbnRleHQiLCJhUnVsZXMiLCJjYXRlZ29yeVNldCIsIm1hdGNoZWRBbnN3ZXJzIiwibWF0Y2hSZWNvcmRzUXVpY2siLCJtYXRjaGVkRmlsdGVyZWQiLCJmaWx0ZXJPbmx5VG9wUmFua2VkIiwibGlzdEFsbEhhdmluZ0NvbnRleHQiLCJtYXRjaFJlY29yZHNIYXZpbmdDb250ZXh0IiwiZmlsdGVyU3RyaW5nTGlzdEJ5T3AiLCJvcGVyYXRvciIsImZyYWdtZW50Iiwic3JjYXJyIiwiZnJhZ21lbnRMQyIsInRyaW1RdW90ZWRTcGFjZWQiLCJ0b0xvd2VyQ2FzZSIsInN0ciIsIm1hdGNoZXMiLCJzb3J0IiwiY29tcGFyZUNhc2VJbnNlbnNpdGl2ZSIsImEiLCJiIiwiciIsImxvY2FsZUNvbXBhcmUiLCJyZW1vdmVDYXNlRHVwbGljYXRlcyIsImFyciIsInMiLCJpbmRleCIsImdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyIsInRyaW1RdW90ZWQiLCJzZWVuIiwiZm9yRWFjaCIsInB1c2giLCJsaWtlbHlQbHVyYWxEaWZmIiwicGx1cmFsT2ZhIiwiYUxDIiwicGx1cmFsT2ZBTEMiLCJsaXN0QWxsV2l0aENhdGVnb3J5Iiwiam9pblNvcnRlZFF1b3RlZCIsInN0cmluZ3MiLCJqb2luRGlzdGluY3QiLCJyZWR1Y2UiLCJwcmV2Iiwib1JlY29yZCIsIk9iamVjdCIsImtleXMiLCJmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQiLCJhbnN3ZXJzIiwib0Fuc3dlciIsInJlc3VsdCIsImpvaW5SZXN1bHRzIiwicmVzdWx0cyIsImNudCIsIl9yYW5raW5nIiwiaW5kZXhPZiIsImluZmVyRG9tYWluIiwidGhlTW9kZWwiLCJkb21haW5zIiwib1dvcmRHcm91cCIsIm1hdGNoZWRTdHJpbmciLCJzQ2F0IiwiZG9tcyIsImdldERvbWFpbnNGb3JDYXRlZ29yeSIsInNEb20iXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUNNQTs7QURFQSxJQUFZQSxjQUFXQyxRQUFNLGVBQU4sQ0FBdkI7QUFFQSxJQUFZQyxRQUFLRCxRQUFNLFNBQU4sQ0FBakI7QUFDQSxJQUFZRSxRQUFLRixRQUFNLE9BQU4sQ0FBakI7QUFFQSxJQUFNRyxXQUFXRCxNQUFNLFNBQU4sQ0FBakI7QUFDQSxJQUFZRSxTQUFNSixRQUFNLGlCQUFOLENBQWxCO0FBQ0EsSUFBSUssVUFBVUQsT0FBT0UsSUFBUCxDQUFZLGFBQVosQ0FBZDtBQUNBLElBQUlDLFVBQVVMLE1BQU0sTUFBTixDQUFkO0FBUUEsSUFBWU0sWUFBU1IsUUFBTSxhQUFOLENBQXJCO0FBRUEsSUFBWVMsV0FBUVQsUUFBTSxZQUFOLENBQXBCO0FBR0EsSUFBWVUsV0FBUVYsUUFBTSxZQUFOLENB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anMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBhbmFseXplLnRzXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblxuXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlciBmcm9tICcuL2lucHV0RmlsdGVyJztcblxuaW1wb3J0ICogYXMgQWxnb2wgZnJvbSAnLi9hbGdvbCc7XG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ2xpc3RhbGwnKTtcbmltcG9ydCAqIGFzIGxvZ2dlciBmcm9tICcuLi91dGlscy9sb2dnZXInO1xudmFyIGxvZ1BlcmYgPSBsb2dnZXIucGVyZihcInBlcmZsaXN0YWxsXCIpO1xudmFyIHBlcmZsb2cgPSBkZWJ1ZygncGVyZicpO1xuLy9jb25zdCBwZXJmbG9nID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcblxuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJztcblxuaW1wb3J0ICogYXMgVG9vbG1hdGNoZXIgZnJvbSAnLi90b29sbWF0Y2hlcic7XG5pbXBvcnQgKiBhcyBCcmVha0Rvd24gZnJvbSAnLi9icmVha2Rvd24nO1xuXG5pbXBvcnQgKiBhcyBTZW50ZW5jZSBmcm9tICcuL3NlbnRlbmNlJztcblxuaW1wb3J0ICogYXMgV29yZCBmcm9tICcuL3dvcmQnO1xuaW1wb3J0ICogYXMgT3BlcmF0b3IgZnJvbSAnLi9vcGVyYXRvcic7XG5cbmltcG9ydCAqIGFzIFdoYXRJcyBmcm9tICcuL3doYXRpcyc7XG5cbmltcG9ydCAqIGFzIE1vZGVsIGZyb20gJy4uL21vZGVsL21vZGVsJztcbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4vbWF0Y2gnO1xuXG52YXIgc1dvcmRzID0ge307XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5OiBzdHJpbmcsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPilcbiAgOiBBcnJheTxJTWF0Y2guSVJlY29yZD4ge1xuICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gSlNPTi5zdHJpbmdpZnkocmVjb3Jkcyx1bmRlZmluZWQsMikgOiBcIi1cIik7XG4gIHZhciByZWxldmFudFJlY29yZHMgPSByZWNvcmRzLmZpbHRlcihmdW5jdGlvbiAocmVjb3JkOiBJTWF0Y2guSVJlY29yZCkge1xuICAgIHJldHVybiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gdW5kZWZpbmVkKSAmJiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gbnVsbCk7XG4gIH0pO1xuICB2YXIgcmVzID0gW107XG4gIGRlYnVnbG9nKFwicmVsZXZhbnQgcmVjb3JkcyBucjpcIiArIHJlbGV2YW50UmVjb3Jkcy5sZW5ndGgpO1xuICByZXR1cm4gcmVsZXZhbnRSZWNvcmRzO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcgOiBzdHJpbmcsICBydWxlczogSU1hdGNoLlNwbGl0UnVsZXMpIHtcbiAgICB2YXIgbWF0Y2hlZCA9IElucHV0RmlsdGVyLmFuYWx5emVTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBydWxlcywgc1dvcmRzKTtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkKSk7XG4gICAgfVxuICAgIHZhciBhU2VudGVuY2VzID0gSW5wdXRGaWx0ZXIuZXhwYW5kTWF0Y2hBcnIobWF0Y2hlZCk7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMpO1xuICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICAvLyB3ZSBsaW1pdCBhbmFseXNpcyB0byBuIHNlbnRlbmNlc1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFTZW50ZW5jZXNSZWluZm9yY2VkLnNsaWNlKDAsIEFsZ29sLkN1dG9mZl9TZW50ZW5jZXMpO1xuICAgIHJldHVybiBhU2VudGVuY2VzUmVpbmZvcmNlZDtcbn1cblxuLy8gY29uc3QgcmVzdWx0ID0gV2hhdElzLnJlc29sdmVDYXRlZ29yeShjYXQsIGExLmVudGl0eSxcbi8vICAgdGhlTW9kZWwubVJ1bGVzLCB0aGVNb2RlbC50b29scywgdGhlTW9kZWwucmVjb3Jkcyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0QWxsV2l0aENvbnRleHQoY2F0ZWdvcnk6IHN0cmluZywgY29udGV4dFF1ZXJ5U3RyaW5nOiBzdHJpbmcsXG4gIGFSdWxlczogSU1hdGNoLlNwbGl0UnVsZXMsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPiwgY2F0ZWdvcnlTZXQ/OiB7IFtrZXkgOiBzdHJpbmddIDogYm9vbGVhbiB9KTogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+IHtcbiAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH0gZWxzZSB7XG4gICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0XCIpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyAocz1cIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzUXVpY2soYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3J5LCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpe1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJmaWx0ZXJpbmcgdG9wUmFua2VkIChhPVwiICsgbWF0Y2hlZEFuc3dlcnMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgIHZhciBtYXRjaGVkRmlsdGVyZWQgPSBXaGF0SXMuZmlsdGVyT25seVRvcFJhbmtlZChtYXRjaGVkQW5zd2Vycyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgIHJldHVybiBtYXRjaGVkRmlsdGVyZWQ7IC8vID8/PyBBbnN3ZXJzO1xuICB9XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxIYXZpbmdDb250ZXh0KGNhdGVnb3J5OiBzdHJpbmcsIGNvbnRleHRRdWVyeVN0cmluZzogc3RyaW5nLFxuICBhUnVsZXM6IElNYXRjaC5TcGxpdFJ1bGVzLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4sXG4gIGNhdGVnb3J5U2V0IDogeyBba2V5OnN0cmluZ10gOiBib29sZWFuIH0pOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4ge1xuICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfSBlbHNlIHtcbiAgICBwZXJmbG9nKFwiYW5hbHl6ZUNvbnRleHRTdHJpbmcgLi4uXCIpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyBoYXZpbmcgKHM9XCIgKyAoYVNlbnRlbmNlc1JlaW5mb3JjZWQubGVuZ3RoKSArIFwiKS4uLlwiKTtcbiAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzSGF2aW5nQ29udGV4dChhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcnksIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJmaWx0ZXJpbmdUb3BSYW5rZWQgKGE9XCIgKyBtYXRjaGVkQW5zd2Vycy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxIYXZpbmdDb250ZXh0IChhPVwiICsgbWF0Y2hlZEZpbHRlcmVkLmxlbmd0aCArIFwiKVwiKTtcbiAgICByZXR1cm4gbWF0Y2hlZEZpbHRlcmVkO1xuICB9XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbHRlclN0cmluZ0xpc3RCeU9wKG9wZXJhdG9yOiBJTWF0Y2guSU9wZXJhdG9yLCBmcmFnbWVudCA6IHN0cmluZywgIHNyY2FyciA6IHN0cmluZ1tdICkgOiBzdHJpbmdbXSB7XG4gIHZhciBmcmFnbWVudExDID0gQnJlYWtEb3duLnRyaW1RdW90ZWRTcGFjZWQoZnJhZ21lbnQudG9Mb3dlckNhc2UoKSk7XG4gIHJldHVybiBzcmNhcnIuZmlsdGVyKGZ1bmN0aW9uKHN0cikge1xuICAgIHJldHVybiBPcGVyYXRvci5tYXRjaGVzKG9wZXJhdG9yLCBmcmFnbWVudExDLCBzdHIudG9Mb3dlckNhc2UoKSk7XG4gIH0pLnNvcnQoKTtcbn1cblxuZnVuY3Rpb24gY29tcGFyZUNhc2VJbnNlbnNpdGl2ZShhOiBzdHJpbmcsIGIgOiBzdHJpbmcpIHtcbiAgdmFyIHIgPSBhLnRvTG93ZXJDYXNlKCkubG9jYWxlQ29tcGFyZShiLnRvTG93ZXJDYXNlKCkpO1xuICBpZiAocikge1xuICAgIHJldHVybiByO1xuICB9XG4gIHJldHVybiAtYS5sb2NhbGVDb21wYXJlKGIpO1xufVxuXG4vKipcbiAqIFNvcnQgc3RyaW5nIGxpc3QgY2FzZSBpbnNlbnNpdGl2ZSwgdGhlbiByZW1vdmUgZHVwbGljYXRlcyByZXRhaW5pbmdcbiAqIFwibGFyZ2VzdFwiIG1hdGNoXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVDYXNlRHVwbGljYXRlcyhhcnIgOiBzdHJpbmdbXSkgOiBzdHJpbmdbXSB7XG4gIGFyci5zb3J0KGNvbXBhcmVDYXNlSW5zZW5zaXRpdmUpO1xuICBkZWJ1Z2xvZygnc29ydGVkIGFycicgKyBKU09OLnN0cmluZ2lmeShhcnIpKTtcbiAgcmV0dXJuIGFyci5maWx0ZXIoZnVuY3Rpb24ocywgaW5kZXgpIHtcbiAgICByZXR1cm4gaW5kZXggPT09IDAgfHwgKDAgIT09IGFycltpbmRleCAtMSBdLnRvTG93ZXJDYXNlKCkubG9jYWxlQ29tcGFyZShzLnRvTG93ZXJDYXNlKCkpKTtcbiAgfSk7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2F0ZWdvcnlPcEZpbHRlckFzRGlzdGluY3RTdHJpbmdzKG9wZXJhdG9yOiBJTWF0Y2guSU9wZXJhdG9yLCBmcmFnbWVudCA6IHN0cmluZyxcbiAgY2F0ZWdvcnkgOiBzdHJpbmcsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPikgOiBzdHJpbmdbXSB7XG4gICAgdmFyIGZyYWdtZW50TEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZChmcmFnbWVudC50b0xvd2VyQ2FzZSgpKTtcbiAgICB2YXIgcmVzID0gW107XG4gICAgdmFyIHNlZW4gPSB7fTtcbiAgICByZWNvcmRzLmZvckVhY2goZnVuY3Rpb24ocmVjb3JkKSB7XG4gICAgICBpZihyZWNvcmRbY2F0ZWdvcnldICYmIE9wZXJhdG9yLm1hdGNoZXMob3BlcmF0b3IsIGZyYWdtZW50TEMsIHJlY29yZFtjYXRlZ29yeV0udG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgaWYoIXNlZW5bcmVjb3JkW2NhdGVnb3J5XV0pIHtcbiAgICAgICAgICBzZWVuW3JlY29yZFtjYXRlZ29yeV1dID0gdHJ1ZTtcbiAgICAgICAgICByZXMucHVzaChyZWNvcmRbY2F0ZWdvcnldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZW1vdmVDYXNlRHVwbGljYXRlcyhyZXMpO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxpa2VseVBsdXJhbERpZmYoYSA6IHN0cmluZywgcGx1cmFsT2ZhIDogc3RyaW5nKSA6IGJvb2xlYW4ge1xuICB2YXIgYUxDID0gQnJlYWtEb3duLnRyaW1RdW90ZWQoYS50b0xvd2VyQ2FzZSgpKSAgfHwgXCJcIjtcbiAgdmFyIHBsdXJhbE9mQUxDID0gQnJlYWtEb3duLnRyaW1RdW90ZWQoKHBsdXJhbE9mYSB8fFwiXCIpLnRvTG93ZXJDYXNlKCkpIHx8IFwiXCI7XG4gIGlmIChhTEMgPT09IHBsdXJhbE9mQUxDKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgaWYoIGFMQyArJ3MnID09PSBwbHVyYWxPZkFMQykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn07XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxXaXRoQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KTogQXJyYXk8SU1hdGNoLklSZWNvcmQ+IHtcbiAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICBkZWJ1Z2xvZyhcIiBsaXN0QWxsV2l0aENhdGVnb3J5OlwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuXG4gIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5Tb3J0ZWRRdW90ZWQoc3RyaW5ncyA6IHN0cmluZ1tdICkgOiBzdHJpbmcge1xuICBpZiAoc3RyaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gXCJcIjtcbiAgfVxuICByZXR1cm4gJ1wiJyArIHN0cmluZ3Muc29ydCgpLmpvaW4oJ1wiOyBcIicpICsgJ1wiJztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5EaXN0aW5jdChjYXRlZ29yeSA6IHN0cmluZywgcmVjb3JkcyA6IEFycmF5PElNYXRjaC5JUmVjb3JkPikgOiBzdHJpbmcge1xuICB2YXIgcmVzID0gcmVjb3Jkcy5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgb1JlY29yZCkge1xuICAgIHByZXZbb1JlY29yZFtjYXRlZ29yeV1dID0gMTtcbiAgICByZXR1cm4gcHJldjtcbiAgfSx7fSBhcyBhbnkpO1xuICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChPYmplY3Qua2V5cyhyZXMpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCggYW5zd2VycyA6IEFycmF5PElNYXRjaC5JV2hhdElzQW5zd2VyPikgOiBzdHJpbmcge1xuICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChhbnN3ZXJzLm1hcChmdW5jdGlvbihvQW5zd2VyKSB7XG4gICAgcmV0dXJuIG9BbnN3ZXIucmVzdWx0O1xuICB9KSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBqb2luUmVzdWx0cyhyZXN1bHRzOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4pOiBzdHJpbmdbXSB7XG4gIHZhciByZXMgID0gW107XG4gIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgaWYocmVzLmluZGV4T2YocmVzdWx0LnJlc3VsdCkgPCAwICl7XG4gICAgICAgIHJlcy5wdXNoKHJlc3VsdC5yZXN1bHQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgIH1cbiAgfSwgMCk7XG4gIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmZlckRvbWFpbih0aGVNb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XG4gLy8gY29uc29sZS5sb2coXCJoZXJlIHRoZSBzdHJpbmdcIiArIGNvbnRleHRRdWVyeVN0cmluZyk7XG4gLy8gIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgcnVsZXNcIiArIEpTT04uc3RyaW5naWZ5KHRoZU1vZGVsLm1SdWxlcykpO1xuICB2YXIgcmVzID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCB0aGVNb2RlbC5ydWxlcyk7XG4gIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzLHVuZGVmaW5lZCwyKSk7XG4gIC8vIHJ1biB0aHJvdWdoIHRoZSBzdHJpbmcsIHNlYXJjaCBmb3IgYSBjYXRlZ29yeVxuICBpZighcmVzLmxlbmd0aCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgdmFyIGRvbWFpbnMgPSBbXTtcbiAgLy8gZG8gd2UgaGF2ZSBhIGRvbWFpbiA/XG4gIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uKG9Xb3JkR3JvdXApIHtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImRvbWFpblwiKSB7XG4gICAgICBkb21haW5zLnB1c2gob1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nKVxuICAgIH1cbiAgfSk7XG4gIGlmKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIGRvbWFpbnNbMF07XG4gIH1cbiAgaWYoZG9tYWlucy5sZW5ndGggPiAwICkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgLy8gVE9ET0RcbiAgfVxuICAvLyB0cnkgYSBjYXRlZ29yeSByZXZlcnNlIG1hcFxuICByZXNbMF0uZm9yRWFjaChmdW5jdGlvbihvV29yZEdyb3VwKXtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcbiAgICAgIHZhciBzQ2F0ID0gb1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nO1xuICAgICAgdmFyIGRvbXMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsc0NhdCk7XG4gICAgICBkb21zLmZvckVhY2goZnVuY3Rpb24oc0RvbSkge1xuICAgICAgICBpZihkb21haW5zLmluZGV4T2Yoc0RvbSkgPCAwKSB7XG4gICAgICAgICAgZG9tYWlucy5wdXNoKHNEb20pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBpZihkb21haW5zLmxlbmd0aCA9PT0gMSkge1xuICAgIHJldHVybiBkb21haW5zWzBdO1xuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59OyIsIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgSW5wdXRGaWx0ZXIgPSByZXF1aXJlKCcuL2lucHV0RmlsdGVyJyk7XG52YXIgQWxnb2wgPSByZXF1aXJlKCcuL2FsZ29sJyk7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2xpc3RhbGwnKTtcbnZhciBsb2dnZXIgPSByZXF1aXJlKCcuLi91dGlscy9sb2dnZXInKTtcbnZhciBsb2dQZXJmID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcbnZhciBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcbnZhciBCcmVha0Rvd24gPSByZXF1aXJlKCcuL2JyZWFrZG93bicpO1xudmFyIFNlbnRlbmNlID0gcmVxdWlyZSgnLi9zZW50ZW5jZScpO1xudmFyIE9wZXJhdG9yID0gcmVxdWlyZSgnLi9vcGVyYXRvcicpO1xudmFyIFdoYXRJcyA9IHJlcXVpcmUoJy4vd2hhdGlzJyk7XG52YXIgTW9kZWwgPSByZXF1aXJlKCcuLi9tb2RlbC9tb2RlbCcpO1xudmFyIHNXb3JkcyA9IHt9O1xuZnVuY3Rpb24gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeShyZWNvcmRzLCB1bmRlZmluZWQsIDIpIDogXCItXCIpO1xuICAgIHZhciByZWxldmFudFJlY29yZHMgPSByZWNvcmRzLmZpbHRlcihmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgICAgIHJldHVybiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gdW5kZWZpbmVkKSAmJiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gbnVsbCk7XG4gICAgfSk7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIGRlYnVnbG9nKFwicmVsZXZhbnQgcmVjb3JkcyBucjpcIiArIHJlbGV2YW50UmVjb3Jkcy5sZW5ndGgpO1xuICAgIHJldHVybiByZWxldmFudFJlY29yZHM7XG59XG5leHBvcnRzLm1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkgPSBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5O1xuZnVuY3Rpb24gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBydWxlcykge1xuICAgIHZhciBtYXRjaGVkID0gSW5wdXRGaWx0ZXIuYW5hbHl6ZVN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHJ1bGVzLCBzV29yZHMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWQpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJhZnRlciByZWluZm9yY2VcIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICAgICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIC8vIHdlIGxpbWl0IGFuYWx5c2lzIHRvIG4gc2VudGVuY2VzXG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYVNlbnRlbmNlc1JlaW5mb3JjZWQuc2xpY2UoMCwgQWxnb2wuQ3V0b2ZmX1NlbnRlbmNlcyk7XG4gICAgcmV0dXJuIGFTZW50ZW5jZXNSZWluZm9yY2VkO1xufVxuZXhwb3J0cy5hbmFseXplQ29udGV4dFN0cmluZyA9IGFuYWx5emVDb250ZXh0U3RyaW5nO1xuLy8gY29uc3QgcmVzdWx0ID0gV2hhdElzLnJlc29sdmVDYXRlZ29yeShjYXQsIGExLmVudGl0eSxcbi8vICAgdGhlTW9kZWwubVJ1bGVzLCB0aGVNb2RlbC50b29scywgdGhlTW9kZWwucmVjb3Jkcyk7XG5mdW5jdGlvbiBsaXN0QWxsV2l0aENvbnRleHQoY2F0ZWdvcnksIGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzLCByZWNvcmRzLCBjYXRlZ29yeVNldCkge1xuICAgIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgICAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICAgICAgcGVyZmxvZyhcIm1hdGNoaW5nIHJlY29yZHMgKHM9XCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNRdWljayhhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcnksIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwiZmlsdGVyaW5nIHRvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxXaXRoQ29udGV4dCAoYT1cIiArIG1hdGNoZWRGaWx0ZXJlZC5sZW5ndGggKyBcIilcIik7XG4gICAgICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgICAgICByZXR1cm4gbWF0Y2hlZEZpbHRlcmVkOyAvLyA/Pz8gQW5zd2VycztcbiAgICB9XG59XG5leHBvcnRzLmxpc3RBbGxXaXRoQ29udGV4dCA9IGxpc3RBbGxXaXRoQ29udGV4dDtcbmZ1bmN0aW9uIGxpc3RBbGxIYXZpbmdDb250ZXh0KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpIHtcbiAgICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBwZXJmbG9nKFwiYW5hbHl6ZUNvbnRleHRTdHJpbmcgLi4uXCIpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIGhhdmluZyAocz1cIiArIChhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGgpICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzSGF2aW5nQ29udGV4dChhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcnksIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwiZmlsdGVyaW5nVG9wUmFua2VkIChhPVwiICsgbWF0Y2hlZEFuc3dlcnMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWQobWF0Y2hlZEFuc3dlcnMpO1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbEhhdmluZ0NvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgICAgICByZXR1cm4gbWF0Y2hlZEZpbHRlcmVkO1xuICAgIH1cbn1cbmV4cG9ydHMubGlzdEFsbEhhdmluZ0NvbnRleHQgPSBsaXN0QWxsSGF2aW5nQ29udGV4dDtcbmZ1bmN0aW9uIGZpbHRlclN0cmluZ0xpc3RCeU9wKG9wZXJhdG9yLCBmcmFnbWVudCwgc3JjYXJyKSB7XG4gICAgdmFyIGZyYWdtZW50TEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZFNwYWNlZChmcmFnbWVudC50b0xvd2VyQ2FzZSgpKTtcbiAgICByZXR1cm4gc3JjYXJyLmZpbHRlcihmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIHJldHVybiBPcGVyYXRvci5tYXRjaGVzKG9wZXJhdG9yLCBmcmFnbWVudExDLCBzdHIudG9Mb3dlckNhc2UoKSk7XG4gICAgfSkuc29ydCgpO1xufVxuZXhwb3J0cy5maWx0ZXJTdHJpbmdMaXN0QnlPcCA9IGZpbHRlclN0cmluZ0xpc3RCeU9wO1xuZnVuY3Rpb24gY29tcGFyZUNhc2VJbnNlbnNpdGl2ZShhLCBiKSB7XG4gICAgdmFyIHIgPSBhLnRvTG93ZXJDYXNlKCkubG9jYWxlQ29tcGFyZShiLnRvTG93ZXJDYXNlKCkpO1xuICAgIGlmIChyKSB7XG4gICAgICAgIHJldHVybiByO1xuICAgIH1cbiAgICByZXR1cm4gLWEubG9jYWxlQ29tcGFyZShiKTtcbn1cbi8qKlxuICogU29ydCBzdHJpbmcgbGlzdCBjYXNlIGluc2Vuc2l0aXZlLCB0aGVuIHJlbW92ZSBkdXBsaWNhdGVzIHJldGFpbmluZ1xuICogXCJsYXJnZXN0XCIgbWF0Y2hcbiAqL1xuZnVuY3Rpb24gcmVtb3ZlQ2FzZUR1cGxpY2F0ZXMoYXJyKSB7XG4gICAgYXJyLnNvcnQoY29tcGFyZUNhc2VJbnNlbnNpdGl2ZSk7XG4gICAgZGVidWdsb2coJ3NvcnRlZCBhcnInICsgSlNPTi5zdHJpbmdpZnkoYXJyKSk7XG4gICAgcmV0dXJuIGFyci5maWx0ZXIoZnVuY3Rpb24gKHMsIGluZGV4KSB7XG4gICAgICAgIHJldHVybiBpbmRleCA9PT0gMCB8fCAoMCAhPT0gYXJyW2luZGV4IC0gMV0udG9Mb3dlckNhc2UoKS5sb2NhbGVDb21wYXJlKHMudG9Mb3dlckNhc2UoKSkpO1xuICAgIH0pO1xufVxuZXhwb3J0cy5yZW1vdmVDYXNlRHVwbGljYXRlcyA9IHJlbW92ZUNhc2VEdXBsaWNhdGVzO1xuO1xuZnVuY3Rpb24gZ2V0Q2F0ZWdvcnlPcEZpbHRlckFzRGlzdGluY3RTdHJpbmdzKG9wZXJhdG9yLCBmcmFnbWVudCwgY2F0ZWdvcnksIHJlY29yZHMpIHtcbiAgICB2YXIgZnJhZ21lbnRMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkKGZyYWdtZW50LnRvTG93ZXJDYXNlKCkpO1xuICAgIHZhciByZXMgPSBbXTtcbiAgICB2YXIgc2VlbiA9IHt9O1xuICAgIHJlY29yZHMuZm9yRWFjaChmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgICAgIGlmIChyZWNvcmRbY2F0ZWdvcnldICYmIE9wZXJhdG9yLm1hdGNoZXMob3BlcmF0b3IsIGZyYWdtZW50TEMsIHJlY29yZFtjYXRlZ29yeV0udG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgICAgIGlmICghc2VlbltyZWNvcmRbY2F0ZWdvcnldXSkge1xuICAgICAgICAgICAgICAgIHNlZW5bcmVjb3JkW2NhdGVnb3J5XV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIHJlcy5wdXNoKHJlY29yZFtjYXRlZ29yeV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlbW92ZUNhc2VEdXBsaWNhdGVzKHJlcyk7XG59XG5leHBvcnRzLmdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyA9IGdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncztcbjtcbmZ1bmN0aW9uIGxpa2VseVBsdXJhbERpZmYoYSwgcGx1cmFsT2ZhKSB7XG4gICAgdmFyIGFMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkKGEudG9Mb3dlckNhc2UoKSkgfHwgXCJcIjtcbiAgICB2YXIgcGx1cmFsT2ZBTEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZCgocGx1cmFsT2ZhIHx8IFwiXCIpLnRvTG93ZXJDYXNlKCkpIHx8IFwiXCI7XG4gICAgaWYgKGFMQyA9PT0gcGx1cmFsT2ZBTEMpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmIChhTEMgKyAncycgPT09IHBsdXJhbE9mQUxDKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5leHBvcnRzLmxpa2VseVBsdXJhbERpZmYgPSBsaWtlbHlQbHVyYWxEaWZmO1xuO1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnksIHJlY29yZHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBkZWJ1Z2xvZyhcIiBsaXN0QWxsV2l0aENhdGVnb3J5OlwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cbmV4cG9ydHMubGlzdEFsbFdpdGhDYXRlZ29yeSA9IGxpc3RBbGxXaXRoQ2F0ZWdvcnk7XG5mdW5jdGlvbiBqb2luU29ydGVkUXVvdGVkKHN0cmluZ3MpIHtcbiAgICBpZiAoc3RyaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuICAgIHJldHVybiAnXCInICsgc3RyaW5ncy5zb3J0KCkuam9pbignXCI7IFwiJykgKyAnXCInO1xufVxuZXhwb3J0cy5qb2luU29ydGVkUXVvdGVkID0gam9pblNvcnRlZFF1b3RlZDtcbmZ1bmN0aW9uIGpvaW5EaXN0aW5jdChjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIHZhciByZXMgPSByZWNvcmRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgb1JlY29yZCkge1xuICAgICAgICBwcmV2W29SZWNvcmRbY2F0ZWdvcnldXSA9IDE7XG4gICAgICAgIHJldHVybiBwcmV2O1xuICAgIH0sIHt9KTtcbiAgICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChPYmplY3Qua2V5cyhyZXMpKTtcbn1cbmV4cG9ydHMuam9pbkRpc3RpbmN0ID0gam9pbkRpc3RpbmN0O1xuZnVuY3Rpb24gZm9ybWF0RGlzdGluY3RGcm9tV2hhdElmUmVzdWx0KGFuc3dlcnMpIHtcbiAgICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChhbnN3ZXJzLm1hcChmdW5jdGlvbiAob0Fuc3dlcikge1xuICAgICAgICByZXR1cm4gb0Fuc3dlci5yZXN1bHQ7XG4gICAgfSkpO1xufVxuZXhwb3J0cy5mb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQgPSBmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQ7XG5mdW5jdGlvbiBqb2luUmVzdWx0cyhyZXN1bHRzKSB7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgICAgIGlmIChyZXN1bHQuX3JhbmtpbmcgPT09IHJlc3VsdHNbMF0uX3JhbmtpbmcpIHtcbiAgICAgICAgICAgIGlmIChyZXMuaW5kZXhPZihyZXN1bHQucmVzdWx0KSA8IDApIHtcbiAgICAgICAgICAgICAgICByZXMucHVzaChyZXN1bHQucmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmV2ICsgMTtcbiAgICAgICAgfVxuICAgIH0sIDApO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmpvaW5SZXN1bHRzID0gam9pblJlc3VsdHM7XG5mdW5jdGlvbiBpbmZlckRvbWFpbih0aGVNb2RlbCwgY29udGV4dFF1ZXJ5U3RyaW5nKSB7XG4gICAgLy8gY29uc29sZS5sb2coXCJoZXJlIHRoZSBzdHJpbmdcIiArIGNvbnRleHRRdWVyeVN0cmluZyk7XG4gICAgLy8gIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgcnVsZXNcIiArIEpTT04uc3RyaW5naWZ5KHRoZU1vZGVsLm1SdWxlcykpO1xuICAgIHZhciByZXMgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHRoZU1vZGVsLnJ1bGVzKTtcbiAgICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlcyx1bmRlZmluZWQsMikpO1xuICAgIC8vIHJ1biB0aHJvdWdoIHRoZSBzdHJpbmcsIHNlYXJjaCBmb3IgYSBjYXRlZ29yeVxuICAgIGlmICghcmVzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB2YXIgZG9tYWlucyA9IFtdO1xuICAgIC8vIGRvIHdlIGhhdmUgYSBkb21haW4gP1xuICAgIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZEdyb3VwKSB7XG4gICAgICAgIGlmIChvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImRvbWFpblwiKSB7XG4gICAgICAgICAgICBkb21haW5zLnB1c2gob1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChkb21haW5zLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXR1cm4gZG9tYWluc1swXTtcbiAgICB9XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICAvLyB0cnkgYSBjYXRlZ29yeSByZXZlcnNlIG1hcFxuICAgIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZEdyb3VwKSB7XG4gICAgICAgIGlmIChvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcbiAgICAgICAgICAgIHZhciBzQ2F0ID0gb1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nO1xuICAgICAgICAgICAgdmFyIGRvbXMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsIHNDYXQpO1xuICAgICAgICAgICAgZG9tcy5mb3JFYWNoKGZ1bmN0aW9uIChzRG9tKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRvbWFpbnMuaW5kZXhPZihzRG9tKSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZG9tYWlucy5wdXNoKHNEb20pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHJldHVybiBkb21haW5zWzBdO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5pbmZlckRvbWFpbiA9IGluZmVyRG9tYWluO1xuO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
