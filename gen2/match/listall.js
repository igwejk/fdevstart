/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var InputFilter = require('./inputFilter');
var Algol = require('./algol');
var debug = require('debug');
var debuglog = debug('listall');
var logger = require('../utils/logger');
var logPerf = logger.perf("perflistall");
var perflog = debug('perf');
var Sentence = require('./sentence');
var WhatIs = require('./whatis');
var Model = require('../model/model');
var sWords = {};
function matchRecordHavingCategory(category, records) {
    debuglog(debuglog.enabled ? JSON.stringify(records, undefined, 2) : "-");
    var relevantRecords = records.filter(function (record) {
        return record[category] !== undefined && record[category] !== null;
    });
    var res = [];
    debuglog("relevant records nr:" + relevantRecords.length);
    return relevantRecords;
}
exports.matchRecordHavingCategory = matchRecordHavingCategory;
function analyzeContextString(contextQueryString, rules) {
    var matched = InputFilter.analyzeString(contextQueryString, rules, sWords);
    if (debuglog.enabled) {
        debuglog("After matched " + JSON.stringify(matched));
    }
    var aSentences = InputFilter.expandMatchArr(matched);
    if (debuglog.enabled) {
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    var aSentencesReinforced = InputFilter.reinForce(aSentences);
    if (debuglog.enabled) {
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    // we limit analysis to n sentences
    var aSentencesReinforced = aSentencesReinforced.slice(0, Algol.Cutoff_Sentences);
    return aSentencesReinforced;
}
exports.analyzeContextString = analyzeContextString;
// const result = WhatIs.resolveCategory(cat, a1.entity,
//   theModel.mRules, theModel.tools, theModel.records);
function listAllWithContext(category, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        logPerf('listAllWithContext');
        perflog("totalListAllWithContext");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records (s=" + aSentencesReinforced.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsQuick(aSentencesReinforced, category, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filtering topRanked (a=" + matchedAnswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllWithContext (a=" + matchedFiltered.length + ")");
        logPerf('listAllWithContext');
        return matchedFiltered; // ??? Answers;
    }
}
exports.listAllWithContext = listAllWithContext;
function listAllHavingContext(category, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        perflog("analyzeContextString ...");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records having (s=" + aSentencesReinforced.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsHavingContext(aSentencesReinforced, category, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filteringTopRanked (a=" + matchedAnswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllHavingContext (a=" + matchedFiltered.length + ")");
        return matchedFiltered;
    }
}
exports.listAllHavingContext = listAllHavingContext;
function listAllWithCategory(category, records) {
    var matchedAnswers = matchRecordHavingCategory(category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
    debuglog(" listAllWithCategory:" + JSON.stringify(matchedAnswers, undefined, 2));
    return matchedAnswers;
}
exports.listAllWithCategory = listAllWithCategory;
function joinSortedQuoted(strings) {
    if (strings.length === 0) {
        return "";
    }
    return '"' + strings.sort().join('"; "') + '"';
}
exports.joinSortedQuoted = joinSortedQuoted;
function joinDistinct(category, records) {
    var res = records.reduce(function (prev, oRecord) {
        prev[oRecord[category]] = 1;
        return prev;
    }, {});
    return joinSortedQuoted(Object.keys(res));
}
exports.joinDistinct = joinDistinct;
function formatDistinctFromWhatIfResult(answers) {
    return joinSortedQuoted(answers.map(function (oAnswer) {
        return oAnswer.result;
    }));
}
exports.formatDistinctFromWhatIfResult = formatDistinctFromWhatIfResult;
function joinResults(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            if (res.indexOf(result.result) < 0) {
                res.push(result.result);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResults = joinResults;
function inferDomain(theModel, contextQueryString) {
    // console.log("here the string" + contextQueryString);
    //  console.log("here the rules" + JSON.stringify(theModel.mRules));
    var res = analyzeContextString(contextQueryString, theModel.rules);
    //console.log(JSON.stringify(res,undefined,2));
    // run through the string, search for a category
    if (!res.length) {
        return undefined;
    }
    var domains = [];
    // do we have a domain ?
    res[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "domain") {
            domains.push(oWordGroup.matchedString);
        }
    });
    if (domains.length === 1) {
        return domains[0];
    }
    if (domains.length > 0) {
        return undefined;
    }
    // try a category reverse map
    res[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "category") {
            var sCat = oWordGroup.matchedString;
            var doms = Model.getDomainsForCategory(theModel, sCat);
            doms.forEach(function (sDom) {
                if (domains.indexOf(sDom) < 0) {
                    domains.push(sDom);
                }
            });
        }
    });
    if (domains.length === 1) {
        return domains[0];
    }
    return undefined;
}
exports.inferDomain = inferDomain;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9saXN0YWxsLnRzIiwibWF0Y2gvbGlzdGFsbC5qcyJdLCJuYW1lcyI6WyJJbnB1dEZpbHRlciIsInJlcXVpcmUiLCJBbGdvbCIsImRlYnVnIiwiZGVidWdsb2ciLCJsb2dnZXIiLCJsb2dQZXJmIiwicGVyZiIsInBlcmZsb2ciLCJTZW50ZW5jZSIsIldoYXRJcyIsIk1vZGVsIiwic1dvcmRzIiwibWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeSIsImNhdGVnb3J5IiwicmVjb3JkcyIsImVuYWJsZWQiLCJKU09OIiwic3RyaW5naWZ5IiwidW5kZWZpbmVkIiwicmVsZXZhbnRSZWNvcmRzIiwiZmlsdGVyIiwicmVjb3JkIiwicmVzIiwibGVuZ3RoIiwiZXhwb3J0cyIsImFuYWx5emVDb250ZXh0U3RyaW5nIiwiY29udGV4dFF1ZXJ5U3RyaW5nIiwicnVsZXMiLCJtYXRjaGVkIiwiYW5hbHl6ZVN0cmluZyIsImFTZW50ZW5jZXMiLCJleHBhbmRNYXRjaEFyciIsIm1hcCIsIm9TZW50ZW5jZSIsInJhbmtpbmdQcm9kdWN0Iiwiam9pbiIsImFTZW50ZW5jZXNSZWluZm9yY2VkIiwicmVpbkZvcmNlIiwic2xpY2UiLCJDdXRvZmZfU2VudGVuY2VzIiwibGlzdEFsbFdpdGhDb250ZXh0IiwiYVJ1bGVzIiwiY2F0ZWdvcnlTZXQiLCJtYXRjaGVkQW5zd2VycyIsIm1hdGNoUmVjb3Jkc1F1aWNrIiwibWF0Y2hlZEZpbHRlcmVkIiwiZmlsdGVyT25seVRvcFJhbmtlZCIsImxpc3RBbGxIYXZpbmdDb250ZXh0IiwibWF0Y2hSZWNvcmRzSGF2aW5nQ29udGV4dCIsImxpc3RBbGxXaXRoQ2F0ZWdvcnkiLCJqb2luU29ydGVkUXVvdGVkIiwic3RyaW5ncyIsInNvcnQiLCJqb2luRGlzdGluY3QiLCJyZWR1Y2UiLCJwcmV2Iiwib1JlY29yZCIsIk9iamVjdCIsImtleXMiLCJmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQiLCJhbnN3ZXJzIiwib0Fuc3dlciIsInJlc3VsdCIsImpvaW5SZXN1bHRzIiwicmVzdWx0cyIsImNudCIsIl9yYW5raW5nIiwiaW5kZXhPZiIsInB1c2giLCJpbmZlckRvbWFpbiIsInRoZU1vZGVsIiwiZG9tYWlucyIsImZvckVhY2giLCJvV29yZEdyb3VwIiwibWF0Y2hlZFN0cmluZyIsInNDYXQiLCJkb21zIiwiZ2V0RG9tYWluc0ZvckNhdGVnb3J5Iiwic0RvbSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQ01BOztBREVBLElBQVlBLGNBQVdDLFFBQU0sZUFBTixDQUF2QjtBQUVBLElBQVlDLFFBQUtELFFBQU0sU0FBTixDQUFqQjtBQUNBLElBQVlFLFFBQUtGLFFBQU0sT0FBTixDQUFqQjtBQUVBLElBQU1HLFdBQVdELE1BQU0sU0FBTixDQUFqQjtBQUNBLElBQVlFLFNBQU1KLFFBQU0saUJBQU4sQ0FBbEI7QUFDQSxJQUFJSyxVQUFVRCxPQUFPRSxJQUFQLENBQVksYUFBWixDQUFkO0FBQ0EsSUFBSUMsVUFBVUwsTUFBTSxNQUFOLENBQWQ7QUFTQSxJQUFZTSxXQUFRUixRQUFNLFlBQU4sQ0FBcEI7QUFJQSxJQUFZUyxTQUFNVCxRQUFNLFVBQU4sQ0FBbEI7QUFFQSxJQUFZVSxRQUFLVixRQUFNLGdCQUFOLENBQWpCO0FBR0EsSUFBSVcsU0FBUyxFQUFiO0FBRUEsU0FBQUMseUJBQUEsQ0FBMENDLFFBQTFDLEVBQTREQyxPQUE1RCxFQUEwRjtBQUV4RlgsYUFBU0EsU0FBU1ksT0FBVCxHQUFtQkMsS0FBS0MsU0FBTCxDQUFlSCxPQUFmLEVBQXVCSSxTQUF2QixFQUFpQyxDQUFqQyxDQUFuQixHQUF5RCxHQUFsRTtBQUNBLFFBQUlDLGtCQUFrQkwsUUFBUU0sTUFBUixDQUFlLFVBQVVDLE1BQVYsRUFBZ0M7QUFDbkUsZUFBUUEsT0FBT1IsUUFBUCxNQUFxQkssU0FBdEIsSUFBcUNHLE9BQU9SLFFBQVAsTUFBcUIsSUFBakU7QUFDRCxLQUZxQixDQUF0QjtBQUdBLFFBQUlTLE1BQU0sRUFBVjtBQUNBbkIsYUFBUyx5QkFB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QUFlLFVBQVNDLFVBQVQsRUFBbUI7QUFDaEMsWUFBR0EsV0FBVzVELFFBQVgsS0FBd0IsVUFBM0IsRUFBdUM7QUFDckMsZ0JBQUk4RCxPQUFPRixXQUFXQyxhQUF0QjtBQUNBLGdCQUFJRSxPQUFPbEUsTUFBTW1FLHFCQUFOLENBQTRCUCxRQUE1QixFQUFxQ0ssSUFBckMsQ0FBWDtBQUNBQyxpQkFBS0osT0FBTCxDQUFhLFVBQVNNLElBQVQsRUFBYTtBQUN4QixvQkFBR1AsUUFBUUosT0FBUixDQUFnQlcsSUFBaEIsSUFBd0IsQ0FBM0IsRUFBOEI7QUFDNUJQLDRCQUFRSCxJQUFSLENBQWFVLElBQWI7QUFDRDtBQUNGLGFBSkQ7QUFLRDtBQUNGLEtBVkQ7QUFXQSxRQUFHUCxRQUFRaEQsTUFBUixLQUFtQixDQUF0QixFQUF5QjtBQUN2QixlQUFPZ0QsUUFBUSxDQUFSLENBQVA7QUFDRDtBQUNELFdBQU9yRCxTQUFQO0FBQ0Q7QUF2Q2VNLFFBQUE2QyxXQUFBLEdBQVdBLFdBQVg7QUF1Q2YiLCJmaWxlIjoibWF0Y2gvbGlzdGFsbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXG5cbmltcG9ydCAqIGFzIElucHV0RmlsdGVyIGZyb20gJy4vaW5wdXRGaWx0ZXInO1xuXG5pbXBvcnQgKiBhcyBBbGdvbCBmcm9tICcuL2FsZ29sJztcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnbGlzdGFsbCcpO1xuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG52YXIgbG9nUGVyZiA9IGxvZ2dlci5wZXJmKFwicGVyZmxpc3RhbGxcIik7XG52YXIgcGVyZmxvZyA9IGRlYnVnKCdwZXJmJyk7XG4vL2NvbnN0IHBlcmZsb2cgPSBsb2dnZXIucGVyZihcInBlcmZsaXN0YWxsXCIpO1xuXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuLi91dGlscy91dGlscyc7XG5cbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuL2lmbWF0Y2gnO1xuXG5pbXBvcnQgKiBhcyBUb29sbWF0Y2hlciBmcm9tICcuL3Rvb2xtYXRjaGVyJztcblxuaW1wb3J0ICogYXMgU2VudGVuY2UgZnJvbSAnLi9zZW50ZW5jZSc7XG5cbmltcG9ydCAqIGFzIFdvcmQgZnJvbSAnLi93b3JkJztcblxuaW1wb3J0ICogYXMgV2hhdElzIGZyb20gJy4vd2hhdGlzJztcblxuaW1wb3J0ICogYXMgTW9kZWwgZnJvbSAnLi4vbW9kZWwvbW9kZWwnO1xuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi9tYXRjaCc7XG5cbnZhciBzV29yZHMgPSB7fTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KVxuICA6IEFycmF5PElNYXRjaC5JUmVjb3JkPiB7XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeShyZWNvcmRzLHVuZGVmaW5lZCwyKSA6IFwiLVwiKTtcbiAgdmFyIHJlbGV2YW50UmVjb3JkcyA9IHJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQ6IElNYXRjaC5JUmVjb3JkKSB7XG4gICAgcmV0dXJuIChyZWNvcmRbY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpICYmIChyZWNvcmRbY2F0ZWdvcnldICE9PSBudWxsKTtcbiAgfSk7XG4gIHZhciByZXMgPSBbXTtcbiAgZGVidWdsb2coXCJyZWxldmFudCByZWNvcmRzIG5yOlwiICsgcmVsZXZhbnRSZWNvcmRzLmxlbmd0aCk7XG4gIHJldHVybiByZWxldmFudFJlY29yZHM7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZyA6IHN0cmluZywgIHJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcykge1xuICAgIHZhciBtYXRjaGVkID0gSW5wdXRGaWx0ZXIuYW5hbHl6ZVN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHJ1bGVzLCBzV29yZHMpO1xuICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWQpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCJhZnRlciByZWluZm9yY2VcIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIC8vIHdlIGxpbWl0IGFuYWx5c2lzIHRvIG4gc2VudGVuY2VzXG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYVNlbnRlbmNlc1JlaW5mb3JjZWQuc2xpY2UoMCwgQWxnb2wuQ3V0b2ZmX1NlbnRlbmNlcyk7XG4gICAgcmV0dXJuIGFTZW50ZW5jZXNSZWluZm9yY2VkO1xufVxuXG4vLyBjb25zdCByZXN1bHQgPSBXaGF0SXMucmVzb2x2ZUNhdGVnb3J5KGNhdCwgYTEuZW50aXR5LFxuLy8gICB0aGVNb2RlbC5tUnVsZXMsIHRoZU1vZGVsLnRvb2xzLCB0aGVNb2RlbC5yZWNvcmRzKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxXaXRoQ29udGV4dChjYXRlZ29yeTogc3RyaW5nLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyxcbiAgYVJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+LCBjYXRlZ29yeVNldD86IHsgW2tleSA6IHN0cmluZ10gOiBib29sZWFuIH0pOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4ge1xuICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfSBlbHNlIHtcbiAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIChzPVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNRdWljayhhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcnksIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCl7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcImZpbHRlcmluZyB0b3BSYW5rZWQgKGE9XCIgKyBtYXRjaGVkQW5zd2Vycy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxXaXRoQ29udGV4dCAoYT1cIiArIG1hdGNoZWRGaWx0ZXJlZC5sZW5ndGggKyBcIilcIik7XG4gICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgcmV0dXJuIG1hdGNoZWRGaWx0ZXJlZDsgLy8gPz8/IEFuc3dlcnM7XG4gIH1cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gbGlzdEFsbEhhdmluZ0NvbnRleHQoY2F0ZWdvcnk6IHN0cmluZywgY29udGV4dFF1ZXJ5U3RyaW5nOiBzdHJpbmcsXG4gIGFSdWxlczogSU1hdGNoLlNwbGl0UnVsZXMsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPixcbiAgY2F0ZWdvcnlTZXQgOiB7IFtrZXk6c3RyaW5nXSA6IGJvb2xlYW4gfSk6IEFycmF5PElNYXRjaC5JV2hhdElzQW5zd2VyPiB7XG4gIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9IGVsc2Uge1xuICAgIHBlcmZsb2coXCJhbmFseXplQ29udGV4dFN0cmluZyAuLi5cIik7XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIGhhdmluZyAocz1cIiArIChhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGgpICsgXCIpLi4uXCIpO1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNIYXZpbmdDb250ZXh0KGFTZW50ZW5jZXNSZWluZm9yY2VkLCBjYXRlZ29yeSwgcmVjb3JkcywgY2F0ZWdvcnlTZXQpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcImZpbHRlcmluZ1RvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWQobWF0Y2hlZEFuc3dlcnMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbEhhdmluZ0NvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgIHJldHVybiBtYXRjaGVkRmlsdGVyZWQ7XG4gIH1cbn1cblxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxXaXRoQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KTogQXJyYXk8SU1hdGNoLklSZWNvcmQ+IHtcbiAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICBkZWJ1Z2xvZyhcIiBsaXN0QWxsV2l0aENhdGVnb3J5OlwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuXG4gIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5Tb3J0ZWRRdW90ZWQoc3RyaW5ncyA6IHN0cmluZ1tdICkgOiBzdHJpbmcge1xuICBpZiAoc3RyaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gXCJcIjtcbiAgfVxuICByZXR1cm4gJ1wiJyArIHN0cmluZ3Muc29ydCgpLmpvaW4oJ1wiOyBcIicpICsgJ1wiJztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5EaXN0aW5jdChjYXRlZ29yeSA6IHN0cmluZywgcmVjb3JkcyA6IEFycmF5PElNYXRjaC5JUmVjb3JkPikgOiBzdHJpbmcge1xuICB2YXIgcmVzID0gcmVjb3Jkcy5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgb1JlY29yZCkge1xuICAgIHByZXZbb1JlY29yZFtjYXRlZ29yeV1dID0gMTtcbiAgICByZXR1cm4gcHJldjtcbiAgfSx7fSBhcyBhbnkpO1xuICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChPYmplY3Qua2V5cyhyZXMpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCggYW5zd2VycyA6IEFycmF5PElNYXRjaC5JV2hhdElzQW5zd2VyPikgOiBzdHJpbmcge1xuICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChhbnN3ZXJzLm1hcChmdW5jdGlvbihvQW5zd2VyKSB7XG4gICAgcmV0dXJuIG9BbnN3ZXIucmVzdWx0O1xuICB9KSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBqb2luUmVzdWx0cyhyZXN1bHRzOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4pOiBzdHJpbmdbXSB7XG4gIHZhciByZXMgID0gW107XG4gIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgaWYocmVzLmluZGV4T2YocmVzdWx0LnJlc3VsdCkgPCAwICl7XG4gICAgICAgIHJlcy5wdXNoKHJlc3VsdC5yZXN1bHQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgIH1cbiAgfSwgMCk7XG4gIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmZlckRvbWFpbih0aGVNb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XG4gLy8gY29uc29sZS5sb2coXCJoZXJlIHRoZSBzdHJpbmdcIiArIGNvbnRleHRRdWVyeVN0cmluZyk7XG4gLy8gIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgcnVsZXNcIiArIEpTT04uc3RyaW5naWZ5KHRoZU1vZGVsLm1SdWxlcykpO1xuICB2YXIgcmVzID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCB0aGVNb2RlbC5ydWxlcyk7XG4gIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzLHVuZGVmaW5lZCwyKSk7XG4gIC8vIHJ1biB0aHJvdWdoIHRoZSBzdHJpbmcsIHNlYXJjaCBmb3IgYSBjYXRlZ29yeVxuICBpZighcmVzLmxlbmd0aCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgdmFyIGRvbWFpbnMgPSBbXTtcbiAgLy8gZG8gd2UgaGF2ZSBhIGRvbWFpbiA/XG4gIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uKG9Xb3JkR3JvdXApIHtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImRvbWFpblwiKSB7XG4gICAgICBkb21haW5zLnB1c2gob1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nKVxuICAgIH1cbiAgfSk7XG4gIGlmKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIGRvbWFpbnNbMF07XG4gIH1cbiAgaWYoZG9tYWlucy5sZW5ndGggPiAwICkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgLy8gVE9ET0RcbiAgfVxuICAvLyB0cnkgYSBjYXRlZ29yeSByZXZlcnNlIG1hcFxuICByZXNbMF0uZm9yRWFjaChmdW5jdGlvbihvV29yZEdyb3VwKXtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcbiAgICAgIHZhciBzQ2F0ID0gb1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nO1xuICAgICAgdmFyIGRvbXMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsc0NhdCk7XG4gICAgICBkb21zLmZvckVhY2goZnVuY3Rpb24oc0RvbSkge1xuICAgICAgICBpZihkb21haW5zLmluZGV4T2Yoc0RvbSkgPCAwKSB7XG4gICAgICAgICAgZG9tYWlucy5wdXNoKHNEb20pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBpZihkb21haW5zLmxlbmd0aCA9PT0gMSkge1xuICAgIHJldHVybiBkb21haW5zWzBdO1xuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59OyIsIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgSW5wdXRGaWx0ZXIgPSByZXF1aXJlKCcuL2lucHV0RmlsdGVyJyk7XG52YXIgQWxnb2wgPSByZXF1aXJlKCcuL2FsZ29sJyk7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2xpc3RhbGwnKTtcbnZhciBsb2dnZXIgPSByZXF1aXJlKCcuLi91dGlscy9sb2dnZXInKTtcbnZhciBsb2dQZXJmID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcbnZhciBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcbnZhciBTZW50ZW5jZSA9IHJlcXVpcmUoJy4vc2VudGVuY2UnKTtcbnZhciBXaGF0SXMgPSByZXF1aXJlKCcuL3doYXRpcycpO1xudmFyIE1vZGVsID0gcmVxdWlyZSgnLi4vbW9kZWwvbW9kZWwnKTtcbnZhciBzV29yZHMgPSB7fTtcbmZ1bmN0aW9uIG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnksIHJlY29yZHMpIHtcbiAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gSlNPTi5zdHJpbmdpZnkocmVjb3JkcywgdW5kZWZpbmVkLCAyKSA6IFwiLVwiKTtcbiAgICB2YXIgcmVsZXZhbnRSZWNvcmRzID0gcmVjb3Jkcy5maWx0ZXIoZnVuY3Rpb24gKHJlY29yZCkge1xuICAgICAgICByZXR1cm4gKHJlY29yZFtjYXRlZ29yeV0gIT09IHVuZGVmaW5lZCkgJiYgKHJlY29yZFtjYXRlZ29yeV0gIT09IG51bGwpO1xuICAgIH0pO1xuICAgIHZhciByZXMgPSBbXTtcbiAgICBkZWJ1Z2xvZyhcInJlbGV2YW50IHJlY29yZHMgbnI6XCIgKyByZWxldmFudFJlY29yZHMubGVuZ3RoKTtcbiAgICByZXR1cm4gcmVsZXZhbnRSZWNvcmRzO1xufVxuZXhwb3J0cy5tYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5ID0gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeTtcbmZ1bmN0aW9uIGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgcnVsZXMpIHtcbiAgICB2YXIgbWF0Y2hlZCA9IElucHV0RmlsdGVyLmFuYWx5emVTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBydWxlcywgc1dvcmRzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkKSk7XG4gICAgfVxuICAgIHZhciBhU2VudGVuY2VzID0gSW5wdXRGaWx0ZXIuZXhwYW5kTWF0Y2hBcnIobWF0Y2hlZCk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICAvLyB3ZSBsaW1pdCBhbmFseXNpcyB0byBuIHNlbnRlbmNlc1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFTZW50ZW5jZXNSZWluZm9yY2VkLnNsaWNlKDAsIEFsZ29sLkN1dG9mZl9TZW50ZW5jZXMpO1xuICAgIHJldHVybiBhU2VudGVuY2VzUmVpbmZvcmNlZDtcbn1cbmV4cG9ydHMuYW5hbHl6ZUNvbnRleHRTdHJpbmcgPSBhbmFseXplQ29udGV4dFN0cmluZztcbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDb250ZXh0KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpIHtcbiAgICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICAgICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0XCIpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIChzPVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzUXVpY2soYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3J5LCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcImZpbHRlcmluZyB0b3BSYW5rZWQgKGE9XCIgKyBtYXRjaGVkQW5zd2Vycy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgICAgIHZhciBtYXRjaGVkRmlsdGVyZWQgPSBXaGF0SXMuZmlsdGVyT25seVRvcFJhbmtlZChtYXRjaGVkQW5zd2Vycyk7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgICAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoZWRGaWx0ZXJlZDsgLy8gPz8/IEFuc3dlcnM7XG4gICAgfVxufVxuZXhwb3J0cy5saXN0QWxsV2l0aENvbnRleHQgPSBsaXN0QWxsV2l0aENvbnRleHQ7XG5mdW5jdGlvbiBsaXN0QWxsSGF2aW5nQ29udGV4dChjYXRlZ29yeSwgY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMsIHJlY29yZHMsIGNhdGVnb3J5U2V0KSB7XG4gICAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcGVyZmxvZyhcImFuYWx5emVDb250ZXh0U3RyaW5nIC4uLlwiKTtcbiAgICAgICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgICAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyBoYXZpbmcgKHM9XCIgKyAoYVNlbnRlbmNlc1JlaW5mb3JjZWQubGVuZ3RoKSArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3Jkc0hhdmluZ0NvbnRleHQoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3J5LCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcImZpbHRlcmluZ1RvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxIYXZpbmdDb250ZXh0IChhPVwiICsgbWF0Y2hlZEZpbHRlcmVkLmxlbmd0aCArIFwiKVwiKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoZWRGaWx0ZXJlZDtcbiAgICB9XG59XG5leHBvcnRzLmxpc3RBbGxIYXZpbmdDb250ZXh0ID0gbGlzdEFsbEhhdmluZ0NvbnRleHQ7XG5mdW5jdGlvbiBsaXN0QWxsV2l0aENhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgIGRlYnVnbG9nKFwiIGxpc3RBbGxXaXRoQ2F0ZWdvcnk6XCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgcmV0dXJuIG1hdGNoZWRBbnN3ZXJzO1xufVxuZXhwb3J0cy5saXN0QWxsV2l0aENhdGVnb3J5ID0gbGlzdEFsbFdpdGhDYXRlZ29yeTtcbmZ1bmN0aW9uIGpvaW5Tb3J0ZWRRdW90ZWQoc3RyaW5ncykge1xuICAgIGlmIChzdHJpbmdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgcmV0dXJuICdcIicgKyBzdHJpbmdzLnNvcnQoKS5qb2luKCdcIjsgXCInKSArICdcIic7XG59XG5leHBvcnRzLmpvaW5Tb3J0ZWRRdW90ZWQgPSBqb2luU29ydGVkUXVvdGVkO1xuZnVuY3Rpb24gam9pbkRpc3RpbmN0KGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgdmFyIHJlcyA9IHJlY29yZHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCBvUmVjb3JkKSB7XG4gICAgICAgIHByZXZbb1JlY29yZFtjYXRlZ29yeV1dID0gMTtcbiAgICAgICAgcmV0dXJuIHByZXY7XG4gICAgfSwge30pO1xuICAgIHJldHVybiBqb2luU29ydGVkUXVvdGVkKE9iamVjdC5rZXlzKHJlcykpO1xufVxuZXhwb3J0cy5qb2luRGlzdGluY3QgPSBqb2luRGlzdGluY3Q7XG5mdW5jdGlvbiBmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQoYW5zd2Vycykge1xuICAgIHJldHVybiBqb2luU29ydGVkUXVvdGVkKGFuc3dlcnMubWFwKGZ1bmN0aW9uIChvQW5zd2VyKSB7XG4gICAgICAgIHJldHVybiBvQW5zd2VyLnJlc3VsdDtcbiAgICB9KSk7XG59XG5leHBvcnRzLmZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCA9IGZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdDtcbmZ1bmN0aW9uIGpvaW5SZXN1bHRzKHJlc3VsdHMpIHtcbiAgICB2YXIgcmVzID0gW107XG4gICAgdmFyIGNudCA9IHJlc3VsdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCByZXN1bHQpIHtcbiAgICAgICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgICAgICAgaWYgKHJlcy5pbmRleE9mKHJlc3VsdC5yZXN1bHQpIDwgMCkge1xuICAgICAgICAgICAgICAgIHJlcy5wdXNoKHJlc3VsdC5yZXN1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgICAgICB9XG4gICAgfSwgMCk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuam9pblJlc3VsdHMgPSBqb2luUmVzdWx0cztcbmZ1bmN0aW9uIGluZmVyRG9tYWluKHRoZU1vZGVsLCBjb250ZXh0UXVlcnlTdHJpbmcpIHtcbiAgICAvLyBjb25zb2xlLmxvZyhcImhlcmUgdGhlIHN0cmluZ1wiICsgY29udGV4dFF1ZXJ5U3RyaW5nKTtcbiAgICAvLyAgY29uc29sZS5sb2coXCJoZXJlIHRoZSBydWxlc1wiICsgSlNPTi5zdHJpbmdpZnkodGhlTW9kZWwubVJ1bGVzKSk7XG4gICAgdmFyIHJlcyA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgdGhlTW9kZWwucnVsZXMpO1xuICAgIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzLHVuZGVmaW5lZCwyKSk7XG4gICAgLy8gcnVuIHRocm91Z2ggdGhlIHN0cmluZywgc2VhcmNoIGZvciBhIGNhdGVnb3J5XG4gICAgaWYgKCFyZXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHZhciBkb21haW5zID0gW107XG4gICAgLy8gZG8gd2UgaGF2ZSBhIGRvbWFpbiA/XG4gICAgcmVzWzBdLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkR3JvdXApIHtcbiAgICAgICAgaWYgKG9Xb3JkR3JvdXAuY2F0ZWdvcnkgPT09IFwiZG9tYWluXCIpIHtcbiAgICAgICAgICAgIGRvbWFpbnMucHVzaChvV29yZEdyb3VwLm1hdGNoZWRTdHJpbmcpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHJldHVybiBkb21haW5zWzBdO1xuICAgIH1cbiAgICBpZiAoZG9tYWlucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIC8vIHRyeSBhIGNhdGVnb3J5IHJldmVyc2UgbWFwXG4gICAgcmVzWzBdLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkR3JvdXApIHtcbiAgICAgICAgaWYgKG9Xb3JkR3JvdXAuY2F0ZWdvcnkgPT09IFwiY2F0ZWdvcnlcIikge1xuICAgICAgICAgICAgdmFyIHNDYXQgPSBvV29yZEdyb3VwLm1hdGNoZWRTdHJpbmc7XG4gICAgICAgICAgICB2YXIgZG9tcyA9IE1vZGVsLmdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbCwgc0NhdCk7XG4gICAgICAgICAgICBkb21zLmZvckVhY2goZnVuY3Rpb24gKHNEb20pIHtcbiAgICAgICAgICAgICAgICBpZiAoZG9tYWlucy5pbmRleE9mKHNEb20pIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICBkb21haW5zLnB1c2goc0RvbSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoZG9tYWlucy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgcmV0dXJuIGRvbWFpbnNbMF07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG5leHBvcnRzLmluZmVyRG9tYWluID0gaW5mZXJEb21haW47XG47XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
