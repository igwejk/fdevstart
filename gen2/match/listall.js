/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var InputFilter = require('./inputFilter');
var Algol = require('./algol');
var debug = require('debug');
var debuglog = debug('listall');
var logger = require('../utils/logger');
var logPerf = logger.perf("perflistall");
var perflog = debug('perf');
var Sentence = require('./sentence');
var WhatIs = require('./whatis');
var Model = require('../model/model');
function matchRecordHavingCategory(category, records) {
    debuglog(JSON.stringify(records, undefined, 2));
    var relevantRecords = records.filter(function (record) {
        return record[category] !== undefined && record[category] !== null;
    });
    var res = [];
    debuglog("relevant records nr:" + relevantRecords.length);
    return relevantRecords;
}
exports.matchRecordHavingCategory = matchRecordHavingCategory;
function analyzeContextString(contextQueryString, aRules) {
    var matched = InputFilter.analyzeString(contextQueryString, aRules);
    if (debuglog.enabled) {
        debuglog("After matched " + JSON.stringify(matched));
    }
    var aSentences = InputFilter.expandMatchArr(matched);
    if (debuglog.enabled) {
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    var aSentencesReinforced = InputFilter.reinForce(aSentences);
    if (debuglog.enabled) {
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    // we limit analysis to n sentences
    var aSentencesReinforced = aSentencesReinforced.slice(0, Algol.Cutoff_Sentences);
    return aSentencesReinforced;
}
exports.analyzeContextString = analyzeContextString;
// const result = WhatIs.resolveCategory(cat, a1.entity,
//   theModel.mRules, theModel.tools, theModel.records);
function listAllWithContext(category, contextQueryString, aRules, records) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        logPerf('listAllWithContext');
        perflog("totalListAllWithContext");
        /*
        var matched = InputFilter.analyzeString(contextQueryString, aRules);
        if(debuglog.enabled) {
          debuglog("After matched " + JSON.stringify(matched));
        }
        var aSentences = InputFilter.expandMatchArr(matched);
        if(debuglog.enabled) {
          debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
          }).join("\n"));
        }
        var aSentencesReinforced = InputFilter.reinForce(aSentences);
        if(debuglog.enabled) {
          debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
          }).join("\n"));
        }
        // we limit analysis to n sentences
        */
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records ...");
        var matchedAnswers = WhatIs.matchRecordsQuick(aSentencesReinforced, category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("match records");
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllWithContext");
        logPerf('listAllWithContext');
        return matchedAnswers;
    }
}
exports.listAllWithContext = listAllWithContext;
function listAllHavingContext(category, contextQueryString, aRules, records) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        perflog("matching records ...");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records ...");
        var matchedAnswers = WhatIs.matchRecordsHavingContext(aSentencesReinforced, category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("total listAllHavingContext");
        return matchedFiltered;
    }
}
exports.listAllHavingContext = listAllHavingContext;
function listAllWithCategory(category, records) {
    var matchedAnswers = matchRecordHavingCategory(category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
    debuglog(" listAllWithCategory:" + JSON.stringify(matchedAnswers, undefined, 2));
    return matchedAnswers;
}
exports.listAllWithCategory = listAllWithCategory;
function joinSortedQuoted(strings) {
    if (strings.length === 0) {
        return "";
    }
    return '"' + strings.sort().join('"; "') + '"';
}
exports.joinSortedQuoted = joinSortedQuoted;
function joinDistinct(category, records) {
    var res = records.reduce(function (prev, oRecord) {
        prev[oRecord[category]] = 1;
        return prev;
    }, {});
    return joinSortedQuoted(Object.keys(res));
}
exports.joinDistinct = joinDistinct;
function formatDistinctFromWhatIfResult(answers) {
    return joinSortedQuoted(answers.map(function (oAnswer) {
        return oAnswer.result;
    }));
}
exports.formatDistinctFromWhatIfResult = formatDistinctFromWhatIfResult;
function joinResults(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            if (res.indexOf(result.result) < 0) {
                res.push(result.result);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResults = joinResults;
function inferDomain(theModel, contextQueryString) {
    // console.log("here the string" + contextQueryString);
    //  console.log("here the rules" + JSON.stringify(theModel.mRules));
    var res = analyzeContextString(contextQueryString, theModel.mRules);
    //console.log(JSON.stringify(res,undefined,2));
    // run through the string, search for a category
    if (!res.length) {
        return undefined;
    }
    var domains = [];
    // do we have a domain ?
    res[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "domain") {
            domains.push(oWordGroup.matchedString);
        }
    });
    if (domains.length === 1) {
        return domains[0];
    }
    if (domains.length > 0) {
        return undefined;
    }
    // try a category reverse map
    res[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "category") {
            var sCat = oWordGroup.matchedString;
            var doms = Model.getDomainsForCategory(theModel, sCat);
            doms.forEach(function (sDom) {
                if (domains.indexOf(sDom) < 0) {
                    domains.push(sDom);
                }
            });
        }
    });
    if (domains.length === 1) {
        return domains[0];
    }
    return undefined;
}
exports.inferDomain = inferDomain;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9saXN0YWxsLnRzIiwibWF0Y2gvbGlzdGFsbC5qcyJdLCJuYW1lcyI6WyJJbnB1dEZpbHRlciIsInJlcXVpcmUiLCJBbGdvbCIsImRlYnVnIiwiZGVidWdsb2ciLCJsb2dnZXIiLCJsb2dQZXJmIiwicGVyZiIsInBlcmZsb2ciLCJTZW50ZW5jZSIsIldoYXRJcyIsIk1vZGVsIiwibWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeSIsImNhdGVnb3J5IiwicmVjb3JkcyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ1bmRlZmluZWQiLCJyZWxldmFudFJlY29yZHMiLCJmaWx0ZXIiLCJyZWNvcmQiLCJyZXMiLCJsZW5ndGgiLCJleHBvcnRzIiwiYW5hbHl6ZUNvbnRleHRTdHJpbmciLCJjb250ZXh0UXVlcnlTdHJpbmciLCJhUnVsZXMiLCJtYXRjaGVkIiwiYW5hbHl6ZVN0cmluZyIsImVuYWJsZWQiLCJhU2VudGVuY2VzIiwiZXhwYW5kTWF0Y2hBcnIiLCJtYXAiLCJvU2VudGVuY2UiLCJyYW5raW5nUHJvZHVjdCIsImpvaW4iLCJhU2VudGVuY2VzUmVpbmZvcmNlZCIsInJlaW5Gb3JjZSIsInNsaWNlIiwiQ3V0b2ZmX1NlbnRlbmNlcyIsImxpc3RBbGxXaXRoQ29udGV4dCIsIm1hdGNoZWRBbnN3ZXJzIiwibWF0Y2hSZWNvcmRzUXVpY2siLCJtYXRjaGVkRmlsdGVyZWQiLCJmaWx0ZXJPbmx5VG9wUmFua2VkIiwibGlzdEFsbEhhdmluZ0NvbnRleHQiLCJtYXRjaFJlY29yZHNIYXZpbmdDb250ZXh0IiwibGlzdEFsbFdpdGhDYXRlZ29yeSIsImpvaW5Tb3J0ZWRRdW90ZWQiLCJzdHJpbmdzIiwic29ydCIsImpvaW5EaXN0aW5jdCIsInJlZHVjZSIsInByZXYiLCJvUmVjb3JkIiwiT2JqZWN0Iiwia2V5cyIsImZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCIsImFuc3dlcnMiLCJvQW5zd2VyIiwicmVzdWx0Iiwiam9pblJlc3VsdHMiLCJyZXN1bHRzIiwiY250IiwiX3JhbmtpbmciLCJpbmRleE9mIiwicHVzaCIsImluZmVyRG9tYWluIiwidGhlTW9kZWwiLCJtUnVsZXMiLCJkb21haW5zIiwiZm9yRWFjaCIsIm9Xb3JkR3JvdXAiLCJtYXRjaGVkU3RyaW5nIiwic0NhdCIsImRvbXMiLCJnZXREb21haW5zRm9yQ2F0ZWdvcnkiLCJzRG9tIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FDTUE7O0FERUEsSUFBWUEsY0FBV0MsUUFBTSxlQUFOLENBQXZCO0FBRUEsSUFBWUMsUUFBS0QsUUFBTSxTQUFOLENBQWpCO0FBQ0EsSUFBWUUsUUFBS0YsUUFBTSxPQUFOLENBQWpCO0FBRUEsSUFBTUcsV0FBV0QsTUFBTSxTQUFOLENBQWpCO0FBQ0EsSUFBWUUsU0FBTUosUUFBTSxpQkFBTixDQUFsQjtBQUNBLElBQUlLLFVBQVVELE9BQU9FLElBQVAsQ0FBWSxhQUFaLENBQWQ7QUFDQSxJQUFJQyxVQUFVTCxNQUFNLE1BQU4sQ0FBZDtBQVNBLElBQVlNLFdBQVFSLFFBQU0sWUFBTixDQUFwQjtBQUlBLElBQVlTLFNBQU1ULFFBQU0sVUFBTixDQUFsQjtBQUVBLElBQVlVLFFBQUtWLFFBQU0sZ0JBQU4sQ0FBakI7QUFJQSxTQUFBVyx5QkFBQSxDQUEwQ0MsUUFBMUMsRUFBNERDLE9BQTVELEVBQTBGO0FBRXhGVixhQUFTVyxLQUFLQyxTQUFMLENBQWVGLE9BQWYsRUFBdUJHLFNBQXZCLEVBQWlDLENBQWpDLENBQVQ7QUFDQSxRQUFJQyxrQkFBa0JKLFFBQVFLLE1BQVIsQ0FBZSxVQUFVQyxNQUFWLEVBQWdDO0FBQ25FLGVBQVFBLE9BQU9QLFFBQVAsTUFBcUJJLFNBQXRCLElBQXFDRyxPQUFPUCxRQUFQLE1BQXFCLElBQWpFO0FBQ0QsS0FGcUIsQ0FBdEI7QUFHQSxRQUFJUSxNQUFNLEVBQVY7QUFDQWpCLGFBQVMseUJBQXlCYyxnQkFBZ0JJLE1BQWxEO0FBQ0EsV0FBT0osZUFBUDtBQUNEO0FBVGVLLFFBQUFYLHlCQUFBLEdBQXlCQSx5QkFBekI7QUFZ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UUFBR1AsUUFBUWhELE1BQVIsS0FBbUIsQ0FBdEIsRUFBeUI7QUFDdkIsZUFBT2dELFFBQVEsQ0FBUixDQUFQO0FBQ0Q7QUFDRCxXQUFPckQsU0FBUDtBQUNEO0FBdkNlTSxRQUFBNEMsV0FBQSxHQUFXQSxXQUFYO0FBdUNmIiwiZmlsZSI6Im1hdGNoL2xpc3RhbGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBhbmFseXplLnRzXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblxuXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlciBmcm9tICcuL2lucHV0RmlsdGVyJztcblxuaW1wb3J0ICogYXMgQWxnb2wgZnJvbSAnLi9hbGdvbCc7XG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ2xpc3RhbGwnKTtcbmltcG9ydCAqIGFzIGxvZ2dlciBmcm9tICcuLi91dGlscy9sb2dnZXInO1xudmFyIGxvZ1BlcmYgPSBsb2dnZXIucGVyZihcInBlcmZsaXN0YWxsXCIpO1xudmFyIHBlcmZsb2cgPSBkZWJ1ZygncGVyZicpO1xuLy9jb25zdCBwZXJmbG9nID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcblxuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJztcblxuaW1wb3J0ICogYXMgVG9vbG1hdGNoZXIgZnJvbSAnLi90b29sbWF0Y2hlcic7XG5cbmltcG9ydCAqIGFzIFNlbnRlbmNlIGZyb20gJy4vc2VudGVuY2UnO1xuXG5pbXBvcnQgKiBhcyBXb3JkIGZyb20gJy4vd29yZCc7XG5cbmltcG9ydCAqIGFzIFdoYXRJcyBmcm9tICcuL3doYXRpcyc7XG5cbmltcG9ydCAqIGFzIE1vZGVsIGZyb20gJy4uL21vZGVsL21vZGVsJztcbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4vbWF0Y2gnO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5OiBzdHJpbmcsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPilcbiAgOiBBcnJheTxJTWF0Y2guSVJlY29yZD4ge1xuICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShyZWNvcmRzLHVuZGVmaW5lZCwyKSk7XG4gIHZhciByZWxldmFudFJlY29yZHMgPSByZWNvcmRzLmZpbHRlcihmdW5jdGlvbiAocmVjb3JkOiBJTWF0Y2guSVJlY29yZCkge1xuICAgIHJldHVybiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gdW5kZWZpbmVkKSAmJiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gbnVsbCk7XG4gIH0pO1xuICB2YXIgcmVzID0gW107XG4gIGRlYnVnbG9nKFwicmVsZXZhbnQgcmVjb3JkcyBucjpcIiArIHJlbGV2YW50UmVjb3Jkcy5sZW5ndGgpO1xuICByZXR1cm4gcmVsZXZhbnRSZWNvcmRzO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcgOiBzdHJpbmcsICBhUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4pIHtcbiAgICB2YXIgbWF0Y2hlZCA9IElucHV0RmlsdGVyLmFuYWx5emVTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWQpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCJhZnRlciByZWluZm9yY2VcIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIC8vIHdlIGxpbWl0IGFuYWx5c2lzIHRvIG4gc2VudGVuY2VzXG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYVNlbnRlbmNlc1JlaW5mb3JjZWQuc2xpY2UoMCwgQWxnb2wuQ3V0b2ZmX1NlbnRlbmNlcyk7XG4gICAgcmV0dXJuIGFTZW50ZW5jZXNSZWluZm9yY2VkO1xufVxuXG4vLyBjb25zdCByZXN1bHQgPSBXaGF0SXMucmVzb2x2ZUNhdGVnb3J5KGNhdCwgYTEuZW50aXR5LFxuLy8gICB0aGVNb2RlbC5tUnVsZXMsIHRoZU1vZGVsLnRvb2xzLCB0aGVNb2RlbC5yZWNvcmRzKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxXaXRoQ29udGV4dChjYXRlZ29yeTogc3RyaW5nLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyxcbiAgYVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4ge1xuICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfSBlbHNlIHtcbiAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgLypcbiAgICB2YXIgbWF0Y2hlZCA9IElucHV0RmlsdGVyLmFuYWx5emVTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWQpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCJhZnRlciByZWluZm9yY2VcIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIC8vIHdlIGxpbWl0IGFuYWx5c2lzIHRvIG4gc2VudGVuY2VzXG4gICAgKi9cbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG5cbiAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyAuLi5cIik7XG5cblxuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNRdWljayhhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcnksIHJlY29yZHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKXtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwibWF0Y2ggcmVjb3Jkc1wiKTtcbiAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWQobWF0Y2hlZEFuc3dlcnMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0XCIpO1xuICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgIHJldHVybiBtYXRjaGVkQW5zd2VycztcbiAgfVxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0QWxsSGF2aW5nQ29udGV4dChjYXRlZ29yeTogc3RyaW5nLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyxcbiAgYVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4ge1xuICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfSBlbHNlIHtcbiAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyAuLi5cIik7XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIC4uLlwiKVxuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNIYXZpbmdDb250ZXh0KGFTZW50ZW5jZXNSZWluZm9yY2VkLCBjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWQobWF0Y2hlZEFuc3dlcnMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcInRvdGFsIGxpc3RBbGxIYXZpbmdDb250ZXh0XCIpXG4gICAgcmV0dXJuIG1hdGNoZWRGaWx0ZXJlZDtcbiAgfVxufVxuXG5cblxuXG5leHBvcnQgZnVuY3Rpb24gbGlzdEFsbFdpdGhDYXRlZ29yeShjYXRlZ29yeTogc3RyaW5nLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pOiBBcnJheTxJTWF0Y2guSVJlY29yZD4ge1xuICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gIGRlYnVnbG9nKFwiIGxpc3RBbGxXaXRoQ2F0ZWdvcnk6XCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG5cbiAgcmV0dXJuIG1hdGNoZWRBbnN3ZXJzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gam9pblNvcnRlZFF1b3RlZChzdHJpbmdzIDogc3RyaW5nW10gKSA6IHN0cmluZyB7XG4gIGlmIChzdHJpbmdzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBcIlwiO1xuICB9XG4gIHJldHVybiAnXCInICsgc3RyaW5ncy5zb3J0KCkuam9pbignXCI7IFwiJykgKyAnXCInO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gam9pbkRpc3RpbmN0KGNhdGVnb3J5IDogc3RyaW5nLCByZWNvcmRzIDogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KSA6IHN0cmluZyB7XG4gIHZhciByZXMgPSByZWNvcmRzLnJlZHVjZShmdW5jdGlvbihwcmV2LCBvUmVjb3JkKSB7XG4gICAgcHJldltvUmVjb3JkW2NhdGVnb3J5XV0gPSAxO1xuICAgIHJldHVybiBwcmV2O1xuICB9LHt9IGFzIGFueSk7XG4gIHJldHVybiBqb2luU29ydGVkUXVvdGVkKE9iamVjdC5rZXlzKHJlcykpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0RGlzdGluY3RGcm9tV2hhdElmUmVzdWx0KCBhbnN3ZXJzIDogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+KSA6IHN0cmluZyB7XG4gIHJldHVybiBqb2luU29ydGVkUXVvdGVkKGFuc3dlcnMubWFwKGZ1bmN0aW9uKG9BbnN3ZXIpIHtcbiAgICByZXR1cm4gb0Fuc3dlci5yZXN1bHQ7XG4gIH0pKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5SZXN1bHRzKHJlc3VsdHM6IEFycmF5PElNYXRjaC5JV2hhdElzQW5zd2VyPik6IHN0cmluZ1tdIHtcbiAgdmFyIHJlcyAgPSBbXTtcbiAgdmFyIGNudCA9IHJlc3VsdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCByZXN1bHQpIHtcbiAgICBpZiAocmVzdWx0Ll9yYW5raW5nID09PSByZXN1bHRzWzBdLl9yYW5raW5nKSB7XG4gICAgICBpZihyZXMuaW5kZXhPZihyZXN1bHQucmVzdWx0KSA8IDAgKXtcbiAgICAgICAgcmVzLnB1c2gocmVzdWx0LnJlc3VsdCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcHJldiArIDE7XG4gICAgfVxuICB9LCAwKTtcbiAgcmV0dXJuIHJlcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGluZmVyRG9tYWluKHRoZU1vZGVsIDogSU1hdGNoLklNb2RlbHMsIGNvbnRleHRRdWVyeVN0cmluZzogc3RyaW5nKTogc3RyaW5nIHtcbiAvLyBjb25zb2xlLmxvZyhcImhlcmUgdGhlIHN0cmluZ1wiICsgY29udGV4dFF1ZXJ5U3RyaW5nKTtcbiAvLyAgY29uc29sZS5sb2coXCJoZXJlIHRoZSBydWxlc1wiICsgSlNPTi5zdHJpbmdpZnkodGhlTW9kZWwubVJ1bGVzKSk7XG4gIHZhciByZXMgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHRoZU1vZGVsLm1SdWxlcyk7XG4gIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzLHVuZGVmaW5lZCwyKSk7XG4gIC8vIHJ1biB0aHJvdWdoIHRoZSBzdHJpbmcsIHNlYXJjaCBmb3IgYSBjYXRlZ29yeVxuICBpZighcmVzLmxlbmd0aCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgdmFyIGRvbWFpbnMgPSBbXTtcbiAgLy8gZG8gd2UgaGF2ZSBhIGRvbWFpbiA/XG4gIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uKG9Xb3JkR3JvdXApIHtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImRvbWFpblwiKSB7XG4gICAgICBkb21haW5zLnB1c2gob1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nKVxuICAgIH1cbiAgfSk7XG4gIGlmKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIGRvbWFpbnNbMF07XG4gIH1cbiAgaWYoZG9tYWlucy5sZW5ndGggPiAwICkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgLy8gVE9ET0RcbiAgfVxuICAvLyB0cnkgYSBjYXRlZ29yeSByZXZlcnNlIG1hcFxuICByZXNbMF0uZm9yRWFjaChmdW5jdGlvbihvV29yZEdyb3VwKXtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcbiAgICAgIHZhciBzQ2F0ID0gb1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nO1xuICAgICAgdmFyIGRvbXMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsc0NhdCk7XG4gICAgICBkb21zLmZvckVhY2goZnVuY3Rpb24oc0RvbSkge1xuICAgICAgICBpZihkb21haW5zLmluZGV4T2Yoc0RvbSkgPCAwKSB7XG4gICAgICAgICAgZG9tYWlucy5wdXNoKHNEb20pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBpZihkb21haW5zLmxlbmd0aCA9PT0gMSkge1xuICAgIHJldHVybiBkb21haW5zWzBdO1xuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59OyIsIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgSW5wdXRGaWx0ZXIgPSByZXF1aXJlKCcuL2lucHV0RmlsdGVyJyk7XG52YXIgQWxnb2wgPSByZXF1aXJlKCcuL2FsZ29sJyk7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2xpc3RhbGwnKTtcbnZhciBsb2dnZXIgPSByZXF1aXJlKCcuLi91dGlscy9sb2dnZXInKTtcbnZhciBsb2dQZXJmID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcbnZhciBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcbnZhciBTZW50ZW5jZSA9IHJlcXVpcmUoJy4vc2VudGVuY2UnKTtcbnZhciBXaGF0SXMgPSByZXF1aXJlKCcuL3doYXRpcycpO1xudmFyIE1vZGVsID0gcmVxdWlyZSgnLi4vbW9kZWwvbW9kZWwnKTtcbmZ1bmN0aW9uIG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnksIHJlY29yZHMpIHtcbiAgICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShyZWNvcmRzLCB1bmRlZmluZWQsIDIpKTtcbiAgICB2YXIgcmVsZXZhbnRSZWNvcmRzID0gcmVjb3Jkcy5maWx0ZXIoZnVuY3Rpb24gKHJlY29yZCkge1xuICAgICAgICByZXR1cm4gKHJlY29yZFtjYXRlZ29yeV0gIT09IHVuZGVmaW5lZCkgJiYgKHJlY29yZFtjYXRlZ29yeV0gIT09IG51bGwpO1xuICAgIH0pO1xuICAgIHZhciByZXMgPSBbXTtcbiAgICBkZWJ1Z2xvZyhcInJlbGV2YW50IHJlY29yZHMgbnI6XCIgKyByZWxldmFudFJlY29yZHMubGVuZ3RoKTtcbiAgICByZXR1cm4gcmVsZXZhbnRSZWNvcmRzO1xufVxuZXhwb3J0cy5tYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5ID0gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeTtcbmZ1bmN0aW9uIGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKSB7XG4gICAgdmFyIG1hdGNoZWQgPSBJbnB1dEZpbHRlci5hbmFseXplU3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkKSk7XG4gICAgfVxuICAgIHZhciBhU2VudGVuY2VzID0gSW5wdXRGaWx0ZXIuZXhwYW5kTWF0Y2hBcnIobWF0Y2hlZCk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICAvLyB3ZSBsaW1pdCBhbmFseXNpcyB0byBuIHNlbnRlbmNlc1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFTZW50ZW5jZXNSZWluZm9yY2VkLnNsaWNlKDAsIEFsZ29sLkN1dG9mZl9TZW50ZW5jZXMpO1xuICAgIHJldHVybiBhU2VudGVuY2VzUmVpbmZvcmNlZDtcbn1cbmV4cG9ydHMuYW5hbHl6ZUNvbnRleHRTdHJpbmcgPSBhbmFseXplQ29udGV4dFN0cmluZztcbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDb250ZXh0KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3Jkcykge1xuICAgIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgICAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgICAgIC8qXG4gICAgICAgIHZhciBtYXRjaGVkID0gSW5wdXRGaWx0ZXIuYW5hbHl6ZVN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkKSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGFTZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICAgICAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgZXhwYW5kXCIgKyBhU2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICAgICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICB9XG4gICAgICAgIC8vIHdlIGxpbWl0IGFuYWx5c2lzIHRvIG4gc2VudGVuY2VzXG4gICAgICAgICovXG4gICAgICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICAgICAgcGVyZmxvZyhcIm1hdGNoaW5nIHJlY29yZHMgLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzUXVpY2soYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwibWF0Y2ggcmVjb3Jkc1wiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxXaXRoQ29udGV4dFwiKTtcbiAgICAgICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgICAgIHJldHVybiBtYXRjaGVkQW5zd2VycztcbiAgICB9XG59XG5leHBvcnRzLmxpc3RBbGxXaXRoQ29udGV4dCA9IGxpc3RBbGxXaXRoQ29udGV4dDtcbmZ1bmN0aW9uIGxpc3RBbGxIYXZpbmdDb250ZXh0KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3Jkcykge1xuICAgIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIC4uLlwiKTtcbiAgICAgICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgICAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyAuLi5cIik7XG4gICAgICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNIYXZpbmdDb250ZXh0KGFTZW50ZW5jZXNSZWluZm9yY2VkLCBjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIHBlcmZsb2coXCJ0b3RhbCBsaXN0QWxsSGF2aW5nQ29udGV4dFwiKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoZWRGaWx0ZXJlZDtcbiAgICB9XG59XG5leHBvcnRzLmxpc3RBbGxIYXZpbmdDb250ZXh0ID0gbGlzdEFsbEhhdmluZ0NvbnRleHQ7XG5mdW5jdGlvbiBsaXN0QWxsV2l0aENhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgIGRlYnVnbG9nKFwiIGxpc3RBbGxXaXRoQ2F0ZWdvcnk6XCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgcmV0dXJuIG1hdGNoZWRBbnN3ZXJzO1xufVxuZXhwb3J0cy5saXN0QWxsV2l0aENhdGVnb3J5ID0gbGlzdEFsbFdpdGhDYXRlZ29yeTtcbmZ1bmN0aW9uIGpvaW5Tb3J0ZWRRdW90ZWQoc3RyaW5ncykge1xuICAgIGlmIChzdHJpbmdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgcmV0dXJuICdcIicgKyBzdHJpbmdzLnNvcnQoKS5qb2luKCdcIjsgXCInKSArICdcIic7XG59XG5leHBvcnRzLmpvaW5Tb3J0ZWRRdW90ZWQgPSBqb2luU29ydGVkUXVvdGVkO1xuZnVuY3Rpb24gam9pbkRpc3RpbmN0KGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgdmFyIHJlcyA9IHJlY29yZHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCBvUmVjb3JkKSB7XG4gICAgICAgIHByZXZbb1JlY29yZFtjYXRlZ29yeV1dID0gMTtcbiAgICAgICAgcmV0dXJuIHByZXY7XG4gICAgfSwge30pO1xuICAgIHJldHVybiBqb2luU29ydGVkUXVvdGVkKE9iamVjdC5rZXlzKHJlcykpO1xufVxuZXhwb3J0cy5qb2luRGlzdGluY3QgPSBqb2luRGlzdGluY3Q7XG5mdW5jdGlvbiBmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQoYW5zd2Vycykge1xuICAgIHJldHVybiBqb2luU29ydGVkUXVvdGVkKGFuc3dlcnMubWFwKGZ1bmN0aW9uIChvQW5zd2VyKSB7XG4gICAgICAgIHJldHVybiBvQW5zd2VyLnJlc3VsdDtcbiAgICB9KSk7XG59XG5leHBvcnRzLmZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCA9IGZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdDtcbmZ1bmN0aW9uIGpvaW5SZXN1bHRzKHJlc3VsdHMpIHtcbiAgICB2YXIgcmVzID0gW107XG4gICAgdmFyIGNudCA9IHJlc3VsdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCByZXN1bHQpIHtcbiAgICAgICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgICAgICAgaWYgKHJlcy5pbmRleE9mKHJlc3VsdC5yZXN1bHQpIDwgMCkge1xuICAgICAgICAgICAgICAgIHJlcy5wdXNoKHJlc3VsdC5yZXN1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgICAgICB9XG4gICAgfSwgMCk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuam9pblJlc3VsdHMgPSBqb2luUmVzdWx0cztcbmZ1bmN0aW9uIGluZmVyRG9tYWluKHRoZU1vZGVsLCBjb250ZXh0UXVlcnlTdHJpbmcpIHtcbiAgICAvLyBjb25zb2xlLmxvZyhcImhlcmUgdGhlIHN0cmluZ1wiICsgY29udGV4dFF1ZXJ5U3RyaW5nKTtcbiAgICAvLyAgY29uc29sZS5sb2coXCJoZXJlIHRoZSBydWxlc1wiICsgSlNPTi5zdHJpbmdpZnkodGhlTW9kZWwubVJ1bGVzKSk7XG4gICAgdmFyIHJlcyA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgdGhlTW9kZWwubVJ1bGVzKTtcbiAgICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlcyx1bmRlZmluZWQsMikpO1xuICAgIC8vIHJ1biB0aHJvdWdoIHRoZSBzdHJpbmcsIHNlYXJjaCBmb3IgYSBjYXRlZ29yeVxuICAgIGlmICghcmVzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB2YXIgZG9tYWlucyA9IFtdO1xuICAgIC8vIGRvIHdlIGhhdmUgYSBkb21haW4gP1xuICAgIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZEdyb3VwKSB7XG4gICAgICAgIGlmIChvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImRvbWFpblwiKSB7XG4gICAgICAgICAgICBkb21haW5zLnB1c2gob1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChkb21haW5zLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXR1cm4gZG9tYWluc1swXTtcbiAgICB9XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICAvLyB0cnkgYSBjYXRlZ29yeSByZXZlcnNlIG1hcFxuICAgIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZEdyb3VwKSB7XG4gICAgICAgIGlmIChvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcbiAgICAgICAgICAgIHZhciBzQ2F0ID0gb1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nO1xuICAgICAgICAgICAgdmFyIGRvbXMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsIHNDYXQpO1xuICAgICAgICAgICAgZG9tcy5mb3JFYWNoKGZ1bmN0aW9uIChzRG9tKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRvbWFpbnMuaW5kZXhPZihzRG9tKSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZG9tYWlucy5wdXNoKHNEb20pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHJldHVybiBkb21haW5zWzBdO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5pbmZlckRvbWFpbiA9IGluZmVyRG9tYWluO1xuO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
