/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require('debug');
var debuglog = debug('listall');
var logger = require('../utils/logger');
var logPerf = logger.perf("perflistall");
var perflog = debug('perf');
var BreakDown = require('./breakdown');
var Operator = require('./operator');
var WhatIs = require('./whatis');
var Model = require('../model/model');
var sWords = {};
function matchRecordHavingCategory(category, records) {
    debuglog(debuglog.enabled ? JSON.stringify(records, undefined, 2) : "-");
    var relevantRecords = records.filter(function (record) {
        return record[category] !== undefined && record[category] !== null;
    });
    var res = [];
    debuglog("relevant records nr:" + relevantRecords.length);
    return relevantRecords;
}
exports.matchRecordHavingCategory = matchRecordHavingCategory;
function analyzeContextString(contextQueryString, rules) {
    return WhatIs.analyzeContextString(contextQueryString, rules);
}
exports.analyzeContextString = analyzeContextString;
// const result = WhatIs.resolveCategory(cat, a1.entity,
//   theModel.mRules, theModel.tools, theModel.records);
function listAllWithContext(category, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        logPerf('listAllWithContext');
        perflog("totalListAllWithContext");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        debuglog("listAllWithContext:matching records (s=" + aSentencesReinforced.length + ")...");
        debuglog("here sentences" + JSON.stringify(aSentencesReinforced, undefined, 2));
        perflog("matching records (s=" + aSentencesReinforced.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsQuick(aSentencesReinforced, category, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filtering topRanked (a=" + matchedAnswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllWithContext (a=" + matchedFiltered.length + ")");
        logPerf('listAllWithContext');
        return matchedFiltered; // ??? Answers;
    }
}
exports.listAllWithContext = listAllWithContext;
function listAllHavingContext(category, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        perflog("analyzeContextString ...");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records having (s=" + aSentencesReinforced.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsHavingContext(aSentencesReinforced, category, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filteringTopRanked (a=" + matchedAnswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllHavingContext (a=" + matchedFiltered.length + ")");
        return matchedFiltered;
    }
}
exports.listAllHavingContext = listAllHavingContext;
function listAllTupelWithContext(categories, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        logPerf('listAllWithContext');
        perflog("totalListAllWithContext");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records (s=" + aSentencesReinforced.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsQuickMultipleCategories(aSentencesReinforced, categories, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filtering topRanked (a=" + matchedAnswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRankedTupel(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllWithContext (a=" + matchedFiltered.length + ")");
        logPerf('listAllWithContext');
        return matchedFiltered; // ??? Answers;
    }
}
exports.listAllTupelWithContext = listAllTupelWithContext;
function listAllTupelHavingContext(categories, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        perflog("analyzeContextString ...");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records having (s=" + aSentencesReinforced.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsTupelHavingContext(aSentencesReinforced, categories, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filteringTopRanked (a=" + matchedAnswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRankedTupel(matchedAnswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllHavingContext (a=" + matchedFiltered.length + ")");
        return matchedFiltered;
    }
}
exports.listAllTupelHavingContext = listAllTupelHavingContext;
function filterStringListByOp(operator, fragment, srcarr) {
    var fragmentLC = BreakDown.trimQuotedSpaced(fragment.toLowerCase());
    return srcarr.filter(function (str) {
        return Operator.matches(operator, fragmentLC, str.toLowerCase());
    }).sort();
}
exports.filterStringListByOp = filterStringListByOp;
function compareCaseInsensitive(a, b) {
    var r = a.toLowerCase().localeCompare(b.toLowerCase());
    if (r) {
        return r;
    }
    return -a.localeCompare(b);
}
/**
 * Sort string list case insensitive, then remove duplicates retaining
 * "largest" match
 */
function removeCaseDuplicates(arr) {
    arr.sort(compareCaseInsensitive);
    debuglog('sorted arr' + JSON.stringify(arr));
    return arr.filter(function (s, index) {
        return index === 0 || 0 !== arr[index - 1].toLowerCase().localeCompare(s.toLowerCase());
    });
}
exports.removeCaseDuplicates = removeCaseDuplicates;
;
function getCategoryOpFilterAsDistinctStrings(operator, fragment, category, records, filterDomain) {
    var fragmentLC = BreakDown.trimQuoted(fragment.toLowerCase());
    var res = [];
    var seen = {};
    records.forEach(function (record) {
        if (filterDomain && record['_domain'] !== filterDomain) {
            return;
        }
        if (record[category] && Operator.matches(operator, fragmentLC, record[category].toLowerCase())) {
            if (!seen[record[category]]) {
                seen[record[category]] = true;
                res.push(record[category]);
            }
        }
    });
    return removeCaseDuplicates(res);
}
exports.getCategoryOpFilterAsDistinctStrings = getCategoryOpFilterAsDistinctStrings;
;
function likelyPluralDiff(a, pluralOfa) {
    var aLC = BreakDown.trimQuoted(a.toLowerCase()) || "";
    var pluralOfALC = BreakDown.trimQuoted((pluralOfa || "").toLowerCase()) || "";
    if (aLC === pluralOfALC) {
        return true;
    }
    if (aLC + 's' === pluralOfALC) {
        return true;
    }
    return false;
}
exports.likelyPluralDiff = likelyPluralDiff;
;
function listAllWithCategory(category, records) {
    var matchedAnswers = matchRecordHavingCategory(category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
    debuglog(" listAllWithCategory:" + JSON.stringify(matchedAnswers, undefined, 2));
    return matchedAnswers;
}
exports.listAllWithCategory = listAllWithCategory;
function joinSortedQuoted(strings) {
    if (strings.length === 0) {
        return "";
    }
    return '"' + strings.sort().join('"; "') + '"';
}
exports.joinSortedQuoted = joinSortedQuoted;
function joinDistinct(category, records) {
    var res = records.reduce(function (prev, oRecord) {
        prev[oRecord[category]] = 1;
        return prev;
    }, {});
    return joinSortedQuoted(Object.keys(res));
}
exports.joinDistinct = joinDistinct;
function formatDistinctFromWhatIfResult(answers) {
    return joinSortedQuoted(answers.map(function (oAnswer) {
        return oAnswer.result;
    }));
}
exports.formatDistinctFromWhatIfResult = formatDistinctFromWhatIfResult;
function joinResults(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            if (res.indexOf(result.result) < 0) {
                res.push(result.result);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResults = joinResults;
var Utils = require('../utils/utils');
function joinResultsTupel(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            var value = Utils.listToQuotedCommaAnd(result.result);
            if (res.indexOf(value) < 0) {
                res.push(value);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResultsTupel = joinResultsTupel;
function inferDomain(theModel, contextQueryString) {
    // console.log("here the string" + contextQueryString);
    //  console.log("here the rules" + JSON.stringify(theModel.mRules));
    var res = analyzeContextString(contextQueryString, theModel.rules);
    //console.log(JSON.stringify(res,undefined,2));
    // run through the string, search for a category
    if (!res.length) {
        return undefined;
    }
    var domains = [];
    //console.log(Sentence.dumpNiceArr(res));
    // do we have a domain ?
    res[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "domain") {
            domains.push(oWordGroup.matchedString);
        }
    });
    if (domains.length === 1) {
        debuglog("got a precise domain " + domains[0]);
        return domains[0];
    }
    if (domains.length > 0) {
        debuglog("got more than one domain, confused  " + domains.join("\n"));
        return undefined;
    }
    debuglog("attempting to determine categories");
    // try a category reverse map
    res[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "category") {
            var sCat = oWordGroup.matchedString;
            var doms = Model.getDomainsForCategory(theModel, sCat);
            doms.forEach(function (sDom) {
                if (domains.indexOf(sDom) < 0) {
                    domains.push(sDom);
                }
            });
        }
    });
    if (domains.length === 1) {
        debuglog("got a precise domain " + domains[0]);
        return domains[0];
    }
    debuglog("got more than one domain, confused  " + domains.join("\n"));
    return undefined;
}
exports.inferDomain = inferDomain;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9saXN0YWxsLnRzIiwibWF0Y2gvbGlzdGFsbC5qcyJdLCJuYW1lcyI6WyJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsImxvZ2dlciIsImxvZ1BlcmYiLCJwZXJmIiwicGVyZmxvZyIsIkJyZWFrRG93biIsIk9wZXJhdG9yIiwiV2hhdElzIiwiTW9kZWwiLCJzV29yZHMiLCJtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5IiwiY2F0ZWdvcnkiLCJyZWNvcmRzIiwiZW5hYmxlZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJ1bmRlZmluZWQiLCJyZWxldmFudFJlY29yZHMiLCJmaWx0ZXIiLCJyZWNvcmQiLCJyZXMiLCJsZW5ndGgiLCJleHBvcnRzIiwiYW5hbHl6ZUNvbnRleHRTdHJpbmciLCJjb250ZXh0UXVlcnlTdHJpbmciLCJydWxlcyIsImxpc3RBbGxXaXRoQ29udGV4dCIsImFSdWxlcyIsImNhdGVnb3J5U2V0IiwiYVNlbnRlbmNlc1JlaW5mb3JjZWQiLCJtYXRjaGVkQW5zd2VycyIsIm1hdGNoUmVjb3Jkc1F1aWNrIiwibWF0Y2hlZEZpbHRlcmVkIiwiZmlsdGVyT25seVRvcFJhbmtlZCIsImxpc3RBbGxIYXZpbmdDb250ZXh0IiwibWF0Y2hSZWNvcmRzSGF2aW5nQ29udGV4dCIsImxpc3RBbGxUdXBlbFdpdGhDb250ZXh0IiwiY2F0ZWdvcmllcyIsIm1hdGNoUmVjb3Jkc1F1aWNrTXVsdGlwbGVDYXRlZ29yaWVzIiwiZmlsdGVyT25seVRvcFJhbmtlZFR1cGVsIiwibGlzdEFsbFR1cGVsSGF2aW5nQ29udGV4dCIsIm1hdGNoUmVjb3Jkc1R1cGVsSGF2aW5nQ29udGV4dCIsImZpbHRlclN0cmluZ0xpc3RCeU9wIiwib3BlcmF0b3IiLCJmcmFnbWVudCIsInNyY2FyciIsImZyYWdtZW50TEMiLCJ0cmltUXVvdGVkU3BhY2VkIiwidG9Mb3dlckNhc2UiLCJzdHIiLCJtYXRjaGVzIiwic29ydCIsImNvbXBhcmVDYXNlSW5zZW5zaXRpdmUiLCJhIiwiYiIsInIiLCJsb2NhbGVDb21wYXJlIiwicmVtb3ZlQ2FzZUR1cGxpY2F0ZXMiLCJhcnIiLCJzIiwiaW5kZXgiLCJnZXRDYXRlZ29yeU9wRmlsdGVyQXNEaXN0aW5jdFN0cmluZ3MiLCJmaWx0ZXJEb21haW4iLCJ0cmltUXVvdGVkIiwic2VlbiIsImZvckVhY2giLCJwdXNoIiwibGlrZWx5UGx1cmFsRGlmZiIsInBsdXJhbE9mYSIsImFMQyIsInBsdXJhbE9mQUxDIiwibGlzdEFsbFdpdGhDYXRlZ29yeSIsImpvaW5Tb3J0ZWRRdW90ZWQiLCJzdHJpbmdzIiwiam9pbiIsImpvaW5EaXN0aW5jdCIsInJlZHVjZSIsInByZXYiLCJvUmVjb3JkIiwiT2JqZWN0Iiwia2V5cyIsImZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCIsImFuc3dlcnMiLCJtYXAiLCJvQW5zd2VyIiwicmVzdWx0Iiwiam9pblJlc3VsdHMiLCJyZXN1bHRzIiwiY250IiwiX3JhbmtpbmciLCJpbmRleE9mIiwiVXRpbHMiLCJqb2luUmVzdWx0c1R1cGVsIiwidmFsdWUiLCJsaXN0VG9RdW90ZWRDb21tYUFuZCIsImluZmVyRG9tYWluIiwidGhlTW9kZWwiLCJkb21haW5zIiwib1dvcmRHcm91cCIsIm1hdGNoZWRTdHJpbmciLCJzQ2F0IiwiZG9tcyIsImdldERvbWFpbnNGb3JDYXRlZ29yeSIsInNEb20iXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUNNQTs7QURLQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4sQ0FBakI7QUFFQSxJQUFNQyxXQUFXRixNQUFNLFNBQU4sQ0FBakI7QUFDQSxJQUFZRyxTQUFNRixRQUFNLGlCQUFOLENBQWxCO0FBQ0EsSUFBSUcsVUFBVUQsT0FBT0UsSUFBUCxDQUFZLGFBQVosQ0FBZDtBQUNBLElBQUlDLFVBQVVOLE1BQU0sTUFBTixDQUFkO0FBUUEsSUFBWU8sWUFBU04sUUFBTSxhQUFOLENBQXJCO0FBS0EsSUFBWU8sV0FBUVAsUUFBTSxZQUFOLENBQXBCO0FBRUEsSUFBWVEsU0FBTVIsUUFBTSxVQUFOLENBQWxCO0FBRUEsSUFBWVMsUUFBS1QsUUFBTSxnQkFBTixDQUFqQjtBQUdBLElBQUlVLFNBQVMsRUFBYjtBQUVBLFNBQUFDLHlCQUFBLENBQTBDQyxRQUExQyxFQUE0REMsT0FBNUQsRUFBMEY7QUFFeEZaLGFBQVNBLFNBQVNhLE9BQVQsR0FBbUJDLEtBQUtDLFNBQUwsQ0FBZUgsT0FBZixFQUF1QkksU0FBdkIsRUFBaUMsQ0FBakMsQ0FBbkIsR0FBeUQsR0FBbEU7QUFDQSxRQUFJQyxrQkFBa0JMLFFBQVFNLE1BQVIsQ0FBZSxVQUFVQyxNQUFWLEVBQWdDO0FBQ25FLGVBQVFBLE9BQU9SLFFBQVAsTUFBcUJLLFNBQXRCLElBQXFDRyxPQUFPUixRQUFQLE1BQXFCLElBQWpFO0FBQ0QsS0FGcUIsQ0FBdEI7QUFHQSxRQUFJUyxNQUFNLEVBQVY7QUFDQXBCLGFBQVMseUJBQXlCaUIsZ0JBQWdCSSxNQUFsRDtBQUNBLFdBQU9KLGVBQVA7QUFDRDtBQVRlSyxRQUFBWix5QkFBQSxHQUF5QkEseUJBQXpCO0FBWWhCLFNBQUFhLG9CQUFBLENBQXFDQyxrQkFBckMsRUFBbUVDLEtBQW5FLEVBQTJGO0FBQ3pGLFdBQU9sQixPQUFPZ0Isb0JBQVAsQ0FBNEJDLGtCQUE1QixFQUErQ0MsS0FBL0MsQ0FBUDtBQUNEO0FBRmVILFFBQUFDLG9CQUFBLEdBQW9CQSxvQkFBcEI7QUFJaEI7QUFDQTtBQUVBLFNBQUFHLGtCQUFBLENBQW1DZixRQUFuQyxFQUFxRGEsa0JBQXJELEVBQ0VHLE1BREYsRUFDNkJmLE9BRDdCLEVBQzZEZ0IsV0FEN0QsRUFDdUc7QUFDckcsUUFBSUosbUJBQW1CSCxNQUFuQixLQUE4QixDQUFsQyxFQUFxQztBQUNuQyxlQUFPLEVBQVA7QUFDRCxLQUZELE1BRU87QUFDTG5CLGdCQUFRLG9CQUFSO0FBQ0FFLGdCQUFRLHlCQUFSO0FBQ0EsWUFBSXlCLHVCQUF1Qk4scUJBQXFCQyxrQkFBckIsRUFBeUNHLE1BQXpDLENBQTNCO0FBQ0EzQixpQkFBUyw0Q0FBNEM2QixxQkFBcUJSLE1BQWpFLEdBQTBFLE1BQW5GO0FBQ0FyQixpQkFBUyxtQkFBbUJjLEtBQUtDLFNBQUwsQ0FBZWMsb0JBQWYsRUFBb0NiLFNBQXBDLEVBQThDLENBQTlDLENBQTVCO0FBQ0FaLGdCQUFRLHlCQUF5QnlCLHFCQUFxQlIsTUFBOUMsR0FBdUQsTUFBL0Q7QUFDQSxZQUFJUyxpQkFBaUJ2QixPQUFPd0IsaUJBQVAsQ0FBeUJGLG9CQUF6QixFQUErQ2xCLFFBQS9DLEVBQXlEQyxPQUF6RCxFQUFrRWdCLFdBQWxFLENBQXJCLENBUEssQ0FPZ0c7QUFDckcsWUFBRzVCLFNBQVNhLE9BQVosRUFBb0I7QUFDbEJiLHFCQUFTLHFCQUFxQmMsS0FBS0MsU0FBTCxDQUFlZSxjQUFmLEVBQStCZCxTQUEvQixFQUEwQyxDQUExQyxDQUE5QjtBQUNEO0FBQ0RaLGdCQUFRLDRCQUE0QjBCLGVBQWVULE1BQTNDLEdBQW9ELE1BQTVEO0FBQ0EsWUFBSVcsa0JBQWtCekIsT0FBTzBCLG1CQUFQLENBQTJCSCxjQUEzQixDQUF0QjtBQUNBLFlBQUk5QixTQUFTYSxPQUFiLEVBQXNCO0FBQ3BCYixxQkFBUyxnQ0FBZ0NjLEtBQUtDLFNBQUwsQ0FBZWlCLGVBQWYsRUFBZ0NoQixTQUFoQyxFQUEyQyxDQUEzQyxDQUF6QztBQUNEO0FBQ0RaLGdCQUFRLGdDQUFnQzRCLGdCQUFnQlgsTUFBaEQsR0FBeUQsR0FBakU7QUFDQW5CLGdCQUFRLG9CQUFSO0FBQ0EsZUFBTzhCLGVBQVAsQ0FsQkssQ0FrQm1CO0FBQ3pCO0FBQ0Y7QUF4QmVWLFFBQUFJLGtCQUFBLEdBQWtCQSxrQkFBbEI7QUEyQmhCLFNBQUFRLG9CQUFBLENBQXFDdkIsUUFBckMsRUFBdURhLGtCQUF2RCxFQUNFRyxNQURGLEVBQzZCZixPQUQ3QixFQUVFZ0IsV0FGRixFQUUwQztBQUN4QyxRQUFJSixtQkFBbUJILE1BQW5CLEtBQThCLENBQWxDLEVBQXFDO0FBQ25DLGVBQU8sRUFBUDtBQUNELEtBRkQsTUFFTztBQUNMakIsZ0JBQVEsMEJBQVI7QUFDQSxZQUFJeUIsdUJBQXVCTixxQkFBcUJDLGtCQUFyQixFQUF5Q0csTUFBekMsQ0FBM0I7QUFDQXZCLGdCQUFRLGdDQUFpQ3lCLHFCQUFxQlIsTUFBdEQsR0FBZ0UsTUFBeEU7QUFDQSxZQUFJUyxpQkFBaUJ2QixPQUFPNEIseUJBQVAsQ0FBaUNOLG9CQUFqQyxFQUF1RGxCLFFBQXZELEVBQWlFQyxPQUFqRSxFQUEwRWdCLFdBQTFFLENBQXJCLENBSkssQ0FJd0c7QUFDN0csWUFBRzVCLFNBQVNhLE9BQVosRUFBcUI7QUFDbkJiLHFCQUFTLHFCQUFxQmMsS0FBS0MsU0FBTCxDQUFlZSxjQUFmLEVBQStCZCxTQUEvQixFQUEwQyxDQUExQyxDQUE5QjtBQUNEO0FBQ0RaLGdCQUFRLDJCQUEyQjBCLGVBQWVULE1BQTFDLEdBQW1ELE1BQTNEO0FBQ0EsWUFBSVcsa0JBQWtCekIsT0FBTzBCLG1CQUFQLENBQTJCSCxjQUEzQixDQUF0QjtBQUNBLFlBQUk5QixTQUFTYSxPQUFiLEVBQXNCO0FBQ3BCYixxQkFBUyxnQ0FBZ0NjLEtBQUtDLFNBQUwsQ0FBZWlCLGVBQWYsRUFBZ0NoQixTQUFoQyxFQUEyQyxDQUEzQyxDQUF6QztBQUNEO0FBQ0RaLGdCQUFRLGtDQUFrQzRCLGdCQUFnQlgsTUFBbEQsR0FBMkQsR0FBbkU7QUFDQSxlQUFPVyxlQUFQO0FBQ0Q7QUFDRjtBQXJCZVYsUUFBQVksb0JBQUEsR0FBb0JBLG9CQUFwQjtBQXdCaEIsU0FBQUUsdUJBQUEsQ0FBd0NDLFVBQXhDLEVBQThEYixrQkFBOUQsRUFDRUcsTUFERixFQUM2QmYsT0FEN0IsRUFDNkRnQixXQUQ3RCxFQUN1RztBQUNyRyxRQUFJSixtQkFBbUJILE1BQW5CLEtBQThCLENBQWxDLEVBQXFDO0FBQ25DLGVBQU8sRUFBUDtBQUNELEtBRkQsTUFFTztBQUNMbkIsZ0JBQVEsb0JBQVI7QUFDQUUsZ0JBQVEseUJBQVI7QUFDQSxZQUFJeUIsdUJBQXVCTixxQkFBcUJDLGtCQUFyQixFQUF5Q0csTUFBekMsQ0FBM0I7QUFDQXZCLGdCQUFRLHlCQUF5QnlCLHFCQUFxQlIsTUFBOUMsR0FBdUQsTUFBL0Q7QUFDQSxZQUFJUyxpQkFBaUJ2QixPQUFPK0IsbUNBQVAsQ0FBMkNULG9CQUEzQyxFQUFpRVEsVUFBakUsRUFBNkV6QixPQUE3RSxFQUFzRmdCLFdBQXRGLENBQXJCLENBTEssQ0FLb0g7QUFDekgsWUFBRzVCLFNBQVNhLE9BQVosRUFBb0I7QUFDbEJiLHFCQUFTLHFCQUFxQmMsS0FBS0MsU0FBTCxDQUFlZSxjQUFmLEVBQStCZCxTQUEvQixFQUEwQyxDQUExQyxDQUE5QjtBQUNEO0FBQ0RaLGdCQUFRLDRCQUE0QjBCLGVBQWVULE1BQTNDLEdBQW9ELE1BQTVEO0FBQ0EsWUFBSVcsa0JBQWtCekIsT0FBT2dDLHdCQUFQLENBQWdDVCxjQUFoQyxDQUF0QjtBQUNBLFlBQUk5QixTQUFTYSxPQUFiLEVBQXNCO0FBQ3BCYixxQkFBUyxnQ0FBZ0NjLEtBQUtDLFNBQUwsQ0FBZWlCLGVBQWYsRUFBZ0NoQixTQUFoQyxFQUEyQyxDQUEzQyxDQUF6QztBQUNEO0FBQ0RaLGdCQUFRLGdDQUFnQzRCLGdCQUFnQlgsTUFBaEQsR0FBeUQsR0FBakU7QUFDQW5CLGdCQUFRLG9CQUFSO0FBQ0EsZUFBTzhCLGVBQVAsQ0FoQkssQ0FnQm1CO0FBQ3pCO0FBQ0Y7QUF0QmVWLFFBQUFjLHVCQUFBLEdBQXVCQSx1QkFBdkI7QUF5QmhCLFNBQUFJLHlCQUFBLENBQTBDSCxVQUExQyxFQUFnRWIsa0JBQWhFLEVBQ0VHLE1BREYsRUFDNkJmLE9BRDdCLEVBRUVnQixXQUZGLEVBRTBDO0FBQ3hDLFFBQUlKLG1CQUFtQkgsTUFBbkIsS0FBOEIsQ0FBbEMsRUFBcUM7QUFDbkMsZUFBTyxFQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0xqQixnQkFBUSwwQkFBUjtBQUNBLFlBQUl5Qix1QkFBdUJOLHFCQUFxQkMsa0JBQXJCLEVBQXlDRyxNQUF6QyxDQUEzQjtBQUNBdkIsZ0JBQVEsZ0NBQWlDeUIscUJBQXFCUixNQUF0RCxHQUFnRSxNQUF4RTtBQUNBLFlBQUlTLGlCQUFpQnZCLE9BQU9rQyw4QkFBUCxDQUFzQ1osb0JBQXRDLEVBQTREUSxVQUE1RCxFQUF3RXpCLE9BQXhFLEVBQWlGZ0IsV0FBakYsQ0FBckIsQ0FKSyxDQUkrRztBQUNwSCxZQUFHNUIsU0FBU2EsT0FBWixFQUFxQjtBQUNuQmIscUJBQVMscUJBQXFCYyxLQUFLQyxTQUFMLENBQWVlLGNBQWYsRUFBK0JkLFNBQS9CLEVBQTBDLENBQTFDLENBQTlCO0FBQ0Q7QUFDRFosZ0JBQVEsMkJBQTJCMEIsZUFBZVQsTUFBMUMsR0FBbUQsTUFBM0Q7QUFDQSxZQUFJVyxrQkFBa0J6QixPQUFPZ0Msd0JBQVAsQ0FBZ0NULGNBQWhDLENBQXRCO0FBQ0EsWUFBSTlCLFNBQVNhLE9BQWIsRUFBc0I7QUFDcEJiLHFCQUFTLGdDQUFnQ2MsS0FBS0MsU0FBTCxDQUFlaUIsZUFBZixFQUFnQ2hCLFNBQWhDLEVBQTJDLENBQTNDLENBQXpDO0FBQ0Q7QUFDRFosZ0JBQVEsa0NBQWtDNEIsZ0JBQWdCWCxNQUFsRCxHQUEyRCxHQUFuRTtBQUNBLGVBQU9XLGVBQVA7QUFDRDtBQUNGO0FBckJlVixRQUFBa0IseUJBQUEsR0FBeUJBLHlCQUF6QjtBQXlCaEIsU0FBQUUsb0JBQUEsQ0FBcUNDLFFBQXJDLEVBQWlFQyxRQUFqRSxFQUFxRkMsTUFBckYsRUFBc0c7QUFDcEcsUUFBSUMsYUFBYXpDLFVBQVUwQyxnQkFBVixDQUEyQkgsU0FBU0ksV0FBVCxFQUEzQixDQUFqQjtBQUNBLFdBQU9ILE9BQU8zQixNQUFQLENBQWMsVUFBUytCLEdBQVQsRUFBWTtBQUMvQixlQUFPM0MsU0FBUzRDLE9BQVQsQ0FBaUJQLFFBQWpCLEVBQTJCRyxVQUEzQixFQUF1Q0csSUFBSUQsV0FBSixFQUF2QyxDQUFQO0FBQ0QsS0FGTSxFQUVKRyxJQUZJLEVBQVA7QUFHRDtBQUxlN0IsUUFBQW9CLG9CQUFBLEdBQW9CQSxvQkFBcEI7QUFPaEIsU0FBQVUsc0JBQUEsQ0FBZ0NDLENBQWhDLEVBQTJDQyxDQUEzQyxFQUFxRDtBQUNuRCxRQUFJQyxJQUFJRixFQUFFTCxXQUFGLEdBQWdCUSxhQUFoQixDQUE4QkYsRUFBRU4sV0FBRixFQUE5QixDQUFSO0FBQ0EsUUFBSU8sQ0FBSixFQUFPO0FBQ0wsZUFBT0EsQ0FBUDtBQUNEO0FBQ0QsV0FBTyxDQUFDRixFQUFFRyxhQUFGLENBQWdCRixDQUFoQixDQUFSO0FBQ0Q7QUFFRDs7OztBQUlBLFNBQUFHLG9CQUFBLENBQXFDQyxHQUFyQyxFQUFtRDtBQUNqREEsUUFBSVAsSUFBSixDQUFTQyxzQkFBVDtBQUNBcEQsYUFBUyxlQUFlYyxLQUFLQyxTQUFMLENBQWUyQyxHQUFmLENBQXhCO0FBQ0EsV0FBT0EsSUFBSXhDLE1BQUosQ0FBVyxVQUFTeUMsQ0FBVCxFQUFZQyxLQUFaLEVBQWlCO0FBQ2pDLGVBQU9BLFVBQVUsQ0FBVixJQUFnQixNQUFNRixJQUFJRSxRQUFPLENBQVgsRUFBZVosV0FBZixHQUE2QlEsYUFBN0IsQ0FBMkNHLEVBQUVYLFdBQUYsRUFBM0MsQ0FBN0I7QUFDRCxLQUZNLENBQVA7QUFHRDtBQU5lMUIsUUFBQW1DLG9CQUFBLEdBQW9CQSxvQkFBcEI7QUFNZjtBQUVELFNBQUFJLG9DQUFBLENBQXFEbEIsUUFBckQsRUFBaUZDLFFBQWpGLEVBQ0VqQyxRQURGLEVBQ3FCQyxPQURyQixFQUNxRGtELFlBRHJELEVBQzJFO0FBQ3ZFLFFBQUloQixhQUFhekMsVUFBVTBELFVBQVYsQ0FBcUJuQixTQUFTSSxXQUFULEVBQXJCLENBQWpCO0FBQ0EsUUFBSTVCLE1BQU0sRUFBVjtBQUNBLFFBQUk0QyxPQUFPLEVBQVg7QUFDQXBELFlBQVFxRCxPQUFSLENBQWdCLFVBQVM5QyxNQUFULEVBQWU7QUFDN0IsWUFBRzJDLGdCQUFnQjNDLE9BQVEsU0FBUixNQUF1QjJDLFlBQTFDLEVBQXdEO0FBQ3REO0FBQ0Q7QUFDRCxZQUFHM0MsT0FBT1IsUUFBUCxLQUFvQkwsU0FBUzRDLE9BQVQsQ0FBaUJQLFFBQWpCLEVBQTJCRyxVQUEzQixFQUF1QzNCLE9BQU9SLFFBQVAsRUFBaUJxQyxXQUFqQixFQUF2QyxDQUF2QixFQUErRjtBQUM3RixnQkFBRyxDQUFDZ0IsS0FBSzdDLE9BQU9SLFFBQVAsQ0FBTCxDQUFKLEVBQTRCO0FBQzFCcUQscUJBQUs3QyxPQUFPUixRQUFQLENBQUwsSUFBeUIsSUFBekI7QUFDQVMsb0JBQUk4QyxJQUFKLENBQVMvQyxPQUFPUixRQUFQLENBQVQ7QUFDRDtBQUNGO0FBQ0YsS0FWRDtBQVdBLFdBQU84QyxxQkFBcUJyQyxHQUFyQixDQUFQO0FBQ0g7QUFqQmVFLFFBQUF1QyxvQ0FBQSxHQUFvQ0Esb0NBQXBDO0FBaUJmO0FBRUQsU0FBQU0sZ0JBQUEsQ0FBaUNkLENBQWpDLEVBQTZDZSxTQUE3QyxFQUErRDtBQUM3RCxRQUFJQyxNQUFNaEUsVUFBVTBELFVBQVYsQ0FBcUJWLEVBQUVMLFdBQUYsRUFBckIsS0FBMEMsRUFBcEQ7QUFDQSxRQUFJc0IsY0FBY2pFLFVBQVUwRCxVQUFWLENBQXFCLENBQUNLLGFBQVksRUFBYixFQUFpQnBCLFdBQWpCLEVBQXJCLEtBQXdELEVBQTFFO0FBQ0EsUUFBSXFCLFFBQVFDLFdBQVosRUFBeUI7QUFDdkIsZUFBTyxJQUFQO0FBQ0Q7QUFDRCxRQUFJRCxNQUFLLEdBQUwsS0FBYUMsV0FBakIsRUFBOEI7QUFDNUIsZUFBTyxJQUFQO0FBQ0Q7QUFDRCxXQUFPLEtBQVA7QUFDRDtBQVZlaEQsUUFBQTZDLGdCQUFBLEdBQWdCQSxnQkFBaEI7QUFVZjtBQUdELFNBQUFJLG1CQUFBLENBQW9DNUQsUUFBcEMsRUFBc0RDLE9BQXRELEVBQW9GO0FBQ2xGLFFBQUlrQixpQkFBaUJwQiwwQkFBMEJDLFFBQTFCLEVBQW9DQyxPQUFwQyxDQUFyQixDQURrRixDQUNmO0FBQ25FWixhQUFTLDBCQUEwQmMsS0FBS0MsU0FBTCxDQUFlZSxjQUFmLEVBQStCZCxTQUEvQixFQUEwQyxDQUExQyxDQUFuQztBQUVBLFdBQU9jLGNBQVA7QUFDRDtBQUxlUixRQUFBaUQsbUJBQUEsR0FBbUJBLG1CQUFuQjtBQU9oQixTQUFBQyxnQkFBQSxDQUFpQ0MsT0FBakMsRUFBbUQ7QUFDakQsUUFBSUEsUUFBUXBELE1BQVIsS0FBbUIsQ0FBdkIsRUFBMEI7QUFDeEIsZUFBTyxFQUFQO0FBQ0Q7QUFDRCxXQUFPLE1BQU1vRCxRQUFRdEIsSUFBUixHQUFldUIsSUFBZixDQUFvQixNQUFwQixDQUFOLEdBQW9DLEdBQTNDO0FBQ0Q7QUFMZXBELFFBQUFrRCxnQkFBQSxHQUFnQkEsZ0JBQWhCO0FBT2hCLFNBQUFHLFlBQUEsQ0FBNkJoRSxRQUE3QixFQUFnREMsT0FBaEQsRUFBK0U7QUFDN0UsUUFBSVEsTUFBTVIsUUFBUWdFLE1BQVIsQ0FBZSxVQUFTQyxJQUFULEVBQWVDLE9BQWYsRUFBc0I7QUFDN0NELGFBQUtDLFFBQVFuRSxRQUFSLENBQUwsSUFBMEIsQ0FBMUI7QUFDQSxlQUFPa0UsSUFBUDtBQUNELEtBSFMsRUFHUixFQUhRLENBQVY7QUFJQSxXQUFPTCxpQkFBaUJPLE9BQU9DLElBQVAsQ0FBWTVELEdBQVosQ0FBakIsQ0FBUDtBQUNEO0FBTmVFLFFBQUFxRCxZQUFBLEdBQVlBLFlBQVo7QUFRaEIsU0FBQU0sOEJBQUEsQ0FBZ0RDLE9BQWhELEVBQXFGO0FBQ25GLFdBQU9WLGlCQUFpQlUsUUFBUUMsR0FBUixDQUFZLFVBQVNDLE9BQVQsRUFBZ0I7QUFDbEQsZUFBT0EsUUFBUUMsTUFBZjtBQUNELEtBRnVCLENBQWpCLENBQVA7QUFHRDtBQUplL0QsUUFBQTJELDhCQUFBLEdBQThCQSw4QkFBOUI7QUFNaEIsU0FBQUssV0FBQSxDQUE0QkMsT0FBNUIsRUFBZ0U7QUFDOUQsUUFBSW5FLE1BQU8sRUFBWDtBQUNBLFFBQUlvRSxNQUFNRCxRQUFRWCxNQUFSLENBQWUsVUFBVUMsSUFBVixFQUFnQlEsTUFBaEIsRUFBc0I7QUFDN0MsWUFBSUEsT0FBT0ksUUFBUCxLQUFvQkYsUUFBUSxDQUFSLEVBQVdFLFFBQW5DLEVBQTZDO0FBQzNDLGdCQUFHckUsSUFBSXNFLE9BQUosQ0FBWUwsT0FBT0EsTUFBbkIsSUFBNkIsQ0FBaEMsRUFBbUM7QUFDakNqRSxvQkFBSThDLElBQUosQ0FBU21CLE9BQU9BLE1BQWhCO0FBQ0Q7QUFDRCxtQkFBT1IsT0FBTyxDQUFkO0FBQ0Q7QUFDRixLQVBTLEVBT1AsQ0FQTyxDQUFWO0FBUUEsV0FBT3pELEdBQVA7QUFDRDtBQVhlRSxRQUFBZ0UsV0FBQSxHQUFXQSxXQUFYO0FBYWhCLElBQVlLLFFBQUs1RixRQUFNLGdCQUFOLENBQWpCO0FBRUEsU0FBQTZGLGdCQUFBLENBQWlDTCxPQUFqQyxFQUEwRTtBQUN4RSxRQUFJbkUsTUFBTyxFQUFYO0FBQ0EsUUFBSW9FLE1BQU1ELFFBQVFYLE1BQVIsQ0FBZSxVQUFVQyxJQUFWLEVBQWdCUSxNQUFoQixFQUFzQjtBQUM3QyxZQUFJQSxPQUFPSSxRQUFQLEtBQW9CRixRQUFRLENBQVIsRUFBV0UsUUFBbkMsRUFBNkM7QUFDM0MsZ0JBQUlJLFFBQVFGLE1BQU1HLG9CQUFOLENBQTJCVCxPQUFPQSxNQUFsQyxDQUFaO0FBQ0EsZ0JBQUdqRSxJQUFJc0UsT0FBSixDQUFZRyxLQUFaLElBQXFCLENBQXhCLEVBQTJCO0FBQ3pCekUsb0JBQUk4QyxJQUFKLENBQVMyQixLQUFUO0FBQ0Q7QUFDRCxtQkFBT2hCLE9BQU8sQ0FBZDtBQUNEO0FBQ0YsS0FSUyxFQVFQLENBUk8sQ0FBVjtBQVNBLFdBQU96RCxHQUFQO0FBQ0Q7QUFaZUUsUUFBQXNFLGdCQUFBLEdBQWdCQSxnQkFBaEI7QUFjaEIsU0FBQUcsV0FBQSxDQUE0QkMsUUFBNUIsRUFBdUR4RSxrQkFBdkQsRUFBaUY7QUFDaEY7QUFDQTtBQUNDLFFBQUlKLE1BQU1HLHFCQUFxQkMsa0JBQXJCLEVBQXlDd0UsU0FBU3ZFLEtBQWxELENBQVY7QUFDQTtBQUNBO0FBQ0EsUUFBRyxDQUFDTCxJQUFJQyxNQUFSLEVBQWdCO0FBQ2QsZUFBT0wsU0FBUDtBQUNEO0FBQ0QsUUFBSWlGLFVBQVUsRUFBZDtBQUNBO0FBQ0E7QUFDQTdFLFFBQUksQ0FBSixFQUFPNkMsT0FBUCxDQUFlLFVBQVNpQyxVQUFULEVBQW1CO0FBQ2hDLFlBQUdBLFdBQVd2RixRQUFYLEtBQXdCLFFBQTNCLEVBQXFDO0FBQ25Dc0Ysb0JBQVEvQixJQUFSLENBQWFnQyxXQUFXQyxhQUF4QjtBQUNEO0FBQ0YsS0FKRDtBQUtBLFFBQUdGLFFBQVE1RSxNQUFSLEtBQW1CLENBQXRCLEVBQXlCO0FBQ3ZCckIsaUJBQVMsMEJBQTBCaUcsUUFBUSxDQUFSLENBQW5DO0FBQ0EsZUFBT0EsUUFBUSxDQUFSLENBQVA7QUFDRDtBQUNELFFBQUdBLFFBQVE1RSxNQUFSLEdBQWlCLENBQXBCLEVBQXdCO0FBQ3RCckIsaUJBQVMseUNBQXlDaUcsUUFBUXZCLElBQVIsQ0FBYSxJQUFiLENBQWxEO0FBQ0EsZUFBTzFELFNBQVA7QUFFRDtBQUNEaEIsYUFBUyxvQ0FBVDtBQUNBO0FBQ0FvQixRQUFJLENBQUosRUFBTzZDLE9BQVAsQ0FBZSxVQUFTaUMsVUFBVCxFQUFtQjtBQUNoQyxZQUFHQSxXQUFXdkYsUUFBWCxLQUF3QixVQUEzQixFQUF1QztBQUNyQyxnQkFBSXlGLE9BQU9GLFdBQVdDLGFBQXRCO0FBQ0EsZ0JBQUlFLE9BQU83RixNQUFNOEYscUJBQU4sQ0FBNEJOLFFBQTVCLEVBQXFDSSxJQUFyQyxDQUFYO0FBQ0FDLGlCQUFLcEMsT0FBTCxDQUFhLFVBQVNzQyxJQUFULEVBQWE7QUFDeEIsb0JBQUdOLFFBQVFQLE9BQVIsQ0FBZ0JhLElBQWhCLElBQXdCLENBQTNCLEVBQThCO0FBQzVCTiw0QkFBUS9CLElBQVIsQ0FBYXFDLElBQWI7QUFDRDtBQUNGLGFBSkQ7QUFLRDtBQUNGLEtBVkQ7QUFXQSxRQUFHTixRQUFRNUUsTUFBUixLQUFtQixDQUF0QixFQUF5QjtBQUN0QnJCLGlCQUFTLDBCQUEwQmlHLFFBQVEsQ0FBUixDQUFuQztBQUNELGVBQU9BLFFBQVEsQ0FBUixDQUFQO0FBQ0Q7QUFDRGpHLGFBQVMseUNBQXlDaUcsUUFBUXZCLElBQVIsQ0FBYSxJQUFiLENBQWxEO0FBQ0EsV0FBTzFELFNBQVA7QUFDRDtBQTdDZU0sUUFBQXlFLFdBQUEsR0FBV0EsV0FBWDtBQTZDZiIsImZpbGUiOiJtYXRjaC9saXN0YWxsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgYW5hbHl6ZS50c1xuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cblxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXIgZnJvbSAnLi9pbnB1dEZpbHRlcic7XG5cbmltcG9ydCAqIGFzIEFsZ29sIGZyb20gJy4vYWxnb2wnO1xuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdsaXN0YWxsJyk7XG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcbnZhciBsb2dQZXJmID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcbnZhciBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcbi8vY29uc3QgcGVyZmxvZyA9IGxvZ2dlci5wZXJmKFwicGVyZmxpc3RhbGxcIik7XG5cbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3V0aWxzL3V0aWxzJztcblxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XG5cbmltcG9ydCAqIGFzIFRvb2xtYXRjaGVyIGZyb20gJy4vdG9vbG1hdGNoZXInO1xuaW1wb3J0ICogYXMgQnJlYWtEb3duIGZyb20gJy4vYnJlYWtkb3duJztcblxuaW1wb3J0ICogYXMgU2VudGVuY2UgZnJvbSAnLi9zZW50ZW5jZSc7XG5cbmltcG9ydCAqIGFzIFdvcmQgZnJvbSAnLi93b3JkJztcbmltcG9ydCAqIGFzIE9wZXJhdG9yIGZyb20gJy4vb3BlcmF0b3InO1xuXG5pbXBvcnQgKiBhcyBXaGF0SXMgZnJvbSAnLi93aGF0aXMnO1xuXG5pbXBvcnQgKiBhcyBNb2RlbCBmcm9tICcuLi9tb2RlbC9tb2RlbCc7XG5pbXBvcnQgKiBhcyBNYXRjaCBmcm9tICcuL21hdGNoJztcblxudmFyIHNXb3JkcyA9IHt9O1xuXG5leHBvcnQgZnVuY3Rpb24gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeShjYXRlZ29yeTogc3RyaW5nLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pXG4gIDogQXJyYXk8SU1hdGNoLklSZWNvcmQ+IHtcbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHJlY29yZHMsdW5kZWZpbmVkLDIpIDogXCItXCIpO1xuICB2YXIgcmVsZXZhbnRSZWNvcmRzID0gcmVjb3Jkcy5maWx0ZXIoZnVuY3Rpb24gKHJlY29yZDogSU1hdGNoLklSZWNvcmQpIHtcbiAgICByZXR1cm4gKHJlY29yZFtjYXRlZ29yeV0gIT09IHVuZGVmaW5lZCkgJiYgKHJlY29yZFtjYXRlZ29yeV0gIT09IG51bGwpO1xuICB9KTtcbiAgdmFyIHJlcyA9IFtdO1xuICBkZWJ1Z2xvZyhcInJlbGV2YW50IHJlY29yZHMgbnI6XCIgKyByZWxldmFudFJlY29yZHMubGVuZ3RoKTtcbiAgcmV0dXJuIHJlbGV2YW50UmVjb3Jkcztcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nIDogc3RyaW5nLCAgcnVsZXM6IElNYXRjaC5TcGxpdFJ1bGVzKSB7XG4gIHJldHVybiBXaGF0SXMuYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLHJ1bGVzKTtcbn1cblxuLy8gY29uc3QgcmVzdWx0ID0gV2hhdElzLnJlc29sdmVDYXRlZ29yeShjYXQsIGExLmVudGl0eSxcbi8vICAgdGhlTW9kZWwubVJ1bGVzLCB0aGVNb2RlbC50b29scywgdGhlTW9kZWwucmVjb3Jkcyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0QWxsV2l0aENvbnRleHQoY2F0ZWdvcnk6IHN0cmluZywgY29udGV4dFF1ZXJ5U3RyaW5nOiBzdHJpbmcsXG4gIGFSdWxlczogSU1hdGNoLlNwbGl0UnVsZXMsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPiwgY2F0ZWdvcnlTZXQ/OiB7IFtrZXkgOiBzdHJpbmddIDogYm9vbGVhbiB9KTogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+IHtcbiAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH0gZWxzZSB7XG4gICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0XCIpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICBkZWJ1Z2xvZyhcImxpc3RBbGxXaXRoQ29udGV4dDptYXRjaGluZyByZWNvcmRzIChzPVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgIGRlYnVnbG9nKFwiaGVyZSBzZW50ZW5jZXNcIiArIEpTT04uc3RyaW5naWZ5KGFTZW50ZW5jZXNSZWluZm9yY2VkLHVuZGVmaW5lZCwyKSk7XG4gICAgcGVyZmxvZyhcIm1hdGNoaW5nIHJlY29yZHMgKHM9XCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3Jkc1F1aWNrKGFTZW50ZW5jZXNSZWluZm9yY2VkLCBjYXRlZ29yeSwgcmVjb3JkcywgY2F0ZWdvcnlTZXQpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKXtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwiZmlsdGVyaW5nIHRvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWQobWF0Y2hlZEFuc3dlcnMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0IChhPVwiICsgbWF0Y2hlZEZpbHRlcmVkLmxlbmd0aCArIFwiKVwiKTtcbiAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICByZXR1cm4gbWF0Y2hlZEZpbHRlcmVkOyAvLyA/Pz8gQW5zd2VycztcbiAgfVxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0QWxsSGF2aW5nQ29udGV4dChjYXRlZ29yeTogc3RyaW5nLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyxcbiAgYVJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+LFxuICBjYXRlZ29yeVNldCA6IHsgW2tleTpzdHJpbmddIDogYm9vbGVhbiB9KTogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+IHtcbiAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH0gZWxzZSB7XG4gICAgcGVyZmxvZyhcImFuYWx5emVDb250ZXh0U3RyaW5nIC4uLlwiKTtcbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgcGVyZmxvZyhcIm1hdGNoaW5nIHJlY29yZHMgaGF2aW5nIChzPVwiICsgKGFTZW50ZW5jZXNSZWluZm9yY2VkLmxlbmd0aCkgKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3Jkc0hhdmluZ0NvbnRleHQoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3J5LCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwiZmlsdGVyaW5nVG9wUmFua2VkIChhPVwiICsgbWF0Y2hlZEFuc3dlcnMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgIHZhciBtYXRjaGVkRmlsdGVyZWQgPSBXaGF0SXMuZmlsdGVyT25seVRvcFJhbmtlZChtYXRjaGVkQW5zd2Vycyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsSGF2aW5nQ29udGV4dCAoYT1cIiArIG1hdGNoZWRGaWx0ZXJlZC5sZW5ndGggKyBcIilcIik7XG4gICAgcmV0dXJuIG1hdGNoZWRGaWx0ZXJlZDtcbiAgfVxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0QWxsVHVwZWxXaXRoQ29udGV4dChjYXRlZ29yaWVzOiBzdHJpbmdbXSwgY29udGV4dFF1ZXJ5U3RyaW5nOiBzdHJpbmcsXG4gIGFSdWxlczogSU1hdGNoLlNwbGl0UnVsZXMsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPiwgY2F0ZWdvcnlTZXQ/OiB7IFtrZXkgOiBzdHJpbmddIDogYm9vbGVhbiB9KTogQXJyYXk8SU1hdGNoLklXaGF0SXNUdXBlbEFuc3dlcj4ge1xuICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfSBlbHNlIHtcbiAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIChzPVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNRdWlja011bHRpcGxlQ2F0ZWdvcmllcyhhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcmllcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKXtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwiZmlsdGVyaW5nIHRvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWRUdXBlbChtYXRjaGVkQW5zd2Vycyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgIHJldHVybiBtYXRjaGVkRmlsdGVyZWQ7IC8vID8/PyBBbnN3ZXJzO1xuICB9XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxUdXBlbEhhdmluZ0NvbnRleHQoY2F0ZWdvcmllczogc3RyaW5nW10sIGNvbnRleHRRdWVyeVN0cmluZzogc3RyaW5nLFxuICBhUnVsZXM6IElNYXRjaC5TcGxpdFJ1bGVzLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4sXG4gIGNhdGVnb3J5U2V0IDogeyBba2V5OnN0cmluZ10gOiBib29sZWFuIH0pOiBBcnJheTxJTWF0Y2guSVdoYXRJc1R1cGVsQW5zd2VyPiB7XG4gIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9IGVsc2Uge1xuICAgIHBlcmZsb2coXCJhbmFseXplQ29udGV4dFN0cmluZyAuLi5cIik7XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIGhhdmluZyAocz1cIiArIChhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGgpICsgXCIpLi4uXCIpO1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNUdXBlbEhhdmluZ0NvbnRleHQoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3JpZXMsIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJmaWx0ZXJpbmdUb3BSYW5rZWQgKGE9XCIgKyBtYXRjaGVkQW5zd2Vycy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkVHVwZWwobWF0Y2hlZEFuc3dlcnMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbEhhdmluZ0NvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgIHJldHVybiBtYXRjaGVkRmlsdGVyZWQ7XG4gIH1cbn1cblxuXG5cbmV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJTdHJpbmdMaXN0QnlPcChvcGVyYXRvcjogSU1hdGNoLklPcGVyYXRvciwgZnJhZ21lbnQgOiBzdHJpbmcsICBzcmNhcnIgOiBzdHJpbmdbXSApIDogc3RyaW5nW10ge1xuICB2YXIgZnJhZ21lbnRMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkU3BhY2VkKGZyYWdtZW50LnRvTG93ZXJDYXNlKCkpO1xuICByZXR1cm4gc3JjYXJyLmZpbHRlcihmdW5jdGlvbihzdHIpIHtcbiAgICByZXR1cm4gT3BlcmF0b3IubWF0Y2hlcyhvcGVyYXRvciwgZnJhZ21lbnRMQywgc3RyLnRvTG93ZXJDYXNlKCkpO1xuICB9KS5zb3J0KCk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVDYXNlSW5zZW5zaXRpdmUoYTogc3RyaW5nLCBiIDogc3RyaW5nKSB7XG4gIHZhciByID0gYS50b0xvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUoYi50b0xvd2VyQ2FzZSgpKTtcbiAgaWYgKHIpIHtcbiAgICByZXR1cm4gcjtcbiAgfVxuICByZXR1cm4gLWEubG9jYWxlQ29tcGFyZShiKTtcbn1cblxuLyoqXG4gKiBTb3J0IHN0cmluZyBsaXN0IGNhc2UgaW5zZW5zaXRpdmUsIHRoZW4gcmVtb3ZlIGR1cGxpY2F0ZXMgcmV0YWluaW5nXG4gKiBcImxhcmdlc3RcIiBtYXRjaFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlQ2FzZUR1cGxpY2F0ZXMoYXJyIDogc3RyaW5nW10pIDogc3RyaW5nW10ge1xuICBhcnIuc29ydChjb21wYXJlQ2FzZUluc2Vuc2l0aXZlKTtcbiAgZGVidWdsb2coJ3NvcnRlZCBhcnInICsgSlNPTi5zdHJpbmdpZnkoYXJyKSk7XG4gIHJldHVybiBhcnIuZmlsdGVyKGZ1bmN0aW9uKHMsIGluZGV4KSB7XG4gICAgcmV0dXJuIGluZGV4ID09PSAwIHx8ICgwICE9PSBhcnJbaW5kZXggLTEgXS50b0xvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUocy50b0xvd2VyQ2FzZSgpKSk7XG4gIH0pO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyhvcGVyYXRvcjogSU1hdGNoLklPcGVyYXRvciwgZnJhZ21lbnQgOiBzdHJpbmcsXG4gIGNhdGVnb3J5IDogc3RyaW5nLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4sIGZpbHRlckRvbWFpbj8gOiBzdHJpbmcpIDogc3RyaW5nW10ge1xuICAgIHZhciBmcmFnbWVudExDID0gQnJlYWtEb3duLnRyaW1RdW90ZWQoZnJhZ21lbnQudG9Mb3dlckNhc2UoKSk7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBzZWVuID0ge307XG4gICAgcmVjb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uKHJlY29yZCkge1xuICAgICAgaWYoZmlsdGVyRG9tYWluICYmIHJlY29yZCBbJ19kb21haW4nXSAhPT0gZmlsdGVyRG9tYWluKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmKHJlY29yZFtjYXRlZ29yeV0gJiYgT3BlcmF0b3IubWF0Y2hlcyhvcGVyYXRvciwgZnJhZ21lbnRMQywgcmVjb3JkW2NhdGVnb3J5XS50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgICBpZighc2VlbltyZWNvcmRbY2F0ZWdvcnldXSkge1xuICAgICAgICAgIHNlZW5bcmVjb3JkW2NhdGVnb3J5XV0gPSB0cnVlO1xuICAgICAgICAgIHJlcy5wdXNoKHJlY29yZFtjYXRlZ29yeV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlbW92ZUNhc2VEdXBsaWNhdGVzKHJlcyk7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gbGlrZWx5UGx1cmFsRGlmZihhIDogc3RyaW5nLCBwbHVyYWxPZmEgOiBzdHJpbmcpIDogYm9vbGVhbiB7XG4gIHZhciBhTEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZChhLnRvTG93ZXJDYXNlKCkpICB8fCBcIlwiO1xuICB2YXIgcGx1cmFsT2ZBTEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZCgocGx1cmFsT2ZhIHx8XCJcIikudG9Mb3dlckNhc2UoKSkgfHwgXCJcIjtcbiAgaWYgKGFMQyA9PT0gcGx1cmFsT2ZBTEMpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBpZiggYUxDICsncycgPT09IHBsdXJhbE9mQUxDKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuXG5leHBvcnQgZnVuY3Rpb24gbGlzdEFsbFdpdGhDYXRlZ29yeShjYXRlZ29yeTogc3RyaW5nLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pOiBBcnJheTxJTWF0Y2guSVJlY29yZD4ge1xuICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gIGRlYnVnbG9nKFwiIGxpc3RBbGxXaXRoQ2F0ZWdvcnk6XCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG5cbiAgcmV0dXJuIG1hdGNoZWRBbnN3ZXJzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gam9pblNvcnRlZFF1b3RlZChzdHJpbmdzIDogc3RyaW5nW10gKSA6IHN0cmluZyB7XG4gIGlmIChzdHJpbmdzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBcIlwiO1xuICB9XG4gIHJldHVybiAnXCInICsgc3RyaW5ncy5zb3J0KCkuam9pbignXCI7IFwiJykgKyAnXCInO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gam9pbkRpc3RpbmN0KGNhdGVnb3J5IDogc3RyaW5nLCByZWNvcmRzIDogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KSA6IHN0cmluZyB7XG4gIHZhciByZXMgPSByZWNvcmRzLnJlZHVjZShmdW5jdGlvbihwcmV2LCBvUmVjb3JkKSB7XG4gICAgcHJldltvUmVjb3JkW2NhdGVnb3J5XV0gPSAxO1xuICAgIHJldHVybiBwcmV2O1xuICB9LHt9IGFzIGFueSk7XG4gIHJldHVybiBqb2luU29ydGVkUXVvdGVkKE9iamVjdC5rZXlzKHJlcykpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0RGlzdGluY3RGcm9tV2hhdElmUmVzdWx0KCBhbnN3ZXJzIDogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+KSA6IHN0cmluZyB7XG4gIHJldHVybiBqb2luU29ydGVkUXVvdGVkKGFuc3dlcnMubWFwKGZ1bmN0aW9uKG9BbnN3ZXIpIHtcbiAgICByZXR1cm4gb0Fuc3dlci5yZXN1bHQ7XG4gIH0pKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5SZXN1bHRzKHJlc3VsdHM6IEFycmF5PElNYXRjaC5JV2hhdElzQW5zd2VyPik6IHN0cmluZ1tdIHtcbiAgdmFyIHJlcyAgPSBbXTtcbiAgdmFyIGNudCA9IHJlc3VsdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCByZXN1bHQpIHtcbiAgICBpZiAocmVzdWx0Ll9yYW5raW5nID09PSByZXN1bHRzWzBdLl9yYW5raW5nKSB7XG4gICAgICBpZihyZXMuaW5kZXhPZihyZXN1bHQucmVzdWx0KSA8IDAgKXtcbiAgICAgICAgcmVzLnB1c2gocmVzdWx0LnJlc3VsdCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcHJldiArIDE7XG4gICAgfVxuICB9LCAwKTtcbiAgcmV0dXJuIHJlcztcbn1cblxuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5leHBvcnQgZnVuY3Rpb24gam9pblJlc3VsdHNUdXBlbChyZXN1bHRzOiBBcnJheTxJTWF0Y2guSVdoYXRJc1R1cGVsQW5zd2VyPik6IHN0cmluZ1tdIHtcbiAgdmFyIHJlcyAgPSBbXTtcbiAgdmFyIGNudCA9IHJlc3VsdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCByZXN1bHQpIHtcbiAgICBpZiAocmVzdWx0Ll9yYW5raW5nID09PSByZXN1bHRzWzBdLl9yYW5raW5nKSB7XG4gICAgICB2YXIgdmFsdWUgPSBVdGlscy5saXN0VG9RdW90ZWRDb21tYUFuZChyZXN1bHQucmVzdWx0KTtcbiAgICAgIGlmKHJlcy5pbmRleE9mKHZhbHVlKSA8IDAgKXtcbiAgICAgICAgcmVzLnB1c2godmFsdWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgIH1cbiAgfSwgMCk7XG4gIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmZlckRvbWFpbih0aGVNb2RlbCA6IElNYXRjaC5JTW9kZWxzLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XG4gLy8gY29uc29sZS5sb2coXCJoZXJlIHRoZSBzdHJpbmdcIiArIGNvbnRleHRRdWVyeVN0cmluZyk7XG4gLy8gIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgcnVsZXNcIiArIEpTT04uc3RyaW5naWZ5KHRoZU1vZGVsLm1SdWxlcykpO1xuICB2YXIgcmVzID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCB0aGVNb2RlbC5ydWxlcyk7XG4gIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzLHVuZGVmaW5lZCwyKSk7XG4gIC8vIHJ1biB0aHJvdWdoIHRoZSBzdHJpbmcsIHNlYXJjaCBmb3IgYSBjYXRlZ29yeVxuICBpZighcmVzLmxlbmd0aCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgdmFyIGRvbWFpbnMgPSBbXTtcbiAgLy9jb25zb2xlLmxvZyhTZW50ZW5jZS5kdW1wTmljZUFycihyZXMpKTtcbiAgLy8gZG8gd2UgaGF2ZSBhIGRvbWFpbiA/XG4gIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uKG9Xb3JkR3JvdXApIHtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImRvbWFpblwiKSB7XG4gICAgICBkb21haW5zLnB1c2gob1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nKVxuICAgIH1cbiAgfSk7XG4gIGlmKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgZGVidWdsb2coXCJnb3QgYSBwcmVjaXNlIGRvbWFpbiBcIiArIGRvbWFpbnNbMF0pO1xuICAgIHJldHVybiBkb21haW5zWzBdO1xuICB9XG4gIGlmKGRvbWFpbnMubGVuZ3RoID4gMCApIHtcbiAgICBkZWJ1Z2xvZyhcImdvdCBtb3JlIHRoYW4gb25lIGRvbWFpbiwgY29uZnVzZWQgIFwiICsgZG9tYWlucy5qb2luKFwiXFxuXCIpKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIC8vIFRPRE9EXG4gIH1cbiAgZGVidWdsb2coXCJhdHRlbXB0aW5nIHRvIGRldGVybWluZSBjYXRlZ29yaWVzXCIpXG4gIC8vIHRyeSBhIGNhdGVnb3J5IHJldmVyc2UgbWFwXG4gIHJlc1swXS5mb3JFYWNoKGZ1bmN0aW9uKG9Xb3JkR3JvdXApe1xuICAgIGlmKG9Xb3JkR3JvdXAuY2F0ZWdvcnkgPT09IFwiY2F0ZWdvcnlcIikge1xuICAgICAgdmFyIHNDYXQgPSBvV29yZEdyb3VwLm1hdGNoZWRTdHJpbmc7XG4gICAgICB2YXIgZG9tcyA9IE1vZGVsLmdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbCxzQ2F0KTtcbiAgICAgIGRvbXMuZm9yRWFjaChmdW5jdGlvbihzRG9tKSB7XG4gICAgICAgIGlmKGRvbWFpbnMuaW5kZXhPZihzRG9tKSA8IDApIHtcbiAgICAgICAgICBkb21haW5zLnB1c2goc0RvbSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG4gIGlmKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgIGRlYnVnbG9nKFwiZ290IGEgcHJlY2lzZSBkb21haW4gXCIgKyBkb21haW5zWzBdKTtcbiAgICByZXR1cm4gZG9tYWluc1swXTtcbiAgfVxuICBkZWJ1Z2xvZyhcImdvdCBtb3JlIHRoYW4gb25lIGRvbWFpbiwgY29uZnVzZWQgIFwiICsgZG9tYWlucy5qb2luKFwiXFxuXCIpKTtcbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn07IiwiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgYW5hbHl6ZS50c1xuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbGlzdGFsbCcpO1xudmFyIGxvZ2dlciA9IHJlcXVpcmUoJy4uL3V0aWxzL2xvZ2dlcicpO1xudmFyIGxvZ1BlcmYgPSBsb2dnZXIucGVyZihcInBlcmZsaXN0YWxsXCIpO1xudmFyIHBlcmZsb2cgPSBkZWJ1ZygncGVyZicpO1xudmFyIEJyZWFrRG93biA9IHJlcXVpcmUoJy4vYnJlYWtkb3duJyk7XG52YXIgT3BlcmF0b3IgPSByZXF1aXJlKCcuL29wZXJhdG9yJyk7XG52YXIgV2hhdElzID0gcmVxdWlyZSgnLi93aGF0aXMnKTtcbnZhciBNb2RlbCA9IHJlcXVpcmUoJy4uL21vZGVsL21vZGVsJyk7XG52YXIgc1dvcmRzID0ge307XG5mdW5jdGlvbiBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHJlY29yZHMsIHVuZGVmaW5lZCwgMikgOiBcIi1cIik7XG4gICAgdmFyIHJlbGV2YW50UmVjb3JkcyA9IHJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQpIHtcbiAgICAgICAgcmV0dXJuIChyZWNvcmRbY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpICYmIChyZWNvcmRbY2F0ZWdvcnldICE9PSBudWxsKTtcbiAgICB9KTtcbiAgICB2YXIgcmVzID0gW107XG4gICAgZGVidWdsb2coXCJyZWxldmFudCByZWNvcmRzIG5yOlwiICsgcmVsZXZhbnRSZWNvcmRzLmxlbmd0aCk7XG4gICAgcmV0dXJuIHJlbGV2YW50UmVjb3Jkcztcbn1cbmV4cG9ydHMubWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeSA9IG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnk7XG5mdW5jdGlvbiBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHJ1bGVzKSB7XG4gICAgcmV0dXJuIFdoYXRJcy5hbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHJ1bGVzKTtcbn1cbmV4cG9ydHMuYW5hbHl6ZUNvbnRleHRTdHJpbmcgPSBhbmFseXplQ29udGV4dFN0cmluZztcbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDb250ZXh0KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpIHtcbiAgICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICAgICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0XCIpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIGRlYnVnbG9nKFwibGlzdEFsbFdpdGhDb250ZXh0Om1hdGNoaW5nIHJlY29yZHMgKHM9XCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgICAgIGRlYnVnbG9nKFwiaGVyZSBzZW50ZW5jZXNcIiArIEpTT04uc3RyaW5naWZ5KGFTZW50ZW5jZXNSZWluZm9yY2VkLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgcGVyZmxvZyhcIm1hdGNoaW5nIHJlY29yZHMgKHM9XCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNRdWljayhhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcnksIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwiZmlsdGVyaW5nIHRvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxXaXRoQ29udGV4dCAoYT1cIiArIG1hdGNoZWRGaWx0ZXJlZC5sZW5ndGggKyBcIilcIik7XG4gICAgICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgICAgICByZXR1cm4gbWF0Y2hlZEZpbHRlcmVkOyAvLyA/Pz8gQW5zd2VycztcbiAgICB9XG59XG5leHBvcnRzLmxpc3RBbGxXaXRoQ29udGV4dCA9IGxpc3RBbGxXaXRoQ29udGV4dDtcbmZ1bmN0aW9uIGxpc3RBbGxIYXZpbmdDb250ZXh0KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpIHtcbiAgICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBwZXJmbG9nKFwiYW5hbHl6ZUNvbnRleHRTdHJpbmcgLi4uXCIpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIGhhdmluZyAocz1cIiArIChhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGgpICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzSGF2aW5nQ29udGV4dChhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcnksIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwiZmlsdGVyaW5nVG9wUmFua2VkIChhPVwiICsgbWF0Y2hlZEFuc3dlcnMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWQobWF0Y2hlZEFuc3dlcnMpO1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbEhhdmluZ0NvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgICAgICByZXR1cm4gbWF0Y2hlZEZpbHRlcmVkO1xuICAgIH1cbn1cbmV4cG9ydHMubGlzdEFsbEhhdmluZ0NvbnRleHQgPSBsaXN0QWxsSGF2aW5nQ29udGV4dDtcbmZ1bmN0aW9uIGxpc3RBbGxUdXBlbFdpdGhDb250ZXh0KGNhdGVnb3JpZXMsIGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzLCByZWNvcmRzLCBjYXRlZ29yeVNldCkge1xuICAgIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgICAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICAgICAgcGVyZmxvZyhcIm1hdGNoaW5nIHJlY29yZHMgKHM9XCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNRdWlja011bHRpcGxlQ2F0ZWdvcmllcyhhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcmllcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIHBlcmZsb2coXCJmaWx0ZXJpbmcgdG9wUmFua2VkIChhPVwiICsgbWF0Y2hlZEFuc3dlcnMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWRUdXBlbChtYXRjaGVkQW5zd2Vycyk7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgICAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoZWRGaWx0ZXJlZDsgLy8gPz8/IEFuc3dlcnM7XG4gICAgfVxufVxuZXhwb3J0cy5saXN0QWxsVHVwZWxXaXRoQ29udGV4dCA9IGxpc3RBbGxUdXBlbFdpdGhDb250ZXh0O1xuZnVuY3Rpb24gbGlzdEFsbFR1cGVsSGF2aW5nQ29udGV4dChjYXRlZ29yaWVzLCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpIHtcbiAgICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBwZXJmbG9nKFwiYW5hbHl6ZUNvbnRleHRTdHJpbmcgLi4uXCIpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIGhhdmluZyAocz1cIiArIChhU2VudGVuY2VzUmVpbmZvcmNlZC5sZW5ndGgpICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzVHVwZWxIYXZpbmdDb250ZXh0KGFTZW50ZW5jZXNSZWluZm9yY2VkLCBjYXRlZ29yaWVzLCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcImZpbHRlcmluZ1RvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkVHVwZWwobWF0Y2hlZEFuc3dlcnMpO1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbEhhdmluZ0NvbnRleHQgKGE9XCIgKyBtYXRjaGVkRmlsdGVyZWQubGVuZ3RoICsgXCIpXCIpO1xuICAgICAgICByZXR1cm4gbWF0Y2hlZEZpbHRlcmVkO1xuICAgIH1cbn1cbmV4cG9ydHMubGlzdEFsbFR1cGVsSGF2aW5nQ29udGV4dCA9IGxpc3RBbGxUdXBlbEhhdmluZ0NvbnRleHQ7XG5mdW5jdGlvbiBmaWx0ZXJTdHJpbmdMaXN0QnlPcChvcGVyYXRvciwgZnJhZ21lbnQsIHNyY2Fycikge1xuICAgIHZhciBmcmFnbWVudExDID0gQnJlYWtEb3duLnRyaW1RdW90ZWRTcGFjZWQoZnJhZ21lbnQudG9Mb3dlckNhc2UoKSk7XG4gICAgcmV0dXJuIHNyY2Fyci5maWx0ZXIoZnVuY3Rpb24gKHN0cikge1xuICAgICAgICByZXR1cm4gT3BlcmF0b3IubWF0Y2hlcyhvcGVyYXRvciwgZnJhZ21lbnRMQywgc3RyLnRvTG93ZXJDYXNlKCkpO1xuICAgIH0pLnNvcnQoKTtcbn1cbmV4cG9ydHMuZmlsdGVyU3RyaW5nTGlzdEJ5T3AgPSBmaWx0ZXJTdHJpbmdMaXN0QnlPcDtcbmZ1bmN0aW9uIGNvbXBhcmVDYXNlSW5zZW5zaXRpdmUoYSwgYikge1xuICAgIHZhciByID0gYS50b0xvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUoYi50b0xvd2VyQ2FzZSgpKTtcbiAgICBpZiAocikge1xuICAgICAgICByZXR1cm4gcjtcbiAgICB9XG4gICAgcmV0dXJuIC1hLmxvY2FsZUNvbXBhcmUoYik7XG59XG4vKipcbiAqIFNvcnQgc3RyaW5nIGxpc3QgY2FzZSBpbnNlbnNpdGl2ZSwgdGhlbiByZW1vdmUgZHVwbGljYXRlcyByZXRhaW5pbmdcbiAqIFwibGFyZ2VzdFwiIG1hdGNoXG4gKi9cbmZ1bmN0aW9uIHJlbW92ZUNhc2VEdXBsaWNhdGVzKGFycikge1xuICAgIGFyci5zb3J0KGNvbXBhcmVDYXNlSW5zZW5zaXRpdmUpO1xuICAgIGRlYnVnbG9nKCdzb3J0ZWQgYXJyJyArIEpTT04uc3RyaW5naWZ5KGFycikpO1xuICAgIHJldHVybiBhcnIuZmlsdGVyKGZ1bmN0aW9uIChzLCBpbmRleCkge1xuICAgICAgICByZXR1cm4gaW5kZXggPT09IDAgfHwgKDAgIT09IGFycltpbmRleCAtIDFdLnRvTG93ZXJDYXNlKCkubG9jYWxlQ29tcGFyZShzLnRvTG93ZXJDYXNlKCkpKTtcbiAgICB9KTtcbn1cbmV4cG9ydHMucmVtb3ZlQ2FzZUR1cGxpY2F0ZXMgPSByZW1vdmVDYXNlRHVwbGljYXRlcztcbjtcbmZ1bmN0aW9uIGdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyhvcGVyYXRvciwgZnJhZ21lbnQsIGNhdGVnb3J5LCByZWNvcmRzLCBmaWx0ZXJEb21haW4pIHtcbiAgICB2YXIgZnJhZ21lbnRMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkKGZyYWdtZW50LnRvTG93ZXJDYXNlKCkpO1xuICAgIHZhciByZXMgPSBbXTtcbiAgICB2YXIgc2VlbiA9IHt9O1xuICAgIHJlY29yZHMuZm9yRWFjaChmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgICAgIGlmIChmaWx0ZXJEb21haW4gJiYgcmVjb3JkWydfZG9tYWluJ10gIT09IGZpbHRlckRvbWFpbikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZWNvcmRbY2F0ZWdvcnldICYmIE9wZXJhdG9yLm1hdGNoZXMob3BlcmF0b3IsIGZyYWdtZW50TEMsIHJlY29yZFtjYXRlZ29yeV0udG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgICAgIGlmICghc2VlbltyZWNvcmRbY2F0ZWdvcnldXSkge1xuICAgICAgICAgICAgICAgIHNlZW5bcmVjb3JkW2NhdGVnb3J5XV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIHJlcy5wdXNoKHJlY29yZFtjYXRlZ29yeV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlbW92ZUNhc2VEdXBsaWNhdGVzKHJlcyk7XG59XG5leHBvcnRzLmdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyA9IGdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncztcbjtcbmZ1bmN0aW9uIGxpa2VseVBsdXJhbERpZmYoYSwgcGx1cmFsT2ZhKSB7XG4gICAgdmFyIGFMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkKGEudG9Mb3dlckNhc2UoKSkgfHwgXCJcIjtcbiAgICB2YXIgcGx1cmFsT2ZBTEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZCgocGx1cmFsT2ZhIHx8IFwiXCIpLnRvTG93ZXJDYXNlKCkpIHx8IFwiXCI7XG4gICAgaWYgKGFMQyA9PT0gcGx1cmFsT2ZBTEMpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmIChhTEMgKyAncycgPT09IHBsdXJhbE9mQUxDKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5leHBvcnRzLmxpa2VseVBsdXJhbERpZmYgPSBsaWtlbHlQbHVyYWxEaWZmO1xuO1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnksIHJlY29yZHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBkZWJ1Z2xvZyhcIiBsaXN0QWxsV2l0aENhdGVnb3J5OlwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cbmV4cG9ydHMubGlzdEFsbFdpdGhDYXRlZ29yeSA9IGxpc3RBbGxXaXRoQ2F0ZWdvcnk7XG5mdW5jdGlvbiBqb2luU29ydGVkUXVvdGVkKHN0cmluZ3MpIHtcbiAgICBpZiAoc3RyaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuICAgIHJldHVybiAnXCInICsgc3RyaW5ncy5zb3J0KCkuam9pbignXCI7IFwiJykgKyAnXCInO1xufVxuZXhwb3J0cy5qb2luU29ydGVkUXVvdGVkID0gam9pblNvcnRlZFF1b3RlZDtcbmZ1bmN0aW9uIGpvaW5EaXN0aW5jdChjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIHZhciByZXMgPSByZWNvcmRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgb1JlY29yZCkge1xuICAgICAgICBwcmV2W29SZWNvcmRbY2F0ZWdvcnldXSA9IDE7XG4gICAgICAgIHJldHVybiBwcmV2O1xuICAgIH0sIHt9KTtcbiAgICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChPYmplY3Qua2V5cyhyZXMpKTtcbn1cbmV4cG9ydHMuam9pbkRpc3RpbmN0ID0gam9pbkRpc3RpbmN0O1xuZnVuY3Rpb24gZm9ybWF0RGlzdGluY3RGcm9tV2hhdElmUmVzdWx0KGFuc3dlcnMpIHtcbiAgICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChhbnN3ZXJzLm1hcChmdW5jdGlvbiAob0Fuc3dlcikge1xuICAgICAgICByZXR1cm4gb0Fuc3dlci5yZXN1bHQ7XG4gICAgfSkpO1xufVxuZXhwb3J0cy5mb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQgPSBmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQ7XG5mdW5jdGlvbiBqb2luUmVzdWx0cyhyZXN1bHRzKSB7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgICAgIGlmIChyZXN1bHQuX3JhbmtpbmcgPT09IHJlc3VsdHNbMF0uX3JhbmtpbmcpIHtcbiAgICAgICAgICAgIGlmIChyZXMuaW5kZXhPZihyZXN1bHQucmVzdWx0KSA8IDApIHtcbiAgICAgICAgICAgICAgICByZXMucHVzaChyZXN1bHQucmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmV2ICsgMTtcbiAgICAgICAgfVxuICAgIH0sIDApO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmpvaW5SZXN1bHRzID0gam9pblJlc3VsdHM7XG52YXIgVXRpbHMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscycpO1xuZnVuY3Rpb24gam9pblJlc3VsdHNUdXBlbChyZXN1bHRzKSB7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgICAgIGlmIChyZXN1bHQuX3JhbmtpbmcgPT09IHJlc3VsdHNbMF0uX3JhbmtpbmcpIHtcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IFV0aWxzLmxpc3RUb1F1b3RlZENvbW1hQW5kKHJlc3VsdC5yZXN1bHQpO1xuICAgICAgICAgICAgaWYgKHJlcy5pbmRleE9mKHZhbHVlKSA8IDApIHtcbiAgICAgICAgICAgICAgICByZXMucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcHJldiArIDE7XG4gICAgICAgIH1cbiAgICB9LCAwKTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5qb2luUmVzdWx0c1R1cGVsID0gam9pblJlc3VsdHNUdXBlbDtcbmZ1bmN0aW9uIGluZmVyRG9tYWluKHRoZU1vZGVsLCBjb250ZXh0UXVlcnlTdHJpbmcpIHtcbiAgICAvLyBjb25zb2xlLmxvZyhcImhlcmUgdGhlIHN0cmluZ1wiICsgY29udGV4dFF1ZXJ5U3RyaW5nKTtcbiAgICAvLyAgY29uc29sZS5sb2coXCJoZXJlIHRoZSBydWxlc1wiICsgSlNPTi5zdHJpbmdpZnkodGhlTW9kZWwubVJ1bGVzKSk7XG4gICAgdmFyIHJlcyA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgdGhlTW9kZWwucnVsZXMpO1xuICAgIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzLHVuZGVmaW5lZCwyKSk7XG4gICAgLy8gcnVuIHRocm91Z2ggdGhlIHN0cmluZywgc2VhcmNoIGZvciBhIGNhdGVnb3J5XG4gICAgaWYgKCFyZXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHZhciBkb21haW5zID0gW107XG4gICAgLy9jb25zb2xlLmxvZyhTZW50ZW5jZS5kdW1wTmljZUFycihyZXMpKTtcbiAgICAvLyBkbyB3ZSBoYXZlIGEgZG9tYWluID9cbiAgICByZXNbMF0uZm9yRWFjaChmdW5jdGlvbiAob1dvcmRHcm91cCkge1xuICAgICAgICBpZiAob1dvcmRHcm91cC5jYXRlZ29yeSA9PT0gXCJkb21haW5cIikge1xuICAgICAgICAgICAgZG9tYWlucy5wdXNoKG9Xb3JkR3JvdXAubWF0Y2hlZFN0cmluZyk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoZG9tYWlucy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgZGVidWdsb2coXCJnb3QgYSBwcmVjaXNlIGRvbWFpbiBcIiArIGRvbWFpbnNbMF0pO1xuICAgICAgICByZXR1cm4gZG9tYWluc1swXTtcbiAgICB9XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID4gMCkge1xuICAgICAgICBkZWJ1Z2xvZyhcImdvdCBtb3JlIHRoYW4gb25lIGRvbWFpbiwgY29uZnVzZWQgIFwiICsgZG9tYWlucy5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgZGVidWdsb2coXCJhdHRlbXB0aW5nIHRvIGRldGVybWluZSBjYXRlZ29yaWVzXCIpO1xuICAgIC8vIHRyeSBhIGNhdGVnb3J5IHJldmVyc2UgbWFwXG4gICAgcmVzWzBdLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkR3JvdXApIHtcbiAgICAgICAgaWYgKG9Xb3JkR3JvdXAuY2F0ZWdvcnkgPT09IFwiY2F0ZWdvcnlcIikge1xuICAgICAgICAgICAgdmFyIHNDYXQgPSBvV29yZEdyb3VwLm1hdGNoZWRTdHJpbmc7XG4gICAgICAgICAgICB2YXIgZG9tcyA9IE1vZGVsLmdldERvbWFpbnNGb3JDYXRlZ29yeSh0aGVNb2RlbCwgc0NhdCk7XG4gICAgICAgICAgICBkb21zLmZvckVhY2goZnVuY3Rpb24gKHNEb20pIHtcbiAgICAgICAgICAgICAgICBpZiAoZG9tYWlucy5pbmRleE9mKHNEb20pIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICBkb21haW5zLnB1c2goc0RvbSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoZG9tYWlucy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgZGVidWdsb2coXCJnb3QgYSBwcmVjaXNlIGRvbWFpbiBcIiArIGRvbWFpbnNbMF0pO1xuICAgICAgICByZXR1cm4gZG9tYWluc1swXTtcbiAgICB9XG4gICAgZGVidWdsb2coXCJnb3QgbW9yZSB0aGFuIG9uZSBkb21haW4sIGNvbmZ1c2VkICBcIiArIGRvbWFpbnMuam9pbihcIlxcblwiKSk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cbmV4cG9ydHMuaW5mZXJEb21haW4gPSBpbmZlckRvbWFpbjtcbjtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
