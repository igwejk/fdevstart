/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require("debug");
var debuglog = debug('listall');
var logger = require("../utils/logger");
var logPerf = logger.perf("perflistall");
var perflog = debug('perf');
var BreakDown = require("./breakdown");
var Operator = require("./operator");
var WhatIs = require("./whatis");
var ErError = require("./ererror");
var Model = require("../model/model");
var sWords = {};
function matchRecordHavingCategory(category, records) {
    debuglog(debuglog.enabled ? JSON.stringify(records, undefined, 2) : "-");
    var relevantRecords = records.filter(function (record) {
        return record[category] !== undefined && record[category] !== null;
    });
    var res = [];
    debuglog("relevant records nr:" + relevantRecords.length);
    return relevantRecords;
}
exports.matchRecordHavingCategory = matchRecordHavingCategory;
function analyzeContextString(contextQueryString, rules) {
    return WhatIs.analyzeContextString(contextQueryString, rules);
}
exports.analyzeContextString = analyzeContextString;
// const result = WhatIs.resolveCategory(cat, a1.entity,
//   theModel.mRules, theModel.tools, theModel.records);
function listAllWithContext(category, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return {
            answers: [],
            errors: [ErError.makeError_EMPTY_INPUT()],
            tokens: []
        };
    } else {
        logPerf('listAllWithContext');
        perflog("totalListAllWithContext");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        debuglog("listAllWithContext:matching records (s=" + aSentencesReinforced.sentences.length + ")...");
        debuglog("here sentences" + JSON.stringify(aSentencesReinforced, undefined, 2));
        perflog("matching records (s=" + aSentencesReinforced.sentences.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsQuick(aSentencesReinforced, category, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filtering topRanked (a=" + matchedAnswers.answers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers.answers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllWithContext (a=" + matchedFiltered.length + ")");
        logPerf('listAllWithContext');
        return {
            answers: matchedFiltered,
            errors: aSentencesReinforced.errors,
            tokens: aSentencesReinforced.tokens
        };
    }
}
exports.listAllWithContext = listAllWithContext;
function listAllHavingContext(category, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return {
            errors: [ErError.makeError_EMPTY_INPUT()],
            tokens: [],
            answers: []
        };
    } else {
        perflog("analyzeContextString ...");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records having (s=" + aSentencesReinforced.sentences.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsHavingContext(aSentencesReinforced, category, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filteringTopRanked (a=" + matchedAnswers.sentences.length + ")...");
        matchedAnswers.answers = WhatIs.filterOnlyTopRanked(matchedAnswers.answers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedAnswers.answers, undefined, 2));
        }
        perflog("totalListAllHavingContext (a=" + matchedAnswers.answers.length + ")");
        return matchedAnswers;
    }
}
exports.listAllHavingContext = listAllHavingContext;
function listAllTupelWithContext(categories, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return {
            tupelanswers: [],
            errors: [ErError.makeError_EMPTY_INPUT()],
            tokens: []
        };
    } else {
        logPerf('listAllWithContext');
        perflog("totalListAllWithContext");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records (s=" + aSentencesReinforced.sentences.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsQuickMultipleCategories(aSentencesReinforced, categories, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filtering topRanked (a=" + matchedAnswers.tupelanswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRankedTupel(matchedAnswers.tupelanswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllWithContext (a=" + matchedFiltered.length + ")");
        logPerf('listAllWithContext');
        return {
            tupelanswers: matchedFiltered,
            errors: aSentencesReinforced.errors,
            tokens: aSentencesReinforced.tokens
        };
    }
}
exports.listAllTupelWithContext = listAllTupelWithContext;
function listAllTupelHavingContext(categories, contextQueryString, aRules, records, categorySet) {
    if (contextQueryString.length === 0) {
        return {
            tupelanswers: [],
            errors: [ErError.makeError_EMPTY_INPUT()],
            tokens: []
        };
    } else {
        perflog("analyzeContextString ...");
        var aSentencesReinforced = analyzeContextString(contextQueryString, aRules);
        perflog("matching records having (s=" + aSentencesReinforced.sentences.length + ")...");
        var matchedAnswers = WhatIs.matchRecordsTupelHavingContext(aSentencesReinforced, categories, records, categorySet); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        if (debuglog.enabled) {
            debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        }
        perflog("filteringTopRanked (a=" + matchedAnswers.tupelanswers.length + ")...");
        var matchedFiltered = WhatIs.filterOnlyTopRankedTupel(matchedAnswers.tupelanswers);
        if (debuglog.enabled) {
            debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        }
        perflog("totalListAllHavingContext (a=" + matchedFiltered.length + ")");
        return {
            tupelanswers: matchedFiltered,
            errors: aSentencesReinforced.errors,
            tokens: aSentencesReinforced.tokens
        };
    }
}
exports.listAllTupelHavingContext = listAllTupelHavingContext;
function filterStringListByOp(operator, fragment, srcarr) {
    var fragmentLC = BreakDown.trimQuotedSpaced(fragment.toLowerCase());
    return srcarr.filter(function (str) {
        return Operator.matches(operator, fragmentLC, str.toLowerCase());
    }).sort();
}
exports.filterStringListByOp = filterStringListByOp;
function compareCaseInsensitive(a, b) {
    var r = a.toLowerCase().localeCompare(b.toLowerCase());
    if (r) {
        return r;
    }
    return -a.localeCompare(b);
}
/**
 * Sort string list case insensitive, then remove duplicates retaining
 * "largest" match
 */
function removeCaseDuplicates(arr) {
    arr.sort(compareCaseInsensitive);
    debuglog('sorted arr' + JSON.stringify(arr));
    return arr.filter(function (s, index) {
        return index === 0 || 0 !== arr[index - 1].toLowerCase().localeCompare(s.toLowerCase());
    });
}
exports.removeCaseDuplicates = removeCaseDuplicates;
;
function getCategoryOpFilterAsDistinctStrings(operator, fragment, category, records, filterDomain) {
    var fragmentLC = BreakDown.trimQuoted(fragment.toLowerCase());
    var res = [];
    var seen = {};
    records.forEach(function (record) {
        if (filterDomain && record['_domain'] !== filterDomain) {
            return;
        }
        if (record[category] && Operator.matches(operator, fragmentLC, record[category].toLowerCase())) {
            if (!seen[record[category]]) {
                seen[record[category]] = true;
                res.push(record[category]);
            }
        }
    });
    return removeCaseDuplicates(res);
}
exports.getCategoryOpFilterAsDistinctStrings = getCategoryOpFilterAsDistinctStrings;
;
function likelyPluralDiff(a, pluralOfa) {
    var aLC = BreakDown.trimQuoted(a.toLowerCase()) || "";
    var pluralOfALC = BreakDown.trimQuoted((pluralOfa || "").toLowerCase()) || "";
    if (aLC === pluralOfALC) {
        return true;
    }
    if (aLC + 's' === pluralOfALC) {
        return true;
    }
    return false;
}
exports.likelyPluralDiff = likelyPluralDiff;
;
function listAllWithCategory(category, records) {
    var matchedAnswers = matchRecordHavingCategory(category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
    debuglog(" listAllWithCategory:" + JSON.stringify(matchedAnswers, undefined, 2));
    return matchedAnswers;
}
exports.listAllWithCategory = listAllWithCategory;
function joinSortedQuoted(strings) {
    if (strings.length === 0) {
        return "";
    }
    return '"' + strings.sort().join('"; "') + '"';
}
exports.joinSortedQuoted = joinSortedQuoted;
function joinDistinct(category, records) {
    var res = records.reduce(function (prev, oRecord) {
        prev[oRecord[category]] = 1;
        return prev;
    }, {});
    return joinSortedQuoted(Object.keys(res));
}
exports.joinDistinct = joinDistinct;
function formatDistinctFromWhatIfResult(answers) {
    return joinSortedQuoted(answers.map(function (oAnswer) {
        return oAnswer.result;
    }));
}
exports.formatDistinctFromWhatIfResult = formatDistinctFromWhatIfResult;
function joinResults(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            if (res.indexOf(result.result) < 0) {
                res.push(result.result);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResults = joinResults;
var Utils = require("../utils/utils");
function joinResultsTupel(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            var value = Utils.listToQuotedCommaAnd(result.result);
            if (res.indexOf(value) < 0) {
                res.push(value);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResultsTupel = joinResultsTupel;
function inferDomain(theModel, contextQueryString) {
    // console.log("here the string" + contextQueryString);
    //  console.log("here the rules" + JSON.stringify(theModel.mRules));
    var res = analyzeContextString(contextQueryString, theModel.rules);
    //console.log(JSON.stringify(res,undefined,2));
    // run through the string, search for a category
    if (!res.sentences.length) {
        return undefined;
    }
    var domains = [];
    //console.log(Sentence.dumpNiceArr(res));
    // do we have a domain ?
    res.sentences[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "domain") {
            domains.push(oWordGroup.matchedString);
        }
    });
    if (domains.length === 1) {
        debuglog("got a precise domain " + domains[0]);
        return domains[0];
    }
    if (domains.length > 0) {
        debuglog(debuglog.enabled ? "got more than one domain, confused  " + domains.join("\n") : '-');
        return undefined;
    }
    debuglog("attempting to determine categories");
    // try a category reverse map
    res.sentences[0].forEach(function (oWordGroup) {
        if (oWordGroup.category === "category") {
            var sCat = oWordGroup.matchedString;
            var doms = Model.getDomainsForCategory(theModel, sCat);
            doms.forEach(function (sDom) {
                if (domains.indexOf(sDom) < 0) {
                    domains.push(sDom);
                }
            });
        }
    });
    if (domains.length === 1) {
        debuglog("got a precise domain " + domains[0]);
        return domains[0];
    }
    debuglog(debuglog.enabled ? "got more than one domain, confused  " + domains.join("\n") : '-');
    return undefined;
}
exports.inferDomain = inferDomain;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9saXN0YWxsLnRzIiwibWF0Y2gvbGlzdGFsbC5qcyJdLCJuYW1lcyI6WyJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsImxvZ2dlciIsImxvZ1BlcmYiLCJwZXJmIiwicGVyZmxvZyIsIkJyZWFrRG93biIsIk9wZXJhdG9yIiwiV2hhdElzIiwiRXJFcnJvciIsIk1vZGVsIiwic1dvcmRzIiwibWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeSIsImNhdGVnb3J5IiwicmVjb3JkcyIsImVuYWJsZWQiLCJKU09OIiwic3RyaW5naWZ5IiwidW5kZWZpbmVkIiwicmVsZXZhbnRSZWNvcmRzIiwiZmlsdGVyIiwicmVjb3JkIiwicmVzIiwibGVuZ3RoIiwiZXhwb3J0cyIsImFuYWx5emVDb250ZXh0U3RyaW5nIiwiY29udGV4dFF1ZXJ5U3RyaW5nIiwicnVsZXMiLCJsaXN0QWxsV2l0aENvbnRleHQiLCJhUnVsZXMiLCJjYXRlZ29yeVNldCIsImFuc3dlcnMiLCJlcnJvcnMiLCJtYWtlRXJyb3JfRU1QVFlfSU5QVVQiLCJ0b2tlbnMiLCJhU2VudGVuY2VzUmVpbmZvcmNlZCIsInNlbnRlbmNlcyIsIm1hdGNoZWRBbnN3ZXJzIiwibWF0Y2hSZWNvcmRzUXVpY2siLCJtYXRjaGVkRmlsdGVyZWQiLCJmaWx0ZXJPbmx5VG9wUmFua2VkIiwibGlzdEFsbEhhdmluZ0NvbnRleHQiLCJtYXRjaFJlY29yZHNIYXZpbmdDb250ZXh0IiwibGlzdEFsbFR1cGVsV2l0aENvbnRleHQiLCJjYXRlZ29yaWVzIiwidHVwZWxhbnN3ZXJzIiwibWF0Y2hSZWNvcmRzUXVpY2tNdWx0aXBsZUNhdGVnb3JpZXMiLCJmaWx0ZXJPbmx5VG9wUmFua2VkVHVwZWwiLCJsaXN0QWxsVHVwZWxIYXZpbmdDb250ZXh0IiwibWF0Y2hSZWNvcmRzVHVwZWxIYXZpbmdDb250ZXh0IiwiZmlsdGVyU3RyaW5nTGlzdEJ5T3AiLCJvcGVyYXRvciIsImZyYWdtZW50Iiwic3JjYXJyIiwiZnJhZ21lbnRMQyIsInRyaW1RdW90ZWRTcGFjZWQiLCJ0b0xvd2VyQ2FzZSIsInN0ciIsIm1hdGNoZXMiLCJzb3J0IiwiY29tcGFyZUNhc2VJbnNlbnNpdGl2ZSIsImEiLCJiIiwiciIsImxvY2FsZUNvbXBhcmUiLCJyZW1vdmVDYXNlRHVwbGljYXRlcyIsImFyciIsInMiLCJpbmRleCIsImdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyIsImZpbHRlckRvbWFpbiIsInRyaW1RdW90ZWQiLCJzZWVuIiwiZm9yRWFjaCIsInB1c2giLCJsaWtlbHlQbHVyYWxEaWZmIiwicGx1cmFsT2ZhIiwiYUxDIiwicGx1cmFsT2ZBTEMiLCJsaXN0QWxsV2l0aENhdGVnb3J5Iiwiam9pblNvcnRlZFF1b3RlZCIsInN0cmluZ3MiLCJqb2luIiwiam9pbkRpc3RpbmN0IiwicmVkdWNlIiwicHJldiIsIm9SZWNvcmQiLCJPYmplY3QiLCJrZXlzIiwiZm9ybWF0RGlzdGluY3RGcm9tV2hhdElmUmVzdWx0IiwibWFwIiwib0Fuc3dlciIsInJlc3VsdCIsImpvaW5SZXN1bHRzIiwicmVzdWx0cyIsImNudCIsIl9yYW5raW5nIiwiaW5kZXhPZiIsIlV0aWxzIiwiam9pblJlc3VsdHNUdXBlbCIsInZhbHVlIiwibGlzdFRvUXVvdGVkQ29tbWFBbmQiLCJpbmZlckRvbWFpbiIsInRoZU1vZGVsIiwiZG9tYWlucyIsIm9Xb3JkR3JvdXAiLCJtYXRjaGVkU3RyaW5nIiwic0NhdCIsImRvbXMiLCJnZXREb21haW5zRm9yQ2F0ZWdvcnkiLCJzRG9tIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FDTUE7O0FES0EsSUFBQUEsUUFBQUMsUUFBQSxPQUFBLENBQUE7QUFFQSxJQUFNQyxXQUFXRixNQUFNLFNBQU4sQ0FBakI7QUFDQSxJQUFBRyxTQUFBRixRQUFBLGlCQUFBLENBQUE7QUFDQSxJQUFJRyxVQUFVRCxPQUFPRSxJQUFQLENBQVksYUFBWixDQUFkO0FBQ0EsSUFBSUMsVUFBVU4sTUFBTSxNQUFOLENBQWQ7QUFR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Q0FBUDtBQUNEO0FBQ0QsUUFBR0EsUUFBUWpGLE1BQVIsR0FBaUIsQ0FBcEIsRUFBd0I7QUFDdEJ0QixpQkFBU0EsU0FBU2MsT0FBVCxHQUFtQix5Q0FBeUN5RixRQUFRdEIsSUFBUixDQUFhLElBQWIsQ0FBNUQsR0FBZ0YsR0FBekY7QUFDQSxlQUFPaEUsU0FBUDtBQUVEO0FBQ0RqQixhQUFTLG9DQUFUO0FBQ0E7QUFDQXFCLFFBQUljLFNBQUosQ0FBYyxDQUFkLEVBQWlCcUMsT0FBakIsQ0FBeUIsVUFBU2dDLFVBQVQsRUFBbUI7QUFDMUMsWUFBR0EsV0FBVzVGLFFBQVgsS0FBd0IsVUFBM0IsRUFBdUM7QUFDckMsZ0JBQUk4RixPQUFPRixXQUFXQyxhQUF0QjtBQUNBLGdCQUFJRSxPQUFPbEcsTUFBTW1HLHFCQUFOLENBQTRCTixRQUE1QixFQUFxQ0ksSUFBckMsQ0FBWDtBQUNBQyxpQkFBS25DLE9BQUwsQ0FBYSxVQUFTcUMsSUFBVCxFQUFhO0FBQ3hCLG9CQUFHTixRQUFRUCxPQUFSLENBQWdCYSxJQUFoQixJQUF3QixDQUEzQixFQUE4QjtBQUM1Qk4sNEJBQVE5QixJQUFSLENBQWFvQyxJQUFiO0FBQ0Q7QUFDRixhQUpEO0FBS0Q7QUFDRixLQVZEO0FBV0EsUUFBR04sUUFBUWpGLE1BQVIsS0FBbUIsQ0FBdEIsRUFBeUI7QUFDdEJ0QixpQkFBUywwQkFBMEJ1RyxRQUFRLENBQVIsQ0FBbkM7QUFDRCxlQUFPQSxRQUFRLENBQVIsQ0FBUDtBQUNEO0FBQ0R2RyxhQUFTQSxTQUFTYyxPQUFULEdBQW9CLHlDQUF5Q3lGLFFBQVF0QixJQUFSLENBQWEsSUFBYixDQUE3RCxHQUFrRixHQUEzRjtBQUNBLFdBQU9oRSxTQUFQO0FBQ0Q7QUE3Q0RNLFFBQUE4RSxXQUFBLEdBQUFBLFdBQUE7QUE2Q0MiLCJmaWxlIjoibWF0Y2gvbGlzdGFsbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXG5cbmltcG9ydCAqIGFzIElucHV0RmlsdGVyIGZyb20gJy4vaW5wdXRGaWx0ZXInO1xuXG5pbXBvcnQgKiBhcyBBbGdvbCBmcm9tICcuL2FsZ29sJztcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnbGlzdGFsbCcpO1xuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG52YXIgbG9nUGVyZiA9IGxvZ2dlci5wZXJmKFwicGVyZmxpc3RhbGxcIik7XG52YXIgcGVyZmxvZyA9IGRlYnVnKCdwZXJmJyk7XG4vL2NvbnN0IHBlcmZsb2cgPSBsb2dnZXIucGVyZihcInBlcmZsaXN0YWxsXCIpO1xuXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuLi91dGlscy91dGlscyc7XG5cbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuL2lmbWF0Y2gnO1xuXG5pbXBvcnQgKiBhcyBUb29sbWF0Y2hlciBmcm9tICcuL3Rvb2xtYXRjaGVyJztcbmltcG9ydCAqIGFzIEJyZWFrRG93biBmcm9tICcuL2JyZWFrZG93bic7XG5cbmltcG9ydCAqIGFzIFNlbnRlbmNlIGZyb20gJy4vc2VudGVuY2UnO1xuXG5pbXBvcnQgKiBhcyBXb3JkIGZyb20gJy4vd29yZCc7XG5pbXBvcnQgKiBhcyBPcGVyYXRvciBmcm9tICcuL29wZXJhdG9yJztcblxuaW1wb3J0ICogYXMgV2hhdElzIGZyb20gJy4vd2hhdGlzJztcbmltcG9ydCAqIGFzIEVyRXJyb3IgZnJvbSAnLi9lcmVycm9yJztcblxuaW1wb3J0ICogYXMgTW9kZWwgZnJvbSAnLi4vbW9kZWwvbW9kZWwnO1xuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi9tYXRjaCc7XG5cbnZhciBzV29yZHMgPSB7fTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KVxuICA6IEFycmF5PElNYXRjaC5JUmVjb3JkPiB7XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeShyZWNvcmRzLHVuZGVmaW5lZCwyKSA6IFwiLVwiKTtcbiAgdmFyIHJlbGV2YW50UmVjb3JkcyA9IHJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQ6IElNYXRjaC5JUmVjb3JkKSB7XG4gICAgcmV0dXJuIChyZWNvcmRbY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpICYmIChyZWNvcmRbY2F0ZWdvcnldICE9PSBudWxsKTtcbiAgfSk7XG4gIHZhciByZXMgPSBbXTtcbiAgZGVidWdsb2coXCJyZWxldmFudCByZWNvcmRzIG5yOlwiICsgcmVsZXZhbnRSZWNvcmRzLmxlbmd0aCk7XG4gIHJldHVybiByZWxldmFudFJlY29yZHM7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZyA6IHN0cmluZywgIHJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcykge1xuICByZXR1cm4gV2hhdElzLmFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZyxydWxlcyk7XG59XG5cbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuXG5leHBvcnQgZnVuY3Rpb24gbGlzdEFsbFdpdGhDb250ZXh0KGNhdGVnb3J5OiBzdHJpbmcsIGNvbnRleHRRdWVyeVN0cmluZzogc3RyaW5nLFxuICBhUnVsZXM6IElNYXRjaC5TcGxpdFJ1bGVzLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4sIGNhdGVnb3J5U2V0PzogeyBba2V5IDogc3RyaW5nXSA6IGJvb2xlYW4gfSk6IElNYXRjaC5JUHJvY2Vzc2VkV2hhdElzQW5zd2Vyc1xuIHtcbiAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4ge1xuICAgICAgYW5zd2VycyA6IFtdLFxuICAgICAgZXJyb3JzIDogW0VyRXJyb3IubWFrZUVycm9yX0VNUFRZX0lOUFVUKCldICxcbiAgICAgIHRva2VucyA6W11cbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxXaXRoQ29udGV4dFwiKTtcbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgZGVidWdsb2coXCJsaXN0QWxsV2l0aENvbnRleHQ6bWF0Y2hpbmcgcmVjb3JkcyAocz1cIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLnNlbnRlbmNlcy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgZGVidWdsb2coXCJoZXJlIHNlbnRlbmNlc1wiICsgSlNPTi5zdHJpbmdpZnkoYVNlbnRlbmNlc1JlaW5mb3JjZWQsdW5kZWZpbmVkLDIpKTtcbiAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyAocz1cIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLnNlbnRlbmNlcy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3Jkc1F1aWNrKGFTZW50ZW5jZXNSZWluZm9yY2VkLCBjYXRlZ29yeSwgcmVjb3JkcywgY2F0ZWdvcnlTZXQpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKXtcbiAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwiZmlsdGVyaW5nIHRvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmFuc3dlcnMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgIHZhciBtYXRjaGVkRmlsdGVyZWQgPSBXaGF0SXMuZmlsdGVyT25seVRvcFJhbmtlZChtYXRjaGVkQW5zd2Vycy5hbnN3ZXJzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxXaXRoQ29udGV4dCAoYT1cIiArIG1hdGNoZWRGaWx0ZXJlZC5sZW5ndGggKyBcIilcIik7XG4gICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgcmV0dXJuIHtcbiAgICAgYW5zd2VycyA6ICBtYXRjaGVkRmlsdGVyZWQsIC8vID8/PyBBbnN3ZXJzO1xuICAgICBlcnJvcnMgOiBhU2VudGVuY2VzUmVpbmZvcmNlZC5lcnJvcnMsXG4gICAgIHRva2VucyA6IGFTZW50ZW5jZXNSZWluZm9yY2VkLnRva2Vuc1xuICAgIH1cbiB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0QWxsSGF2aW5nQ29udGV4dChjYXRlZ29yeTogc3RyaW5nLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyxcbiAgYVJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+LFxuICBjYXRlZ29yeVNldCA6IHsgW2tleTpzdHJpbmddIDogYm9vbGVhbiB9KTogSU1hdGNoLklQcm9jZXNzZWRXaGF0SXNBbnN3ZXJzIHtcbiAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4ge1xuICAgICAgZXJyb3JzIDogW0VyRXJyb3IubWFrZUVycm9yX0VNUFRZX0lOUFVUKCldICxcbiAgICAgIHRva2VucyA6W10sXG4gICAgICBhbnN3ZXJzOltdXG4gICB9O1xuICB9IGVsc2Uge1xuICAgIHBlcmZsb2coXCJhbmFseXplQ29udGV4dFN0cmluZyAuLi5cIik7XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIGhhdmluZyAocz1cIiArIChhU2VudGVuY2VzUmVpbmZvcmNlZC5zZW50ZW5jZXMubGVuZ3RoKSArIFwiKS4uLlwiKTtcbiAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzSGF2aW5nQ29udGV4dChhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcnksIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgaWYoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJmaWx0ZXJpbmdUb3BSYW5rZWQgKGE9XCIgKyBtYXRjaGVkQW5zd2Vycy5zZW50ZW5jZXMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgIG1hdGNoZWRBbnN3ZXJzLmFuc3dlcnMgPSBXaGF0SXMuZmlsdGVyT25seVRvcFJhbmtlZChtYXRjaGVkQW5zd2Vycy5hbnN3ZXJzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLmFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsSGF2aW5nQ29udGV4dCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmFuc3dlcnMubGVuZ3RoICsgXCIpXCIpO1xuICAgIHJldHVybiBtYXRjaGVkQW5zd2VycztcbiAgfVxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0QWxsVHVwZWxXaXRoQ29udGV4dChjYXRlZ29yaWVzOiBzdHJpbmdbXSwgY29udGV4dFF1ZXJ5U3RyaW5nOiBzdHJpbmcsXG4gIGFSdWxlczogSU1hdGNoLlNwbGl0UnVsZXMsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPiwgY2F0ZWdvcnlTZXQ/OiB7IFtrZXkgOiBzdHJpbmddIDogYm9vbGVhbiB9KTogSU1hdGNoLklQcm9jZXNzZWRXaGF0SXNUdXBlbEFuc3dlcnMge1xuICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB7XG4gICAgICB0dXBlbGFuc3dlcnMgOiBbXSxcbiAgICAgIGVycm9ycyA6IFtFckVycm9yLm1ha2VFcnJvcl9FTVBUWV9JTlBVVCgpXSAsXG4gICAgICB0b2tlbnMgOltdLFxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0XCIpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyAocz1cIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLnNlbnRlbmNlcy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3Jkc1F1aWNrTXVsdGlwbGVDYXRlZ29yaWVzKGFTZW50ZW5jZXNSZWluZm9yY2VkLCBjYXRlZ29yaWVzLCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgIGlmKGRlYnVnbG9nLmVuYWJsZWQpe1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJmaWx0ZXJpbmcgdG9wUmFua2VkIChhPVwiICsgbWF0Y2hlZEFuc3dlcnMudHVwZWxhbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWRUdXBlbChtYXRjaGVkQW5zd2Vycy50dXBlbGFuc3dlcnMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0IChhPVwiICsgbWF0Y2hlZEZpbHRlcmVkLmxlbmd0aCArIFwiKVwiKTtcbiAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHVwZWxhbnN3ZXJzIDogbWF0Y2hlZEZpbHRlcmVkLCAvLyA/Pz8gQW5zd2VycztcbiAgICAgIGVycm9ycyA6IGFTZW50ZW5jZXNSZWluZm9yY2VkLmVycm9ycyxcbiAgICAgIHRva2VuczogYVNlbnRlbmNlc1JlaW5mb3JjZWQudG9rZW5zXG4gICAgfVxuICB9XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxUdXBlbEhhdmluZ0NvbnRleHQoY2F0ZWdvcmllczogc3RyaW5nW10sIGNvbnRleHRRdWVyeVN0cmluZzogc3RyaW5nLFxuICBhUnVsZXM6IElNYXRjaC5TcGxpdFJ1bGVzLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4sXG4gIGNhdGVnb3J5U2V0IDogeyBba2V5OnN0cmluZ10gOiBib29sZWFuIH0pOiBJTWF0Y2guSVByb2Nlc3NlZFdoYXRJc1R1cGVsQW5zd2VycyB7XG4gIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR1cGVsYW5zd2VycyA6IFtdLFxuICAgICAgZXJyb3JzIDogW0VyRXJyb3IubWFrZUVycm9yX0VNUFRZX0lOUFVUKCldICxcbiAgICAgIHRva2VucyA6W10sXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICBwZXJmbG9nKFwiYW5hbHl6ZUNvbnRleHRTdHJpbmcgLi4uXCIpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyBoYXZpbmcgKHM9XCIgKyAoYVNlbnRlbmNlc1JlaW5mb3JjZWQuc2VudGVuY2VzLmxlbmd0aCkgKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3Jkc1R1cGVsSGF2aW5nQ29udGV4dChhU2VudGVuY2VzUmVpbmZvcmNlZCwgY2F0ZWdvcmllcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBpZihkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcGVyZmxvZyhcImZpbHRlcmluZ1RvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLnR1cGVsYW5zd2Vycy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkVHVwZWwobWF0Y2hlZEFuc3dlcnMudHVwZWxhbnN3ZXJzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxIYXZpbmdDb250ZXh0IChhPVwiICsgbWF0Y2hlZEZpbHRlcmVkLmxlbmd0aCArIFwiKVwiKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHVwZWxhbnN3ZXJzIDogIG1hdGNoZWRGaWx0ZXJlZCxcbiAgICAgIGVycm9ycyA6IGFTZW50ZW5jZXNSZWluZm9yY2VkLmVycm9ycyxcbiAgICAgIHRva2VuczogYVNlbnRlbmNlc1JlaW5mb3JjZWQudG9rZW5zXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJTdHJpbmdMaXN0QnlPcChvcGVyYXRvcjogSU1hdGNoLklPcGVyYXRvciwgZnJhZ21lbnQgOiBzdHJpbmcsICBzcmNhcnIgOiBzdHJpbmdbXSApIDogc3RyaW5nW10ge1xuICB2YXIgZnJhZ21lbnRMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkU3BhY2VkKGZyYWdtZW50LnRvTG93ZXJDYXNlKCkpO1xuICByZXR1cm4gc3JjYXJyLmZpbHRlcihmdW5jdGlvbihzdHIpIHtcbiAgICByZXR1cm4gT3BlcmF0b3IubWF0Y2hlcyhvcGVyYXRvciwgZnJhZ21lbnRMQywgc3RyLnRvTG93ZXJDYXNlKCkpO1xuICB9KS5zb3J0KCk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVDYXNlSW5zZW5zaXRpdmUoYTogc3RyaW5nLCBiIDogc3RyaW5nKSB7XG4gIHZhciByID0gYS50b0xvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUoYi50b0xvd2VyQ2FzZSgpKTtcbiAgaWYgKHIpIHtcbiAgICByZXR1cm4gcjtcbiAgfVxuICByZXR1cm4gLWEubG9jYWxlQ29tcGFyZShiKTtcbn1cblxuLyoqXG4gKiBTb3J0IHN0cmluZyBsaXN0IGNhc2UgaW5zZW5zaXRpdmUsIHRoZW4gcmVtb3ZlIGR1cGxpY2F0ZXMgcmV0YWluaW5nXG4gKiBcImxhcmdlc3RcIiBtYXRjaFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlQ2FzZUR1cGxpY2F0ZXMoYXJyIDogc3RyaW5nW10pIDogc3RyaW5nW10ge1xuICBhcnIuc29ydChjb21wYXJlQ2FzZUluc2Vuc2l0aXZlKTtcbiAgZGVidWdsb2coJ3NvcnRlZCBhcnInICsgSlNPTi5zdHJpbmdpZnkoYXJyKSk7XG4gIHJldHVybiBhcnIuZmlsdGVyKGZ1bmN0aW9uKHMsIGluZGV4KSB7XG4gICAgcmV0dXJuIGluZGV4ID09PSAwIHx8ICgwICE9PSBhcnJbaW5kZXggLTEgXS50b0xvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUocy50b0xvd2VyQ2FzZSgpKSk7XG4gIH0pO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyhvcGVyYXRvcjogSU1hdGNoLklPcGVyYXRvciwgZnJhZ21lbnQgOiBzdHJpbmcsXG4gIGNhdGVnb3J5IDogc3RyaW5nLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4sIGZpbHRlckRvbWFpbj8gOiBzdHJpbmcpIDogc3RyaW5nW10ge1xuICAgIHZhciBmcmFnbWVudExDID0gQnJlYWtEb3duLnRyaW1RdW90ZWQoZnJhZ21lbnQudG9Mb3dlckNhc2UoKSk7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBzZWVuID0ge307XG4gICAgcmVjb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uKHJlY29yZCkge1xuICAgICAgaWYoZmlsdGVyRG9tYWluICYmIHJlY29yZCBbJ19kb21haW4nXSAhPT0gZmlsdGVyRG9tYWluKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmKHJlY29yZFtjYXRlZ29yeV0gJiYgT3BlcmF0b3IubWF0Y2hlcyhvcGVyYXRvciwgZnJhZ21lbnRMQywgcmVjb3JkW2NhdGVnb3J5XS50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgICBpZighc2VlbltyZWNvcmRbY2F0ZWdvcnldXSkge1xuICAgICAgICAgIHNlZW5bcmVjb3JkW2NhdGVnb3J5XV0gPSB0cnVlO1xuICAgICAgICAgIHJlcy5wdXNoKHJlY29yZFtjYXRlZ29yeV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlbW92ZUNhc2VEdXBsaWNhdGVzKHJlcyk7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gbGlrZWx5UGx1cmFsRGlmZihhIDogc3RyaW5nLCBwbHVyYWxPZmEgOiBzdHJpbmcpIDogYm9vbGVhbiB7XG4gIHZhciBhTEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZChhLnRvTG93ZXJDYXNlKCkpICB8fCBcIlwiO1xuICB2YXIgcGx1cmFsT2ZBTEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZCgocGx1cmFsT2ZhIHx8XCJcIikudG9Mb3dlckNhc2UoKSkgfHwgXCJcIjtcbiAgaWYgKGFMQyA9PT0gcGx1cmFsT2ZBTEMpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBpZiggYUxDICsncycgPT09IHBsdXJhbE9mQUxDKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuXG5leHBvcnQgZnVuY3Rpb24gbGlzdEFsbFdpdGhDYXRlZ29yeShjYXRlZ29yeTogc3RyaW5nLCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pOiBBcnJheTxJTWF0Y2guSVJlY29yZD4ge1xuICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gIGRlYnVnbG9nKFwiIGxpc3RBbGxXaXRoQ2F0ZWdvcnk6XCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5Tb3J0ZWRRdW90ZWQoc3RyaW5ncyA6IHN0cmluZ1tdICkgOiBzdHJpbmcge1xuICBpZiAoc3RyaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gXCJcIjtcbiAgfVxuICByZXR1cm4gJ1wiJyArIHN0cmluZ3Muc29ydCgpLmpvaW4oJ1wiOyBcIicpICsgJ1wiJztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5EaXN0aW5jdChjYXRlZ29yeSA6IHN0cmluZywgcmVjb3JkcyA6IEFycmF5PElNYXRjaC5JUmVjb3JkPikgOiBzdHJpbmcge1xuICB2YXIgcmVzID0gcmVjb3Jkcy5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgb1JlY29yZCkge1xuICAgIHByZXZbb1JlY29yZFtjYXRlZ29yeV1dID0gMTtcbiAgICByZXR1cm4gcHJldjtcbiAgfSx7fSBhcyBhbnkpO1xuICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChPYmplY3Qua2V5cyhyZXMpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCggYW5zd2VycyA6IEFycmF5PElNYXRjaC5JV2hhdElzQW5zd2VyPikgOiBzdHJpbmcge1xuICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChhbnN3ZXJzLm1hcChmdW5jdGlvbihvQW5zd2VyKSB7XG4gICAgcmV0dXJuIG9BbnN3ZXIucmVzdWx0O1xuICB9KSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBqb2luUmVzdWx0cyhyZXN1bHRzOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4pOiBzdHJpbmdbXSB7XG4gIHZhciByZXMgID0gW107XG4gIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgaWYocmVzLmluZGV4T2YocmVzdWx0LnJlc3VsdCkgPCAwICl7XG4gICAgICAgIHJlcy5wdXNoKHJlc3VsdC5yZXN1bHQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgIH1cbiAgfSwgMCk7XG4gIHJldHVybiByZXM7XG59XG5cbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJy4uL3V0aWxzL3V0aWxzJztcblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5SZXN1bHRzVHVwZWwocmVzdWx0czogQXJyYXk8SU1hdGNoLklXaGF0SXNUdXBlbEFuc3dlcj4pOiBzdHJpbmdbXSB7XG4gIHZhciByZXMgID0gW107XG4gIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgdmFyIHZhbHVlID0gVXRpbHMubGlzdFRvUXVvdGVkQ29tbWFBbmQocmVzdWx0LnJlc3VsdCk7XG4gICAgICBpZihyZXMuaW5kZXhPZih2YWx1ZSkgPCAwICl7XG4gICAgICAgIHJlcy5wdXNoKHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBwcmV2ICsgMTtcbiAgICB9XG4gIH0sIDApO1xuICByZXR1cm4gcmVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5mZXJEb21haW4odGhlTW9kZWwgOiBJTWF0Y2guSU1vZGVscywgY29udGV4dFF1ZXJ5U3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcge1xuIC8vIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgc3RyaW5nXCIgKyBjb250ZXh0UXVlcnlTdHJpbmcpO1xuIC8vICBjb25zb2xlLmxvZyhcImhlcmUgdGhlIHJ1bGVzXCIgKyBKU09OLnN0cmluZ2lmeSh0aGVNb2RlbC5tUnVsZXMpKTtcbiAgdmFyIHJlcyA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgdGhlTW9kZWwucnVsZXMpO1xuICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlcyx1bmRlZmluZWQsMikpO1xuICAvLyBydW4gdGhyb3VnaCB0aGUgc3RyaW5nLCBzZWFyY2ggZm9yIGEgY2F0ZWdvcnlcbiAgaWYoIXJlcy5zZW50ZW5jZXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICB2YXIgZG9tYWlucyA9IFtdO1xuICAvL2NvbnNvbGUubG9nKFNlbnRlbmNlLmR1bXBOaWNlQXJyKHJlcykpO1xuICAvLyBkbyB3ZSBoYXZlIGEgZG9tYWluID9cbiAgcmVzLnNlbnRlbmNlc1swXS5mb3JFYWNoKGZ1bmN0aW9uKG9Xb3JkR3JvdXApIHtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImRvbWFpblwiKSB7XG4gICAgICBkb21haW5zLnB1c2gob1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nKVxuICAgIH1cbiAgfSk7XG4gIGlmKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgZGVidWdsb2coXCJnb3QgYSBwcmVjaXNlIGRvbWFpbiBcIiArIGRvbWFpbnNbMF0pO1xuICAgIHJldHVybiBkb21haW5zWzBdO1xuICB9XG4gIGlmKGRvbWFpbnMubGVuZ3RoID4gMCApIHtcbiAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkPyAoXCJnb3QgbW9yZSB0aGFuIG9uZSBkb21haW4sIGNvbmZ1c2VkICBcIiArIGRvbWFpbnMuam9pbihcIlxcblwiKSk6Jy0nKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIC8vIFRPRE9EXG4gIH1cbiAgZGVidWdsb2coXCJhdHRlbXB0aW5nIHRvIGRldGVybWluZSBjYXRlZ29yaWVzXCIpXG4gIC8vIHRyeSBhIGNhdGVnb3J5IHJldmVyc2UgbWFwXG4gIHJlcy5zZW50ZW5jZXNbMF0uZm9yRWFjaChmdW5jdGlvbihvV29yZEdyb3VwKXtcbiAgICBpZihvV29yZEdyb3VwLmNhdGVnb3J5ID09PSBcImNhdGVnb3J5XCIpIHtcbiAgICAgIHZhciBzQ2F0ID0gb1dvcmRHcm91cC5tYXRjaGVkU3RyaW5nO1xuICAgICAgdmFyIGRvbXMgPSBNb2RlbC5nZXREb21haW5zRm9yQ2F0ZWdvcnkodGhlTW9kZWwsc0NhdCk7XG4gICAgICBkb21zLmZvckVhY2goZnVuY3Rpb24oc0RvbSkge1xuICAgICAgICBpZihkb21haW5zLmluZGV4T2Yoc0RvbSkgPCAwKSB7XG4gICAgICAgICAgZG9tYWlucy5wdXNoKHNEb20pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBpZihkb21haW5zLmxlbmd0aCA9PT0gMSkge1xuICAgICBkZWJ1Z2xvZyhcImdvdCBhIHByZWNpc2UgZG9tYWluIFwiICsgZG9tYWluc1swXSk7XG4gICAgcmV0dXJuIGRvbWFpbnNbMF07XG4gIH1cbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcImdvdCBtb3JlIHRoYW4gb25lIGRvbWFpbiwgY29uZnVzZWQgIFwiICsgZG9tYWlucy5qb2luKFwiXFxuXCIpKSA6Jy0nKTtcbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn07IiwiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgYW5hbHl6ZS50c1xuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdsaXN0YWxsJyk7XG52YXIgbG9nZ2VyID0gcmVxdWlyZShcIi4uL3V0aWxzL2xvZ2dlclwiKTtcbnZhciBsb2dQZXJmID0gbG9nZ2VyLnBlcmYoXCJwZXJmbGlzdGFsbFwiKTtcbnZhciBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcbnZhciBCcmVha0Rvd24gPSByZXF1aXJlKFwiLi9icmVha2Rvd25cIik7XG52YXIgT3BlcmF0b3IgPSByZXF1aXJlKFwiLi9vcGVyYXRvclwiKTtcbnZhciBXaGF0SXMgPSByZXF1aXJlKFwiLi93aGF0aXNcIik7XG52YXIgRXJFcnJvciA9IHJlcXVpcmUoXCIuL2VyZXJyb3JcIik7XG52YXIgTW9kZWwgPSByZXF1aXJlKFwiLi4vbW9kZWwvbW9kZWxcIik7XG52YXIgc1dvcmRzID0ge307XG5mdW5jdGlvbiBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHJlY29yZHMsIHVuZGVmaW5lZCwgMikgOiBcIi1cIik7XG4gICAgdmFyIHJlbGV2YW50UmVjb3JkcyA9IHJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQpIHtcbiAgICAgICAgcmV0dXJuIChyZWNvcmRbY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpICYmIChyZWNvcmRbY2F0ZWdvcnldICE9PSBudWxsKTtcbiAgICB9KTtcbiAgICB2YXIgcmVzID0gW107XG4gICAgZGVidWdsb2coXCJyZWxldmFudCByZWNvcmRzIG5yOlwiICsgcmVsZXZhbnRSZWNvcmRzLmxlbmd0aCk7XG4gICAgcmV0dXJuIHJlbGV2YW50UmVjb3Jkcztcbn1cbmV4cG9ydHMubWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeSA9IG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnk7XG5mdW5jdGlvbiBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHJ1bGVzKSB7XG4gICAgcmV0dXJuIFdoYXRJcy5hbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIHJ1bGVzKTtcbn1cbmV4cG9ydHMuYW5hbHl6ZUNvbnRleHRTdHJpbmcgPSBhbmFseXplQ29udGV4dFN0cmluZztcbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDb250ZXh0KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3JkcywgY2F0ZWdvcnlTZXQpIHtcbiAgICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYW5zd2VyczogW10sXG4gICAgICAgICAgICBlcnJvcnM6IFtFckVycm9yLm1ha2VFcnJvcl9FTVBUWV9JTlBVVCgpXSxcbiAgICAgICAgICAgIHRva2VuczogW11cbiAgICAgICAgfTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxvZ1BlcmYoJ2xpc3RBbGxXaXRoQ29udGV4dCcpO1xuICAgICAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsV2l0aENvbnRleHRcIik7XG4gICAgICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IGFuYWx5emVDb250ZXh0U3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICAgICAgZGVidWdsb2coXCJsaXN0QWxsV2l0aENvbnRleHQ6bWF0Y2hpbmcgcmVjb3JkcyAocz1cIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLnNlbnRlbmNlcy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgICAgIGRlYnVnbG9nKFwiaGVyZSBzZW50ZW5jZXNcIiArIEpTT04uc3RyaW5naWZ5KGFTZW50ZW5jZXNSZWluZm9yY2VkLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgcGVyZmxvZyhcIm1hdGNoaW5nIHJlY29yZHMgKHM9XCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5zZW50ZW5jZXMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzUXVpY2soYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3J5LCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcImZpbHRlcmluZyB0b3BSYW5rZWQgKGE9XCIgKyBtYXRjaGVkQW5zd2Vycy5hbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzLmFuc3dlcnMpO1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0IChhPVwiICsgbWF0Y2hlZEZpbHRlcmVkLmxlbmd0aCArIFwiKVwiKTtcbiAgICAgICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhbnN3ZXJzOiBtYXRjaGVkRmlsdGVyZWQsXG4gICAgICAgICAgICBlcnJvcnM6IGFTZW50ZW5jZXNSZWluZm9yY2VkLmVycm9ycyxcbiAgICAgICAgICAgIHRva2VuczogYVNlbnRlbmNlc1JlaW5mb3JjZWQudG9rZW5zXG4gICAgICAgIH07XG4gICAgfVxufVxuZXhwb3J0cy5saXN0QWxsV2l0aENvbnRleHQgPSBsaXN0QWxsV2l0aENvbnRleHQ7XG5mdW5jdGlvbiBsaXN0QWxsSGF2aW5nQ29udGV4dChjYXRlZ29yeSwgY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMsIHJlY29yZHMsIGNhdGVnb3J5U2V0KSB7XG4gICAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGVycm9yczogW0VyRXJyb3IubWFrZUVycm9yX0VNUFRZX0lOUFVUKCldLFxuICAgICAgICAgICAgdG9rZW5zOiBbXSxcbiAgICAgICAgICAgIGFuc3dlcnM6IFtdXG4gICAgICAgIH07XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBwZXJmbG9nKFwiYW5hbHl6ZUNvbnRleHRTdHJpbmcgLi4uXCIpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIGhhdmluZyAocz1cIiArIChhU2VudGVuY2VzUmVpbmZvcmNlZC5zZW50ZW5jZXMubGVuZ3RoKSArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3Jkc0hhdmluZ0NvbnRleHQoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3J5LCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcImZpbHRlcmluZ1RvcFJhbmtlZCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLnNlbnRlbmNlcy5sZW5ndGggKyBcIikuLi5cIik7XG4gICAgICAgIG1hdGNoZWRBbnN3ZXJzLmFuc3dlcnMgPSBXaGF0SXMuZmlsdGVyT25seVRvcFJhbmtlZChtYXRjaGVkQW5zd2Vycy5hbnN3ZXJzKTtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2Vycy5hbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwidG90YWxMaXN0QWxsSGF2aW5nQ29udGV4dCAoYT1cIiArIG1hdGNoZWRBbnN3ZXJzLmFuc3dlcnMubGVuZ3RoICsgXCIpXCIpO1xuICAgICAgICByZXR1cm4gbWF0Y2hlZEFuc3dlcnM7XG4gICAgfVxufVxuZXhwb3J0cy5saXN0QWxsSGF2aW5nQ29udGV4dCA9IGxpc3RBbGxIYXZpbmdDb250ZXh0O1xuZnVuY3Rpb24gbGlzdEFsbFR1cGVsV2l0aENvbnRleHQoY2F0ZWdvcmllcywgY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMsIHJlY29yZHMsIGNhdGVnb3J5U2V0KSB7XG4gICAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR1cGVsYW5zd2VyczogW10sXG4gICAgICAgICAgICBlcnJvcnM6IFtFckVycm9yLm1ha2VFcnJvcl9FTVBUWV9JTlBVVCgpXSxcbiAgICAgICAgICAgIHRva2VuczogW10sXG4gICAgICAgIH07XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBsb2dQZXJmKCdsaXN0QWxsV2l0aENvbnRleHQnKTtcbiAgICAgICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0XCIpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBhbmFseXplQ29udGV4dFN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIHBlcmZsb2coXCJtYXRjaGluZyByZWNvcmRzIChzPVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQuc2VudGVuY2VzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3Jkc1F1aWNrTXVsdGlwbGVDYXRlZ29yaWVzKGFTZW50ZW5jZXNSZWluZm9yY2VkLCBjYXRlZ29yaWVzLCByZWNvcmRzLCBjYXRlZ29yeVNldCk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcImZpbHRlcmluZyB0b3BSYW5rZWQgKGE9XCIgKyBtYXRjaGVkQW5zd2Vycy50dXBlbGFuc3dlcnMubGVuZ3RoICsgXCIpLi4uXCIpO1xuICAgICAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWRUdXBlbChtYXRjaGVkQW5zd2Vycy50dXBlbGFuc3dlcnMpO1xuICAgICAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIH1cbiAgICAgICAgcGVyZmxvZyhcInRvdGFsTGlzdEFsbFdpdGhDb250ZXh0IChhPVwiICsgbWF0Y2hlZEZpbHRlcmVkLmxlbmd0aCArIFwiKVwiKTtcbiAgICAgICAgbG9nUGVyZignbGlzdEFsbFdpdGhDb250ZXh0Jyk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0dXBlbGFuc3dlcnM6IG1hdGNoZWRGaWx0ZXJlZCxcbiAgICAgICAgICAgIGVycm9yczogYVNlbnRlbmNlc1JlaW5mb3JjZWQuZXJyb3JzLFxuICAgICAgICAgICAgdG9rZW5zOiBhU2VudGVuY2VzUmVpbmZvcmNlZC50b2tlbnNcbiAgICAgICAgfTtcbiAgICB9XG59XG5leHBvcnRzLmxpc3RBbGxUdXBlbFdpdGhDb250ZXh0ID0gbGlzdEFsbFR1cGVsV2l0aENvbnRleHQ7XG5mdW5jdGlvbiBsaXN0QWxsVHVwZWxIYXZpbmdDb250ZXh0KGNhdGVnb3JpZXMsIGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzLCByZWNvcmRzLCBjYXRlZ29yeVNldCkge1xuICAgIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0dXBlbGFuc3dlcnM6IFtdLFxuICAgICAgICAgICAgZXJyb3JzOiBbRXJFcnJvci5tYWtlRXJyb3JfRU1QVFlfSU5QVVQoKV0sXG4gICAgICAgICAgICB0b2tlbnM6IFtdLFxuICAgICAgICB9O1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcGVyZmxvZyhcImFuYWx5emVDb250ZXh0U3RyaW5nIC4uLlwiKTtcbiAgICAgICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgICAgICBwZXJmbG9nKFwibWF0Y2hpbmcgcmVjb3JkcyBoYXZpbmcgKHM9XCIgKyAoYVNlbnRlbmNlc1JlaW5mb3JjZWQuc2VudGVuY2VzLmxlbmd0aCkgKyBcIikuLi5cIik7XG4gICAgICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNUdXBlbEhhdmluZ0NvbnRleHQoYVNlbnRlbmNlc1JlaW5mb3JjZWQsIGNhdGVnb3JpZXMsIHJlY29yZHMsIGNhdGVnb3J5U2V0KTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJmbG9nKFwiZmlsdGVyaW5nVG9wUmFua2VkIChhPVwiICsgbWF0Y2hlZEFuc3dlcnMudHVwZWxhbnN3ZXJzLmxlbmd0aCArIFwiKS4uLlwiKTtcbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkVHVwZWwobWF0Y2hlZEFuc3dlcnMudHVwZWxhbnN3ZXJzKTtcbiAgICAgICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgdG9wLXJhbmtlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkRmlsdGVyZWQsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIHBlcmZsb2coXCJ0b3RhbExpc3RBbGxIYXZpbmdDb250ZXh0IChhPVwiICsgbWF0Y2hlZEZpbHRlcmVkLmxlbmd0aCArIFwiKVwiKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR1cGVsYW5zd2VyczogbWF0Y2hlZEZpbHRlcmVkLFxuICAgICAgICAgICAgZXJyb3JzOiBhU2VudGVuY2VzUmVpbmZvcmNlZC5lcnJvcnMsXG4gICAgICAgICAgICB0b2tlbnM6IGFTZW50ZW5jZXNSZWluZm9yY2VkLnRva2Vuc1xuICAgICAgICB9O1xuICAgIH1cbn1cbmV4cG9ydHMubGlzdEFsbFR1cGVsSGF2aW5nQ29udGV4dCA9IGxpc3RBbGxUdXBlbEhhdmluZ0NvbnRleHQ7XG5mdW5jdGlvbiBmaWx0ZXJTdHJpbmdMaXN0QnlPcChvcGVyYXRvciwgZnJhZ21lbnQsIHNyY2Fycikge1xuICAgIHZhciBmcmFnbWVudExDID0gQnJlYWtEb3duLnRyaW1RdW90ZWRTcGFjZWQoZnJhZ21lbnQudG9Mb3dlckNhc2UoKSk7XG4gICAgcmV0dXJuIHNyY2Fyci5maWx0ZXIoZnVuY3Rpb24gKHN0cikge1xuICAgICAgICByZXR1cm4gT3BlcmF0b3IubWF0Y2hlcyhvcGVyYXRvciwgZnJhZ21lbnRMQywgc3RyLnRvTG93ZXJDYXNlKCkpO1xuICAgIH0pLnNvcnQoKTtcbn1cbmV4cG9ydHMuZmlsdGVyU3RyaW5nTGlzdEJ5T3AgPSBmaWx0ZXJTdHJpbmdMaXN0QnlPcDtcbmZ1bmN0aW9uIGNvbXBhcmVDYXNlSW5zZW5zaXRpdmUoYSwgYikge1xuICAgIHZhciByID0gYS50b0xvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUoYi50b0xvd2VyQ2FzZSgpKTtcbiAgICBpZiAocikge1xuICAgICAgICByZXR1cm4gcjtcbiAgICB9XG4gICAgcmV0dXJuIC1hLmxvY2FsZUNvbXBhcmUoYik7XG59XG4vKipcbiAqIFNvcnQgc3RyaW5nIGxpc3QgY2FzZSBpbnNlbnNpdGl2ZSwgdGhlbiByZW1vdmUgZHVwbGljYXRlcyByZXRhaW5pbmdcbiAqIFwibGFyZ2VzdFwiIG1hdGNoXG4gKi9cbmZ1bmN0aW9uIHJlbW92ZUNhc2VEdXBsaWNhdGVzKGFycikge1xuICAgIGFyci5zb3J0KGNvbXBhcmVDYXNlSW5zZW5zaXRpdmUpO1xuICAgIGRlYnVnbG9nKCdzb3J0ZWQgYXJyJyArIEpTT04uc3RyaW5naWZ5KGFycikpO1xuICAgIHJldHVybiBhcnIuZmlsdGVyKGZ1bmN0aW9uIChzLCBpbmRleCkge1xuICAgICAgICByZXR1cm4gaW5kZXggPT09IDAgfHwgKDAgIT09IGFycltpbmRleCAtIDFdLnRvTG93ZXJDYXNlKCkubG9jYWxlQ29tcGFyZShzLnRvTG93ZXJDYXNlKCkpKTtcbiAgICB9KTtcbn1cbmV4cG9ydHMucmVtb3ZlQ2FzZUR1cGxpY2F0ZXMgPSByZW1vdmVDYXNlRHVwbGljYXRlcztcbjtcbmZ1bmN0aW9uIGdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyhvcGVyYXRvciwgZnJhZ21lbnQsIGNhdGVnb3J5LCByZWNvcmRzLCBmaWx0ZXJEb21haW4pIHtcbiAgICB2YXIgZnJhZ21lbnRMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkKGZyYWdtZW50LnRvTG93ZXJDYXNlKCkpO1xuICAgIHZhciByZXMgPSBbXTtcbiAgICB2YXIgc2VlbiA9IHt9O1xuICAgIHJlY29yZHMuZm9yRWFjaChmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgICAgIGlmIChmaWx0ZXJEb21haW4gJiYgcmVjb3JkWydfZG9tYWluJ10gIT09IGZpbHRlckRvbWFpbikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZWNvcmRbY2F0ZWdvcnldICYmIE9wZXJhdG9yLm1hdGNoZXMob3BlcmF0b3IsIGZyYWdtZW50TEMsIHJlY29yZFtjYXRlZ29yeV0udG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgICAgIGlmICghc2VlbltyZWNvcmRbY2F0ZWdvcnldXSkge1xuICAgICAgICAgICAgICAgIHNlZW5bcmVjb3JkW2NhdGVnb3J5XV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIHJlcy5wdXNoKHJlY29yZFtjYXRlZ29yeV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlbW92ZUNhc2VEdXBsaWNhdGVzKHJlcyk7XG59XG5leHBvcnRzLmdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncyA9IGdldENhdGVnb3J5T3BGaWx0ZXJBc0Rpc3RpbmN0U3RyaW5ncztcbjtcbmZ1bmN0aW9uIGxpa2VseVBsdXJhbERpZmYoYSwgcGx1cmFsT2ZhKSB7XG4gICAgdmFyIGFMQyA9IEJyZWFrRG93bi50cmltUXVvdGVkKGEudG9Mb3dlckNhc2UoKSkgfHwgXCJcIjtcbiAgICB2YXIgcGx1cmFsT2ZBTEMgPSBCcmVha0Rvd24udHJpbVF1b3RlZCgocGx1cmFsT2ZhIHx8IFwiXCIpLnRvTG93ZXJDYXNlKCkpIHx8IFwiXCI7XG4gICAgaWYgKGFMQyA9PT0gcGx1cmFsT2ZBTEMpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmIChhTEMgKyAncycgPT09IHBsdXJhbE9mQUxDKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5leHBvcnRzLmxpa2VseVBsdXJhbERpZmYgPSBsaWtlbHlQbHVyYWxEaWZmO1xuO1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnksIHJlY29yZHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBkZWJ1Z2xvZyhcIiBsaXN0QWxsV2l0aENhdGVnb3J5OlwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cbmV4cG9ydHMubGlzdEFsbFdpdGhDYXRlZ29yeSA9IGxpc3RBbGxXaXRoQ2F0ZWdvcnk7XG5mdW5jdGlvbiBqb2luU29ydGVkUXVvdGVkKHN0cmluZ3MpIHtcbiAgICBpZiAoc3RyaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuICAgIHJldHVybiAnXCInICsgc3RyaW5ncy5zb3J0KCkuam9pbignXCI7IFwiJykgKyAnXCInO1xufVxuZXhwb3J0cy5qb2luU29ydGVkUXVvdGVkID0gam9pblNvcnRlZFF1b3RlZDtcbmZ1bmN0aW9uIGpvaW5EaXN0aW5jdChjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIHZhciByZXMgPSByZWNvcmRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgb1JlY29yZCkge1xuICAgICAgICBwcmV2W29SZWNvcmRbY2F0ZWdvcnldXSA9IDE7XG4gICAgICAgIHJldHVybiBwcmV2O1xuICAgIH0sIHt9KTtcbiAgICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChPYmplY3Qua2V5cyhyZXMpKTtcbn1cbmV4cG9ydHMuam9pbkRpc3RpbmN0ID0gam9pbkRpc3RpbmN0O1xuZnVuY3Rpb24gZm9ybWF0RGlzdGluY3RGcm9tV2hhdElmUmVzdWx0KGFuc3dlcnMpIHtcbiAgICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChhbnN3ZXJzLm1hcChmdW5jdGlvbiAob0Fuc3dlcikge1xuICAgICAgICByZXR1cm4gb0Fuc3dlci5yZXN1bHQ7XG4gICAgfSkpO1xufVxuZXhwb3J0cy5mb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQgPSBmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQ7XG5mdW5jdGlvbiBqb2luUmVzdWx0cyhyZXN1bHRzKSB7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgICAgIGlmIChyZXN1bHQuX3JhbmtpbmcgPT09IHJlc3VsdHNbMF0uX3JhbmtpbmcpIHtcbiAgICAgICAgICAgIGlmIChyZXMuaW5kZXhPZihyZXN1bHQucmVzdWx0KSA8IDApIHtcbiAgICAgICAgICAgICAgICByZXMucHVzaChyZXN1bHQucmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmV2ICsgMTtcbiAgICAgICAgfVxuICAgIH0sIDApO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmpvaW5SZXN1bHRzID0gam9pblJlc3VsdHM7XG52YXIgVXRpbHMgPSByZXF1aXJlKFwiLi4vdXRpbHMvdXRpbHNcIik7XG5mdW5jdGlvbiBqb2luUmVzdWx0c1R1cGVsKHJlc3VsdHMpIHtcbiAgICB2YXIgcmVzID0gW107XG4gICAgdmFyIGNudCA9IHJlc3VsdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCByZXN1bHQpIHtcbiAgICAgICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgICAgICAgdmFyIHZhbHVlID0gVXRpbHMubGlzdFRvUXVvdGVkQ29tbWFBbmQocmVzdWx0LnJlc3VsdCk7XG4gICAgICAgICAgICBpZiAocmVzLmluZGV4T2YodmFsdWUpIDwgMCkge1xuICAgICAgICAgICAgICAgIHJlcy5wdXNoKHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmV2ICsgMTtcbiAgICAgICAgfVxuICAgIH0sIDApO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmpvaW5SZXN1bHRzVHVwZWwgPSBqb2luUmVzdWx0c1R1cGVsO1xuZnVuY3Rpb24gaW5mZXJEb21haW4odGhlTW9kZWwsIGNvbnRleHRRdWVyeVN0cmluZykge1xuICAgIC8vIGNvbnNvbGUubG9nKFwiaGVyZSB0aGUgc3RyaW5nXCIgKyBjb250ZXh0UXVlcnlTdHJpbmcpO1xuICAgIC8vICBjb25zb2xlLmxvZyhcImhlcmUgdGhlIHJ1bGVzXCIgKyBKU09OLnN0cmluZ2lmeSh0aGVNb2RlbC5tUnVsZXMpKTtcbiAgICB2YXIgcmVzID0gYW5hbHl6ZUNvbnRleHRTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCB0aGVNb2RlbC5ydWxlcyk7XG4gICAgLy9jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXMsdW5kZWZpbmVkLDIpKTtcbiAgICAvLyBydW4gdGhyb3VnaCB0aGUgc3RyaW5nLCBzZWFyY2ggZm9yIGEgY2F0ZWdvcnlcbiAgICBpZiAoIXJlcy5zZW50ZW5jZXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHZhciBkb21haW5zID0gW107XG4gICAgLy9jb25zb2xlLmxvZyhTZW50ZW5jZS5kdW1wTmljZUFycihyZXMpKTtcbiAgICAvLyBkbyB3ZSBoYXZlIGEgZG9tYWluID9cbiAgICByZXMuc2VudGVuY2VzWzBdLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkR3JvdXApIHtcbiAgICAgICAgaWYgKG9Xb3JkR3JvdXAuY2F0ZWdvcnkgPT09IFwiZG9tYWluXCIpIHtcbiAgICAgICAgICAgIGRvbWFpbnMucHVzaChvV29yZEdyb3VwLm1hdGNoZWRTdHJpbmcpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgaWYgKGRvbWFpbnMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiZ290IGEgcHJlY2lzZSBkb21haW4gXCIgKyBkb21haW5zWzBdKTtcbiAgICAgICAgcmV0dXJuIGRvbWFpbnNbMF07XG4gICAgfVxuICAgIGlmIChkb21haW5zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcImdvdCBtb3JlIHRoYW4gb25lIGRvbWFpbiwgY29uZnVzZWQgIFwiICsgZG9tYWlucy5qb2luKFwiXFxuXCIpKSA6ICctJyk7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGRlYnVnbG9nKFwiYXR0ZW1wdGluZyB0byBkZXRlcm1pbmUgY2F0ZWdvcmllc1wiKTtcbiAgICAvLyB0cnkgYSBjYXRlZ29yeSByZXZlcnNlIG1hcFxuICAgIHJlcy5zZW50ZW5jZXNbMF0uZm9yRWFjaChmdW5jdGlvbiAob1dvcmRHcm91cCkge1xuICAgICAgICBpZiAob1dvcmRHcm91cC5jYXRlZ29yeSA9PT0gXCJjYXRlZ29yeVwiKSB7XG4gICAgICAgICAgICB2YXIgc0NhdCA9IG9Xb3JkR3JvdXAubWF0Y2hlZFN0cmluZztcbiAgICAgICAgICAgIHZhciBkb21zID0gTW9kZWwuZ2V0RG9tYWluc0ZvckNhdGVnb3J5KHRoZU1vZGVsLCBzQ2F0KTtcbiAgICAgICAgICAgIGRvbXMuZm9yRWFjaChmdW5jdGlvbiAoc0RvbSkge1xuICAgICAgICAgICAgICAgIGlmIChkb21haW5zLmluZGV4T2Yoc0RvbSkgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvbWFpbnMucHVzaChzRG9tKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChkb21haW5zLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICBkZWJ1Z2xvZyhcImdvdCBhIHByZWNpc2UgZG9tYWluIFwiICsgZG9tYWluc1swXSk7XG4gICAgICAgIHJldHVybiBkb21haW5zWzBdO1xuICAgIH1cbiAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKFwiZ290IG1vcmUgdGhhbiBvbmUgZG9tYWluLCBjb25mdXNlZCAgXCIgKyBkb21haW5zLmpvaW4oXCJcXG5cIikpIDogJy0nKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5pbmZlckRvbWFpbiA9IGluZmVyRG9tYWluO1xuO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
