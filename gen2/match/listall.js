/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var InputFilter = require('./inputFilter');
var debug = require('debug');
var debuglog = debug('whatis');
var Sentence = require('./sentence');
var WhatIs = require('./whatis');
function matchRecordHavingCategory(category, records) {
    debuglog(JSON.stringify(records, undefined, 2));
    var relevantRecords = records.filter(function (record) {
        return record[category] !== undefined && record[category] !== null;
    });
    var res = [];
    debuglog("relevant records nr:" + relevantRecords.length);
    return relevantRecords;
}
exports.matchRecordHavingCategory = matchRecordHavingCategory;
function analyzeCategory(categoryword, aRules, wholesentence) {
    var cats = InputFilter.categorizeAWord(categoryword, aRules, wholesentence, {});
    // TODO qualify
    cats = cats.filter(function (cat) {
        return cat.category === 'category';
    });
    if (cats.length) {
        return cats[0].matchedString;
    }
}
exports.analyzeCategory = analyzeCategory;
// const result = WhatIs.resolveCategory(cat, a1.entity,
//   theModel.mRules, theModel.tools, theModel.records);
function listAllWithContext(category, contextQueryString, aRules, records) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        var matched = InputFilter.analyzeString(contextQueryString, aRules);
        debuglog("After matched " + JSON.stringify(matched));
        var aSentences = InputFilter.expandMatchArr(matched);
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var aSentencesReinforced = InputFilter.reinForce(aSentences);
        //aSentences.map(function(oSentence) { return InputFilter.reinForce(oSentence); });
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var matchedAnswers = WhatIs.matchRecords(aSentences, category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        return matchedAnswers;
    }
}
exports.listAllWithContext = listAllWithContext;
function listAllHavingContext(category, contextQueryString, aRules, records) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        var matched = InputFilter.analyzeString(contextQueryString, aRules);
        debuglog("After matched " + JSON.stringify(matched));
        var aSentences = InputFilter.expandMatchArr(matched);
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var aSentencesReinforced = InputFilter.reinForce(aSentences);
        //aSentences.map(function(oSentence) { return InputFilter.reinForce(oSentence); });
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var matchedAnswers = WhatIs.matchRecordsHavingContext(aSentences, category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        debuglog(" matched Answers" + JSON.stringify(matchedAnswers, undefined, 2));
        var matchedFiltered = WhatIs.filterOnlyTopRanked(matchedAnswers);
        debuglog(" matched top-ranked Answers" + JSON.stringify(matchedFiltered, undefined, 2));
        return matchedFiltered;
    }
}
exports.listAllHavingContext = listAllHavingContext;
function listAllWithCategory(category, records) {
    var matchedAnswers = matchRecordHavingCategory(category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
    debuglog(" listAllWithCategory:" + JSON.stringify(matchedAnswers, undefined, 2));
    return matchedAnswers;
}
exports.listAllWithCategory = listAllWithCategory;
function joinSortedQuoted(strings) {
    if (strings.length === 0) {
        return "";
    }
    return '"' + strings.sort().join('"; "') + '"';
}
exports.joinSortedQuoted = joinSortedQuoted;
function joinDistinct(category, records) {
    var res = records.reduce(function (prev, oRecord) {
        prev[oRecord[category]] = 1;
        return prev;
    }, {});
    return joinSortedQuoted(Object.keys(res));
}
exports.joinDistinct = joinDistinct;
function formatDistinctFromWhatIfResult(answers) {
    return joinSortedQuoted(answers.map(function (oAnswer) {
        return oAnswer.result;
    }));
}
exports.formatDistinctFromWhatIfResult = formatDistinctFromWhatIfResult;
function joinResults(results) {
    var res = [];
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            if (res.indexOf(result.result) < 0) {
                res.push(result.result);
            }
            return prev + 1;
        }
    }, 0);
    return res;
}
exports.joinResults = joinResults;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9saXN0YWxsLnRzIiwibWF0Y2gvbGlzdGFsbC5qcyJdLCJuYW1lcyI6WyJJbnB1dEZpbHRlciIsInJlcXVpcmUiLCJkZWJ1ZyIsImRlYnVnbG9nIiwiU2VudGVuY2UiLCJXaGF0SXMiLCJtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5IiwiY2F0ZWdvcnkiLCJyZWNvcmRzIiwiSlNPTiIsInN0cmluZ2lmeSIsInVuZGVmaW5lZCIsInJlbGV2YW50UmVjb3JkcyIsImZpbHRlciIsInJlY29yZCIsInJlcyIsImxlbmd0aCIsImV4cG9ydHMiLCJhbmFseXplQ2F0ZWdvcnkiLCJjYXRlZ29yeXdvcmQiLCJhUnVsZXMiLCJ3aG9sZXNlbnRlbmNlIiwiY2F0cyIsImNhdGVnb3JpemVBV29yZCIsImNhdCIsIm1hdGNoZWRTdHJpbmciLCJsaXN0QWxsV2l0aENvbnRleHQiLCJjb250ZXh0UXVlcnlTdHJpbmciLCJtYXRjaGVkIiwiYW5hbHl6ZVN0cmluZyIsImFTZW50ZW5jZXMiLCJleHBhbmRNYXRjaEFyciIsIm1hcCIsIm9TZW50ZW5jZSIsInJhbmtpbmdQcm9kdWN0Iiwiam9pbiIsImFTZW50ZW5jZXNSZWluZm9yY2VkIiwicmVpbkZvcmNlIiwibWF0Y2hlZEFuc3dlcnMiLCJtYXRjaFJlY29yZHMiLCJtYXRjaGVkRmlsdGVyZWQiLCJmaWx0ZXJPbmx5VG9wUmFua2VkIiwibGlzdEFsbEhhdmluZ0NvbnRleHQiLCJtYXRjaFJlY29yZHNIYXZpbmdDb250ZXh0IiwibGlzdEFsbFdpdGhDYXRlZ29yeSIsImpvaW5Tb3J0ZWRRdW90ZWQiLCJzdHJpbmdzIiwic29ydCIsImpvaW5EaXN0aW5jdCIsInJlZHVjZSIsInByZXYiLCJvUmVjb3JkIiwiT2JqZWN0Iiwia2V5cyIsImZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCIsImFuc3dlcnMiLCJvQW5zd2VyIiwicmVzdWx0Iiwiam9pblJlc3VsdHMiLCJyZXN1bHRzIiwiY250IiwiX3Jhbmtp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ZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgYW5hbHl6ZS50c1xuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cblxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXIgZnJvbSAnLi9pbnB1dEZpbHRlcic7XG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1Zygnd2hhdGlzJyk7XG5cbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3V0aWxzL3V0aWxzJztcblxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XG5cbmltcG9ydCAqIGFzIFRvb2xtYXRjaGVyIGZyb20gJy4vdG9vbG1hdGNoZXInO1xuXG5pbXBvcnQgKiBhcyBTZW50ZW5jZSBmcm9tICcuL3NlbnRlbmNlJztcblxuaW1wb3J0ICogYXMgV29yZCBmcm9tICcuL3dvcmQnO1xuXG5pbXBvcnQgKiBhcyBXaGF0SXMgZnJvbSAnLi93aGF0aXMnO1xuXG5cbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4vbWF0Y2gnO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5KGNhdGVnb3J5OiBzdHJpbmcsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPilcbiAgOiBBcnJheTxJTWF0Y2guSVJlY29yZD4ge1xuICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShyZWNvcmRzLHVuZGVmaW5lZCwyKSk7XG4gIHZhciByZWxldmFudFJlY29yZHMgPSByZWNvcmRzLmZpbHRlcihmdW5jdGlvbiAocmVjb3JkOiBJTWF0Y2guSVJlY29yZCkge1xuICAgIHJldHVybiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gdW5kZWZpbmVkKSAmJiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gbnVsbCk7XG4gIH0pO1xuICB2YXIgcmVzID0gW107XG4gIGRlYnVnbG9nKFwicmVsZXZhbnQgcmVjb3JkcyBucjpcIiArIHJlbGV2YW50UmVjb3Jkcy5sZW5ndGgpO1xuICByZXR1cm4gcmVsZXZhbnRSZWNvcmRzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYW5hbHl6ZUNhdGVnb3J5KGNhdGVnb3J5d29yZCA6IHN0cmluZyAsIGFSdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgd2hvbGVzZW50ZW5jZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgdmFyIGNhdHMgPSBJbnB1dEZpbHRlci5jYXRlZ29yaXplQVdvcmQoY2F0ZWdvcnl3b3JkLCBhUnVsZXMsIHdob2xlc2VudGVuY2UsIHt9KTtcbiAgLy8gVE9ETyBxdWFsaWZ5XG4gIGNhdHMgPSBjYXRzLmZpbHRlcihmdW5jdGlvbihjYXQpIHtcbiAgICByZXR1cm4gY2F0LmNhdGVnb3J5ID09PSAnY2F0ZWdvcnknO1xuICB9KVxuICBpZiAoY2F0cy5sZW5ndGgpIHtcbiAgICByZXR1cm4gY2F0c1swXS5tYXRjaGVkU3RyaW5nO1xuICB9XG59XG5cbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuXG5leHBvcnQgZnVuY3Rpb24gbGlzdEFsbFdpdGhDb250ZXh0KGNhdGVnb3J5OiBzdHJpbmcsIGNvbnRleHRRdWVyeVN0cmluZzogc3RyaW5nLFxuICBhUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4sIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPik6IEFycmF5PElNYXRjaC5JV2hhdElzQW5zd2VyPiB7XG4gIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9IGVsc2Uge1xuICAgIHZhciBtYXRjaGVkID0gSW5wdXRGaWx0ZXIuYW5hbHl6ZVN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZCkpO1xuICAgIHZhciBhU2VudGVuY2VzID0gSW5wdXRGaWx0ZXIuZXhwYW5kTWF0Y2hBcnIobWF0Y2hlZCk7XG4gICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IElucHV0RmlsdGVyLnJlaW5Gb3JjZShhU2VudGVuY2VzKTtcbiAgICAvL2FTZW50ZW5jZXMubWFwKGZ1bmN0aW9uKG9TZW50ZW5jZSkgeyByZXR1cm4gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKG9TZW50ZW5jZSk7IH0pO1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gV2hhdElzLm1hdGNoUmVjb3JkcyhhU2VudGVuY2VzLCBjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuXG4gICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcblxuICAgIHJldHVybiBtYXRjaGVkQW5zd2VycztcbiAgfVxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0QWxsSGF2aW5nQ29udGV4dChjYXRlZ29yeTogc3RyaW5nLCBjb250ZXh0UXVlcnlTdHJpbmc6IHN0cmluZyxcbiAgYVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCByZWNvcmRzOiBBcnJheTxJTWF0Y2guSVJlY29yZD4pOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4ge1xuICBpZiAoY29udGV4dFF1ZXJ5U3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfSBlbHNlIHtcbiAgICB2YXIgbWF0Y2hlZCA9IElucHV0RmlsdGVyLmFuYWx5emVTdHJpbmcoY29udGV4dFF1ZXJ5U3RyaW5nLCBhUnVsZXMpO1xuICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWQpKTtcbiAgICB2YXIgYVNlbnRlbmNlcyA9IElucHV0RmlsdGVyLmV4cGFuZE1hdGNoQXJyKG1hdGNoZWQpO1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgZXhwYW5kXCIgKyBhU2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgLy9hU2VudGVuY2VzLm1hcChmdW5jdGlvbihvU2VudGVuY2UpIHsgcmV0dXJuIElucHV0RmlsdGVyLnJlaW5Gb3JjZShvU2VudGVuY2UpOyB9KTtcbiAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IFdoYXRJcy5tYXRjaFJlY29yZHNIYXZpbmdDb250ZXh0KGFTZW50ZW5jZXMsIGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgZGVidWdsb2coXCIgbWF0Y2hlZCBBbnN3ZXJzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkQW5zd2VycywgdW5kZWZpbmVkLCAyKSk7XG4gICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcblxuICAgIHJldHVybiBtYXRjaGVkRmlsdGVyZWQ7XG4gIH1cbn1cblxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RBbGxXaXRoQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZywgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KTogQXJyYXk8SU1hdGNoLklSZWNvcmQ+IHtcbiAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICBkZWJ1Z2xvZyhcIiBsaXN0QWxsV2l0aENhdGVnb3J5OlwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuXG4gIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5Tb3J0ZWRRdW90ZWQoc3RyaW5ncyA6IHN0cmluZ1tdICkgOiBzdHJpbmcge1xuICBpZiAoc3RyaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gXCJcIjtcbiAgfVxuICByZXR1cm4gJ1wiJyArIHN0cmluZ3Muc29ydCgpLmpvaW4oJ1wiOyBcIicpICsgJ1wiJztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvaW5EaXN0aW5jdChjYXRlZ29yeSA6IHN0cmluZywgcmVjb3JkcyA6IEFycmF5PElNYXRjaC5JUmVjb3JkPikgOiBzdHJpbmcge1xuICB2YXIgcmVzID0gcmVjb3Jkcy5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgb1JlY29yZCkge1xuICAgIHByZXZbb1JlY29yZFtjYXRlZ29yeV1dID0gMTtcbiAgICByZXR1cm4gcHJldjtcbiAgfSx7fSBhcyBhbnkpO1xuICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChPYmplY3Qua2V5cyhyZXMpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdERpc3RpbmN0RnJvbVdoYXRJZlJlc3VsdCggYW5zd2VycyA6IEFycmF5PElNYXRjaC5JV2hhdElzQW5zd2VyPikgOiBzdHJpbmcge1xuICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChhbnN3ZXJzLm1hcChmdW5jdGlvbihvQW5zd2VyKSB7XG4gICAgcmV0dXJuIG9BbnN3ZXIucmVzdWx0O1xuICB9KSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBqb2luUmVzdWx0cyhyZXN1bHRzOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4pOiBzdHJpbmdbXSB7XG4gIHZhciByZXMgID0gW107XG4gIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlc3VsdC5fcmFua2luZyA9PT0gcmVzdWx0c1swXS5fcmFua2luZykge1xuICAgICAgaWYocmVzLmluZGV4T2YocmVzdWx0LnJlc3VsdCkgPCAwICl7XG4gICAgICAgIHJlcy5wdXNoKHJlc3VsdC5yZXN1bHQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHByZXYgKyAxO1xuICAgIH1cbiAgfSwgMCk7XG4gIHJldHVybiByZXM7XG59XG4iLCIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBhbmFseXplLnRzXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIElucHV0RmlsdGVyID0gcmVxdWlyZSgnLi9pbnB1dEZpbHRlcicpO1xudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCd3aGF0aXMnKTtcbnZhciBTZW50ZW5jZSA9IHJlcXVpcmUoJy4vc2VudGVuY2UnKTtcbnZhciBXaGF0SXMgPSByZXF1aXJlKCcuL3doYXRpcycpO1xuZnVuY3Rpb24gbWF0Y2hSZWNvcmRIYXZpbmdDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIGRlYnVnbG9nKEpTT04uc3RyaW5naWZ5KHJlY29yZHMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHZhciByZWxldmFudFJlY29yZHMgPSByZWNvcmRzLmZpbHRlcihmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgICAgIHJldHVybiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gdW5kZWZpbmVkKSAmJiAocmVjb3JkW2NhdGVnb3J5XSAhPT0gbnVsbCk7XG4gICAgfSk7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIGRlYnVnbG9nKFwicmVsZXZhbnQgcmVjb3JkcyBucjpcIiArIHJlbGV2YW50UmVjb3Jkcy5sZW5ndGgpO1xuICAgIHJldHVybiByZWxldmFudFJlY29yZHM7XG59XG5leHBvcnRzLm1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkgPSBtYXRjaFJlY29yZEhhdmluZ0NhdGVnb3J5O1xuZnVuY3Rpb24gYW5hbHl6ZUNhdGVnb3J5KGNhdGVnb3J5d29yZCwgYVJ1bGVzLCB3aG9sZXNlbnRlbmNlKSB7XG4gICAgdmFyIGNhdHMgPSBJbnB1dEZpbHRlci5jYXRlZ29yaXplQVdvcmQoY2F0ZWdvcnl3b3JkLCBhUnVsZXMsIHdob2xlc2VudGVuY2UsIHt9KTtcbiAgICAvLyBUT0RPIHF1YWxpZnlcbiAgICBjYXRzID0gY2F0cy5maWx0ZXIoZnVuY3Rpb24gKGNhdCkge1xuICAgICAgICByZXR1cm4gY2F0LmNhdGVnb3J5ID09PSAnY2F0ZWdvcnknO1xuICAgIH0pO1xuICAgIGlmIChjYXRzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gY2F0c1swXS5tYXRjaGVkU3RyaW5nO1xuICAgIH1cbn1cbmV4cG9ydHMuYW5hbHl6ZUNhdGVnb3J5ID0gYW5hbHl6ZUNhdGVnb3J5O1xuLy8gY29uc3QgcmVzdWx0ID0gV2hhdElzLnJlc29sdmVDYXRlZ29yeShjYXQsIGExLmVudGl0eSxcbi8vICAgdGhlTW9kZWwubVJ1bGVzLCB0aGVNb2RlbC50b29scywgdGhlTW9kZWwucmVjb3Jkcyk7XG5mdW5jdGlvbiBsaXN0QWxsV2l0aENvbnRleHQoY2F0ZWdvcnksIGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzLCByZWNvcmRzKSB7XG4gICAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdmFyIG1hdGNoZWQgPSBJbnB1dEZpbHRlci5hbmFseXplU3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICAgICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZCkpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlcyA9IElucHV0RmlsdGVyLmV4cGFuZE1hdGNoQXJyKG1hdGNoZWQpO1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgICAgIC8vYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24ob1NlbnRlbmNlKSB7IHJldHVybiBJbnB1dEZpbHRlci5yZWluRm9yY2Uob1NlbnRlbmNlKTsgfSk7XG4gICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzKGFTZW50ZW5jZXMsIGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICB2YXIgbWF0Y2hlZEZpbHRlcmVkID0gV2hhdElzLmZpbHRlck9ubHlUb3BSYW5rZWQobWF0Y2hlZEFuc3dlcnMpO1xuICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIHRvcC1yYW5rZWQgQW5zd2Vyc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEZpbHRlcmVkLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoZWRBbnN3ZXJzO1xuICAgIH1cbn1cbmV4cG9ydHMubGlzdEFsbFdpdGhDb250ZXh0ID0gbGlzdEFsbFdpdGhDb250ZXh0O1xuZnVuY3Rpb24gbGlzdEFsbEhhdmluZ0NvbnRleHQoY2F0ZWdvcnksIGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzLCByZWNvcmRzKSB7XG4gICAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdmFyIG1hdGNoZWQgPSBJbnB1dEZpbHRlci5hbmFseXplU3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICAgICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZCkpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlcyA9IElucHV0RmlsdGVyLmV4cGFuZE1hdGNoQXJyKG1hdGNoZWQpO1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgICAgIC8vYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24ob1NlbnRlbmNlKSB7IHJldHVybiBJbnB1dEZpbHRlci5yZWluRm9yY2Uob1NlbnRlbmNlKTsgfSk7XG4gICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBXaGF0SXMubWF0Y2hSZWNvcmRzSGF2aW5nQ29udGV4dChhU2VudGVuY2VzLCBjYXRlZ29yeSwgcmVjb3Jkcyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgICAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgdmFyIG1hdGNoZWRGaWx0ZXJlZCA9IFdoYXRJcy5maWx0ZXJPbmx5VG9wUmFua2VkKG1hdGNoZWRBbnN3ZXJzKTtcbiAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZCB0b3AtcmFua2VkIEFuc3dlcnNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRGaWx0ZXJlZCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIHJldHVybiBtYXRjaGVkRmlsdGVyZWQ7XG4gICAgfVxufVxuZXhwb3J0cy5saXN0QWxsSGF2aW5nQ29udGV4dCA9IGxpc3RBbGxIYXZpbmdDb250ZXh0O1xuZnVuY3Rpb24gbGlzdEFsbFdpdGhDYXRlZ29yeShjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIHZhciBtYXRjaGVkQW5zd2VycyA9IG1hdGNoUmVjb3JkSGF2aW5nQ2F0ZWdvcnkoY2F0ZWdvcnksIHJlY29yZHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBkZWJ1Z2xvZyhcIiBsaXN0QWxsV2l0aENhdGVnb3J5OlwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiBtYXRjaGVkQW5zd2Vycztcbn1cbmV4cG9ydHMubGlzdEFsbFdpdGhDYXRlZ29yeSA9IGxpc3RBbGxXaXRoQ2F0ZWdvcnk7XG5mdW5jdGlvbiBqb2luU29ydGVkUXVvdGVkKHN0cmluZ3MpIHtcbiAgICBpZiAoc3RyaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuICAgIHJldHVybiAnXCInICsgc3RyaW5ncy5zb3J0KCkuam9pbignXCI7IFwiJykgKyAnXCInO1xufVxuZXhwb3J0cy5qb2luU29ydGVkUXVvdGVkID0gam9pblNvcnRlZFF1b3RlZDtcbmZ1bmN0aW9uIGpvaW5EaXN0aW5jdChjYXRlZ29yeSwgcmVjb3Jkcykge1xuICAgIHZhciByZXMgPSByZWNvcmRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgb1JlY29yZCkge1xuICAgICAgICBwcmV2W29SZWNvcmRbY2F0ZWdvcnldXSA9IDE7XG4gICAgICAgIHJldHVybiBwcmV2O1xuICAgIH0sIHt9KTtcbiAgICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChPYmplY3Qua2V5cyhyZXMpKTtcbn1cbmV4cG9ydHMuam9pbkRpc3RpbmN0ID0gam9pbkRpc3RpbmN0O1xuZnVuY3Rpb24gZm9ybWF0RGlzdGluY3RGcm9tV2hhdElmUmVzdWx0KGFuc3dlcnMpIHtcbiAgICByZXR1cm4gam9pblNvcnRlZFF1b3RlZChhbnN3ZXJzLm1hcChmdW5jdGlvbiAob0Fuc3dlcikge1xuICAgICAgICByZXR1cm4gb0Fuc3dlci5yZXN1bHQ7XG4gICAgfSkpO1xufVxuZXhwb3J0cy5mb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQgPSBmb3JtYXREaXN0aW5jdEZyb21XaGF0SWZSZXN1bHQ7XG5mdW5jdGlvbiBqb2luUmVzdWx0cyhyZXN1bHRzKSB7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBjbnQgPSByZXN1bHRzLnJlZHVjZShmdW5jdGlvbiAocHJldiwgcmVzdWx0KSB7XG4gICAgICAgIGlmIChyZXN1bHQuX3JhbmtpbmcgPT09IHJlc3VsdHNbMF0uX3JhbmtpbmcpIHtcbiAgICAgICAgICAgIGlmIChyZXMuaW5kZXhPZihyZXN1bHQucmVzdWx0KSA8IDApIHtcbiAgICAgICAgICAgICAgICByZXMucHVzaChyZXN1bHQucmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmV2ICsgMTtcbiAgICAgICAgfVxuICAgIH0sIDApO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmpvaW5SZXN1bHRzID0gam9pblJlc3VsdHM7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
