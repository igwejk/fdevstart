/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var InputFilter = require('./inputFilter');
var debug = require('debug');
var debuglog = debug('whatis');
var Sentence = require('./sentence');
var Word = require('./word');
function cmpByResultThenRanking(a, b) {
    var cmp = a.result.localeCompare(b.result);
    if (cmp) {
        return cmp;
    }
    return -(a._ranking - b._ranking);
}
exports.cmpByResultThenRanking = cmpByResultThenRanking;
function cmpByRanking(a, b) {
    var cmp = -(a._ranking - b._ranking);
    if (cmp) {
        return cmp;
    }
    cmp = a.result.localeCompare(b.result);
    if (cmp) {
        return cmp;
    }
    // are records different?
    var res = Object.keys(a.result).sort().reduce(function (prev, sKey) {
        if (prev) {
            return prev;
        }
        if (b.result[sKey] !== a.result[sKey]) {
            if (!b.result[sKey]) {
                return -1;
            }
            if (!a.result[sKey]) {
                return +1;
            }
            return b.result[sKey].localeCompare(a.result[sKey]);
        }
        return 0;
    }, 0);
    return res;
}
exports.cmpByRanking = cmpByRanking;
function dumpNice(answer) {
    var result = {
        s: "",
        push: function push(s) {
            this.s = this.s + s;
        }
    };
    var s = "**Result for category: " + answer.category + " is " + answer.result + "\n rank: " + answer._ranking + "\n";
    result.push(s);
    Object.keys(answer.record).forEach(function (sRequires, index) {
        if (sRequires.charAt(0) !== '_') {
            result.push("record: " + sRequires + " -> " + answer.record[sRequires]);
        }
        result.push('\n');
    });
    var oSentence = answer.sentence;
    oSentence.forEach(function (oWord, index) {
        var sWord = "[" + index + "] : " + oWord.category + " \"" + oWord.string + "\" => \"" + oWord.matchedString + "\"";
        result.push(sWord + "\n");
    });
    result.push(".\n");
    return result.s;
}
exports.dumpNice = dumpNice;
function dumpWeightsTop(toolmatches, options) {
    var s = '';
    toolmatches.forEach(function (oMatch, index) {
        if (index < options.top) {
            s = s + "WhatIsAnswer[" + index + "]...\n";
            s = s + dumpNice(oMatch);
        }
    });
    return s;
}
exports.dumpWeightsTop = dumpWeightsTop;
function filterRetainTopRankedResult(res) {
    var result = res.filter(function (iRes, index) {
        debuglog(index + ' ' + JSON.stringify(iRes));
        if (iRes.result === (res[index - 1] && res[index - 1].result)) {
            debuglog('skip');
            return false;
        }
        return true;
    });
    result.sort(cmpByRanking);
    return result;
}
exports.filterRetainTopRankedResult = filterRetainTopRankedResult;
var Match = require('./match');
function calcRanking(matched, mismatched, relevantCount) {
    var lenMatched = Object.keys(matched).length;
    var factor = Match.calcRankingProduct(matched);
    factor *= Math.pow(1.5, lenMatched);
    var lenMisMatched = Object.keys(mismatched).length;
    var factor2 = Match.calcRankingProduct(mismatched);
    factor2 *= Math.pow(0.4, lenMisMatched);
    return Math.pow(factor2 * factor, 1 / (lenMisMatched + lenMatched));
}
exports.calcRanking = calcRanking;
function matchRecords(aSentences, category, records) {
    var relevantRecords = records.filter(function (record) {
        return !!record[category];
    });
    var res = [];
    relevantRecords.forEach(function (record) {
        aSentences.forEach(function (oSentence) {
            // count matches in record which are *not* the category
            var mismatched = {};
            var matched = {};
            aSentences.forEach(function (aSentence) {
                var mismatched = {};
                var matched = {};
                var cntRelevantWords = 0;
                aSentence.forEach(function (oWord) {
                    if (!Word.Word.isFiller(oWord)) {
                        cntRelevantWords = cntRelevantWords + 1;
                        if (oWord.category && record[oWord.category] !== undefined) {
                            if (oWord.matchedString === record[oWord.category]) {
                                matched[oWord.category] = oWord;
                            } else {
                                mismatched[oWord.category] = oWord;
                            }
                        }
                    }
                });
                if (Object.keys(matched).length > Object.keys(mismatched).length) {
                    res.push({
                        sentence: aSentence,
                        record: record,
                        category: category,
                        result: record[category],
                        _ranking: calcRanking(matched, mismatched, cntRelevantWords)
                    });
                }
            });
        });
    });
    res.sort(cmpByResultThenRanking);
    res = filterRetainTopRankedResult(res);
    return res;
}
exports.matchRecords = matchRecords;
function analyzeCategory(categoryword, aRules, wholesentence) {
    var cats = InputFilter.categorizeAWord(categoryword, aRules, wholesentence, {});
    // TODO qualify
    cats = cats.filter(function (cat) {
        return cat.category === 'category';
    });
    if (cats.length) {
        return cats[0].matchedString;
    }
}
exports.analyzeCategory = analyzeCategory;
// const result = WhatIs.resolveCategory(cat, a1.entity,
//   theModel.mRules, theModel.tools, theModel.records);
function resolveCategory(category, contextQueryString, aRules, records) {
    if (contextQueryString.length === 0) {
        return [];
    } else {
        var matched = InputFilter.analyzeString(contextQueryString, aRules);
        debuglog("After matched " + JSON.stringify(matched));
        var aSentences = InputFilter.expandMatchArr(matched);
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var aSentencesReinforced = InputFilter.reinForce(aSentences);
        //aSentences.map(function(oSentence) { return InputFilter.reinForce(oSentence); });
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var matchedAnswers = matchRecords(aSentences, category, records); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        debuglog(" matchedTools" + JSON.stringify(matchedAnswers, undefined, 2));
        return matchedAnswers;
    }
}
exports.resolveCategory = resolveCategory;
function isIndiscriminateResult(results) {
    var cnt = results.reduce(function (prev, result) {
        if (result._ranking === results[0]._ranking) {
            return prev + 1;
        }
    }, 0);
    if (cnt > 1) {
        // search for a discriminating category value
        var discriminating = Object.keys(results[0].record).reduce(function (prev, category) {
            if (category.charAt(0) !== '_' && category !== results[0].category && results[0].record[category] !== results[1].record[category]) {
                prev.push(category);
            }
            return prev;
        }, []);
        if (discriminating.length) {
            return "Many comparable results, perhaps you want to specify a discriminating " + discriminating.join(',');
        }
        return 'Your question does not have a specifci answer';
    }
    return undefined;
}
exports.isIndiscriminateResult = isIndiscriminateResult;
/**
 * TODO: rework this to work correctly with sets
 */
function isComplete(match) {
    // TODO -> analyze sets
    return match && match.rank > 0.6 && Object.keys(match.toolmatchresult.missing || {}).length === 0;
}
exports.isComplete = isComplete;
function getPrompt(match) {
    if (!match) {
        return;
    }
    if (match.rank > 0.6) {
        return undefined;
    }
    if (Object.keys(match.toolmatchresult.missing).length) {
        var missing = Object.keys(match.toolmatchresult.missing)[0];
        return {
            category: missing,
            text: 'Please provide a missing "' + missing + '"?'
        };
    }
    return undefined;
}
exports.getPrompt = getPrompt;
function setPrompt(match, prompt, response) {
    if (!match) {
        return;
    }
    if (response.toLowerCase() !== 'cancel' && response.toLowerCase() !== 'abort') {
        var u = {};
        u.category = prompt.category;
        u._ranking = 1.0;
        u.matchedString = response;
        /// TODO test whether this can be valid at all?
        match.toolmatchresult.required[prompt.category] = u;
        delete match.toolmatchresult.missing[prompt.category];
    }
}
exports.setPrompt = setPrompt;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC93aGF0aXMudHMiLCJtYXRjaC93aGF0aXMuanMiXSwibmFtZXMiOlsiSW5wdXRGaWx0ZXIiLCJyZXF1aXJlIiwiZGVidWciLCJkZWJ1Z2xvZyIsIlNlbnRlbmNlIiwiV29yZCIsImNtcEJ5UmVzdWx0VGhlblJhbmtpbmciLCJhIiwiYiIsImNtcCIsInJlc3VsdCIsImxvY2FsZUNvbXBhcmUiLCJfcmFua2luZyIsImV4cG9ydHMiLCJjbXBCeVJhbmtpbmciLCJyZXMiLCJPYmplY3QiLCJrZXlzIiwic29ydCIsInJlZHVjZSIsInByZXYiLCJzS2V5IiwiZHVtcE5pY2UiLCJhbnN3ZXIiLCJzIiwicHVzaCIsImNhdGVnb3J5IiwicmVjb3JkIiwiZm9yRWFjaCIsInNSZXF1aXJlcyIsImluZGV4IiwiY2hhckF0Iiwib1NlbnRlbmNlIiwic2VudGVuY2UiLCJvV29yZCIsInNXb3JkIiwic3RyaW5nIiwibWF0Y2hlZFN0cmluZyIsImR1bXBXZWlnaHRzVG9wIiwidG9vbG1hdGNoZXMiLCJvcHRpb25zIiwib01hdGNoIiwidG9wIiwiZmlsdGVyUmV0YWluVG9wUmFua2VkUmVzdWx0IiwiZmlsdGVyIiwiaVJlcyIsIkpTT04iLCJzdHJpbmdpZnkiLCJNYXRjaCIsImNhbGNSYW5raW5nIiwibWF0Y2hlZCIsIm1pc21hdGNoZWQiLCJyZWxldmFudENvdW50IiwibGVuTWF0Y2hlZCIsImxlbmd0aCIsImZhY3RvciIsImNhbGNSYW5raW5nUHJvZHVjdCIsIk1hdGgiLCJwb3ciLCJsZW5NaXNNYXRjaGVkIiwiZmFjdG9yMiIsIm1hdGNoUmVjb3JkcyIsImFTZW50ZW5jZXMiLCJyZWNvcmRzIiwicmVsZXZhbnRSZWNvcmRzIiwiYVNlbnRlbmNlIiwiY250UmVsZXZhbnRXb3JkcyIsImlzRmlsbGVyIiwidW5kZWZpbmVkIiwiYW5hbHl6ZUNhdGVnb3J5IiwiY2F0ZWdvcnl3b3JkIiwiYVJ1bGVzIiwid2hvbGVzZW50ZW5jZSIsImNhdHMiLCJjYXRlZ29yaXplQVdvcmQiLCJjYXQiLCJyZXNvbHZlQ2F0ZWdvcnkiLCJjb250ZXh0UXVlcnlTdHJpbmciLCJhbmFseXplU3RyaW5nIiwiZXhwYW5kTWF0Y2hBcnIiLCJtYXAiLCJyYW5raW5nUHJvZHVjdCIsImpvaW4iLCJhU2VudGVuY2VzUmVpbmZvcmNlZCIsInJlaW5Gb3JjZSIsIm1hdGNoZWRBbnN3ZXJzIiwiaXNJbmRpc2NyaW1pbmF0ZVJlc3VsdCIsInJlc3VsdHMiLCJjbnQiLCJkaXNjcmltaW5hdGluZyIsImlzQ29tcGxldGUiLCJtYXRjaCIsInJhbmsiLCJ0b29sbWF0Y2hyZXN1bHQiLCJtaXNzaW5nIiwiZ2V0UHJvbXB0IiwidGV4dCIsInNldFByb21wdCIsInByb21wdCIsInJlc3BvbnNlIiwidG9Mb3dlckNhc2UiLCJ1IiwicmVxdWlyZWQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUNNQTs7QURFQSxJQUFZQSxjQUFXQyxRQUFNLGVBQU4sQ0FBdkI7QUFFQSxJQUFZQyxRQUFLRCxRQUFNLE9BQU4sQ0FBakI7QUFFQSxJQUFNRSxXQUFXRCxNQUFNLFFBQU4sQ0FBakI7QUFRQSxJQUFZRSxXQUFRSCxRQUFNLFlBQU4sQ0FBcEI7QUFFQSxJQUFZSSxPQUFJSixRQUFNLFFBQU4sQ0FBaEI7QUFHQSxTQUFBSyxzQkFBQSxDQUF1Q0MsQ0FBdkMsRUFBZ0VDLENBQWhFLEVBQXVGO0FBQ3JGLFFBQUlDLE1BQU1GLEVBQUVHLE1BQUYsQ0FBU0MsYUFBVCxDQUF1QkgsRUFBRUUsTUFBekIsQ0FBVjtBQUNBLFFBQUlELEdBQUosRUFBUztBQUNQLGVBQU9BLEdBQVA7QUFDRDtBQUNELFdBQU8sRUFBRUYsRUFBRUssUUFBRixHQUFhSixFQUFFSSxRQUFqQixDQUFQO0FBQ0Q7QUFOZUMsUUFBQVAsc0JBQUEsR0FBc0JBLHNCQUF0QjtBQVNoQixTQUFBUSxZQUFBLENBQTZCUCxDQUE3QixFQUFzREMsQ0FBdEQsRUFBNkU7QUFDM0UsUUFBSUMsTUFBTSxFQUFFRixFQUFFSyxRQUFGLEdBQWFKLEVBQUVJLFFBQWpC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a0QyRSxDQUFsRDtBQUNBLGVBQU9WLE1BQU1FLGVBQU4sQ0FBc0JDLE9BQXRCLENBQThCSSxPQUFPeEUsUUFBckMsQ0FBUDtBQUNEO0FBQ0Y7QUFkZWIsUUFBQW9GLFNBQUEsR0FBU0EsU0FBVCIsImZpbGUiOiJtYXRjaC93aGF0aXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBhbmFseXplLnRzXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblxuXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlciBmcm9tICcuL2lucHV0RmlsdGVyJztcblxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCd3aGF0aXMnKTtcblxuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJztcblxuaW1wb3J0ICogYXMgVG9vbG1hdGNoZXIgZnJvbSAnLi90b29sbWF0Y2hlcic7XG5cbmltcG9ydCAqIGFzIFNlbnRlbmNlIGZyb20gJy4vc2VudGVuY2UnO1xuXG5pbXBvcnQgKiBhcyBXb3JkIGZyb20gJy4vd29yZCc7XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGNtcEJ5UmVzdWx0VGhlblJhbmtpbmcoYTogSU1hdGNoLklXaGF0SXNBbnN3ZXIsIGI6IElNYXRjaC5JV2hhdElzQW5zd2VyKSB7XG4gIHZhciBjbXAgPSBhLnJlc3VsdC5sb2NhbGVDb21wYXJlKGIucmVzdWx0KTtcbiAgaWYgKGNtcCkge1xuICAgIHJldHVybiBjbXA7XG4gIH1cbiAgcmV0dXJuIC0oYS5fcmFua2luZyAtIGIuX3JhbmtpbmcpO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBjbXBCeVJhbmtpbmcoYTogSU1hdGNoLklXaGF0SXNBbnN3ZXIsIGI6IElNYXRjaC5JV2hhdElzQW5zd2VyKSB7XG4gIHZhciBjbXAgPSAtKGEuX3JhbmtpbmcgLSBiLl9yYW5raW5nKTtcbiAgaWYgKGNtcCkge1xuICAgIHJldHVybiBjbXA7XG4gIH1cbiAgY21wID0gYS5yZXN1bHQubG9jYWxlQ29tcGFyZShiLnJlc3VsdCk7XG4gIGlmKGNtcCkge1xuICAgIHJldHVybiBjbXA7XG4gIH1cblxuICAvLyBhcmUgcmVjb3JkcyBkaWZmZXJlbnQ/XG4gIHZhciByZXMgPSBPYmplY3Qua2V5cyhhLnJlc3VsdCkuc29ydCgpLnJlZHVjZShmdW5jdGlvbihwcmV2LCBzS2V5KSB7XG4gICAgaWYocHJldikge1xuICAgICAgcmV0dXJuIHByZXY7XG4gICAgfVxuICAgIGlmKGIucmVzdWx0W3NLZXldICE9PSBhLnJlc3VsdFtzS2V5XSkge1xuICAgICAgaWYoIWIucmVzdWx0W3NLZXldKSB7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICAgIH1cbiAgICAgIGlmKCFhLnJlc3VsdFtzS2V5XSkge1xuICAgICAgICByZXR1cm4gKzE7XG4gICAgICB9XG4gICAgICByZXR1cm4gYi5yZXN1bHRbc0tleV0ubG9jYWxlQ29tcGFyZShhLnJlc3VsdFtzS2V5XSk7XG4gICAgfVxuICAgIHJldHVybiAwO1xuICB9LCAwKTtcbiAgcmV0dXJuIHJlcztcbn1cblxuXG5cbmV4cG9ydCBmdW5jdGlvbiBkdW1wTmljZShhbnN3ZXI6IElNYXRjaC5JV2hhdElzQW5zd2VyKSB7XG4gIHZhciByZXN1bHQgPSB7XG4gICAgczogXCJcIixcbiAgICBwdXNoOiBmdW5jdGlvbiAocykgeyB0aGlzLnMgPSB0aGlzLnMgKyBzOyB9XG4gIH07XG4gIHZhciBzID1cbiAgICBgKipSZXN1bHQgZm9yIGNhdGVnb3J5OiAke2Fuc3dlci5jYXRlZ29yeX0gaXMgJHthbnN3ZXIucmVzdWx0fVxuIHJhbms6ICR7YW5zd2VyLl9yYW5raW5nfVxuYDtcbiAgcmVzdWx0LnB1c2gocyk7XG4gIE9iamVjdC5rZXlzKGFuc3dlci5yZWNvcmQpLmZvckVhY2goZnVuY3Rpb24gKHNSZXF1aXJlcywgaW5kZXgpIHtcbiAgICBpZiAoc1JlcXVpcmVzLmNoYXJBdCgwKSAhPT0gJ18nKSB7XG4gICAgICByZXN1bHQucHVzaChgcmVjb3JkOiAke3NSZXF1aXJlc30gLT4gJHthbnN3ZXIucmVjb3JkW3NSZXF1aXJlc119YCk7XG4gICAgfVxuICAgIHJlc3VsdC5wdXNoKCdcXG4nKTtcbiAgfSk7XG4gIHZhciBvU2VudGVuY2UgPSBhbnN3ZXIuc2VudGVuY2U7XG4gIG9TZW50ZW5jZS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZCwgaW5kZXgpIHtcbiAgICB2YXIgc1dvcmQgPSBgWyR7aW5kZXh9XSA6ICR7b1dvcmQuY2F0ZWdvcnl9IFwiJHtvV29yZC5zdHJpbmd9XCIgPT4gXCIke29Xb3JkLm1hdGNoZWRTdHJpbmd9XCJgXG4gICAgcmVzdWx0LnB1c2goc1dvcmQgKyBcIlxcblwiKTtcbiAgfSlcbiAgcmVzdWx0LnB1c2goXCIuXFxuXCIpO1xuICByZXR1cm4gcmVzdWx0LnM7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGR1bXBXZWlnaHRzVG9wKHRvb2xtYXRjaGVzOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4sIG9wdGlvbnM6IGFueSkge1xuICB2YXIgcyA9ICcnO1xuICB0b29sbWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvTWF0Y2gsIGluZGV4KSB7XG4gICAgaWYgKGluZGV4IDwgb3B0aW9ucy50b3ApIHtcbiAgICAgIHMgPSBzICsgXCJXaGF0SXNBbnN3ZXJbXCIgKyBpbmRleCArIFwiXS4uLlxcblwiO1xuICAgICAgcyA9IHMgKyBkdW1wTmljZShvTWF0Y2gpO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmlsdGVyUmV0YWluVG9wUmFua2VkUmVzdWx0KHJlczogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+KTogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+IHtcbiAgdmFyIHJlc3VsdCA9IHJlcy5maWx0ZXIoZnVuY3Rpb24gKGlSZXMsIGluZGV4KSB7XG4gICAgZGVidWdsb2coaW5kZXggKyAnICcgKyBKU09OLnN0cmluZ2lmeShpUmVzKSk7XG4gICAgaWYgKGlSZXMucmVzdWx0ID09PSAocmVzW2luZGV4IC0gMV0gJiYgcmVzW2luZGV4IC0gMV0ucmVzdWx0KSkge1xuICAgICAgZGVidWdsb2coJ3NraXAnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0pO1xuICByZXN1bHQuc29ydChjbXBCeVJhbmtpbmcpO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG5pbXBvcnQgKiBhcyBNYXRjaCBmcm9tICcuL21hdGNoJztcblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGNSYW5raW5nKG1hdGNoZWQ6IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLklXb3JkIH0sXG4gIG1pc21hdGNoZWQ6IHsgW2tleTogc3RyaW5nXTogSU1hdGNoLklXb3JkIH0sIHJlbGV2YW50Q291bnQ6IG51bWJlcik6IG51bWJlciB7XG5cbiAgdmFyIGxlbk1hdGNoZWQgPSBPYmplY3Qua2V5cyhtYXRjaGVkKS5sZW5ndGg7XG4gIHZhciBmYWN0b3IgPSBNYXRjaC5jYWxjUmFua2luZ1Byb2R1Y3QobWF0Y2hlZCk7XG4gIGZhY3RvciAqPSBNYXRoLnBvdygxLjUsIGxlbk1hdGNoZWQpO1xuXG4gIHZhciBsZW5NaXNNYXRjaGVkID0gT2JqZWN0LmtleXMobWlzbWF0Y2hlZCkubGVuZ3RoO1xuICB2YXIgZmFjdG9yMiA9IE1hdGNoLmNhbGNSYW5raW5nUHJvZHVjdChtaXNtYXRjaGVkKTtcbiAgZmFjdG9yMiAqPSBNYXRoLnBvdygwLjQsIGxlbk1pc01hdGNoZWQpO1xuXG4gIHJldHVybiBNYXRoLnBvdyhmYWN0b3IyICogZmFjdG9yLCAxIC8gKGxlbk1pc01hdGNoZWQgKyBsZW5NYXRjaGVkKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXRjaFJlY29yZHMoYVNlbnRlbmNlczogQXJyYXk8SU1hdGNoLklTZW50ZW5jZT4sIGNhdGVnb3J5OiBzdHJpbmcsIHJlY29yZHM6IEFycmF5PElNYXRjaC5JUmVjb3JkPilcbiAgOiBBcnJheTxJTWF0Y2guSVdoYXRJc0Fuc3dlcj4ge1xuICB2YXIgcmVsZXZhbnRSZWNvcmRzID0gcmVjb3Jkcy5maWx0ZXIoZnVuY3Rpb24gKHJlY29yZDogSU1hdGNoLklSZWNvcmQpIHtcbiAgICByZXR1cm4gISFyZWNvcmRbY2F0ZWdvcnldO1xuICB9KTtcbiAgdmFyIHJlcyA9IFtdO1xuICByZWxldmFudFJlY29yZHMuZm9yRWFjaChmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgYVNlbnRlbmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIC8vIGNvdW50IG1hdGNoZXMgaW4gcmVjb3JkIHdoaWNoIGFyZSAqbm90KiB0aGUgY2F0ZWdvcnlcbiAgICAgIHZhciBtaXNtYXRjaGVkID0ge31cbiAgICAgIHZhciBtYXRjaGVkID0ge307XG4gICAgICBhU2VudGVuY2VzLmZvckVhY2goZnVuY3Rpb24gKGFTZW50ZW5jZSkge1xuICAgICAgICB2YXIgbWlzbWF0Y2hlZCA9IHt9O1xuICAgICAgICB2YXIgbWF0Y2hlZCA9IHt9O1xuICAgICAgICB2YXIgY250UmVsZXZhbnRXb3JkcyA9IDA7XG4gICAgICAgIGFTZW50ZW5jZS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZCkge1xuICAgICAgICAgIGlmICghV29yZC5Xb3JkLmlzRmlsbGVyKG9Xb3JkKSkge1xuICAgICAgICAgICAgY250UmVsZXZhbnRXb3JkcyA9IGNudFJlbGV2YW50V29yZHMgKyAxO1xuICAgICAgICAgICAgaWYgKG9Xb3JkLmNhdGVnb3J5ICYmIChyZWNvcmRbb1dvcmQuY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgICAgICAgIGlmIChvV29yZC5tYXRjaGVkU3RyaW5nID09PSByZWNvcmRbb1dvcmQuY2F0ZWdvcnldKSB7XG4gICAgICAgICAgICAgICAgbWF0Y2hlZFtvV29yZC5jYXRlZ29yeV0gPSBvV29yZDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBtaXNtYXRjaGVkW29Xb3JkLmNhdGVnb3J5XSA9IG9Xb3JkO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKG1hdGNoZWQpLmxlbmd0aCA+IE9iamVjdC5rZXlzKG1pc21hdGNoZWQpLmxlbmd0aCkge1xuICAgICAgICAgIHJlcy5wdXNoKHtcbiAgICAgICAgICAgIHNlbnRlbmNlOiBhU2VudGVuY2UsXG4gICAgICAgICAgICByZWNvcmQgOiByZWNvcmQsXG4gICAgICAgICAgICBjYXRlZ29yeSA6IGNhdGVnb3J5LFxuICAgICAgICAgICAgcmVzdWx0OiByZWNvcmRbY2F0ZWdvcnldLFxuICAgICAgICAgICAgX3Jhbmtpbmc6IGNhbGNSYW5raW5nKG1hdGNoZWQsIG1pc21hdGNoZWQsIGNudFJlbGV2YW50V29yZHMpXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSk7XG4gIH0pO1xuICByZXMuc29ydChjbXBCeVJlc3VsdFRoZW5SYW5raW5nKTtcbiAgcmVzID0gZmlsdGVyUmV0YWluVG9wUmFua2VkUmVzdWx0KHJlcyk7XG4gIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhbmFseXplQ2F0ZWdvcnkoY2F0ZWdvcnl3b3JkIDogc3RyaW5nICwgYVJ1bGVzOiBBcnJheTxJTWF0Y2gubVJ1bGU+LCB3aG9sZXNlbnRlbmNlOiBzdHJpbmcpOiBzdHJpbmcge1xuICB2YXIgY2F0cyA9IElucHV0RmlsdGVyLmNhdGVnb3JpemVBV29yZChjYXRlZ29yeXdvcmQsIGFSdWxlcywgd2hvbGVzZW50ZW5jZSwge30pO1xuICAvLyBUT0RPIHF1YWxpZnlcbiAgY2F0cyA9IGNhdHMuZmlsdGVyKGZ1bmN0aW9uKGNhdCkge1xuICAgIHJldHVybiBjYXQuY2F0ZWdvcnkgPT09ICdjYXRlZ29yeSc7XG4gIH0pXG4gIGlmIChjYXRzLmxlbmd0aCkge1xuICAgIHJldHVybiBjYXRzWzBdLm1hdGNoZWRTdHJpbmc7XG4gIH1cbn1cblxuLy8gY29uc3QgcmVzdWx0ID0gV2hhdElzLnJlc29sdmVDYXRlZ29yeShjYXQsIGExLmVudGl0eSxcbi8vICAgdGhlTW9kZWwubVJ1bGVzLCB0aGVNb2RlbC50b29scywgdGhlTW9kZWwucmVjb3Jkcyk7XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZywgY29udGV4dFF1ZXJ5U3RyaW5nOiBzdHJpbmcsXG4gIGFSdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgcmVjb3JkczogQXJyYXk8SU1hdGNoLklSZWNvcmQ+KTogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+IHtcbiAgaWYgKGNvbnRleHRRdWVyeVN0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH0gZWxzZSB7XG4gICAgdmFyIG1hdGNoZWQgPSBJbnB1dEZpbHRlci5hbmFseXplU3RyaW5nKGNvbnRleHRRdWVyeVN0cmluZywgYVJ1bGVzKTtcbiAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkKSk7XG4gICAgdmFyIGFTZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMpO1xuICAgIC8vYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24ob1NlbnRlbmNlKSB7IHJldHVybiBJbnB1dEZpbHRlci5yZWluRm9yY2Uob1NlbnRlbmNlKTsgfSk7XG4gICAgZGVidWdsb2coXCJhZnRlciByZWluZm9yY2VcIiArIGFTZW50ZW5jZXNSZWluZm9yY2VkLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICB2YXIgbWF0Y2hlZEFuc3dlcnMgPSBtYXRjaFJlY29yZHMoYVNlbnRlbmNlcywgY2F0ZWdvcnksIHJlY29yZHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkVG9vbHNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRBbnN3ZXJzLCB1bmRlZmluZWQsIDIpKTtcbiAgICByZXR1cm4gbWF0Y2hlZEFuc3dlcnM7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzSW5kaXNjcmltaW5hdGVSZXN1bHQocmVzdWx0czogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+KTogc3RyaW5nIHtcbiAgdmFyIGNudCA9IHJlc3VsdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCByZXN1bHQpIHtcbiAgICBpZiAocmVzdWx0Ll9yYW5raW5nID09PSByZXN1bHRzWzBdLl9yYW5raW5nKSB7XG4gICAgICByZXR1cm4gcHJldiArIDE7XG4gICAgfVxuICB9LCAwKTtcbiAgaWYgKGNudCA+IDEpIHtcbiAgICAvLyBzZWFyY2ggZm9yIGEgZGlzY3JpbWluYXRpbmcgY2F0ZWdvcnkgdmFsdWVcbiAgICB2YXIgZGlzY3JpbWluYXRpbmcgPSBPYmplY3Qua2V5cyhyZXN1bHRzWzBdLnJlY29yZCkucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCBjYXRlZ29yeSkge1xuICAgICAgaWYgKChjYXRlZ29yeS5jaGFyQXQoMCkgIT09ICdfJyAmJiBjYXRlZ29yeSAhPT0gcmVzdWx0c1swXS5jYXRlZ29yeSlcbiAgICAgICAgJiYgKHJlc3VsdHNbMF0ucmVjb3JkW2NhdGVnb3J5XSAhPT0gcmVzdWx0c1sxXS5yZWNvcmRbY2F0ZWdvcnldKSkge1xuICAgICAgICBwcmV2LnB1c2goY2F0ZWdvcnkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHByZXY7XG4gICAgfSwgW10pO1xuICAgIGlmIChkaXNjcmltaW5hdGluZy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBcIk1hbnkgY29tcGFyYWJsZSByZXN1bHRzLCBwZXJoYXBzIHlvdSB3YW50IHRvIHNwZWNpZnkgYSBkaXNjcmltaW5hdGluZyBcIiArIGRpc2NyaW1pbmF0aW5nLmpvaW4oJywnKTtcbiAgICB9XG4gICAgcmV0dXJuICdZb3VyIHF1ZXN0aW9uIGRvZXMgbm90IGhhdmUgYSBzcGVjaWZjaSBhbnN3ZXInO1xuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbi8qKlxuICogVE9ETzogcmV3b3JrIHRoaXMgdG8gd29yayBjb3JyZWN0bHkgd2l0aCBzZXRzXG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQ29tcGxldGUobWF0Y2g6IElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gIC8vIFRPRE8gLT4gYW5hbHl6ZSBzZXRzXG4gIHJldHVybiBtYXRjaCAmJiBtYXRjaC5yYW5rID4gMC42ICYmXG4gICAgT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcgfHwge30pLmxlbmd0aCA9PT0gMFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJvbXB0KG1hdGNoOiBJTWF0Y2guSVRvb2xNYXRjaCkge1xuICBpZiAoIW1hdGNoKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmIChtYXRjaC5yYW5rID4gMC42KSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBpZiAoT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpLmxlbmd0aCkge1xuICAgIHZhciBtaXNzaW5nID0gT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpWzBdO1xuICAgIHJldHVybiB7XG4gICAgICBjYXRlZ29yeTogbWlzc2luZyxcbiAgICAgIHRleHQ6ICdQbGVhc2UgcHJvdmlkZSBhIG1pc3NpbmcgXCInICsgbWlzc2luZyArICdcIj8nXG4gICAgfVxuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHNldFByb21wdChtYXRjaDogSU1hdGNoLklUb29sTWF0Y2gsIHByb21wdDogSU1hdGNoLklQcm9tcHQsXG4gIHJlc3BvbnNlOiBzdHJpbmcpIHtcbiAgaWYgKCFtYXRjaCkge1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAocmVzcG9uc2UudG9Mb3dlckNhc2UoKSAhPT0gJ2NhbmNlbCcgJiYgcmVzcG9uc2UudG9Mb3dlckNhc2UoKSAhPT0gJ2Fib3J0Jykge1xuICAgIHZhciB1ID0ge30gYXMgSU1hdGNoLklXb3JkO1xuICAgIHUuY2F0ZWdvcnkgPSBwcm9tcHQuY2F0ZWdvcnk7XG4gICAgdS5fcmFua2luZyA9IDEuMDtcbiAgICB1Lm1hdGNoZWRTdHJpbmcgPSByZXNwb25zZTtcbiAgICAvLy8gVE9ETyB0ZXN0IHdoZXRoZXIgdGhpcyBjYW4gYmUgdmFsaWQgYXQgYWxsP1xuICAgIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtwcm9tcHQuY2F0ZWdvcnldID0gdTtcbiAgICBkZWxldGUgbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmdbcHJvbXB0LmNhdGVnb3J5XTtcbiAgfVxufVxuXG5cbiIsIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgSW5wdXRGaWx0ZXIgPSByZXF1aXJlKCcuL2lucHV0RmlsdGVyJyk7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ3doYXRpcycpO1xudmFyIFNlbnRlbmNlID0gcmVxdWlyZSgnLi9zZW50ZW5jZScpO1xudmFyIFdvcmQgPSByZXF1aXJlKCcuL3dvcmQnKTtcbmZ1bmN0aW9uIGNtcEJ5UmVzdWx0VGhlblJhbmtpbmcoYSwgYikge1xuICAgIHZhciBjbXAgPSBhLnJlc3VsdC5sb2NhbGVDb21wYXJlKGIucmVzdWx0KTtcbiAgICBpZiAoY21wKSB7XG4gICAgICAgIHJldHVybiBjbXA7XG4gICAgfVxuICAgIHJldHVybiAtKGEuX3JhbmtpbmcgLSBiLl9yYW5raW5nKTtcbn1cbmV4cG9ydHMuY21wQnlSZXN1bHRUaGVuUmFua2luZyA9IGNtcEJ5UmVzdWx0VGhlblJhbmtpbmc7XG5mdW5jdGlvbiBjbXBCeVJhbmtpbmcoYSwgYikge1xuICAgIHZhciBjbXAgPSAtKGEuX3JhbmtpbmcgLSBiLl9yYW5raW5nKTtcbiAgICBpZiAoY21wKSB7XG4gICAgICAgIHJldHVybiBjbXA7XG4gICAgfVxuICAgIGNtcCA9IGEucmVzdWx0LmxvY2FsZUNvbXBhcmUoYi5yZXN1bHQpO1xuICAgIGlmIChjbXApIHtcbiAgICAgICAgcmV0dXJuIGNtcDtcbiAgICB9XG4gICAgLy8gYXJlIHJlY29yZHMgZGlmZmVyZW50P1xuICAgIHZhciByZXMgPSBPYmplY3Qua2V5cyhhLnJlc3VsdCkuc29ydCgpLnJlZHVjZShmdW5jdGlvbiAocHJldiwgc0tleSkge1xuICAgICAgICBpZiAocHJldikge1xuICAgICAgICAgICAgcmV0dXJuIHByZXY7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGIucmVzdWx0W3NLZXldICE9PSBhLnJlc3VsdFtzS2V5XSkge1xuICAgICAgICAgICAgaWYgKCFiLnJlc3VsdFtzS2V5XSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghYS5yZXN1bHRbc0tleV0pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKzE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYi5yZXN1bHRbc0tleV0ubG9jYWxlQ29tcGFyZShhLnJlc3VsdFtzS2V5XSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfSwgMCk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuY21wQnlSYW5raW5nID0gY21wQnlSYW5raW5nO1xuZnVuY3Rpb24gZHVtcE5pY2UoYW5zd2VyKSB7XG4gICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgICAgczogXCJcIixcbiAgICAgICAgcHVzaDogZnVuY3Rpb24gKHMpIHsgdGhpcy5zID0gdGhpcy5zICsgczsgfVxuICAgIH07XG4gICAgdmFyIHMgPSBcIioqUmVzdWx0IGZvciBjYXRlZ29yeTogXCIgKyBhbnN3ZXIuY2F0ZWdvcnkgKyBcIiBpcyBcIiArIGFuc3dlci5yZXN1bHQgKyBcIlxcbiByYW5rOiBcIiArIGFuc3dlci5fcmFua2luZyArIFwiXFxuXCI7XG4gICAgcmVzdWx0LnB1c2gocyk7XG4gICAgT2JqZWN0LmtleXMoYW5zd2VyLnJlY29yZCkuZm9yRWFjaChmdW5jdGlvbiAoc1JlcXVpcmVzLCBpbmRleCkge1xuICAgICAgICBpZiAoc1JlcXVpcmVzLmNoYXJBdCgwKSAhPT0gJ18nKSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaChcInJlY29yZDogXCIgKyBzUmVxdWlyZXMgKyBcIiAtPiBcIiArIGFuc3dlci5yZWNvcmRbc1JlcXVpcmVzXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgIH0pO1xuICAgIHZhciBvU2VudGVuY2UgPSBhbnN3ZXIuc2VudGVuY2U7XG4gICAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkLCBpbmRleCkge1xuICAgICAgICB2YXIgc1dvcmQgPSBcIltcIiArIGluZGV4ICsgXCJdIDogXCIgKyBvV29yZC5jYXRlZ29yeSArIFwiIFxcXCJcIiArIG9Xb3JkLnN0cmluZyArIFwiXFxcIiA9PiBcXFwiXCIgKyBvV29yZC5tYXRjaGVkU3RyaW5nICsgXCJcXFwiXCI7XG4gICAgICAgIHJlc3VsdC5wdXNoKHNXb3JkICsgXCJcXG5cIik7XG4gICAgfSk7XG4gICAgcmVzdWx0LnB1c2goXCIuXFxuXCIpO1xuICAgIHJldHVybiByZXN1bHQucztcbn1cbmV4cG9ydHMuZHVtcE5pY2UgPSBkdW1wTmljZTtcbmZ1bmN0aW9uIGR1bXBXZWlnaHRzVG9wKHRvb2xtYXRjaGVzLCBvcHRpb25zKSB7XG4gICAgdmFyIHMgPSAnJztcbiAgICB0b29sbWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvTWF0Y2gsIGluZGV4KSB7XG4gICAgICAgIGlmIChpbmRleCA8IG9wdGlvbnMudG9wKSB7XG4gICAgICAgICAgICBzID0gcyArIFwiV2hhdElzQW5zd2VyW1wiICsgaW5kZXggKyBcIl0uLi5cXG5cIjtcbiAgICAgICAgICAgIHMgPSBzICsgZHVtcE5pY2Uob01hdGNoKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBzO1xufVxuZXhwb3J0cy5kdW1wV2VpZ2h0c1RvcCA9IGR1bXBXZWlnaHRzVG9wO1xuZnVuY3Rpb24gZmlsdGVyUmV0YWluVG9wUmFua2VkUmVzdWx0KHJlcykge1xuICAgIHZhciByZXN1bHQgPSByZXMuZmlsdGVyKGZ1bmN0aW9uIChpUmVzLCBpbmRleCkge1xuICAgICAgICBkZWJ1Z2xvZyhpbmRleCArICcgJyArIEpTT04uc3RyaW5naWZ5KGlSZXMpKTtcbiAgICAgICAgaWYgKGlSZXMucmVzdWx0ID09PSAocmVzW2luZGV4IC0gMV0gJiYgcmVzW2luZGV4IC0gMV0ucmVzdWx0KSkge1xuICAgICAgICAgICAgZGVidWdsb2coJ3NraXAnKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgICByZXN1bHQuc29ydChjbXBCeVJhbmtpbmcpO1xuICAgIHJldHVybiByZXN1bHQ7XG59XG5leHBvcnRzLmZpbHRlclJldGFpblRvcFJhbmtlZFJlc3VsdCA9IGZpbHRlclJldGFpblRvcFJhbmtlZFJlc3VsdDtcbnZhciBNYXRjaCA9IHJlcXVpcmUoJy4vbWF0Y2gnKTtcbmZ1bmN0aW9uIGNhbGNSYW5raW5nKG1hdGNoZWQsIG1pc21hdGNoZWQsIHJlbGV2YW50Q291bnQpIHtcbiAgICB2YXIgbGVuTWF0Y2hlZCA9IE9iamVjdC5rZXlzKG1hdGNoZWQpLmxlbmd0aDtcbiAgICB2YXIgZmFjdG9yID0gTWF0Y2guY2FsY1JhbmtpbmdQcm9kdWN0KG1hdGNoZWQpO1xuICAgIGZhY3RvciAqPSBNYXRoLnBvdygxLjUsIGxlbk1hdGNoZWQpO1xuICAgIHZhciBsZW5NaXNNYXRjaGVkID0gT2JqZWN0LmtleXMobWlzbWF0Y2hlZCkubGVuZ3RoO1xuICAgIHZhciBmYWN0b3IyID0gTWF0Y2guY2FsY1JhbmtpbmdQcm9kdWN0KG1pc21hdGNoZWQpO1xuICAgIGZhY3RvcjIgKj0gTWF0aC5wb3coMC40LCBsZW5NaXNNYXRjaGVkKTtcbiAgICByZXR1cm4gTWF0aC5wb3coZmFjdG9yMiAqIGZhY3RvciwgMSAvIChsZW5NaXNNYXRjaGVkICsgbGVuTWF0Y2hlZCkpO1xufVxuZXhwb3J0cy5jYWxjUmFua2luZyA9IGNhbGNSYW5raW5nO1xuZnVuY3Rpb24gbWF0Y2hSZWNvcmRzKGFTZW50ZW5jZXMsIGNhdGVnb3J5LCByZWNvcmRzKSB7XG4gICAgdmFyIHJlbGV2YW50UmVjb3JkcyA9IHJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQpIHtcbiAgICAgICAgcmV0dXJuICEhcmVjb3JkW2NhdGVnb3J5XTtcbiAgICB9KTtcbiAgICB2YXIgcmVzID0gW107XG4gICAgcmVsZXZhbnRSZWNvcmRzLmZvckVhY2goZnVuY3Rpb24gKHJlY29yZCkge1xuICAgICAgICBhU2VudGVuY2VzLmZvckVhY2goZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgLy8gY291bnQgbWF0Y2hlcyBpbiByZWNvcmQgd2hpY2ggYXJlICpub3QqIHRoZSBjYXRlZ29yeVxuICAgICAgICAgICAgdmFyIG1pc21hdGNoZWQgPSB7fTtcbiAgICAgICAgICAgIHZhciBtYXRjaGVkID0ge307XG4gICAgICAgICAgICBhU2VudGVuY2VzLmZvckVhY2goZnVuY3Rpb24gKGFTZW50ZW5jZSkge1xuICAgICAgICAgICAgICAgIHZhciBtaXNtYXRjaGVkID0ge307XG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoZWQgPSB7fTtcbiAgICAgICAgICAgICAgICB2YXIgY250UmVsZXZhbnRXb3JkcyA9IDA7XG4gICAgICAgICAgICAgICAgYVNlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghV29yZC5Xb3JkLmlzRmlsbGVyKG9Xb3JkKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY250UmVsZXZhbnRXb3JkcyA9IGNudFJlbGV2YW50V29yZHMgKyAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9Xb3JkLmNhdGVnb3J5ICYmIChyZWNvcmRbb1dvcmQuY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9Xb3JkLm1hdGNoZWRTdHJpbmcgPT09IHJlY29yZFtvV29yZC5jYXRlZ29yeV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFtvV29yZC5jYXRlZ29yeV0gPSBvV29yZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pc21hdGNoZWRbb1dvcmQuY2F0ZWdvcnldID0gb1dvcmQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKG1hdGNoZWQpLmxlbmd0aCA+IE9iamVjdC5rZXlzKG1pc21hdGNoZWQpLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICByZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZW50ZW5jZTogYVNlbnRlbmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkOiByZWNvcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IHJlY29yZFtjYXRlZ29yeV0sXG4gICAgICAgICAgICAgICAgICAgICAgICBfcmFua2luZzogY2FsY1JhbmtpbmcobWF0Y2hlZCwgbWlzbWF0Y2hlZCwgY250UmVsZXZhbnRXb3JkcylcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJlcy5zb3J0KGNtcEJ5UmVzdWx0VGhlblJhbmtpbmcpO1xuICAgIHJlcyA9IGZpbHRlclJldGFpblRvcFJhbmtlZFJlc3VsdChyZXMpO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLm1hdGNoUmVjb3JkcyA9IG1hdGNoUmVjb3JkcztcbmZ1bmN0aW9uIGFuYWx5emVDYXRlZ29yeShjYXRlZ29yeXdvcmQsIGFSdWxlcywgd2hvbGVzZW50ZW5jZSkge1xuICAgIHZhciBjYXRzID0gSW5wdXRGaWx0ZXIuY2F0ZWdvcml6ZUFXb3JkKGNhdGVnb3J5d29yZCwgYVJ1bGVzLCB3aG9sZXNlbnRlbmNlLCB7fSk7XG4gICAgLy8gVE9ETyBxdWFsaWZ5XG4gICAgY2F0cyA9IGNhdHMuZmlsdGVyKGZ1bmN0aW9uIChjYXQpIHtcbiAgICAgICAgcmV0dXJuIGNhdC5jYXRlZ29yeSA9PT0gJ2NhdGVnb3J5JztcbiAgICB9KTtcbiAgICBpZiAoY2F0cy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGNhdHNbMF0ubWF0Y2hlZFN0cmluZztcbiAgICB9XG59XG5leHBvcnRzLmFuYWx5emVDYXRlZ29yeSA9IGFuYWx5emVDYXRlZ29yeTtcbi8vIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4vLyAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIHRoZU1vZGVsLnJlY29yZHMpO1xuZnVuY3Rpb24gcmVzb2x2ZUNhdGVnb3J5KGNhdGVnb3J5LCBjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcywgcmVjb3Jkcykge1xuICAgIGlmIChjb250ZXh0UXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhciBtYXRjaGVkID0gSW5wdXRGaWx0ZXIuYW5hbHl6ZVN0cmluZyhjb250ZXh0UXVlcnlTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWQpKTtcbiAgICAgICAgdmFyIGFTZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICAgICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMpO1xuICAgICAgICAvL2FTZW50ZW5jZXMubWFwKGZ1bmN0aW9uKG9TZW50ZW5jZSkgeyByZXR1cm4gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKG9TZW50ZW5jZSk7IH0pO1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgdmFyIG1hdGNoZWRBbnN3ZXJzID0gbWF0Y2hSZWNvcmRzKGFTZW50ZW5jZXMsIGNhdGVnb3J5LCByZWNvcmRzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWRUb29sc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZEFuc3dlcnMsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICByZXR1cm4gbWF0Y2hlZEFuc3dlcnM7XG4gICAgfVxufVxuZXhwb3J0cy5yZXNvbHZlQ2F0ZWdvcnkgPSByZXNvbHZlQ2F0ZWdvcnk7XG5mdW5jdGlvbiBpc0luZGlzY3JpbWluYXRlUmVzdWx0KHJlc3VsdHMpIHtcbiAgICB2YXIgY250ID0gcmVzdWx0cy5yZWR1Y2UoZnVuY3Rpb24gKHByZXYsIHJlc3VsdCkge1xuICAgICAgICBpZiAocmVzdWx0Ll9yYW5raW5nID09PSByZXN1bHRzWzBdLl9yYW5raW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gcHJldiArIDE7XG4gICAgICAgIH1cbiAgICB9LCAwKTtcbiAgICBpZiAoY250ID4gMSkge1xuICAgICAgICAvLyBzZWFyY2ggZm9yIGEgZGlzY3JpbWluYXRpbmcgY2F0ZWdvcnkgdmFsdWVcbiAgICAgICAgdmFyIGRpc2NyaW1pbmF0aW5nID0gT2JqZWN0LmtleXMocmVzdWx0c1swXS5yZWNvcmQpLnJlZHVjZShmdW5jdGlvbiAocHJldiwgY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgIGlmICgoY2F0ZWdvcnkuY2hhckF0KDApICE9PSAnXycgJiYgY2F0ZWdvcnkgIT09IHJlc3VsdHNbMF0uY2F0ZWdvcnkpXG4gICAgICAgICAgICAgICAgJiYgKHJlc3VsdHNbMF0ucmVjb3JkW2NhdGVnb3J5XSAhPT0gcmVzdWx0c1sxXS5yZWNvcmRbY2F0ZWdvcnldKSkge1xuICAgICAgICAgICAgICAgIHByZXYucHVzaChjYXRlZ29yeSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgICAgfSwgW10pO1xuICAgICAgICBpZiAoZGlzY3JpbWluYXRpbmcubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gXCJNYW55IGNvbXBhcmFibGUgcmVzdWx0cywgcGVyaGFwcyB5b3Ugd2FudCB0byBzcGVjaWZ5IGEgZGlzY3JpbWluYXRpbmcgXCIgKyBkaXNjcmltaW5hdGluZy5qb2luKCcsJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICdZb3VyIHF1ZXN0aW9uIGRvZXMgbm90IGhhdmUgYSBzcGVjaWZjaSBhbnN3ZXInO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5pc0luZGlzY3JpbWluYXRlUmVzdWx0ID0gaXNJbmRpc2NyaW1pbmF0ZVJlc3VsdDtcbi8qKlxuICogVE9ETzogcmV3b3JrIHRoaXMgdG8gd29yayBjb3JyZWN0bHkgd2l0aCBzZXRzXG4gKi9cbmZ1bmN0aW9uIGlzQ29tcGxldGUobWF0Y2gpIHtcbiAgICAvLyBUT0RPIC0+IGFuYWx5emUgc2V0c1xuICAgIHJldHVybiBtYXRjaCAmJiBtYXRjaC5yYW5rID4gMC42ICYmXG4gICAgICAgIE9iamVjdC5rZXlzKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nIHx8IHt9KS5sZW5ndGggPT09IDA7XG59XG5leHBvcnRzLmlzQ29tcGxldGUgPSBpc0NvbXBsZXRlO1xuZnVuY3Rpb24gZ2V0UHJvbXB0KG1hdGNoKSB7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChtYXRjaC5yYW5rID4gMC42KSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmIChPYmplY3Qua2V5cyhtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZykubGVuZ3RoKSB7XG4gICAgICAgIHZhciBtaXNzaW5nID0gT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpWzBdO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IG1pc3NpbmcsXG4gICAgICAgICAgICB0ZXh0OiAnUGxlYXNlIHByb3ZpZGUgYSBtaXNzaW5nIFwiJyArIG1pc3NpbmcgKyAnXCI/J1xuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5nZXRQcm9tcHQgPSBnZXRQcm9tcHQ7XG5mdW5jdGlvbiBzZXRQcm9tcHQobWF0Y2gsIHByb21wdCwgcmVzcG9uc2UpIHtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHJlc3BvbnNlLnRvTG93ZXJDYXNlKCkgIT09ICdjYW5jZWwnICYmIHJlc3BvbnNlLnRvTG93ZXJDYXNlKCkgIT09ICdhYm9ydCcpIHtcbiAgICAgICAgdmFyIHUgPSB7fTtcbiAgICAgICAgdS5jYXRlZ29yeSA9IHByb21wdC5jYXRlZ29yeTtcbiAgICAgICAgdS5fcmFua2luZyA9IDEuMDtcbiAgICAgICAgdS5tYXRjaGVkU3RyaW5nID0gcmVzcG9uc2U7XG4gICAgICAgIC8vLyBUT0RPIHRlc3Qgd2hldGhlciB0aGlzIGNhbiBiZSB2YWxpZCBhdCBhbGw/XG4gICAgICAgIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtwcm9tcHQuY2F0ZWdvcnldID0gdTtcbiAgICAgICAgZGVsZXRlIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nW3Byb21wdC5jYXRlZ29yeV07XG4gICAgfVxufVxuZXhwb3J0cy5zZXRQcm9tcHQgPSBzZXRQcm9tcHQ7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
