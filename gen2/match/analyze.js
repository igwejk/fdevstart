/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var InputFilter = require('./inputFilter');
var debug = require('debug');
var debuglog = debug('analyze');
var Toolmatcher = require('./toolmatcher');
var Sentence = require('./sentence');
function analyzeAll(sString, aRules, aTools) {
    if (sString.length === 0) {
        return [];
    } else {
        var matched = InputFilter.analyzeString(sString, aRules);
        debuglog("After matched " + JSON.stringify(matched));
        var aSentences = InputFilter.expandMatchArr(matched);
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var aSentencesReinforced = InputFilter.reinForce(aSentences);
        //aSentences.map(function(oSentence) { return InputFilter.reinForce(oSentence); });
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var matchedTools = Toolmatcher.matchTools(aSentences, aTools); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        debuglog(" matchedTools" + JSON.stringify(matchedTools, undefined, 2));
        return matchedTools;
    }
}
exports.analyzeAll = analyzeAll;
/**
 * TODO: rework this to work correctly with sets
 */
function isComplete(match) {
    // TODO -> analyze sets
    return match && match.rank > 0.6 && Object.keys(match.toolmatchresult.missing || {}).length === 0;
}
exports.isComplete = isComplete;
function getPrompt(match) {
    if (!match) {
        return;
    }
    if (match.rank < 0.6) {
        return undefined;
    }
    if (Object.keys(match.toolmatchresult.missing).length) {
        var missing = Object.keys(match.toolmatchresult.missing)[0];
        return {
            category: missing,
            text: 'Please provide a missing "' + missing + '"?'
        };
    }
    return undefined;
}
exports.getPrompt = getPrompt;
function setPrompt(match, prompt, response) {
    if (!match) {
        return;
    }
    if (response.toLowerCase() !== 'cancel' && response.toLowerCase() !== 'abort') {
        var u = {};
        u.category = prompt.category;
        u._ranking = 1.0;
        u.matchedString = response;
        /// TODO test whether this can be valid at all?
        match.toolmatchresult.required[prompt.category] = u;
        delete match.toolmatchresult.missing[prompt.category];
    }
}
exports.setPrompt = setPrompt;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9hbmFseXplLnRzIiwibWF0Y2gvYW5hbHl6ZS5qcyJdLCJuYW1lcyI6WyJJbnB1dEZpbHRlciIsInJlcXVpcmUiLCJkZWJ1ZyIsImRlYnVnbG9nIiwiVG9vbG1hdGNoZXIiLCJTZW50ZW5jZSIsImFuYWx5emVBbGwiLCJzU3RyaW5nIiwiYVJ1bGVzIiwiYVRvb2xzIiwibGVuZ3RoIiwibWF0Y2hlZCIsImFuYWx5emVTdHJpbmciLCJKU09OIiwic3RyaW5naWZ5IiwiYVNlbnRlbmNlcyIsImV4cGFuZE1hdGNoQXJyIiwibWFwIiwib1NlbnRlbmNlIiwicmFua2luZ1Byb2R1Y3QiLCJqb2luIiwiYVNlbnRlbmNlc1JlaW5mb3JjZWQiLCJyZWluRm9yY2UiLCJtYXRjaGVkVG9vbHMiLCJtYXRjaFRvb2xzIiwidW5kZWZpbmVkIiwiZXhwb3J0cyIsImlzQ29tcGxldGUiLCJtYXRjaCIsInJhbmsiLCJPYmplY3QiLCJrZXlzIiwidG9vbG1hdGNocmVzdWx0IiwibWlzc2luZyIsImdldFByb21wdCIsImNhdGVnb3J5IiwidGV4dCIsInNldFByb21wdCIsInByb21wdCIsInJlc3BvbnNlIiwidG9Mb3dlckNhc2UiLCJ1IiwiX3JhbmtpbmciLCJtYXRjaGVkU3RyaW5nIiwicmVxdWlyZWQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUNNQTs7QURFQSxJQUFZQSxjQUFXQyxRQUFNLGVBQU4sQ0FBdkI7QUFFQSxJQUFZQyxRQUFLRCxRQUFNLE9BQU4sQ0FBakI7QUFFQSxJQUFNRSxXQUFXRCxNQUFNLFNBQU4sQ0FBakI7QUFNQSxJQUFZRSxjQUFXSCxRQUFNLGVBQU4sQ0FBdkI7QUFFQSxJQUFZSSxXQUFRSixRQUFNLFlBQU4sQ0FBcEI7QUFFQSxTQUFBSyxVQUFBLENBQTJCQyxPQUEzQixFQUE0Q0MsTUFBNUMsRUFBeUVDLE1BQXpFLEVBQW9HO0FBQ2xHLFFBQUlGLFFBQVFHLE1BQVIsS0FBbUIsQ0FBdkIsRUFBMEI7QUFDeEIsZUFBTyxFQUFQ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T0FBT0gsUUFBckMsQ0FBUDtBQUNGO0FBQ0g7QUFkZVQsUUFBQVcsU0FBQSxHQUFTQSxTQUFUIiwiZmlsZSI6Im1hdGNoL2FuYWx5emUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBhbmFseXplLnRzXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblxuXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlciBmcm9tICcuL2lucHV0RmlsdGVyJztcblxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdhbmFseXplJyk7XG5cbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3V0aWxzL3V0aWxzJztcblxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XG5cbmltcG9ydCAqIGFzIFRvb2xtYXRjaGVyIGZyb20gJy4vdG9vbG1hdGNoZXInO1xuXG5pbXBvcnQgKiBhcyBTZW50ZW5jZSBmcm9tICcuL3NlbnRlbmNlJztcblxuZXhwb3J0IGZ1bmN0aW9uIGFuYWx5emVBbGwoc1N0cmluZzogc3RyaW5nLCBhUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4sIGFUb29sczogQXJyYXk8SU1hdGNoLklUb29sPikge1xuICBpZiAoc1N0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH0gZWxzZSB7XG4gICAgdmFyIG1hdGNoZWQgPSBJbnB1dEZpbHRlci5hbmFseXplU3RyaW5nKHNTdHJpbmcsIGFSdWxlcyk7XG4gICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZCkpO1xuICAgIHZhciBhU2VudGVuY2VzID0gSW5wdXRGaWx0ZXIuZXhwYW5kTWF0Y2hBcnIobWF0Y2hlZCk7XG4gICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IElucHV0RmlsdGVyLnJlaW5Gb3JjZShhU2VudGVuY2VzKTtcbiAgICAvL2FTZW50ZW5jZXMubWFwKGZ1bmN0aW9uKG9TZW50ZW5jZSkgeyByZXR1cm4gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKG9TZW50ZW5jZSk7IH0pO1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgfSkuam9pbihcIlxcblwiKSk7XG5cbiAgICB2YXIgbWF0Y2hlZFRvb2xzID0gVG9vbG1hdGNoZXIubWF0Y2hUb29scyhhU2VudGVuY2VzLCBhVG9vbHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkVG9vbHNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRUb29scywgdW5kZWZpbmVkLCAyKSk7XG4gICAgcmV0dXJuIG1hdGNoZWRUb29scztcbiAgfVxufVxuXG4vKipcbiAqIFRPRE86IHJld29yayB0aGlzIHRvIHdvcmsgY29ycmVjdGx5IHdpdGggc2V0c1xuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBpc0NvbXBsZXRlKG1hdGNoIDogIElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gIC8vIFRPRE8gLT4gYW5hbHl6ZSBzZXRzXG4gIHJldHVybiBtYXRjaCAmJiBtYXRjaC5yYW5rID4gMC42ICYmXG4gICAgT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcgfHx7fSkubGVuZ3RoID09PSAwXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQcm9tcHQobWF0Y2ggOiAgSU1hdGNoLklUb29sTWF0Y2gpIHtcbiAgaWYoIW1hdGNoKSB7XG4gICAgICByZXR1cm47XG4gIH1cbiAgaWYgKG1hdGNoLnJhbmsgPCAwLjYgKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBpZihPYmplY3Qua2V5cyhtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZykubGVuZ3RoICkge1xuICAgIHZhciBtaXNzaW5nID0gT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpWzBdO1xuICAgIHJldHVybiB7XG4gICAgICBjYXRlZ29yeSA6IG1pc3NpbmcsXG4gICAgICB0ZXh0IDogJ1BsZWFzZSBwcm92aWRlIGEgbWlzc2luZyBcIicgKyBtaXNzaW5nICsgJ1wiPydcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gc2V0UHJvbXB0KG1hdGNoIDogSU1hdGNoLklUb29sTWF0Y2gsIHByb21wdDogSU1hdGNoLklQcm9tcHQsXG4gIHJlc3BvbnNlIDogc3RyaW5nKSB7XG4gICAgaWYoIW1hdGNoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChyZXNwb25zZS50b0xvd2VyQ2FzZSgpICE9PSAnY2FuY2VsJyAmJiByZXNwb25zZS50b0xvd2VyQ2FzZSgpICE9PSAnYWJvcnQnKSB7XG4gICAgICB2YXIgdSA9IHt9IGFzIElNYXRjaC5JV29yZDtcbiAgICAgIHUuY2F0ZWdvcnkgPSBwcm9tcHQuY2F0ZWdvcnk7XG4gICAgICB1Ll9yYW5raW5nID0gMS4wO1xuICAgICAgdS5tYXRjaGVkU3RyaW5nID0gcmVzcG9uc2U7XG4gICAgICAvLy8gVE9ETyB0ZXN0IHdoZXRoZXIgdGhpcyBjYW4gYmUgdmFsaWQgYXQgYWxsP1xuICAgICAgbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3Byb21wdC5jYXRlZ29yeV0gPSB1O1xuICAgICAgZGVsZXRlIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nW3Byb21wdC5jYXRlZ29yeV07XG4gICB9XG59XG5cblxuIiwiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgYW5hbHl6ZS50c1xuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBJbnB1dEZpbHRlciA9IHJlcXVpcmUoJy4vaW5wdXRGaWx0ZXInKTtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnYW5hbHl6ZScpO1xudmFyIFRvb2xtYXRjaGVyID0gcmVxdWlyZSgnLi90b29sbWF0Y2hlcicpO1xudmFyIFNlbnRlbmNlID0gcmVxdWlyZSgnLi9zZW50ZW5jZScpO1xuZnVuY3Rpb24gYW5hbHl6ZUFsbChzU3RyaW5nLCBhUnVsZXMsIGFUb29scykge1xuICAgIGlmIChzU3RyaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICB2YXIgbWF0Y2hlZCA9IElucHV0RmlsdGVyLmFuYWx5emVTdHJpbmcoc1N0cmluZywgYVJ1bGVzKTtcbiAgICAgICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZCkpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlcyA9IElucHV0RmlsdGVyLmV4cGFuZE1hdGNoQXJyKG1hdGNoZWQpO1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgICAgIC8vYVNlbnRlbmNlcy5tYXAoZnVuY3Rpb24ob1NlbnRlbmNlKSB7IHJldHVybiBJbnB1dEZpbHRlci5yZWluRm9yY2Uob1NlbnRlbmNlKTsgfSk7XG4gICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICB2YXIgbWF0Y2hlZFRvb2xzID0gVG9vbG1hdGNoZXIubWF0Y2hUb29scyhhU2VudGVuY2VzLCBhVG9vbHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICAgICAgZGVidWdsb2coXCIgbWF0Y2hlZFRvb2xzXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaGVkVG9vbHMsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICByZXR1cm4gbWF0Y2hlZFRvb2xzO1xuICAgIH1cbn1cbmV4cG9ydHMuYW5hbHl6ZUFsbCA9IGFuYWx5emVBbGw7XG4vKipcbiAqIFRPRE86IHJld29yayB0aGlzIHRvIHdvcmsgY29ycmVjdGx5IHdpdGggc2V0c1xuICovXG5mdW5jdGlvbiBpc0NvbXBsZXRlKG1hdGNoKSB7XG4gICAgLy8gVE9ETyAtPiBhbmFseXplIHNldHNcbiAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2gucmFuayA+IDAuNiAmJlxuICAgICAgICBPYmplY3Qua2V5cyhtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZyB8fCB7fSkubGVuZ3RoID09PSAwO1xufVxuZXhwb3J0cy5pc0NvbXBsZXRlID0gaXNDb21wbGV0ZTtcbmZ1bmN0aW9uIGdldFByb21wdChtYXRjaCkge1xuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAobWF0Y2gucmFuayA8IDAuNikge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAoT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpLmxlbmd0aCkge1xuICAgICAgICB2YXIgbWlzc2luZyA9IE9iamVjdC5rZXlzKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nKVswXTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBtaXNzaW5nLFxuICAgICAgICAgICAgdGV4dDogJ1BsZWFzZSBwcm92aWRlIGEgbWlzc2luZyBcIicgKyBtaXNzaW5nICsgJ1wiPydcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cbmV4cG9ydHMuZ2V0UHJvbXB0ID0gZ2V0UHJvbXB0O1xuZnVuY3Rpb24gc2V0UHJvbXB0KG1hdGNoLCBwcm9tcHQsIHJlc3BvbnNlKSB7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChyZXNwb25zZS50b0xvd2VyQ2FzZSgpICE9PSAnY2FuY2VsJyAmJiByZXNwb25zZS50b0xvd2VyQ2FzZSgpICE9PSAnYWJvcnQnKSB7XG4gICAgICAgIHZhciB1ID0ge307XG4gICAgICAgIHUuY2F0ZWdvcnkgPSBwcm9tcHQuY2F0ZWdvcnk7XG4gICAgICAgIHUuX3JhbmtpbmcgPSAxLjA7XG4gICAgICAgIHUubWF0Y2hlZFN0cmluZyA9IHJlc3BvbnNlO1xuICAgICAgICAvLy8gVE9ETyB0ZXN0IHdoZXRoZXIgdGhpcyBjYW4gYmUgdmFsaWQgYXQgYWxsP1xuICAgICAgICBtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbcHJvbXB0LmNhdGVnb3J5XSA9IHU7XG4gICAgICAgIGRlbGV0ZSBtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZ1twcm9tcHQuY2F0ZWdvcnldO1xuICAgIH1cbn1cbmV4cG9ydHMuc2V0UHJvbXB0ID0gc2V0UHJvbXB0O1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
