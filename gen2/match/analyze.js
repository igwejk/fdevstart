/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var InputFilter = require('./inputFilter');
var debug = require('debug');
var debuglog = debug('analyze');
var Toolmatcher = require('./toolmatcher');
var Sentence = require('./sentence');
function analyzeAll(sString, aRules, aTools) {
    if (sString.length === 0) {
        return [];
    } else {
        var matched = InputFilter.analyzeString(sString, aRules);
        debuglog("After matched " + JSON.stringify(matched));
        var aSentences = InputFilter.expandMatchArr(matched);
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var aSentencesReinforced = InputFilter.reinForce(aSentences);
        //aSentences.map(function(oSentence) { return InputFilter.reinForce(oSentence); });
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        var matchedTools = Toolmatcher.matchTools(aSentences, aTools); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        debuglog(" matchedTools" + JSON.stringify(matchedTools, undefined, 2));
        return matchedTools;
    }
}
exports.analyzeAll = analyzeAll;
function isComplete(match) {
    return match && match.rank > 0.6 && Object.keys(match.toolmatchresult.missing || {}).length === 0;
}
exports.isComplete = isComplete;
function getPrompt(match) {
    if (!match) {
        return;
    }
    if (match.rank > 0.6) {
        return undefined;
    }
    if (Object.keys(match.toolmatchresult.missing).length) {
        var missing = Object.keys(match.toolmatchresult.missing)[0];
        return {
            category: missing,
            text: 'Please provide a missing "' + missing + '"?'
        };
    }
    return undefined;
}
exports.getPrompt = getPrompt;
function setPrompt(match, prompt, response) {
    if (!match) {
        return;
    }
    if (response.toLowerCase() !== 'cancel' && response.toLowerCase() !== 'abort') {
        var u = {};
        u.category = prompt.category;
        u._ranking = 1.0;
        u.matchedString = response;
        /// TODO test whether this can be valid at all?
        match.toolmatchresult.required[prompt.category] = u;
        delete match.toolmatchresult.missing[prompt.category];
    }
}
exports.setPrompt = setPrompt;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9hbmFseXplLnRzIiwibWF0Y2gvYW5hbHl6ZS5qcyJdLCJuYW1lcyI6WyJJbnB1dEZpbHRlciIsInJlcXVpcmUiLCJkZWJ1ZyIsImRlYnVnbG9nIiwiVG9vbG1hdGNoZXIiLCJTZW50ZW5jZSIsImFuYWx5emVBbGwiLCJzU3RyaW5nIiwiYVJ1bGVzIiwiYVRvb2xzIiwibGVuZ3RoIiwibWF0Y2hlZCIsImFuYWx5emVTdHJpbmciLCJKU09OIiwic3RyaW5naWZ5IiwiYVNlbnRlbmNlcyIsImV4cGFuZE1hdGNoQXJyIiwibWFwIiwib1NlbnRlbmNlIiwicmFua2luZ1Byb2R1Y3QiLCJqb2luIiwiYVNlbnRlbmNlc1JlaW5mb3JjZWQiLCJyZWluRm9yY2UiLCJtYXRjaGVkVG9vbHMiLCJtYXRjaFRvb2xzIiwidW5kZWZpbmVkIiwiZXhwb3J0cyIsImlzQ29tcGxldGUiLCJtYXRjaCIsInJhbmsiLCJPYmplY3QiLCJrZXlzIiwidG9vbG1hdGNocmVzdWx0IiwibWlzc2luZyIsImdldFByb21wdCIsImNhdGVnb3J5IiwidGV4dCIsInNldFByb21wdCIsInByb21wdCIsInJlc3BvbnNlIiwidG9Mb3dlckNhc2UiLCJ1IiwiX3JhbmtpbmciLCJtYXRjaGVkU3RyaW5nIiwicmVxdWlyZWQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUNNQTs7QURFQSxJQUFZQSxjQUFXQyxRQUFNLGVBQU4sQ0FBdkI7QUFFQSxJQUFZQyxRQUFLRCxRQUFNLE9BQU4sQ0FBakI7QUFFQSxJQUFNRSxXQUFXRCxNQUFNLFNBQU4sQ0FBakI7QUFNQSxJQUFZRSxjQUFXSCxRQUFNLGVBQU4sQ0FBdkI7QUFFQSxJQUFZSSxXQUFRSixRQUFNLFlBQU4sQ0FBcEI7QUFFQSxTQUFBSyxVQUFBLENBQTJCQyxPQUEzQixFQUE0Q0MsTUFBNUMsRUFBeUVDLE1BQXpFLEVBQW9HO0FBQ2xHLFFBQUlGLFFBQVFHLE1BQVIsS0FBbUIsQ0FBdkIsRUFBMEI7QUFDeEIsZUFBTyxFQUFQ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Q0FBUDtBQUNGO0FBQ0g7QUFkZVQsUUFBQVcsU0FBQSxHQUFTQSxTQUFUIiwiZmlsZSI6Im1hdGNoL2FuYWx5emUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBhbmFseXplLnRzXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblxuXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlciBmcm9tICcuL2lucHV0RmlsdGVyJztcblxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdhbmFseXplJyk7XG5cbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3V0aWxzL3V0aWxzJztcblxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XG5cbmltcG9ydCAqIGFzIFRvb2xtYXRjaGVyIGZyb20gJy4vdG9vbG1hdGNoZXInO1xuXG5pbXBvcnQgKiBhcyBTZW50ZW5jZSBmcm9tICcuL3NlbnRlbmNlJztcblxuZXhwb3J0IGZ1bmN0aW9uIGFuYWx5emVBbGwoc1N0cmluZzogc3RyaW5nLCBhUnVsZXM6IEFycmF5PElNYXRjaC5tUnVsZT4sIGFUb29sczogQXJyYXk8SU1hdGNoLklUb29sPikge1xuICBpZiAoc1N0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH0gZWxzZSB7XG4gICAgdmFyIG1hdGNoZWQgPSBJbnB1dEZpbHRlci5hbmFseXplU3RyaW5nKHNTdHJpbmcsIGFSdWxlcyk7XG4gICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZCkpO1xuICAgIHZhciBhU2VudGVuY2VzID0gSW5wdXRGaWx0ZXIuZXhwYW5kTWF0Y2hBcnIobWF0Y2hlZCk7XG4gICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIHZhciBhU2VudGVuY2VzUmVpbmZvcmNlZCA9IElucHV0RmlsdGVyLnJlaW5Gb3JjZShhU2VudGVuY2VzKTtcbiAgICAvL2FTZW50ZW5jZXMubWFwKGZ1bmN0aW9uKG9TZW50ZW5jZSkgeyByZXR1cm4gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKG9TZW50ZW5jZSk7IH0pO1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzUmVpbmZvcmNlZC5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgfSkuam9pbihcIlxcblwiKSk7XG5cbiAgICB2YXIgbWF0Y2hlZFRvb2xzID0gVG9vbG1hdGNoZXIubWF0Y2hUb29scyhhU2VudGVuY2VzLCBhVG9vbHMpOyAvL2FUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogYW55IC8qIG9iamVjdHN0cmVhbSovIHtcbiAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkVG9vbHNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRUb29scywgdW5kZWZpbmVkLCAyKSk7XG4gICAgcmV0dXJuIG1hdGNoZWRUb29scztcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNDb21wbGV0ZShtYXRjaCA6ICBJTWF0Y2guSVRvb2xNYXRjaCkge1xuICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2gucmFuayA+IDAuNiAmJlxuICAgIE9iamVjdC5rZXlzKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nIHx8e30pLmxlbmd0aCA9PT0gMFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJvbXB0KG1hdGNoIDogIElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gIGlmKCFtYXRjaCkge1xuICAgICAgcmV0dXJuO1xuICB9XG4gIGlmIChtYXRjaC5yYW5rID4gMC42ICkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgaWYoT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpLmxlbmd0aCApIHtcbiAgICB2YXIgbWlzc2luZyA9IE9iamVjdC5rZXlzKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nKVswXTtcbiAgICByZXR1cm4ge1xuICAgICAgY2F0ZWdvcnkgOiBtaXNzaW5nLFxuICAgICAgdGV4dCA6ICdQbGVhc2UgcHJvdmlkZSBhIG1pc3NpbmcgXCInICsgbWlzc2luZyArICdcIj8nXG4gICAgfVxuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHNldFByb21wdChtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoLCBwcm9tcHQ6IElNYXRjaC5JUHJvbXB0LFxuICByZXNwb25zZSA6IHN0cmluZykge1xuICAgIGlmKCFtYXRjaCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAocmVzcG9uc2UudG9Mb3dlckNhc2UoKSAhPT0gJ2NhbmNlbCcgJiYgcmVzcG9uc2UudG9Mb3dlckNhc2UoKSAhPT0gJ2Fib3J0Jykge1xuICAgICAgdmFyIHUgPSB7fSBhcyBJTWF0Y2guSVdvcmQ7XG4gICAgICB1LmNhdGVnb3J5ID0gcHJvbXB0LmNhdGVnb3J5O1xuICAgICAgdS5fcmFua2luZyA9IDEuMDtcbiAgICAgIHUubWF0Y2hlZFN0cmluZyA9IHJlc3BvbnNlO1xuICAgICAgLy8vIFRPRE8gdGVzdCB3aGV0aGVyIHRoaXMgY2FuIGJlIHZhbGlkIGF0IGFsbD9cbiAgICAgIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtwcm9tcHQuY2F0ZWdvcnldID0gdTtcbiAgICAgIGRlbGV0ZSBtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZ1twcm9tcHQuY2F0ZWdvcnldO1xuICAgfVxufVxuXG5cbiIsIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgSW5wdXRGaWx0ZXIgPSByZXF1aXJlKCcuL2lucHV0RmlsdGVyJyk7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2FuYWx5emUnKTtcbnZhciBUb29sbWF0Y2hlciA9IHJlcXVpcmUoJy4vdG9vbG1hdGNoZXInKTtcbnZhciBTZW50ZW5jZSA9IHJlcXVpcmUoJy4vc2VudGVuY2UnKTtcbmZ1bmN0aW9uIGFuYWx5emVBbGwoc1N0cmluZywgYVJ1bGVzLCBhVG9vbHMpIHtcbiAgICBpZiAoc1N0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdmFyIG1hdGNoZWQgPSBJbnB1dEZpbHRlci5hbmFseXplU3RyaW5nKHNTdHJpbmcsIGFSdWxlcyk7XG4gICAgICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWQpKTtcbiAgICAgICAgdmFyIGFTZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5leHBhbmRNYXRjaEFycihtYXRjaGVkKTtcbiAgICAgICAgZGVidWdsb2coXCJhZnRlciBleHBhbmRcIiArIGFTZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgdmFyIGFTZW50ZW5jZXNSZWluZm9yY2VkID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMpO1xuICAgICAgICAvL2FTZW50ZW5jZXMubWFwKGZ1bmN0aW9uKG9TZW50ZW5jZSkgeyByZXR1cm4gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKG9TZW50ZW5jZSk7IH0pO1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgdmFyIG1hdGNoZWRUb29scyA9IFRvb2xtYXRjaGVyLm1hdGNoVG9vbHMoYVNlbnRlbmNlcywgYVRvb2xzKTsgLy9hVG9vbDogQXJyYXk8SU1hdGNoLklUb29sPik6IGFueSAvKiBvYmplY3RzdHJlYW0qLyB7XG4gICAgICAgIGRlYnVnbG9nKFwiIG1hdGNoZWRUb29sc1wiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hlZFRvb2xzLCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoZWRUb29scztcbiAgICB9XG59XG5leHBvcnRzLmFuYWx5emVBbGwgPSBhbmFseXplQWxsO1xuZnVuY3Rpb24gaXNDb21wbGV0ZShtYXRjaCkge1xuICAgIHJldHVybiBtYXRjaCAmJiBtYXRjaC5yYW5rID4gMC42ICYmXG4gICAgICAgIE9iamVjdC5rZXlzKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nIHx8IHt9KS5sZW5ndGggPT09IDA7XG59XG5leHBvcnRzLmlzQ29tcGxldGUgPSBpc0NvbXBsZXRlO1xuZnVuY3Rpb24gZ2V0UHJvbXB0KG1hdGNoKSB7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChtYXRjaC5yYW5rID4gMC42KSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmIChPYmplY3Qua2V5cyhtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZykubGVuZ3RoKSB7XG4gICAgICAgIHZhciBtaXNzaW5nID0gT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpWzBdO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY2F0ZWdvcnk6IG1pc3NpbmcsXG4gICAgICAgICAgICB0ZXh0OiAnUGxlYXNlIHByb3ZpZGUgYSBtaXNzaW5nIFwiJyArIG1pc3NpbmcgKyAnXCI/J1xuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5nZXRQcm9tcHQgPSBnZXRQcm9tcHQ7XG5mdW5jdGlvbiBzZXRQcm9tcHQobWF0Y2gsIHByb21wdCwgcmVzcG9uc2UpIHtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHJlc3BvbnNlLnRvTG93ZXJDYXNlKCkgIT09ICdjYW5jZWwnICYmIHJlc3BvbnNlLnRvTG93ZXJDYXNlKCkgIT09ICdhYm9ydCcpIHtcbiAgICAgICAgdmFyIHUgPSB7fTtcbiAgICAgICAgdS5jYXRlZ29yeSA9IHByb21wdC5jYXRlZ29yeTtcbiAgICAgICAgdS5fcmFua2luZyA9IDEuMDtcbiAgICAgICAgdS5tYXRjaGVkU3RyaW5nID0gcmVzcG9uc2U7XG4gICAgICAgIC8vLyBUT0RPIHRlc3Qgd2hldGhlciB0aGlzIGNhbiBiZSB2YWxpZCBhdCBhbGw/XG4gICAgICAgIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtwcm9tcHQuY2F0ZWdvcnldID0gdTtcbiAgICAgICAgZGVsZXRlIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nW3Byb21wdC5jYXRlZ29yeV07XG4gICAgfVxufVxuZXhwb3J0cy5zZXRQcm9tcHQgPSBzZXRQcm9tcHQ7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
