/**
 *
 * @module jfseb.fdevstart.analyze
 * @file analyze.ts
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var InputFilter = require('./inputFilter');
var debug = require('debug');
var debuglog = debug('analyze');
var logger = require('../utils/logger');
var perf = logger.perf('analyze');
var Toolmatcher = require('./toolmatcher');
var Sentence = require('./sentence');
function analyzeAll(sString, aRules, aTools, words) {
    "use strict";

    if (sString.length === 0) {
        return [];
    } else {
        perf('analyzeString');
        //   InputFilter.resetCnt();
        var matched = InputFilter.analyzeString(sString, aRules, words);
        perf('analyzeString');
        //   InputFilter.dumpCnt();
        perf('expand');
        debuglog("After matched " + JSON.stringify(matched));
        var aSentences = InputFilter.expandMatchArr(matched);
        debuglog("after expand" + aSentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        perf('expand');
        var aSentencesReinforced = InputFilter.reinForce(aSentences);
        //aSentences.map(function(oSentence) { return InputFilter.reinForce(oSentence); });
        debuglog("after reinforce" + aSentencesReinforced.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
        perf('matchTools');
        var matchedTools = Toolmatcher.matchTools(aSentences, aTools); //aTool: Array<IMatch.ITool>): any /* objectstream*/ {
        perf('matchTools');
        debuglog(" matchedTools" + JSON.stringify(matchedTools, undefined, 2));
        return matchedTools;
    }
}
exports.analyzeAll = analyzeAll;
/**
 * TODO: rework this to work correctly with sets
 */
function isComplete(match) {
    // TODO -> analyze sets
    return match && match.rank > 0.6 && Object.keys(match.toolmatchresult.missing || {}).length === 0;
}
exports.isComplete = isComplete;
function getPrompt(match) {
    if (!match) {
        return;
    }
    if (match.rank < 0.6) {
        return undefined;
    }
    if (Object.keys(match.toolmatchresult.missing).length) {
        var missing = Object.keys(match.toolmatchresult.missing)[0];
        return {
            category: missing,
            text: 'Please provide a missing "' + missing + '"?'
        };
    }
    return undefined;
}
exports.getPrompt = getPrompt;
function setPrompt(match, prompt, response) {
    if (!match) {
        return;
    }
    if (response.toLowerCase() !== 'cancel' && response.toLowerCase() !== 'abort') {
        var u = {};
        u.category = prompt.category;
        u._ranking = 1.0;
        u.matchedString = response;
        /// TODO test whether this can be valid at all?
        match.toolmatchresult.required[prompt.category] = u;
        delete match.toolmatchresult.missing[prompt.category];
    }
}
exports.setPrompt = setPrompt;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9hbmFseXplLnRzIl0sIm5hbWVzIjpbIklucHV0RmlsdGVyIiwicmVxdWlyZSIsImRlYnVnIiwiZGVidWdsb2ciLCJsb2dnZXIiLCJwZXJmIiwiVG9vbG1hdGNoZXIiLCJTZW50ZW5jZSIsImFuYWx5emVBbGwiLCJzU3RyaW5nIiwiYVJ1bGVzIiwiYVRvb2xzIiwid29yZHMiLCJsZW5ndGgiLCJtYXRjaGVkIiwiYW5hbHl6ZVN0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJhU2VudGVuY2VzIiwiZXhwYW5kTWF0Y2hBcnIiLCJtYXAiLCJvU2VudGVuY2UiLCJyYW5raW5nUHJvZHVjdCIsImpvaW4iLCJhU2VudGVuY2VzUmVpbmZvcmNlZCIsInJlaW5Gb3JjZSIsIm1hdGNoZWRUb29scyIsIm1hdGNoVG9vbHMiLCJ1bmRlZmluZWQiLCJleHBvcnRzIiwiaXNDb21wbGV0ZSIsIm1hdGNoIiwicmFuayIsIk9iamVjdCIsImtleXMiLCJ0b29sbWF0Y2hyZXN1bHQiLCJtaXNzaW5nIiwiZ2V0UHJvbXB0IiwiY2F0ZWdvcnkiLCJ0ZXh0Iiwic2V0UHJvbXB0IiwicHJvbXB0IiwicmVzcG9uc2UiLCJ0b0xvd2VyQ2FzZSIsInUiLCJfcmFua2luZyIsIm1hdGNoZWRTdHJpbmciLCJyZXF1aXJlZCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQU9BOztBQUVBLElBQVlBLGNBQVdDLFFBQU0sZUFBTixDQUF2QjtBQUVBLElBQVlDLFFBQUtELFFBQU0sT0FBTixDQUFqQjtBQUVBLElBQU1FLFdBQVdELE1BQU0sU0FBTixDQUFqQjtBQUlBLElBQVlFLFNBQU1ILFFBQU0saUJBQU4sQ0FBbEI7QUFDQSxJQUFJSSxPQUFPRCxPQUFPQyxJQUFQLENBQVksU0FBWixDQUFYO0FBT0EsSUFBWUMsY0FBV0wsUUFBTSxlQUFOLENBQXZCO0FBRUEsSUFBWU0sV0FBUU4sUUFBTSxZQUFOLENBQXBCO0FBRUEsU0FBQU8sVUFBQSxDQUEyQkMsT0FBM0IsRUFBNEND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QStFO0FBQzdFLFlBQUlDLElBQUksRUFBUjtBQUNBQSxVQUFFTixRQUFGLEdBQWFHLE9BQU9ILFFBQXBCO0FBQ0FNLFVBQUVDLFFBQUYsR0FBYSxHQUFiO0FBQ0FELFVBQUVFLGFBQUYsR0FBa0JKLFFBQWxCO0FBQ0E7QUFDQVgsY0FBTUksZUFBTixDQUFzQlksUUFBdEIsQ0FBK0JOLE9BQU9ILFFBQXRDLElBQWtETSxDQUFsRDtBQUNBLGVBQU9iLE1BQU1JLGVBQU4sQ0FBc0JDLE9BQXRCLENBQThCSyxPQUFPSCxRQUFyQyxDQUFQO0FBQ0Y7QUFDSDtBQWRlVCxRQUFBVyxTQUFBLEdBQVNBLFNBQVQiLCJmaWxlIjoibWF0Y2gvYW5hbHl6ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGFuYWx5emUudHNcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXG5cInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXIgZnJvbSAnLi9pbnB1dEZpbHRlcic7XG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnYW5hbHl6ZScpO1xuXG5cblxuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG52YXIgcGVyZiA9IGxvZ2dlci5wZXJmKCdhbmFseXplJyk7XG5cblxuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJztcblxuaW1wb3J0ICogYXMgVG9vbG1hdGNoZXIgZnJvbSAnLi90b29sbWF0Y2hlcic7XG5cbmltcG9ydCAqIGFzIFNlbnRlbmNlIGZyb20gJy4vc2VudGVuY2UnO1xuXG5leHBvcnQgZnVuY3Rpb24gYW5hbHl6ZUFsbChzU3RyaW5nOiBzdHJpbmcsIGFSdWxlczogQXJyYXk8SU1hdGNoLm1SdWxlPiwgYVRvb2xzOiBBcnJheTxJTWF0Y2guSVRvb2w+LCB3b3Jkcz8gKSB7XG4gIFwidXNlIHN0cmljdFwiO1xuICBpZiAoc1N0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH0gZWxzZSB7XG4gICAgcGVyZignYW5hbHl6ZVN0cmluZycpO1xuIC8vICAgSW5wdXRGaWx0ZXIucmVzZXRDbnQoKTtcbiAgICB2YXIgbWF0Y2hlZCA9IElucHV0RmlsdGVyLmFuYWx5emVTdHJpbmcoc1N0cmluZywgYVJ1bGVzLCB3b3Jkcyk7XG4gICAgcGVyZignYW5hbHl6ZVN0cmluZycpO1xuIC8vICAgSW5wdXRGaWx0ZXIuZHVtcENudCgpO1xuICAgIHBlcmYoJ2V4cGFuZCcpO1xuICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWQpKTtcbiAgICB2YXIgYVNlbnRlbmNlcyA9IElucHV0RmlsdGVyLmV4cGFuZE1hdGNoQXJyKG1hdGNoZWQpO1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgZXhwYW5kXCIgKyBhU2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICBwZXJmKCdleHBhbmQnKTtcbiAgICB2YXIgYVNlbnRlbmNlc1JlaW5mb3JjZWQgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcyk7XG4gICAgLy9hU2VudGVuY2VzLm1hcChmdW5jdGlvbihvU2VudGVuY2UpIHsgcmV0dXJuIElucHV0RmlsdGVyLnJlaW5Gb3JjZShvU2VudGVuY2UpOyB9KTtcbiAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlc1JlaW5mb3JjZWQubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgcGVyZignbWF0Y2hUb29scycpO1xuICAgIHZhciBtYXRjaGVkVG9vbHMgPSBUb29sbWF0Y2hlci5tYXRjaFRvb2xzKGFTZW50ZW5jZXMsIGFUb29scyk7IC8vYVRvb2w6IEFycmF5PElNYXRjaC5JVG9vbD4pOiBhbnkgLyogb2JqZWN0c3RyZWFtKi8ge1xuICAgIHBlcmYoJ21hdGNoVG9vbHMnKTtcbiAgICBkZWJ1Z2xvZyhcIiBtYXRjaGVkVG9vbHNcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoZWRUb29scywgdW5kZWZpbmVkLCAyKSk7XG4gICAgcmV0dXJuIG1hdGNoZWRUb29scztcbiAgfVxufVxuXG4vKipcbiAqIFRPRE86IHJld29yayB0aGlzIHRvIHdvcmsgY29ycmVjdGx5IHdpdGggc2V0c1xuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBpc0NvbXBsZXRlKG1hdGNoIDogIElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gIC8vIFRPRE8gLT4gYW5hbHl6ZSBzZXRzXG4gIHJldHVybiBtYXRjaCAmJiBtYXRjaC5yYW5rID4gMC42ICYmXG4gICAgT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcgfHx7fSkubGVuZ3RoID09PSAwXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQcm9tcHQobWF0Y2ggOiAgSU1hdGNoLklUb29sTWF0Y2gpIHtcbiAgaWYoIW1hdGNoKSB7XG4gICAgICByZXR1cm47XG4gIH1cbiAgaWYgKG1hdGNoLnJhbmsgPCAwLjYgKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBpZihPYmplY3Qua2V5cyhtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZykubGVuZ3RoICkge1xuICAgIHZhciBtaXNzaW5nID0gT2JqZWN0LmtleXMobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm1pc3NpbmcpWzBdO1xuICAgIHJldHVybiB7XG4gICAgICBjYXRlZ29yeSA6IG1pc3NpbmcsXG4gICAgICB0ZXh0IDogJ1BsZWFzZSBwcm92aWRlIGEgbWlzc2luZyBcIicgKyBtaXNzaW5nICsgJ1wiPydcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gc2V0UHJvbXB0KG1hdGNoIDogSU1hdGNoLklUb29sTWF0Y2gsIHByb21wdDogSU1hdGNoLklQcm9tcHQsXG4gIHJlc3BvbnNlIDogc3RyaW5nKSB7XG4gICAgaWYoIW1hdGNoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChyZXNwb25zZS50b0xvd2VyQ2FzZSgpICE9PSAnY2FuY2VsJyAmJiByZXNwb25zZS50b0xvd2VyQ2FzZSgpICE9PSAnYWJvcnQnKSB7XG4gICAgICB2YXIgdSA9IHt9IGFzIElNYXRjaC5JV29yZDtcbiAgICAgIHUuY2F0ZWdvcnkgPSBwcm9tcHQuY2F0ZWdvcnk7XG4gICAgICB1Ll9yYW5raW5nID0gMS4wO1xuICAgICAgdS5tYXRjaGVkU3RyaW5nID0gcmVzcG9uc2U7XG4gICAgICAvLy8gVE9ETyB0ZXN0IHdoZXRoZXIgdGhpcyBjYW4gYmUgdmFsaWQgYXQgYWxsP1xuICAgICAgbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3Byb21wdC5jYXRlZ29yeV0gPSB1O1xuICAgICAgZGVsZXRlIG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nW3Byb21wdC5jYXRlZ29yeV07XG4gICB9XG59XG5cblxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
