/**
 *
 * @module jfseb.fdevstart.analyze
 * @file erbase
 * @copyright (c) 2016 Gerd Forstmann
 *
 * Basic domain based entity recognition
 */
"use strict";

var InputFilter = require("./inputFilter");
var debug = require("debug");
var debuglog = debug('erbase');
var debuglogV = debug('erbase');
var perflog = debug('perf');
var breakdown = require("./breakdown");
var ERError = require("./ererror");
var AnyObject = Object;
var utils = require("../utils/utils");
var Sentence = require("./sentence");
/**
 * Given a  string, break it down into components,
 * [['A', 'B'], ['A B']]
 *
 * then categorizeWords
 * returning
 *
 * [ [[ { category: 'systemId', word : 'A'},
 *      { category: 'otherthing', word : 'A'}
 *    ],
 *    // result of B
 *    [ { category: 'systemId', word : 'B'},
 *      { category: 'otherthing', word : 'A'}
 *      { category: 'anothertryp', word : 'B'}
 *    ]
 *   ],
 * ]]]
 *
 *
 *
 */
function tokenizeString(sString, rules, words) {
    var cnt = 0;
    var fac = 1;
    var tokens = breakdown.tokenizeString(sString);
    if (debuglog.enabled) {
        debuglog("here breakdown" + JSON.stringify(tokens));
    }
    //console.log(JSON.stringify(u));
    words = words || {};
    perflog('this many known words: ' + Object.keys(words).length);
    var res = [];
    var cntRec = {};
    var categorizedSentence = [];
    var hasRecombined = false;
    tokens.tokens.forEach(function (token, index) {
        var seenIt = InputFilter.categorizeAWordWithOffsets(token, rules, sString, words, cntRec);
        /* cannot have this, or need to add all fragment words "UI2 Integration"  if(seenIt.length === 0) {
              return false;
            }
        */
        hasRecombined = hasRecombined || !seenIt.every(function (res) {
            return !res.rule.range;
        });
        debuglog(" categorized " + token + "/" + index + " to " + JSON.stringify(seenIt));
        categorizedSentence[index] = seenIt;
        cnt = cnt + seenIt.length;
        fac = fac * seenIt.length;
    });
    // have seen the plain categorization,
    debuglog(" sentences " + tokens.tokens.length + " matches " + cnt + " fac: " + fac);
    if (debuglog.enabled && tokens.tokens.length) {
        debuglog("first match " + JSON.stringify(tokens, undefined, 2));
    }
    debuglog(debuglog.enabled ? " prior RangeRule " + JSON.stringify(categorizedSentence) + " " : '-');
    if (hasRecombined) {
        evaluateRangeRulesToPosition(tokens.tokens, tokens.fusable, categorizedSentence);
    }
    debuglog(debuglog.enabled ? " after RangeRule " + JSON.stringify(categorizedSentence) + " " : '-');
    perflog(" sentences " + tokens.tokens.length + " / " + res.length + " matches " + cnt + " fac: " + fac + " rec : " + JSON.stringify(cntRec, undefined, 2));
    return {
        fusable: tokens.fusable,
        tokens: tokens.tokens,
        categorizedWords: categorizedSentence
    };
}
exports.tokenizeString = tokenizeString;
function isSameRes(present, res) {
    if (!(present.rule.matchedString === res.rule.matchedString && present.rule.category === res.rule.category && present.span === res.span && present.rule.bitindex === res.rule.bitindex)) {
        return 0;
    }
    if (present._ranking < res._ranking) {
        return -1;
    }
    return +1;
}
exports.isSameRes = isSameRes;
function mergeIgnoreOrAppend(result, res) {
    var insertindex = -1;
    var foundNothing = result.every(function (present, index) {
        var r = isSameRes(present, res);
        if (r < 0) {
            //console.log("overwriting worse \n" + JSON.stringify(res) + '\n' + JSON.stringify(present)+ '\n');
            result[index] = res;
            return false;
        } else if (r > 0) {
            //console.log('skipping present');
            return false;
        }
        return true;
    });
    if (foundNothing) {
        //debulog('pushing');
        result.push(res);
    }
}
exports.mergeIgnoreOrAppend = mergeIgnoreOrAppend;
function evaluateRangeRulesToPosition(tokens, fusable, categorizedWords) {
    debuglog(debuglog.enabled ? "evaluateRangeRulesToPosition... " + JSON.stringify(categorizedWords) : '-');
    categorizedWords.forEach(function (wordlist, index) {
        wordlist.forEach(function (word) {
            if (word.rule.range) {
                //console.log(` got targetindex for RangeRules evaluation : ${targetIndex} ${index} ${fusable.join(" ")}`);
                var targetIndex = breakdown.isCombinableRangeReturnIndex(word.rule.range, fusable, index);
                //console.log(` got targetindex for RangeRules evaluation : ${targetIndex}`);
                if (targetIndex >= 0) {
                    var combinedWord = breakdown.combineTokens(word.rule.range, index, tokens);
                    debuglog(debuglog.enabled ? " test \"" + combinedWord + "\" against \"" + word.rule.range.rule.lowercaseword + "\" " + JSON.stringify(word.rule.range.rule) : '-');
                    var res = InputFilter.categorizeWordWithOffsetWithRankCutoffSingle(combinedWord, word.rule.range.rule);
                    debuglog(debuglog.enabled ? " got res : " + JSON.stringify(res) : '-');
                    if (res) {
                        res.span = word.rule.range.high - word.rule.range.low + 1;
                        categorizedWords[targetIndex] = categorizedWords[targetIndex].slice(0); // avoid invalidation of seenit
                        debuglog("pushed sth at " + targetIndex);
                        mergeIgnoreOrAppend(categorizedWords[targetIndex], res);
                    }
                }
            }
        });
    });
    // filter all range rules !
    categorizedWords.forEach(function (wordlist, index) {
        categorizedWords[index] = wordlist.filter(function (word) {
            return !word.rule.range;
        });
    });
}
exports.evaluateRangeRulesToPosition = evaluateRangeRulesToPosition;
var clone = utils.cloneDeep;
function copyVecMembers(u) {
    var i = 0;
    for (i = 0; i < u.length; ++i) {
        u[i] = clone(u[i]);
    }
    return u;
}
// we can replicate the tail or the head,
// we replicate the tail as it is smaller.
// [a,b,c ]
function isSpanVec(vec, index) {
    var effectivelen = vec.reduce(function (prev, mem) {
        return prev += mem.span ? mem.span : 1;
    }, 0);
    return effectivelen > index;
}
exports.isSpanVec = isSpanVec;
/**
 * expand an array [[a1,a2], [b1,b2],[c]]
 * into all combinations
 *
 *  if a1 has a span of three, the variations of the lower layer are skipped
 *
 * with the special property
 */
function expandTokenMatchesToSentences(tokens, tokenMatches) {
    var a = [];
    var wordMatches = [];
    debuglogV(debuglog.enabled ? JSON.stringify(tokenMatches) : '-');
    tokenMatches.forEach(function (aWordMatches, wordIndex) {
        wordMatches[wordIndex] = [];
        aWordMatches.forEach(function (oWordVariant, wordVariantIndex) {
            wordMatches[wordIndex][wordVariantIndex] = oWordVariant;
        });
    });
    debuglog(debuglog.enabled ? JSON.stringify(tokenMatches) : '-');
    var result = {
        errors: [],
        tokens: tokens,
        sentences: []
    };
    var nvecs = [];
    var res = [[]];
    // var nvecs = [];
    var rvec = [];
    for (var tokenIndex = 0; tokenIndex < tokenMatches.length; ++tokenIndex) {
        //vecs is the vector of all so far seen variants up to k length.
        var nextBase = [];
        //independent of existence of matches on level k, we retain all vectors which are covered by a span
        // we skip extending them below
        for (var u = 0; u < res.length; ++u) {
            if (isSpanVec(res[u], tokenIndex)) {
                nextBase.push(res[u]);
            }
        }
        var lenMatches = tokenMatches[tokenIndex].length;
        if (nextBase.length === 0 && lenMatches === 0) {
            // the word at index I cannot be understood
            //if (result.errors.length === 0) {
            result.errors.push(ERError.makeError_NO_KNOWN_WORD(tokenIndex, tokens));
        }
        for (var l = 0; l < lenMatches; ++l) {
            //debuglog("vecs now" + JSON.stringify(vecs));
            var nvecs = []; //vecs.slice(); // copy the vec[i] base vector;
            //debuglog("vecs copied now" + JSON.stringify(nvecs));
            for (var u = 0; u < res.length; ++u) {
                if (!isSpanVec(res[u], tokenIndex)) {
                    // for each so far constructed result (of length k) in res
                    nvecs.push(res[u].slice()); // make a copy of each vector
                    nvecs[nvecs.length - 1] = copyVecMembers(nvecs[nvecs.length - 1]);
                    // debuglog("copied vecs["+ u+"]" + JSON.stringify(vecs[u]));
                    nvecs[nvecs.length - 1].push(clone(tokenMatches[tokenIndex][l])); // push the lth variant
                }
            }
            //   debuglog(" at     " + k + ":" + l + " nextbase >" + JSON.stringify(nextBase))
            //   debuglog(" append " + k + ":" + l + " nvecs    >" + JSON.stringify(nvecs))
            nextBase = nextBase.concat(nvecs);
        } //constru
        //  debuglog("now at " + k + ":" + l + " >" + JSON.stringify(nextBase))
        res = nextBase;
    }
    debuglogV(debuglogV.enabled ? "APPENDING TO RES" + 0 + ":" + l + " >" + JSON.stringify(nextBase) : '-');
    result.sentences = res;
    return result;
}
exports.expandTokenMatchesToSentences = expandTokenMatchesToSentences;
function processString(query, rules, words) {
    words = words || {};
    var tokenStruct = tokenizeString(query, rules, words);
    evaluateRangeRulesToPosition(tokenStruct.tokens, tokenStruct.fusable, tokenStruct.categorizedWords);
    if (debuglog.enabled) {
        debuglog("After matched " + JSON.stringify(tokenStruct.categorizedWords));
    }
    var aSentences = expandTokenMatchesToSentences(tokenStruct.tokens, tokenStruct.categorizedWords);
    if (debuglog.enabled) {
        debuglog("after expand" + aSentences.sentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + Sentence.dumpNice(oSentence); //JSON.stringify(oSentence);
        }).join("\n"));
    }
    aSentences.sentences = InputFilter.reinForce(aSentences.sentences);
    if (debuglog.enabled) {
        debuglog("after reinforce" + aSentences.sentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    return aSentences;
}
exports.processString = processString;
function simplifySentence(res) {
    return res.map(function (r) {
        return r.map(function (word) {
            return word.string + '=>' + word.matchedString + '/' + word.category + (word.span ? '/' + word.span : '');
        });
    });
}
exports.simplifySentence = simplifySentence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9lcmJhc2UudHMiLCJtYXRjaC9lcmJhc2UuanMiXSwibmFtZXMiOlsiSW5wdXRGaWx0ZXIiLCJyZXF1aXJlIiwiZGVidWciLCJkZWJ1Z2xvZyIsImRlYnVnbG9nViIsInBlcmZsb2ciLCJicmVha2Rvd24iLCJFUkVycm9yIiwiQW55T2JqZWN0IiwiT2JqZWN0IiwidXRpbHMiLCJTZW50ZW5jZSIsInRva2VuaXplU3RyaW5nIiwic1N0cmluZyIsInJ1bGVzIiwid29yZHMiLCJjbnQiLCJmYWMiLCJ0b2tlbnMiLCJlbmFibGVkIiwiSlNPTiIsInN0cmluZ2lmeSIsImtleXMiLCJsZW5ndGgiLCJyZXMiLCJjbnRSZWMiLCJjYXRlZ29yaXplZFNlbnRlbmNlIiwiaGFzUmVjb21iaW5lZCIsImZvckVhY2giLCJ0b2tlbiIsImluZGV4Iiwic2Vlbkl0IiwiY2F0ZWdvcml6ZUFXb3JkV2l0aE9mZnNldHMiLCJldmVyeSIsInJ1bGUiLCJyYW5nZSIsInVuZGVmaW5lZCIsImV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24iLCJmdXNhYmxlIiwiY2F0ZWdvcml6ZWRXb3JkcyIsImV4cG9ydHMiLCJpc1NhbWVSZXMiLCJwcmVzZW50IiwibWF0Y2hlZFN0cmluZyIsImNhdGVnb3J5Iiwic3BhbiIsImJpdGluZGV4IiwiX3JhbmtpbmciLCJtZXJnZUlnbm9yZU9yQXBwZW5kIiwicmVzdWx0IiwiaW5zZXJ0aW5kZXgiLCJmb3VuZE5vdGhpbmciLCJyIiwicHVzaCIsIndvcmRsaXN0Iiwid29yZCIsInRhcmdldEluZGV4IiwiaXNDb21iaW5hYmxlUmFuZ2VSZXR1cm5JbmRleCIsImNvbWJpbmVkV29yZCIsImNvbWJpbmVUb2tlbnMiLCJsb3dlcmNhc2V3b3JkIiwiY2F0ZWdvcml6ZVdvcmRXaXRoT2Zmc2V0V2l0aFJhbmtDdXRvZmZTaW5nbGUiLCJoaWdoIiwibG93Iiwic2xpY2UiLCJmaWx0ZXIiLCJjbG9uZSIsImNsb25lRGVlcCIsImNvcHlWZWNNZW1iZXJzIiwidSIsImkiLCJpc1NwYW5WZWMiLCJ2ZWMiLCJlZmZlY3RpdmVsZW4iLCJyZWR1Y2UiLCJwcmV2IiwibWVtIiwiZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXMiLCJ0b2tlbk1hdGNoZXMiLCJhIiwid29yZE1hdGNoZXMiLCJhV29yZE1hdGNoZXMiLCJ3b3JkSW5kZXgiLCJvV29yZFZhcmlhbnQiLCJ3b3JkVmFyaWFudEluZGV4IiwiZXJyb3JzIiwic2VudGVuY2VzIiwibnZlY3MiLCJydmVjIiwidG9rZW5JbmRleCIsIm5leHRCYXNlIiwibGVuTWF0Y2hlcyIsIm1ha2VFcnJvcl9OT19LTk9XTl9XT1JEIiwibCIsImNvbmNhdCIsInByb2Nlc3NTdHJpbmciLCJxdWVyeSIsInRva2VuU3RydWN0IiwiYVNlbnRlbmNlcyIsIm1hcCIsIm9TZW50ZW5jZSIsInJhbmtpbmdQcm9kdWN0IiwiZHVtcE5pY2UiLCJqb2luIiwicmVpbkZvcmNlIiwic2ltcGxpZnlTZW50ZW5jZSIsInN0cmluZyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0FDUUE7O0FERUEsSUFBQUEsY0FBQUMsUUFBQSxlQUFBLENBQUE7QUFFQSxJQUFBQyxRQUFBRCxRQUFBLE9BQUEsQ0FBQTtBQUVBLElBQU1FLFdBQVdELE1BQU0sUUFBTixDQUFqQjtBQUNBLElBQU1FLFlBQVlGLE1BQU0sUUFBTixDQUFsQjtBQUNBLElBQU1HLFVBQVVILE1BQU0sTUFBTixDQUFoQjtBQUVBLElBQUFJLFlBQUFMLFFBQUEsYUFBQSxDQUFBO0FBQ0EsSUFBQU0sVUFBQU4sUUFBQSxXQUFBLENBQUE7QUFFQSxJQUFNTyxZQUFpQkMsTUFBdkI7QUFNQSxJQUFBQyxRQUFBVCxRQUFBLGdCQUFBLENBQUE7QUFNQSxJQUFBVSxXQUFBVixRQUFBLFlBQUEsQ0FBQTtBQWlDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBcUJBLFNBQUFXLGNBQUEsQ0FBK0JDLE9BQS9CLEVBQWdEQyxLQUFoRCxFQUNFQyxLQURGLEVBQzREO0FBRTFELFFBQUlDLE1B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LFlBQVl3RyxTQUFaLENBQXNCTixXQUFXWixTQUFqQyxDQUF2QjtBQUNBLFFBQUluRixTQUFTZ0IsT0FBYixFQUFzQjtBQUNwQmhCLGlCQUFTLG9CQUFvQitGLFdBQVdaLFNBQVgsQ0FBcUJhLEdBQXJCLENBQXlCLFVBQVVDLFNBQVYsRUFBbUI7QUFDdkUsbUJBQU96RixTQUFTMEYsY0FBVCxDQUF3QkQsU0FBeEIsSUFBcUMsR0FBckMsR0FBMkNoRixLQUFLQyxTQUFMLENBQWUrRSxTQUFmLENBQWxEO0FBQ0QsU0FGNEIsRUFFMUJHLElBRjBCLENBRXJCLElBRnFCLENBQTdCO0FBR0Q7QUFDRCxXQUFPTCxVQUFQO0FBQ0Q7QUF2QkQxRCxRQUFBdUQsYUFBQSxHQUFBQSxhQUFBO0FBeUJBLFNBQUFVLGdCQUFBLENBQWlDakYsR0FBakMsRUFBb0M7QUFDbEMsV0FBT0EsSUFBSTJFLEdBQUosQ0FBUSxVQUFVL0MsQ0FBVixFQUFXO0FBQ3hCLGVBQU9BLEVBQUUrQyxHQUFGLENBQU0sVUFBQTVDLElBQUEsRUFBSTtBQUFNLG1CQUFPQSxLQUFLbUQsTUFBTCxHQUFjLElBQWQsR0FBcUJuRCxLQUFLWixhQUExQixHQUEwQyxHQUExQyxHQUFnRFksS0FBS1gsUUFBckQsSUFBaUVXLEtBQUtWLElBQUwsR0FBWSxNQUFNVSxLQUFLVixJQUF2QixHQUE4QixFQUEvRixDQUFQO0FBQTJHLFNBQTNILENBQVA7QUFDRCxLQUZNLENBQVA7QUFHRDtBQUpETCxRQUFBaUUsZ0JBQUEsR0FBQUEsZ0JBQUEiLCJmaWxlIjoibWF0Y2gvZXJiYXNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgZXJiYXNlXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKlxuICogQmFzaWMgZG9tYWluIGJhc2VkIGVudGl0eSByZWNvZ25pdGlvblxuICovXG5cblxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXIgZnJvbSAnLi9pbnB1dEZpbHRlcic7XG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnZXJiYXNlJyk7XG5jb25zdCBkZWJ1Z2xvZ1YgPSBkZWJ1ZygnZXJiYXNlJyk7XG5jb25zdCBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcblxuaW1wb3J0ICogYXMgYnJlYWtkb3duIGZyb20gJy4vYnJlYWtkb3duJztcbmltcG9ydCAqIGFzIEVSRXJyb3IgZnJvbSAnLi9lcmVycm9yJztcblxuY29uc3QgQW55T2JqZWN0ID0gPGFueT5PYmplY3Q7XG5cblxuXG5cblxuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJztcblxuaW1wb3J0ICogYXMgVG9vbG1hdGNoZXIgZnJvbSAnLi90b29sbWF0Y2hlcic7XG5cbmltcG9ydCAqIGFzIFNlbnRlbmNlIGZyb20gJy4vc2VudGVuY2UnO1xuXG5pbXBvcnQgKiBhcyBXb3JkIGZyb20gJy4vd29yZCc7XG5cbmltcG9ydCAqIGFzIEFsZ29sIGZyb20gJy4vYWxnb2wnO1xuXG5cbmltcG9ydCAqIGFzIE1hdGNoIGZyb20gJy4vbWF0Y2gnO1xuXG5cbmludGVyZmFjZSBJVG9rZW5pemVkU3RyaW5nIHtcbiAgdG9rZW5zOiBzdHJpbmdbXSxcbiAgY2F0ZWdvcml6ZWRXb3JkczogSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZFtdW11cbiAgZnVzYWJsZTogYm9vbGVhbltdO1xufVxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuLyoqXG4gKiBHaXZlbiBhICBzdHJpbmcsIGJyZWFrIGl0IGRvd24gaW50byBjb21wb25lbnRzLFxuICogW1snQScsICdCJ10sIFsnQSBCJ11dXG4gKlxuICogdGhlbiBjYXRlZ29yaXplV29yZHNcbiAqIHJldHVybmluZ1xuICpcbiAqIFsgW1sgeyBjYXRlZ29yeTogJ3N5c3RlbUlkJywgd29yZCA6ICdBJ30sXG4gKiAgICAgIHsgY2F0ZWdvcnk6ICdvdGhlcnRoaW5nJywgd29yZCA6ICdBJ31cbiAqICAgIF0sXG4gKiAgICAvLyByZXN1bHQgb2YgQlxuICogICAgWyB7IGNhdGVnb3J5OiAnc3lzdGVtSWQnLCB3b3JkIDogJ0InfSxcbiAqICAgICAgeyBjYXRlZ29yeTogJ290aGVydGhpbmcnLCB3b3JkIDogJ0EnfVxuICogICAgICB7IGNhdGVnb3J5OiAnYW5vdGhlcnRyeXAnLCB3b3JkIDogJ0InfVxuICogICAgXVxuICogICBdLFxuICogXV1dXG4gKlxuICpcbiAqXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0b2tlbml6ZVN0cmluZyhzU3RyaW5nOiBzdHJpbmcsIHJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcyxcbiAgd29yZHM6IHsgW2tleTogc3RyaW5nXTogQXJyYXk8SU1hdGNoLklDYXRlZ29yaXplZFN0cmluZz4gfSlcbiAgOiBJVG9rZW5pemVkU3RyaW5nIHtcbiAgdmFyIGNudCA9IDA7XG4gIHZhciBmYWMgPSAxO1xuICB2YXIgdG9rZW5zID0gYnJlYWtkb3duLnRva2VuaXplU3RyaW5nKHNTdHJpbmcpO1xuICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgIGRlYnVnbG9nKFwiaGVyZSBicmVha2Rvd25cIiArIEpTT04uc3RyaW5naWZ5KHRva2VucykpO1xuICB9XG4gIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkodSkpO1xuICB3b3JkcyA9IHdvcmRzIHx8IHt9O1xuICBwZXJmbG9nKCd0aGlzIG1hbnkga25vd24gd29yZHM6ICcgKyBPYmplY3Qua2V5cyh3b3JkcykubGVuZ3RoKTtcbiAgdmFyIHJlcyA9IFtdIGFzIElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWRbXVtdO1xuICB2YXIgY250UmVjID0ge307XG4gIHZhciBjYXRlZ29yaXplZFNlbnRlbmNlID0gW10gYXMgSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZFtdW107XG4gIHZhciBoYXNSZWNvbWJpbmVkID0gZmFsc2U7XG4gIHRva2Vucy50b2tlbnMuZm9yRWFjaChmdW5jdGlvbiAodG9rZW4sIGluZGV4KSB7XG4gICAgdmFyIHNlZW5JdCA9IElucHV0RmlsdGVyLmNhdGVnb3JpemVBV29yZFdpdGhPZmZzZXRzKHRva2VuLCBydWxlcywgc1N0cmluZywgd29yZHMsIGNudFJlYyk7XG4gICAgLyogY2Fubm90IGhhdmUgdGhpcywgb3IgbmVlZCB0byBhZGQgYWxsIGZyYWdtZW50IHdvcmRzIFwiVUkyIEludGVncmF0aW9uXCIgIGlmKHNlZW5JdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAqL1xuICAgIGhhc1JlY29tYmluZWQgPSBoYXNSZWNvbWJpbmVkIHx8ICFzZWVuSXQuZXZlcnkocmVzID0+ICFyZXMucnVsZS5yYW5nZSk7XG4gICAgZGVidWdsb2coYCBjYXRlZ29yaXplZCAke3Rva2VufS8ke2luZGV4fSB0byBgICsgSlNPTi5zdHJpbmdpZnkoc2Vlbkl0KSk7XG4gICAgY2F0ZWdvcml6ZWRTZW50ZW5jZVtpbmRleF0gPSBzZWVuSXQ7XG4gICAgY250ID0gY250ICsgc2Vlbkl0Lmxlbmd0aDtcbiAgICBmYWMgPSBmYWMgKiBzZWVuSXQubGVuZ3RoO1xuICB9KTtcbiAgLy8gaGF2ZSBzZWVuIHRoZSBwbGFpbiBjYXRlZ29yaXphdGlvbixcbiAgZGVidWdsb2coXCIgc2VudGVuY2VzIFwiICsgdG9rZW5zLnRva2Vucy5sZW5ndGggKyBcIiBtYXRjaGVzIFwiICsgY250ICsgXCIgZmFjOiBcIiArIGZhYyk7XG4gIGlmIChkZWJ1Z2xvZy5lbmFibGVkICYmIHRva2Vucy50b2tlbnMubGVuZ3RoKSB7XG4gICAgZGVidWdsb2coXCJmaXJzdCBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KHRva2VucywgdW5kZWZpbmVkLCAyKSk7XG4gIH1cbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IGAgcHJpb3IgUmFuZ2VSdWxlICR7SlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRTZW50ZW5jZSl9IGAgOiAnLScpO1xuICBpZiAoaGFzUmVjb21iaW5lZCkge1xuICAgIGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24odG9rZW5zLnRva2VucywgdG9rZW5zLmZ1c2FibGUsIGNhdGVnb3JpemVkU2VudGVuY2UpO1xuICB9XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBgIGFmdGVyIFJhbmdlUnVsZSAke0pTT04uc3RyaW5naWZ5KGNhdGVnb3JpemVkU2VudGVuY2UpfSBgIDogJy0nKTtcbiAgcGVyZmxvZyhcIiBzZW50ZW5jZXMgXCIgKyB0b2tlbnMudG9rZW5zLmxlbmd0aCArIFwiIC8gXCIgKyByZXMubGVuZ3RoICsgXCIgbWF0Y2hlcyBcIiArIGNudCArIFwiIGZhYzogXCIgKyBmYWMgKyBcIiByZWMgOiBcIiArIEpTT04uc3RyaW5naWZ5KGNudFJlYywgdW5kZWZpbmVkLCAyKSk7XG4gIHJldHVybiB7XG4gICAgZnVzYWJsZTogdG9rZW5zLmZ1c2FibGUsXG4gICAgdG9rZW5zOiB0b2tlbnMudG9rZW5zLFxuICAgIGNhdGVnb3JpemVkV29yZHM6IGNhdGVnb3JpemVkU2VudGVuY2VcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTYW1lUmVzKHByZXNlbnQ6IElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWQsIHJlcyA6IElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWQpICA6IG51bWJlciB7XG4gIGlmKCEoKHByZXNlbnQucnVsZS5tYXRjaGVkU3RyaW5nID09PSByZXMucnVsZS5tYXRjaGVkU3RyaW5nKVxuICAgICYmIChwcmVzZW50LnJ1bGUuY2F0ZWdvcnkgPT09IHJlcy5ydWxlLmNhdGVnb3J5KVxuICAgICYmIChwcmVzZW50LnNwYW4gPT09IHJlcy5zcGFuKVxuICAmJiAocHJlc2VudC5ydWxlLmJpdGluZGV4ID09PSByZXMucnVsZS5iaXRpbmRleCkpKSB7XG4gICAgICByZXR1cm4gMDtcbiAgfVxuICBpZihwcmVzZW50Ll9yYW5raW5nIDwgcmVzLl9yYW5raW5nKSB7XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIHJldHVybiArMTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlSWdub3JlT3JBcHBlbmQocmVzdWx0IDogSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZFtdLCByZXMgOiBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkKSB7XG4gIHZhciBpbnNlcnRpbmRleCA9IC0xO1xuICB2YXIgZm91bmROb3RoaW5nID0gcmVzdWx0LmV2ZXJ5KCAocHJlc2VudCxpbmRleCkgPT4ge1xuICAgIHZhciByID0gaXNTYW1lUmVzKHByZXNlbnQscmVzKTtcbiAgICBpZiAociA8IDApIHtcbiAgICAgIC8vY29uc29sZS5sb2coXCJvdmVyd3JpdGluZyB3b3JzZSBcXG5cIiArIEpTT04uc3RyaW5naWZ5KHJlcykgKyAnXFxuJyArIEpTT04uc3RyaW5naWZ5KHByZXNlbnQpKyAnXFxuJyk7XG4gICAgICByZXN1bHRbaW5kZXhdID0gcmVzO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSBpZihyID4gMCkge1xuICAgICAgLy9jb25zb2xlLmxvZygnc2tpcHBpbmcgcHJlc2VudCcpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSk7XG4gIGlmKGZvdW5kTm90aGluZykge1xuICAgIC8vZGVidWxvZygncHVzaGluZycpO1xuICAgIHJlc3VsdC5wdXNoKHJlcyk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24odG9rZW5zOiBzdHJpbmdbXSwgZnVzYWJsZTogYm9vbGVhbltdLCBjYXRlZ29yaXplZFdvcmRzOiBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkW11bXSkge1xuICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKFwiZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbi4uLiBcIiArIEpTT04uc3RyaW5naWZ5KGNhdGVnb3JpemVkV29yZHMpKSA6ICctJyk7XG4gIGNhdGVnb3JpemVkV29yZHMuZm9yRWFjaChmdW5jdGlvbiAod29yZGxpc3QsIGluZGV4KSB7XG4gICAgd29yZGxpc3QuZm9yRWFjaChmdW5jdGlvbiAod29yZCkge1xuICAgICAgaWYgKHdvcmQucnVsZS5yYW5nZSkge1xuICAgICAgICAvL2NvbnNvbGUubG9nKGAgZ290IHRhcmdldGluZGV4IGZvciBSYW5nZVJ1bGVzIGV2YWx1YXRpb24gOiAke3RhcmdldEluZGV4fSAke2luZGV4fSAke2Z1c2FibGUuam9pbihcIiBcIil9YCk7XG4gICAgICAgIHZhciB0YXJnZXRJbmRleCA9IGJyZWFrZG93bi5pc0NvbWJpbmFibGVSYW5nZVJldHVybkluZGV4KHdvcmQucnVsZS5yYW5nZSwgZnVzYWJsZSwgaW5kZXgpO1xuICAgICAgICAvL2NvbnNvbGUubG9nKGAgZ290IHRhcmdldGluZGV4IGZvciBSYW5nZVJ1bGVzIGV2YWx1YXRpb24gOiAke3RhcmdldEluZGV4fWApO1xuICAgICAgICBpZiAodGFyZ2V0SW5kZXggPj0gMCkge1xuICAgICAgICAgIHZhciBjb21iaW5lZFdvcmQgPSBicmVha2Rvd24uY29tYmluZVRva2Vucyh3b3JkLnJ1bGUucmFuZ2UsIGluZGV4LCB0b2tlbnMpO1xuICAgICAgICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoYCB0ZXN0IFwiJHtjb21iaW5lZFdvcmR9XCIgYWdhaW5zdCBcIiR7d29yZC5ydWxlLnJhbmdlLnJ1bGUubG93ZXJjYXNld29yZH1cIiAke0pTT04uc3RyaW5naWZ5KHdvcmQucnVsZS5yYW5nZS5ydWxlKX1gKSA6ICctJyk7XG4gICAgICAgICAgdmFyIHJlcyA9IElucHV0RmlsdGVyLmNhdGVnb3JpemVXb3JkV2l0aE9mZnNldFdpdGhSYW5rQ3V0b2ZmU2luZ2xlKGNvbWJpbmVkV29yZCwgd29yZC5ydWxlLnJhbmdlLnJ1bGUpO1xuICAgICAgICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCIgZ290IHJlcyA6IFwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSkgOiAnLScpO1xuICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgIHJlcy5zcGFuID0gd29yZC5ydWxlLnJhbmdlLmhpZ2ggLSB3b3JkLnJ1bGUucmFuZ2UubG93ICsgMTtcbiAgICAgICAgICAgIGNhdGVnb3JpemVkV29yZHNbdGFyZ2V0SW5kZXhdID0gY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0uc2xpY2UoMCk7IC8vIGF2b2lkIGludmFsaWRhdGlvbiBvZiBzZWVuaXRcbiAgICAgICAgICAgIGRlYnVnbG9nKGBwdXNoZWQgc3RoIGF0ICR7dGFyZ2V0SW5kZXh9YCk7XG4gICAgICAgICAgICBtZXJnZUlnbm9yZU9yQXBwZW5kKGNhdGVnb3JpemVkV29yZHNbdGFyZ2V0SW5kZXhdLHJlcyk7XG4gICAvLyAgICAgICAgIGNhdGVnb3JpemVkV29yZHNbdGFyZ2V0SW5kZXhdLnB1c2gocmVzKTsgLy8gY2hlY2sgdGhhdCB0aGlzIGRvZXMgbm90IGludmFsaWRhdGUgc2Vlbml0IVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbiAgLy8gZmlsdGVyIGFsbCByYW5nZSBydWxlcyAhXG4gIGNhdGVnb3JpemVkV29yZHMuZm9yRWFjaChmdW5jdGlvbiAod29yZGxpc3QsIGluZGV4KSB7XG4gICAgY2F0ZWdvcml6ZWRXb3Jkc1tpbmRleF0gPSB3b3JkbGlzdC5maWx0ZXIod29yZCA9PiAhd29yZC5ydWxlLnJhbmdlKTtcbiAgfSk7XG59XG5cblxuXG5cbmNvbnN0IGNsb25lID0gdXRpbHMuY2xvbmVEZWVwO1xuXG5cblxuXG5mdW5jdGlvbiBjb3B5VmVjTWVtYmVycyh1KSB7XG4gIHZhciBpID0gMDtcbiAgZm9yIChpID0gMDsgaSA8IHUubGVuZ3RoOyArK2kpIHtcbiAgICB1W2ldID0gY2xvbmUodVtpXSk7XG4gIH1cbiAgcmV0dXJuIHU7XG59XG5cblxuLy8gd2UgY2FuIHJlcGxpY2F0ZSB0aGUgdGFpbCBvciB0aGUgaGVhZCxcbi8vIHdlIHJlcGxpY2F0ZSB0aGUgdGFpbCBhcyBpdCBpcyBzbWFsbGVyLlxuLy8gW2EsYixjIF1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzU3BhblZlYyh2ZWM6IEFycmF5PGFueT4sIGluZGV4OiBudW1iZXIpIHtcbiAgdmFyIGVmZmVjdGl2ZWxlbiA9IHZlYy5yZWR1Y2UoKHByZXYsIG1lbSkgPT4gcHJldiArPSBtZW0uc3BhbiA/IG1lbS5zcGFuIDogMSwgMCk7XG4gIHJldHVybiBlZmZlY3RpdmVsZW4gPiBpbmRleDtcbn1cblxuLyoqXG4gKiBleHBhbmQgYW4gYXJyYXkgW1thMSxhMl0sIFtiMSxiMl0sW2NdXVxuICogaW50byBhbGwgY29tYmluYXRpb25zXG4gKlxuICogIGlmIGExIGhhcyBhIHNwYW4gb2YgdGhyZWUsIHRoZSB2YXJpYXRpb25zIG9mIHRoZSBsb3dlciBsYXllciBhcmUgc2tpcHBlZFxuICpcbiAqIHdpdGggdGhlIHNwZWNpYWwgcHJvcGVydHlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGV4cGFuZFRva2VuTWF0Y2hlc1RvU2VudGVuY2VzKHRva2Vuczogc3RyaW5nW10sIHRva2VuTWF0Y2hlczogQXJyYXk8QXJyYXk8YW55Pj4pOiBJTWF0Y2guSVByb2Nlc3NlZFNlbnRlbmNlcyB7XG4gIHZhciBhID0gW107XG4gIHZhciB3b3JkTWF0Y2hlcyA9IFtdO1xuICBkZWJ1Z2xvZ1YoZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHRva2VuTWF0Y2hlcykgOiAnLScpO1xuICB0b2tlbk1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbiAoYVdvcmRNYXRjaGVzLCB3b3JkSW5kZXg6IG51bWJlcikge1xuICAgIHdvcmRNYXRjaGVzW3dvcmRJbmRleF0gPSBbXTtcbiAgICBhV29yZE1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbiAob1dvcmRWYXJpYW50LCB3b3JkVmFyaWFudEluZGV4OiBudW1iZXIpIHtcbiAgICAgIHdvcmRNYXRjaGVzW3dvcmRJbmRleF1bd29yZFZhcmlhbnRJbmRleF0gPSBvV29yZFZhcmlhbnQ7XG4gICAgfSk7XG4gIH0pO1xuICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gSlNPTi5zdHJpbmdpZnkodG9rZW5NYXRjaGVzKSA6ICctJyk7XG4gIHZhciByZXN1bHQgPSB7XG4gICAgZXJyb3JzOiBbXSxcbiAgICB0b2tlbnM6IHRva2VucyxcbiAgICBzZW50ZW5jZXM6IFtdXG4gIH0gYXMgSU1hdGNoLklQcm9jZXNzZWRTZW50ZW5jZXM7XG4gIHZhciBudmVjcyA9IFtdO1xuICB2YXIgcmVzID0gW1tdXTtcbiAgLy8gdmFyIG52ZWNzID0gW107XG4gIHZhciBydmVjID0gW107XG4gIGZvciAodmFyIHRva2VuSW5kZXggPSAwOyB0b2tlbkluZGV4IDwgdG9rZW5NYXRjaGVzLmxlbmd0aDsgKyt0b2tlbkluZGV4KSB7IC8vIHdvcmRnIGluZGV4IGtcbiAgICAvL3ZlY3MgaXMgdGhlIHZlY3RvciBvZiBhbGwgc28gZmFyIHNlZW4gdmFyaWFudHMgdXAgdG8gayBsZW5ndGguXG4gICAgdmFyIG5leHRCYXNlID0gW107XG4gICAgLy9pbmRlcGVuZGVudCBvZiBleGlzdGVuY2Ugb2YgbWF0Y2hlcyBvbiBsZXZlbCBrLCB3ZSByZXRhaW4gYWxsIHZlY3RvcnMgd2hpY2ggYXJlIGNvdmVyZWQgYnkgYSBzcGFuXG4gICAgLy8gd2Ugc2tpcCBleHRlbmRpbmcgdGhlbSBiZWxvd1xuICAgIGZvciAodmFyIHUgPSAwOyB1IDwgcmVzLmxlbmd0aDsgKyt1KSB7XG4gICAgICBpZiAoaXNTcGFuVmVjKHJlc1t1XSwgdG9rZW5JbmRleCkpIHtcbiAgICAgICAgbmV4dEJhc2UucHVzaChyZXNbdV0pO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgbGVuTWF0Y2hlcyA9IHRva2VuTWF0Y2hlc1t0b2tlbkluZGV4XS5sZW5ndGg7XG4gICAgaWYgKG5leHRCYXNlLmxlbmd0aCA9PT0gMCAmJiBsZW5NYXRjaGVzID09PSAwKSB7XG4gICAgICAvLyB0aGUgd29yZCBhdCBpbmRleCBJIGNhbm5vdCBiZSB1bmRlcnN0b29kXG4gICAgICAvL2lmIChyZXN1bHQuZXJyb3JzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmVzdWx0LmVycm9ycy5wdXNoKEVSRXJyb3IubWFrZUVycm9yX05PX0tOT1dOX1dPUkQodG9rZW5JbmRleCwgdG9rZW5zKSk7XG4gICAgICAvL31cbiAgICB9XG4gICAgZm9yICh2YXIgbCA9IDA7IGwgPCBsZW5NYXRjaGVzOyArK2wpIHsgLy8gZm9yIGVhY2ggdmFyaWFudCBwcmVzZW50IGF0IGluZGV4IGtcbiAgICAgIC8vZGVidWdsb2coXCJ2ZWNzIG5vd1wiICsgSlNPTi5zdHJpbmdpZnkodmVjcykpO1xuICAgICAgdmFyIG52ZWNzID0gW107IC8vdmVjcy5zbGljZSgpOyAvLyBjb3B5IHRoZSB2ZWNbaV0gYmFzZSB2ZWN0b3I7XG4gICAgICAvL2RlYnVnbG9nKFwidmVjcyBjb3BpZWQgbm93XCIgKyBKU09OLnN0cmluZ2lmeShudmVjcykpO1xuICAgICAgZm9yICh2YXIgdSA9IDA7IHUgPCByZXMubGVuZ3RoOyArK3UpIHtcbiAgICAgICAgaWYgKCFpc1NwYW5WZWMocmVzW3VdLCB0b2tlbkluZGV4KSkge1xuICAgICAgICAgIC8vIGZvciBlYWNoIHNvIGZhciBjb25zdHJ1Y3RlZCByZXN1bHQgKG9mIGxlbmd0aCBrKSBpbiByZXNcbiAgICAgICAgICBudmVjcy5wdXNoKHJlc1t1XS5zbGljZSgpKTsgLy8gbWFrZSBhIGNvcHkgb2YgZWFjaCB2ZWN0b3JcbiAgICAgICAgICBudmVjc1tudmVjcy5sZW5ndGggLSAxXSA9IGNvcHlWZWNNZW1iZXJzKG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdKTtcbiAgICAgICAgICAvLyBkZWJ1Z2xvZyhcImNvcGllZCB2ZWNzW1wiKyB1K1wiXVwiICsgSlNPTi5zdHJpbmdpZnkodmVjc1t1XSkpO1xuICAgICAgICAgIG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdLnB1c2goXG4gICAgICAgICAgICBjbG9uZSh0b2tlbk1hdGNoZXNbdG9rZW5JbmRleF1bbF0pKTsgLy8gcHVzaCB0aGUgbHRoIHZhcmlhbnRcbiAgICAgICAgICAvLyBkZWJ1Z2xvZyhcIm5vdyBudmVjcyBcIiArIG52ZWNzLmxlbmd0aCArIFwiIFwiICsgSlNPTi5zdHJpbmdpZnkobnZlY3MpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gICBkZWJ1Z2xvZyhcIiBhdCAgICAgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbmV4dGJhc2UgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKVxuICAgICAgLy8gICBkZWJ1Z2xvZyhcIiBhcHBlbmQgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbnZlY3MgICAgPlwiICsgSlNPTi5zdHJpbmdpZnkobnZlY3MpKVxuICAgICAgbmV4dEJhc2UgPSBuZXh0QmFzZS5jb25jYXQobnZlY3MpO1xuICAgICAgLy8gICBkZWJ1Z2xvZyhcIiAgcmVzdWx0IFwiICsgayArIFwiOlwiICsgbCArIFwiIG52ZWNzICAgID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSlcbiAgICB9IC8vY29uc3RydVxuICAgIC8vICBkZWJ1Z2xvZyhcIm5vdyBhdCBcIiArIGsgKyBcIjpcIiArIGwgKyBcIiA+XCIgKyBKU09OLnN0cmluZ2lmeShuZXh0QmFzZSkpXG4gICAgcmVzID0gbmV4dEJhc2U7XG4gIH1cbiAgZGVidWdsb2dWKGRlYnVnbG9nVi5lbmFibGVkID8gKFwiQVBQRU5ESU5HIFRPIFJFU1wiICsgMCArIFwiOlwiICsgbCArIFwiID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSkgOiAnLScpO1xuICByZXN1bHQuc2VudGVuY2VzID0gcmVzO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBwcm9jZXNzU3RyaW5nKHF1ZXJ5OiBzdHJpbmcsIHJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcyxcbiB3b3JkczogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nPiB9XG4pOiAgSU1hdGNoLklQcm9jZXNzZWRTZW50ZW5jZXMge1xuICB3b3JkcyA9IHdvcmRzIHx8IHt9O1xuICB2YXIgdG9rZW5TdHJ1Y3QgPSB0b2tlbml6ZVN0cmluZyhxdWVyeSwgcnVsZXMsIHdvcmRzKTtcbiAgZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbih0b2tlblN0cnVjdC50b2tlbnMsIHRva2VuU3RydWN0LmZ1c2FibGUsXG4gICAgdG9rZW5TdHJ1Y3QuY2F0ZWdvcml6ZWRXb3Jkcyk7XG4gIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5TdHJ1Y3QuY2F0ZWdvcml6ZWRXb3JkcykpO1xuICB9XG4gIHZhciBhU2VudGVuY2VzID0gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXModG9rZW5TdHJ1Y3QudG9rZW5zLCB0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKTtcbiAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5zZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgU2VudGVuY2UuZHVtcE5pY2Uob1NlbnRlbmNlKTsgLy9KU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICB9XG4gIGFTZW50ZW5jZXMuc2VudGVuY2VzID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMuc2VudGVuY2VzKTtcbiAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlcy5zZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICB9XG4gIHJldHVybiBhU2VudGVuY2VzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2ltcGxpZnlTZW50ZW5jZShyZXMpIHtcbiAgcmV0dXJuIHJlcy5tYXAoZnVuY3Rpb24gKHIpIHtcbiAgICByZXR1cm4gci5tYXAod29yZCA9PiB7IHJldHVybiB3b3JkLnN0cmluZyArICc9PicgKyB3b3JkLm1hdGNoZWRTdHJpbmcgKyAnLycgKyB3b3JkLmNhdGVnb3J5ICsgKHdvcmQuc3BhbiA/ICcvJyArIHdvcmQuc3BhbiA6ICcnKSB9KVxuICB9KTtcbn1cbiIsIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGVyYmFzZVxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICpcbiAqIEJhc2ljIGRvbWFpbiBiYXNlZCBlbnRpdHkgcmVjb2duaXRpb25cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgSW5wdXRGaWx0ZXIgPSByZXF1aXJlKFwiLi9pbnB1dEZpbHRlclwiKTtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdlcmJhc2UnKTtcbnZhciBkZWJ1Z2xvZ1YgPSBkZWJ1ZygnZXJiYXNlJyk7XG52YXIgcGVyZmxvZyA9IGRlYnVnKCdwZXJmJyk7XG52YXIgYnJlYWtkb3duID0gcmVxdWlyZShcIi4vYnJlYWtkb3duXCIpO1xudmFyIEVSRXJyb3IgPSByZXF1aXJlKFwiLi9lcmVycm9yXCIpO1xudmFyIEFueU9iamVjdCA9IE9iamVjdDtcbnZhciB1dGlscyA9IHJlcXVpcmUoXCIuLi91dGlscy91dGlsc1wiKTtcbnZhciBTZW50ZW5jZSA9IHJlcXVpcmUoXCIuL3NlbnRlbmNlXCIpO1xuLyoqXG4gKiBHaXZlbiBhICBzdHJpbmcsIGJyZWFrIGl0IGRvd24gaW50byBjb21wb25lbnRzLFxuICogW1snQScsICdCJ10sIFsnQSBCJ11dXG4gKlxuICogdGhlbiBjYXRlZ29yaXplV29yZHNcbiAqIHJldHVybmluZ1xuICpcbiAqIFsgW1sgeyBjYXRlZ29yeTogJ3N5c3RlbUlkJywgd29yZCA6ICdBJ30sXG4gKiAgICAgIHsgY2F0ZWdvcnk6ICdvdGhlcnRoaW5nJywgd29yZCA6ICdBJ31cbiAqICAgIF0sXG4gKiAgICAvLyByZXN1bHQgb2YgQlxuICogICAgWyB7IGNhdGVnb3J5OiAnc3lzdGVtSWQnLCB3b3JkIDogJ0InfSxcbiAqICAgICAgeyBjYXRlZ29yeTogJ290aGVydGhpbmcnLCB3b3JkIDogJ0EnfVxuICogICAgICB7IGNhdGVnb3J5OiAnYW5vdGhlcnRyeXAnLCB3b3JkIDogJ0InfVxuICogICAgXVxuICogICBdLFxuICogXV1dXG4gKlxuICpcbiAqXG4gKi9cbmZ1bmN0aW9uIHRva2VuaXplU3RyaW5nKHNTdHJpbmcsIHJ1bGVzLCB3b3Jkcykge1xuICAgIHZhciBjbnQgPSAwO1xuICAgIHZhciBmYWMgPSAxO1xuICAgIHZhciB0b2tlbnMgPSBicmVha2Rvd24udG9rZW5pemVTdHJpbmcoc1N0cmluZyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJoZXJlIGJyZWFrZG93blwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5zKSk7XG4gICAgfVxuICAgIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkodSkpO1xuICAgIHdvcmRzID0gd29yZHMgfHwge307XG4gICAgcGVyZmxvZygndGhpcyBtYW55IGtub3duIHdvcmRzOiAnICsgT2JqZWN0LmtleXMod29yZHMpLmxlbmd0aCk7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBjbnRSZWMgPSB7fTtcbiAgICB2YXIgY2F0ZWdvcml6ZWRTZW50ZW5jZSA9IFtdO1xuICAgIHZhciBoYXNSZWNvbWJpbmVkID0gZmFsc2U7XG4gICAgdG9rZW5zLnRva2Vucy5mb3JFYWNoKGZ1bmN0aW9uICh0b2tlbiwgaW5kZXgpIHtcbiAgICAgICAgdmFyIHNlZW5JdCA9IElucHV0RmlsdGVyLmNhdGVnb3JpemVBV29yZFdpdGhPZmZzZXRzKHRva2VuLCBydWxlcywgc1N0cmluZywgd29yZHMsIGNudFJlYyk7XG4gICAgICAgIC8qIGNhbm5vdCBoYXZlIHRoaXMsIG9yIG5lZWQgdG8gYWRkIGFsbCBmcmFnbWVudCB3b3JkcyBcIlVJMiBJbnRlZ3JhdGlvblwiICBpZihzZWVuSXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKi9cbiAgICAgICAgaGFzUmVjb21iaW5lZCA9IGhhc1JlY29tYmluZWQgfHwgIXNlZW5JdC5ldmVyeShmdW5jdGlvbiAocmVzKSB7IHJldHVybiAhcmVzLnJ1bGUucmFuZ2U7IH0pO1xuICAgICAgICBkZWJ1Z2xvZyhcIiBjYXRlZ29yaXplZCBcIiArIHRva2VuICsgXCIvXCIgKyBpbmRleCArIFwiIHRvIFwiICsgSlNPTi5zdHJpbmdpZnkoc2Vlbkl0KSk7XG4gICAgICAgIGNhdGVnb3JpemVkU2VudGVuY2VbaW5kZXhdID0gc2Vlbkl0O1xuICAgICAgICBjbnQgPSBjbnQgKyBzZWVuSXQubGVuZ3RoO1xuICAgICAgICBmYWMgPSBmYWMgKiBzZWVuSXQubGVuZ3RoO1xuICAgIH0pO1xuICAgIC8vIGhhdmUgc2VlbiB0aGUgcGxhaW4gY2F0ZWdvcml6YXRpb24sXG4gICAgZGVidWdsb2coXCIgc2VudGVuY2VzIFwiICsgdG9rZW5zLnRva2Vucy5sZW5ndGggKyBcIiBtYXRjaGVzIFwiICsgY250ICsgXCIgZmFjOiBcIiArIGZhYyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQgJiYgdG9rZW5zLnRva2Vucy5sZW5ndGgpIHtcbiAgICAgICAgZGVidWdsb2coXCJmaXJzdCBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KHRva2VucywgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBcIiBwcmlvciBSYW5nZVJ1bGUgXCIgKyBKU09OLnN0cmluZ2lmeShjYXRlZ29yaXplZFNlbnRlbmNlKSArIFwiIFwiIDogJy0nKTtcbiAgICBpZiAoaGFzUmVjb21iaW5lZCkge1xuICAgICAgICBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2Vucy50b2tlbnMsIHRva2Vucy5mdXNhYmxlLCBjYXRlZ29yaXplZFNlbnRlbmNlKTtcbiAgICB9XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IFwiIGFmdGVyIFJhbmdlUnVsZSBcIiArIEpTT04uc3RyaW5naWZ5KGNhdGVnb3JpemVkU2VudGVuY2UpICsgXCIgXCIgOiAnLScpO1xuICAgIHBlcmZsb2coXCIgc2VudGVuY2VzIFwiICsgdG9rZW5zLnRva2Vucy5sZW5ndGggKyBcIiAvIFwiICsgcmVzLmxlbmd0aCArIFwiIG1hdGNoZXMgXCIgKyBjbnQgKyBcIiBmYWM6IFwiICsgZmFjICsgXCIgcmVjIDogXCIgKyBKU09OLnN0cmluZ2lmeShjbnRSZWMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiB7XG4gICAgICAgIGZ1c2FibGU6IHRva2Vucy5mdXNhYmxlLFxuICAgICAgICB0b2tlbnM6IHRva2Vucy50b2tlbnMsXG4gICAgICAgIGNhdGVnb3JpemVkV29yZHM6IGNhdGVnb3JpemVkU2VudGVuY2VcbiAgICB9O1xufVxuZXhwb3J0cy50b2tlbml6ZVN0cmluZyA9IHRva2VuaXplU3RyaW5nO1xuZnVuY3Rpb24gaXNTYW1lUmVzKHByZXNlbnQsIHJlcykge1xuICAgIGlmICghKChwcmVzZW50LnJ1bGUubWF0Y2hlZFN0cmluZyA9PT0gcmVzLnJ1bGUubWF0Y2hlZFN0cmluZylcbiAgICAgICAgJiYgKHByZXNlbnQucnVsZS5jYXRlZ29yeSA9PT0gcmVzLnJ1bGUuY2F0ZWdvcnkpXG4gICAgICAgICYmIChwcmVzZW50LnNwYW4gPT09IHJlcy5zcGFuKVxuICAgICAgICAmJiAocHJlc2VudC5ydWxlLmJpdGluZGV4ID09PSByZXMucnVsZS5iaXRpbmRleCkpKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICBpZiAocHJlc2VudC5fcmFua2luZyA8IHJlcy5fcmFua2luZykge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIHJldHVybiArMTtcbn1cbmV4cG9ydHMuaXNTYW1lUmVzID0gaXNTYW1lUmVzO1xuZnVuY3Rpb24gbWVyZ2VJZ25vcmVPckFwcGVuZChyZXN1bHQsIHJlcykge1xuICAgIHZhciBpbnNlcnRpbmRleCA9IC0xO1xuICAgIHZhciBmb3VuZE5vdGhpbmcgPSByZXN1bHQuZXZlcnkoZnVuY3Rpb24gKHByZXNlbnQsIGluZGV4KSB7XG4gICAgICAgIHZhciByID0gaXNTYW1lUmVzKHByZXNlbnQsIHJlcyk7XG4gICAgICAgIGlmIChyIDwgMCkge1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIm92ZXJ3cml0aW5nIHdvcnNlIFxcblwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSArICdcXG4nICsgSlNPTi5zdHJpbmdpZnkocHJlc2VudCkrICdcXG4nKTtcbiAgICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSByZXM7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAociA+IDApIHtcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ3NraXBwaW5nIHByZXNlbnQnKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgICBpZiAoZm91bmROb3RoaW5nKSB7XG4gICAgICAgIC8vZGVidWxvZygncHVzaGluZycpO1xuICAgICAgICByZXN1bHQucHVzaChyZXMpO1xuICAgIH1cbn1cbmV4cG9ydHMubWVyZ2VJZ25vcmVPckFwcGVuZCA9IG1lcmdlSWdub3JlT3JBcHBlbmQ7XG5mdW5jdGlvbiBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2VucywgZnVzYWJsZSwgY2F0ZWdvcml6ZWRXb3Jkcykge1xuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uLi4uIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRXb3JkcykpIDogJy0nKTtcbiAgICBjYXRlZ29yaXplZFdvcmRzLmZvckVhY2goZnVuY3Rpb24gKHdvcmRsaXN0LCBpbmRleCkge1xuICAgICAgICB3b3JkbGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkKSB7XG4gICAgICAgICAgICBpZiAod29yZC5ydWxlLnJhbmdlKSB7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgIGdvdCB0YXJnZXRpbmRleCBmb3IgUmFuZ2VSdWxlcyBldmFsdWF0aW9uIDogJHt0YXJnZXRJbmRleH0gJHtpbmRleH0gJHtmdXNhYmxlLmpvaW4oXCIgXCIpfWApO1xuICAgICAgICAgICAgICAgIHZhciB0YXJnZXRJbmRleCA9IGJyZWFrZG93bi5pc0NvbWJpbmFibGVSYW5nZVJldHVybkluZGV4KHdvcmQucnVsZS5yYW5nZSwgZnVzYWJsZSwgaW5kZXgpO1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYCBnb3QgdGFyZ2V0aW5kZXggZm9yIFJhbmdlUnVsZXMgZXZhbHVhdGlvbiA6ICR7dGFyZ2V0SW5kZXh9YCk7XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldEluZGV4ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkV29yZCA9IGJyZWFrZG93bi5jb21iaW5lVG9rZW5zKHdvcmQucnVsZS5yYW5nZSwgaW5kZXgsIHRva2Vucyk7XG4gICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCIgdGVzdCBcXFwiXCIgKyBjb21iaW5lZFdvcmQgKyBcIlxcXCIgYWdhaW5zdCBcXFwiXCIgKyB3b3JkLnJ1bGUucmFuZ2UucnVsZS5sb3dlcmNhc2V3b3JkICsgXCJcXFwiIFwiICsgSlNPTi5zdHJpbmdpZnkod29yZC5ydWxlLnJhbmdlLnJ1bGUpKSA6ICctJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBJbnB1dEZpbHRlci5jYXRlZ29yaXplV29yZFdpdGhPZmZzZXRXaXRoUmFua0N1dG9mZlNpbmdsZShjb21iaW5lZFdvcmQsIHdvcmQucnVsZS5yYW5nZS5ydWxlKTtcbiAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcIiBnb3QgcmVzIDogXCIgKyBKU09OLnN0cmluZ2lmeShyZXMpKSA6ICctJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5zcGFuID0gd29yZC5ydWxlLnJhbmdlLmhpZ2ggLSB3b3JkLnJ1bGUucmFuZ2UubG93ICsgMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGVnb3JpemVkV29yZHNbdGFyZ2V0SW5kZXhdID0gY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0uc2xpY2UoMCk7IC8vIGF2b2lkIGludmFsaWRhdGlvbiBvZiBzZWVuaXRcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwicHVzaGVkIHN0aCBhdCBcIiArIHRhcmdldEluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlSWdub3JlT3JBcHBlbmQoY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0sIHJlcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIC8vIGZpbHRlciBhbGwgcmFuZ2UgcnVsZXMgIVxuICAgIGNhdGVnb3JpemVkV29yZHMuZm9yRWFjaChmdW5jdGlvbiAod29yZGxpc3QsIGluZGV4KSB7XG4gICAgICAgIGNhdGVnb3JpemVkV29yZHNbaW5kZXhdID0gd29yZGxpc3QuZmlsdGVyKGZ1bmN0aW9uICh3b3JkKSB7IHJldHVybiAhd29yZC5ydWxlLnJhbmdlOyB9KTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbiA9IGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb247XG52YXIgY2xvbmUgPSB1dGlscy5jbG9uZURlZXA7XG5mdW5jdGlvbiBjb3B5VmVjTWVtYmVycyh1KSB7XG4gICAgdmFyIGkgPSAwO1xuICAgIGZvciAoaSA9IDA7IGkgPCB1Lmxlbmd0aDsgKytpKSB7XG4gICAgICAgIHVbaV0gPSBjbG9uZSh1W2ldKTtcbiAgICB9XG4gICAgcmV0dXJuIHU7XG59XG4vLyB3ZSBjYW4gcmVwbGljYXRlIHRoZSB0YWlsIG9yIHRoZSBoZWFkLFxuLy8gd2UgcmVwbGljYXRlIHRoZSB0YWlsIGFzIGl0IGlzIHNtYWxsZXIuXG4vLyBbYSxiLGMgXVxuZnVuY3Rpb24gaXNTcGFuVmVjKHZlYywgaW5kZXgpIHtcbiAgICB2YXIgZWZmZWN0aXZlbGVuID0gdmVjLnJlZHVjZShmdW5jdGlvbiAocHJldiwgbWVtKSB7IHJldHVybiBwcmV2ICs9IG1lbS5zcGFuID8gbWVtLnNwYW4gOiAxOyB9LCAwKTtcbiAgICByZXR1cm4gZWZmZWN0aXZlbGVuID4gaW5kZXg7XG59XG5leHBvcnRzLmlzU3BhblZlYyA9IGlzU3BhblZlYztcbi8qKlxuICogZXhwYW5kIGFuIGFycmF5IFtbYTEsYTJdLCBbYjEsYjJdLFtjXV1cbiAqIGludG8gYWxsIGNvbWJpbmF0aW9uc1xuICpcbiAqICBpZiBhMSBoYXMgYSBzcGFuIG9mIHRocmVlLCB0aGUgdmFyaWF0aW9ucyBvZiB0aGUgbG93ZXIgbGF5ZXIgYXJlIHNraXBwZWRcbiAqXG4gKiB3aXRoIHRoZSBzcGVjaWFsIHByb3BlcnR5XG4gKi9cbmZ1bmN0aW9uIGV4cGFuZFRva2VuTWF0Y2hlc1RvU2VudGVuY2VzKHRva2VucywgdG9rZW5NYXRjaGVzKSB7XG4gICAgdmFyIGEgPSBbXTtcbiAgICB2YXIgd29yZE1hdGNoZXMgPSBbXTtcbiAgICBkZWJ1Z2xvZ1YoZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHRva2VuTWF0Y2hlcykgOiAnLScpO1xuICAgIHRva2VuTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChhV29yZE1hdGNoZXMsIHdvcmRJbmRleCkge1xuICAgICAgICB3b3JkTWF0Y2hlc1t3b3JkSW5kZXhdID0gW107XG4gICAgICAgIGFXb3JkTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZFZhcmlhbnQsIHdvcmRWYXJpYW50SW5kZXgpIHtcbiAgICAgICAgICAgIHdvcmRNYXRjaGVzW3dvcmRJbmRleF1bd29yZFZhcmlhbnRJbmRleF0gPSBvV29yZFZhcmlhbnQ7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeSh0b2tlbk1hdGNoZXMpIDogJy0nKTtcbiAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICBlcnJvcnM6IFtdLFxuICAgICAgICB0b2tlbnM6IHRva2VucyxcbiAgICAgICAgc2VudGVuY2VzOiBbXVxuICAgIH07XG4gICAgdmFyIG52ZWNzID0gW107XG4gICAgdmFyIHJlcyA9IFtbXV07XG4gICAgLy8gdmFyIG52ZWNzID0gW107XG4gICAgdmFyIHJ2ZWMgPSBbXTtcbiAgICBmb3IgKHZhciB0b2tlbkluZGV4ID0gMDsgdG9rZW5JbmRleCA8IHRva2VuTWF0Y2hlcy5sZW5ndGg7ICsrdG9rZW5JbmRleCkge1xuICAgICAgICAvL3ZlY3MgaXMgdGhlIHZlY3RvciBvZiBhbGwgc28gZmFyIHNlZW4gdmFyaWFudHMgdXAgdG8gayBsZW5ndGguXG4gICAgICAgIHZhciBuZXh0QmFzZSA9IFtdO1xuICAgICAgICAvL2luZGVwZW5kZW50IG9mIGV4aXN0ZW5jZSBvZiBtYXRjaGVzIG9uIGxldmVsIGssIHdlIHJldGFpbiBhbGwgdmVjdG9ycyB3aGljaCBhcmUgY292ZXJlZCBieSBhIHNwYW5cbiAgICAgICAgLy8gd2Ugc2tpcCBleHRlbmRpbmcgdGhlbSBiZWxvd1xuICAgICAgICBmb3IgKHZhciB1ID0gMDsgdSA8IHJlcy5sZW5ndGg7ICsrdSkge1xuICAgICAgICAgICAgaWYgKGlzU3BhblZlYyhyZXNbdV0sIHRva2VuSW5kZXgpKSB7XG4gICAgICAgICAgICAgICAgbmV4dEJhc2UucHVzaChyZXNbdV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBsZW5NYXRjaGVzID0gdG9rZW5NYXRjaGVzW3Rva2VuSW5kZXhdLmxlbmd0aDtcbiAgICAgICAgaWYgKG5leHRCYXNlLmxlbmd0aCA9PT0gMCAmJiBsZW5NYXRjaGVzID09PSAwKSB7XG4gICAgICAgICAgICAvLyB0aGUgd29yZCBhdCBpbmRleCBJIGNhbm5vdCBiZSB1bmRlcnN0b29kXG4gICAgICAgICAgICAvL2lmIChyZXN1bHQuZXJyb3JzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmVzdWx0LmVycm9ycy5wdXNoKEVSRXJyb3IubWFrZUVycm9yX05PX0tOT1dOX1dPUkQodG9rZW5JbmRleCwgdG9rZW5zKSk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgbCA9IDA7IGwgPCBsZW5NYXRjaGVzOyArK2wpIHtcbiAgICAgICAgICAgIC8vZGVidWdsb2coXCJ2ZWNzIG5vd1wiICsgSlNPTi5zdHJpbmdpZnkodmVjcykpO1xuICAgICAgICAgICAgdmFyIG52ZWNzID0gW107IC8vdmVjcy5zbGljZSgpOyAvLyBjb3B5IHRoZSB2ZWNbaV0gYmFzZSB2ZWN0b3I7XG4gICAgICAgICAgICAvL2RlYnVnbG9nKFwidmVjcyBjb3BpZWQgbm93XCIgKyBKU09OLnN0cmluZ2lmeShudmVjcykpO1xuICAgICAgICAgICAgZm9yICh2YXIgdSA9IDA7IHUgPCByZXMubGVuZ3RoOyArK3UpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzU3BhblZlYyhyZXNbdV0sIHRva2VuSW5kZXgpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGZvciBlYWNoIHNvIGZhciBjb25zdHJ1Y3RlZCByZXN1bHQgKG9mIGxlbmd0aCBrKSBpbiByZXNcbiAgICAgICAgICAgICAgICAgICAgbnZlY3MucHVzaChyZXNbdV0uc2xpY2UoKSk7IC8vIG1ha2UgYSBjb3B5IG9mIGVhY2ggdmVjdG9yXG4gICAgICAgICAgICAgICAgICAgIG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdID0gY29weVZlY01lbWJlcnMobnZlY3NbbnZlY3MubGVuZ3RoIC0gMV0pO1xuICAgICAgICAgICAgICAgICAgICAvLyBkZWJ1Z2xvZyhcImNvcGllZCB2ZWNzW1wiKyB1K1wiXVwiICsgSlNPTi5zdHJpbmdpZnkodmVjc1t1XSkpO1xuICAgICAgICAgICAgICAgICAgICBudmVjc1tudmVjcy5sZW5ndGggLSAxXS5wdXNoKGNsb25lKHRva2VuTWF0Y2hlc1t0b2tlbkluZGV4XVtsXSkpOyAvLyBwdXNoIHRoZSBsdGggdmFyaWFudFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vICAgZGVidWdsb2coXCIgYXQgICAgIFwiICsgayArIFwiOlwiICsgbCArIFwiIG5leHRiYXNlID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSlcbiAgICAgICAgICAgIC8vICAgZGVidWdsb2coXCIgYXBwZW5kIFwiICsgayArIFwiOlwiICsgbCArIFwiIG52ZWNzICAgID5cIiArIEpTT04uc3RyaW5naWZ5KG52ZWNzKSlcbiAgICAgICAgICAgIG5leHRCYXNlID0gbmV4dEJhc2UuY29uY2F0KG52ZWNzKTtcbiAgICAgICAgfSAvL2NvbnN0cnVcbiAgICAgICAgLy8gIGRlYnVnbG9nKFwibm93IGF0IFwiICsgayArIFwiOlwiICsgbCArIFwiID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSlcbiAgICAgICAgcmVzID0gbmV4dEJhc2U7XG4gICAgfVxuICAgIGRlYnVnbG9nVihkZWJ1Z2xvZ1YuZW5hYmxlZCA/IChcIkFQUEVORElORyBUTyBSRVNcIiArIDAgKyBcIjpcIiArIGwgKyBcIiA+XCIgKyBKU09OLnN0cmluZ2lmeShuZXh0QmFzZSkpIDogJy0nKTtcbiAgICByZXN1bHQuc2VudGVuY2VzID0gcmVzO1xuICAgIHJldHVybiByZXN1bHQ7XG59XG5leHBvcnRzLmV4cGFuZFRva2VuTWF0Y2hlc1RvU2VudGVuY2VzID0gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXM7XG5mdW5jdGlvbiBwcm9jZXNzU3RyaW5nKHF1ZXJ5LCBydWxlcywgd29yZHMpIHtcbiAgICB3b3JkcyA9IHdvcmRzIHx8IHt9O1xuICAgIHZhciB0b2tlblN0cnVjdCA9IHRva2VuaXplU3RyaW5nKHF1ZXJ5LCBydWxlcywgd29yZHMpO1xuICAgIGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24odG9rZW5TdHJ1Y3QudG9rZW5zLCB0b2tlblN0cnVjdC5mdXNhYmxlLCB0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeSh0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKSk7XG4gICAgfVxuICAgIHZhciBhU2VudGVuY2VzID0gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXModG9rZW5TdHJ1Y3QudG9rZW5zLCB0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5zZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBTZW50ZW5jZS5kdW1wTmljZShvU2VudGVuY2UpOyAvL0pTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICAgIH1cbiAgICBhU2VudGVuY2VzLnNlbnRlbmNlcyA9IElucHV0RmlsdGVyLnJlaW5Gb3JjZShhU2VudGVuY2VzLnNlbnRlbmNlcyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJhZnRlciByZWluZm9yY2VcIiArIGFTZW50ZW5jZXMuc2VudGVuY2VzLm1hcChmdW5jdGlvbiAob1NlbnRlbmNlKSB7XG4gICAgICAgICAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIHJldHVybiBhU2VudGVuY2VzO1xufVxuZXhwb3J0cy5wcm9jZXNzU3RyaW5nID0gcHJvY2Vzc1N0cmluZztcbmZ1bmN0aW9uIHNpbXBsaWZ5U2VudGVuY2UocmVzKSB7XG4gICAgcmV0dXJuIHJlcy5tYXAoZnVuY3Rpb24gKHIpIHtcbiAgICAgICAgcmV0dXJuIHIubWFwKGZ1bmN0aW9uICh3b3JkKSB7IHJldHVybiB3b3JkLnN0cmluZyArICc9PicgKyB3b3JkLm1hdGNoZWRTdHJpbmcgKyAnLycgKyB3b3JkLmNhdGVnb3J5ICsgKHdvcmQuc3BhbiA/ICcvJyArIHdvcmQuc3BhbiA6ICcnKTsgfSk7XG4gICAgfSk7XG59XG5leHBvcnRzLnNpbXBsaWZ5U2VudGVuY2UgPSBzaW1wbGlmeVNlbnRlbmNlO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
