/**
 *
 * @module jfseb.fdevstart.analyze
 * @file erbase
 * @copyright (c) 2016 Gerd Forstmann
 *
 * Basic domain based entity recognition
 */
"use strict";

var InputFilter = require("./inputFilter");
var debug = require("debug");
var debuglog = debug('erbase');
var debuglogV = debug('erbase');
var perflog = debug('perf');
var breakdown = require("./breakdown");
var ERError = require("./ererror");
var AnyObject = Object;
var utils = require("../utils/utils");
var Sentence = require("./sentence");
/**
 * Given a  string, break it down into components,
 * [['A', 'B'], ['A B']]
 *
 * then categorizeWords
 * returning
 *
 * [ [[ { category: 'systemId', word : 'A'},
 *      { category: 'otherthing', word : 'A'}
 *    ],
 *    // result of B
 *    [ { category: 'systemId', word : 'B'},
 *      { category: 'otherthing', word : 'A'}
 *      { category: 'anothertryp', word : 'B'}
 *    ]
 *   ],
 * ]]]
 *
 *
 *
 */
function tokenizeString(sString, rules, words) {
    var cnt = 0;
    var fac = 1;
    var tokens = breakdown.tokenizeString(sString);
    if (debuglog.enabled) {
        debuglog("here breakdown" + JSON.stringify(tokens));
    }
    //console.log(JSON.stringify(u));
    words = words || {};
    perflog('this many known words: ' + Object.keys(words).length);
    var res = [];
    var cntRec = {};
    var categorizedSentence = [];
    var hasRecombined = false;
    tokens.tokens.forEach(function (token, index) {
        var seenIt = InputFilter.categorizeAWordWithOffsets(token, rules, sString, words, cntRec);
        /* cannot have this, or need to add all fragment words "UI2 Integration"  if(seenIt.length === 0) {
              return false;
            }
        */
        hasRecombined = hasRecombined || !seenIt.every(function (res) {
            return !res.rule.range;
        });
        debuglog(" categorized " + token + "/" + index + " to " + JSON.stringify(seenIt));
        categorizedSentence[index] = seenIt;
        cnt = cnt + seenIt.length;
        fac = fac * seenIt.length;
    });
    // have seen the plain categorization,
    debuglog(" sentences " + tokens.tokens.length + " matches " + cnt + " fac: " + fac);
    if (debuglog.enabled && tokens.tokens.length) {
        debuglog("first match " + JSON.stringify(tokens, undefined, 2));
    }
    debuglog(debuglog.enabled ? " prior RangeRule " + JSON.stringify(categorizedSentence) + " " : '-');
    if (hasRecombined) {
        evaluateRangeRulesToPosition(tokens.tokens, tokens.fusable, categorizedSentence);
    }
    debuglog(debuglog.enabled ? " after RangeRule " + JSON.stringify(categorizedSentence) + " " : '-');
    perflog(" sentences " + tokens.tokens.length + " / " + res.length + " matches " + cnt + " fac: " + fac + " rec : " + JSON.stringify(cntRec, undefined, 2));
    return {
        fusable: tokens.fusable,
        tokens: tokens.tokens,
        categorizedWords: categorizedSentence
    };
}
exports.tokenizeString = tokenizeString;
function isSameRes(present, res) {
    if (!(present.rule.matchedString === res.rule.matchedString && present.rule.category === res.rule.category && present.span === res.span && present.rule.bitindex === res.rule.bitindex)) {
        return 0;
    }
    if (present._ranking < res._ranking) {
        return -1;
    }
    return +1;
}
exports.isSameRes = isSameRes;
function mergeIgnoreOrAppend(result, res) {
    var insertindex = -1;
    var foundNothing = result.every(function (present, index) {
        var r = isSameRes(present, res);
        if (r < 0) {
            //console.log("overwriting worse \n" + JSON.stringify(res) + '\n' + JSON.stringify(present)+ '\n');
            result[index] = res;
            return false;
        } else if (r > 0) {
            //console.log('skipping present');
            return false;
        }
        return true;
    });
    if (foundNothing) {
        //debulog('pushing');
        result.push(res);
    }
}
exports.mergeIgnoreOrAppend = mergeIgnoreOrAppend;
function evaluateRangeRulesToPosition(tokens, fusable, categorizedWords) {
    debuglog(debuglog.enabled ? "evaluateRangeRulesToPosition... " + JSON.stringify(categorizedWords) : '-');
    categorizedWords.forEach(function (wordlist, index) {
        wordlist.forEach(function (word) {
            if (word.rule.range) {
                //console.log(` got targetindex for RangeRules evaluation : ${targetIndex} ${index} ${fusable.join(" ")}`);
                var targetIndex = breakdown.isCombinableRangeReturnIndex(word.rule.range, fusable, index);
                //console.log(` got targetindex for RangeRules evaluation : ${targetIndex}`);
                if (targetIndex >= 0) {
                    var combinedWord = breakdown.combineTokens(word.rule.range, index, tokens);
                    debuglog(debuglog.enabled ? " test \"" + combinedWord + "\" against \"" + word.rule.range.rule.lowercaseword + "\" " + JSON.stringify(word.rule.range.rule) : '-');
                    var res = InputFilter.categorizeWordWithOffsetWithRankCutoffSingle(combinedWord, word.rule.range.rule);
                    debuglog(debuglog.enabled ? " got res : " + JSON.stringify(res) : '-');
                    if (res) {
                        res.span = word.rule.range.high - word.rule.range.low + 1;
                        categorizedWords[targetIndex] = categorizedWords[targetIndex].slice(0); // avoid invalidation of seenit
                        debuglog("pushed sth at " + targetIndex);
                        mergeIgnoreOrAppend(categorizedWords[targetIndex], res);
                    }
                }
            }
        });
    });
    // filter all range rules !
    categorizedWords.forEach(function (wordlist, index) {
        categorizedWords[index] = wordlist.filter(function (word) {
            return !word.rule.range;
        });
    });
}
exports.evaluateRangeRulesToPosition = evaluateRangeRulesToPosition;
var clone = utils.cloneDeep;
function copyVecMembers(u) {
    var i = 0;
    for (i = 0; i < u.length; ++i) {
        u[i] = clone(u[i]);
    }
    return u;
}
// we can replicate the tail or the head,
// we replicate the tail as it is smaller.
// [a,b,c ]
function isSpanVec(vec, index) {
    var effectivelen = vec.reduce(function (prev, mem) {
        return prev += mem.span ? mem.span : 1;
    }, 0);
    return effectivelen > index;
}
exports.isSpanVec = isSpanVec;
/**
 * expand an array [[a1,a2], [b1,b2],[c]]
 * into all combinations
 *
 *  if a1 has a span of three, the variations of the lower layer are skipped
 *
 * with the special property
 */
function expandTokenMatchesToSentences(tokens, tokenMatches) {
    var a = [];
    var wordMatches = [];
    debuglogV(debuglog.enabled ? JSON.stringify(tokenMatches) : '-');
    tokenMatches.forEach(function (aWordMatches, wordIndex) {
        wordMatches[wordIndex] = [];
        aWordMatches.forEach(function (oWordVariant, wordVariantIndex) {
            wordMatches[wordIndex][wordVariantIndex] = oWordVariant;
        });
    });
    debuglog(debuglog.enabled ? JSON.stringify(tokenMatches) : '-');
    var result = {
        errors: [],
        tokens: tokens,
        sentences: []
    };
    var nvecs = [];
    var res = [[]];
    // var nvecs = [];
    var rvec = [];
    for (var tokenIndex = 0; tokenIndex < tokenMatches.length; ++tokenIndex) {
        //vecs is the vector of all so far seen variants up to k length.
        var nextBase = [];
        //independent of existence of matches on level k, we retain all vectors which are covered by a span
        // we skip extending them below
        for (var u = 0; u < res.length; ++u) {
            if (isSpanVec(res[u], tokenIndex)) {
                nextBase.push(res[u]);
            }
        }
        var lenMatches = tokenMatches[tokenIndex].length;
        if (nextBase.length === 0 && lenMatches === 0) {
            // the word at index I cannot be understood
            if (result.errors.length === 0) {
                result.errors.push(ERError.makeError_NO_KNOWN_WORD(tokenIndex, tokens));
            }
        }
        for (var l = 0; l < lenMatches; ++l) {
            //debuglog("vecs now" + JSON.stringify(vecs));
            var nvecs = []; //vecs.slice(); // copy the vec[i] base vector;
            //debuglog("vecs copied now" + JSON.stringify(nvecs));
            for (var u = 0; u < res.length; ++u) {
                if (!isSpanVec(res[u], tokenIndex)) {
                    // for each so far constructed result (of length k) in res
                    nvecs.push(res[u].slice()); // make a copy of each vector
                    nvecs[nvecs.length - 1] = copyVecMembers(nvecs[nvecs.length - 1]);
                    // debuglog("copied vecs["+ u+"]" + JSON.stringify(vecs[u]));
                    nvecs[nvecs.length - 1].push(clone(tokenMatches[tokenIndex][l])); // push the lth variant
                }
            }
            //   debuglog(" at     " + k + ":" + l + " nextbase >" + JSON.stringify(nextBase))
            //   debuglog(" append " + k + ":" + l + " nvecs    >" + JSON.stringify(nvecs))
            nextBase = nextBase.concat(nvecs);
        } //constru
        //  debuglog("now at " + k + ":" + l + " >" + JSON.stringify(nextBase))
        res = nextBase;
    }
    debuglogV(debuglogV.enabled ? "APPENDING TO RES" + 0 + ":" + l + " >" + JSON.stringify(nextBase) : '-');
    result.sentences = res;
    return result;
}
exports.expandTokenMatchesToSentences = expandTokenMatchesToSentences;
function processString(query, rules, words) {
    words = words || {};
    var tokenStruct = tokenizeString(query, rules, words);
    evaluateRangeRulesToPosition(tokenStruct.tokens, tokenStruct.fusable, tokenStruct.categorizedWords);
    if (debuglog.enabled) {
        debuglog("After matched " + JSON.stringify(tokenStruct.categorizedWords));
    }
    var aSentences = expandTokenMatchesToSentences(tokenStruct.tokens, tokenStruct.categorizedWords);
    if (debuglog.enabled) {
        debuglog("after expand" + aSentences.sentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + Sentence.dumpNice(oSentence); //JSON.stringify(oSentence);
        }).join("\n"));
    }
    aSentences.sentences = InputFilter.reinForce(aSentences.sentences);
    if (debuglog.enabled) {
        debuglog("after reinforce" + aSentences.sentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    return aSentences;
}
exports.processString = processString;
function simplifySentence(res) {
    return res.map(function (r) {
        return r.map(function (word) {
            return word.string + '=>' + word.matchedString + '/' + word.category + (word.span ? '/' + word.span : '');
        });
    });
}
exports.simplifySentence = simplifySentence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9lcmJhc2UudHMiLCJtYXRjaC9lcmJhc2UuanMiXSwibmFtZXMiOlsiSW5wdXRGaWx0ZXIiLCJyZXF1aXJlIiwiZGVidWciLCJkZWJ1Z2xvZyIsImRlYnVnbG9nViIsInBlcmZsb2ciLCJicmVha2Rvd24iLCJFUkVycm9yIiwiQW55T2JqZWN0IiwiT2JqZWN0IiwidXRpbHMiLCJTZW50ZW5jZSIsInRva2VuaXplU3RyaW5nIiwic1N0cmluZyIsInJ1bGVzIiwid29yZHMiLCJjbnQiLCJmYWMiLCJ0b2tlbnMiLCJlbmFibGVkIiwiSlNPTiIsInN0cmluZ2lmeSIsImtleXMiLCJsZW5ndGgiLCJyZXMiLCJjbnRSZWMiLCJjYXRlZ29yaXplZFNlbnRlbmNlIiwiaGFzUmVjb21iaW5lZCIsImZvckVhY2giLCJ0b2tlbiIsImluZGV4Iiwic2Vlbkl0IiwiY2F0ZWdvcml6ZUFXb3JkV2l0aE9mZnNldHMiLCJldmVyeSIsInJ1bGUiLCJyYW5nZSIsInVuZGVmaW5lZCIsImV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24iLCJmdXNhYmxlIiwiY2F0ZWdvcml6ZWRXb3JkcyIsImV4cG9ydHMiLCJpc1NhbWVSZXMiLCJwcmVzZW50IiwibWF0Y2hlZFN0cmluZyIsImNhdGVnb3J5Iiwic3BhbiIsImJpdGluZGV4IiwiX3JhbmtpbmciLCJtZXJnZUlnbm9yZU9yQXBwZW5kIiwicmVzdWx0IiwiaW5zZXJ0aW5kZXgiLCJmb3VuZE5vdGhpbmciLCJyIiwicHVzaCIsIndvcmRsaXN0Iiwid29yZCIsInRhcmdldEluZGV4IiwiaXNDb21iaW5hYmxlUmFuZ2VSZXR1cm5JbmRleCIsImNvbWJpbmVkV29yZCIsImNvbWJpbmVUb2tlbnMiLCJsb3dlcmNhc2V3b3JkIiwiY2F0ZWdvcml6ZVdvcmRXaXRoT2Zmc2V0V2l0aFJhbmtDdXRvZmZTaW5nbGUiLCJoaWdoIiwibG93Iiwic2xpY2UiLCJmaWx0ZXIiLCJjbG9uZSIsImNsb25lRGVlcCIsImNvcHlWZWNNZW1iZXJzIiwidSIsImkiLCJpc1NwYW5WZWMiLCJ2ZWMiLCJlZmZlY3RpdmVsZW4iLCJyZWR1Y2UiLCJwcmV2IiwibWVtIiwiZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXMiLCJ0b2tlbk1hdGNoZXMiLCJhIiwid29yZE1hdGNoZXMiLCJhV29yZE1hdGNoZXMiLCJ3b3JkSW5kZXgiLCJvV29yZFZhcmlhbnQiLCJ3b3JkVmFyaWFudEluZGV4IiwiZXJyb3JzIiwic2VudGVuY2VzIiwibnZlY3MiLCJydmVjIiwidG9rZW5JbmRleCIsIm5leHRCYXNlIiwibGVuTWF0Y2hlcyIsIm1ha2VFcnJvcl9OT19LTk9XTl9XT1JEIiwibCIsImNvbmNhdCIsInByb2Nlc3NTdHJpbmciLCJxdWVyeSIsInRva2VuU3RydWN0IiwiYVNlbnRlbmNlcyIsIm1hcCIsIm9TZW50ZW5jZSIsInJhbmtpbmdQcm9kdWN0IiwiZHVtcE5pY2UiLCJqb2luIiwicmVpbkZvcmNlIiwic2ltcGxpZnlTZW50ZW5jZSIsInN0cmluZyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0FDUUE7O0FERUEsSUFBQUEsY0FBQUMsUUFBQSxlQUFBLENBQUE7QUFFQSxJQUFBQyxRQUFBRCxRQUFBLE9BQUEsQ0FBQTtBQUVBLElBQU1FLFdBQVdELE1BQU0sUUFBTixDQUFqQjtBQUNBLElBQU1FLFlBQVlGLE1BQU0sUUFBTixDQUFsQjtBQUNBLElBQU1HLFVBQVVILE1BQU0sTUFBTixDQUFoQjtBQUVBLElBQUFJLFlBQUFMLFFBQUEsYUFBQSxDQUFBO0FBQ0EsSUFBQU0sVUFBQU4sUUFBQSxXQUFBLENBQUE7QUFFQSxJQUFNTyxZQUFpQkMsTUFBdkI7QUFNQSxJQUFBQyxRQUFBVCxRQUFBLGdCQUFBLENBQUE7QUFNQSxJQUFBVSxXQUFBVixRQUFBLFlBQUEsQ0FBQTtBQWlDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBcUJBLFNBQUFXLGNBQUEsQ0FBK0JDLE9BQS9CLEVBQWdEQyxLQUFoRCxFQUNFQyxLQURGLEVBQzREO0FBRTFELFFBQUlDLE1B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QkcsSUFGdUIsQ0FFbEIsSUFGa0IsQ0FBMUI7QUFHRDtBQUNETCxlQUFXWixTQUFYLEdBQXVCdEYsWUFBWXdHLFNBQVosQ0FBc0JOLFdBQVdaLFNBQWpDLENBQXZCO0FBQ0EsUUFBSW5GLFNBQVNnQixPQUFiLEVBQXNCO0FBQ3BCaEIsaUJBQVMsb0JBQW9CK0YsV0FBV1osU0FBWCxDQUFxQmEsR0FBckIsQ0FBeUIsVUFBVUMsU0FBVixFQUFtQjtBQUN2RSxtQkFBT3pGLFNBQVMwRixjQUFULENBQXdCRCxTQUF4QixJQUFxQyxHQUFyQyxHQUEyQ2hGLEtBQUtDLFNBQUwsQ0FBZStFLFNBQWYsQ0FBbEQ7QUFDRCxTQUY0QixFQUUxQkcsSUFGMEIsQ0FFckIsSUFGcUIsQ0FBN0I7QUFHRDtBQUNELFdBQU9MLFVBQVA7QUFDRDtBQXZCRDFELFFBQUF1RCxhQUFBLEdBQUFBLGFBQUE7QUF5QkEsU0FBQVUsZ0JBQUEsQ0FBaUNqRixHQUFqQyxFQUFvQztBQUNsQyxXQUFPQSxJQUFJMkUsR0FBSixDQUFRLFVBQVUvQyxDQUFWLEVBQVc7QUFDeEIsZUFBT0EsRUFBRStDLEdBQUYsQ0FBTSxVQUFBNUMsSUFBQSxFQUFJO0FBQU0sbUJBQU9BLEtBQUttRCxNQUFMLEdBQWMsSUFBZCxHQUFxQm5ELEtBQUtaLGFBQTFCLEdBQTBDLEdBQTFDLEdBQWdEWSxLQUFLWCxRQUFyRCxJQUFpRVcsS0FBS1YsSUFBTCxHQUFZLE1BQU1VLEtBQUtWLElBQXZCLEdBQThCLEVBQS9GLENBQVA7QUFBMkcsU0FBM0gsQ0FBUDtBQUNELEtBRk0sQ0FBUDtBQUdEO0FBSkRMLFFBQUFpRSxnQkFBQSxHQUFBQSxnQkFBQSIsImZpbGUiOiJtYXRjaC9lcmJhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5hbmFseXplXG4gKiBAZmlsZSBlcmJhc2VcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqXG4gKiBCYXNpYyBkb21haW4gYmFzZWQgZW50aXR5IHJlY29nbml0aW9uXG4gKi9cblxuXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlciBmcm9tICcuL2lucHV0RmlsdGVyJztcblxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdlcmJhc2UnKTtcbmNvbnN0IGRlYnVnbG9nViA9IGRlYnVnKCdlcmJhc2UnKTtcbmNvbnN0IHBlcmZsb2cgPSBkZWJ1ZygncGVyZicpO1xuXG5pbXBvcnQgKiBhcyBicmVha2Rvd24gZnJvbSAnLi9icmVha2Rvd24nO1xuaW1wb3J0ICogYXMgRVJFcnJvciBmcm9tICcuL2VyZXJyb3InO1xuXG5jb25zdCBBbnlPYmplY3QgPSA8YW55Pk9iamVjdDtcblxuXG5cblxuXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuLi91dGlscy91dGlscyc7XG5cbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuL2lmbWF0Y2gnO1xuXG5pbXBvcnQgKiBhcyBUb29sbWF0Y2hlciBmcm9tICcuL3Rvb2xtYXRjaGVyJztcblxuaW1wb3J0ICogYXMgU2VudGVuY2UgZnJvbSAnLi9zZW50ZW5jZSc7XG5cbmltcG9ydCAqIGFzIFdvcmQgZnJvbSAnLi93b3JkJztcblxuaW1wb3J0ICogYXMgQWxnb2wgZnJvbSAnLi9hbGdvbCc7XG5cblxuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi9tYXRjaCc7XG5cblxuaW50ZXJmYWNlIElUb2tlbml6ZWRTdHJpbmcge1xuICB0b2tlbnM6IHN0cmluZ1tdLFxuICBjYXRlZ29yaXplZFdvcmRzOiBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkW11bXVxuICBmdXNhYmxlOiBib29sZWFuW107XG59XG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG4vKipcbiAqIEdpdmVuIGEgIHN0cmluZywgYnJlYWsgaXQgZG93biBpbnRvIGNvbXBvbmVudHMsXG4gKiBbWydBJywgJ0InXSwgWydBIEInXV1cbiAqXG4gKiB0aGVuIGNhdGVnb3JpemVXb3Jkc1xuICogcmV0dXJuaW5nXG4gKlxuICogWyBbWyB7IGNhdGVnb3J5OiAnc3lzdGVtSWQnLCB3b3JkIDogJ0EnfSxcbiAqICAgICAgeyBjYXRlZ29yeTogJ290aGVydGhpbmcnLCB3b3JkIDogJ0EnfVxuICogICAgXSxcbiAqICAgIC8vIHJlc3VsdCBvZiBCXG4gKiAgICBbIHsgY2F0ZWdvcnk6ICdzeXN0ZW1JZCcsIHdvcmQgOiAnQid9LFxuICogICAgICB7IGNhdGVnb3J5OiAnb3RoZXJ0aGluZycsIHdvcmQgOiAnQSd9XG4gKiAgICAgIHsgY2F0ZWdvcnk6ICdhbm90aGVydHJ5cCcsIHdvcmQgOiAnQid9XG4gKiAgICBdXG4gKiAgIF0sXG4gKiBdXV1cbiAqXG4gKlxuICpcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRva2VuaXplU3RyaW5nKHNTdHJpbmc6IHN0cmluZywgcnVsZXM6IElNYXRjaC5TcGxpdFJ1bGVzLFxuICB3b3JkczogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nPiB9KVxuICA6IElUb2tlbml6ZWRTdHJpbmcge1xuICB2YXIgY250ID0gMDtcbiAgdmFyIGZhYyA9IDE7XG4gIHZhciB0b2tlbnMgPSBicmVha2Rvd24udG9rZW5pemVTdHJpbmcoc1N0cmluZyk7XG4gIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgZGVidWdsb2coXCJoZXJlIGJyZWFrZG93blwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5zKSk7XG4gIH1cbiAgLy9jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh1KSk7XG4gIHdvcmRzID0gd29yZHMgfHwge307XG4gIHBlcmZsb2coJ3RoaXMgbWFueSBrbm93biB3b3JkczogJyArIE9iamVjdC5rZXlzKHdvcmRzKS5sZW5ndGgpO1xuICB2YXIgcmVzID0gW10gYXMgSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZFtdW107XG4gIHZhciBjbnRSZWMgPSB7fTtcbiAgdmFyIGNhdGVnb3JpemVkU2VudGVuY2UgPSBbXSBhcyBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkW11bXTtcbiAgdmFyIGhhc1JlY29tYmluZWQgPSBmYWxzZTtcbiAgdG9rZW5zLnRva2Vucy5mb3JFYWNoKGZ1bmN0aW9uICh0b2tlbiwgaW5kZXgpIHtcbiAgICB2YXIgc2Vlbkl0ID0gSW5wdXRGaWx0ZXIuY2F0ZWdvcml6ZUFXb3JkV2l0aE9mZnNldHModG9rZW4sIHJ1bGVzLCBzU3RyaW5nLCB3b3JkcywgY250UmVjKTtcbiAgICAvKiBjYW5ub3QgaGF2ZSB0aGlzLCBvciBuZWVkIHRvIGFkZCBhbGwgZnJhZ21lbnQgd29yZHMgXCJVSTIgSW50ZWdyYXRpb25cIiAgaWYoc2Vlbkl0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICovXG4gICAgaGFzUmVjb21iaW5lZCA9IGhhc1JlY29tYmluZWQgfHwgIXNlZW5JdC5ldmVyeShyZXMgPT4gIXJlcy5ydWxlLnJhbmdlKTtcbiAgICBkZWJ1Z2xvZyhgIGNhdGVnb3JpemVkICR7dG9rZW59LyR7aW5kZXh9IHRvIGAgKyBKU09OLnN0cmluZ2lmeShzZWVuSXQpKTtcbiAgICBjYXRlZ29yaXplZFNlbnRlbmNlW2luZGV4XSA9IHNlZW5JdDtcbiAgICBjbnQgPSBjbnQgKyBzZWVuSXQubGVuZ3RoO1xuICAgIGZhYyA9IGZhYyAqIHNlZW5JdC5sZW5ndGg7XG4gIH0pO1xuICAvLyBoYXZlIHNlZW4gdGhlIHBsYWluIGNhdGVnb3JpemF0aW9uLFxuICBkZWJ1Z2xvZyhcIiBzZW50ZW5jZXMgXCIgKyB0b2tlbnMudG9rZW5zLmxlbmd0aCArIFwiIG1hdGNoZXMgXCIgKyBjbnQgKyBcIiBmYWM6IFwiICsgZmFjKTtcbiAgaWYgKGRlYnVnbG9nLmVuYWJsZWQgJiYgdG9rZW5zLnRva2Vucy5sZW5ndGgpIHtcbiAgICBkZWJ1Z2xvZyhcImZpcnN0IG1hdGNoIFwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5zLCB1bmRlZmluZWQsIDIpKTtcbiAgfVxuICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gYCBwcmlvciBSYW5nZVJ1bGUgJHtKU09OLnN0cmluZ2lmeShjYXRlZ29yaXplZFNlbnRlbmNlKX0gYCA6ICctJyk7XG4gIGlmIChoYXNSZWNvbWJpbmVkKSB7XG4gICAgZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbih0b2tlbnMudG9rZW5zLCB0b2tlbnMuZnVzYWJsZSwgY2F0ZWdvcml6ZWRTZW50ZW5jZSk7XG4gIH1cbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IGAgYWZ0ZXIgUmFuZ2VSdWxlICR7SlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRTZW50ZW5jZSl9IGAgOiAnLScpO1xuICBwZXJmbG9nKFwiIHNlbnRlbmNlcyBcIiArIHRva2Vucy50b2tlbnMubGVuZ3RoICsgXCIgLyBcIiArIHJlcy5sZW5ndGggKyBcIiBtYXRjaGVzIFwiICsgY250ICsgXCIgZmFjOiBcIiArIGZhYyArIFwiIHJlYyA6IFwiICsgSlNPTi5zdHJpbmdpZnkoY250UmVjLCB1bmRlZmluZWQsIDIpKTtcbiAgcmV0dXJuIHtcbiAgICBmdXNhYmxlOiB0b2tlbnMuZnVzYWJsZSxcbiAgICB0b2tlbnM6IHRva2Vucy50b2tlbnMsXG4gICAgY2F0ZWdvcml6ZWRXb3JkczogY2F0ZWdvcml6ZWRTZW50ZW5jZVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1NhbWVSZXMocHJlc2VudDogSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZCwgcmVzIDogSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZCkgIDogbnVtYmVyIHtcbiAgaWYoISgocHJlc2VudC5ydWxlLm1hdGNoZWRTdHJpbmcgPT09IHJlcy5ydWxlLm1hdGNoZWRTdHJpbmcpXG4gICAgJiYgKHByZXNlbnQucnVsZS5jYXRlZ29yeSA9PT0gcmVzLnJ1bGUuY2F0ZWdvcnkpXG4gICAgJiYgKHByZXNlbnQuc3BhbiA9PT0gcmVzLnNwYW4pXG4gICYmIChwcmVzZW50LnJ1bGUuYml0aW5kZXggPT09IHJlcy5ydWxlLmJpdGluZGV4KSkpIHtcbiAgICAgIHJldHVybiAwO1xuICB9XG4gIGlmKHByZXNlbnQuX3JhbmtpbmcgPCByZXMuX3JhbmtpbmcpIHtcbiAgICByZXR1cm4gLTE7XG4gIH1cbiAgcmV0dXJuICsxO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VJZ25vcmVPckFwcGVuZChyZXN1bHQgOiBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkW10sIHJlcyA6IElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWQpIHtcbiAgdmFyIGluc2VydGluZGV4ID0gLTE7XG4gIHZhciBmb3VuZE5vdGhpbmcgPSByZXN1bHQuZXZlcnkoIChwcmVzZW50LGluZGV4KSA9PiB7XG4gICAgdmFyIHIgPSBpc1NhbWVSZXMocHJlc2VudCxyZXMpO1xuICAgIGlmIChyIDwgMCkge1xuICAgICAgLy9jb25zb2xlLmxvZyhcIm92ZXJ3cml0aW5nIHdvcnNlIFxcblwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSArICdcXG4nICsgSlNPTi5zdHJpbmdpZnkocHJlc2VudCkrICdcXG4nKTtcbiAgICAgIHJlc3VsdFtpbmRleF0gPSByZXM7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSBlbHNlIGlmKHIgPiAwKSB7XG4gICAgICAvL2NvbnNvbGUubG9nKCdza2lwcGluZyBwcmVzZW50Jyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9KTtcbiAgaWYoZm91bmROb3RoaW5nKSB7XG4gICAgLy9kZWJ1bG9nKCdwdXNoaW5nJyk7XG4gICAgcmVzdWx0LnB1c2gocmVzKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbih0b2tlbnM6IHN0cmluZ1tdLCBmdXNhYmxlOiBib29sZWFuW10sIGNhdGVnb3JpemVkV29yZHM6IElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWRbXVtdKSB7XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uLi4uIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRXb3JkcykpIDogJy0nKTtcbiAgY2F0ZWdvcml6ZWRXb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkbGlzdCwgaW5kZXgpIHtcbiAgICB3b3JkbGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkKSB7XG4gICAgICBpZiAod29yZC5ydWxlLnJhbmdlKSB7XG4gICAgICAgIC8vY29uc29sZS5sb2coYCBnb3QgdGFyZ2V0aW5kZXggZm9yIFJhbmdlUnVsZXMgZXZhbHVhdGlvbiA6ICR7dGFyZ2V0SW5kZXh9ICR7aW5kZXh9ICR7ZnVzYWJsZS5qb2luKFwiIFwiKX1gKTtcbiAgICAgICAgdmFyIHRhcmdldEluZGV4ID0gYnJlYWtkb3duLmlzQ29tYmluYWJsZVJhbmdlUmV0dXJuSW5kZXgod29yZC5ydWxlLnJhbmdlLCBmdXNhYmxlLCBpbmRleCk7XG4gICAgICAgIC8vY29uc29sZS5sb2coYCBnb3QgdGFyZ2V0aW5kZXggZm9yIFJhbmdlUnVsZXMgZXZhbHVhdGlvbiA6ICR7dGFyZ2V0SW5kZXh9YCk7XG4gICAgICAgIGlmICh0YXJnZXRJbmRleCA+PSAwKSB7XG4gICAgICAgICAgdmFyIGNvbWJpbmVkV29yZCA9IGJyZWFrZG93bi5jb21iaW5lVG9rZW5zKHdvcmQucnVsZS5yYW5nZSwgaW5kZXgsIHRva2Vucyk7XG4gICAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChgIHRlc3QgXCIke2NvbWJpbmVkV29yZH1cIiBhZ2FpbnN0IFwiJHt3b3JkLnJ1bGUucmFuZ2UucnVsZS5sb3dlcmNhc2V3b3JkfVwiICR7SlNPTi5zdHJpbmdpZnkod29yZC5ydWxlLnJhbmdlLnJ1bGUpfWApIDogJy0nKTtcbiAgICAgICAgICB2YXIgcmVzID0gSW5wdXRGaWx0ZXIuY2F0ZWdvcml6ZVdvcmRXaXRoT2Zmc2V0V2l0aFJhbmtDdXRvZmZTaW5nbGUoY29tYmluZWRXb3JkLCB3b3JkLnJ1bGUucmFuZ2UucnVsZSk7XG4gICAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcIiBnb3QgcmVzIDogXCIgKyBKU09OLnN0cmluZ2lmeShyZXMpKSA6ICctJyk7XG4gICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgcmVzLnNwYW4gPSB3b3JkLnJ1bGUucmFuZ2UuaGlnaCAtIHdvcmQucnVsZS5yYW5nZS5sb3cgKyAxO1xuICAgICAgICAgICAgY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0gPSBjYXRlZ29yaXplZFdvcmRzW3RhcmdldEluZGV4XS5zbGljZSgwKTsgLy8gYXZvaWQgaW52YWxpZGF0aW9uIG9mIHNlZW5pdFxuICAgICAgICAgICAgZGVidWdsb2coYHB1c2hlZCBzdGggYXQgJHt0YXJnZXRJbmRleH1gKTtcbiAgICAgICAgICAgIG1lcmdlSWdub3JlT3JBcHBlbmQoY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0scmVzKTtcbiAgIC8vICAgICAgICAgY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0ucHVzaChyZXMpOyAvLyBjaGVjayB0aGF0IHRoaXMgZG9lcyBub3QgaW52YWxpZGF0ZSBzZWVuaXQhXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuICAvLyBmaWx0ZXIgYWxsIHJhbmdlIHJ1bGVzICFcbiAgY2F0ZWdvcml6ZWRXb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkbGlzdCwgaW5kZXgpIHtcbiAgICBjYXRlZ29yaXplZFdvcmRzW2luZGV4XSA9IHdvcmRsaXN0LmZpbHRlcih3b3JkID0+ICF3b3JkLnJ1bGUucmFuZ2UpO1xuICB9KTtcbn1cblxuXG5cblxuY29uc3QgY2xvbmUgPSB1dGlscy5jbG9uZURlZXA7XG5cblxuXG5cbmZ1bmN0aW9uIGNvcHlWZWNNZW1iZXJzKHUpIHtcbiAgdmFyIGkgPSAwO1xuICBmb3IgKGkgPSAwOyBpIDwgdS5sZW5ndGg7ICsraSkge1xuICAgIHVbaV0gPSBjbG9uZSh1W2ldKTtcbiAgfVxuICByZXR1cm4gdTtcbn1cblxuXG4vLyB3ZSBjYW4gcmVwbGljYXRlIHRoZSB0YWlsIG9yIHRoZSBoZWFkLFxuLy8gd2UgcmVwbGljYXRlIHRoZSB0YWlsIGFzIGl0IGlzIHNtYWxsZXIuXG4vLyBbYSxiLGMgXVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTcGFuVmVjKHZlYzogQXJyYXk8YW55PiwgaW5kZXg6IG51bWJlcikge1xuICB2YXIgZWZmZWN0aXZlbGVuID0gdmVjLnJlZHVjZSgocHJldiwgbWVtKSA9PiBwcmV2ICs9IG1lbS5zcGFuID8gbWVtLnNwYW4gOiAxLCAwKTtcbiAgcmV0dXJuIGVmZmVjdGl2ZWxlbiA+IGluZGV4O1xufVxuXG4vKipcbiAqIGV4cGFuZCBhbiBhcnJheSBbW2ExLGEyXSwgW2IxLGIyXSxbY11dXG4gKiBpbnRvIGFsbCBjb21iaW5hdGlvbnNcbiAqXG4gKiAgaWYgYTEgaGFzIGEgc3BhbiBvZiB0aHJlZSwgdGhlIHZhcmlhdGlvbnMgb2YgdGhlIGxvd2VyIGxheWVyIGFyZSBza2lwcGVkXG4gKlxuICogd2l0aCB0aGUgc3BlY2lhbCBwcm9wZXJ0eVxuICovXG5leHBvcnQgZnVuY3Rpb24gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXModG9rZW5zOiBzdHJpbmdbXSwgdG9rZW5NYXRjaGVzOiBBcnJheTxBcnJheTxhbnk+Pik6IElNYXRjaC5JUHJvY2Vzc2VkU2VudGVuY2VzIHtcbiAgdmFyIGEgPSBbXTtcbiAgdmFyIHdvcmRNYXRjaGVzID0gW107XG4gIGRlYnVnbG9nVihkZWJ1Z2xvZy5lbmFibGVkID8gSlNPTi5zdHJpbmdpZnkodG9rZW5NYXRjaGVzKSA6ICctJyk7XG4gIHRva2VuTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChhV29yZE1hdGNoZXMsIHdvcmRJbmRleDogbnVtYmVyKSB7XG4gICAgd29yZE1hdGNoZXNbd29yZEluZGV4XSA9IFtdO1xuICAgIGFXb3JkTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZFZhcmlhbnQsIHdvcmRWYXJpYW50SW5kZXg6IG51bWJlcikge1xuICAgICAgd29yZE1hdGNoZXNbd29yZEluZGV4XVt3b3JkVmFyaWFudEluZGV4XSA9IG9Xb3JkVmFyaWFudDtcbiAgICB9KTtcbiAgfSk7XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeSh0b2tlbk1hdGNoZXMpIDogJy0nKTtcbiAgdmFyIHJlc3VsdCA9IHtcbiAgICBlcnJvcnM6IFtdLFxuICAgIHRva2VuczogdG9rZW5zLFxuICAgIHNlbnRlbmNlczogW11cbiAgfSBhcyBJTWF0Y2guSVByb2Nlc3NlZFNlbnRlbmNlcztcbiAgdmFyIG52ZWNzID0gW107XG4gIHZhciByZXMgPSBbW11dO1xuICAvLyB2YXIgbnZlY3MgPSBbXTtcbiAgdmFyIHJ2ZWMgPSBbXTtcbiAgZm9yICh2YXIgdG9rZW5JbmRleCA9IDA7IHRva2VuSW5kZXggPCB0b2tlbk1hdGNoZXMubGVuZ3RoOyArK3Rva2VuSW5kZXgpIHsgLy8gd29yZGcgaW5kZXgga1xuICAgIC8vdmVjcyBpcyB0aGUgdmVjdG9yIG9mIGFsbCBzbyBmYXIgc2VlbiB2YXJpYW50cyB1cCB0byBrIGxlbmd0aC5cbiAgICB2YXIgbmV4dEJhc2UgPSBbXTtcbiAgICAvL2luZGVwZW5kZW50IG9mIGV4aXN0ZW5jZSBvZiBtYXRjaGVzIG9uIGxldmVsIGssIHdlIHJldGFpbiBhbGwgdmVjdG9ycyB3aGljaCBhcmUgY292ZXJlZCBieSBhIHNwYW5cbiAgICAvLyB3ZSBza2lwIGV4dGVuZGluZyB0aGVtIGJlbG93XG4gICAgZm9yICh2YXIgdSA9IDA7IHUgPCByZXMubGVuZ3RoOyArK3UpIHtcbiAgICAgIGlmIChpc1NwYW5WZWMocmVzW3VdLCB0b2tlbkluZGV4KSkge1xuICAgICAgICBuZXh0QmFzZS5wdXNoKHJlc1t1XSk7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBsZW5NYXRjaGVzID0gdG9rZW5NYXRjaGVzW3Rva2VuSW5kZXhdLmxlbmd0aDtcbiAgICBpZiAobmV4dEJhc2UubGVuZ3RoID09PSAwICYmIGxlbk1hdGNoZXMgPT09IDApIHtcbiAgICAgIC8vIHRoZSB3b3JkIGF0IGluZGV4IEkgY2Fubm90IGJlIHVuZGVyc3Rvb2RcbiAgICAgIGlmIChyZXN1bHQuZXJyb3JzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXN1bHQuZXJyb3JzLnB1c2goRVJFcnJvci5tYWtlRXJyb3JfTk9fS05PV05fV09SRCh0b2tlbkluZGV4LCB0b2tlbnMpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIgbCA9IDA7IGwgPCBsZW5NYXRjaGVzOyArK2wpIHsgLy8gZm9yIGVhY2ggdmFyaWFudCBwcmVzZW50IGF0IGluZGV4IGtcbiAgICAgIC8vZGVidWdsb2coXCJ2ZWNzIG5vd1wiICsgSlNPTi5zdHJpbmdpZnkodmVjcykpO1xuICAgICAgdmFyIG52ZWNzID0gW107IC8vdmVjcy5zbGljZSgpOyAvLyBjb3B5IHRoZSB2ZWNbaV0gYmFzZSB2ZWN0b3I7XG4gICAgICAvL2RlYnVnbG9nKFwidmVjcyBjb3BpZWQgbm93XCIgKyBKU09OLnN0cmluZ2lmeShudmVjcykpO1xuICAgICAgZm9yICh2YXIgdSA9IDA7IHUgPCByZXMubGVuZ3RoOyArK3UpIHtcbiAgICAgICAgaWYgKCFpc1NwYW5WZWMocmVzW3VdLCB0b2tlbkluZGV4KSkge1xuICAgICAgICAgIC8vIGZvciBlYWNoIHNvIGZhciBjb25zdHJ1Y3RlZCByZXN1bHQgKG9mIGxlbmd0aCBrKSBpbiByZXNcbiAgICAgICAgICBudmVjcy5wdXNoKHJlc1t1XS5zbGljZSgpKTsgLy8gbWFrZSBhIGNvcHkgb2YgZWFjaCB2ZWN0b3JcbiAgICAgICAgICBudmVjc1tudmVjcy5sZW5ndGggLSAxXSA9IGNvcHlWZWNNZW1iZXJzKG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdKTtcbiAgICAgICAgICAvLyBkZWJ1Z2xvZyhcImNvcGllZCB2ZWNzW1wiKyB1K1wiXVwiICsgSlNPTi5zdHJpbmdpZnkodmVjc1t1XSkpO1xuICAgICAgICAgIG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdLnB1c2goXG4gICAgICAgICAgICBjbG9uZSh0b2tlbk1hdGNoZXNbdG9rZW5JbmRleF1bbF0pKTsgLy8gcHVzaCB0aGUgbHRoIHZhcmlhbnRcbiAgICAgICAgICAvLyBkZWJ1Z2xvZyhcIm5vdyBudmVjcyBcIiArIG52ZWNzLmxlbmd0aCArIFwiIFwiICsgSlNPTi5zdHJpbmdpZnkobnZlY3MpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gICBkZWJ1Z2xvZyhcIiBhdCAgICAgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbmV4dGJhc2UgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKVxuICAgICAgLy8gICBkZWJ1Z2xvZyhcIiBhcHBlbmQgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbnZlY3MgICAgPlwiICsgSlNPTi5zdHJpbmdpZnkobnZlY3MpKVxuICAgICAgbmV4dEJhc2UgPSBuZXh0QmFzZS5jb25jYXQobnZlY3MpO1xuICAgICAgLy8gICBkZWJ1Z2xvZyhcIiAgcmVzdWx0IFwiICsgayArIFwiOlwiICsgbCArIFwiIG52ZWNzICAgID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSlcbiAgICB9IC8vY29uc3RydVxuICAgIC8vICBkZWJ1Z2xvZyhcIm5vdyBhdCBcIiArIGsgKyBcIjpcIiArIGwgKyBcIiA+XCIgKyBKU09OLnN0cmluZ2lmeShuZXh0QmFzZSkpXG4gICAgcmVzID0gbmV4dEJhc2U7XG4gIH1cbiAgZGVidWdsb2dWKGRlYnVnbG9nVi5lbmFibGVkID8gKFwiQVBQRU5ESU5HIFRPIFJFU1wiICsgMCArIFwiOlwiICsgbCArIFwiID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSkgOiAnLScpO1xuICByZXN1bHQuc2VudGVuY2VzID0gcmVzO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBwcm9jZXNzU3RyaW5nKHF1ZXJ5OiBzdHJpbmcsIHJ1bGVzOiBJTWF0Y2guU3BsaXRSdWxlcyxcbiB3b3JkczogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nPiB9XG4pOiAgSU1hdGNoLklQcm9jZXNzZWRTZW50ZW5jZXMge1xuICB3b3JkcyA9IHdvcmRzIHx8IHt9O1xuICB2YXIgdG9rZW5TdHJ1Y3QgPSB0b2tlbml6ZVN0cmluZyhxdWVyeSwgcnVsZXMsIHdvcmRzKTtcbiAgZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbih0b2tlblN0cnVjdC50b2tlbnMsIHRva2VuU3RydWN0LmZ1c2FibGUsXG4gICAgdG9rZW5TdHJ1Y3QuY2F0ZWdvcml6ZWRXb3Jkcyk7XG4gIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgZGVidWdsb2coXCJBZnRlciBtYXRjaGVkIFwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5TdHJ1Y3QuY2F0ZWdvcml6ZWRXb3JkcykpO1xuICB9XG4gIHZhciBhU2VudGVuY2VzID0gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXModG9rZW5TdHJ1Y3QudG9rZW5zLCB0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKTtcbiAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICBkZWJ1Z2xvZyhcImFmdGVyIGV4cGFuZFwiICsgYVNlbnRlbmNlcy5zZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICByZXR1cm4gU2VudGVuY2UucmFua2luZ1Byb2R1Y3Qob1NlbnRlbmNlKSArIFwiOlwiICsgU2VudGVuY2UuZHVtcE5pY2Uob1NlbnRlbmNlKTsgLy9KU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICB9XG4gIGFTZW50ZW5jZXMuc2VudGVuY2VzID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMuc2VudGVuY2VzKTtcbiAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlcy5zZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgIH0pLmpvaW4oXCJcXG5cIikpO1xuICB9XG4gIHJldHVybiBhU2VudGVuY2VzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2ltcGxpZnlTZW50ZW5jZShyZXMpIHtcbiAgcmV0dXJuIHJlcy5tYXAoZnVuY3Rpb24gKHIpIHtcbiAgICByZXR1cm4gci5tYXAod29yZCA9PiB7IHJldHVybiB3b3JkLnN0cmluZyArICc9PicgKyB3b3JkLm1hdGNoZWRTdHJpbmcgKyAnLycgKyB3b3JkLmNhdGVnb3J5ICsgKHdvcmQuc3BhbiA/ICcvJyArIHdvcmQuc3BhbiA6ICcnKSB9KVxuICB9KTtcbn1cbiIsIi8qKlxuICpcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmFuYWx5emVcbiAqIEBmaWxlIGVyYmFzZVxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICpcbiAqIEJhc2ljIGRvbWFpbiBiYXNlZCBlbnRpdHkgcmVjb2duaXRpb25cbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgSW5wdXRGaWx0ZXIgPSByZXF1aXJlKFwiLi9pbnB1dEZpbHRlclwiKTtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdlcmJhc2UnKTtcbnZhciBkZWJ1Z2xvZ1YgPSBkZWJ1ZygnZXJiYXNlJyk7XG52YXIgcGVyZmxvZyA9IGRlYnVnKCdwZXJmJyk7XG52YXIgYnJlYWtkb3duID0gcmVxdWlyZShcIi4vYnJlYWtkb3duXCIpO1xudmFyIEVSRXJyb3IgPSByZXF1aXJlKFwiLi9lcmVycm9yXCIpO1xudmFyIEFueU9iamVjdCA9IE9iamVjdDtcbnZhciB1dGlscyA9IHJlcXVpcmUoXCIuLi91dGlscy91dGlsc1wiKTtcbnZhciBTZW50ZW5jZSA9IHJlcXVpcmUoXCIuL3NlbnRlbmNlXCIpO1xuLyoqXG4gKiBHaXZlbiBhICBzdHJpbmcsIGJyZWFrIGl0IGRvd24gaW50byBjb21wb25lbnRzLFxuICogW1snQScsICdCJ10sIFsnQSBCJ11dXG4gKlxuICogdGhlbiBjYXRlZ29yaXplV29yZHNcbiAqIHJldHVybmluZ1xuICpcbiAqIFsgW1sgeyBjYXRlZ29yeTogJ3N5c3RlbUlkJywgd29yZCA6ICdBJ30sXG4gKiAgICAgIHsgY2F0ZWdvcnk6ICdvdGhlcnRoaW5nJywgd29yZCA6ICdBJ31cbiAqICAgIF0sXG4gKiAgICAvLyByZXN1bHQgb2YgQlxuICogICAgWyB7IGNhdGVnb3J5OiAnc3lzdGVtSWQnLCB3b3JkIDogJ0InfSxcbiAqICAgICAgeyBjYXRlZ29yeTogJ290aGVydGhpbmcnLCB3b3JkIDogJ0EnfVxuICogICAgICB7IGNhdGVnb3J5OiAnYW5vdGhlcnRyeXAnLCB3b3JkIDogJ0InfVxuICogICAgXVxuICogICBdLFxuICogXV1dXG4gKlxuICpcbiAqXG4gKi9cbmZ1bmN0aW9uIHRva2VuaXplU3RyaW5nKHNTdHJpbmcsIHJ1bGVzLCB3b3Jkcykge1xuICAgIHZhciBjbnQgPSAwO1xuICAgIHZhciBmYWMgPSAxO1xuICAgIHZhciB0b2tlbnMgPSBicmVha2Rvd24udG9rZW5pemVTdHJpbmcoc1N0cmluZyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICAgICAgZGVidWdsb2coXCJoZXJlIGJyZWFrZG93blwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5zKSk7XG4gICAgfVxuICAgIC8vY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkodSkpO1xuICAgIHdvcmRzID0gd29yZHMgfHwge307XG4gICAgcGVyZmxvZygndGhpcyBtYW55IGtub3duIHdvcmRzOiAnICsgT2JqZWN0LmtleXMod29yZHMpLmxlbmd0aCk7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHZhciBjbnRSZWMgPSB7fTtcbiAgICB2YXIgY2F0ZWdvcml6ZWRTZW50ZW5jZSA9IFtdO1xuICAgIHZhciBoYXNSZWNvbWJpbmVkID0gZmFsc2U7XG4gICAgdG9rZW5zLnRva2Vucy5mb3JFYWNoKGZ1bmN0aW9uICh0b2tlbiwgaW5kZXgpIHtcbiAgICAgICAgdmFyIHNlZW5JdCA9IElucHV0RmlsdGVyLmNhdGVnb3JpemVBV29yZFdpdGhPZmZzZXRzKHRva2VuLCBydWxlcywgc1N0cmluZywgd29yZHMsIGNudFJlYyk7XG4gICAgICAgIC8qIGNhbm5vdCBoYXZlIHRoaXMsIG9yIG5lZWQgdG8gYWRkIGFsbCBmcmFnbWVudCB3b3JkcyBcIlVJMiBJbnRlZ3JhdGlvblwiICBpZihzZWVuSXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKi9cbiAgICAgICAgaGFzUmVjb21iaW5lZCA9IGhhc1JlY29tYmluZWQgfHwgIXNlZW5JdC5ldmVyeShmdW5jdGlvbiAocmVzKSB7IHJldHVybiAhcmVzLnJ1bGUucmFuZ2U7IH0pO1xuICAgICAgICBkZWJ1Z2xvZyhcIiBjYXRlZ29yaXplZCBcIiArIHRva2VuICsgXCIvXCIgKyBpbmRleCArIFwiIHRvIFwiICsgSlNPTi5zdHJpbmdpZnkoc2Vlbkl0KSk7XG4gICAgICAgIGNhdGVnb3JpemVkU2VudGVuY2VbaW5kZXhdID0gc2Vlbkl0O1xuICAgICAgICBjbnQgPSBjbnQgKyBzZWVuSXQubGVuZ3RoO1xuICAgICAgICBmYWMgPSBmYWMgKiBzZWVuSXQubGVuZ3RoO1xuICAgIH0pO1xuICAgIC8vIGhhdmUgc2VlbiB0aGUgcGxhaW4gY2F0ZWdvcml6YXRpb24sXG4gICAgZGVidWdsb2coXCIgc2VudGVuY2VzIFwiICsgdG9rZW5zLnRva2Vucy5sZW5ndGggKyBcIiBtYXRjaGVzIFwiICsgY250ICsgXCIgZmFjOiBcIiArIGZhYyk7XG4gICAgaWYgKGRlYnVnbG9nLmVuYWJsZWQgJiYgdG9rZW5zLnRva2Vucy5sZW5ndGgpIHtcbiAgICAgICAgZGVidWdsb2coXCJmaXJzdCBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KHRva2VucywgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBcIiBwcmlvciBSYW5nZVJ1bGUgXCIgKyBKU09OLnN0cmluZ2lmeShjYXRlZ29yaXplZFNlbnRlbmNlKSArIFwiIFwiIDogJy0nKTtcbiAgICBpZiAoaGFzUmVjb21iaW5lZCkge1xuICAgICAgICBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2Vucy50b2tlbnMsIHRva2Vucy5mdXNhYmxlLCBjYXRlZ29yaXplZFNlbnRlbmNlKTtcbiAgICB9XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IFwiIGFmdGVyIFJhbmdlUnVsZSBcIiArIEpTT04uc3RyaW5naWZ5KGNhdGVnb3JpemVkU2VudGVuY2UpICsgXCIgXCIgOiAnLScpO1xuICAgIHBlcmZsb2coXCIgc2VudGVuY2VzIFwiICsgdG9rZW5zLnRva2Vucy5sZW5ndGggKyBcIiAvIFwiICsgcmVzLmxlbmd0aCArIFwiIG1hdGNoZXMgXCIgKyBjbnQgKyBcIiBmYWM6IFwiICsgZmFjICsgXCIgcmVjIDogXCIgKyBKU09OLnN0cmluZ2lmeShjbnRSZWMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiB7XG4gICAgICAgIGZ1c2FibGU6IHRva2Vucy5mdXNhYmxlLFxuICAgICAgICB0b2tlbnM6IHRva2Vucy50b2tlbnMsXG4gICAgICAgIGNhdGVnb3JpemVkV29yZHM6IGNhdGVnb3JpemVkU2VudGVuY2VcbiAgICB9O1xufVxuZXhwb3J0cy50b2tlbml6ZVN0cmluZyA9IHRva2VuaXplU3RyaW5nO1xuZnVuY3Rpb24gaXNTYW1lUmVzKHByZXNlbnQsIHJlcykge1xuICAgIGlmICghKChwcmVzZW50LnJ1bGUubWF0Y2hlZFN0cmluZyA9PT0gcmVzLnJ1bGUubWF0Y2hlZFN0cmluZylcbiAgICAgICAgJiYgKHByZXNlbnQucnVsZS5jYXRlZ29yeSA9PT0gcmVzLnJ1bGUuY2F0ZWdvcnkpXG4gICAgICAgICYmIChwcmVzZW50LnNwYW4gPT09IHJlcy5zcGFuKVxuICAgICAgICAmJiAocHJlc2VudC5ydWxlLmJpdGluZGV4ID09PSByZXMucnVsZS5iaXRpbmRleCkpKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICBpZiAocHJlc2VudC5fcmFua2luZyA8IHJlcy5fcmFua2luZykge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIHJldHVybiArMTtcbn1cbmV4cG9ydHMuaXNTYW1lUmVzID0gaXNTYW1lUmVzO1xuZnVuY3Rpb24gbWVyZ2VJZ25vcmVPckFwcGVuZChyZXN1bHQsIHJlcykge1xuICAgIHZhciBpbnNlcnRpbmRleCA9IC0xO1xuICAgIHZhciBmb3VuZE5vdGhpbmcgPSByZXN1bHQuZXZlcnkoZnVuY3Rpb24gKHByZXNlbnQsIGluZGV4KSB7XG4gICAgICAgIHZhciByID0gaXNTYW1lUmVzKHByZXNlbnQsIHJlcyk7XG4gICAgICAgIGlmIChyIDwgMCkge1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIm92ZXJ3cml0aW5nIHdvcnNlIFxcblwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSArICdcXG4nICsgSlNPTi5zdHJpbmdpZnkocHJlc2VudCkrICdcXG4nKTtcbiAgICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSByZXM7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAociA+IDApIHtcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ3NraXBwaW5nIHByZXNlbnQnKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgICBpZiAoZm91bmROb3RoaW5nKSB7XG4gICAgICAgIC8vZGVidWxvZygncHVzaGluZycpO1xuICAgICAgICByZXN1bHQucHVzaChyZXMpO1xuICAgIH1cbn1cbmV4cG9ydHMubWVyZ2VJZ25vcmVPckFwcGVuZCA9IG1lcmdlSWdub3JlT3JBcHBlbmQ7XG5mdW5jdGlvbiBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2VucywgZnVzYWJsZSwgY2F0ZWdvcml6ZWRXb3Jkcykge1xuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uLi4uIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRXb3JkcykpIDogJy0nKTtcbiAgICBjYXRlZ29yaXplZFdvcmRzLmZvckVhY2goZnVuY3Rpb24gKHdvcmRsaXN0LCBpbmRleCkge1xuICAgICAgICB3b3JkbGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkKSB7XG4gICAgICAgICAgICBpZiAod29yZC5ydWxlLnJhbmdlKSB7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgIGdvdCB0YXJnZXRpbmRleCBmb3IgUmFuZ2VSdWxlcyBldmFsdWF0aW9uIDogJHt0YXJnZXRJbmRleH0gJHtpbmRleH0gJHtmdXNhYmxlLmpvaW4oXCIgXCIpfWApO1xuICAgICAgICAgICAgICAgIHZhciB0YXJnZXRJbmRleCA9IGJyZWFrZG93bi5pc0NvbWJpbmFibGVSYW5nZVJldHVybkluZGV4KHdvcmQucnVsZS5yYW5nZSwgZnVzYWJsZSwgaW5kZXgpO1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYCBnb3QgdGFyZ2V0aW5kZXggZm9yIFJhbmdlUnVsZXMgZXZhbHVhdGlvbiA6ICR7dGFyZ2V0SW5kZXh9YCk7XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldEluZGV4ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkV29yZCA9IGJyZWFrZG93bi5jb21iaW5lVG9rZW5zKHdvcmQucnVsZS5yYW5nZSwgaW5kZXgsIHRva2Vucyk7XG4gICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCIgdGVzdCBcXFwiXCIgKyBjb21iaW5lZFdvcmQgKyBcIlxcXCIgYWdhaW5zdCBcXFwiXCIgKyB3b3JkLnJ1bGUucmFuZ2UucnVsZS5sb3dlcmNhc2V3b3JkICsgXCJcXFwiIFwiICsgSlNPTi5zdHJpbmdpZnkod29yZC5ydWxlLnJhbmdlLnJ1bGUpKSA6ICctJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBJbnB1dEZpbHRlci5jYXRlZ29yaXplV29yZFdpdGhPZmZzZXRXaXRoUmFua0N1dG9mZlNpbmdsZShjb21iaW5lZFdvcmQsIHdvcmQucnVsZS5yYW5nZS5ydWxlKTtcbiAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcIiBnb3QgcmVzIDogXCIgKyBKU09OLnN0cmluZ2lmeShyZXMpKSA6ICctJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5zcGFuID0gd29yZC5ydWxlLnJhbmdlLmhpZ2ggLSB3b3JkLnJ1bGUucmFuZ2UubG93ICsgMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGVnb3JpemVkV29yZHNbdGFyZ2V0SW5kZXhdID0gY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0uc2xpY2UoMCk7IC8vIGF2b2lkIGludmFsaWRhdGlvbiBvZiBzZWVuaXRcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwicHVzaGVkIHN0aCBhdCBcIiArIHRhcmdldEluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlSWdub3JlT3JBcHBlbmQoY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0sIHJlcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIC8vIGZpbHRlciBhbGwgcmFuZ2UgcnVsZXMgIVxuICAgIGNhdGVnb3JpemVkV29yZHMuZm9yRWFjaChmdW5jdGlvbiAod29yZGxpc3QsIGluZGV4KSB7XG4gICAgICAgIGNhdGVnb3JpemVkV29yZHNbaW5kZXhdID0gd29yZGxpc3QuZmlsdGVyKGZ1bmN0aW9uICh3b3JkKSB7IHJldHVybiAhd29yZC5ydWxlLnJhbmdlOyB9KTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbiA9IGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb247XG52YXIgY2xvbmUgPSB1dGlscy5jbG9uZURlZXA7XG5mdW5jdGlvbiBjb3B5VmVjTWVtYmVycyh1KSB7XG4gICAgdmFyIGkgPSAwO1xuICAgIGZvciAoaSA9IDA7IGkgPCB1Lmxlbmd0aDsgKytpKSB7XG4gICAgICAgIHVbaV0gPSBjbG9uZSh1W2ldKTtcbiAgICB9XG4gICAgcmV0dXJuIHU7XG59XG4vLyB3ZSBjYW4gcmVwbGljYXRlIHRoZSB0YWlsIG9yIHRoZSBoZWFkLFxuLy8gd2UgcmVwbGljYXRlIHRoZSB0YWlsIGFzIGl0IGlzIHNtYWxsZXIuXG4vLyBbYSxiLGMgXVxuZnVuY3Rpb24gaXNTcGFuVmVjKHZlYywgaW5kZXgpIHtcbiAgICB2YXIgZWZmZWN0aXZlbGVuID0gdmVjLnJlZHVjZShmdW5jdGlvbiAocHJldiwgbWVtKSB7IHJldHVybiBwcmV2ICs9IG1lbS5zcGFuID8gbWVtLnNwYW4gOiAxOyB9LCAwKTtcbiAgICByZXR1cm4gZWZmZWN0aXZlbGVuID4gaW5kZXg7XG59XG5leHBvcnRzLmlzU3BhblZlYyA9IGlzU3BhblZlYztcbi8qKlxuICogZXhwYW5kIGFuIGFycmF5IFtbYTEsYTJdLCBbYjEsYjJdLFtjXV1cbiAqIGludG8gYWxsIGNvbWJpbmF0aW9uc1xuICpcbiAqICBpZiBhMSBoYXMgYSBzcGFuIG9mIHRocmVlLCB0aGUgdmFyaWF0aW9ucyBvZiB0aGUgbG93ZXIgbGF5ZXIgYXJlIHNraXBwZWRcbiAqXG4gKiB3aXRoIHRoZSBzcGVjaWFsIHByb3BlcnR5XG4gKi9cbmZ1bmN0aW9uIGV4cGFuZFRva2VuTWF0Y2hlc1RvU2VudGVuY2VzKHRva2VucywgdG9rZW5NYXRjaGVzKSB7XG4gICAgdmFyIGEgPSBbXTtcbiAgICB2YXIgd29yZE1hdGNoZXMgPSBbXTtcbiAgICBkZWJ1Z2xvZ1YoZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHRva2VuTWF0Y2hlcykgOiAnLScpO1xuICAgIHRva2VuTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChhV29yZE1hdGNoZXMsIHdvcmRJbmRleCkge1xuICAgICAgICB3b3JkTWF0Y2hlc1t3b3JkSW5kZXhdID0gW107XG4gICAgICAgIGFXb3JkTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZFZhcmlhbnQsIHdvcmRWYXJpYW50SW5kZXgpIHtcbiAgICAgICAgICAgIHdvcmRNYXRjaGVzW3dvcmRJbmRleF1bd29yZFZhcmlhbnRJbmRleF0gPSBvV29yZFZhcmlhbnQ7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeSh0b2tlbk1hdGNoZXMpIDogJy0nKTtcbiAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICBlcnJvcnM6IFtdLFxuICAgICAgICB0b2tlbnM6IHRva2VucyxcbiAgICAgICAgc2VudGVuY2VzOiBbXVxuICAgIH07XG4gICAgdmFyIG52ZWNzID0gW107XG4gICAgdmFyIHJlcyA9IFtbXV07XG4gICAgLy8gdmFyIG52ZWNzID0gW107XG4gICAgdmFyIHJ2ZWMgPSBbXTtcbiAgICBmb3IgKHZhciB0b2tlbkluZGV4ID0gMDsgdG9rZW5JbmRleCA8IHRva2VuTWF0Y2hlcy5sZW5ndGg7ICsrdG9rZW5JbmRleCkge1xuICAgICAgICAvL3ZlY3MgaXMgdGhlIHZlY3RvciBvZiBhbGwgc28gZmFyIHNlZW4gdmFyaWFudHMgdXAgdG8gayBsZW5ndGguXG4gICAgICAgIHZhciBuZXh0QmFzZSA9IFtdO1xuICAgICAgICAvL2luZGVwZW5kZW50IG9mIGV4aXN0ZW5jZSBvZiBtYXRjaGVzIG9uIGxldmVsIGssIHdlIHJldGFpbiBhbGwgdmVjdG9ycyB3aGljaCBhcmUgY292ZXJlZCBieSBhIHNwYW5cbiAgICAgICAgLy8gd2Ugc2tpcCBleHRlbmRpbmcgdGhlbSBiZWxvd1xuICAgICAgICBmb3IgKHZhciB1ID0gMDsgdSA8IHJlcy5sZW5ndGg7ICsrdSkge1xuICAgICAgICAgICAgaWYgKGlzU3BhblZlYyhyZXNbdV0sIHRva2VuSW5kZXgpKSB7XG4gICAgICAgICAgICAgICAgbmV4dEJhc2UucHVzaChyZXNbdV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBsZW5NYXRjaGVzID0gdG9rZW5NYXRjaGVzW3Rva2VuSW5kZXhdLmxlbmd0aDtcbiAgICAgICAgaWYgKG5leHRCYXNlLmxlbmd0aCA9PT0gMCAmJiBsZW5NYXRjaGVzID09PSAwKSB7XG4gICAgICAgICAgICAvLyB0aGUgd29yZCBhdCBpbmRleCBJIGNhbm5vdCBiZSB1bmRlcnN0b29kXG4gICAgICAgICAgICBpZiAocmVzdWx0LmVycm9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXN1bHQuZXJyb3JzLnB1c2goRVJFcnJvci5tYWtlRXJyb3JfTk9fS05PV05fV09SRCh0b2tlbkluZGV4LCB0b2tlbnMpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBsID0gMDsgbCA8IGxlbk1hdGNoZXM7ICsrbCkge1xuICAgICAgICAgICAgLy9kZWJ1Z2xvZyhcInZlY3Mgbm93XCIgKyBKU09OLnN0cmluZ2lmeSh2ZWNzKSk7XG4gICAgICAgICAgICB2YXIgbnZlY3MgPSBbXTsgLy92ZWNzLnNsaWNlKCk7IC8vIGNvcHkgdGhlIHZlY1tpXSBiYXNlIHZlY3RvcjtcbiAgICAgICAgICAgIC8vZGVidWdsb2coXCJ2ZWNzIGNvcGllZCBub3dcIiArIEpTT04uc3RyaW5naWZ5KG52ZWNzKSk7XG4gICAgICAgICAgICBmb3IgKHZhciB1ID0gMDsgdSA8IHJlcy5sZW5ndGg7ICsrdSkge1xuICAgICAgICAgICAgICAgIGlmICghaXNTcGFuVmVjKHJlc1t1XSwgdG9rZW5JbmRleCkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gZm9yIGVhY2ggc28gZmFyIGNvbnN0cnVjdGVkIHJlc3VsdCAob2YgbGVuZ3RoIGspIGluIHJlc1xuICAgICAgICAgICAgICAgICAgICBudmVjcy5wdXNoKHJlc1t1XS5zbGljZSgpKTsgLy8gbWFrZSBhIGNvcHkgb2YgZWFjaCB2ZWN0b3JcbiAgICAgICAgICAgICAgICAgICAgbnZlY3NbbnZlY3MubGVuZ3RoIC0gMV0gPSBjb3B5VmVjTWVtYmVycyhudmVjc1tudmVjcy5sZW5ndGggLSAxXSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIGRlYnVnbG9nKFwiY29waWVkIHZlY3NbXCIrIHUrXCJdXCIgKyBKU09OLnN0cmluZ2lmeSh2ZWNzW3VdKSk7XG4gICAgICAgICAgICAgICAgICAgIG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdLnB1c2goY2xvbmUodG9rZW5NYXRjaGVzW3Rva2VuSW5kZXhdW2xdKSk7IC8vIHB1c2ggdGhlIGx0aCB2YXJpYW50XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gICBkZWJ1Z2xvZyhcIiBhdCAgICAgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbmV4dGJhc2UgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKVxuICAgICAgICAgICAgLy8gICBkZWJ1Z2xvZyhcIiBhcHBlbmQgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbnZlY3MgICAgPlwiICsgSlNPTi5zdHJpbmdpZnkobnZlY3MpKVxuICAgICAgICAgICAgbmV4dEJhc2UgPSBuZXh0QmFzZS5jb25jYXQobnZlY3MpO1xuICAgICAgICB9IC8vY29uc3RydVxuICAgICAgICAvLyAgZGVidWdsb2coXCJub3cgYXQgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKVxuICAgICAgICByZXMgPSBuZXh0QmFzZTtcbiAgICB9XG4gICAgZGVidWdsb2dWKGRlYnVnbG9nVi5lbmFibGVkID8gKFwiQVBQRU5ESU5HIFRPIFJFU1wiICsgMCArIFwiOlwiICsgbCArIFwiID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSkgOiAnLScpO1xuICAgIHJlc3VsdC5zZW50ZW5jZXMgPSByZXM7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbmV4cG9ydHMuZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXMgPSBleHBhbmRUb2tlbk1hdGNoZXNUb1NlbnRlbmNlcztcbmZ1bmN0aW9uIHByb2Nlc3NTdHJpbmcocXVlcnksIHJ1bGVzLCB3b3Jkcykge1xuICAgIHdvcmRzID0gd29yZHMgfHwge307XG4gICAgdmFyIHRva2VuU3RydWN0ID0gdG9rZW5pemVTdHJpbmcocXVlcnksIHJ1bGVzLCB3b3Jkcyk7XG4gICAgZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbih0b2tlblN0cnVjdC50b2tlbnMsIHRva2VuU3RydWN0LmZ1c2FibGUsIHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXMgPSBleHBhbmRUb2tlbk1hdGNoZXNUb1NlbnRlbmNlcyh0b2tlblN0cnVjdC50b2tlbnMsIHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgZXhwYW5kXCIgKyBhU2VudGVuY2VzLnNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIFNlbnRlbmNlLmR1bXBOaWNlKG9TZW50ZW5jZSk7IC8vSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIGFTZW50ZW5jZXMuc2VudGVuY2VzID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMuc2VudGVuY2VzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlcy5zZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICB9XG4gICAgcmV0dXJuIGFTZW50ZW5jZXM7XG59XG5leHBvcnRzLnByb2Nlc3NTdHJpbmcgPSBwcm9jZXNzU3RyaW5nO1xuZnVuY3Rpb24gc2ltcGxpZnlTZW50ZW5jZShyZXMpIHtcbiAgICByZXR1cm4gcmVzLm1hcChmdW5jdGlvbiAocikge1xuICAgICAgICByZXR1cm4gci5tYXAoZnVuY3Rpb24gKHdvcmQpIHsgcmV0dXJuIHdvcmQuc3RyaW5nICsgJz0+JyArIHdvcmQubWF0Y2hlZFN0cmluZyArICcvJyArIHdvcmQuY2F0ZWdvcnkgKyAod29yZC5zcGFuID8gJy8nICsgd29yZC5zcGFuIDogJycpOyB9KTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuc2ltcGxpZnlTZW50ZW5jZSA9IHNpbXBsaWZ5U2VudGVuY2U7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
