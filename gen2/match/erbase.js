/**
 *
 * @module jfseb.fdevstart.analyze
 * @file erbase
 * @copyright (c) 2016 Gerd Forstmann
 *
 * Basic domain based entity recognition
 */
"use strict";

var InputFilter = require("./inputFilter");
var debug = require("debug");
var debuglog = debug('erbase');
var debuglogV = debug('erbase');
var perflog = debug('perf');
var breakdown = require("./breakdown");
var ERError = require("./ererror");
var AnyObject = Object;
function mockDebug(o) {
    debuglog = o;
    debuglogV = o;
    perflog = o;
}
exports.mockDebug = mockDebug;
var utils = require("../utils/utils");
var Sentence = require("./sentence");
/**
 * Given a  string, break it down into components,
 * [['A', 'B'], ['A B']]
 *
 * then categorizeWords
 * returning
 *
 * [ [[ { category: 'systemId', word : 'A'},
 *      { category: 'otherthing', word : 'A'}
 *    ],
 *    // result of B
 *    [ { category: 'systemId', word : 'B'},
 *      { category: 'otherthing', word : 'A'}
 *      { category: 'anothertryp', word : 'B'}
 *    ]
 *   ],
 * ]]]
 *
 *
 *
 */
function tokenizeString(sString, rules, words) {
    var cnt = 0;
    var fac = 1;
    var tokens = breakdown.tokenizeString(sString);
    if (debuglog.enabled) {
        debuglog("here breakdown" + JSON.stringify(tokens));
    }
    //console.log(JSON.stringify(u));
    words = words || {};
    perflog('this many known words: ' + Object.keys(words).length);
    var res = [];
    var cntRec = {};
    var categorizedSentence = [];
    var hasRecombined = false;
    tokens.tokens.forEach(function (token, index) {
        var seenIt = InputFilter.categorizeAWordWithOffsets(token, rules, sString, words, cntRec);
        /* cannot have this, or need to add all fragment words "UI2 Integration"  if(seenIt.length === 0) {
              return false;
            }
        */
        hasRecombined = hasRecombined || !seenIt.every(function (res) {
            return !res.rule.range;
        });
        debuglog(" categorized " + token + "/" + index + " to " + JSON.stringify(seenIt));
        categorizedSentence[index] = seenIt;
        cnt = cnt + seenIt.length;
        fac = fac * seenIt.length;
    });
    // have seen the plain categorization,
    debuglog(" sentences " + tokens.tokens.length + " matches " + cnt + " fac: " + fac);
    if (debuglog.enabled && tokens.tokens.length) {
        debuglog("first match " + JSON.stringify(tokens, undefined, 2));
    }
    debuglog(debuglog.enabled ? " prior RangeRule " + JSON.stringify(categorizedSentence) + " " : '-');
    if (hasRecombined) {
        evaluateRangeRulesToPosition(tokens.tokens, tokens.fusable, categorizedSentence);
    }
    debuglog(debuglog.enabled ? " after RangeRule " + JSON.stringify(categorizedSentence) + " " : '-');
    perflog(" sentences " + tokens.tokens.length + " / " + res.length + " matches " + cnt + " fac: " + fac + " rec : " + JSON.stringify(cntRec, undefined, 2));
    return {
        fusable: tokens.fusable,
        tokens: tokens.tokens,
        categorizedWords: categorizedSentence
    };
}
exports.tokenizeString = tokenizeString;
function isSameRes(present, res) {
    if (!(present.rule.matchedString === res.rule.matchedString && present.rule.category === res.rule.category && present.span === res.span && present.rule.bitindex === res.rule.bitindex)) {
        return 0;
    }
    if (present._ranking < res._ranking) {
        return -1;
    }
    return +1;
}
exports.isSameRes = isSameRes;
function mergeIgnoreOrAppend(result, res) {
    var insertindex = -1;
    var foundNothing = result.every(function (present, index) {
        var r = isSameRes(present, res);
        if (r < 0) {
            //console.log("overwriting worse \n" + JSON.stringify(res) + '\n' + JSON.stringify(present)+ '\n');
            result[index] = res;
            return false;
        } else if (r > 0) {
            //console.log('skipping present');
            return false;
        }
        return true;
    });
    if (foundNothing) {
        //debulog('pushing');
        result.push(res);
    }
}
exports.mergeIgnoreOrAppend = mergeIgnoreOrAppend;
function evaluateRangeRulesToPosition(tokens, fusable, categorizedWords) {
    debuglog(debuglog.enabled ? "evaluateRangeRulesToPosition... " + JSON.stringify(categorizedWords) : '-');
    categorizedWords.forEach(function (wordlist, index) {
        wordlist.forEach(function (word) {
            if (word.rule.range) {
                //console.log(` got targetindex for RangeRules evaluation : ${targetIndex} ${index} ${fusable.join(" ")}`);
                var targetIndex = breakdown.isCombinableRangeReturnIndex(word.rule.range, fusable, index);
                //console.log(` got targetindex for RangeRules evaluation : ${targetIndex}`);
                if (targetIndex >= 0) {
                    var combinedWord = breakdown.combineTokens(word.rule.range, index, tokens);
                    debuglog(debuglog.enabled ? " test \"" + combinedWord + "\" against \"" + word.rule.range.rule.lowercaseword + "\" " + JSON.stringify(word.rule.range.rule) : '-');
                    var res = InputFilter.categorizeWordWithOffsetWithRankCutoffSingle(combinedWord, word.rule.range.rule);
                    debuglog(debuglog.enabled ? " got res : " + JSON.stringify(res) : '-');
                    if (res) {
                        res.span = word.rule.range.high - word.rule.range.low + 1;
                        categorizedWords[targetIndex] = categorizedWords[targetIndex].slice(0); // avoid invalidation of seenit
                        debuglog("pushed sth at " + targetIndex);
                        mergeIgnoreOrAppend(categorizedWords[targetIndex], res);
                    }
                }
            }
        });
    });
    // filter all range rules !
    categorizedWords.forEach(function (wordlist, index) {
        categorizedWords[index] = wordlist.filter(function (word) {
            return !word.rule.range;
        });
    });
}
exports.evaluateRangeRulesToPosition = evaluateRangeRulesToPosition;
var clone = utils.cloneDeep;
function copyVecMembers(u) {
    var i = 0;
    for (i = 0; i < u.length; ++i) {
        u[i] = clone(u[i]);
    }
    return u;
}
// we can replicate the tail or the head,
// we replicate the tail as it is smaller.
// [a,b,c ]
function isSpanVec(vec, index) {
    var effectivelen = vec.reduce(function (prev, mem) {
        return prev += mem.span ? mem.span : 1;
    }, 0);
    return effectivelen > index;
}
exports.isSpanVec = isSpanVec;
/**
 * expand an array [[a1,a2], [b1,b2],[c]]
 * into all combinations
 *
 *  if a1 has a span of three, the variations of the lower layer are skipped
 *
 * with the special property
 */
function expandTokenMatchesToSentences(tokens, tokenMatches) {
    var a = [];
    var wordMatches = [];
    debuglogV(debuglog.enabled ? JSON.stringify(tokenMatches) : '-');
    tokenMatches.forEach(function (aWordMatches, wordIndex) {
        wordMatches[wordIndex] = [];
        aWordMatches.forEach(function (oWordVariant, wordVariantIndex) {
            wordMatches[wordIndex][wordVariantIndex] = oWordVariant;
        });
    });
    debuglog(debuglog.enabled ? JSON.stringify(tokenMatches) : '-');
    var result = {
        errors: [],
        tokens: tokens,
        sentences: []
    };
    var nvecs = [];
    var res = [[]];
    // var nvecs = [];
    var rvec = [];
    for (var tokenIndex = 0; tokenIndex < tokenMatches.length; ++tokenIndex) {
        //vecs is the vector of all so far seen variants up to k length.
        var nextBase = [];
        //independent of existence of matches on level k, we retain all vectors which are covered by a span
        // we skip extending them below
        for (var u = 0; u < res.length; ++u) {
            if (isSpanVec(res[u], tokenIndex)) {
                nextBase.push(res[u]);
            }
        }
        var lenMatches = tokenMatches[tokenIndex].length;
        if (nextBase.length === 0 && lenMatches === 0) {
            // the word at index I cannot be understood
            //if (result.errors.length === 0) {
            result.errors.push(ERError.makeError_NO_KNOWN_WORD(tokenIndex, tokens));
        }
        for (var l = 0; l < lenMatches; ++l) {
            //debuglog("vecs now" + JSON.stringify(vecs));
            var nvecs = []; //vecs.slice(); // copy the vec[i] base vector;
            //debuglog("vecs copied now" + JSON.stringify(nvecs));
            for (var u = 0; u < res.length; ++u) {
                if (!isSpanVec(res[u], tokenIndex)) {
                    // for each so far constructed result (of length k) in res
                    nvecs.push(res[u].slice()); // make a copy of each vector
                    nvecs[nvecs.length - 1] = copyVecMembers(nvecs[nvecs.length - 1]);
                    // debuglog("copied vecs["+ u+"]" + JSON.stringify(vecs[u]));
                    nvecs[nvecs.length - 1].push(clone(tokenMatches[tokenIndex][l])); // push the lth variant
                }
            }
            //   debuglog(" at     " + k + ":" + l + " nextbase >" + JSON.stringify(nextBase))
            //   debuglog(" append " + k + ":" + l + " nvecs    >" + JSON.stringify(nvecs))
            nextBase = nextBase.concat(nvecs);
        } //constru
        //  debuglog("now at " + k + ":" + l + " >" + JSON.stringify(nextBase))
        res = nextBase;
    }
    debuglogV(debuglogV.enabled ? "APPENDING TO RES" + 0 + ":" + l + " >" + JSON.stringify(nextBase) : '-');
    result.sentences = res;
    return result;
}
exports.expandTokenMatchesToSentences = expandTokenMatchesToSentences;
function processString(query, rules, words) {
    words = words || {};
    var tokenStruct = tokenizeString(query, rules, words);
    evaluateRangeRulesToPosition(tokenStruct.tokens, tokenStruct.fusable, tokenStruct.categorizedWords);
    if (debuglog.enabled) {
        debuglog("After matched " + JSON.stringify(tokenStruct.categorizedWords));
    }
    var aSentences = expandTokenMatchesToSentences(tokenStruct.tokens, tokenStruct.categorizedWords);
    if (debuglog.enabled) {
        debuglog("after expand" + aSentences.sentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + Sentence.dumpNice(oSentence); //JSON.stringify(oSentence);
        }).join("\n"));
    }
    aSentences.sentences = InputFilter.reinForce(aSentences.sentences);
    if (debuglog.enabled) {
        debuglog("after reinforce" + aSentences.sentences.map(function (oSentence) {
            return Sentence.rankingProduct(oSentence) + ":" + JSON.stringify(oSentence);
        }).join("\n"));
    }
    return aSentences;
}
exports.processString = processString;
function simplifySentence(res) {
    return res.map(function (r) {
        return r.map(function (word) {
            return word.string + '=>' + word.matchedString + '/' + word.category + (word.span ? '/' + word.span : '');
        });
    });
}
exports.simplifySentence = simplifySentence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9lcmJhc2UudHMiLCJtYXRjaC9lcmJhc2UuanMiXSwibmFtZXMiOlsiSW5wdXRGaWx0ZXIiLCJyZXF1aXJlIiwiZGVidWciLCJkZWJ1Z2xvZyIsImRlYnVnbG9nViIsInBlcmZsb2ciLCJicmVha2Rvd24iLCJFUkVycm9yIiwiQW55T2JqZWN0IiwiT2JqZWN0IiwibW9ja0RlYnVnIiwibyIsImV4cG9ydHMiLCJ1dGlscyIsIlNlbnRlbmNlIiwidG9rZW5pemVTdHJpbmciLCJzU3RyaW5nIiwicnVsZXMiLCJ3b3JkcyIsImNudCIsImZhYyIsInRva2VucyIsImVuYWJsZWQiLCJKU09OIiwic3RyaW5naWZ5Iiwia2V5cyIsImxlbmd0aCIsInJlcyIsImNudFJlYyIsImNhdGVnb3JpemVkU2VudGVuY2UiLCJoYXNSZWNvbWJpbmVkIiwiZm9yRWFjaCIsInRva2VuIiwiaW5kZXgiLCJzZWVuSXQiLCJjYXRlZ29yaXplQVdvcmRXaXRoT2Zmc2V0cyIsImV2ZXJ5IiwicnVsZSIsInJhbmdlIiwidW5kZWZpbmVkIiwiZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbiIsImZ1c2FibGUiLCJjYXRlZ29yaXplZFdvcmRzIiwiaXNTYW1lUmVzIiwicHJlc2VudCIsIm1hdGNoZWRTdHJpbmciLCJjYXRlZ29yeSIsInNwYW4iLCJiaXRpbmRleCIsIl9yYW5raW5nIiwibWVyZ2VJZ25vcmVPckFwcGVuZCIsInJlc3VsdCIsImluc2VydGluZGV4IiwiZm91bmROb3RoaW5nIiwiciIsInB1c2giLCJ3b3JkbGlzdCIsIndvcmQiLCJ0YXJnZXRJbmRleCIsImlzQ29tYmluYWJsZVJhbmdlUmV0dXJuSW5kZXgiLCJjb21iaW5lZFdvcmQiLCJjb21iaW5lVG9rZW5zIiwibG93ZXJjYXNld29yZCIsImNhdGVnb3JpemVXb3JkV2l0aE9mZnNldFdpdGhSYW5rQ3V0b2ZmU2luZ2xlIiwiaGlnaCIsImxvdyIsInNsaWNlIiwiZmlsdGVyIiwiY2xvbmUiLCJjbG9uZURlZXAiLCJjb3B5VmVjTWVtYmVycyIsInUiLCJpIiwiaXNTcGFuVmVjIiwidmVjIiwiZWZmZWN0aXZlbGVuIiwicmVkdWNlIiwicHJldiIsIm1lbSIsImV4cGFuZFRva2VuTWF0Y2hlc1RvU2VudGVuY2VzIiwidG9rZW5NYXRjaGVzIiwiYSIsIndvcmRNYXRjaGVzIiwiYVdvcmRNYXRjaGVzIiwid29yZEluZGV4Iiwib1dvcmRWYXJpYW50Iiwid29yZFZhcmlhbnRJbmRleCIsImVycm9ycyIsInNlbnRlbmNlcyIsIm52ZWNzIiwicnZlYyIsInRva2VuSW5kZXgiLCJuZXh0QmFzZSIsImxlbk1hdGNoZXMiLCJtYWtlRXJyb3JfTk9fS05PV05fV09SRCIsImwiLCJjb25jYXQiLCJwcm9jZXNzU3RyaW5nIiwicXVlcnkiLCJ0b2tlblN0cnVjdCIsImFTZW50ZW5jZXMiLCJtYXAiLCJvU2VudGVuY2UiLCJyYW5raW5nUHJvZHVjdCIsImR1bXBOaWNlIiwiam9pbiIsInJlaW5Gb3JjZSIsInNpbXBsaWZ5U2VudGVuY2UiLCJzdHJpbmciXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQ1FBOztBREVBLElBQUFBLGNBQUFDLFFBQUEsZUFBQSxDQUFBO0FBRUEsSUFBQUMsUUFBQUQsUUFBQSxPQUFBLENBQUE7QUFJQSxJQUFJRSxXQUFXRCxNQUFNLFFBQU4sQ0FBZjtBQUNBLElBQUlFLFlBQVlGLE1BQU0sUUFBTixDQUFoQjtBQUNBLElBQUlHLFVBQVVILE1BQU0sTUFBTixDQUFkO0FBRUEsSUFBQUksWUFBQUwsUUFBQSxhQUFBLENBQUE7QUFDQSxJQUFBTSxVQUFBTixRQUFBLFdBQUEsQ0FBQTtBQUVBLElBQU1PLFlBQWlCQyxNQUF2QjtBQUVBLFNBQUFDLFNBQUEsQ0FBMEJDLENBQTFCLEVBQTJCO0FBQ3pCUixlQUFXUSxDQUFYO0FBQ0FQLGdCQUFZTyxDQUFaO0FBQ0FOLGNBQVVNLENBQVY7QUFDRDtBQUpEQyxRQUFBRixTQUFBLEdBQUFBLFNBQUE7QUFPQSxJQUFBRyxRQUFBWixRQUFBLGdCQUFBLENBQUE7QUFNQSxJQUFBYSxXQUFBYixRQUFBLFlBQUEsQ0FBQTtBQWlDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBcUJBLFNBQUFjLGNBQUEsQ0FBK0JDLE9BQS9CLEVBQWdEQyxLQUFoRCxFQUNFQyxLQURGLEVBQzREO0FBRTFELFFBQUlDLE1BQU0sQ0FBVjtBQUNBLFFBQUlDLE1BQU0sQ0FBVjtBQUNBLFFBQUlDLFNBQVNmLFVBQVVTLGNBQVYsQ0FBeUJDLE9BQXpCLENBQWI7QUFDQSxRQUFJYixTQUFTbUIsT0FBYixFQUFzQjtBQUNwQm5CLGlCQUFTLG1CQUFtQm9CLEtBQUtDLFNBQUwsQ0FBZUgsTUFBZixDQUE1QjtBQUNEO0FBQ0Q7QUFDQUgsWUFBUUEsU0FBUyxFQUFqQjtBQUNBYixZQUFRLDRCQUE0QkksT0FBT2dCLElBQVAsQ0FBWVAsS0FBWixFQUFtQlEsTUFBdkQ7QUFDQSxRQUFJQyxNQUFNLEVBQVY7QUFDQSxRQUFJQyxTQUFTLEVBQWI7QUFDQSxRQUFJQyxzQkFBc0IsRUFBMUI7QUFDQSxRQUFJQyxnQkFBZ0IsS0FBcEI7QUFDQVQsV0FBT0EsTUFBUCxDQUFjVSxPQUFkLENBQXNCLFVBQVVDLEtBQVYsRUFBaUJDLEtBQWpCLEVBQXNCO0FBQzFDLFlBQUlDLFNBQVNsQyxZQUFZbUMsMEJBQVosQ0FBdUNILEtBQXZDLEVBQThDZixLQUE5QyxFQUFxREQsT0FBckQsRUFBOERFLEtBQTlELEVBQXFFVSxNQUFyRSxDQUFiO0FBQ0E7Ozs7QUFJQUUsd0JBQWdCQSxpQkFBaUIsQ0FBQ0ksT0FBT0UsS0FBUCxDQUFhLFVBQUFULEdBQUEsRUFBRztBQUFJLG1CQUFBLENBQUNBLElBQUlVLElBQUosQ0FBU0MsS0FBVjtBQUFlLFNBQW5DLENBQWxDO0FBQ0FuQyxpQkFBUyxrQkFBZ0I2QixLQUFoQixHQUFxQixHQUFyQixHQUF5QkMsS0FBekIsR0FBOEIsTUFBOUIsR0FBdUNWLEtBQUtDLFNBQUwsQ0FBZVUsTUFBZixDQUFoRDtBQUNBTCw0QkFBb0JJLEtBQXBCLElBQTZCQyxNQUE3QjtBQUNBZixjQUFNQSxNQUFNZSxPQUFPUixNQUFuQjtBQUNBTixjQUFNQSxNQUFNYyxPQUFPUixNQUFuQjtBQUNELEtBWEQ7QUFZQTtBQUNBdkIsYUFBUyxnQkFBZ0JrQixPQUFPQSxNQUFQLENBQWNLLE1BQTlCLEdBQXVDLFdBQXZDLEdBQXFEUCxHQUFyRCxHQUEyRCxRQUEzRCxHQUFzRUMsR0FBL0U7QUFDQSxRQUFJakIsU0FBU21CLE9BQVQsSUFBb0JELE9BQU9BLE1BQVAsQ0FBY0ssTUFBdEMsRUFBOEM7QUFDNUN2QixpQkFBUyxpQkFBaUJvQixLQUFLQyxTQUFMLENBQWVILE1BQWYsRUFBdUJrQixTQUF2QixFQUFrQyxDQUFsQyxDQUExQjtBQUNEO0FBQ0RwQyxhQUFTQSxTQUFTbUIsT0FBVCxHQUFtQixzQkFBb0JDLEtBQUtDLFNBQUwsQ0FBZUssbUJBQWYsQ0FBcEIsR0FBdUQsR0FBMUUsR0FBZ0YsR0FBekY7QUFDQSxRQUFJQyxhQUFKLEVBQW1CO0FBQ2pCVSxxQ0FBNkJuQixPQUFPQSxNQUFwQyxFQUE0Q0EsT0FBT29CLE9BQW5ELEVBQTREWixtQkFBNUQ7QUFDRDtBQUNEMUIsYUFBU0EsU0FBU21CLE9BQVQsR0FBbUIsc0JBQW9CQyxLQUFLQyxTQUFMLENBQWVLLG1CQUFmLENBQXBCLEdBQXVELEdBQTFFLEdBQWdGLEdBQXpGO0FBQ0F4QixZQUFRLGdCQUFnQmdCLE9BQU9BLE1BQVAsQ0FBY0ssTUFBOUIsR0FBdUMsS0FBdkMsR0FBK0NDLElBQUlELE1BQW5ELEdBQTRELFdBQTVELEdBQTBFUCxHQUExRSxHQUFnRixRQUFoRixHQUEyRkMsR0FBM0YsR0FBaUcsU0FBakcsR0FBNkdHLEtBQUtDLFNBQUwsQ0FBZUksTUFBZixFQUF1QlcsU0FBdkIsRUFBa0MsQ0FBbEMsQ0FBckg7QUFDQSxXQUFPO0FBQ0xFLGlCQUFTcEIsT0FBT29CLE9BRFg7QUFFTHBCLGdCQUFRQSxPQUFPQSxNQUZWO0FBR0xxQiwwQkFBa0JiO0FBSGIsS0FBUDtBQUtEO0FBNUNEakIsUUFBQUcsY0FBQSxHQUFBQSxjQUFBO0FBOENBLFNBQUE0QixTQUFBLENBQTBCQyxPQUExQixFQUFvRWpCLEdBQXBFLEVBQXlHO0FBQ3ZHLFFBQUcsRUFBR2lCLFFBQVFQLElBQVIsQ0FBYVEsYUFBYixLQUErQmxCLElBQUlVLElBQUosQ0FBU1EsYUFBekMsSUFDQ0QsUUFBUVAsSUFBUixDQUFhUyxRQUFiLEtBQTBCbkIsSUFBSVUsSUFBSixDQUFTUyxRQURwQyxJQUVDRixRQUFRRyxJQUFSLEtBQWlCcEIsSUFBSW9CLElBRnRCLElBR0RILFFBQVFQLElBQVIsQ0FBYVcsUUFBYixLQUEwQnJCLElBQUlVLElBQUosQ0FBU1csUUFIcEMsQ0FBSCxFQUdtRDtBQUMvQyxlQUFPLENBQVA7QUFDSDtBQUNELFFBQUdKLFFBQVFLLFFBQVIsR0FBbUJ0QixJQUFJc0IsUUFBMUIsRUFBb0M7QUFDbEMsZUFBTyxDQUFDLENBQVI7QUFDRDtBQUNELFdBQU8sQ0FBQyxDQUFSO0FBQ0Q7QUFYRHJDLFFBQUErQixTQUFBLEdBQUFBLFNBQUE7QUFhQSxTQUFBTyxtQkFBQSxDQUFvQ0MsTUFBcEMsRUFBZ0Z4QixHQUFoRixFQUFxSDtBQUNuSCxRQUFJeUIsY0FBYyxDQUFDLENBQW5CO0FBQ0EsUUFBSUMsZUFBZUYsT0FBT2YsS0FBUCxDQUFjLFVBQUNRLE9BQUQsRUFBU1gsS0FBVCxFQUFjO0FBQzdDLFlBQUlxQixJQUFJWCxVQUFVQyxPQUFWLEVBQWtCakIsR0FBbEIsQ0FBUjtBQUNBLFlBQUkyQixJQUFJLENBQVIsRUFBVztBQUNUO0FBQ0FILG1CQUFPbEIsS0FBUCxJQUFnQk4sR0FBaEI7QUFDQSxtQkFBTyxLQUFQO0FBQ0QsU0FKRCxNQUlPLElBQUcyQixJQUFJLENBQVAsRUFBVTtBQUNmO0FBQ0EsbUJBQU8sS0FBUDtBQUNEO0FBQ0QsZUFBTyxJQUFQO0FBQ0QsS0FYa0IsQ0FBbkI7QUFZQSxRQUFHRCxZQUFILEVBQWlCO0FBQ2Y7QUFDQUYsZUFBT0ksSUFBUCxDQUFZNUIsR0FBWjtBQUNEO0FBQ0Y7QUFsQkRmLFFBQUFzQyxtQkFBQSxHQUFBQSxtQkFBQTtBQW9CQSxTQUFBViw0QkFBQSxDQUE2Q25CLE1BQTdDLEVBQStEb0IsT0FBL0QsRUFBbUZDLGdCQUFuRixFQUF3STtBQUN0SXZDLGFBQVNBLFNBQVNtQixPQUFULEdBQW9CLHFDQUFxQ0MsS0FBS0MsU0FBTCxDQUFla0IsZ0JBQWYsQ0FBekQsR0FBNkYsR0FBdEc7QUFDQUEscUJBQWlCWCxPQUFqQixDQUF5QixVQUFVeUIsUUFBVixFQUFvQnZCLEtBQXBCLEVBQXlCO0FBQ2hEdUIsaUJBQVN6QixPQUFULENBQWlCLFVBQVUwQixJQUFWLEVBQWM7QUFDN0IsZ0JBQUlBLEtBQUtwQixJQUFMLENBQVVDLEtBQWQsRUFBcUI7QUFDbkI7QUFDQSxvQkFBSW9CLGNBQWNwRCxVQUFVcUQsNEJBQVYsQ0FBdUNGLEtBQUtwQixJQUFMLENBQVVDLEtBQWpELEVBQXdERyxPQUF4RCxFQUFpRVIsS0FBakUsQ0FBbEI7QUFDQTtBQUNBLG9CQUFJeUIsZUFBZSxDQUFuQixFQUFzQjtBQUNwQix3QkFBSUUsZUFBZXRELFVBQVV1RCxhQUFWLENBQXdCSixLQUFLcEIsSUFBTCxDQUFVQyxLQUFsQyxFQUF5Q0wsS0FBekMsRUFBZ0RaLE1BQWhELENBQW5CO0FBQ0FsQiw2QkFBU0EsU0FBU21CLE9BQVQsR0FBb0IsYUFBVXNDLFlBQVYsR0FBc0IsZUFBdEIsR0FBb0NILEtBQUtwQixJQUFMLENBQVVDLEtBQVYsQ0FBZ0JELElBQWhCLENBQXFCeUIsYUFBekQsR0FBc0UsS0FBdEUsR0FBMkV2QyxLQUFLQyxTQUFMLENBQWVpQyxLQUFLcEIsSUFBTCxDQUFVQyxLQUFWLENBQWdCRCxJQUEvQixDQUEvRixHQUF5SSxHQUFsSjtBQUNBLHdCQUFJVixNQUFNM0IsWUFBWStELDRDQUFaLENBQXlESCxZQUF6RCxFQUF1RUgsS0FBS3BCLElBQUwsQ0FBVUMsS0FBVixDQUFnQkQsSUFBdkYsQ0FBVjtBQUNBbEMsNkJBQVNBLFNBQVNtQixPQUFULEdBQW9CLGdCQUFnQkMsS0FBS0MsU0FBTCxDQUFlRyxHQUFmLENBQXBDLEdBQTJELEdBQXBFO0FBQ0Esd0JBQUlBLEdBQUosRUFBUztBQUNQQSw0QkFBSW9CLElBQUosR0FBV1UsS0FBS3BCLElBQUwsQ0FBVUMsS0FBVixDQUFnQjBCLElBQWhCLEdBQXVCUCxLQUFLcEIsSUFBTCxDQUFVQyxLQUFWLENBQWdCMkIsR0FBdkMsR0FBNkMsQ0FBeEQ7QUFDQXZCLHlDQUFpQmdCLFdBQWpCLElBQWdDaEIsaUJBQWlCZ0IsV0FBakIsRUFBOEJRLEtBQTlCLENBQW9DLENBQXBDLENBQWhDLENBRk8sQ0FFaUU7QUFDeEUvRCxpQ0FBUyxtQkFBaUJ1RCxXQUExQjtBQUNBUiw0Q0FBb0JSLGlCQUFpQmdCLFdBQWpCLENBQXBCLEVBQWtEL0IsR0FBbEQ7QUFFRDtBQUNGO0FBQ0Y7QUFDRixTQW5CRDtBQW9CRCxLQXJCRDtBQXNCQTtBQUNBZSxxQkFBaUJYLE9BQWpCLENBQXlCLFVBQVV5QixRQUFWLEVBQW9CdkIsS0FBcEIsRUFBeUI7QUFDaERTLHlCQUFpQlQsS0FBakIsSUFBMEJ1QixTQUFTVyxNQUFULENBQWdCLFVBQUFWLElBQUEsRUFBSTtBQUFJLG1CQUFBLENBQUNBLEtBQUtwQixJQUFMLENBQVVDLEtBQVg7QUFBZ0IsU0FBeEMsQ0FBMUI7QUFDRCxLQUZEO0FBR0Q7QUE1QkQxQixRQUFBNEIsNEJBQUEsR0FBQUEsNEJBQUE7QUFpQ0EsSUFBTTRCLFFBQVF2RCxNQUFNd0QsU0FBcEI7QUFLQSxTQUFBQyxjQUFBLENBQXdCQyxDQUF4QixFQUF5QjtBQUN2QixRQUFJQyxJQUFJLENBQVI7QUFDQSxTQUFLQSxJQUFJLENBQVQsRUFBWUEsSUFBSUQsRUFBRTdDLE1BQWxCLEVBQTBCLEVBQUU4QyxDQUE1QixFQUErQjtBQUM3QkQsVUFBRUMsQ0FBRixJQUFPSixNQUFNRyxFQUFFQyxDQUFGLENBQU4sQ0FBUDtBQUNEO0FBQ0QsV0FBT0QsQ0FBUDtBQUNEO0FBR0Q7QUFDQTtBQUNBO0FBRUEsU0FBQUUsU0FBQSxDQUEwQkMsR0FBMUIsRUFBMkN6QyxLQUEzQyxFQUF3RDtBQUN0RCxRQUFJMEMsZUFBZUQsSUFBSUUsTUFBSixDQUFXLFVBQUNDLElBQUQsRUFBT0MsR0FBUCxFQUFVO0FBQUssZUFBQUQsUUFBUUMsSUFBSS9CLElBQUosR0FBVytCLElBQUkvQixJQUFmLEdBQXNCLENBQTlCO0FBQStCLEtBQXpELEVBQTJELENBQTNELENBQW5CO0FBQ0EsV0FBTzRCLGVBQWUxQyxLQUF0QjtBQUNEO0FBSERyQixRQUFBNkQsU0FBQSxHQUFBQSxTQUFBO0FBS0E7Ozs7Ozs7O0FBUUEsU0FBQU0sNkJBQUEsQ0FBOEMxRCxNQUE5QyxFQUFnRTJELFlBQWhFLEVBQStGO0FBQzdGLFFBQUlDLElBQUksRUFBUjtBQUNBLFFBQUlDLGNBQWMsRUFBbEI7QUFDQTlFLGNBQVVELFNBQVNtQixPQUFULEdBQW1CQyxLQUFLQyxTQUFMLENBQWV3RCxZQUFmLENBQW5CLEdBQWtELEdBQTVEO0FBQ0FBLGlCQUFhakQsT0FBYixDQUFxQixVQUFVb0QsWUFBVixFQUF3QkMsU0FBeEIsRUFBeUM7QUFDNURGLG9CQUFZRSxTQUFaLElBQXlCLEVBQXpCO0FBQ0FELHFCQUFhcEQsT0FBYixDQUFxQixVQUFVc0QsWUFBVixFQUF3QkMsZ0JBQXhCLEVBQWdEO0FBQ25FSix3QkFBWUUsU0FBWixFQUF1QkUsZ0JBQXZCLElBQTJDRCxZQUEzQztBQUNELFNBRkQ7QUFHRCxLQUxEO0FBTUFsRixhQUFTQSxTQUFTbUIsT0FBVCxHQUFtQkMsS0FBS0MsU0FBTCxDQUFld0QsWUFBZixDQUFuQixHQUFrRCxHQUEzRDtBQUNBLFFBQUk3QixTQUFTO0FBQ1hvQyxnQkFBUSxFQURHO0FBRVhsRSxnQkFBUUEsTUFGRztBQUdYbUUsbUJBQVc7QUFIQSxLQUFiO0FBS0EsUUFBSUMsUUFBUSxFQUFaO0FBQ0EsUUFBSTlELE1BQU0sQ0FBQyxFQUFELENBQVY7QUFDQTtBQUNBLFFBQUkrRCxPQUFPLEVBQVg7QUFDQSxTQUFLLElBQUlDLGFBQWEsQ0FBdEIsRUFBeUJBLGFBQWFYLGFBQWF0RCxNQUFuRCxFQUEyRCxFQUFFaUUsVUFBN0QsRUFBeUU7QUFDdkU7QUFDQSxZQUFJQyxXQUFXLEVBQWY7QUFDQTtBQUNBO0FBQ0EsYUFBSyxJQUFJckIsSUFBSSxDQUFiLEVBQWdCQSxJQUFJNUMsSUFBSUQsTUFBeEIsRUFBZ0MsRUFBRTZDLENBQWxDLEVBQXFDO0FBQ25DLGdCQUFJRSxVQUFVOUMsSUFBSTRDLENBQUosQ0FBVixFQUFrQm9CLFVBQWxCLENBQUosRUFBbUM7QUFDakNDLHlCQUFTckMsSUFBVCxDQUFjNUIsSUFBSTRDLENBQUosQ0FBZDtBQUNEO0FBQ0Y7QUFDRCxZQUFJc0IsYUFBYWIsYUFBYVcsVUFBYixFQUF5QmpFLE1BQTFDO0FBQ0EsWUFBSWtFLFNBQVNsRSxNQUFULEtBQW9CLENBQXBCLElBQXlCbUUsZUFBZSxDQUE1QyxFQUErQztBQUM3QztBQUNBO0FBQ0ExQyxtQkFBT29DLE1BQVAsQ0FBY2hDLElBQWQsQ0FBbUJoRCxRQUFRdUYsdUJBQVIsQ0FBZ0NILFVBQWhDLEVBQTRDdEUsTUFBNUMsQ0FBbkI7QUFFRDtBQUNELGFBQUssSUFBSTBFLElBQUksQ0FBYixFQUFnQkEsSUFBSUYsVUFBcEIsRUFBZ0MsRUFBRUUsQ0FBbEMsRUFBcUM7QUFDbkM7QUFDQSxnQkFBSU4sUUFBUSxFQUFaLENBRm1DLENBRW5CO0FBQ2hCO0FBQ0EsaUJBQUssSUFBSWxCLElBQUksQ0FBYixFQUFnQkEsSUFBSTVDLElBQUlELE1BQXhCLEVBQWdDLEVBQUU2QyxDQUFsQyxFQUFxQztBQUNuQyxvQkFBSSxDQUFDRSxVQUFVOUMsSUFBSTRDLENBQUosQ0FBVixFQUFrQm9CLFVBQWxCLENBQUwsRUFBb0M7QUFDbEM7QUFDQUYsMEJBQU1sQyxJQUFOLENBQVc1QixJQUFJNEMsQ0FBSixFQUFPTCxLQUFQLEVBQVgsRUFGa0MsQ0FFTjtBQUM1QnVCLDBCQUFNQSxNQUFNL0QsTUFBTixHQUFlLENBQXJCLElBQTBCNEMsZUFBZW1CLE1BQU1BLE1BQU0vRCxNQUFOLEdBQWUsQ0FBckIsQ0FBZixDQUExQjtBQUNBO0FBQ0ErRCwwQkFBTUEsTUFBTS9ELE1BQU4sR0FBZSxDQUFyQixFQUF3QjZCLElBQXhCLENBQ0VhLE1BQU1ZLGFBQWFXLFVBQWIsRUFBeUJJLENBQXpCLENBQU4sQ0FERixFQUxrQyxDQU1LO0FBRXhDO0FBQ0Y7QUFDRDtBQUNBO0FBQ0FILHVCQUFXQSxTQUFTSSxNQUFULENBQWdCUCxLQUFoQixDQUFYO0FBRUQsU0FwQ3NFLENBb0NyRTtBQUNGO0FBQ0E5RCxjQUFNaUUsUUFBTjtBQUNEO0FBQ0R4RixjQUFVQSxVQUFVa0IsT0FBVixHQUFxQixxQkFBcUIsQ0FBckIsR0FBeUIsR0FBekIsR0FBK0J5RSxDQUEvQixHQUFtQyxJQUFuQyxHQUEwQ3hFLEtBQUtDLFNBQUwsQ0FBZW9FLFFBQWYsQ0FBL0QsR0FBMkYsR0FBckc7QUFDQXpDLFdBQU9xQyxTQUFQLEdBQW1CN0QsR0FBbkI7QUFDQSxXQUFPd0IsTUFBUDtBQUNEO0FBL0REdkMsUUFBQW1FLDZCQUFBLEdBQUFBLDZCQUFBO0FBa0VBLFNBQUFrQixhQUFBLENBQThCQyxLQUE5QixFQUE2Q2pGLEtBQTdDLEVBQ0NDLEtBREQsRUFDMkQ7QUFFekRBLFlBQVFBLFNBQVMsRUFBakI7QUFDQSxRQUFJaUYsY0FBY3BGLGVBQWVtRixLQUFmLEVBQXNCakYsS0FBdEIsRUFBNkJDLEtBQTdCLENBQWxCO0FBQ0FzQixpQ0FBNkIyRCxZQUFZOUUsTUFBekMsRUFBaUQ4RSxZQUFZMUQsT0FBN0QsRUFDRTBELFlBQVl6RCxnQkFEZDtBQUVBLFFBQUl2QyxTQUFTbUIsT0FBYixFQUFzQjtBQUNwQm5CLGlCQUFTLG1CQUFtQm9CLEtBQUtDLFNBQUwsQ0FBZTJFLFlBQVl6RCxnQkFBM0IsQ0FBNUI7QUFDRDtBQUNELFFBQUkwRCxhQUFhckIsOEJBQThCb0IsWUFBWTlFLE1BQTFDLEVBQWtEOEUsWUFBWXpELGdCQUE5RCxDQUFqQjtBQUNBLFFBQUl2QyxTQUFTbUIsT0FBYixFQUFzQjtBQUNwQm5CLGlCQUFTLGlCQUFpQmlHLFdBQVdaLFNBQVgsQ0FBcUJhLEdBQXJCLENBQXlCLFVBQVVDLFNBQVYsRUFBbUI7QUFDdEUsbUJBQU94RixTQUFTeUYsY0FBVCxDQUF3QkQsU0FBeEIsSUFBcUMsR0FBckMsR0FBMkN4RixTQUFTMEYsUUFBVCxDQUFrQkYsU0FBbEIsQ0FBbEQsQ0FEc0UsQ0FDVTtBQUMvRSxTQUZ5QixFQUV2QkcsSUFGdUIsQ0FFbEIsSUFGa0IsQ0FBMUI7QUFHRDtBQUNETCxlQUFXWixTQUFYLEdBQXVCeEYsWUFBWTBHLFNBQVosQ0FBc0JOLFdBQVdaLFNBQWpDLENBQXZCO0FBQ0EsUUFBSXJGLFNBQVNtQixPQUFiLEVBQXNCO0FBQ3BCbkIsaUJBQVMsb0JBQW9CaUcsV0FBV1osU0FBWCxDQUFxQmEsR0FBckIsQ0FBeUIsVUFBVUMsU0FBVixFQUFtQjtBQUN2RSxtQkFBT3hGLFNBQVN5RixjQUFULENBQXdCRCxTQUF4QixJQUFxQyxHQUFyQyxHQUEyQy9FLEtBQUtDLFNBQUwsQ0FBZThFLFNBQWYsQ0FBbEQ7QUFDRCxTQUY0QixFQUUxQkcsSUFGMEIsQ0FFckIsSUFGcUIsQ0FBN0I7QUFHRDtBQUNELFdBQU9MLFVBQVA7QUFDRDtBQXZCRHhGLFFBQUFxRixhQUFBLEdBQUFBLGFBQUE7QUF5QkEsU0FBQVUsZ0JBQUEsQ0FBaUNoRixHQUFqQyxFQUFvQztBQUNsQyxXQUFPQSxJQUFJMEUsR0FBSixDQUFRLFVBQVUvQyxDQUFWLEVBQVc7QUFDeEIsZUFBT0EsRUFBRStDLEdBQUYsQ0FBTSxVQUFBNUMsSUFBQSxFQUFJO0FBQU0sbUJBQU9BLEtBQUttRCxNQUFMLEdBQWMsSUFBZCxHQUFxQm5ELEtBQUtaLGFBQTFCLEdBQTBDLEdBQTFDLEdBQWdEWSxLQUFLWCxRQUFyRCxJQUFpRVcsS0FBS1YsSUFBTCxHQUFZLE1BQU1VLEtBQUtWLElBQXZCLEdBQThCLEVBQS9GLENBQVA7QUFBMkcsU0FBM0gsQ0FBUDtBQUNELEtBRk0sQ0FBUDtBQUdEO0FBSkRuQyxRQUFBK0YsZ0JBQUEsR0FBQUEsZ0JBQUEiLCJmaWxlIjoibWF0Y2gvZXJiYXNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgZXJiYXNlXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKlxuICogQmFzaWMgZG9tYWluIGJhc2VkIGVudGl0eSByZWNvZ25pdGlvblxuICovXG5cblxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXIgZnJvbSAnLi9pbnB1dEZpbHRlcic7XG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuXG5cbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdlcmJhc2UnKTtcbnZhciBkZWJ1Z2xvZ1YgPSBkZWJ1ZygnZXJiYXNlJyk7XG52YXIgcGVyZmxvZyA9IGRlYnVnKCdwZXJmJyk7XG5cbmltcG9ydCAqIGFzIGJyZWFrZG93biBmcm9tICcuL2JyZWFrZG93bic7XG5pbXBvcnQgKiBhcyBFUkVycm9yIGZyb20gJy4vZXJlcnJvcic7XG5cbmNvbnN0IEFueU9iamVjdCA9IDxhbnk+T2JqZWN0O1xuXG5leHBvcnQgZnVuY3Rpb24gbW9ja0RlYnVnKG8pIHtcbiAgZGVidWdsb2cgPSBvO1xuICBkZWJ1Z2xvZ1YgPSBvO1xuICBwZXJmbG9nID0gbztcbn1cblxuXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuLi91dGlscy91dGlscyc7XG5cbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuL2lmbWF0Y2gnO1xuXG5pbXBvcnQgKiBhcyBUb29sbWF0Y2hlciBmcm9tICcuL3Rvb2xtYXRjaGVyJztcblxuaW1wb3J0ICogYXMgU2VudGVuY2UgZnJvbSAnLi9zZW50ZW5jZSc7XG5cbmltcG9ydCAqIGFzIFdvcmQgZnJvbSAnLi93b3JkJztcblxuaW1wb3J0ICogYXMgQWxnb2wgZnJvbSAnLi9hbGdvbCc7XG5cblxuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi9tYXRjaCc7XG5cblxuaW50ZXJmYWNlIElUb2tlbml6ZWRTdHJpbmcge1xuICB0b2tlbnM6IHN0cmluZ1tdLFxuICBjYXRlZ29yaXplZFdvcmRzOiBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkW11bXVxuICBmdXNhYmxlOiBib29sZWFuW107XG59XG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG4vKipcbiAqIEdpdmVuIGEgIHN0cmluZywgYnJlYWsgaXQgZG93biBpbnRvIGNvbXBvbmVudHMsXG4gKiBbWydBJywgJ0InXSwgWydBIEInXV1cbiAqXG4gKiB0aGVuIGNhdGVnb3JpemVXb3Jkc1xuICogcmV0dXJuaW5nXG4gKlxuICogWyBbWyB7IGNhdGVnb3J5OiAnc3lzdGVtSWQnLCB3b3JkIDogJ0EnfSxcbiAqICAgICAgeyBjYXRlZ29yeTogJ290aGVydGhpbmcnLCB3b3JkIDogJ0EnfVxuICogICAgXSxcbiAqICAgIC8vIHJlc3VsdCBvZiBCXG4gKiAgICBbIHsgY2F0ZWdvcnk6ICdzeXN0ZW1JZCcsIHdvcmQgOiAnQid9LFxuICogICAgICB7IGNhdGVnb3J5OiAnb3RoZXJ0aGluZycsIHdvcmQgOiAnQSd9XG4gKiAgICAgIHsgY2F0ZWdvcnk6ICdhbm90aGVydHJ5cCcsIHdvcmQgOiAnQid9XG4gKiAgICBdXG4gKiAgIF0sXG4gKiBdXV1cbiAqXG4gKlxuICpcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRva2VuaXplU3RyaW5nKHNTdHJpbmc6IHN0cmluZywgcnVsZXM6IElNYXRjaC5TcGxpdFJ1bGVzLFxuICB3b3JkczogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nPiB9KVxuICA6IElUb2tlbml6ZWRTdHJpbmcge1xuICB2YXIgY250ID0gMDtcbiAgdmFyIGZhYyA9IDE7XG4gIHZhciB0b2tlbnMgPSBicmVha2Rvd24udG9rZW5pemVTdHJpbmcoc1N0cmluZyk7XG4gIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgZGVidWdsb2coXCJoZXJlIGJyZWFrZG93blwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5zKSk7XG4gIH1cbiAgLy9jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh1KSk7XG4gIHdvcmRzID0gd29yZHMgfHwge307XG4gIHBlcmZsb2coJ3RoaXMgbWFueSBrbm93biB3b3JkczogJyArIE9iamVjdC5rZXlzKHdvcmRzKS5sZW5ndGgpO1xuICB2YXIgcmVzID0gW10gYXMgSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZFtdW107XG4gIHZhciBjbnRSZWMgPSB7fTtcbiAgdmFyIGNhdGVnb3JpemVkU2VudGVuY2UgPSBbXSBhcyBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkW11bXTtcbiAgdmFyIGhhc1JlY29tYmluZWQgPSBmYWxzZTtcbiAgdG9rZW5zLnRva2Vucy5mb3JFYWNoKGZ1bmN0aW9uICh0b2tlbiwgaW5kZXgpIHtcbiAgICB2YXIgc2Vlbkl0ID0gSW5wdXRGaWx0ZXIuY2F0ZWdvcml6ZUFXb3JkV2l0aE9mZnNldHModG9rZW4sIHJ1bGVzLCBzU3RyaW5nLCB3b3JkcywgY250UmVjKTtcbiAgICAvKiBjYW5ub3QgaGF2ZSB0aGlzLCBvciBuZWVkIHRvIGFkZCBhbGwgZnJhZ21lbnQgd29yZHMgXCJVSTIgSW50ZWdyYXRpb25cIiAgaWYoc2Vlbkl0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICovXG4gICAgaGFzUmVjb21iaW5lZCA9IGhhc1JlY29tYmluZWQgfHwgIXNlZW5JdC5ldmVyeShyZXMgPT4gIXJlcy5ydWxlLnJhbmdlKTtcbiAgICBkZWJ1Z2xvZyhgIGNhdGVnb3JpemVkICR7dG9rZW59LyR7aW5kZXh9IHRvIGAgKyBKU09OLnN0cmluZ2lmeShzZWVuSXQpKTtcbiAgICBjYXRlZ29yaXplZFNlbnRlbmNlW2luZGV4XSA9IHNlZW5JdDtcbiAgICBjbnQgPSBjbnQgKyBzZWVuSXQubGVuZ3RoO1xuICAgIGZhYyA9IGZhYyAqIHNlZW5JdC5sZW5ndGg7XG4gIH0pO1xuICAvLyBoYXZlIHNlZW4gdGhlIHBsYWluIGNhdGVnb3JpemF0aW9uLFxuICBkZWJ1Z2xvZyhcIiBzZW50ZW5jZXMgXCIgKyB0b2tlbnMudG9rZW5zLmxlbmd0aCArIFwiIG1hdGNoZXMgXCIgKyBjbnQgKyBcIiBmYWM6IFwiICsgZmFjKTtcbiAgaWYgKGRlYnVnbG9nLmVuYWJsZWQgJiYgdG9rZW5zLnRva2Vucy5sZW5ndGgpIHtcbiAgICBkZWJ1Z2xvZyhcImZpcnN0IG1hdGNoIFwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5zLCB1bmRlZmluZWQsIDIpKTtcbiAgfVxuICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gYCBwcmlvciBSYW5nZVJ1bGUgJHtKU09OLnN0cmluZ2lmeShjYXRlZ29yaXplZFNlbnRlbmNlKX0gYCA6ICctJyk7XG4gIGlmIChoYXNSZWNvbWJpbmVkKSB7XG4gICAgZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbih0b2tlbnMudG9rZW5zLCB0b2tlbnMuZnVzYWJsZSwgY2F0ZWdvcml6ZWRTZW50ZW5jZSk7XG4gIH1cbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IGAgYWZ0ZXIgUmFuZ2VSdWxlICR7SlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRTZW50ZW5jZSl9IGAgOiAnLScpO1xuICBwZXJmbG9nKFwiIHNlbnRlbmNlcyBcIiArIHRva2Vucy50b2tlbnMubGVuZ3RoICsgXCIgLyBcIiArIHJlcy5sZW5ndGggKyBcIiBtYXRjaGVzIFwiICsgY250ICsgXCIgZmFjOiBcIiArIGZhYyArIFwiIHJlYyA6IFwiICsgSlNPTi5zdHJpbmdpZnkoY250UmVjLCB1bmRlZmluZWQsIDIpKTtcbiAgcmV0dXJuIHtcbiAgICBmdXNhYmxlOiB0b2tlbnMuZnVzYWJsZSxcbiAgICB0b2tlbnM6IHRva2Vucy50b2tlbnMsXG4gICAgY2F0ZWdvcml6ZWRXb3JkczogY2F0ZWdvcml6ZWRTZW50ZW5jZVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1NhbWVSZXMocHJlc2VudDogSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZCwgcmVzIDogSU1hdGNoLklDYXRlZ29yaXplZFN0cmluZ1JhbmdlZCkgIDogbnVtYmVyIHtcbiAgaWYoISgocHJlc2VudC5ydWxlLm1hdGNoZWRTdHJpbmcgPT09IHJlcy5ydWxlLm1hdGNoZWRTdHJpbmcpXG4gICAgJiYgKHByZXNlbnQucnVsZS5jYXRlZ29yeSA9PT0gcmVzLnJ1bGUuY2F0ZWdvcnkpXG4gICAgJiYgKHByZXNlbnQuc3BhbiA9PT0gcmVzLnNwYW4pXG4gICYmIChwcmVzZW50LnJ1bGUuYml0aW5kZXggPT09IHJlcy5ydWxlLmJpdGluZGV4KSkpIHtcbiAgICAgIHJldHVybiAwO1xuICB9XG4gIGlmKHByZXNlbnQuX3JhbmtpbmcgPCByZXMuX3JhbmtpbmcpIHtcbiAgICByZXR1cm4gLTE7XG4gIH1cbiAgcmV0dXJuICsxO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VJZ25vcmVPckFwcGVuZChyZXN1bHQgOiBJTWF0Y2guSUNhdGVnb3JpemVkU3RyaW5nUmFuZ2VkW10sIHJlcyA6IElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWQpIHtcbiAgdmFyIGluc2VydGluZGV4ID0gLTE7XG4gIHZhciBmb3VuZE5vdGhpbmcgPSByZXN1bHQuZXZlcnkoIChwcmVzZW50LGluZGV4KSA9PiB7XG4gICAgdmFyIHIgPSBpc1NhbWVSZXMocHJlc2VudCxyZXMpO1xuICAgIGlmIChyIDwgMCkge1xuICAgICAgLy9jb25zb2xlLmxvZyhcIm92ZXJ3cml0aW5nIHdvcnNlIFxcblwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSArICdcXG4nICsgSlNPTi5zdHJpbmdpZnkocHJlc2VudCkrICdcXG4nKTtcbiAgICAgIHJlc3VsdFtpbmRleF0gPSByZXM7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSBlbHNlIGlmKHIgPiAwKSB7XG4gICAgICAvL2NvbnNvbGUubG9nKCdza2lwcGluZyBwcmVzZW50Jyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9KTtcbiAgaWYoZm91bmROb3RoaW5nKSB7XG4gICAgLy9kZWJ1bG9nKCdwdXNoaW5nJyk7XG4gICAgcmVzdWx0LnB1c2gocmVzKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbih0b2tlbnM6IHN0cmluZ1tdLCBmdXNhYmxlOiBib29sZWFuW10sIGNhdGVnb3JpemVkV29yZHM6IElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmdSYW5nZWRbXVtdKSB7XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyAoXCJldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uLi4uIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRXb3JkcykpIDogJy0nKTtcbiAgY2F0ZWdvcml6ZWRXb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkbGlzdCwgaW5kZXgpIHtcbiAgICB3b3JkbGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkKSB7XG4gICAgICBpZiAod29yZC5ydWxlLnJhbmdlKSB7XG4gICAgICAgIC8vY29uc29sZS5sb2coYCBnb3QgdGFyZ2V0aW5kZXggZm9yIFJhbmdlUnVsZXMgZXZhbHVhdGlvbiA6ICR7dGFyZ2V0SW5kZXh9ICR7aW5kZXh9ICR7ZnVzYWJsZS5qb2luKFwiIFwiKX1gKTtcbiAgICAgICAgdmFyIHRhcmdldEluZGV4ID0gYnJlYWtkb3duLmlzQ29tYmluYWJsZVJhbmdlUmV0dXJuSW5kZXgod29yZC5ydWxlLnJhbmdlLCBmdXNhYmxlLCBpbmRleCk7XG4gICAgICAgIC8vY29uc29sZS5sb2coYCBnb3QgdGFyZ2V0aW5kZXggZm9yIFJhbmdlUnVsZXMgZXZhbHVhdGlvbiA6ICR7dGFyZ2V0SW5kZXh9YCk7XG4gICAgICAgIGlmICh0YXJnZXRJbmRleCA+PSAwKSB7XG4gICAgICAgICAgdmFyIGNvbWJpbmVkV29yZCA9IGJyZWFrZG93bi5jb21iaW5lVG9rZW5zKHdvcmQucnVsZS5yYW5nZSwgaW5kZXgsIHRva2Vucyk7XG4gICAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChgIHRlc3QgXCIke2NvbWJpbmVkV29yZH1cIiBhZ2FpbnN0IFwiJHt3b3JkLnJ1bGUucmFuZ2UucnVsZS5sb3dlcmNhc2V3b3JkfVwiICR7SlNPTi5zdHJpbmdpZnkod29yZC5ydWxlLnJhbmdlLnJ1bGUpfWApIDogJy0nKTtcbiAgICAgICAgICB2YXIgcmVzID0gSW5wdXRGaWx0ZXIuY2F0ZWdvcml6ZVdvcmRXaXRoT2Zmc2V0V2l0aFJhbmtDdXRvZmZTaW5nbGUoY29tYmluZWRXb3JkLCB3b3JkLnJ1bGUucmFuZ2UucnVsZSk7XG4gICAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcIiBnb3QgcmVzIDogXCIgKyBKU09OLnN0cmluZ2lmeShyZXMpKSA6ICctJyk7XG4gICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgcmVzLnNwYW4gPSB3b3JkLnJ1bGUucmFuZ2UuaGlnaCAtIHdvcmQucnVsZS5yYW5nZS5sb3cgKyAxO1xuICAgICAgICAgICAgY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0gPSBjYXRlZ29yaXplZFdvcmRzW3RhcmdldEluZGV4XS5zbGljZSgwKTsgLy8gYXZvaWQgaW52YWxpZGF0aW9uIG9mIHNlZW5pdFxuICAgICAgICAgICAgZGVidWdsb2coYHB1c2hlZCBzdGggYXQgJHt0YXJnZXRJbmRleH1gKTtcbiAgICAgICAgICAgIG1lcmdlSWdub3JlT3JBcHBlbmQoY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0scmVzKTtcbiAgIC8vICAgICAgICAgY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0ucHVzaChyZXMpOyAvLyBjaGVjayB0aGF0IHRoaXMgZG9lcyBub3QgaW52YWxpZGF0ZSBzZWVuaXQhXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuICAvLyBmaWx0ZXIgYWxsIHJhbmdlIHJ1bGVzICFcbiAgY2F0ZWdvcml6ZWRXb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkbGlzdCwgaW5kZXgpIHtcbiAgICBjYXRlZ29yaXplZFdvcmRzW2luZGV4XSA9IHdvcmRsaXN0LmZpbHRlcih3b3JkID0+ICF3b3JkLnJ1bGUucmFuZ2UpO1xuICB9KTtcbn1cblxuXG5cblxuY29uc3QgY2xvbmUgPSB1dGlscy5jbG9uZURlZXA7XG5cblxuXG5cbmZ1bmN0aW9uIGNvcHlWZWNNZW1iZXJzKHUpIHtcbiAgdmFyIGkgPSAwO1xuICBmb3IgKGkgPSAwOyBpIDwgdS5sZW5ndGg7ICsraSkge1xuICAgIHVbaV0gPSBjbG9uZSh1W2ldKTtcbiAgfVxuICByZXR1cm4gdTtcbn1cblxuXG4vLyB3ZSBjYW4gcmVwbGljYXRlIHRoZSB0YWlsIG9yIHRoZSBoZWFkLFxuLy8gd2UgcmVwbGljYXRlIHRoZSB0YWlsIGFzIGl0IGlzIHNtYWxsZXIuXG4vLyBbYSxiLGMgXVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTcGFuVmVjKHZlYzogQXJyYXk8YW55PiwgaW5kZXg6IG51bWJlcikge1xuICB2YXIgZWZmZWN0aXZlbGVuID0gdmVjLnJlZHVjZSgocHJldiwgbWVtKSA9PiBwcmV2ICs9IG1lbS5zcGFuID8gbWVtLnNwYW4gOiAxLCAwKTtcbiAgcmV0dXJuIGVmZmVjdGl2ZWxlbiA+IGluZGV4O1xufVxuXG4vKipcbiAqIGV4cGFuZCBhbiBhcnJheSBbW2ExLGEyXSwgW2IxLGIyXSxbY11dXG4gKiBpbnRvIGFsbCBjb21iaW5hdGlvbnNcbiAqXG4gKiAgaWYgYTEgaGFzIGEgc3BhbiBvZiB0aHJlZSwgdGhlIHZhcmlhdGlvbnMgb2YgdGhlIGxvd2VyIGxheWVyIGFyZSBza2lwcGVkXG4gKlxuICogd2l0aCB0aGUgc3BlY2lhbCBwcm9wZXJ0eVxuICovXG5leHBvcnQgZnVuY3Rpb24gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXModG9rZW5zOiBzdHJpbmdbXSwgdG9rZW5NYXRjaGVzOiBBcnJheTxBcnJheTxhbnk+Pik6IElNYXRjaC5JUHJvY2Vzc2VkU2VudGVuY2VzIHtcbiAgdmFyIGEgPSBbXTtcbiAgdmFyIHdvcmRNYXRjaGVzID0gW107XG4gIGRlYnVnbG9nVihkZWJ1Z2xvZy5lbmFibGVkID8gSlNPTi5zdHJpbmdpZnkodG9rZW5NYXRjaGVzKSA6ICctJyk7XG4gIHRva2VuTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChhV29yZE1hdGNoZXMsIHdvcmRJbmRleDogbnVtYmVyKSB7XG4gICAgd29yZE1hdGNoZXNbd29yZEluZGV4XSA9IFtdO1xuICAgIGFXb3JkTWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZFZhcmlhbnQsIHdvcmRWYXJpYW50SW5kZXg6IG51bWJlcikge1xuICAgICAgd29yZE1hdGNoZXNbd29yZEluZGV4XVt3b3JkVmFyaWFudEluZGV4XSA9IG9Xb3JkVmFyaWFudDtcbiAgICB9KTtcbiAgfSk7XG4gIGRlYnVnbG9nKGRlYnVnbG9nLmVuYWJsZWQgPyBKU09OLnN0cmluZ2lmeSh0b2tlbk1hdGNoZXMpIDogJy0nKTtcbiAgdmFyIHJlc3VsdCA9IHtcbiAgICBlcnJvcnM6IFtdLFxuICAgIHRva2VuczogdG9rZW5zLFxuICAgIHNlbnRlbmNlczogW11cbiAgfSBhcyBJTWF0Y2guSVByb2Nlc3NlZFNlbnRlbmNlcztcbiAgdmFyIG52ZWNzID0gW107XG4gIHZhciByZXMgPSBbW11dO1xuICAvLyB2YXIgbnZlY3MgPSBbXTtcbiAgdmFyIHJ2ZWMgPSBbXTtcbiAgZm9yICh2YXIgdG9rZW5JbmRleCA9IDA7IHRva2VuSW5kZXggPCB0b2tlbk1hdGNoZXMubGVuZ3RoOyArK3Rva2VuSW5kZXgpIHsgLy8gd29yZGcgaW5kZXgga1xuICAgIC8vdmVjcyBpcyB0aGUgdmVjdG9yIG9mIGFsbCBzbyBmYXIgc2VlbiB2YXJpYW50cyB1cCB0byBrIGxlbmd0aC5cbiAgICB2YXIgbmV4dEJhc2UgPSBbXTtcbiAgICAvL2luZGVwZW5kZW50IG9mIGV4aXN0ZW5jZSBvZiBtYXRjaGVzIG9uIGxldmVsIGssIHdlIHJldGFpbiBhbGwgdmVjdG9ycyB3aGljaCBhcmUgY292ZXJlZCBieSBhIHNwYW5cbiAgICAvLyB3ZSBza2lwIGV4dGVuZGluZyB0aGVtIGJlbG93XG4gICAgZm9yICh2YXIgdSA9IDA7IHUgPCByZXMubGVuZ3RoOyArK3UpIHtcbiAgICAgIGlmIChpc1NwYW5WZWMocmVzW3VdLCB0b2tlbkluZGV4KSkge1xuICAgICAgICBuZXh0QmFzZS5wdXNoKHJlc1t1XSk7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBsZW5NYXRjaGVzID0gdG9rZW5NYXRjaGVzW3Rva2VuSW5kZXhdLmxlbmd0aDtcbiAgICBpZiAobmV4dEJhc2UubGVuZ3RoID09PSAwICYmIGxlbk1hdGNoZXMgPT09IDApIHtcbiAgICAgIC8vIHRoZSB3b3JkIGF0IGluZGV4IEkgY2Fubm90IGJlIHVuZGVyc3Rvb2RcbiAgICAgIC8vaWYgKHJlc3VsdC5lcnJvcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXN1bHQuZXJyb3JzLnB1c2goRVJFcnJvci5tYWtlRXJyb3JfTk9fS05PV05fV09SRCh0b2tlbkluZGV4LCB0b2tlbnMpKTtcbiAgICAgIC8vfVxuICAgIH1cbiAgICBmb3IgKHZhciBsID0gMDsgbCA8IGxlbk1hdGNoZXM7ICsrbCkgeyAvLyBmb3IgZWFjaCB2YXJpYW50IHByZXNlbnQgYXQgaW5kZXgga1xuICAgICAgLy9kZWJ1Z2xvZyhcInZlY3Mgbm93XCIgKyBKU09OLnN0cmluZ2lmeSh2ZWNzKSk7XG4gICAgICB2YXIgbnZlY3MgPSBbXTsgLy92ZWNzLnNsaWNlKCk7IC8vIGNvcHkgdGhlIHZlY1tpXSBiYXNlIHZlY3RvcjtcbiAgICAgIC8vZGVidWdsb2coXCJ2ZWNzIGNvcGllZCBub3dcIiArIEpTT04uc3RyaW5naWZ5KG52ZWNzKSk7XG4gICAgICBmb3IgKHZhciB1ID0gMDsgdSA8IHJlcy5sZW5ndGg7ICsrdSkge1xuICAgICAgICBpZiAoIWlzU3BhblZlYyhyZXNbdV0sIHRva2VuSW5kZXgpKSB7XG4gICAgICAgICAgLy8gZm9yIGVhY2ggc28gZmFyIGNvbnN0cnVjdGVkIHJlc3VsdCAob2YgbGVuZ3RoIGspIGluIHJlc1xuICAgICAgICAgIG52ZWNzLnB1c2gocmVzW3VdLnNsaWNlKCkpOyAvLyBtYWtlIGEgY29weSBvZiBlYWNoIHZlY3RvclxuICAgICAgICAgIG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdID0gY29weVZlY01lbWJlcnMobnZlY3NbbnZlY3MubGVuZ3RoIC0gMV0pO1xuICAgICAgICAgIC8vIGRlYnVnbG9nKFwiY29waWVkIHZlY3NbXCIrIHUrXCJdXCIgKyBKU09OLnN0cmluZ2lmeSh2ZWNzW3VdKSk7XG4gICAgICAgICAgbnZlY3NbbnZlY3MubGVuZ3RoIC0gMV0ucHVzaChcbiAgICAgICAgICAgIGNsb25lKHRva2VuTWF0Y2hlc1t0b2tlbkluZGV4XVtsXSkpOyAvLyBwdXNoIHRoZSBsdGggdmFyaWFudFxuICAgICAgICAgIC8vIGRlYnVnbG9nKFwibm93IG52ZWNzIFwiICsgbnZlY3MubGVuZ3RoICsgXCIgXCIgKyBKU09OLnN0cmluZ2lmeShudmVjcykpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyAgIGRlYnVnbG9nKFwiIGF0ICAgICBcIiArIGsgKyBcIjpcIiArIGwgKyBcIiBuZXh0YmFzZSA+XCIgKyBKU09OLnN0cmluZ2lmeShuZXh0QmFzZSkpXG4gICAgICAvLyAgIGRlYnVnbG9nKFwiIGFwcGVuZCBcIiArIGsgKyBcIjpcIiArIGwgKyBcIiBudmVjcyAgICA+XCIgKyBKU09OLnN0cmluZ2lmeShudmVjcykpXG4gICAgICBuZXh0QmFzZSA9IG5leHRCYXNlLmNvbmNhdChudmVjcyk7XG4gICAgICAvLyAgIGRlYnVnbG9nKFwiICByZXN1bHQgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbnZlY3MgICAgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKVxuICAgIH0gLy9jb25zdHJ1XG4gICAgLy8gIGRlYnVnbG9nKFwibm93IGF0IFwiICsgayArIFwiOlwiICsgbCArIFwiID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSlcbiAgICByZXMgPSBuZXh0QmFzZTtcbiAgfVxuICBkZWJ1Z2xvZ1YoZGVidWdsb2dWLmVuYWJsZWQgPyAoXCJBUFBFTkRJTkcgVE8gUkVTXCIgKyAwICsgXCI6XCIgKyBsICsgXCIgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKSA6ICctJyk7XG4gIHJlc3VsdC5zZW50ZW5jZXMgPSByZXM7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHByb2Nlc3NTdHJpbmcocXVlcnk6IHN0cmluZywgcnVsZXM6IElNYXRjaC5TcGxpdFJ1bGVzLFxuIHdvcmRzOiB7IFtrZXk6IHN0cmluZ106IEFycmF5PElNYXRjaC5JQ2F0ZWdvcml6ZWRTdHJpbmc+IH1cbik6ICBJTWF0Y2guSVByb2Nlc3NlZFNlbnRlbmNlcyB7XG4gIHdvcmRzID0gd29yZHMgfHwge307XG4gIHZhciB0b2tlblN0cnVjdCA9IHRva2VuaXplU3RyaW5nKHF1ZXJ5LCBydWxlcywgd29yZHMpO1xuICBldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uKHRva2VuU3RydWN0LnRva2VucywgdG9rZW5TdHJ1Y3QuZnVzYWJsZSxcbiAgICB0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKTtcbiAgaWYgKGRlYnVnbG9nLmVuYWJsZWQpIHtcbiAgICBkZWJ1Z2xvZyhcIkFmdGVyIG1hdGNoZWQgXCIgKyBKU09OLnN0cmluZ2lmeSh0b2tlblN0cnVjdC5jYXRlZ29yaXplZFdvcmRzKSk7XG4gIH1cbiAgdmFyIGFTZW50ZW5jZXMgPSBleHBhbmRUb2tlbk1hdGNoZXNUb1NlbnRlbmNlcyh0b2tlblN0cnVjdC50b2tlbnMsIHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpO1xuICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgZXhwYW5kXCIgKyBhU2VudGVuY2VzLnNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBTZW50ZW5jZS5kdW1wTmljZShvU2VudGVuY2UpOyAvL0pTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgfSkuam9pbihcIlxcblwiKSk7XG4gIH1cbiAgYVNlbnRlbmNlcy5zZW50ZW5jZXMgPSBJbnB1dEZpbHRlci5yZWluRm9yY2UoYVNlbnRlbmNlcy5zZW50ZW5jZXMpO1xuICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgIGRlYnVnbG9nKFwiYWZ0ZXIgcmVpbmZvcmNlXCIgKyBhU2VudGVuY2VzLnNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIEpTT04uc3RyaW5naWZ5KG9TZW50ZW5jZSk7XG4gICAgfSkuam9pbihcIlxcblwiKSk7XG4gIH1cbiAgcmV0dXJuIGFTZW50ZW5jZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzaW1wbGlmeVNlbnRlbmNlKHJlcykge1xuICByZXR1cm4gcmVzLm1hcChmdW5jdGlvbiAocikge1xuICAgIHJldHVybiByLm1hcCh3b3JkID0+IHsgcmV0dXJuIHdvcmQuc3RyaW5nICsgJz0+JyArIHdvcmQubWF0Y2hlZFN0cmluZyArICcvJyArIHdvcmQuY2F0ZWdvcnkgKyAod29yZC5zcGFuID8gJy8nICsgd29yZC5zcGFuIDogJycpIH0pXG4gIH0pO1xufVxuIiwiLyoqXG4gKlxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYW5hbHl6ZVxuICogQGZpbGUgZXJiYXNlXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKlxuICogQmFzaWMgZG9tYWluIGJhc2VkIGVudGl0eSByZWNvZ25pdGlvblxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBJbnB1dEZpbHRlciA9IHJlcXVpcmUoXCIuL2lucHV0RmlsdGVyXCIpO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2VyYmFzZScpO1xudmFyIGRlYnVnbG9nViA9IGRlYnVnKCdlcmJhc2UnKTtcbnZhciBwZXJmbG9nID0gZGVidWcoJ3BlcmYnKTtcbnZhciBicmVha2Rvd24gPSByZXF1aXJlKFwiLi9icmVha2Rvd25cIik7XG52YXIgRVJFcnJvciA9IHJlcXVpcmUoXCIuL2VyZXJyb3JcIik7XG52YXIgQW55T2JqZWN0ID0gT2JqZWN0O1xuZnVuY3Rpb24gbW9ja0RlYnVnKG8pIHtcbiAgICBkZWJ1Z2xvZyA9IG87XG4gICAgZGVidWdsb2dWID0gbztcbiAgICBwZXJmbG9nID0gbztcbn1cbmV4cG9ydHMubW9ja0RlYnVnID0gbW9ja0RlYnVnO1xudmFyIHV0aWxzID0gcmVxdWlyZShcIi4uL3V0aWxzL3V0aWxzXCIpO1xudmFyIFNlbnRlbmNlID0gcmVxdWlyZShcIi4vc2VudGVuY2VcIik7XG4vKipcbiAqIEdpdmVuIGEgIHN0cmluZywgYnJlYWsgaXQgZG93biBpbnRvIGNvbXBvbmVudHMsXG4gKiBbWydBJywgJ0InXSwgWydBIEInXV1cbiAqXG4gKiB0aGVuIGNhdGVnb3JpemVXb3Jkc1xuICogcmV0dXJuaW5nXG4gKlxuICogWyBbWyB7IGNhdGVnb3J5OiAnc3lzdGVtSWQnLCB3b3JkIDogJ0EnfSxcbiAqICAgICAgeyBjYXRlZ29yeTogJ290aGVydGhpbmcnLCB3b3JkIDogJ0EnfVxuICogICAgXSxcbiAqICAgIC8vIHJlc3VsdCBvZiBCXG4gKiAgICBbIHsgY2F0ZWdvcnk6ICdzeXN0ZW1JZCcsIHdvcmQgOiAnQid9LFxuICogICAgICB7IGNhdGVnb3J5OiAnb3RoZXJ0aGluZycsIHdvcmQgOiAnQSd9XG4gKiAgICAgIHsgY2F0ZWdvcnk6ICdhbm90aGVydHJ5cCcsIHdvcmQgOiAnQid9XG4gKiAgICBdXG4gKiAgIF0sXG4gKiBdXV1cbiAqXG4gKlxuICpcbiAqL1xuZnVuY3Rpb24gdG9rZW5pemVTdHJpbmcoc1N0cmluZywgcnVsZXMsIHdvcmRzKSB7XG4gICAgdmFyIGNudCA9IDA7XG4gICAgdmFyIGZhYyA9IDE7XG4gICAgdmFyIHRva2VucyA9IGJyZWFrZG93bi50b2tlbml6ZVN0cmluZyhzU3RyaW5nKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcImhlcmUgYnJlYWtkb3duXCIgKyBKU09OLnN0cmluZ2lmeSh0b2tlbnMpKTtcbiAgICB9XG4gICAgLy9jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh1KSk7XG4gICAgd29yZHMgPSB3b3JkcyB8fCB7fTtcbiAgICBwZXJmbG9nKCd0aGlzIG1hbnkga25vd24gd29yZHM6ICcgKyBPYmplY3Qua2V5cyh3b3JkcykubGVuZ3RoKTtcbiAgICB2YXIgcmVzID0gW107XG4gICAgdmFyIGNudFJlYyA9IHt9O1xuICAgIHZhciBjYXRlZ29yaXplZFNlbnRlbmNlID0gW107XG4gICAgdmFyIGhhc1JlY29tYmluZWQgPSBmYWxzZTtcbiAgICB0b2tlbnMudG9rZW5zLmZvckVhY2goZnVuY3Rpb24gKHRva2VuLCBpbmRleCkge1xuICAgICAgICB2YXIgc2Vlbkl0ID0gSW5wdXRGaWx0ZXIuY2F0ZWdvcml6ZUFXb3JkV2l0aE9mZnNldHModG9rZW4sIHJ1bGVzLCBzU3RyaW5nLCB3b3JkcywgY250UmVjKTtcbiAgICAgICAgLyogY2Fubm90IGhhdmUgdGhpcywgb3IgbmVlZCB0byBhZGQgYWxsIGZyYWdtZW50IHdvcmRzIFwiVUkyIEludGVncmF0aW9uXCIgIGlmKHNlZW5JdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAqL1xuICAgICAgICBoYXNSZWNvbWJpbmVkID0gaGFzUmVjb21iaW5lZCB8fCAhc2Vlbkl0LmV2ZXJ5KGZ1bmN0aW9uIChyZXMpIHsgcmV0dXJuICFyZXMucnVsZS5yYW5nZTsgfSk7XG4gICAgICAgIGRlYnVnbG9nKFwiIGNhdGVnb3JpemVkIFwiICsgdG9rZW4gKyBcIi9cIiArIGluZGV4ICsgXCIgdG8gXCIgKyBKU09OLnN0cmluZ2lmeShzZWVuSXQpKTtcbiAgICAgICAgY2F0ZWdvcml6ZWRTZW50ZW5jZVtpbmRleF0gPSBzZWVuSXQ7XG4gICAgICAgIGNudCA9IGNudCArIHNlZW5JdC5sZW5ndGg7XG4gICAgICAgIGZhYyA9IGZhYyAqIHNlZW5JdC5sZW5ndGg7XG4gICAgfSk7XG4gICAgLy8gaGF2ZSBzZWVuIHRoZSBwbGFpbiBjYXRlZ29yaXphdGlvbixcbiAgICBkZWJ1Z2xvZyhcIiBzZW50ZW5jZXMgXCIgKyB0b2tlbnMudG9rZW5zLmxlbmd0aCArIFwiIG1hdGNoZXMgXCIgKyBjbnQgKyBcIiBmYWM6IFwiICsgZmFjKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCAmJiB0b2tlbnMudG9rZW5zLmxlbmd0aCkge1xuICAgICAgICBkZWJ1Z2xvZyhcImZpcnN0IG1hdGNoIFwiICsgSlNPTi5zdHJpbmdpZnkodG9rZW5zLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IFwiIHByaW9yIFJhbmdlUnVsZSBcIiArIEpTT04uc3RyaW5naWZ5KGNhdGVnb3JpemVkU2VudGVuY2UpICsgXCIgXCIgOiAnLScpO1xuICAgIGlmIChoYXNSZWNvbWJpbmVkKSB7XG4gICAgICAgIGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24odG9rZW5zLnRva2VucywgdG9rZW5zLmZ1c2FibGUsIGNhdGVnb3JpemVkU2VudGVuY2UpO1xuICAgIH1cbiAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gXCIgYWZ0ZXIgUmFuZ2VSdWxlIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0ZWdvcml6ZWRTZW50ZW5jZSkgKyBcIiBcIiA6ICctJyk7XG4gICAgcGVyZmxvZyhcIiBzZW50ZW5jZXMgXCIgKyB0b2tlbnMudG9rZW5zLmxlbmd0aCArIFwiIC8gXCIgKyByZXMubGVuZ3RoICsgXCIgbWF0Y2hlcyBcIiArIGNudCArIFwiIGZhYzogXCIgKyBmYWMgKyBcIiByZWMgOiBcIiArIEpTT04uc3RyaW5naWZ5KGNudFJlYywgdW5kZWZpbmVkLCAyKSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgZnVzYWJsZTogdG9rZW5zLmZ1c2FibGUsXG4gICAgICAgIHRva2VuczogdG9rZW5zLnRva2VucyxcbiAgICAgICAgY2F0ZWdvcml6ZWRXb3JkczogY2F0ZWdvcml6ZWRTZW50ZW5jZVxuICAgIH07XG59XG5leHBvcnRzLnRva2VuaXplU3RyaW5nID0gdG9rZW5pemVTdHJpbmc7XG5mdW5jdGlvbiBpc1NhbWVSZXMocHJlc2VudCwgcmVzKSB7XG4gICAgaWYgKCEoKHByZXNlbnQucnVsZS5tYXRjaGVkU3RyaW5nID09PSByZXMucnVsZS5tYXRjaGVkU3RyaW5nKVxuICAgICAgICAmJiAocHJlc2VudC5ydWxlLmNhdGVnb3J5ID09PSByZXMucnVsZS5jYXRlZ29yeSlcbiAgICAgICAgJiYgKHByZXNlbnQuc3BhbiA9PT0gcmVzLnNwYW4pXG4gICAgICAgICYmIChwcmVzZW50LnJ1bGUuYml0aW5kZXggPT09IHJlcy5ydWxlLmJpdGluZGV4KSkpIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIGlmIChwcmVzZW50Ll9yYW5raW5nIDwgcmVzLl9yYW5raW5nKSB7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICB9XG4gICAgcmV0dXJuICsxO1xufVxuZXhwb3J0cy5pc1NhbWVSZXMgPSBpc1NhbWVSZXM7XG5mdW5jdGlvbiBtZXJnZUlnbm9yZU9yQXBwZW5kKHJlc3VsdCwgcmVzKSB7XG4gICAgdmFyIGluc2VydGluZGV4ID0gLTE7XG4gICAgdmFyIGZvdW5kTm90aGluZyA9IHJlc3VsdC5ldmVyeShmdW5jdGlvbiAocHJlc2VudCwgaW5kZXgpIHtcbiAgICAgICAgdmFyIHIgPSBpc1NhbWVSZXMocHJlc2VudCwgcmVzKTtcbiAgICAgICAgaWYgKHIgPCAwKSB7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwib3ZlcndyaXRpbmcgd29yc2UgXFxuXCIgKyBKU09OLnN0cmluZ2lmeShyZXMpICsgJ1xcbicgKyBKU09OLnN0cmluZ2lmeShwcmVzZW50KSsgJ1xcbicpO1xuICAgICAgICAgICAgcmVzdWx0W2luZGV4XSA9IHJlcztcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChyID4gMCkge1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnc2tpcHBpbmcgcHJlc2VudCcpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH0pO1xuICAgIGlmIChmb3VuZE5vdGhpbmcpIHtcbiAgICAgICAgLy9kZWJ1bG9nKCdwdXNoaW5nJyk7XG4gICAgICAgIHJlc3VsdC5wdXNoKHJlcyk7XG4gICAgfVxufVxuZXhwb3J0cy5tZXJnZUlnbm9yZU9yQXBwZW5kID0gbWVyZ2VJZ25vcmVPckFwcGVuZDtcbmZ1bmN0aW9uIGV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24odG9rZW5zLCBmdXNhYmxlLCBjYXRlZ29yaXplZFdvcmRzKSB7XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcImV2YWx1YXRlUmFuZ2VSdWxlc1RvUG9zaXRpb24uLi4gXCIgKyBKU09OLnN0cmluZ2lmeShjYXRlZ29yaXplZFdvcmRzKSkgOiAnLScpO1xuICAgIGNhdGVnb3JpemVkV29yZHMuZm9yRWFjaChmdW5jdGlvbiAod29yZGxpc3QsIGluZGV4KSB7XG4gICAgICAgIHdvcmRsaXN0LmZvckVhY2goZnVuY3Rpb24gKHdvcmQpIHtcbiAgICAgICAgICAgIGlmICh3b3JkLnJ1bGUucmFuZ2UpIHtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGAgZ290IHRhcmdldGluZGV4IGZvciBSYW5nZVJ1bGVzIGV2YWx1YXRpb24gOiAke3RhcmdldEluZGV4fSAke2luZGV4fSAke2Z1c2FibGUuam9pbihcIiBcIil9YCk7XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldEluZGV4ID0gYnJlYWtkb3duLmlzQ29tYmluYWJsZVJhbmdlUmV0dXJuSW5kZXgod29yZC5ydWxlLnJhbmdlLCBmdXNhYmxlLCBpbmRleCk7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgIGdvdCB0YXJnZXRpbmRleCBmb3IgUmFuZ2VSdWxlcyBldmFsdWF0aW9uIDogJHt0YXJnZXRJbmRleH1gKTtcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0SW5kZXggPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY29tYmluZWRXb3JkID0gYnJlYWtkb3duLmNvbWJpbmVUb2tlbnMod29yZC5ydWxlLnJhbmdlLCBpbmRleCwgdG9rZW5zKTtcbiAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IChcIiB0ZXN0IFxcXCJcIiArIGNvbWJpbmVkV29yZCArIFwiXFxcIiBhZ2FpbnN0IFxcXCJcIiArIHdvcmQucnVsZS5yYW5nZS5ydWxlLmxvd2VyY2FzZXdvcmQgKyBcIlxcXCIgXCIgKyBKU09OLnN0cmluZ2lmeSh3b3JkLnJ1bGUucmFuZ2UucnVsZSkpIDogJy0nKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IElucHV0RmlsdGVyLmNhdGVnb3JpemVXb3JkV2l0aE9mZnNldFdpdGhSYW5rQ3V0b2ZmU2luZ2xlKGNvbWJpbmVkV29yZCwgd29yZC5ydWxlLnJhbmdlLnJ1bGUpO1xuICAgICAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKFwiIGdvdCByZXMgOiBcIiArIEpTT04uc3RyaW5naWZ5KHJlcykpIDogJy0nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnNwYW4gPSB3b3JkLnJ1bGUucmFuZ2UuaGlnaCAtIHdvcmQucnVsZS5yYW5nZS5sb3cgKyAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcml6ZWRXb3Jkc1t0YXJnZXRJbmRleF0gPSBjYXRlZ29yaXplZFdvcmRzW3RhcmdldEluZGV4XS5zbGljZSgwKTsgLy8gYXZvaWQgaW52YWxpZGF0aW9uIG9mIHNlZW5pdFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coXCJwdXNoZWQgc3RoIGF0IFwiICsgdGFyZ2V0SW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VJZ25vcmVPckFwcGVuZChjYXRlZ29yaXplZFdvcmRzW3RhcmdldEluZGV4XSwgcmVzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgLy8gZmlsdGVyIGFsbCByYW5nZSBydWxlcyAhXG4gICAgY2F0ZWdvcml6ZWRXb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uICh3b3JkbGlzdCwgaW5kZXgpIHtcbiAgICAgICAgY2F0ZWdvcml6ZWRXb3Jkc1tpbmRleF0gPSB3b3JkbGlzdC5maWx0ZXIoZnVuY3Rpb24gKHdvcmQpIHsgcmV0dXJuICF3b3JkLnJ1bGUucmFuZ2U7IH0pO1xuICAgIH0pO1xufVxuZXhwb3J0cy5ldmFsdWF0ZVJhbmdlUnVsZXNUb1Bvc2l0aW9uID0gZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbjtcbnZhciBjbG9uZSA9IHV0aWxzLmNsb25lRGVlcDtcbmZ1bmN0aW9uIGNvcHlWZWNNZW1iZXJzKHUpIHtcbiAgICB2YXIgaSA9IDA7XG4gICAgZm9yIChpID0gMDsgaSA8IHUubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgdVtpXSA9IGNsb25lKHVbaV0pO1xuICAgIH1cbiAgICByZXR1cm4gdTtcbn1cbi8vIHdlIGNhbiByZXBsaWNhdGUgdGhlIHRhaWwgb3IgdGhlIGhlYWQsXG4vLyB3ZSByZXBsaWNhdGUgdGhlIHRhaWwgYXMgaXQgaXMgc21hbGxlci5cbi8vIFthLGIsYyBdXG5mdW5jdGlvbiBpc1NwYW5WZWModmVjLCBpbmRleCkge1xuICAgIHZhciBlZmZlY3RpdmVsZW4gPSB2ZWMucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCBtZW0pIHsgcmV0dXJuIHByZXYgKz0gbWVtLnNwYW4gPyBtZW0uc3BhbiA6IDE7IH0sIDApO1xuICAgIHJldHVybiBlZmZlY3RpdmVsZW4gPiBpbmRleDtcbn1cbmV4cG9ydHMuaXNTcGFuVmVjID0gaXNTcGFuVmVjO1xuLyoqXG4gKiBleHBhbmQgYW4gYXJyYXkgW1thMSxhMl0sIFtiMSxiMl0sW2NdXVxuICogaW50byBhbGwgY29tYmluYXRpb25zXG4gKlxuICogIGlmIGExIGhhcyBhIHNwYW4gb2YgdGhyZWUsIHRoZSB2YXJpYXRpb25zIG9mIHRoZSBsb3dlciBsYXllciBhcmUgc2tpcHBlZFxuICpcbiAqIHdpdGggdGhlIHNwZWNpYWwgcHJvcGVydHlcbiAqL1xuZnVuY3Rpb24gZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXModG9rZW5zLCB0b2tlbk1hdGNoZXMpIHtcbiAgICB2YXIgYSA9IFtdO1xuICAgIHZhciB3b3JkTWF0Y2hlcyA9IFtdO1xuICAgIGRlYnVnbG9nVihkZWJ1Z2xvZy5lbmFibGVkID8gSlNPTi5zdHJpbmdpZnkodG9rZW5NYXRjaGVzKSA6ICctJyk7XG4gICAgdG9rZW5NYXRjaGVzLmZvckVhY2goZnVuY3Rpb24gKGFXb3JkTWF0Y2hlcywgd29yZEluZGV4KSB7XG4gICAgICAgIHdvcmRNYXRjaGVzW3dvcmRJbmRleF0gPSBbXTtcbiAgICAgICAgYVdvcmRNYXRjaGVzLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkVmFyaWFudCwgd29yZFZhcmlhbnRJbmRleCkge1xuICAgICAgICAgICAgd29yZE1hdGNoZXNbd29yZEluZGV4XVt3b3JkVmFyaWFudEluZGV4XSA9IG9Xb3JkVmFyaWFudDtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZCA/IEpTT04uc3RyaW5naWZ5KHRva2VuTWF0Y2hlcykgOiAnLScpO1xuICAgIHZhciByZXN1bHQgPSB7XG4gICAgICAgIGVycm9yczogW10sXG4gICAgICAgIHRva2VuczogdG9rZW5zLFxuICAgICAgICBzZW50ZW5jZXM6IFtdXG4gICAgfTtcbiAgICB2YXIgbnZlY3MgPSBbXTtcbiAgICB2YXIgcmVzID0gW1tdXTtcbiAgICAvLyB2YXIgbnZlY3MgPSBbXTtcbiAgICB2YXIgcnZlYyA9IFtdO1xuICAgIGZvciAodmFyIHRva2VuSW5kZXggPSAwOyB0b2tlbkluZGV4IDwgdG9rZW5NYXRjaGVzLmxlbmd0aDsgKyt0b2tlbkluZGV4KSB7XG4gICAgICAgIC8vdmVjcyBpcyB0aGUgdmVjdG9yIG9mIGFsbCBzbyBmYXIgc2VlbiB2YXJpYW50cyB1cCB0byBrIGxlbmd0aC5cbiAgICAgICAgdmFyIG5leHRCYXNlID0gW107XG4gICAgICAgIC8vaW5kZXBlbmRlbnQgb2YgZXhpc3RlbmNlIG9mIG1hdGNoZXMgb24gbGV2ZWwgaywgd2UgcmV0YWluIGFsbCB2ZWN0b3JzIHdoaWNoIGFyZSBjb3ZlcmVkIGJ5IGEgc3BhblxuICAgICAgICAvLyB3ZSBza2lwIGV4dGVuZGluZyB0aGVtIGJlbG93XG4gICAgICAgIGZvciAodmFyIHUgPSAwOyB1IDwgcmVzLmxlbmd0aDsgKyt1KSB7XG4gICAgICAgICAgICBpZiAoaXNTcGFuVmVjKHJlc1t1XSwgdG9rZW5JbmRleCkpIHtcbiAgICAgICAgICAgICAgICBuZXh0QmFzZS5wdXNoKHJlc1t1XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGxlbk1hdGNoZXMgPSB0b2tlbk1hdGNoZXNbdG9rZW5JbmRleF0ubGVuZ3RoO1xuICAgICAgICBpZiAobmV4dEJhc2UubGVuZ3RoID09PSAwICYmIGxlbk1hdGNoZXMgPT09IDApIHtcbiAgICAgICAgICAgIC8vIHRoZSB3b3JkIGF0IGluZGV4IEkgY2Fubm90IGJlIHVuZGVyc3Rvb2RcbiAgICAgICAgICAgIC8vaWYgKHJlc3VsdC5lcnJvcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXN1bHQuZXJyb3JzLnB1c2goRVJFcnJvci5tYWtlRXJyb3JfTk9fS05PV05fV09SRCh0b2tlbkluZGV4LCB0b2tlbnMpKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBsID0gMDsgbCA8IGxlbk1hdGNoZXM7ICsrbCkge1xuICAgICAgICAgICAgLy9kZWJ1Z2xvZyhcInZlY3Mgbm93XCIgKyBKU09OLnN0cmluZ2lmeSh2ZWNzKSk7XG4gICAgICAgICAgICB2YXIgbnZlY3MgPSBbXTsgLy92ZWNzLnNsaWNlKCk7IC8vIGNvcHkgdGhlIHZlY1tpXSBiYXNlIHZlY3RvcjtcbiAgICAgICAgICAgIC8vZGVidWdsb2coXCJ2ZWNzIGNvcGllZCBub3dcIiArIEpTT04uc3RyaW5naWZ5KG52ZWNzKSk7XG4gICAgICAgICAgICBmb3IgKHZhciB1ID0gMDsgdSA8IHJlcy5sZW5ndGg7ICsrdSkge1xuICAgICAgICAgICAgICAgIGlmICghaXNTcGFuVmVjKHJlc1t1XSwgdG9rZW5JbmRleCkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gZm9yIGVhY2ggc28gZmFyIGNvbnN0cnVjdGVkIHJlc3VsdCAob2YgbGVuZ3RoIGspIGluIHJlc1xuICAgICAgICAgICAgICAgICAgICBudmVjcy5wdXNoKHJlc1t1XS5zbGljZSgpKTsgLy8gbWFrZSBhIGNvcHkgb2YgZWFjaCB2ZWN0b3JcbiAgICAgICAgICAgICAgICAgICAgbnZlY3NbbnZlY3MubGVuZ3RoIC0gMV0gPSBjb3B5VmVjTWVtYmVycyhudmVjc1tudmVjcy5sZW5ndGggLSAxXSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIGRlYnVnbG9nKFwiY29waWVkIHZlY3NbXCIrIHUrXCJdXCIgKyBKU09OLnN0cmluZ2lmeSh2ZWNzW3VdKSk7XG4gICAgICAgICAgICAgICAgICAgIG52ZWNzW252ZWNzLmxlbmd0aCAtIDFdLnB1c2goY2xvbmUodG9rZW5NYXRjaGVzW3Rva2VuSW5kZXhdW2xdKSk7IC8vIHB1c2ggdGhlIGx0aCB2YXJpYW50XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gICBkZWJ1Z2xvZyhcIiBhdCAgICAgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbmV4dGJhc2UgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKVxuICAgICAgICAgICAgLy8gICBkZWJ1Z2xvZyhcIiBhcHBlbmQgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgbnZlY3MgICAgPlwiICsgSlNPTi5zdHJpbmdpZnkobnZlY3MpKVxuICAgICAgICAgICAgbmV4dEJhc2UgPSBuZXh0QmFzZS5jb25jYXQobnZlY3MpO1xuICAgICAgICB9IC8vY29uc3RydVxuICAgICAgICAvLyAgZGVidWdsb2coXCJub3cgYXQgXCIgKyBrICsgXCI6XCIgKyBsICsgXCIgPlwiICsgSlNPTi5zdHJpbmdpZnkobmV4dEJhc2UpKVxuICAgICAgICByZXMgPSBuZXh0QmFzZTtcbiAgICB9XG4gICAgZGVidWdsb2dWKGRlYnVnbG9nVi5lbmFibGVkID8gKFwiQVBQRU5ESU5HIFRPIFJFU1wiICsgMCArIFwiOlwiICsgbCArIFwiID5cIiArIEpTT04uc3RyaW5naWZ5KG5leHRCYXNlKSkgOiAnLScpO1xuICAgIHJlc3VsdC5zZW50ZW5jZXMgPSByZXM7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbmV4cG9ydHMuZXhwYW5kVG9rZW5NYXRjaGVzVG9TZW50ZW5jZXMgPSBleHBhbmRUb2tlbk1hdGNoZXNUb1NlbnRlbmNlcztcbmZ1bmN0aW9uIHByb2Nlc3NTdHJpbmcocXVlcnksIHJ1bGVzLCB3b3Jkcykge1xuICAgIHdvcmRzID0gd29yZHMgfHwge307XG4gICAgdmFyIHRva2VuU3RydWN0ID0gdG9rZW5pemVTdHJpbmcocXVlcnksIHJ1bGVzLCB3b3Jkcyk7XG4gICAgZXZhbHVhdGVSYW5nZVJ1bGVzVG9Qb3NpdGlvbih0b2tlblN0cnVjdC50b2tlbnMsIHRva2VuU3RydWN0LmZ1c2FibGUsIHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiQWZ0ZXIgbWF0Y2hlZCBcIiArIEpTT04uc3RyaW5naWZ5KHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpKTtcbiAgICB9XG4gICAgdmFyIGFTZW50ZW5jZXMgPSBleHBhbmRUb2tlbk1hdGNoZXNUb1NlbnRlbmNlcyh0b2tlblN0cnVjdC50b2tlbnMsIHRva2VuU3RydWN0LmNhdGVnb3JpemVkV29yZHMpO1xuICAgIGlmIChkZWJ1Z2xvZy5lbmFibGVkKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiYWZ0ZXIgZXhwYW5kXCIgKyBhU2VudGVuY2VzLnNlbnRlbmNlcy5tYXAoZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIFNlbnRlbmNlLnJhbmtpbmdQcm9kdWN0KG9TZW50ZW5jZSkgKyBcIjpcIiArIFNlbnRlbmNlLmR1bXBOaWNlKG9TZW50ZW5jZSk7IC8vSlNPTi5zdHJpbmdpZnkob1NlbnRlbmNlKTtcbiAgICAgICAgfSkuam9pbihcIlxcblwiKSk7XG4gICAgfVxuICAgIGFTZW50ZW5jZXMuc2VudGVuY2VzID0gSW5wdXRGaWx0ZXIucmVpbkZvcmNlKGFTZW50ZW5jZXMuc2VudGVuY2VzKTtcbiAgICBpZiAoZGVidWdsb2cuZW5hYmxlZCkge1xuICAgICAgICBkZWJ1Z2xvZyhcImFmdGVyIHJlaW5mb3JjZVwiICsgYVNlbnRlbmNlcy5zZW50ZW5jZXMubWFwKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBTZW50ZW5jZS5yYW5raW5nUHJvZHVjdChvU2VudGVuY2UpICsgXCI6XCIgKyBKU09OLnN0cmluZ2lmeShvU2VudGVuY2UpO1xuICAgICAgICB9KS5qb2luKFwiXFxuXCIpKTtcbiAgICB9XG4gICAgcmV0dXJuIGFTZW50ZW5jZXM7XG59XG5leHBvcnRzLnByb2Nlc3NTdHJpbmcgPSBwcm9jZXNzU3RyaW5nO1xuZnVuY3Rpb24gc2ltcGxpZnlTZW50ZW5jZShyZXMpIHtcbiAgICByZXR1cm4gcmVzLm1hcChmdW5jdGlvbiAocikge1xuICAgICAgICByZXR1cm4gci5tYXAoZnVuY3Rpb24gKHdvcmQpIHsgcmV0dXJuIHdvcmQuc3RyaW5nICsgJz0+JyArIHdvcmQubWF0Y2hlZFN0cmluZyArICcvJyArIHdvcmQuY2F0ZWdvcnkgKyAod29yZC5zcGFuID8gJy8nICsgd29yZC5zcGFuIDogJycpOyB9KTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuc2ltcGxpZnlTZW50ZW5jZSA9IHNpbXBsaWZ5U2VudGVuY2U7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
