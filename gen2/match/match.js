/**
 * @file match
 * @module jfseb.fdevstart.match
 * @copyright (c) Gerd Forstmann
 *
 *
 * Judging function for a match
 */
"use strict";

var debug = require('debug');
var debuglog = debug('match');
function weakenByN(a, n) {
    return 1.0 + (a - 1.0) / n;
}
function calcRankingProduct(oSet) {
    var factor = Object.keys(oSet).reduce(function (prev, sCategory) {
        return prev *= oSet[sCategory]._ranking;
    }, 1.0);
    return factor;
}
exports.calcRankingProduct = calcRankingProduct;
function calcGeometricMeansOfRanking(oSet) {
    var keys = Object.keys(oSet);
    if (!keys.length) {
        return 1.0;
    }
    var factor = calcRankingProduct(oSet);
    return Math.pow(factor, 1 / keys.length);
}
/**
 * Calculate a number to rank a matched tool
 *
 *
 */
function rankToolMatch(a) {
    var missing = Object.keys(a.missing || {}).length;
    var required = Object.keys(a.required || {}).length;
    var optional = Object.keys(a.optional || {}).length;
    var spurious = Object.keys(a.spurious || {}).length;
    var matching = required + optional;
    debuglog("caluclating rank of " + JSON.stringify(a));
    var rankingRequired = calcGeometricMeansOfRanking(a.required);
    var rankingOptional = calcGeometricMeansOfRanking(a.optional);
    // 1.1 for every optional;
    //  0.9 for every spurious
    //  for every required
    var spuriousDeprec = Math.pow(0.9, Object.keys(a.spurious).length);
    // 0.8 for every missing;
    var missingDeprec = Math.pow(0.8, Object.keys(a.missing).length);
    // 1.1 for toolmentiond
    if (a.toolmentioned) {
        res *= 1.1;
    }
    var res = missingDeprec * spuriousDeprec * weakenByN(rankingRequired * rankingOptional, 10);
    //  var res =  matching * 100 - 30 * missing  -  10* spurious + factor;
    debuglog("result is " + res);
    return res;
}
exports.rankToolMatch = rankToolMatch;
;
exports.ToolMatch = {
    rankResult: function rankResult(a) {
        return rankToolMatch(a);
    },
    isAnyMatch: function isAnyMatch(toolmatch) {
        return Object.keys(toolmatch.toolmatchresult.required).length + Object.keys(toolmatch.toolmatchresult.optional).length > 0;
    },
    compBetterMatch: function compBetterMatch(a, b) {
        return rankToolMatch(b.toolmatchresult) - rankToolMatch(a.toolmatchresult);
    },
    isComplete: function isComplete(toolmatch) {
        return Object.keys(toolmatch.toolmatchresult.missing).length === 0;
    },
    dumpNiceTop: function dumpNiceTop(toolmatches, options) {
        var s = '';
        toolmatches.forEach(function (oMatch, index) {
            if (index < options.top) {
                s = s + "Toolmatch[" + index + "]...\n";
                s = s + exports.ToolMatch.dumpNice(oMatch);
            }
        });
        return s;
    },
    dumpNice: function dumpNice(toolmatch) {
        var result = {
            s: "",
            push: function push(s) {
                this.s = this.s + s;
            }
        };
        var s = "**Result for tool: " + toolmatch.tool.name + "\n rank: " + toolmatch.rank + "\n";
        result.push(s);
        Object.keys(toolmatch.tool.requires).forEach(function (sRequires, index) {
            result.push("required: " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.required[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.required[sRequires].matchedString + '"');
            } else {
                result.push("? missing!");
            }
            result.push('\n');
        });
        Object.keys(toolmatch.tool.optional).forEach(function (sRequires, index) {
            result.push("optional : " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.optional[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.optional[sRequires].matchedString + '"');
            } else {
                result.push("?");
            }
            result.push('\n');
        });
        var oSentence = toolmatch.sentence;
        oSentence.forEach(function (oWord, index) {
            var sWord = "[" + index + "] : " + oWord.category + " \"" + oWord.string + "\" => \"" + oWord.matchedString + "\"";
            result.push(sWord + "\n");
        });
        result.push(".\n");
        return result.s;
    },
    dumpWeightsTop: function dumpWeightsTop(toolmatches, options) {
        var s = '';
        toolmatches.forEach(function (oMatch, index) {
            if (index < options.top) {
                s = s + "Toolmatch[" + index + "]...\n";
                s = s + exports.ToolMatch.dumpWeights(oMatch);
            }
        });
        return s;
    },
    dumpWeights: function dumpWeights(toolmatch) {
        var result = {
            s: "",
            push: function push(s) {
                this.s = this.s + s;
            }
        };
        var requires = Object.keys(toolmatch.tool.requires).length;
        var required = Object.keys(toolmatch.toolmatchresult.required).length;
        var spurious = Object.keys(toolmatch.toolmatchresult.spurious).length;
        var s = "**Result for tool: " + toolmatch.tool.name + "\n rank: " + toolmatch.rank + "  (req:" + required + "/" + requires + "   " + spurious + ")\n";
        result.push(s);
        Object.keys(toolmatch.tool.requires).forEach(function (sRequires, index) {
            result.push("required: " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.required[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.required[sRequires].matchedString + '"');
            } else {
                result.push("? missing!");
            }
            result.push('\n');
        });
        Object.keys(toolmatch.tool.optional).forEach(function (sRequires, index) {
            result.push("optional : " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.optional[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.optional[sRequires].matchedString + '"');
            } else {
                result.push("?");
            }
            result.push('\n');
        });
        var oSentence = toolmatch.sentence;
        oSentence.forEach(function (oWord, index) {
            var sWord = "[" + index + "] : " + oWord.category + " \"" + oWord.string + "\" => \"" + oWord.matchedString + "\"  (_r:" + oWord._ranking + "/" + (oWord.reinforce || '') + "/" + (oWord.levenmatch || '') + ")";
            result.push(sWord + "\n");
        });
        result.push(".\n");
        return result.s;
    }
};
exports.Result = {
    getEntity: function getEntity(match, key) {
        if (!match.toolmatchresult) {
            return undefined;
        }
        if (match.toolmatchresult.required[key]) {
            return match.toolmatchresult.required[key];
        }
        if (match.toolmatchresult.optional[key]) {
            return match.toolmatchresult.optional[key];
        }
        return undefined;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9tYXRjaC50cyIsIm1hdGNoL21hdGNoLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwid2Vha2VuQnlOIiwiYSIsIm4iLCJjYWxjUmFua2luZ1Byb2R1Y3QiLCJvU2V0IiwiZmFjdG9yIiwiT2JqZWN0Iiwia2V5cyIsInJlZHVjZSIsInByZXYiLCJzQ2F0ZWdvcnkiLCJfcmFua2luZyIsImV4cG9ydHMiLCJjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmciLCJsZW5ndGgiLCJNYXRoIiwicG93IiwicmFua1Rvb2xNYXRjaCIsIm1pc3NpbmciLCJyZXF1aXJlZCIsIm9wdGlvbmFsIiwic3B1cmlvdXMiLCJtYXRjaGluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJyYW5raW5nUmVxdWlyZWQiLCJyYW5raW5nT3B0aW9uYWwiLCJzcHVyaW91c0RlcHJlYyIsIm1pc3NpbmdEZXByZWMiLCJ0b29sbWVudGlvbmVkIiwicmVzIiwiVG9vbE1hdGNoIiwicmFua1Jlc3VsdCIsImlzQW55TWF0Y2giLCJ0b29sbWF0Y2giLCJ0b29sbWF0Y2hyZXN1bHQiLCJjb21wQmV0dGVyTWF0Y2giLCJiIiwiaXNDb21wbGV0ZSIsImR1bXBOaWNlVG9wIiwidG9vbG1hdGNoZXMiLCJvcHRpb25zIiwicyIsImZvckVhY2giLCJvTWF0Y2giLCJpbmRleCIsInRvcCIsImR1bXBOaWNlIiwicmVzdWx0IiwicHVzaCIsInRvb2wiLCJuYW1lIiwicmFuayIsInJlcXVpcmVzIiwic1JlcXVpcmVzIiwibWF0Y2hlZFN0cmluZyIsIm9TZW50ZW5jZSIsInNlbnRlbmNlIiwib1dvcmQiLCJzV29yZCIsImNhdGVnb3J5Iiwic3RyaW5nIiwiZHVtcFdlaWdodHNUb3AiLCJkdW1wV2VpZ2h0cyIsInJlaW5mb3JjZSIsImxldmVubWF0Y2giLCJSZXN1bHQiLCJnZXRFbnRpdHkiLCJtYXRjaCIsImtleSIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6IkFB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T0MsU0FBUDtBQUNEO0FBYm1CLENBQVQiLCJmaWxlIjoibWF0Y2gvbWF0Y2guanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIG1hdGNoXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC5tYXRjaFxuICogQGNvcHlyaWdodCAoYykgR2VyZCBGb3JzdG1hbm5cbiAqXG4gKlxuICogSnVkZ2luZyBmdW5jdGlvbiBmb3IgYSBtYXRjaFxuICovXG5cblxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnbWF0Y2gnKTtcbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuL2lmbWF0Y2gnO1xuaW1wb3J0ICogYXMgc3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5cblxuZnVuY3Rpb24gd2Vha2VuQnlOKGEgOiBudW1iZXIsIG4gOiBudW1iZXIpIDogbnVtYmVyIHtcbiAgcmV0dXJuIDEuMCArIChhLTEuMCkvbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGNSYW5raW5nUHJvZHVjdChvU2V0IDogeyBba2V5IDogc3RyaW5nXSA6IElNYXRjaC5JV29yZH0gKSA6IG51bWJlciB7XG4gdmFyIGZhY3RvciA9IE9iamVjdC5rZXlzKG9TZXQpLnJlZHVjZShmdW5jdGlvbihwcmV2LCBzQ2F0ZWdvcnkpIHtcbiAgICByZXR1cm4gcHJldiAqPSBvU2V0W3NDYXRlZ29yeV0uX3Jhbmtpbmc7XG4gIH0sMS4wKTtcbiAgcmV0dXJuIGZhY3Rvcjtcbn1cblxuZnVuY3Rpb24gY2FsY0dlb21ldHJpY01lYW5zT2ZSYW5raW5nKG9TZXQgOiB7IFtrZXkgOiBzdHJpbmddIDogSU1hdGNoLklXb3JkfSkge1xuICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9TZXQpO1xuICBpZigha2V5cy5sZW5ndGgpIHtcbiAgICByZXR1cm4gMS4wO1xuICB9XG4gIHZhciBmYWN0b3IgPSBjYWxjUmFua2luZ1Byb2R1Y3Qob1NldCk7XG4gIHJldHVybiBNYXRoLnBvdyhmYWN0b3IsIDEva2V5cy5sZW5ndGgpO1xufVxuLyoqXG4gKiBDYWxjdWxhdGUgYSBudW1iZXIgdG8gcmFuayBhIG1hdGNoZWQgdG9vbFxuICpcbiAqXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByYW5rVG9vbE1hdGNoKGE6IElNYXRjaC5JVG9vbE1hdGNoUmVzdWx0KSA6IG51bWJlciB7XG4gIHZhciBtaXNzaW5nID0gT2JqZWN0LmtleXMoYS5taXNzaW5nIHx8IHt9KS5sZW5ndGg7XG4gIHZhciByZXF1aXJlZCA9IE9iamVjdC5rZXlzKGEucmVxdWlyZWQgfHwge30pLmxlbmd0aDtcbiAgdmFyIG9wdGlvbmFsID0gT2JqZWN0LmtleXMoYS5vcHRpb25hbCB8fCB7fSkgLmxlbmd0aDtcbiAgdmFyIHNwdXJpb3VzID0gT2JqZWN0LmtleXMoYS5zcHVyaW91cyB8fCB7fSkubGVuZ3RoO1xuICB2YXIgbWF0Y2hpbmcgPSByZXF1aXJlZCArIG9wdGlvbmFsO1xuICBkZWJ1Z2xvZyhcImNhbHVjbGF0aW5nIHJhbmsgb2YgXCIgKyBKU09OLnN0cmluZ2lmeShhKSk7XG4gIHZhciByYW5raW5nUmVxdWlyZWQgPSBjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmcoYS5yZXF1aXJlZCk7XG4gIHZhciByYW5raW5nT3B0aW9uYWwgPSBjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmcoYS5vcHRpb25hbCk7XG5cbiAgLy8gMS4xIGZvciBldmVyeSBvcHRpb25hbDtcblxuIC8vICAwLjkgZm9yIGV2ZXJ5IHNwdXJpb3VzXG4gLy8gIGZvciBldmVyeSByZXF1aXJlZFxuIHZhciBzcHVyaW91c0RlcHJlYyA9IE1hdGgucG93KDAuOSwgT2JqZWN0LmtleXMoYS5zcHVyaW91cykubGVuZ3RoKTtcbiAvLyAwLjggZm9yIGV2ZXJ5IG1pc3Npbmc7XG4gdmFyIG1pc3NpbmdEZXByZWMgPSBNYXRoLnBvdygwLjgsIE9iamVjdC5rZXlzKGEubWlzc2luZykubGVuZ3RoKTtcblxuIC8vIDEuMSBmb3IgdG9vbG1lbnRpb25kXG4gaWYoYS50b29sbWVudGlvbmVkKSB7XG4gICByZXMgKj0gMS4xO1xuIH1cblxuIHZhciByZXMgPSBtaXNzaW5nRGVwcmVjICogc3B1cmlvdXNEZXByZWMgKiAod2Vha2VuQnlOKHJhbmtpbmdSZXF1aXJlZCpyYW5raW5nT3B0aW9uYWwsIDEwKSlcbi8vICB2YXIgcmVzID0gIG1hdGNoaW5nICogMTAwIC0gMzAgKiBtaXNzaW5nICAtICAxMCogc3B1cmlvdXMgKyBmYWN0b3I7XG4gIGRlYnVnbG9nKFwicmVzdWx0IGlzIFwiICsgcmVzKTtcbiAgcmV0dXJuIHJlcztcbn07XG5cbmV4cG9ydCBjb25zdCBUb29sTWF0Y2ggPSB7XG4gIHJhbmtSZXN1bHQ6IGZ1bmN0aW9uKGE6IElNYXRjaC5JVG9vbE1hdGNoUmVzdWx0KSA6IG51bWJlciB7XG4gICAgcmV0dXJuIHJhbmtUb29sTWF0Y2goYSk7XG4gIH0sXG4gIGlzQW55TWF0Y2g6IGZ1bmN0aW9uKHRvb2xtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoKSA6IGJvb2xlYW4gIHtcbiAgICByZXR1cm4gKE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWQpLmxlbmd0aCArXG4gICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWwpLmxlbmd0aCkgPiAwO1xuICB9LFxuICBjb21wQmV0dGVyTWF0Y2goYSA6IElNYXRjaC5JVG9vbE1hdGNoLCBiIDogSU1hdGNoLklUb29sTWF0Y2gpIHtcbiAgICByZXR1cm4gcmFua1Rvb2xNYXRjaChiLnRvb2xtYXRjaHJlc3VsdCApIC0gcmFua1Rvb2xNYXRjaChhLnRvb2xtYXRjaHJlc3VsdCk7XG4gIH0sXG4gIGlzQ29tcGxldGU6IGZ1bmN0aW9uKHRvb2xtYXRjaDogSU1hdGNoLklUb29sTWF0Y2gpIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nKS5sZW5ndGggPT09IDA7XG4gIH0sXG5cbiAgZHVtcE5pY2VUb3AgOiBmdW5jdGlvbih0b29sbWF0Y2hlcyA6IEFycmF5PElNYXRjaC5JVG9vbE1hdGNoPiwgb3B0aW9ucyA6IGFueSkge1xuICAgIHZhciBzID0gJyc7XG4gICAgdG9vbG1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbihvTWF0Y2gsaW5kZXgpIHtcbiAgICAgIGlmICggaW5kZXggPCBvcHRpb25zLnRvcCkge1xuICAgICAgICBzID0gcyArIFwiVG9vbG1hdGNoW1wiICsgaW5kZXggKyBcIl0uLi5cXG5cIjtcbiAgICAgICAgcyA9IHMgKyBUb29sTWF0Y2guZHVtcE5pY2Uob01hdGNoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcztcbiAgfSxcblxuICBkdW1wTmljZSA6IGZ1bmN0aW9uKHRvb2xtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgIHMgOiBcIlwiLFxuICAgICAgcHVzaCA6IGZ1bmN0aW9uKHMpIHsgdGhpcy5zID0gdGhpcy5zICsgczsgfVxuICAgIH07XG4gICAgdmFyIHMgPVxuYCoqUmVzdWx0IGZvciB0b29sOiAke3Rvb2xtYXRjaC50b29sLm5hbWV9XG4gcmFuazogJHt0b29sbWF0Y2gucmFua31cbmA7XG4gICAgcmVzdWx0LnB1c2gocyk7XG4gICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmZvckVhY2goZnVuY3Rpb24oc1JlcXVpcmVzLGluZGV4KSB7XG4gICAgICByZXN1bHQucHVzaChgcmVxdWlyZWQ6ICR7c1JlcXVpcmVzfSAtPiBgKTtcbiAgICAgIGlmICh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10pIHtcbiAgICAgICAgcmVzdWx0LnB1c2goJ1wiJyArIHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbc1JlcXVpcmVzXS5tYXRjaGVkU3RyaW5nICsgJ1wiJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQucHVzaChgPyBtaXNzaW5nIWApO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgIH0pO1xuXG4gICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wub3B0aW9uYWwpLmZvckVhY2goZnVuY3Rpb24oc1JlcXVpcmVzLGluZGV4KSB7XG4gICAgICByZXN1bHQucHVzaChgb3B0aW9uYWwgOiAke3NSZXF1aXJlc30gLT4gYCk7XG4gICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKGA/YCk7XG4gICAgICB9XG4gICAgICByZXN1bHQucHVzaCgnXFxuJyk7XG4gICAgfSk7XG4gICAgdmFyIG9TZW50ZW5jZSA9IHRvb2xtYXRjaC5zZW50ZW5jZTtcbiAgICBvU2VudGVuY2UuZm9yRWFjaChmdW5jdGlvbihvV29yZCwgaW5kZXgpIHtcbiAgICAgIHZhciBzV29yZCA9IGBbJHtpbmRleH1dIDogJHtvV29yZC5jYXRlZ29yeX0gXCIke29Xb3JkLnN0cmluZ31cIiA9PiBcIiR7b1dvcmQubWF0Y2hlZFN0cmluZ31cImBcbiAgICAgIHJlc3VsdC5wdXNoKHNXb3JkICsgXCJcXG5cIik7XG4gICAgfSlcbiAgICByZXN1bHQucHVzaChcIi5cXG5cIik7XG4gICAgcmV0dXJuIHJlc3VsdC5zO1xuXG4gIH0sXG5cbiAgZHVtcFdlaWdodHNUb3AgOiBmdW5jdGlvbih0b29sbWF0Y2hlcyA6IEFycmF5PElNYXRjaC5JVG9vbE1hdGNoPiwgb3B0aW9ucyA6IGFueSkge1xuICAgIHZhciBzID0gJyc7XG4gICAgdG9vbG1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbihvTWF0Y2gsaW5kZXgpIHtcbiAgICAgIGlmICggaW5kZXggPCBvcHRpb25zLnRvcCkge1xuICAgICAgICBzID0gcyArIFwiVG9vbG1hdGNoW1wiICsgaW5kZXggKyBcIl0uLi5cXG5cIjtcbiAgICAgICAgcyA9IHMgKyBUb29sTWF0Y2guZHVtcFdlaWdodHMob01hdGNoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcztcbiAgfSxcblxuICBkdW1wV2VpZ2h0cyA6IGZ1bmN0aW9uKHRvb2xtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgIHMgOiBcIlwiLFxuICAgICAgcHVzaCA6IGZ1bmN0aW9uKHMpIHsgdGhpcy5zID0gdGhpcy5zICsgczsgfVxuICAgIH07XG5cbiAgdmFyIHJlcXVpcmVzID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmxlbmd0aDtcbiAgdmFyIHJlcXVpcmVkID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZCkubGVuZ3RoO1xuXG4gICAgdmFyIHNwdXJpb3VzID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5zcHVyaW91cykubGVuZ3RoO1xuICAgIHZhciBzID1cbmAqKlJlc3VsdCBmb3IgdG9vbDogJHt0b29sbWF0Y2gudG9vbC5uYW1lfVxuIHJhbms6ICR7dG9vbG1hdGNoLnJhbmt9ICAocmVxOiR7cmVxdWlyZWR9LyR7cmVxdWlyZXN9ICAgJHtzcHVyaW91c30pXG5gXG4gICAgcmVzdWx0LnB1c2gocyk7XG4gICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmZvckVhY2goZnVuY3Rpb24oc1JlcXVpcmVzLGluZGV4KSB7XG4gICAgICByZXN1bHQucHVzaChgcmVxdWlyZWQ6ICR7c1JlcXVpcmVzfSAtPiBgKTtcbiAgICAgIGlmICh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10pIHtcbiAgICAgICAgcmVzdWx0LnB1c2goJ1wiJyArIHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbc1JlcXVpcmVzXS5tYXRjaGVkU3RyaW5nICsgJ1wiJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQucHVzaChgPyBtaXNzaW5nIWApO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgIH0pO1xuXG4gICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wub3B0aW9uYWwpLmZvckVhY2goZnVuY3Rpb24oc1JlcXVpcmVzLGluZGV4KSB7XG4gICAgICByZXN1bHQucHVzaChgb3B0aW9uYWwgOiAke3NSZXF1aXJlc30gLT4gYCk7XG4gICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKGA/YCk7XG4gICAgICB9XG4gICAgICByZXN1bHQucHVzaCgnXFxuJyk7XG4gICAgfSk7XG4gICAgdmFyIG9TZW50ZW5jZSA9IHRvb2xtYXRjaC5zZW50ZW5jZTtcbiAgICBvU2VudGVuY2UuZm9yRWFjaChmdW5jdGlvbihvV29yZCwgaW5kZXgpIHtcbiAgICAgIHZhciBzV29yZCA9IGBbJHtpbmRleH1dIDogJHtvV29yZC5jYXRlZ29yeX0gXCIke29Xb3JkLnN0cmluZ31cIiA9PiBcIiR7b1dvcmQubWF0Y2hlZFN0cmluZ31cIiAgKF9yOiR7b1dvcmQuX3Jhbmtpbmd9LyR7b1dvcmQucmVpbmZvcmNlIHx8ICcnfS8ke29Xb3JkLmxldmVubWF0Y2ggfHwgJyd9KWBcbiAgICAgIHJlc3VsdC5wdXNoKHNXb3JkICsgXCJcXG5cIik7XG4gICAgfSlcbiAgICByZXN1bHQucHVzaChcIi5cXG5cIik7XG4gICAgcmV0dXJuIHJlc3VsdC5zO1xuXG4gIH1cbn1cblxuXG5leHBvcnQgY29uc3QgUmVzdWx0ID0ge1xuICBnZXRFbnRpdHk6IGZ1bmN0aW9uKG1hdGNoIDogSU1hdGNoLklUb29sTWF0Y2gsIGtleSA6IHN0cmluZykgOiBJTWF0Y2guSVdvcmQge1xuICAgIGlmKCFtYXRjaC50b29sbWF0Y2hyZXN1bHQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgaWYobWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW2tleV0pIHtcbiAgICAgIHJldHVybiBtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRba2V5XTtcbiAgICB9XG4gICAgaWYobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW2tleV0pIHtcbiAgICAgIHJldHVybiBtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxba2V5XTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufSIsIi8qKlxuICogQGZpbGUgbWF0Y2hcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0Lm1hdGNoXG4gKiBAY29weXJpZ2h0IChjKSBHZXJkIEZvcnN0bWFublxuICpcbiAqXG4gKiBKdWRnaW5nIGZ1bmN0aW9uIGZvciBhIG1hdGNoXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdtYXRjaCcpO1xuZnVuY3Rpb24gd2Vha2VuQnlOKGEsIG4pIHtcbiAgICByZXR1cm4gMS4wICsgKGEgLSAxLjApIC8gbjtcbn1cbmZ1bmN0aW9uIGNhbGNSYW5raW5nUHJvZHVjdChvU2V0KSB7XG4gICAgdmFyIGZhY3RvciA9IE9iamVjdC5rZXlzKG9TZXQpLnJlZHVjZShmdW5jdGlvbiAocHJldiwgc0NhdGVnb3J5KSB7XG4gICAgICAgIHJldHVybiBwcmV2ICo9IG9TZXRbc0NhdGVnb3J5XS5fcmFua2luZztcbiAgICB9LCAxLjApO1xuICAgIHJldHVybiBmYWN0b3I7XG59XG5leHBvcnRzLmNhbGNSYW5raW5nUHJvZHVjdCA9IGNhbGNSYW5raW5nUHJvZHVjdDtcbmZ1bmN0aW9uIGNhbGNHZW9tZXRyaWNNZWFuc09mUmFua2luZyhvU2V0KSB7XG4gICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvU2V0KTtcbiAgICBpZiAoIWtleXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiAxLjA7XG4gICAgfVxuICAgIHZhciBmYWN0b3IgPSBjYWxjUmFua2luZ1Byb2R1Y3Qob1NldCk7XG4gICAgcmV0dXJuIE1hdGgucG93KGZhY3RvciwgMSAvIGtleXMubGVuZ3RoKTtcbn1cbi8qKlxuICogQ2FsY3VsYXRlIGEgbnVtYmVyIHRvIHJhbmsgYSBtYXRjaGVkIHRvb2xcbiAqXG4gKlxuICovXG5mdW5jdGlvbiByYW5rVG9vbE1hdGNoKGEpIHtcbiAgICB2YXIgbWlzc2luZyA9IE9iamVjdC5rZXlzKGEubWlzc2luZyB8fCB7fSkubGVuZ3RoO1xuICAgIHZhciByZXF1aXJlZCA9IE9iamVjdC5rZXlzKGEucmVxdWlyZWQgfHwge30pLmxlbmd0aDtcbiAgICB2YXIgb3B0aW9uYWwgPSBPYmplY3Qua2V5cyhhLm9wdGlvbmFsIHx8IHt9KS5sZW5ndGg7XG4gICAgdmFyIHNwdXJpb3VzID0gT2JqZWN0LmtleXMoYS5zcHVyaW91cyB8fCB7fSkubGVuZ3RoO1xuICAgIHZhciBtYXRjaGluZyA9IHJlcXVpcmVkICsgb3B0aW9uYWw7XG4gICAgZGVidWdsb2coXCJjYWx1Y2xhdGluZyByYW5rIG9mIFwiICsgSlNPTi5zdHJpbmdpZnkoYSkpO1xuICAgIHZhciByYW5raW5nUmVxdWlyZWQgPSBjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmcoYS5yZXF1aXJlZCk7XG4gICAgdmFyIHJhbmtpbmdPcHRpb25hbCA9IGNhbGNHZW9tZXRyaWNNZWFuc09mUmFua2luZyhhLm9wdGlvbmFsKTtcbiAgICAvLyAxLjEgZm9yIGV2ZXJ5IG9wdGlvbmFsO1xuICAgIC8vICAwLjkgZm9yIGV2ZXJ5IHNwdXJpb3VzXG4gICAgLy8gIGZvciBldmVyeSByZXF1aXJlZFxuICAgIHZhciBzcHVyaW91c0RlcHJlYyA9IE1hdGgucG93KDAuOSwgT2JqZWN0LmtleXMoYS5zcHVyaW91cykubGVuZ3RoKTtcbiAgICAvLyAwLjggZm9yIGV2ZXJ5IG1pc3Npbmc7XG4gICAgdmFyIG1pc3NpbmdEZXByZWMgPSBNYXRoLnBvdygwLjgsIE9iamVjdC5rZXlzKGEubWlzc2luZykubGVuZ3RoKTtcbiAgICAvLyAxLjEgZm9yIHRvb2xtZW50aW9uZFxuICAgIGlmIChhLnRvb2xtZW50aW9uZWQpIHtcbiAgICAgICAgcmVzICo9IDEuMTtcbiAgICB9XG4gICAgdmFyIHJlcyA9IG1pc3NpbmdEZXByZWMgKiBzcHVyaW91c0RlcHJlYyAqICh3ZWFrZW5CeU4ocmFua2luZ1JlcXVpcmVkICogcmFua2luZ09wdGlvbmFsLCAxMCkpO1xuICAgIC8vICB2YXIgcmVzID0gIG1hdGNoaW5nICogMTAwIC0gMzAgKiBtaXNzaW5nICAtICAxMCogc3B1cmlvdXMgKyBmYWN0b3I7XG4gICAgZGVidWdsb2coXCJyZXN1bHQgaXMgXCIgKyByZXMpO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLnJhbmtUb29sTWF0Y2ggPSByYW5rVG9vbE1hdGNoO1xuO1xuZXhwb3J0cy5Ub29sTWF0Y2ggPSB7XG4gICAgcmFua1Jlc3VsdDogZnVuY3Rpb24gKGEpIHtcbiAgICAgICAgcmV0dXJuIHJhbmtUb29sTWF0Y2goYSk7XG4gICAgfSxcbiAgICBpc0FueU1hdGNoOiBmdW5jdGlvbiAodG9vbG1hdGNoKSB7XG4gICAgICAgIHJldHVybiAoT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZCkubGVuZ3RoICtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWwpLmxlbmd0aCkgPiAwO1xuICAgIH0sXG4gICAgY29tcEJldHRlck1hdGNoOiBmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICByZXR1cm4gcmFua1Rvb2xNYXRjaChiLnRvb2xtYXRjaHJlc3VsdCkgLSByYW5rVG9vbE1hdGNoKGEudG9vbG1hdGNocmVzdWx0KTtcbiAgICB9LFxuICAgIGlzQ29tcGxldGU6IGZ1bmN0aW9uICh0b29sbWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQubWlzc2luZykubGVuZ3RoID09PSAwO1xuICAgIH0sXG4gICAgZHVtcE5pY2VUb3A6IGZ1bmN0aW9uICh0b29sbWF0Y2hlcywgb3B0aW9ucykge1xuICAgICAgICB2YXIgcyA9ICcnO1xuICAgICAgICB0b29sbWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvTWF0Y2gsIGluZGV4KSB7XG4gICAgICAgICAgICBpZiAoaW5kZXggPCBvcHRpb25zLnRvcCkge1xuICAgICAgICAgICAgICAgIHMgPSBzICsgXCJUb29sbWF0Y2hbXCIgKyBpbmRleCArIFwiXS4uLlxcblwiO1xuICAgICAgICAgICAgICAgIHMgPSBzICsgZXhwb3J0cy5Ub29sTWF0Y2guZHVtcE5pY2Uob01hdGNoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBzO1xuICAgIH0sXG4gICAgZHVtcE5pY2U6IGZ1bmN0aW9uICh0b29sbWF0Y2gpIHtcbiAgICAgICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgICAgICAgIHM6IFwiXCIsXG4gICAgICAgICAgICBwdXNoOiBmdW5jdGlvbiAocykgeyB0aGlzLnMgPSB0aGlzLnMgKyBzOyB9XG4gICAgICAgIH07XG4gICAgICAgIHZhciBzID0gXCIqKlJlc3VsdCBmb3IgdG9vbDogXCIgKyB0b29sbWF0Y2gudG9vbC5uYW1lICsgXCJcXG4gcmFuazogXCIgKyB0b29sbWF0Y2gucmFuayArIFwiXFxuXCI7XG4gICAgICAgIHJlc3VsdC5wdXNoKHMpO1xuICAgICAgICBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbC5yZXF1aXJlcykuZm9yRWFjaChmdW5jdGlvbiAoc1JlcXVpcmVzLCBpbmRleCkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goXCJyZXF1aXJlZDogXCIgKyBzUmVxdWlyZXMgKyBcIiAtPiBcIik7XG4gICAgICAgICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtzUmVxdWlyZXNdKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1wiJyArIHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbc1JlcXVpcmVzXS5tYXRjaGVkU3RyaW5nICsgJ1wiJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChcIj8gbWlzc2luZyFcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQucHVzaCgnXFxuJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbC5vcHRpb25hbCkuZm9yRWFjaChmdW5jdGlvbiAoc1JlcXVpcmVzLCBpbmRleCkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goXCJvcHRpb25hbCA6IFwiICsgc1JlcXVpcmVzICsgXCIgLT4gXCIpO1xuICAgICAgICAgICAgaWYgKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxbc1JlcXVpcmVzXSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goXCI/XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgICAgICB9KTtcbiAgICAgICAgdmFyIG9TZW50ZW5jZSA9IHRvb2xtYXRjaC5zZW50ZW5jZTtcbiAgICAgICAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkLCBpbmRleCkge1xuICAgICAgICAgICAgdmFyIHNXb3JkID0gXCJbXCIgKyBpbmRleCArIFwiXSA6IFwiICsgb1dvcmQuY2F0ZWdvcnkgKyBcIiBcXFwiXCIgKyBvV29yZC5zdHJpbmcgKyBcIlxcXCIgPT4gXFxcIlwiICsgb1dvcmQubWF0Y2hlZFN0cmluZyArIFwiXFxcIlwiO1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goc1dvcmQgKyBcIlxcblwiKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJlc3VsdC5wdXNoKFwiLlxcblwiKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5zO1xuICAgIH0sXG4gICAgZHVtcFdlaWdodHNUb3A6IGZ1bmN0aW9uICh0b29sbWF0Y2hlcywgb3B0aW9ucykge1xuICAgICAgICB2YXIgcyA9ICcnO1xuICAgICAgICB0b29sbWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChvTWF0Y2gsIGluZGV4KSB7XG4gICAgICAgICAgICBpZiAoaW5kZXggPCBvcHRpb25zLnRvcCkge1xuICAgICAgICAgICAgICAgIHMgPSBzICsgXCJUb29sbWF0Y2hbXCIgKyBpbmRleCArIFwiXS4uLlxcblwiO1xuICAgICAgICAgICAgICAgIHMgPSBzICsgZXhwb3J0cy5Ub29sTWF0Y2guZHVtcFdlaWdodHMob01hdGNoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBzO1xuICAgIH0sXG4gICAgZHVtcFdlaWdodHM6IGZ1bmN0aW9uICh0b29sbWF0Y2gpIHtcbiAgICAgICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgICAgICAgIHM6IFwiXCIsXG4gICAgICAgICAgICBwdXNoOiBmdW5jdGlvbiAocykgeyB0aGlzLnMgPSB0aGlzLnMgKyBzOyB9XG4gICAgICAgIH07XG4gICAgICAgIHZhciByZXF1aXJlcyA9IE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLnJlcXVpcmVzKS5sZW5ndGg7XG4gICAgICAgIHZhciByZXF1aXJlZCA9IE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWQpLmxlbmd0aDtcbiAgICAgICAgdmFyIHNwdXJpb3VzID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5zcHVyaW91cykubGVuZ3RoO1xuICAgICAgICB2YXIgcyA9IFwiKipSZXN1bHQgZm9yIHRvb2w6IFwiICsgdG9vbG1hdGNoLnRvb2wubmFtZSArIFwiXFxuIHJhbms6IFwiICsgdG9vbG1hdGNoLnJhbmsgKyBcIiAgKHJlcTpcIiArIHJlcXVpcmVkICsgXCIvXCIgKyByZXF1aXJlcyArIFwiICAgXCIgKyBzcHVyaW91cyArIFwiKVxcblwiO1xuICAgICAgICByZXN1bHQucHVzaChzKTtcbiAgICAgICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmZvckVhY2goZnVuY3Rpb24gKHNSZXF1aXJlcywgaW5kZXgpIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwicmVxdWlyZWQ6IFwiICsgc1JlcXVpcmVzICsgXCIgLT4gXCIpO1xuICAgICAgICAgICAgaWYgKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbc1JlcXVpcmVzXSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goXCI/IG1pc3NpbmchXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgICAgICB9KTtcbiAgICAgICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wub3B0aW9uYWwpLmZvckVhY2goZnVuY3Rpb24gKHNSZXF1aXJlcywgaW5kZXgpIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwib3B0aW9uYWwgOiBcIiArIHNSZXF1aXJlcyArIFwiIC0+IFwiKTtcbiAgICAgICAgICAgIGlmICh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW3NSZXF1aXJlc10pIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXCInICsgdG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdLm1hdGNoZWRTdHJpbmcgKyAnXCInKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwiP1wiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHZhciBvU2VudGVuY2UgPSB0b29sbWF0Y2guc2VudGVuY2U7XG4gICAgICAgIG9TZW50ZW5jZS5mb3JFYWNoKGZ1bmN0aW9uIChvV29yZCwgaW5kZXgpIHtcbiAgICAgICAgICAgIHZhciBzV29yZCA9IFwiW1wiICsgaW5kZXggKyBcIl0gOiBcIiArIG9Xb3JkLmNhdGVnb3J5ICsgXCIgXFxcIlwiICsgb1dvcmQuc3RyaW5nICsgXCJcXFwiID0+IFxcXCJcIiArIG9Xb3JkLm1hdGNoZWRTdHJpbmcgKyBcIlxcXCIgIChfcjpcIiArIG9Xb3JkLl9yYW5raW5nICsgXCIvXCIgKyAob1dvcmQucmVpbmZvcmNlIHx8ICcnKSArIFwiL1wiICsgKG9Xb3JkLmxldmVubWF0Y2ggfHwgJycpICsgXCIpXCI7XG4gICAgICAgICAgICByZXN1bHQucHVzaChzV29yZCArIFwiXFxuXCIpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmVzdWx0LnB1c2goXCIuXFxuXCIpO1xuICAgICAgICByZXR1cm4gcmVzdWx0LnM7XG4gICAgfVxufTtcbmV4cG9ydHMuUmVzdWx0ID0ge1xuICAgIGdldEVudGl0eTogZnVuY3Rpb24gKG1hdGNoLCBrZXkpIHtcbiAgICAgICAgaWYgKCFtYXRjaC50b29sbWF0Y2hyZXN1bHQpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtrZXldKSB7XG4gICAgICAgICAgICByZXR1cm4gbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtrZXldKSB7XG4gICAgICAgICAgICByZXR1cm4gbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG59O1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
