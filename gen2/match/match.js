/**
 * @file match
 * @module jfseb.fdevstart.match
 * @copyright (c) Gerd Forstmann
 *
 *
 * Judging function for a match
 */
"use strict";

var debug = require("debug");
var debuglog = debug('match');
function weakenByN(a, n) {
    return 1.0 + (a - 1.0) / n;
}
function calcRankingProduct(oSet) {
    var factor = Object.keys(oSet).reduce(function (prev, sCategory) {
        return prev *= oSet[sCategory]._ranking;
    }, 1.0);
    return factor;
}
exports.calcRankingProduct = calcRankingProduct;
function calcGeometricMeansOfRanking(oSet) {
    var keys = Object.keys(oSet);
    if (!keys.length) {
        return 1.0;
    }
    var factor = calcRankingProduct(oSet);
    return Math.pow(factor, 1 / keys.length);
}
/**
 * Calculate a number to rank a matched tool
 *
 *
 */
function rankToolMatch(a) {
    var missing = Object.keys(a.missing || {}).length;
    var required = Object.keys(a.required || {}).length;
    var optional = Object.keys(a.optional || {}).length;
    var spurious = Object.keys(a.spurious || {}).length;
    var matching = required + optional;
    debuglog(debuglog.enabled ? "caluclating rank of " + JSON.stringify(a) : '-');
    var rankingRequired = calcGeometricMeansOfRanking(a.required);
    var rankingOptional = calcGeometricMeansOfRanking(a.optional);
    // 1.1 for every optional;
    //  0.9 for every spurious
    //  for every required
    var spuriousDeprec = Math.pow(0.9, Object.keys(a.spurious).length);
    // 0.8 for every missing;
    var missingDeprec = Math.pow(0.8, Object.keys(a.missing).length);
    // 1.1 for toolmentiond
    if (a.toolmentioned) {
        res *= 1.1;
    }
    var res = missingDeprec * spuriousDeprec * weakenByN(rankingRequired * rankingOptional, 10);
    //  var res =  matching * 100 - 30 * missing  -  10* spurious + factor;
    debuglog("result is " + res);
    return res;
}
exports.rankToolMatch = rankToolMatch;
;
exports.ToolMatch = {
    rankResult: function rankResult(a) {
        return rankToolMatch(a);
    },
    isAnyMatch: function isAnyMatch(toolmatch) {
        return Object.keys(toolmatch.toolmatchresult.required).length + Object.keys(toolmatch.toolmatchresult.optional).length > 0;
    },
    compBetterMatch: function compBetterMatch(a, b) {
        return rankToolMatch(b.toolmatchresult) - rankToolMatch(a.toolmatchresult);
    },
    isComplete: function isComplete(toolmatch) {
        return Object.keys(toolmatch.toolmatchresult.missing).length === 0;
    },
    dumpNiceTop: function dumpNiceTop(toolmatches, options) {
        var s = '';
        toolmatches.forEach(function (oMatch, index) {
            if (index < options.top) {
                s = s + "Toolmatch[" + index + "]...\n";
                s = s + exports.ToolMatch.dumpNice(oMatch);
            }
        });
        return s;
    },
    dumpNice: function dumpNice(toolmatch) {
        var result = {
            s: "",
            push: function push(s) {
                this.s = this.s + s;
            }
        };
        var s = "**Result for tool: " + toolmatch.tool.name + "\n rank: " + toolmatch.rank + "\n";
        result.push(s);
        Object.keys(toolmatch.tool.requires).forEach(function (sRequires, index) {
            result.push("required: " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.required[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.required[sRequires].matchedString + '"');
            } else {
                result.push("? missing!");
            }
            result.push('\n');
        });
        Object.keys(toolmatch.tool.optional).forEach(function (sRequires, index) {
            result.push("optional : " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.optional[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.optional[sRequires].matchedString + '"');
            } else {
                result.push("?");
            }
            result.push('\n');
        });
        var oSentence = toolmatch.sentence;
        oSentence.forEach(function (oWord, index) {
            var sWord = "[" + index + "] : " + oWord.category + " \"" + oWord.string + "\" => \"" + oWord.matchedString + "\"";
            result.push(sWord + "\n");
        });
        result.push(".\n");
        return result.s;
    },
    dumpWeightsTop: function dumpWeightsTop(toolmatches, options) {
        var s = '';
        toolmatches.forEach(function (oMatch, index) {
            if (index < options.top) {
                s = s + "Toolmatch[" + index + "]...\n";
                s = s + exports.ToolMatch.dumpWeights(oMatch);
            }
        });
        return s;
    },
    dumpWeights: function dumpWeights(toolmatch) {
        var result = {
            s: "",
            push: function push(s) {
                this.s = this.s + s;
            }
        };
        var requires = Object.keys(toolmatch.tool.requires).length;
        var required = Object.keys(toolmatch.toolmatchresult.required).length;
        var spurious = Object.keys(toolmatch.toolmatchresult.spurious).length;
        var s = "**Result for tool: " + toolmatch.tool.name + "\n rank: " + toolmatch.rank + "  (req:" + required + "/" + requires + "   " + spurious + ")\n";
        result.push(s);
        Object.keys(toolmatch.tool.requires).forEach(function (sRequires, index) {
            result.push("required: " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.required[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.required[sRequires].matchedString + '"');
            } else {
                result.push("? missing!");
            }
            result.push('\n');
        });
        Object.keys(toolmatch.tool.optional).forEach(function (sRequires, index) {
            result.push("optional : " + sRequires + " -> ");
            if (toolmatch.toolmatchresult.optional[sRequires]) {
                result.push('"' + toolmatch.toolmatchresult.optional[sRequires].matchedString + '"');
            } else {
                result.push("?");
            }
            result.push('\n');
        });
        var oSentence = toolmatch.sentence;
        oSentence.forEach(function (oWord, index) {
            var sWord = "[" + index + "] : " + oWord.category + " \"" + oWord.string + "\" => \"" + oWord.matchedString + "\"  (_r:" + oWord._ranking + "/" + (oWord.reinforce || '') + "/" + (oWord.levenmatch || '') + ")";
            result.push(sWord + "\n");
        });
        result.push(".\n");
        return result.s;
    }
};
exports.Result = {
    getEntity: function getEntity(match, key) {
        if (!match.toolmatchresult) {
            return undefined;
        }
        if (match.toolmatchresult.required[key]) {
            return match.toolmatchresult.required[key];
        }
        if (match.toolmatchresult.optional[key]) {
            return match.toolmatchresult.optional[key];
        }
        return undefined;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9tYXRjaC50cyIsIm1hdGNoL21hdGNoLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsImRlYnVnbG9nIiwid2Vha2VuQnlOIiwiYSIsIm4iLCJjYWxjUmFua2luZ1Byb2R1Y3QiLCJvU2V0IiwiZmFjdG9yIiwiT2JqZWN0Iiwia2V5cyIsInJlZHVjZSIsInByZXYiLCJzQ2F0ZWdvcnkiLCJfcmFua2luZyIsImV4cG9ydHMiLCJjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmciLCJsZW5ndGgiLCJNYXRoIiwicG93IiwicmFua1Rvb2xNYXRjaCIsIm1pc3NpbmciLCJyZXF1aXJlZCIsIm9wdGlvbmFsIiwic3B1cmlvdXMiLCJtYXRjaGluZyIsImVuYWJsZWQiLCJKU09OIiwic3RyaW5naWZ5IiwicmFua2luZ1JlcXVpcmVkIiwicmFua2luZ09wdGlvbmFsIiwic3B1cmlvdXNEZXByZWMiLCJtaXNzaW5nRGVwcmVjIiwidG9vbG1lbnRpb25lZCIsInJlcyIsIlRvb2xNYXRjaCIsInJhbmtSZXN1bHQiLCJpc0FueU1hdGNoIiwidG9vbG1hdGNoIiwidG9vbG1hdGNocmVzdWx0IiwiY29tcEJldHRlck1hdGNoIiwiYiIsImlzQ29tcGxldGUiLCJkdW1wTmljZVRvcCIsInRvb2xtYXRjaGVzIiwib3B0aW9ucyIsInMiLCJmb3JFYWNoIiwib01hdGNoIiwiaW5kZXgiLCJ0b3AiLCJkdW1wTmljZSIsInJlc3VsdCIsInB1c2giLCJ0b29sIiwibmFtZSIsInJhbmsiLCJyZXF1aXJlcyIsInNSZXF1aXJlcyIsIm1hdGNoZWRTdHJpbmciLCJvU2VudGVuY2UiLCJzZW50ZW5jZSIsIm9Xb3JkIiwic1dvcmQiLCJjYXRlZ29yeSIsInN0cmluZyIsImR1bXBXZWlnaHRzVG9wIiwiZHVtcFdlaWdodHMiLCJyZWluZm9yY2UiLCJsZXZlbm1hdGNoIiwiUmVzdWx0IiwiZ2V0RW50aXR5IiwibWF0Y2giLCJrZXkiLCJ1bmRlZmluZWQiXSwibWFw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c0JoQixRQUF0QixDQUErQmtELEdBQS9CLENBQVA7QUFDRDtBQUNELGVBQU9DLFNBQVA7QUFDRDtBQWJtQixDQUFUIiwiZmlsZSI6Im1hdGNoL21hdGNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBtYXRjaFxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQubWF0Y2hcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXG4gKlxuICpcbiAqIEp1ZGdpbmcgZnVuY3Rpb24gZm9yIGEgbWF0Y2hcbiAqL1xuXG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ21hdGNoJyk7XG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJztcbmltcG9ydCAqIGFzIHN0cmVhbSBmcm9tICdzdHJlYW0nO1xuXG5cbmZ1bmN0aW9uIHdlYWtlbkJ5TihhIDogbnVtYmVyLCBuIDogbnVtYmVyKSA6IG51bWJlciB7XG4gIHJldHVybiAxLjAgKyAoYS0xLjApL247XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjUmFua2luZ1Byb2R1Y3Qob1NldCA6IHsgW2tleSA6IHN0cmluZ10gOiBJTWF0Y2guSVdvcmR9ICkgOiBudW1iZXIge1xuIHZhciBmYWN0b3IgPSBPYmplY3Qua2V5cyhvU2V0KS5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgc0NhdGVnb3J5KSB7XG4gICAgcmV0dXJuIHByZXYgKj0gb1NldFtzQ2F0ZWdvcnldLl9yYW5raW5nO1xuICB9LDEuMCk7XG4gIHJldHVybiBmYWN0b3I7XG59XG5cbmZ1bmN0aW9uIGNhbGNHZW9tZXRyaWNNZWFuc09mUmFua2luZyhvU2V0IDogeyBba2V5IDogc3RyaW5nXSA6IElNYXRjaC5JV29yZH0pIHtcbiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvU2V0KTtcbiAgaWYoIWtleXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIDEuMDtcbiAgfVxuICB2YXIgZmFjdG9yID0gY2FsY1JhbmtpbmdQcm9kdWN0KG9TZXQpO1xuICByZXR1cm4gTWF0aC5wb3coZmFjdG9yLCAxL2tleXMubGVuZ3RoKTtcbn1cbi8qKlxuICogQ2FsY3VsYXRlIGEgbnVtYmVyIHRvIHJhbmsgYSBtYXRjaGVkIHRvb2xcbiAqXG4gKlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmFua1Rvb2xNYXRjaChhOiBJTWF0Y2guSVRvb2xNYXRjaFJlc3VsdCkgOiBudW1iZXIge1xuICB2YXIgbWlzc2luZyA9IE9iamVjdC5rZXlzKGEubWlzc2luZyB8fCB7fSkubGVuZ3RoO1xuICB2YXIgcmVxdWlyZWQgPSBPYmplY3Qua2V5cyhhLnJlcXVpcmVkIHx8IHt9KS5sZW5ndGg7XG4gIHZhciBvcHRpb25hbCA9IE9iamVjdC5rZXlzKGEub3B0aW9uYWwgfHwge30pIC5sZW5ndGg7XG4gIHZhciBzcHVyaW91cyA9IE9iamVjdC5rZXlzKGEuc3B1cmlvdXMgfHwge30pLmxlbmd0aDtcbiAgdmFyIG1hdGNoaW5nID0gcmVxdWlyZWQgKyBvcHRpb25hbDtcbiAgZGVidWdsb2coZGVidWdsb2cuZW5hYmxlZD8gKFwiY2FsdWNsYXRpbmcgcmFuayBvZiBcIiArIEpTT04uc3RyaW5naWZ5KGEpKSA6ICctJyk7XG4gIHZhciByYW5raW5nUmVxdWlyZWQgPSBjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmcoYS5yZXF1aXJlZCk7XG4gIHZhciByYW5raW5nT3B0aW9uYWwgPSBjYWxjR2VvbWV0cmljTWVhbnNPZlJhbmtpbmcoYS5vcHRpb25hbCk7XG5cbiAgLy8gMS4xIGZvciBldmVyeSBvcHRpb25hbDtcblxuIC8vICAwLjkgZm9yIGV2ZXJ5IHNwdXJpb3VzXG4gLy8gIGZvciBldmVyeSByZXF1aXJlZFxuIHZhciBzcHVyaW91c0RlcHJlYyA9IE1hdGgucG93KDAuOSwgT2JqZWN0LmtleXMoYS5zcHVyaW91cykubGVuZ3RoKTtcbiAvLyAwLjggZm9yIGV2ZXJ5IG1pc3Npbmc7XG4gdmFyIG1pc3NpbmdEZXByZWMgPSBNYXRoLnBvdygwLjgsIE9iamVjdC5rZXlzKGEubWlzc2luZykubGVuZ3RoKTtcblxuIC8vIDEuMSBmb3IgdG9vbG1lbnRpb25kXG4gaWYoYS50b29sbWVudGlvbmVkKSB7XG4gICByZXMgKj0gMS4xO1xuIH1cblxuIHZhciByZXMgPSBtaXNzaW5nRGVwcmVjICogc3B1cmlvdXNEZXByZWMgKiAod2Vha2VuQnlOKHJhbmtpbmdSZXF1aXJlZCpyYW5raW5nT3B0aW9uYWwsIDEwKSlcbi8vICB2YXIgcmVzID0gIG1hdGNoaW5nICogMTAwIC0gMzAgKiBtaXNzaW5nICAtICAxMCogc3B1cmlvdXMgKyBmYWN0b3I7XG4gIGRlYnVnbG9nKFwicmVzdWx0IGlzIFwiICsgcmVzKTtcbiAgcmV0dXJuIHJlcztcbn07XG5cbmV4cG9ydCBjb25zdCBUb29sTWF0Y2ggPSB7XG4gIHJhbmtSZXN1bHQ6IGZ1bmN0aW9uKGE6IElNYXRjaC5JVG9vbE1hdGNoUmVzdWx0KSA6IG51bWJlciB7XG4gICAgcmV0dXJuIHJhbmtUb29sTWF0Y2goYSk7XG4gIH0sXG4gIGlzQW55TWF0Y2g6IGZ1bmN0aW9uKHRvb2xtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoKSA6IGJvb2xlYW4gIHtcbiAgICByZXR1cm4gKE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWQpLmxlbmd0aCArXG4gICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWwpLmxlbmd0aCkgPiAwO1xuICB9LFxuICBjb21wQmV0dGVyTWF0Y2goYSA6IElNYXRjaC5JVG9vbE1hdGNoLCBiIDogSU1hdGNoLklUb29sTWF0Y2gpIHtcbiAgICByZXR1cm4gcmFua1Rvb2xNYXRjaChiLnRvb2xtYXRjaHJlc3VsdCApIC0gcmFua1Rvb2xNYXRjaChhLnRvb2xtYXRjaHJlc3VsdCk7XG4gIH0sXG4gIGlzQ29tcGxldGU6IGZ1bmN0aW9uKHRvb2xtYXRjaDogSU1hdGNoLklUb29sTWF0Y2gpIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nKS5sZW5ndGggPT09IDA7XG4gIH0sXG5cbiAgZHVtcE5pY2VUb3AgOiBmdW5jdGlvbih0b29sbWF0Y2hlcyA6IEFycmF5PElNYXRjaC5JVG9vbE1hdGNoPiwgb3B0aW9ucyA6IGFueSkge1xuICAgIHZhciBzID0gJyc7XG4gICAgdG9vbG1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbihvTWF0Y2gsaW5kZXgpIHtcbiAgICAgIGlmICggaW5kZXggPCBvcHRpb25zLnRvcCkge1xuICAgICAgICBzID0gcyArIFwiVG9vbG1hdGNoW1wiICsgaW5kZXggKyBcIl0uLi5cXG5cIjtcbiAgICAgICAgcyA9IHMgKyBUb29sTWF0Y2guZHVtcE5pY2Uob01hdGNoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcztcbiAgfSxcblxuICBkdW1wTmljZSA6IGZ1bmN0aW9uKHRvb2xtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgIHMgOiBcIlwiLFxuICAgICAgcHVzaCA6IGZ1bmN0aW9uKHMpIHsgdGhpcy5zID0gdGhpcy5zICsgczsgfVxuICAgIH07XG4gICAgdmFyIHMgPVxuYCoqUmVzdWx0IGZvciB0b29sOiAke3Rvb2xtYXRjaC50b29sLm5hbWV9XG4gcmFuazogJHt0b29sbWF0Y2gucmFua31cbmA7XG4gICAgcmVzdWx0LnB1c2gocyk7XG4gICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmZvckVhY2goZnVuY3Rpb24oc1JlcXVpcmVzLGluZGV4KSB7XG4gICAgICByZXN1bHQucHVzaChgcmVxdWlyZWQ6ICR7c1JlcXVpcmVzfSAtPiBgKTtcbiAgICAgIGlmICh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10pIHtcbiAgICAgICAgcmVzdWx0LnB1c2goJ1wiJyArIHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbc1JlcXVpcmVzXS5tYXRjaGVkU3RyaW5nICsgJ1wiJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQucHVzaChgPyBtaXNzaW5nIWApO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgIH0pO1xuXG4gICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wub3B0aW9uYWwpLmZvckVhY2goZnVuY3Rpb24oc1JlcXVpcmVzLGluZGV4KSB7XG4gICAgICByZXN1bHQucHVzaChgb3B0aW9uYWwgOiAke3NSZXF1aXJlc30gLT4gYCk7XG4gICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKGA/YCk7XG4gICAgICB9XG4gICAgICByZXN1bHQucHVzaCgnXFxuJyk7XG4gICAgfSk7XG4gICAgdmFyIG9TZW50ZW5jZSA9IHRvb2xtYXRjaC5zZW50ZW5jZTtcbiAgICBvU2VudGVuY2UuZm9yRWFjaChmdW5jdGlvbihvV29yZCwgaW5kZXgpIHtcbiAgICAgIHZhciBzV29yZCA9IGBbJHtpbmRleH1dIDogJHtvV29yZC5jYXRlZ29yeX0gXCIke29Xb3JkLnN0cmluZ31cIiA9PiBcIiR7b1dvcmQubWF0Y2hlZFN0cmluZ31cImBcbiAgICAgIHJlc3VsdC5wdXNoKHNXb3JkICsgXCJcXG5cIik7XG4gICAgfSlcbiAgICByZXN1bHQucHVzaChcIi5cXG5cIik7XG4gICAgcmV0dXJuIHJlc3VsdC5zO1xuXG4gIH0sXG5cbiAgZHVtcFdlaWdodHNUb3AgOiBmdW5jdGlvbih0b29sbWF0Y2hlcyA6IEFycmF5PElNYXRjaC5JVG9vbE1hdGNoPiwgb3B0aW9ucyA6IGFueSkge1xuICAgIHZhciBzID0gJyc7XG4gICAgdG9vbG1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbihvTWF0Y2gsaW5kZXgpIHtcbiAgICAgIGlmICggaW5kZXggPCBvcHRpb25zLnRvcCkge1xuICAgICAgICBzID0gcyArIFwiVG9vbG1hdGNoW1wiICsgaW5kZXggKyBcIl0uLi5cXG5cIjtcbiAgICAgICAgcyA9IHMgKyBUb29sTWF0Y2guZHVtcFdlaWdodHMob01hdGNoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcztcbiAgfSxcblxuICBkdW1wV2VpZ2h0cyA6IGZ1bmN0aW9uKHRvb2xtYXRjaCA6IElNYXRjaC5JVG9vbE1hdGNoKSB7XG4gICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgIHMgOiBcIlwiLFxuICAgICAgcHVzaCA6IGZ1bmN0aW9uKHMpIHsgdGhpcy5zID0gdGhpcy5zICsgczsgfVxuICAgIH07XG5cbiAgdmFyIHJlcXVpcmVzID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmxlbmd0aDtcbiAgdmFyIHJlcXVpcmVkID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZCkubGVuZ3RoO1xuXG4gICAgdmFyIHNwdXJpb3VzID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5zcHVyaW91cykubGVuZ3RoO1xuICAgIHZhciBzID1cbmAqKlJlc3VsdCBmb3IgdG9vbDogJHt0b29sbWF0Y2gudG9vbC5uYW1lfVxuIHJhbms6ICR7dG9vbG1hdGNoLnJhbmt9ICAocmVxOiR7cmVxdWlyZWR9LyR7cmVxdWlyZXN9ICAgJHtzcHVyaW91c30pXG5gXG4gICAgcmVzdWx0LnB1c2gocyk7XG4gICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmZvckVhY2goZnVuY3Rpb24oc1JlcXVpcmVzLGluZGV4KSB7XG4gICAgICByZXN1bHQucHVzaChgcmVxdWlyZWQ6ICR7c1JlcXVpcmVzfSAtPiBgKTtcbiAgICAgIGlmICh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10pIHtcbiAgICAgICAgcmVzdWx0LnB1c2goJ1wiJyArIHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbc1JlcXVpcmVzXS5tYXRjaGVkU3RyaW5nICsgJ1wiJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQucHVzaChgPyBtaXNzaW5nIWApO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgIH0pO1xuXG4gICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wub3B0aW9uYWwpLmZvckVhY2goZnVuY3Rpb24oc1JlcXVpcmVzLGluZGV4KSB7XG4gICAgICByZXN1bHQucHVzaChgb3B0aW9uYWwgOiAke3NSZXF1aXJlc30gLT4gYCk7XG4gICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKGA/YCk7XG4gICAgICB9XG4gICAgICByZXN1bHQucHVzaCgnXFxuJyk7XG4gICAgfSk7XG4gICAgdmFyIG9TZW50ZW5jZSA9IHRvb2xtYXRjaC5zZW50ZW5jZTtcbiAgICBvU2VudGVuY2UuZm9yRWFjaChmdW5jdGlvbihvV29yZCwgaW5kZXgpIHtcbiAgICAgIHZhciBzV29yZCA9IGBbJHtpbmRleH1dIDogJHtvV29yZC5jYXRlZ29yeX0gXCIke29Xb3JkLnN0cmluZ31cIiA9PiBcIiR7b1dvcmQubWF0Y2hlZFN0cmluZ31cIiAgKF9yOiR7b1dvcmQuX3Jhbmtpbmd9LyR7b1dvcmQucmVpbmZvcmNlIHx8ICcnfS8ke29Xb3JkLmxldmVubWF0Y2ggfHwgJyd9KWBcbiAgICAgIHJlc3VsdC5wdXNoKHNXb3JkICsgXCJcXG5cIik7XG4gICAgfSlcbiAgICByZXN1bHQucHVzaChcIi5cXG5cIik7XG4gICAgcmV0dXJuIHJlc3VsdC5zO1xuXG4gIH1cbn1cblxuXG5leHBvcnQgY29uc3QgUmVzdWx0ID0ge1xuICBnZXRFbnRpdHk6IGZ1bmN0aW9uKG1hdGNoIDogSU1hdGNoLklUb29sTWF0Y2gsIGtleSA6IHN0cmluZykgOiBJTWF0Y2guSVdvcmQge1xuICAgIGlmKCFtYXRjaC50b29sbWF0Y2hyZXN1bHQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgaWYobWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW2tleV0pIHtcbiAgICAgIHJldHVybiBtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRba2V5XTtcbiAgICB9XG4gICAgaWYobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW2tleV0pIHtcbiAgICAgIHJldHVybiBtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxba2V5XTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufSIsIi8qKlxuICogQGZpbGUgbWF0Y2hcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0Lm1hdGNoXG4gKiBAY29weXJpZ2h0IChjKSBHZXJkIEZvcnN0bWFublxuICpcbiAqXG4gKiBKdWRnaW5nIGZ1bmN0aW9uIGZvciBhIG1hdGNoXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ21hdGNoJyk7XG5mdW5jdGlvbiB3ZWFrZW5CeU4oYSwgbikge1xuICAgIHJldHVybiAxLjAgKyAoYSAtIDEuMCkgLyBuO1xufVxuZnVuY3Rpb24gY2FsY1JhbmtpbmdQcm9kdWN0KG9TZXQpIHtcbiAgICB2YXIgZmFjdG9yID0gT2JqZWN0LmtleXMob1NldCkucmVkdWNlKGZ1bmN0aW9uIChwcmV2LCBzQ2F0ZWdvcnkpIHtcbiAgICAgICAgcmV0dXJuIHByZXYgKj0gb1NldFtzQ2F0ZWdvcnldLl9yYW5raW5nO1xuICAgIH0sIDEuMCk7XG4gICAgcmV0dXJuIGZhY3Rvcjtcbn1cbmV4cG9ydHMuY2FsY1JhbmtpbmdQcm9kdWN0ID0gY2FsY1JhbmtpbmdQcm9kdWN0O1xuZnVuY3Rpb24gY2FsY0dlb21ldHJpY01lYW5zT2ZSYW5raW5nKG9TZXQpIHtcbiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9TZXQpO1xuICAgIGlmICgha2V5cy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIDEuMDtcbiAgICB9XG4gICAgdmFyIGZhY3RvciA9IGNhbGNSYW5raW5nUHJvZHVjdChvU2V0KTtcbiAgICByZXR1cm4gTWF0aC5wb3coZmFjdG9yLCAxIC8ga2V5cy5sZW5ndGgpO1xufVxuLyoqXG4gKiBDYWxjdWxhdGUgYSBudW1iZXIgdG8gcmFuayBhIG1hdGNoZWQgdG9vbFxuICpcbiAqXG4gKi9cbmZ1bmN0aW9uIHJhbmtUb29sTWF0Y2goYSkge1xuICAgIHZhciBtaXNzaW5nID0gT2JqZWN0LmtleXMoYS5taXNzaW5nIHx8IHt9KS5sZW5ndGg7XG4gICAgdmFyIHJlcXVpcmVkID0gT2JqZWN0LmtleXMoYS5yZXF1aXJlZCB8fCB7fSkubGVuZ3RoO1xuICAgIHZhciBvcHRpb25hbCA9IE9iamVjdC5rZXlzKGEub3B0aW9uYWwgfHwge30pLmxlbmd0aDtcbiAgICB2YXIgc3B1cmlvdXMgPSBPYmplY3Qua2V5cyhhLnNwdXJpb3VzIHx8IHt9KS5sZW5ndGg7XG4gICAgdmFyIG1hdGNoaW5nID0gcmVxdWlyZWQgKyBvcHRpb25hbDtcbiAgICBkZWJ1Z2xvZyhkZWJ1Z2xvZy5lbmFibGVkID8gKFwiY2FsdWNsYXRpbmcgcmFuayBvZiBcIiArIEpTT04uc3RyaW5naWZ5KGEpKSA6ICctJyk7XG4gICAgdmFyIHJhbmtpbmdSZXF1aXJlZCA9IGNhbGNHZW9tZXRyaWNNZWFuc09mUmFua2luZyhhLnJlcXVpcmVkKTtcbiAgICB2YXIgcmFua2luZ09wdGlvbmFsID0gY2FsY0dlb21ldHJpY01lYW5zT2ZSYW5raW5nKGEub3B0aW9uYWwpO1xuICAgIC8vIDEuMSBmb3IgZXZlcnkgb3B0aW9uYWw7XG4gICAgLy8gIDAuOSBmb3IgZXZlcnkgc3B1cmlvdXNcbiAgICAvLyAgZm9yIGV2ZXJ5IHJlcXVpcmVkXG4gICAgdmFyIHNwdXJpb3VzRGVwcmVjID0gTWF0aC5wb3coMC45LCBPYmplY3Qua2V5cyhhLnNwdXJpb3VzKS5sZW5ndGgpO1xuICAgIC8vIDAuOCBmb3IgZXZlcnkgbWlzc2luZztcbiAgICB2YXIgbWlzc2luZ0RlcHJlYyA9IE1hdGgucG93KDAuOCwgT2JqZWN0LmtleXMoYS5taXNzaW5nKS5sZW5ndGgpO1xuICAgIC8vIDEuMSBmb3IgdG9vbG1lbnRpb25kXG4gICAgaWYgKGEudG9vbG1lbnRpb25lZCkge1xuICAgICAgICByZXMgKj0gMS4xO1xuICAgIH1cbiAgICB2YXIgcmVzID0gbWlzc2luZ0RlcHJlYyAqIHNwdXJpb3VzRGVwcmVjICogKHdlYWtlbkJ5TihyYW5raW5nUmVxdWlyZWQgKiByYW5raW5nT3B0aW9uYWwsIDEwKSk7XG4gICAgLy8gIHZhciByZXMgPSAgbWF0Y2hpbmcgKiAxMDAgLSAzMCAqIG1pc3NpbmcgIC0gIDEwKiBzcHVyaW91cyArIGZhY3RvcjtcbiAgICBkZWJ1Z2xvZyhcInJlc3VsdCBpcyBcIiArIHJlcyk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMucmFua1Rvb2xNYXRjaCA9IHJhbmtUb29sTWF0Y2g7XG47XG5leHBvcnRzLlRvb2xNYXRjaCA9IHtcbiAgICByYW5rUmVzdWx0OiBmdW5jdGlvbiAoYSkge1xuICAgICAgICByZXR1cm4gcmFua1Rvb2xNYXRjaChhKTtcbiAgICB9LFxuICAgIGlzQW55TWF0Y2g6IGZ1bmN0aW9uICh0b29sbWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIChPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkKS5sZW5ndGggK1xuICAgICAgICAgICAgT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbCkubGVuZ3RoKSA+IDA7XG4gICAgfSxcbiAgICBjb21wQmV0dGVyTWF0Y2g6IGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgICAgIHJldHVybiByYW5rVG9vbE1hdGNoKGIudG9vbG1hdGNocmVzdWx0KSAtIHJhbmtUb29sTWF0Y2goYS50b29sbWF0Y2hyZXN1bHQpO1xuICAgIH0sXG4gICAgaXNDb21wbGV0ZTogZnVuY3Rpb24gKHRvb2xtYXRjaCkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5taXNzaW5nKS5sZW5ndGggPT09IDA7XG4gICAgfSxcbiAgICBkdW1wTmljZVRvcDogZnVuY3Rpb24gKHRvb2xtYXRjaGVzLCBvcHRpb25zKSB7XG4gICAgICAgIHZhciBzID0gJyc7XG4gICAgICAgIHRvb2xtYXRjaGVzLmZvckVhY2goZnVuY3Rpb24gKG9NYXRjaCwgaW5kZXgpIHtcbiAgICAgICAgICAgIGlmIChpbmRleCA8IG9wdGlvbnMudG9wKSB7XG4gICAgICAgICAgICAgICAgcyA9IHMgKyBcIlRvb2xtYXRjaFtcIiArIGluZGV4ICsgXCJdLi4uXFxuXCI7XG4gICAgICAgICAgICAgICAgcyA9IHMgKyBleHBvcnRzLlRvb2xNYXRjaC5kdW1wTmljZShvTWF0Y2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHM7XG4gICAgfSxcbiAgICBkdW1wTmljZTogZnVuY3Rpb24gKHRvb2xtYXRjaCkge1xuICAgICAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICAgICAgczogXCJcIixcbiAgICAgICAgICAgIHB1c2g6IGZ1bmN0aW9uIChzKSB7IHRoaXMucyA9IHRoaXMucyArIHM7IH1cbiAgICAgICAgfTtcbiAgICAgICAgdmFyIHMgPSBcIioqUmVzdWx0IGZvciB0b29sOiBcIiArIHRvb2xtYXRjaC50b29sLm5hbWUgKyBcIlxcbiByYW5rOiBcIiArIHRvb2xtYXRjaC5yYW5rICsgXCJcXG5cIjtcbiAgICAgICAgcmVzdWx0LnB1c2gocyk7XG4gICAgICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLnJlcXVpcmVzKS5mb3JFYWNoKGZ1bmN0aW9uIChzUmVxdWlyZXMsIGluZGV4KSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaChcInJlcXVpcmVkOiBcIiArIHNSZXF1aXJlcyArIFwiIC0+IFwiKTtcbiAgICAgICAgICAgIGlmICh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW3NSZXF1aXJlc10pIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXCInICsgdG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtzUmVxdWlyZXNdLm1hdGNoZWRTdHJpbmcgKyAnXCInKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwiPyBtaXNzaW5nIVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIE9iamVjdC5rZXlzKHRvb2xtYXRjaC50b29sLm9wdGlvbmFsKS5mb3JFYWNoKGZ1bmN0aW9uIChzUmVxdWlyZXMsIGluZGV4KSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaChcIm9wdGlvbmFsIDogXCIgKyBzUmVxdWlyZXMgKyBcIiAtPiBcIik7XG4gICAgICAgICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5vcHRpb25hbFtzUmVxdWlyZXNdKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1wiJyArIHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxbc1JlcXVpcmVzXS5tYXRjaGVkU3RyaW5nICsgJ1wiJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChcIj9cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQucHVzaCgnXFxuJyk7XG4gICAgICAgIH0pO1xuICAgICAgICB2YXIgb1NlbnRlbmNlID0gdG9vbG1hdGNoLnNlbnRlbmNlO1xuICAgICAgICBvU2VudGVuY2UuZm9yRWFjaChmdW5jdGlvbiAob1dvcmQsIGluZGV4KSB7XG4gICAgICAgICAgICB2YXIgc1dvcmQgPSBcIltcIiArIGluZGV4ICsgXCJdIDogXCIgKyBvV29yZC5jYXRlZ29yeSArIFwiIFxcXCJcIiArIG9Xb3JkLnN0cmluZyArIFwiXFxcIiA9PiBcXFwiXCIgKyBvV29yZC5tYXRjaGVkU3RyaW5nICsgXCJcXFwiXCI7XG4gICAgICAgICAgICByZXN1bHQucHVzaChzV29yZCArIFwiXFxuXCIpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmVzdWx0LnB1c2goXCIuXFxuXCIpO1xuICAgICAgICByZXR1cm4gcmVzdWx0LnM7XG4gICAgfSxcbiAgICBkdW1wV2VpZ2h0c1RvcDogZnVuY3Rpb24gKHRvb2xtYXRjaGVzLCBvcHRpb25zKSB7XG4gICAgICAgIHZhciBzID0gJyc7XG4gICAgICAgIHRvb2xtYXRjaGVzLmZvckVhY2goZnVuY3Rpb24gKG9NYXRjaCwgaW5kZXgpIHtcbiAgICAgICAgICAgIGlmIChpbmRleCA8IG9wdGlvbnMudG9wKSB7XG4gICAgICAgICAgICAgICAgcyA9IHMgKyBcIlRvb2xtYXRjaFtcIiArIGluZGV4ICsgXCJdLi4uXFxuXCI7XG4gICAgICAgICAgICAgICAgcyA9IHMgKyBleHBvcnRzLlRvb2xNYXRjaC5kdW1wV2VpZ2h0cyhvTWF0Y2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHM7XG4gICAgfSxcbiAgICBkdW1wV2VpZ2h0czogZnVuY3Rpb24gKHRvb2xtYXRjaCkge1xuICAgICAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICAgICAgczogXCJcIixcbiAgICAgICAgICAgIHB1c2g6IGZ1bmN0aW9uIChzKSB7IHRoaXMucyA9IHRoaXMucyArIHM7IH1cbiAgICAgICAgfTtcbiAgICAgICAgdmFyIHJlcXVpcmVzID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2wucmVxdWlyZXMpLmxlbmd0aDtcbiAgICAgICAgdmFyIHJlcXVpcmVkID0gT2JqZWN0LmtleXModG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZCkubGVuZ3RoO1xuICAgICAgICB2YXIgc3B1cmlvdXMgPSBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0LnNwdXJpb3VzKS5sZW5ndGg7XG4gICAgICAgIHZhciBzID0gXCIqKlJlc3VsdCBmb3IgdG9vbDogXCIgKyB0b29sbWF0Y2gudG9vbC5uYW1lICsgXCJcXG4gcmFuazogXCIgKyB0b29sbWF0Y2gucmFuayArIFwiICAocmVxOlwiICsgcmVxdWlyZWQgKyBcIi9cIiArIHJlcXVpcmVzICsgXCIgICBcIiArIHNwdXJpb3VzICsgXCIpXFxuXCI7XG4gICAgICAgIHJlc3VsdC5wdXNoKHMpO1xuICAgICAgICBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbC5yZXF1aXJlcykuZm9yRWFjaChmdW5jdGlvbiAoc1JlcXVpcmVzLCBpbmRleCkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goXCJyZXF1aXJlZDogXCIgKyBzUmVxdWlyZXMgKyBcIiAtPiBcIik7XG4gICAgICAgICAgICBpZiAodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdC5yZXF1aXJlZFtzUmVxdWlyZXNdKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1wiJyArIHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRbc1JlcXVpcmVzXS5tYXRjaGVkU3RyaW5nICsgJ1wiJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChcIj8gbWlzc2luZyFcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQucHVzaCgnXFxuJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBPYmplY3Qua2V5cyh0b29sbWF0Y2gudG9vbC5vcHRpb25hbCkuZm9yRWFjaChmdW5jdGlvbiAoc1JlcXVpcmVzLCBpbmRleCkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goXCJvcHRpb25hbCA6IFwiICsgc1JlcXVpcmVzICsgXCIgLT4gXCIpO1xuICAgICAgICAgICAgaWYgKHRvb2xtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxbc1JlcXVpcmVzXSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcIicgKyB0b29sbWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW3NSZXF1aXJlc10ubWF0Y2hlZFN0cmluZyArICdcIicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goXCI/XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1xcbicpO1xuICAgICAgICB9KTtcbiAgICAgICAgdmFyIG9TZW50ZW5jZSA9IHRvb2xtYXRjaC5zZW50ZW5jZTtcbiAgICAgICAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkLCBpbmRleCkge1xuICAgICAgICAgICAgdmFyIHNXb3JkID0gXCJbXCIgKyBpbmRleCArIFwiXSA6IFwiICsgb1dvcmQuY2F0ZWdvcnkgKyBcIiBcXFwiXCIgKyBvV29yZC5zdHJpbmcgKyBcIlxcXCIgPT4gXFxcIlwiICsgb1dvcmQubWF0Y2hlZFN0cmluZyArIFwiXFxcIiAgKF9yOlwiICsgb1dvcmQuX3JhbmtpbmcgKyBcIi9cIiArIChvV29yZC5yZWluZm9yY2UgfHwgJycpICsgXCIvXCIgKyAob1dvcmQubGV2ZW5tYXRjaCB8fCAnJykgKyBcIilcIjtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHNXb3JkICsgXCJcXG5cIik7XG4gICAgICAgIH0pO1xuICAgICAgICByZXN1bHQucHVzaChcIi5cXG5cIik7XG4gICAgICAgIHJldHVybiByZXN1bHQucztcbiAgICB9XG59O1xuZXhwb3J0cy5SZXN1bHQgPSB7XG4gICAgZ2V0RW50aXR5OiBmdW5jdGlvbiAobWF0Y2gsIGtleSkge1xuICAgICAgICBpZiAoIW1hdGNoLnRvb2xtYXRjaHJlc3VsdCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWF0Y2gudG9vbG1hdGNocmVzdWx0LnJlcXVpcmVkW2tleV0pIHtcbiAgICAgICAgICAgIHJldHVybiBtYXRjaC50b29sbWF0Y2hyZXN1bHQucmVxdWlyZWRba2V5XTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWF0Y2gudG9vbG1hdGNocmVzdWx0Lm9wdGlvbmFsW2tleV0pIHtcbiAgICAgICAgICAgIHJldHVybiBtYXRjaC50b29sbWF0Y2hyZXN1bHQub3B0aW9uYWxba2V5XTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbn07XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
