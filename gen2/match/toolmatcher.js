/**
 * @file toolmatcher
 * @module jfseb.fdevstart.toolmatcher
 * @copyright (c) Gerd Forstmann
 *
 * Match a tool record on a sentence,
 *
 * This will unify matching required and optional category words
 * with the requirements of the tool.
 *
 */
"use strict";
// / <reference path="../../lib/node-4.d.ts" />

var debug = require('debug');
var utils = require('../utils/utils');
var Sentence = require('./sentence');
var OpsWord = require('./word');
var Word = OpsWord.Word;
var Category = OpsWord.Category;
var debuglog = debug('toolmatcher');
function matchTool(oSentence, oTool) {
    var used = {};
    var required = {};
    var optional = {};
    var matched = {};
    var spurious = {};
    var toolmentioned = [];
    Object.keys(oTool.requires || {}).forEach(function (sCategory) {
        var _a = Sentence.findWordByCategory(oSentence, sCategory),
            word = _a.word,
            index = _a.index;
        if (word) {
            matched[word] = "required";
            used[index] = 1;
            required[sCategory] = word;
        }
    });
    Object.keys(oTool.optional || {}).forEach(function (sCategory) {
        var _a = Sentence.findWordByCategory(oSentence, sCategory),
            word = _a.word,
            index = _a.index;
        if (word) {
            matched[word] = "optional";
            used[index] = 1;
            optional[sCategory] = word;
        }
    });
    oSentence.forEach(function (oWord, index) {
        if (!used[index] && !Word.isFiller(oWord) && !Word.isCategory(oWord)) {
            debuglog("have spurious word" + JSON.stringify(oWord));
            if (!used[index] && oWord.category === Category.CAT_TOOL && oWord.matchedString === oTool.name) {
                toolmentioned.push(oWord);
            } else {
                spurious[oWord.matchedString] = 1;
            }
        }
    });
    debuglog('satisfied : ' + Object.keys(oTool.requires).join(";"));
    debuglog('required  : ' + Object.keys(oTool.requires).join(";"));
    var missing = utils.ArrayUtils.setMinus(Object.keys(oTool.requires), Object.keys(required)).reduce(function (map, sKey) {
        map[sKey] = 1;
        return map;
    }, {});
    return {
        required: required,
        missing: missing,
        optional: optional,
        spurious: spurious,
        toolmentioned: toolmentioned
    };
}
exports.matchTool = matchTool;
var match = require('./match');
var ToolMatch = match.ToolMatch;
function matchTools(aSentences, aTool) {
    //var stream = new streamutils.MatchStream();
    var result = [];
    aTool.forEach(function (oTool) {
        aSentences.forEach(function (oSentence) {
            var toolmatchresult = matchTool(oSentence, oTool);
            var toolmatch = {
                toolmatchresult: toolmatchresult,
                sentence: oSentence,
                tool: oTool,
                rank: 0
            };
            toolmatch.rank = ToolMatch.rankResult(toolmatch.toolmatchresult);
            if (ToolMatch.isAnyMatch(toolmatch)) {
                result.push(toolmatch);
            }
        });
    });
    result.sort(ToolMatch.compBetterMatch);
    return result;
}
exports.matchTools = matchTools;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC90b29sbWF0Y2hlci50cyIsIm1hdGNoL3Rvb2xtYXRjaGVyLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsInV0aWxzIiwiU2VudGVuY2UiLCJPcHNXb3JkIiwiV29yZCIsIkNhdGVnb3J5IiwiZGVidWdsb2ciLCJtYXRjaFRvb2wiLCJvU2VudGVuY2UiLCJvVG9vbCIsInVzZWQiLCJyZXF1aXJlZCIsIm9wdGlvbmFsIiwibWF0Y2hlZCIsInNwdXJpb3VzIiwidG9vbG1lbnRpb25lZCIsIk9iamVjdCIsImtleXMiLCJyZXF1aXJlcyIsImZvckVhY2giLCJzQ2F0ZWdvcnkiLCJfYSIsImZpbmRXb3JkQnlDYXRlZ29yeSIsIndvcmQiLCJpbmRleCIsIm9Xb3JkIiwiaXNGaWxsZXIiLCJpc0NhdGVnb3J5IiwiSlNPTiIsInN0cmluZ2lmeSIsImNhdGVnb3J5IiwiQ0FUX1RPT0wiLCJtYXRjaGVkU3RyaW5nIiwibmFtZSIsInB1c2giLCJqb2luIiwibWlzc2luZyIsIkFycmF5VXRpbHMiLCJzZXRNaW51cyIsInJlZHVjZSIsIm1hcCIsInNLZXkiLCJleHBvcnRzIiwibWF0Y2giLCJUb29sTWF0Y2giLCJtYXRjaFRvb2xzIiwiYVNlbnRlbmNlcyIsImFUb29sIiwicmVzdWx0IiwidG9vbG1hdGNocmVzdWx0IiwidG9vbG1hdGNoIiwic2VudGVuY2UiLCJ0b29sIiwicmFuayIsInJhbmtSZXN1bHQiLCJpc0FueU1hdGNoIiwic29ydCIsImNvbXBCZXR0ZXJNYXRjaCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7O0FDV0E7QURDQTs7QUFFQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4sQ0FBakI7QUFJQSxJQUFZQyxRQUFLRCxRQUFNLGdCQUFOLENBQWpCO0FBQ0EsSUFBWUUsV0FBUUYsUUFBTSxZQUFOLENBQXBCO0FBQ0EsSUFBWUcsVUFBT0gsUUFBTSxRQUFOLENBQW5CO0FBRUEsSUFBTUksT0FBT0QsUUFBUUMsSUFBckI7QUFD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SUxFLGtCQUFVQSxRQUpMO0FBS0xDLHVCQUFnQkE7QUFMWCxLQUFQO0FBT0Q7QUFqRGUyQixRQUFBbkMsU0FBQSxHQUFTQSxTQUFUO0FBbURoQixJQUFZb0MsUUFBSzNDLFFBQU0sU0FBTixDQUFqQjtBQUVBLElBQU00QyxZQUFZRCxNQUFNQyxTQUF4QjtBQUVBLFNBQUFDLFVBQUEsQ0FBMkJDLFVBQTNCLEVBQWdFQyxLQUFoRSxFQUEwRjtBQUN4RjtBQUNBLFFBQUlDLFNBQVMsRUFBYjtBQUNBRCxVQUFNNUIsT0FBTixDQUFjLFVBQVVWLEtBQVYsRUFBZTtBQUMzQnFDLG1CQUFXM0IsT0FBWCxDQUFtQixVQUFVWCxTQUFWLEVBQW1CO0FBQ3BDLGdCQUFJeUMsa0JBQWtCMUMsVUFBVUMsU0FBVixFQUFxQkMsS0FBckIsQ0FBdEI7QUFDQSxnQkFBSXlDLFlBQVk7QUFDZEQsaUNBQWlCQSxlQURIO0FBRWRFLDBCQUFVM0MsU0FGSTtBQUdkNEMsc0JBQU8zQyxLQUhPO0FBSWQ0QyxzQkFBTztBQUpPLGFBQWhCO0FBTUFILHNCQUFVRyxJQUFWLEdBQWlCVCxVQUFVVSxVQUFWLENBQXFCSixVQUFVRCxlQUEvQixDQUFqQjtBQUNBLGdCQUFJTCxVQUFVVyxVQUFWLENBQXFCTCxTQUFyQixDQUFKLEVBQXFDO0FBQ25DRix1QkFBT2QsSUFBUCxDQUFZZ0IsU0FBWjtBQUNEO0FBQ0YsU0FaRDtBQWFELEtBZEQ7QUFlQUYsV0FBT1EsSUFBUCxDQUFZWixVQUFVYSxlQUF0QjtBQUNBLFdBQU9ULE1BQVA7QUFDRDtBQXBCZU4sUUFBQUcsVUFBQSxHQUFVQSxVQUFWIiwiZmlsZSI6Im1hdGNoL3Rvb2xtYXRjaGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEBmaWxlIHRvb2xtYXRjaGVyXHJcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LnRvb2xtYXRjaGVyXHJcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXHJcbiAqXHJcbiAqIE1hdGNoIGEgdG9vbCByZWNvcmQgb24gYSBzZW50ZW5jZSxcclxuICpcclxuICogVGhpcyB3aWxsIHVuaWZ5IG1hdGNoaW5nIHJlcXVpcmVkIGFuZCBvcHRpb25hbCBjYXRlZ29yeSB3b3Jkc1xyXG4gKiB3aXRoIHRoZSByZXF1aXJlbWVudHMgb2YgdGhlIHRvb2wuXHJcbiAqXHJcbiAqL1xyXG5cclxuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxyXG5cclxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xyXG5cclxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XHJcblxyXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuLi91dGlscy91dGlscyc7XHJcbmltcG9ydCAqIGFzIFNlbnRlbmNlIGZyb20gJy4vc2VudGVuY2UnO1xyXG5pbXBvcnQgKiBhcyBPcHNXb3JkIGZyb20gJy4vd29yZCc7XHJcblxyXG5jb25zdCBXb3JkID0gT3BzV29yZC5Xb3JkO1xyXG5jb25zdCBDYXRlZ29yeSA9IE9wc1dvcmQuQ2F0ZWdvcnk7XHJcblxyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2hlcicpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoVG9vbChvU2VudGVuY2U6IElNYXRjaC5JU2VudGVuY2UsIG9Ub29sOiBJTWF0Y2guSVRvb2wpOiBJTWF0Y2guSVRvb2xNYXRjaFJlc3VsdCB7XHJcbiAgdmFyIHVzZWQgPSB7fSBhcyB7IFtrZXk6IG51bWJlcl06IG51bWJlciB9O1xyXG4gIHZhciByZXF1aXJlZCA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSU1hdGNoLklXb3JkIH07XHJcbiAgdmFyIG9wdGlvbmFsID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBJTWF0Y2guSVdvcmQgfTtcclxuICB2YXIgbWF0Y2hlZCA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XHJcbiAgdmFyIHNwdXJpb3VzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfTtcclxuICB2YXIgdG9vbG1lbnRpb25lZCA9IFtdIGFzIEFycmF5PElNYXRjaC5JV29yZD47XHJcbiAgT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMgfHwge30pLmZvckVhY2goZnVuY3Rpb24gKHNDYXRlZ29yeTogc3RyaW5nKSB7XHJcbiAgICBsZXQgeyB3b3JkLCBpbmRleCB9ID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KTtcclxuICAgIGlmICh3b3JkKSB7XHJcbiAgICAgIG1hdGNoZWRbd29yZCBhcyBhbnldID0gXCJyZXF1aXJlZFwiO1xyXG4gICAgICB1c2VkW2luZGV4XSA9IDE7XHJcbiAgICAgIHJlcXVpcmVkW3NDYXRlZ29yeV0gPSB3b3JkO1xyXG4gICAgfVxyXG4gIH0pO1xyXG4gIE9iamVjdC5rZXlzKG9Ub29sLm9wdGlvbmFsIHx8IHt9KS5mb3JFYWNoKGZ1bmN0aW9uIChzQ2F0ZWdvcnk6IHN0cmluZykge1xyXG4gICAgdmFyIHsgd29yZCwgaW5kZXggfSA9IFNlbnRlbmNlLmZpbmRXb3JkQnlDYXRlZ29yeShvU2VudGVuY2UsIHNDYXRlZ29yeSk7XHJcbiAgICBpZiAod29yZCkge1xyXG4gICAgICBtYXRjaGVkW3dvcmQgYXMgYW55XSA9IFwib3B0aW9uYWxcIjtcclxuICAgICAgdXNlZFtpbmRleF0gPSAxO1xyXG4gICAgICBvcHRpb25hbFtzQ2F0ZWdvcnldID0gd29yZDtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkLCBpbmRleCkge1xyXG4gICAgaWYgKCF1c2VkW2luZGV4XSAmJiAhV29yZC5pc0ZpbGxlcihvV29yZCkgJiYgIVdvcmQuaXNDYXRlZ29yeShvV29yZCkpIHtcclxuICAgICAgZGVidWdsb2coXCJoYXZlIHNwdXJpb3VzIHdvcmRcIiArIEpTT04uc3RyaW5naWZ5KG9Xb3JkKSk7XHJcbiAgICAgIGlmICghdXNlZFtpbmRleF0gJiYgb1dvcmQuY2F0ZWdvcnkgPT09IENhdGVnb3J5LkNBVF9UT09MICYmIG9Xb3JkLm1hdGNoZWRTdHJpbmcgPT09IG9Ub29sLm5hbWUgKSB7XHJcbiAgICAgICAgdG9vbG1lbnRpb25lZC5wdXNoKG9Xb3JkKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBzcHVyaW91c1tvV29yZC5tYXRjaGVkU3RyaW5nXSA9IDE7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KTtcclxuICBkZWJ1Z2xvZygnc2F0aXNmaWVkIDogJyArIE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzKS5qb2luKFwiO1wiKSk7XHJcbiAgZGVidWdsb2coJ3JlcXVpcmVkICA6ICcgKyBPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcykuam9pbihcIjtcIikpO1xyXG4gIHZhciBtaXNzaW5nID0gdXRpbHMuQXJyYXlVdGlscy5zZXRNaW51cyhPYmplY3Qua2V5cyhvVG9vbC5yZXF1aXJlcyksIE9iamVjdC5rZXlzKHJlcXVpcmVkKSkucmVkdWNlKFxyXG4gICAgZnVuY3Rpb24gKG1hcCwgc0tleSkge1xyXG4gICAgICBtYXBbc0tleV0gPSAxO1xyXG4gICAgICByZXR1cm4gbWFwO1xyXG4gICAgfSwge30pXHJcblxyXG4gIHJldHVybiB7XHJcbiAgICByZXF1aXJlZDogcmVxdWlyZWQsXHJcbiAgICBtaXNzaW5nOiBtaXNzaW5nLFxyXG4gICAgb3B0aW9uYWw6IG9wdGlvbmFsLFxyXG4gICAgc3B1cmlvdXM6IHNwdXJpb3VzLFxyXG4gICAgdG9vbG1lbnRpb25lZCA6IHRvb2xtZW50aW9uZWRcclxuICB9XHJcbn1cclxuXHJcbmltcG9ydCAqIGFzIG1hdGNoIGZyb20gJy4vbWF0Y2gnO1xyXG5cclxuY29uc3QgVG9vbE1hdGNoID0gbWF0Y2guVG9vbE1hdGNoO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoVG9vbHMoYVNlbnRlbmNlczogQXJyYXk8SU1hdGNoLklTZW50ZW5jZT4sIGFUb29sOiBBcnJheTxJTWF0Y2guSVRvb2w+KTogSU1hdGNoLklUb29sTWF0Y2hbXSAvKiBvYmplY3RzdHJlYW0qLyB7XHJcbiAgLy92YXIgc3RyZWFtID0gbmV3IHN0cmVhbXV0aWxzLk1hdGNoU3RyZWFtKCk7XHJcbiAgdmFyIHJlc3VsdCA9IFtdO1xyXG4gIGFUb29sLmZvckVhY2goZnVuY3Rpb24gKG9Ub29sKSB7XHJcbiAgICBhU2VudGVuY2VzLmZvckVhY2goZnVuY3Rpb24gKG9TZW50ZW5jZSkge1xyXG4gICAgICB2YXIgdG9vbG1hdGNocmVzdWx0ID0gbWF0Y2hUb29sKG9TZW50ZW5jZSwgb1Rvb2wpO1xyXG4gICAgICB2YXIgdG9vbG1hdGNoID0ge1xyXG4gICAgICAgIHRvb2xtYXRjaHJlc3VsdDogdG9vbG1hdGNocmVzdWx0LFxyXG4gICAgICAgIHNlbnRlbmNlOiBvU2VudGVuY2UsXHJcbiAgICAgICAgdG9vbCA6IG9Ub29sLFxyXG4gICAgICAgIHJhbmsgOiAwXHJcbiAgICAgIH0gYXMgSU1hdGNoLklUb29sTWF0Y2g7XHJcbiAgICAgIHRvb2xtYXRjaC5yYW5rID0gVG9vbE1hdGNoLnJhbmtSZXN1bHQodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdCk7XHJcbiAgICAgIGlmIChUb29sTWF0Y2guaXNBbnlNYXRjaCh0b29sbWF0Y2gpKSB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2godG9vbG1hdGNoKTtcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9KTtcclxuICByZXN1bHQuc29ydChUb29sTWF0Y2guY29tcEJldHRlck1hdGNoKTtcclxuICByZXR1cm4gcmVzdWx0O1xyXG59IiwiLyoqXG4gKiBAZmlsZSB0b29sbWF0Y2hlclxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQudG9vbG1hdGNoZXJcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXG4gKlxuICogTWF0Y2ggYSB0b29sIHJlY29yZCBvbiBhIHNlbnRlbmNlLFxuICpcbiAqIFRoaXMgd2lsbCB1bmlmeSBtYXRjaGluZyByZXF1aXJlZCBhbmQgb3B0aW9uYWwgY2F0ZWdvcnkgd29yZHNcbiAqIHdpdGggdGhlIHJlcXVpcmVtZW50cyBvZiB0aGUgdG9vbC5cbiAqXG4gKi9cblwidXNlIHN0cmljdFwiO1xuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciB1dGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzJyk7XG52YXIgU2VudGVuY2UgPSByZXF1aXJlKCcuL3NlbnRlbmNlJyk7XG52YXIgT3BzV29yZCA9IHJlcXVpcmUoJy4vd29yZCcpO1xudmFyIFdvcmQgPSBPcHNXb3JkLldvcmQ7XG52YXIgQ2F0ZWdvcnkgPSBPcHNXb3JkLkNhdGVnb3J5O1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ3Rvb2xtYXRjaGVyJyk7XG5mdW5jdGlvbiBtYXRjaFRvb2wob1NlbnRlbmNlLCBvVG9vbCkge1xuICAgIHZhciB1c2VkID0ge307XG4gICAgdmFyIHJlcXVpcmVkID0ge307XG4gICAgdmFyIG9wdGlvbmFsID0ge307XG4gICAgdmFyIG1hdGNoZWQgPSB7fTtcbiAgICB2YXIgc3B1cmlvdXMgPSB7fTtcbiAgICB2YXIgdG9vbG1lbnRpb25lZCA9IFtdO1xuICAgIE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzIHx8IHt9KS5mb3JFYWNoKGZ1bmN0aW9uIChzQ2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIF9hID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KG9TZW50ZW5jZSwgc0NhdGVnb3J5KSwgd29yZCA9IF9hLndvcmQsIGluZGV4ID0gX2EuaW5kZXg7XG4gICAgICAgIGlmICh3b3JkKSB7XG4gICAgICAgICAgICBtYXRjaGVkW3dvcmRdID0gXCJyZXF1aXJlZFwiO1xuICAgICAgICAgICAgdXNlZFtpbmRleF0gPSAxO1xuICAgICAgICAgICAgcmVxdWlyZWRbc0NhdGVnb3J5XSA9IHdvcmQ7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBPYmplY3Qua2V5cyhvVG9vbC5vcHRpb25hbCB8fCB7fSkuZm9yRWFjaChmdW5jdGlvbiAoc0NhdGVnb3J5KSB7XG4gICAgICAgIHZhciBfYSA9IFNlbnRlbmNlLmZpbmRXb3JkQnlDYXRlZ29yeShvU2VudGVuY2UsIHNDYXRlZ29yeSksIHdvcmQgPSBfYS53b3JkLCBpbmRleCA9IF9hLmluZGV4O1xuICAgICAgICBpZiAod29yZCkge1xuICAgICAgICAgICAgbWF0Y2hlZFt3b3JkXSA9IFwib3B0aW9uYWxcIjtcbiAgICAgICAgICAgIHVzZWRbaW5kZXhdID0gMTtcbiAgICAgICAgICAgIG9wdGlvbmFsW3NDYXRlZ29yeV0gPSB3b3JkO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgb1NlbnRlbmNlLmZvckVhY2goZnVuY3Rpb24gKG9Xb3JkLCBpbmRleCkge1xuICAgICAgICBpZiAoIXVzZWRbaW5kZXhdICYmICFXb3JkLmlzRmlsbGVyKG9Xb3JkKSAmJiAhV29yZC5pc0NhdGVnb3J5KG9Xb3JkKSkge1xuICAgICAgICAgICAgZGVidWdsb2coXCJoYXZlIHNwdXJpb3VzIHdvcmRcIiArIEpTT04uc3RyaW5naWZ5KG9Xb3JkKSk7XG4gICAgICAgICAgICBpZiAoIXVzZWRbaW5kZXhdICYmIG9Xb3JkLmNhdGVnb3J5ID09PSBDYXRlZ29yeS5DQVRfVE9PTCAmJiBvV29yZC5tYXRjaGVkU3RyaW5nID09PSBvVG9vbC5uYW1lKSB7XG4gICAgICAgICAgICAgICAgdG9vbG1lbnRpb25lZC5wdXNoKG9Xb3JkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHNwdXJpb3VzW29Xb3JkLm1hdGNoZWRTdHJpbmddID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGRlYnVnbG9nKCdzYXRpc2ZpZWQgOiAnICsgT2JqZWN0LmtleXMob1Rvb2wucmVxdWlyZXMpLmpvaW4oXCI7XCIpKTtcbiAgICBkZWJ1Z2xvZygncmVxdWlyZWQgIDogJyArIE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzKS5qb2luKFwiO1wiKSk7XG4gICAgdmFyIG1pc3NpbmcgPSB1dGlscy5BcnJheVV0aWxzLnNldE1pbnVzKE9iamVjdC5rZXlzKG9Ub29sLnJlcXVpcmVzKSwgT2JqZWN0LmtleXMocmVxdWlyZWQpKS5yZWR1Y2UoZnVuY3Rpb24gKG1hcCwgc0tleSkge1xuICAgICAgICBtYXBbc0tleV0gPSAxO1xuICAgICAgICByZXR1cm4gbWFwO1xuICAgIH0sIHt9KTtcbiAgICByZXR1cm4ge1xuICAgICAgICByZXF1aXJlZDogcmVxdWlyZWQsXG4gICAgICAgIG1pc3Npbmc6IG1pc3NpbmcsXG4gICAgICAgIG9wdGlvbmFsOiBvcHRpb25hbCxcbiAgICAgICAgc3B1cmlvdXM6IHNwdXJpb3VzLFxuICAgICAgICB0b29sbWVudGlvbmVkOiB0b29sbWVudGlvbmVkXG4gICAgfTtcbn1cbmV4cG9ydHMubWF0Y2hUb29sID0gbWF0Y2hUb29sO1xudmFyIG1hdGNoID0gcmVxdWlyZSgnLi9tYXRjaCcpO1xudmFyIFRvb2xNYXRjaCA9IG1hdGNoLlRvb2xNYXRjaDtcbmZ1bmN0aW9uIG1hdGNoVG9vbHMoYVNlbnRlbmNlcywgYVRvb2wpIHtcbiAgICAvL3ZhciBzdHJlYW0gPSBuZXcgc3RyZWFtdXRpbHMuTWF0Y2hTdHJlYW0oKTtcbiAgICB2YXIgcmVzdWx0ID0gW107XG4gICAgYVRvb2wuZm9yRWFjaChmdW5jdGlvbiAob1Rvb2wpIHtcbiAgICAgICAgYVNlbnRlbmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChvU2VudGVuY2UpIHtcbiAgICAgICAgICAgIHZhciB0b29sbWF0Y2hyZXN1bHQgPSBtYXRjaFRvb2wob1NlbnRlbmNlLCBvVG9vbCk7XG4gICAgICAgICAgICB2YXIgdG9vbG1hdGNoID0ge1xuICAgICAgICAgICAgICAgIHRvb2xtYXRjaHJlc3VsdDogdG9vbG1hdGNocmVzdWx0LFxuICAgICAgICAgICAgICAgIHNlbnRlbmNlOiBvU2VudGVuY2UsXG4gICAgICAgICAgICAgICAgdG9vbDogb1Rvb2wsXG4gICAgICAgICAgICAgICAgcmFuazogMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRvb2xtYXRjaC5yYW5rID0gVG9vbE1hdGNoLnJhbmtSZXN1bHQodG9vbG1hdGNoLnRvb2xtYXRjaHJlc3VsdCk7XG4gICAgICAgICAgICBpZiAoVG9vbE1hdGNoLmlzQW55TWF0Y2godG9vbG1hdGNoKSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRvb2xtYXRjaCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJlc3VsdC5zb3J0KFRvb2xNYXRjaC5jb21wQmV0dGVyTWF0Y2gpO1xuICAgIHJldHVybiByZXN1bHQ7XG59XG5leHBvcnRzLm1hdGNoVG9vbHMgPSBtYXRjaFRvb2xzO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
