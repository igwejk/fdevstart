/**
 * @file
 * @module jfseb.fdevstart.breakdown
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require("debug");
var debuglog = debug('dispatcher');
function cleanseString(sString) {
    var len = 0;
    while (len !== sString.length) {
        len = sString.length;
        sString = sString.replace(/\s+/g, ' ');
        sString = sString.replace(/^\s+/, '');
        sString = sString.replace(/\s+$/, '');
        sString = sString.replace(/^[,;.]+/, '');
        sString = sString.replace(/[,;.]+$/, '');
    }
    return sString;
}
exports.cleanseString = cleanseString;
function cleanseQuotedString(sString) {
    var len = 0;
    while (len !== sString.length) {
        len = sString.length;
        sString = sString.replace(/\s\s+/g, ' ');
        sString = sString.replace(/\s+/g, ' ');
        sString = sString.replace(/^\s+/, '');
        sString = sString.replace(/\s+$/, '');
        sString = sString.replace(/^[,;.]+/, '');
        sString = sString.replace(/[,;.]+$/, '');
    }
    return sString;
}
exports.cleanseQuotedString = cleanseQuotedString;
var regexpRemoveDouble = new RegExp(/^\"(\".*\")\"$/);
var striptail = new RegExp(/^\"([^\"]+)"$/);
function trimQuoted(sString) {
    var skipUntil = 0;
    var stripped = sString;
    var m = regexpRemoveDouble.exec(sString);
    while (m) {
        stripped = m[1];
        m = regexpRemoveDouble.exec(stripped);
    }
    debuglog("stripped " + stripped);
    m = striptail.exec(stripped);
    if (m) {
        return m[1];
    }
    return cleanseString(sString);
}
exports.trimQuoted = trimQuoted;
function trimQuotedSpaced(sString) {
    var skipUntil = 0;
    sString = sString.replace(/^"\s+/g, '"');
    sString = sString.replace(/\s+\"$/g, '"');
    return sString;
}
exports.trimQuotedSpaced = trimQuotedSpaced;
function recombineQuoted(aArr) {
    var skipUntil = 0;
    aArr = aArr.map(function (s, index) {
        if (index < skipUntil) {
            debuglog("skipping >" + s + "<");
            return undefined;
        }
        if (/^"/.exec(s)) {
            var i = index;
            while (i < aArr.length && (!/"$/.exec(aArr[i]) || index === i && s === '"')) {
                i = i + 1;
            }
            if (i === aArr.length) {
                debuglog("Unterminated quoted string");
                return s;
            } else {
                skipUntil = i + 1;
                var res = aArr.slice(index, i + 1).join(" ");
            }
            return res;
        }
        return s;
    }).filter(function (s) {
        return s !== undefined;
    }).map(function (s) {
        return trimQuotedSpaced(s);
    });
    return aArr;
}
exports.recombineQuoted = recombineQuoted;
function isQuoted(sString) {
    return !!/^".*"$/.exec(sString);
}
exports.isQuoted = isQuoted;
function countSpaces(sString) {
    var r = 0;
    for (var i = 0; i < sString.length; ++i) {
        if (sString.charAt(i) === ' ') {
            r = r + 1;
        }
    }
    return r;
}
exports.countSpaces = countSpaces;
var Quotes = /^"([^"]+)"/;
function swallowQuote(str, i) {
    var m = Quotes.exec(str.substring(i));
    if (!m) {
        return { token: undefined,
            nextpos: i
        };
    }
    return {
        token: cleanseString(m[1]),
        nextpos: i + m[0].length
    };
}
exports.swallowQuote = swallowQuote;
var Word = /^(([-#A-Z_a-z0-9\/\\\%\$&](\'[-#A-Z_a-z0-9\/\\\%\$&])*)+)/;
function swallowWord(str, i) {
    var m = Word.exec(str.substring(i));
    if (!m) {
        return { token: undefined,
            nextpos: i
        };
    }
    return {
        token: m[1],
        nextpos: i + m[0].length
    };
}
exports.swallowWord = swallowWord;
function pushToken(res, token) {
    res.tokens.push(token);
    res.fusable[res.tokens.length] = true;
}
/**
 *@param {string} sString , e.g. "a,b c;d O'Hara and "murph'ys"
 *@return {Array<String>} broken down array, e.g.
 * [["a b c"], ["a", "b c"], ["a b", "c"], ....["a", "b", "c"]]
 */
function tokenizeString(sString, spacesLimit) {
    var res = {
        tokens: [],
        fusable: [false]
    };
    var i = 0;
    var seenSep = false;
    while (i < sString.length) {
        switch (sString.charAt(i)) {
            case '"':
                var _a = swallowQuote(sString, i),
                    token = _a.token,
                    nextpos = _a.nextpos;
                if (nextpos === i) {
                    // unterminated quote, treat like separator
                    res.fusable[res.tokens.length] = false;
                    seenSep = true;
                    ++i;
                } else if (token === "") {
                    res.fusable[res.tokens.length] = false;
                    seenSep = true;
                    i = nextpos;
                } else {
                    res.fusable[res.tokens.length] = false;
                    pushToken(res, token);
                    res.fusable[res.tokens.length] = false;
                    i = nextpos;
                }
                break;
            case '\t':
            case '\n':
            case '\r':
            case ' ':
                i++;
                break;
            case ':':
            case ',':
            case '.':
            case '?':
            case '!':
            case ';':
                res.fusable[res.tokens.length] = false;
                seenSep = true;
                ++i;
                break;
            default:
                var _b = swallowWord(sString, i),
                    token = _b.token,
                    nextpos = _b.nextpos;
                if (token) {
                    pushToken(res, token);
                    i = nextpos;
                } else {
                    res.fusable[res.tokens.length] = false;
                    i++;
                }
                break;
        }
    }
    res.fusable[res.tokens.length] = false;
    return res;
}
exports.tokenizeString = tokenizeString;
function makeMatchPattern(str) {
    var tokens = tokenizeString(str);
    var bestlen = 0;
    var best = {
        longestToken: "",
        span: { low: 0, high: 0 }
    };
    if (tokens.tokens.length > 1) {
        tokens.tokens.forEach(function (token, index) {
            var len = token.length;
            if (len > bestlen) {
                bestlen = len;
                best.longestToken = token;
                best.span.low = -index;
            }
        });
        best.span.high = tokens.tokens.length + best.span.low - 1;
        return best;
    }
    return undefined;
}
exports.makeMatchPattern = makeMatchPattern;
/**
 *@param {string} sString , e.g. "a b c"
 *@return {Array<Array<String>>} broken down array, e.g.
 *[["a b c"], ["a", "b c"], ["a b", "c"], ....["a", "b", "c"]]
 */
function breakdownString(sString, spacesLimit) {
    var rString = cleanseString(sString);
    if (spacesLimit === undefined) {
        spacesLimit = -1;
    }
    var u = rString.split(" ");
    u = recombineQuoted(u);
    var k = 0;
    if (u.length === 0) {
        return [[]];
    }
    var w = [[u[0]]];
    while (k < u.length - 1) {
        k = k + 1;
        var r1 = w.map(function (entry) {
            debuglog(JSON.stringify(entry));
            var entry = entry.slice(0);
            debuglog(JSON.stringify(entry));
            var preventry = entry[entry.length - 1];
            // do not combine quoted strings!
            if (preventry === null) {} else if (isQuoted(u[k]) || isQuoted(preventry)) {
                entry[entry.length - 1] = null;
            } else {
                var combined = preventry + " " + u[k];
                if (spacesLimit > 0 && countSpaces(combined) > spacesLimit) {
                    combined = null;
                }
                entry[entry.length - 1] = combined;
            }
            return entry;
        });
        var r2 = w.map(function (entry) {
            debuglog("2 >" + JSON.stringify(entry));
            var entry = entry.slice(0);
            entry.push(u[k]);
            return entry;
        });
        debuglog(JSON.stringify(r1));
        debuglog(JSON.stringify(r2));
        w = r1.concat(r2);
    }
    w = w.filter(function (oMap) {
        return oMap.every(function (sWord) {
            return sWord !== null;
        });
    });
    return w.map(function (oMap) {
        return oMap.map(function (sWord) {
            return trimQuoted(sWord);
        });
    });
}
exports.breakdownString = breakdownString;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9icmVha2Rvd24udHMiLCJtYXRjaC9icmVha2Rvd24uanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJjbGVhbnNlU3RyaW5nIiwic1N0cmluZyIsImxlbiIsImxlbmd0aCIsInJlcGxhY2UiLCJleHBvcnRzIiwiY2xlYW5zZVF1b3RlZFN0cmluZyIsInJlZ2V4cFJlbW92ZURvdWJsZSIsIlJlZ0V4cCIsInN0cmlwdGFpbCIsInRyaW1RdW90ZWQiLCJza2lwVW50aWwiLCJzdHJpcHBlZCIsIm0iLCJleGVjIiwidHJpbVF1b3RlZFNwYWNlZCIsInJlY29tYmluZVF1b3RlZCIsImFBcnIiLCJtYXAiLCJzIiwiaW5kZXgiLCJ1bmRlZmluZWQiLCJpIiwicmVzIiwic2xpY2UiLCJqb2luIiwiZmlsdGVyIiwiaXNRdW90ZWQiLCJjb3VudFNwYWNlcyIsInIiLCJjaGFyQXQiLCJRdW90ZXMiLCJzd2FsbG93UXVvdGUiLCJzdHIiLCJzdWJzdHJpbmciLCJ0b2tlbiIsIm5leHRwb3MiLCJXb3JkIiwic3dhbGxvd1dvcmQiLCJwdXNoVG9rZW4iLCJ0b2tlbnMiLCJwdXNoIiwiZnVzYWJsZSIsInRva2VuaXplU3RyaW5nIiwic3BhY2VzTGltaXQiLCJzZWVuU2VwIiwiX2EiLCJfYiIsIm1ha2VNYXRjaFBhdHRlcm4iLCJiZXN0bGVuIiwiYmVzdCIsImxvbmdlc3RUb2tlbiIsInNwYW4iLCJsb3ciLCJoaWdoIiwiZm9yRWFjaCIsImJyZWFrZG93blN0cmluZyIsInJTdHJpbmciLCJ1Iiwic3BsaXQiLCJrIiwidyIsInIxIiwiZW50cnkiLCJKU09OIiwic3RyaW5naWZ5IiwicHJldmVudHJ5IiwiY29tYmluZWQiLCJyMiIsImNvbmNhdCIsIm9NYXAiLCJldmVyeSIsInNXb3JkIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUNLQTs7QURDQSxJQUFBQSxRQUFBQyxRQUFBLE9BQUEsQ0FBQTtBQUNBLElBQU1DLFdBQVdGLE1B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QVdpQixFQUFFRSxDQUFGLENBQVg7QUFDQSxtQkFBT0csS0FBUDtBQUNILFNBTFEsQ0FBVDtBQU1BaEUsaUJBQVNpRSxLQUFLQyxTQUFMLENBQWVILEVBQWYsQ0FBVDtBQUNBL0QsaUJBQVNpRSxLQUFLQyxTQUFMLENBQWVHLEVBQWYsQ0FBVDtBQUNBUCxZQUFJQyxHQUFHTyxNQUFILENBQVVELEVBQVYsQ0FBSjtBQUNIO0FBQ0RQLFFBQUlBLEVBQUVuQyxNQUFGLENBQVMsVUFBUzRDLElBQVQsRUFBYTtBQUN0QixlQUFPQSxLQUFLQyxLQUFMLENBQVcsVUFBU0MsS0FBVCxFQUFjO0FBQzVCLG1CQUFPQSxVQUFVLElBQWpCO0FBQ0gsU0FGTSxDQUFQO0FBR0gsS0FKRyxDQUFKO0FBS0EsV0FBT1gsRUFBRTNDLEdBQUYsQ0FBTSxVQUFVb0QsSUFBVixFQUFjO0FBQ3ZCLGVBQU9BLEtBQUtwRCxHQUFMLENBQVMsVUFBVXNELEtBQVYsRUFBZTtBQUMzQixtQkFBTzlELFdBQVc4RCxLQUFYLENBQVA7QUFDSCxTQUZNLENBQVA7QUFHSCxLQUpNLENBQVA7QUFLSDtBQXJERG5FLFFBQUFtRCxlQUFBLEdBQUFBLGVBQUEiLCJmaWxlIjoibWF0Y2gvYnJlYWtkb3duLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEBmaWxlXHJcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LmJyZWFrZG93blxyXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdkaXNwYXRjaGVyJylcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xlYW5zZVN0cmluZyhzU3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgdmFyIGxlbiA9IDA7XHJcbiAgICB3aGlsZSAobGVuICE9PSBzU3RyaW5nLmxlbmd0aCkge1xyXG4gICAgICAgIGxlbiA9IHNTdHJpbmcubGVuZ3RoO1xyXG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL1xccysvZywgJyAnKTtcclxuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9eXFxzKy8sICcnKTtcclxuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9cXHMrJC8sICcnKTtcclxuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9eWyw7Ll0rLywgJycpO1xyXG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL1ssOy5dKyQvLCAnJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc1N0cmluZ1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xlYW5zZVF1b3RlZFN0cmluZyhzU3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgdmFyIGxlbiA9IDA7XHJcbiAgICB3aGlsZSAobGVuICE9PSBzU3RyaW5nLmxlbmd0aCkge1xyXG4gICAgICAgIGxlbiA9IHNTdHJpbmcubGVuZ3RoO1xyXG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL1xcc1xccysvZywgJyAnKTtcclxuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9cXHMrL2csICcgJyk7XHJcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXlxccysvLCAnJyk7XHJcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXFxzKyQvLCAnJyk7XHJcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXlssOy5dKy8sICcnKTtcclxuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9bLDsuXSskLywgJycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHNTdHJpbmdcclxufVxyXG5cclxuXHJcblxyXG5jb25zdCByZWdleHBSZW1vdmVEb3VibGUgPSBuZXcgUmVnRXhwKC9eXFxcIihcXFwiLipcXFwiKVxcXCIkLyk7XHJcbmNvbnN0IHN0cmlwdGFpbCA9IG5ldyBSZWdFeHAoL15cXFwiKFteXFxcIl0rKVwiJC8pXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdHJpbVF1b3RlZChzU3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgdmFyIHNraXBVbnRpbCA9IDA7XHJcbiAgICB2YXIgc3RyaXBwZWQgPSBzU3RyaW5nO1xyXG4gICAgdmFyIG0gPSByZWdleHBSZW1vdmVEb3VibGUuZXhlYyhzU3RyaW5nKTtcclxuICAgIHdoaWxlIChtKSB7XHJcbiAgICAgICAgc3RyaXBwZWQgPSBtWzFdO1xyXG4gICAgICAgIG0gPSByZWdleHBSZW1vdmVEb3VibGUuZXhlYyhzdHJpcHBlZCk7XHJcbiAgICB9XHJcbiAgICBkZWJ1Z2xvZyhcInN0cmlwcGVkIFwiICsgc3RyaXBwZWQpO1xyXG4gICAgbSA9IHN0cmlwdGFpbC5leGVjKHN0cmlwcGVkKTtcclxuICAgIGlmIChtKSB7XHJcbiAgICAgICAgcmV0dXJuIG1bMV07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY2xlYW5zZVN0cmluZyhzU3RyaW5nKTtcclxufVxyXG5cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdHJpbVF1b3RlZFNwYWNlZChzU3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgdmFyIHNraXBVbnRpbCA9IDA7XHJcbiAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9eXCJcXHMrL2csICdcIicpO1xyXG4gICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXFxzK1xcXCIkL2csICdcIicpO1xyXG4gICAgcmV0dXJuIHNTdHJpbmc7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVjb21iaW5lUXVvdGVkKGFBcnI6IEFycmF5PHN0cmluZz4pOiBBcnJheTxzdHJpbmc+IHtcclxuICAgIHZhciBza2lwVW50aWwgPSAwO1xyXG4gICAgYUFyciA9IGFBcnIubWFwKGZ1bmN0aW9uIChzLCBpbmRleCkge1xyXG4gICAgICAgIGlmIChpbmRleCA8IHNraXBVbnRpbCkge1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZyhcInNraXBwaW5nID5cIiArIHMgKyBcIjxcIik7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICgvXlwiLy5leGVjKHMpKSB7XHJcbiAgICAgICAgICAgIHZhciBpID0gaW5kZXg7XHJcbiAgICAgICAgICAgIHdoaWxlIChpIDwgYUFyci5sZW5ndGggJiYgKCEvXCIkLy5leGVjKGFBcnJbaV0pIHx8IChpbmRleCA9PT0gaSAmJiBzID09PSAnXCInKSkpIHtcclxuICAgICAgICAgICAgICAgIGkgPSBpICsgMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaSA9PT0gYUFyci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwiVW50ZXJtaW5hdGVkIHF1b3RlZCBzdHJpbmdcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNraXBVbnRpbCA9IGkgKyAxO1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlcyA9IGFBcnIuc2xpY2UoaW5kZXgsIGkgKyAxKS5qb2luKFwiIFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcztcclxuICAgIH0pLmZpbHRlcihmdW5jdGlvbiAocykge1xyXG4gICAgICAgIHJldHVybiBzICE9PSB1bmRlZmluZWQ7XHJcbiAgICB9KS5tYXAoZnVuY3Rpb24gKHMpIHtcclxuICAgICAgICByZXR1cm4gdHJpbVF1b3RlZFNwYWNlZChzKTtcclxuICAgIH0pXHJcbiAgICByZXR1cm4gYUFycjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzUXVvdGVkKHNTdHJpbmcpIHtcclxuICAgIHJldHVybiAhIS9eXCIuKlwiJC8uZXhlYyhzU3RyaW5nKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNvdW50U3BhY2VzKHNTdHJpbmc6IHN0cmluZykge1xyXG4gICAgdmFyIHIgPSAwO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzU3RyaW5nLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgaWYgKHNTdHJpbmcuY2hhckF0KGkpID09PSAnICcpIHtcclxuICAgICAgICAgICAgciA9IHIgKyAxO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVRva2VuaXplZFN0cmluZyB7XHJcbiAgICB0b2tlbnMgOiBzdHJpbmdbXSxcclxuICAgIGZ1c2FibGUgOiBib29sZWFuW107XHJcbiAgICAvL2luZGV4TWFwIDogeyBba2V5Om51bWJlcl0gOiB7IGZ1c2U6IGJvb2xlYW59fTtcclxufVxyXG5cclxudmFyIFF1b3RlcyA9IC9eXCIoW15cIl0rKVwiLztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzd2FsbG93UXVvdGUoc3RyIDogc3RyaW5nLCBpIDogbnVtYmVyKSA6IHsgdG9rZW4gOiBzdHJpbmcsIG5leHRwb3MgOiBudW1iZXJ9IHtcclxuICAgICB2YXIgbSA9IFF1b3Rlcy5leGVjKHN0ci5zdWJzdHJpbmcoaSkpO1xyXG4gICAgIGlmKCFtKSB7XHJcbiAgICAgICAgICByZXR1cm4geyB0b2tlbjogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgbmV4dHBvcyA6IGlcclxuICAgICAgICAgfVxyXG4gICAgIH1cclxuICAgICByZXR1cm4ge1xyXG4gICAgICAgICB0b2tlbiA6IGNsZWFuc2VTdHJpbmcobVsxXSksXHJcbiAgICAgICAgIG5leHRwb3MgOiAoaSArIG1bMF0ubGVuZ3RoKVxyXG4gICAgIH1cclxufVxyXG5cclxudmFyIFdvcmQgPSAvXigoWy0jQS1aX2EtejAtOVxcL1xcXFxcXCVcXCQmXShcXCdbLSNBLVpfYS16MC05XFwvXFxcXFxcJVxcJCZdKSopKykvO1xyXG5leHBvcnQgZnVuY3Rpb24gc3dhbGxvd1dvcmQoc3RyIDogc3RyaW5nLCBpIDogbnVtYmVyKSA6IHsgdG9rZW4gOiBzdHJpbmcsIG5leHRwb3MgOiBudW1iZXJ9IHtcclxuICAgICB2YXIgbSA9IFdvcmQuZXhlYyhzdHIuc3Vic3RyaW5nKGkpKTtcclxuICAgICBpZighbSkge1xyXG4gICAgICAgICByZXR1cm4geyB0b2tlbjogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgbmV4dHBvcyA6IGlcclxuICAgICAgICAgfVxyXG4gICAgIH1cclxuICAgICByZXR1cm4ge1xyXG4gICAgICAgICB0b2tlbiA6IG1bMV0sXHJcbiAgICAgICAgIG5leHRwb3MgOiAoaSArIG1bMF0ubGVuZ3RoKVxyXG4gICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcHVzaFRva2VuKHJlcyA6IElUb2tlbml6ZWRTdHJpbmcsIHRva2VuIDogc3RyaW5nKSB7XHJcbiAgICByZXMudG9rZW5zLnB1c2godG9rZW4pO1xyXG4gICAgcmVzLmZ1c2FibGVbcmVzLnRva2Vucy5sZW5ndGhdID0gdHJ1ZTtcclxufVxyXG5cclxuLyoqXHJcbiAqQHBhcmFtIHtzdHJpbmd9IHNTdHJpbmcgLCBlLmcuIFwiYSxiIGM7ZCBPJ0hhcmEgYW5kIFwibXVycGgneXNcIlxyXG4gKkByZXR1cm4ge0FycmF5PFN0cmluZz59IGJyb2tlbiBkb3duIGFycmF5LCBlLmcuXHJcbiAqIFtbXCJhIGIgY1wiXSwgW1wiYVwiLCBcImIgY1wiXSwgW1wiYSBiXCIsIFwiY1wiXSwgLi4uLltcImFcIiwgXCJiXCIsIFwiY1wiXV1cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB0b2tlbml6ZVN0cmluZyhzU3RyaW5nOiBzdHJpbmcsIHNwYWNlc0xpbWl0PzogbnVtYmVyKTogSVRva2VuaXplZFN0cmluZyB7XHJcbiAgICB2YXIgcmVzID0ge1xyXG4gICAgICAgIHRva2VuczogW10sXHJcbiAgICAgICAgZnVzYWJsZSA6W2ZhbHNlXVxyXG4gICAgfSBhcyBJVG9rZW5pemVkU3RyaW5nO1xyXG4gICAgdmFyIGkgPSAwO1xyXG4gICAgdmFyIHNlZW5TZXA9IGZhbHNlO1xyXG4gICAgd2hpbGUgKGkgPHNTdHJpbmcubGVuZ3RoICkge1xyXG4gICAgICAgIHN3aXRjaChzU3RyaW5nLmNoYXJBdChpKSkge1xyXG4gICAgICAgICAgICBjYXNlICdcIic6XHJcbiAgICAgICAgICAgICAgICB2YXIgeyB0b2tlbiwgbmV4dHBvcyB9ID0gc3dhbGxvd1F1b3RlKHNTdHJpbmcsaSk7XHJcbiAgICAgICAgICAgICAgICBpZihuZXh0cG9zID09PSBpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdW50ZXJtaW5hdGVkIHF1b3RlLCB0cmVhdCBsaWtlIHNlcGFyYXRvclxyXG4gICAgICAgICAgICAgICAgICAgIHJlcy5mdXNhYmxlW3Jlcy50b2tlbnMubGVuZ3RoXSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlZW5TZXAgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICsraTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0b2tlbiA9PT0gXCJcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcy5mdXNhYmxlW3Jlcy50b2tlbnMubGVuZ3RoXSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlZW5TZXAgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGkgPSBuZXh0cG9zO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXMuZnVzYWJsZVtyZXMudG9rZW5zLmxlbmd0aF0gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICBwdXNoVG9rZW4ocmVzLHRva2VuKTtcclxuICAgICAgICAgICAgICAgICAgICByZXMuZnVzYWJsZVtyZXMudG9rZW5zLmxlbmd0aF0gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICBpID0gbmV4dHBvcztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ1xcdCc6XHJcbiAgICAgICAgICAgIGNhc2UgJ1xcbic6XHJcbiAgICAgICAgICAgIGNhc2UgJ1xccic6XHJcbiAgICAgICAgICAgIGNhc2UgJyAnOlxyXG4gICAgICAgICAgICAgICAgaSsrO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnOic6XHJcbiAgICAgICAgICAgIGNhc2UgJywnOlxyXG4gICAgICAgICAgICBjYXNlICcuJzpcclxuICAgICAgICAgICAgY2FzZSAnPyc6XHJcbiAgICAgICAgICAgIGNhc2UgJyEnOlxyXG4gICAgICAgICAgICBjYXNlICc7JzpcclxuICAgICAgICAgICAgICAgIHJlcy5mdXNhYmxlW3Jlcy50b2tlbnMubGVuZ3RoXSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgc2VlblNlcCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICArK2k7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdmFyIHt0b2tlbiwgbmV4dHBvc30gPSBzd2FsbG93V29yZChzU3RyaW5nLGkpO1xyXG4gICAgICAgICAgICAgICAgaWYodG9rZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICBwdXNoVG9rZW4ocmVzLHRva2VuKTtcclxuICAgICAgICAgICAgICAgICAgICBpID0gbmV4dHBvcztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLmZ1c2FibGVbcmVzLnRva2Vucy5sZW5ndGhdID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgaSsrXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJlcy5mdXNhYmxlW3Jlcy50b2tlbnMubGVuZ3RoXSA9IGZhbHNlO1xyXG4gICAgcmV0dXJuIHJlcztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VNYXRjaFBhdHRlcm4oc3RyOiBzdHJpbmcpIHtcclxuICAgIHZhciB0b2tlbnMgPSB0b2tlbml6ZVN0cmluZyhzdHIpO1xyXG4gICAgdmFyIGJlc3RsZW4gPSAwO1xyXG4gICAgdmFyIGJlc3QgPSB7XHJcbiAgICAgICAgbG9uZ2VzdFRva2VuIDogXCJcIixcclxuICAgICAgICBzcGFuOiB7bG93OiAwLCBoaWdoOiAwfVxyXG4gICAgfTtcclxuICAgIGlmKHRva2Vucy50b2tlbnMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgIHRva2Vucy50b2tlbnMuZm9yRWFjaChmdW5jdGlvbih0b2tlbixpbmRleCkge1xyXG4gICAgICAgICAgICB2YXIgbGVuID0gdG9rZW4ubGVuZ3RoO1xyXG4gICAgICAgICAgICBpZiAobGVuID4gYmVzdGxlbikge1xyXG4gICAgICAgICAgICAgICAgYmVzdGxlbiA9IGxlbjtcclxuICAgICAgICAgICAgICAgIGJlc3QubG9uZ2VzdFRva2VuID0gdG9rZW47XHJcbiAgICAgICAgICAgICAgICBiZXN0LnNwYW4ubG93ID0gLWluZGV4O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgYmVzdC5zcGFuLmhpZ2ggPSB0b2tlbnMudG9rZW5zLmxlbmd0aCArIGJlc3Quc3Bhbi5sb3cgLSAxO1xyXG4gICAgICAgIHJldHVybiBiZXN0O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxufVxyXG5cclxuLyoqXHJcbiAqQHBhcmFtIHtzdHJpbmd9IHNTdHJpbmcgLCBlLmcuIFwiYSBiIGNcIlxyXG4gKkByZXR1cm4ge0FycmF5PEFycmF5PFN0cmluZz4+fSBicm9rZW4gZG93biBhcnJheSwgZS5nLlxyXG4gKltbXCJhIGIgY1wiXSwgW1wiYVwiLCBcImIgY1wiXSwgW1wiYSBiXCIsIFwiY1wiXSwgLi4uLltcImFcIiwgXCJiXCIsIFwiY1wiXV1cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBicmVha2Rvd25TdHJpbmcoc1N0cmluZzogc3RyaW5nLCBzcGFjZXNMaW1pdD86IG51bWJlcik6IEFycmF5PEFycmF5PFN0cmluZz4+IHtcclxuICAgIHZhciByU3RyaW5nID0gY2xlYW5zZVN0cmluZyhzU3RyaW5nKTtcclxuICAgIGlmIChzcGFjZXNMaW1pdCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgc3BhY2VzTGltaXQgPSAtMTtcclxuICAgIH1cclxuICAgIHZhciB1ID0gclN0cmluZy5zcGxpdChcIiBcIik7XHJcbiAgICB1ID0gcmVjb21iaW5lUXVvdGVkKHUpO1xyXG4gICAgdmFyIGsgPSAwO1xyXG4gICAgaWYgKHUubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIFtbXV07XHJcbiAgICB9XHJcbiAgICB2YXIgdyA9IFtbdVswXV1dO1xyXG4gICAgd2hpbGUgKGsgPCB1Lmxlbmd0aCAtIDEpIHtcclxuICAgICAgICBrID0gayArIDE7XHJcbiAgICAgICAgdmFyIHIxID0gdy5tYXAoZnVuY3Rpb24gKGVudHJ5KSB7XHJcbiAgICAgICAgICAgIGRlYnVnbG9nKEpTT04uc3RyaW5naWZ5KGVudHJ5KSk7XHJcbiAgICAgICAgICAgIHZhciBlbnRyeSA9IGVudHJ5LnNsaWNlKDApO1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShlbnRyeSkpO1xyXG4gICAgICAgICAgICB2YXIgcHJldmVudHJ5ID0gZW50cnlbZW50cnkubGVuZ3RoIC0xXTtcclxuICAgICAgICAgICAgLy8gZG8gbm90IGNvbWJpbmUgcXVvdGVkIHN0cmluZ3MhXHJcbiAgICAgICAgICAgIGlmIChwcmV2ZW50cnkgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIC8qIGRvIG5vdGhpbmcgKi8gLy9yZXR1cm4gZW50cnk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNRdW90ZWQodVtrXSkgfHwgaXNRdW90ZWQocHJldmVudHJ5KSkge1xyXG4gICAgICAgICAgICAgICAgZW50cnlbZW50cnkubGVuZ3RoIC0gMV0gPSBudWxsO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkID0gcHJldmVudHJ5ICsgXCIgXCIgKyB1W2tdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNwYWNlc0xpbWl0ID4gMCAmJiBjb3VudFNwYWNlcyhjb21iaW5lZCkgPiBzcGFjZXNMaW1pdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbWJpbmVkID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVudHJ5W2VudHJ5Lmxlbmd0aCAtIDFdID0gY29tYmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGVudHJ5O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHZhciByMiA9IHcubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIjIgPlwiICsgSlNPTi5zdHJpbmdpZnkoZW50cnkpKTtcclxuICAgICAgICAgICAgdmFyIGVudHJ5ID0gZW50cnkuc2xpY2UoMCk7XHJcbiAgICAgICAgICAgIGVudHJ5LnB1c2godVtrXSk7XHJcbiAgICAgICAgICAgIHJldHVybiBlbnRyeVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGRlYnVnbG9nKEpTT04uc3RyaW5naWZ5KHIxKSk7XHJcbiAgICAgICAgZGVidWdsb2coSlNPTi5zdHJpbmdpZnkocjIpKTtcclxuICAgICAgICB3ID0gcjEuY29uY2F0KHIyKTtcclxuICAgIH1cclxuICAgIHcgPSB3LmZpbHRlcihmdW5jdGlvbihvTWFwKSB7XHJcbiAgICAgICAgcmV0dXJuIG9NYXAuZXZlcnkoZnVuY3Rpb24oc1dvcmQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHNXb3JkICE9PSBudWxsO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdy5tYXAoZnVuY3Rpb24gKG9NYXApIHtcclxuICAgICAgICByZXR1cm4gb01hcC5tYXAoZnVuY3Rpb24gKHNXb3JkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cmltUXVvdGVkKHNXb3JkKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJ1xyXG5cclxuIiwiLyoqXG4gKiBAZmlsZVxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYnJlYWtkb3duXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2Rpc3BhdGNoZXInKTtcbmZ1bmN0aW9uIGNsZWFuc2VTdHJpbmcoc1N0cmluZykge1xuICAgIHZhciBsZW4gPSAwO1xuICAgIHdoaWxlIChsZW4gIT09IHNTdHJpbmcubGVuZ3RoKSB7XG4gICAgICAgIGxlbiA9IHNTdHJpbmcubGVuZ3RoO1xuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9cXHMrL2csICcgJyk7XG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL15cXHMrLywgJycpO1xuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9cXHMrJC8sICcnKTtcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXlssOy5dKy8sICcnKTtcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvWyw7Ll0rJC8sICcnKTtcbiAgICB9XG4gICAgcmV0dXJuIHNTdHJpbmc7XG59XG5leHBvcnRzLmNsZWFuc2VTdHJpbmcgPSBjbGVhbnNlU3RyaW5nO1xuZnVuY3Rpb24gY2xlYW5zZVF1b3RlZFN0cmluZyhzU3RyaW5nKSB7XG4gICAgdmFyIGxlbiA9IDA7XG4gICAgd2hpbGUgKGxlbiAhPT0gc1N0cmluZy5sZW5ndGgpIHtcbiAgICAgICAgbGVuID0gc1N0cmluZy5sZW5ndGg7XG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL1xcc1xccysvZywgJyAnKTtcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXFxzKy9nLCAnICcpO1xuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9eXFxzKy8sICcnKTtcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXFxzKyQvLCAnJyk7XG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL15bLDsuXSsvLCAnJyk7XG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL1ssOy5dKyQvLCAnJyk7XG4gICAgfVxuICAgIHJldHVybiBzU3RyaW5nO1xufVxuZXhwb3J0cy5jbGVhbnNlUXVvdGVkU3RyaW5nID0gY2xlYW5zZVF1b3RlZFN0cmluZztcbnZhciByZWdleHBSZW1vdmVEb3VibGUgPSBuZXcgUmVnRXhwKC9eXFxcIihcXFwiLipcXFwiKVxcXCIkLyk7XG52YXIgc3RyaXB0YWlsID0gbmV3IFJlZ0V4cCgvXlxcXCIoW15cXFwiXSspXCIkLyk7XG5mdW5jdGlvbiB0cmltUXVvdGVkKHNTdHJpbmcpIHtcbiAgICB2YXIgc2tpcFVudGlsID0gMDtcbiAgICB2YXIgc3RyaXBwZWQgPSBzU3RyaW5nO1xuICAgIHZhciBtID0gcmVnZXhwUmVtb3ZlRG91YmxlLmV4ZWMoc1N0cmluZyk7XG4gICAgd2hpbGUgKG0pIHtcbiAgICAgICAgc3RyaXBwZWQgPSBtWzFdO1xuICAgICAgICBtID0gcmVnZXhwUmVtb3ZlRG91YmxlLmV4ZWMoc3RyaXBwZWQpO1xuICAgIH1cbiAgICBkZWJ1Z2xvZyhcInN0cmlwcGVkIFwiICsgc3RyaXBwZWQpO1xuICAgIG0gPSBzdHJpcHRhaWwuZXhlYyhzdHJpcHBlZCk7XG4gICAgaWYgKG0pIHtcbiAgICAgICAgcmV0dXJuIG1bMV07XG4gICAgfVxuICAgIHJldHVybiBjbGVhbnNlU3RyaW5nKHNTdHJpbmcpO1xufVxuZXhwb3J0cy50cmltUXVvdGVkID0gdHJpbVF1b3RlZDtcbmZ1bmN0aW9uIHRyaW1RdW90ZWRTcGFjZWQoc1N0cmluZykge1xuICAgIHZhciBza2lwVW50aWwgPSAwO1xuICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL15cIlxccysvZywgJ1wiJyk7XG4gICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXFxzK1xcXCIkL2csICdcIicpO1xuICAgIHJldHVybiBzU3RyaW5nO1xufVxuZXhwb3J0cy50cmltUXVvdGVkU3BhY2VkID0gdHJpbVF1b3RlZFNwYWNlZDtcbmZ1bmN0aW9uIHJlY29tYmluZVF1b3RlZChhQXJyKSB7XG4gICAgdmFyIHNraXBVbnRpbCA9IDA7XG4gICAgYUFyciA9IGFBcnIubWFwKGZ1bmN0aW9uIChzLCBpbmRleCkge1xuICAgICAgICBpZiAoaW5kZXggPCBza2lwVW50aWwpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwic2tpcHBpbmcgPlwiICsgcyArIFwiPFwiKTtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKC9eXCIvLmV4ZWMocykpIHtcbiAgICAgICAgICAgIHZhciBpID0gaW5kZXg7XG4gICAgICAgICAgICB3aGlsZSAoaSA8IGFBcnIubGVuZ3RoICYmICghL1wiJC8uZXhlYyhhQXJyW2ldKSB8fCAoaW5kZXggPT09IGkgJiYgcyA9PT0gJ1wiJykpKSB7XG4gICAgICAgICAgICAgICAgaSA9IGkgKyAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGkgPT09IGFBcnIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCJVbnRlcm1pbmF0ZWQgcXVvdGVkIHN0cmluZ1wiKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHNraXBVbnRpbCA9IGkgKyAxO1xuICAgICAgICAgICAgICAgIHZhciByZXMgPSBhQXJyLnNsaWNlKGluZGV4LCBpICsgMSkuam9pbihcIiBcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzO1xuICAgIH0pLmZpbHRlcihmdW5jdGlvbiAocykge1xuICAgICAgICByZXR1cm4gcyAhPT0gdW5kZWZpbmVkO1xuICAgIH0pLm1hcChmdW5jdGlvbiAocykge1xuICAgICAgICByZXR1cm4gdHJpbVF1b3RlZFNwYWNlZChzKTtcbiAgICB9KTtcbiAgICByZXR1cm4gYUFycjtcbn1cbmV4cG9ydHMucmVjb21iaW5lUXVvdGVkID0gcmVjb21iaW5lUXVvdGVkO1xuZnVuY3Rpb24gaXNRdW90ZWQoc1N0cmluZykge1xuICAgIHJldHVybiAhIS9eXCIuKlwiJC8uZXhlYyhzU3RyaW5nKTtcbn1cbmV4cG9ydHMuaXNRdW90ZWQgPSBpc1F1b3RlZDtcbmZ1bmN0aW9uIGNvdW50U3BhY2VzKHNTdHJpbmcpIHtcbiAgICB2YXIgciA9IDA7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzU3RyaW5nLmxlbmd0aDsgKytpKSB7XG4gICAgICAgIGlmIChzU3RyaW5nLmNoYXJBdChpKSA9PT0gJyAnKSB7XG4gICAgICAgICAgICByID0gciArIDE7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHI7XG59XG5leHBvcnRzLmNvdW50U3BhY2VzID0gY291bnRTcGFjZXM7XG52YXIgUXVvdGVzID0gL15cIihbXlwiXSspXCIvO1xuZnVuY3Rpb24gc3dhbGxvd1F1b3RlKHN0ciwgaSkge1xuICAgIHZhciBtID0gUXVvdGVzLmV4ZWMoc3RyLnN1YnN0cmluZyhpKSk7XG4gICAgaWYgKCFtKSB7XG4gICAgICAgIHJldHVybiB7IHRva2VuOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBuZXh0cG9zOiBpXG4gICAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHRva2VuOiBjbGVhbnNlU3RyaW5nKG1bMV0pLFxuICAgICAgICBuZXh0cG9zOiAoaSArIG1bMF0ubGVuZ3RoKVxuICAgIH07XG59XG5leHBvcnRzLnN3YWxsb3dRdW90ZSA9IHN3YWxsb3dRdW90ZTtcbnZhciBXb3JkID0gL14oKFstI0EtWl9hLXowLTlcXC9cXFxcXFwlXFwkJl0oXFwnWy0jQS1aX2EtejAtOVxcL1xcXFxcXCVcXCQmXSkqKSspLztcbmZ1bmN0aW9uIHN3YWxsb3dXb3JkKHN0ciwgaSkge1xuICAgIHZhciBtID0gV29yZC5leGVjKHN0ci5zdWJzdHJpbmcoaSkpO1xuICAgIGlmICghbSkge1xuICAgICAgICByZXR1cm4geyB0b2tlbjogdW5kZWZpbmVkLFxuICAgICAgICAgICAgbmV4dHBvczogaVxuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICB0b2tlbjogbVsxXSxcbiAgICAgICAgbmV4dHBvczogKGkgKyBtWzBdLmxlbmd0aClcbiAgICB9O1xufVxuZXhwb3J0cy5zd2FsbG93V29yZCA9IHN3YWxsb3dXb3JkO1xuZnVuY3Rpb24gcHVzaFRva2VuKHJlcywgdG9rZW4pIHtcbiAgICByZXMudG9rZW5zLnB1c2godG9rZW4pO1xuICAgIHJlcy5mdXNhYmxlW3Jlcy50b2tlbnMubGVuZ3RoXSA9IHRydWU7XG59XG4vKipcbiAqQHBhcmFtIHtzdHJpbmd9IHNTdHJpbmcgLCBlLmcuIFwiYSxiIGM7ZCBPJ0hhcmEgYW5kIFwibXVycGgneXNcIlxuICpAcmV0dXJuIHtBcnJheTxTdHJpbmc+fSBicm9rZW4gZG93biBhcnJheSwgZS5nLlxuICogW1tcImEgYiBjXCJdLCBbXCJhXCIsIFwiYiBjXCJdLCBbXCJhIGJcIiwgXCJjXCJdLCAuLi4uW1wiYVwiLCBcImJcIiwgXCJjXCJdXVxuICovXG5mdW5jdGlvbiB0b2tlbml6ZVN0cmluZyhzU3RyaW5nLCBzcGFjZXNMaW1pdCkge1xuICAgIHZhciByZXMgPSB7XG4gICAgICAgIHRva2VuczogW10sXG4gICAgICAgIGZ1c2FibGU6IFtmYWxzZV1cbiAgICB9O1xuICAgIHZhciBpID0gMDtcbiAgICB2YXIgc2VlblNlcCA9IGZhbHNlO1xuICAgIHdoaWxlIChpIDwgc1N0cmluZy5sZW5ndGgpIHtcbiAgICAgICAgc3dpdGNoIChzU3RyaW5nLmNoYXJBdChpKSkge1xuICAgICAgICAgICAgY2FzZSAnXCInOlxuICAgICAgICAgICAgICAgIHZhciBfYSA9IHN3YWxsb3dRdW90ZShzU3RyaW5nLCBpKSwgdG9rZW4gPSBfYS50b2tlbiwgbmV4dHBvcyA9IF9hLm5leHRwb3M7XG4gICAgICAgICAgICAgICAgaWYgKG5leHRwb3MgPT09IGkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gdW50ZXJtaW5hdGVkIHF1b3RlLCB0cmVhdCBsaWtlIHNlcGFyYXRvclxuICAgICAgICAgICAgICAgICAgICByZXMuZnVzYWJsZVtyZXMudG9rZW5zLmxlbmd0aF0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgc2VlblNlcCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICsraTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodG9rZW4gPT09IFwiXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzLmZ1c2FibGVbcmVzLnRva2Vucy5sZW5ndGhdID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHNlZW5TZXAgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpID0gbmV4dHBvcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5mdXNhYmxlW3Jlcy50b2tlbnMubGVuZ3RoXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBwdXNoVG9rZW4ocmVzLCB0b2tlbik7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5mdXNhYmxlW3Jlcy50b2tlbnMubGVuZ3RoXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpID0gbmV4dHBvcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdcXHQnOlxuICAgICAgICAgICAgY2FzZSAnXFxuJzpcbiAgICAgICAgICAgIGNhc2UgJ1xccic6XG4gICAgICAgICAgICBjYXNlICcgJzpcbiAgICAgICAgICAgICAgICBpKys7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICc6JzpcbiAgICAgICAgICAgIGNhc2UgJywnOlxuICAgICAgICAgICAgY2FzZSAnLic6XG4gICAgICAgICAgICBjYXNlICc/JzpcbiAgICAgICAgICAgIGNhc2UgJyEnOlxuICAgICAgICAgICAgY2FzZSAnOyc6XG4gICAgICAgICAgICAgICAgcmVzLmZ1c2FibGVbcmVzLnRva2Vucy5sZW5ndGhdID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgc2VlblNlcCA9IHRydWU7XG4gICAgICAgICAgICAgICAgKytpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB2YXIgX2IgPSBzd2FsbG93V29yZChzU3RyaW5nLCBpKSwgdG9rZW4gPSBfYi50b2tlbiwgbmV4dHBvcyA9IF9iLm5leHRwb3M7XG4gICAgICAgICAgICAgICAgaWYgKHRva2VuKSB7XG4gICAgICAgICAgICAgICAgICAgIHB1c2hUb2tlbihyZXMsIHRva2VuKTtcbiAgICAgICAgICAgICAgICAgICAgaSA9IG5leHRwb3M7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXMuZnVzYWJsZVtyZXMudG9rZW5zLmxlbmd0aF0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaSsrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXMuZnVzYWJsZVtyZXMudG9rZW5zLmxlbmd0aF0gPSBmYWxzZTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy50b2tlbml6ZVN0cmluZyA9IHRva2VuaXplU3RyaW5nO1xuZnVuY3Rpb24gbWFrZU1hdGNoUGF0dGVybihzdHIpIHtcbiAgICB2YXIgdG9rZW5zID0gdG9rZW5pemVTdHJpbmcoc3RyKTtcbiAgICB2YXIgYmVzdGxlbiA9IDA7XG4gICAgdmFyIGJlc3QgPSB7XG4gICAgICAgIGxvbmdlc3RUb2tlbjogXCJcIixcbiAgICAgICAgc3BhbjogeyBsb3c6IDAsIGhpZ2g6IDAgfVxuICAgIH07XG4gICAgaWYgKHRva2Vucy50b2tlbnMubGVuZ3RoID4gMSkge1xuICAgICAgICB0b2tlbnMudG9rZW5zLmZvckVhY2goZnVuY3Rpb24gKHRva2VuLCBpbmRleCkge1xuICAgICAgICAgICAgdmFyIGxlbiA9IHRva2VuLmxlbmd0aDtcbiAgICAgICAgICAgIGlmIChsZW4gPiBiZXN0bGVuKSB7XG4gICAgICAgICAgICAgICAgYmVzdGxlbiA9IGxlbjtcbiAgICAgICAgICAgICAgICBiZXN0Lmxvbmdlc3RUb2tlbiA9IHRva2VuO1xuICAgICAgICAgICAgICAgIGJlc3Quc3Bhbi5sb3cgPSAtaW5kZXg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBiZXN0LnNwYW4uaGlnaCA9IHRva2Vucy50b2tlbnMubGVuZ3RoICsgYmVzdC5zcGFuLmxvdyAtIDE7XG4gICAgICAgIHJldHVybiBiZXN0O1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5tYWtlTWF0Y2hQYXR0ZXJuID0gbWFrZU1hdGNoUGF0dGVybjtcbi8qKlxuICpAcGFyYW0ge3N0cmluZ30gc1N0cmluZyAsIGUuZy4gXCJhIGIgY1wiXG4gKkByZXR1cm4ge0FycmF5PEFycmF5PFN0cmluZz4+fSBicm9rZW4gZG93biBhcnJheSwgZS5nLlxuICpbW1wiYSBiIGNcIl0sIFtcImFcIiwgXCJiIGNcIl0sIFtcImEgYlwiLCBcImNcIl0sIC4uLi5bXCJhXCIsIFwiYlwiLCBcImNcIl1dXG4gKi9cbmZ1bmN0aW9uIGJyZWFrZG93blN0cmluZyhzU3RyaW5nLCBzcGFjZXNMaW1pdCkge1xuICAgIHZhciByU3RyaW5nID0gY2xlYW5zZVN0cmluZyhzU3RyaW5nKTtcbiAgICBpZiAoc3BhY2VzTGltaXQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBzcGFjZXNMaW1pdCA9IC0xO1xuICAgIH1cbiAgICB2YXIgdSA9IHJTdHJpbmcuc3BsaXQoXCIgXCIpO1xuICAgIHUgPSByZWNvbWJpbmVRdW90ZWQodSk7XG4gICAgdmFyIGsgPSAwO1xuICAgIGlmICh1Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW1tdXTtcbiAgICB9XG4gICAgdmFyIHcgPSBbW3VbMF1dXTtcbiAgICB3aGlsZSAoayA8IHUubGVuZ3RoIC0gMSkge1xuICAgICAgICBrID0gayArIDE7XG4gICAgICAgIHZhciByMSA9IHcubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xuICAgICAgICAgICAgZGVidWdsb2coSlNPTi5zdHJpbmdpZnkoZW50cnkpKTtcbiAgICAgICAgICAgIHZhciBlbnRyeSA9IGVudHJ5LnNsaWNlKDApO1xuICAgICAgICAgICAgZGVidWdsb2coSlNPTi5zdHJpbmdpZnkoZW50cnkpKTtcbiAgICAgICAgICAgIHZhciBwcmV2ZW50cnkgPSBlbnRyeVtlbnRyeS5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgIC8vIGRvIG5vdCBjb21iaW5lIHF1b3RlZCBzdHJpbmdzIVxuICAgICAgICAgICAgaWYgKHByZXZlbnRyeSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoaXNRdW90ZWQodVtrXSkgfHwgaXNRdW90ZWQocHJldmVudHJ5KSkge1xuICAgICAgICAgICAgICAgIGVudHJ5W2VudHJ5Lmxlbmd0aCAtIDFdID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBjb21iaW5lZCA9IHByZXZlbnRyeSArIFwiIFwiICsgdVtrXTtcbiAgICAgICAgICAgICAgICBpZiAoc3BhY2VzTGltaXQgPiAwICYmIGNvdW50U3BhY2VzKGNvbWJpbmVkKSA+IHNwYWNlc0xpbWl0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbWJpbmVkID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZW50cnlbZW50cnkubGVuZ3RoIC0gMV0gPSBjb21iaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBlbnRyeTtcbiAgICAgICAgfSk7XG4gICAgICAgIHZhciByMiA9IHcubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIyID5cIiArIEpTT04uc3RyaW5naWZ5KGVudHJ5KSk7XG4gICAgICAgICAgICB2YXIgZW50cnkgPSBlbnRyeS5zbGljZSgwKTtcbiAgICAgICAgICAgIGVudHJ5LnB1c2godVtrXSk7XG4gICAgICAgICAgICByZXR1cm4gZW50cnk7XG4gICAgICAgIH0pO1xuICAgICAgICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShyMSkpO1xuICAgICAgICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShyMikpO1xuICAgICAgICB3ID0gcjEuY29uY2F0KHIyKTtcbiAgICB9XG4gICAgdyA9IHcuZmlsdGVyKGZ1bmN0aW9uIChvTWFwKSB7XG4gICAgICAgIHJldHVybiBvTWFwLmV2ZXJ5KGZ1bmN0aW9uIChzV29yZCkge1xuICAgICAgICAgICAgcmV0dXJuIHNXb3JkICE9PSBudWxsO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gdy5tYXAoZnVuY3Rpb24gKG9NYXApIHtcbiAgICAgICAgcmV0dXJuIG9NYXAubWFwKGZ1bmN0aW9uIChzV29yZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRyaW1RdW90ZWQoc1dvcmQpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuYnJlYWtkb3duU3RyaW5nID0gYnJlYWtkb3duU3RyaW5nO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
