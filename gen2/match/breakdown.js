/**
 * @file
 * @module jfseb.fdevstart.breakdown
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require('debug');
var debuglog = debug('dispatcher');
function cleanseString(sString) {
    var len = 0;
    while (len !== sString.length) {
        len = sString.length;
        sString = sString.replace(/\s\s+/g, ' ');
        sString = sString.replace(/\s\s+/g, ' ');
        sString = sString.replace(/^\s+/, '');
        sString = sString.replace(/\s+$/, '');
        sString = sString.replace(/^[,;.]+/, '');
        sString = sString.replace(/[,;.]+$/, '');
    }
    return sString;
}
exports.cleanseString = cleanseString;
var regexpRemoveDouble = new RegExp(/^\"(\".*\")\"$/);
var striptail = new RegExp(/^\"([^\"]+)"$/);
function trimQuoted(sString) {
    var skipUntil = 0;
    var stripped = sString;
    var m = regexpRemoveDouble.exec(sString);
    while (m) {
        stripped = m[1];
        m = regexpRemoveDouble.exec(stripped);
    }
    debuglog("stripped " + stripped);
    m = striptail.exec(stripped);
    if (m) {
        return m[1];
    }
    return cleanseString(sString);
}
exports.trimQuoted = trimQuoted;
function trimQuotedSpaced(sString) {
    var skipUntil = 0;
    sString = sString.replace(/^"\s+/g, '"');
    sString = sString.replace(/\s+\"$/g, '"');
    return sString;
}
exports.trimQuotedSpaced = trimQuotedSpaced;
function recombineQuoted(aArr) {
    var skipUntil = 0;
    aArr = aArr.map(function (s, index) {
        if (index < skipUntil) {
            debuglog("skipping >" + s + "<");
            return undefined;
        }
        if (/^"/.exec(s)) {
            var i = index;
            while (i < aArr.length && (!/"$/.exec(aArr[i]) || index === i && s === '"')) {
                i = i + 1;
            }
            if (i === aArr.length) {
                debuglog("Unterminated quoted string");
                return s;
            } else {
                skipUntil = i + 1;
                var res = aArr.slice(index, i + 1).join(" ");
            }
            return res;
        }
        return s;
    }).filter(function (s) {
        return s !== undefined;
    }).map(function (s) {
        return trimQuotedSpaced(s);
    });
    return aArr;
}
exports.recombineQuoted = recombineQuoted;
function isQuoted(sString) {
    return !!/^".*"$/.exec(sString);
}
exports.isQuoted = isQuoted;
function countSpaces(sString) {
    var r = 0;
    for (var i = 0; i < sString.length; ++i) {
        if (sString.charAt(i) === ' ') {
            r = r + 1;
        }
    }
    return r;
}
exports.countSpaces = countSpaces;
/**
 *@param {string} sString , e.g. "a b c"
 *@return {Array<Array<String>>} broken down array, e.g.
 *[["a b c"], ["a", "b c"], ["a b", "c"], ....["a", "b", "c"]]
 */
function breakdownString(sString, spacesLimit) {
    var rString = cleanseString(sString);
    if (spacesLimit === undefined) {
        spacesLimit = -1;
    }
    var u = rString.split(" ");
    u = recombineQuoted(u);
    var k = 0;
    if (u.length === 0) {
        return [[]];
    }
    var w = [[u[0]]];
    while (k < u.length - 1) {
        k = k + 1;
        var r1 = w.map(function (entry) {
            debuglog(JSON.stringify(entry));
            var entry = entry.slice(0);
            debuglog(JSON.stringify(entry));
            var preventry = entry[entry.length - 1];
            // do not combine quoted strings!
            if (preventry === null) {} else if (isQuoted(u[k]) || isQuoted(preventry)) {
                entry[entry.length - 1] = null;
            } else {
                var combined = preventry + " " + u[k];
                if (spacesLimit > 0 && countSpaces(combined) > spacesLimit) {
                    combined = null;
                }
                entry[entry.length - 1] = combined;
            }
            return entry;
        });
        var r2 = w.map(function (entry) {
            debuglog("2 >" + JSON.stringify(entry));
            var entry = entry.slice(0);
            entry.push(u[k]);
            return entry;
        });
        debuglog(JSON.stringify(r1));
        debuglog(JSON.stringify(r2));
        w = r1.concat(r2);
    }
    w = w.filter(function (oMap) {
        return oMap.every(function (sWord) {
            return sWord !== null;
        });
    });
    return w.map(function (oMap) {
        return oMap.map(function (sWord) {
            return trimQuoted(sWord);
        });
    });
}
exports.breakdownString = breakdownString;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC9icmVha2Rvd24udHMiLCJtYXRjaC9icmVha2Rvd24uanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJjbGVhbnNlU3RyaW5nIiwic1N0cmluZyIsImxlbiIsImxlbmd0aCIsInJlcGxhY2UiLCJleHBvcnRzIiwicmVnZXhwUmVtb3ZlRG91YmxlIiwiUmVnRXhwIiwic3RyaXB0YWlsIiwidHJpbVF1b3RlZCIsInNraXBVbnRpbCIsInN0cmlwcGVkIiwibSIsImV4ZWMiLCJ0cmltUXVvdGVkU3BhY2VkIiwicmVjb21iaW5lUXVvdGVkIiwiYUFyciIsIm1hcCIsInMiLCJpbmRleCIsInVuZGVmaW5lZCIsImkiLCJyZXMiLCJzbGljZSIsImpvaW4iLCJmaWx0ZXIiLCJpc1F1b3RlZCIsImNvdW50U3BhY2VzIiwiciIsImNoYXJBdCIsImJyZWFrZG93blN0cmluZyIsInNwYWNlc0xpbWl0IiwiclN0cmluZyIsInUiLCJzcGxpdCIsImsiLCJ3IiwicjEiLCJlbnRyeSIsIkpTT04iLCJzdHJpbmdpZnkiLCJwcmV2ZW50cnkiLCJjb21iaW5lZCIsInIyIiwicHVzaCIsImNvbmNhdCIsIm9NYXAiLCJldmVyeSIsInNXb3JkIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUNLQTs7QURDQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4sQ0FBakI7QUFDQSxJQUFNQyxXQUFXRixNQUFNLFlBQU4sQ0FBakI7QUFHQSxTQUFBRyxhQUFBLENBQThCQyxPQUE5QixFQUE2QztBQUN6QyxRQUFJQyxNQUFNLENBQVY7QUFDQSxXQUFPQSxRQUFRRCxRQUFRRSxNQUF2QixFQUErQjtBQUMzQkQsY0FBTUQsUUFBUUUsTUFBZDtBQUNBRixrQkFBVUEsUUFBUUcsT0FBUixDQUFnQixRQUFoQixFQUEwQixHQUExQixDQUFWO0FBQ0FILGtCQUFVQSxRQUFRRyxPQUFSLENBQWdCLFFBQWhCLEVBQTBCLEdBQTFCLENBQVY7QUFDQUgsa0JBQVVBLFFB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QWYsQ0FBVDtBQUNBUCxZQUFJQyxHQUFHUSxNQUFILENBQVVGLEVBQVYsQ0FBSjtBQUNIO0FBQ0RQLFFBQUlBLEVBQUVYLE1BQUYsQ0FBUyxVQUFTcUIsSUFBVCxFQUFhO0FBQ3RCLGVBQU9BLEtBQUtDLEtBQUwsQ0FBVyxVQUFTQyxLQUFULEVBQWM7QUFDNUIsbUJBQU9BLFVBQVUsSUFBakI7QUFDSCxTQUZNLENBQVA7QUFHSCxLQUpHLENBQUo7QUFLQSxXQUFPWixFQUFFbkIsR0FBRixDQUFNLFVBQVU2QixJQUFWLEVBQWM7QUFDdkIsZUFBT0EsS0FBSzdCLEdBQUwsQ0FBUyxVQUFVK0IsS0FBVixFQUFlO0FBQzNCLG1CQUFPdkMsV0FBV3VDLEtBQVgsQ0FBUDtBQUNILFNBRk0sQ0FBUDtBQUdILEtBSk0sQ0FBUDtBQUtIO0FBckRlM0MsUUFBQXlCLGVBQUEsR0FBZUEsZUFBZiIsImZpbGUiOiJtYXRjaC9icmVha2Rvd24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQGZpbGVcclxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYnJlYWtkb3duXHJcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cclxuICovXHJcblxyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ2Rpc3BhdGNoZXInKVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjbGVhbnNlU3RyaW5nKHNTdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICB2YXIgbGVuID0gMDtcclxuICAgIHdoaWxlIChsZW4gIT09IHNTdHJpbmcubGVuZ3RoKSB7XHJcbiAgICAgICAgbGVuID0gc1N0cmluZy5sZW5ndGg7XHJcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXFxzXFxzKy9nLCAnICcpO1xyXG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL1xcc1xccysvZywgJyAnKTtcclxuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9eXFxzKy8sICcnKTtcclxuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9cXHMrJC8sICcnKTtcclxuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9eWyw7Ll0rLywgJycpO1xyXG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL1ssOy5dKyQvLCAnJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc1N0cmluZ1xyXG59XHJcblxyXG5cclxuY29uc3QgcmVnZXhwUmVtb3ZlRG91YmxlID0gbmV3IFJlZ0V4cCgvXlxcXCIoXFxcIi4qXFxcIilcXFwiJC8pO1xyXG5jb25zdCBzdHJpcHRhaWwgPSBuZXcgUmVnRXhwKC9eXFxcIihbXlxcXCJdKylcIiQvKVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRyaW1RdW90ZWQoc1N0cmluZzogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHZhciBza2lwVW50aWwgPSAwO1xyXG4gICAgdmFyIHN0cmlwcGVkID0gc1N0cmluZztcclxuICAgIHZhciBtID0gcmVnZXhwUmVtb3ZlRG91YmxlLmV4ZWMoc1N0cmluZyk7XHJcbiAgICB3aGlsZSAobSkge1xyXG4gICAgICAgIHN0cmlwcGVkID0gbVsxXTtcclxuICAgICAgICBtID0gcmVnZXhwUmVtb3ZlRG91YmxlLmV4ZWMoc3RyaXBwZWQpO1xyXG4gICAgfVxyXG4gICAgZGVidWdsb2coXCJzdHJpcHBlZCBcIiArIHN0cmlwcGVkKTtcclxuICAgIG0gPSBzdHJpcHRhaWwuZXhlYyhzdHJpcHBlZCk7XHJcbiAgICBpZiAobSkge1xyXG4gICAgICAgIHJldHVybiBtWzFdO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGNsZWFuc2VTdHJpbmcoc1N0cmluZyk7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdHJpbVF1b3RlZFNwYWNlZChzU3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgdmFyIHNraXBVbnRpbCA9IDA7XHJcbiAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9eXCJcXHMrL2csICdcIicpO1xyXG4gICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXFxzK1xcXCIkL2csICdcIicpO1xyXG4gICAgcmV0dXJuIHNTdHJpbmc7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVjb21iaW5lUXVvdGVkKGFBcnI6IEFycmF5PHN0cmluZz4pOiBBcnJheTxzdHJpbmc+IHtcclxuICAgIHZhciBza2lwVW50aWwgPSAwO1xyXG4gICAgYUFyciA9IGFBcnIubWFwKGZ1bmN0aW9uIChzLCBpbmRleCkge1xyXG4gICAgICAgIGlmIChpbmRleCA8IHNraXBVbnRpbCkge1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZyhcInNraXBwaW5nID5cIiArIHMgKyBcIjxcIik7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICgvXlwiLy5leGVjKHMpKSB7XHJcbiAgICAgICAgICAgIHZhciBpID0gaW5kZXg7XHJcbiAgICAgICAgICAgIHdoaWxlIChpIDwgYUFyci5sZW5ndGggJiYgKCEvXCIkLy5leGVjKGFBcnJbaV0pIHx8IChpbmRleCA9PT0gaSAmJiBzID09PSAnXCInKSkpIHtcclxuICAgICAgICAgICAgICAgIGkgPSBpICsgMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaSA9PT0gYUFyci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKFwiVW50ZXJtaW5hdGVkIHF1b3RlZCBzdHJpbmdcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNraXBVbnRpbCA9IGkgKyAxO1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlcyA9IGFBcnIuc2xpY2UoaW5kZXgsIGkgKyAxKS5qb2luKFwiIFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcztcclxuICAgIH0pLmZpbHRlcihmdW5jdGlvbiAocykge1xyXG4gICAgICAgIHJldHVybiBzICE9PSB1bmRlZmluZWQ7XHJcbiAgICB9KS5tYXAoZnVuY3Rpb24gKHMpIHtcclxuICAgICAgICByZXR1cm4gdHJpbVF1b3RlZFNwYWNlZChzKTtcclxuICAgIH0pXHJcbiAgICByZXR1cm4gYUFycjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzUXVvdGVkKHNTdHJpbmcpIHtcclxuICAgIHJldHVybiAhIS9eXCIuKlwiJC8uZXhlYyhzU3RyaW5nKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNvdW50U3BhY2VzKHNTdHJpbmc6IHN0cmluZykge1xyXG4gICAgdmFyIHIgPSAwO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzU3RyaW5nLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgaWYgKHNTdHJpbmcuY2hhckF0KGkpID09PSAnICcpIHtcclxuICAgICAgICAgICAgciA9IHIgKyAxO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByO1xyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqQHBhcmFtIHtzdHJpbmd9IHNTdHJpbmcgLCBlLmcuIFwiYSBiIGNcIlxyXG4gKkByZXR1cm4ge0FycmF5PEFycmF5PFN0cmluZz4+fSBicm9rZW4gZG93biBhcnJheSwgZS5nLlxyXG4gKltbXCJhIGIgY1wiXSwgW1wiYVwiLCBcImIgY1wiXSwgW1wiYSBiXCIsIFwiY1wiXSwgLi4uLltcImFcIiwgXCJiXCIsIFwiY1wiXV1cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBicmVha2Rvd25TdHJpbmcoc1N0cmluZzogc3RyaW5nLCBzcGFjZXNMaW1pdD86IG51bWJlcik6IEFycmF5PEFycmF5PFN0cmluZz4+IHtcclxuICAgIHZhciByU3RyaW5nID0gY2xlYW5zZVN0cmluZyhzU3RyaW5nKTtcclxuICAgIGlmIChzcGFjZXNMaW1pdCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgc3BhY2VzTGltaXQgPSAtMTtcclxuICAgIH1cclxuICAgIHZhciB1ID0gclN0cmluZy5zcGxpdChcIiBcIik7XHJcbiAgICB1ID0gcmVjb21iaW5lUXVvdGVkKHUpO1xyXG4gICAgdmFyIGsgPSAwO1xyXG4gICAgaWYgKHUubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIFtbXV07XHJcbiAgICB9XHJcbiAgICB2YXIgdyA9IFtbdVswXV1dO1xyXG4gICAgd2hpbGUgKGsgPCB1Lmxlbmd0aCAtIDEpIHtcclxuICAgICAgICBrID0gayArIDE7XHJcbiAgICAgICAgdmFyIHIxID0gdy5tYXAoZnVuY3Rpb24gKGVudHJ5KSB7XHJcbiAgICAgICAgICAgIGRlYnVnbG9nKEpTT04uc3RyaW5naWZ5KGVudHJ5KSk7XHJcbiAgICAgICAgICAgIHZhciBlbnRyeSA9IGVudHJ5LnNsaWNlKDApO1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShlbnRyeSkpO1xyXG4gICAgICAgICAgICB2YXIgcHJldmVudHJ5ID0gZW50cnlbZW50cnkubGVuZ3RoIC0xXTtcclxuICAgICAgICAgICAgLy8gZG8gbm90IGNvbWJpbmUgcXVvdGVkIHN0cmluZ3MhXHJcbiAgICAgICAgICAgIGlmIChwcmV2ZW50cnkgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIC8qIGRvIG5vdGhpbmcgKi8gLy9yZXR1cm4gZW50cnk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNRdW90ZWQodVtrXSkgfHwgaXNRdW90ZWQocHJldmVudHJ5KSkge1xyXG4gICAgICAgICAgICAgICAgZW50cnlbZW50cnkubGVuZ3RoIC0gMV0gPSBudWxsO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkID0gcHJldmVudHJ5ICsgXCIgXCIgKyB1W2tdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNwYWNlc0xpbWl0ID4gMCAmJiBjb3VudFNwYWNlcyhjb21iaW5lZCkgPiBzcGFjZXNMaW1pdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbWJpbmVkID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVudHJ5W2VudHJ5Lmxlbmd0aCAtIDFdID0gY29tYmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGVudHJ5O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHZhciByMiA9IHcubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIjIgPlwiICsgSlNPTi5zdHJpbmdpZnkoZW50cnkpKTtcclxuICAgICAgICAgICAgdmFyIGVudHJ5ID0gZW50cnkuc2xpY2UoMCk7XHJcbiAgICAgICAgICAgIGVudHJ5LnB1c2godVtrXSk7XHJcbiAgICAgICAgICAgIHJldHVybiBlbnRyeVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGRlYnVnbG9nKEpTT04uc3RyaW5naWZ5KHIxKSk7XHJcbiAgICAgICAgZGVidWdsb2coSlNPTi5zdHJpbmdpZnkocjIpKTtcclxuICAgICAgICB3ID0gcjEuY29uY2F0KHIyKTtcclxuICAgIH1cclxuICAgIHcgPSB3LmZpbHRlcihmdW5jdGlvbihvTWFwKSB7XHJcbiAgICAgICAgcmV0dXJuIG9NYXAuZXZlcnkoZnVuY3Rpb24oc1dvcmQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHNXb3JkICE9PSBudWxsO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdy5tYXAoZnVuY3Rpb24gKG9NYXApIHtcclxuICAgICAgICByZXR1cm4gb01hcC5tYXAoZnVuY3Rpb24gKHNXb3JkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cmltUXVvdGVkKHNXb3JkKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi9pZm1hdGNoJ1xyXG5cclxuIiwiLyoqXG4gKiBAZmlsZVxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQuYnJlYWtkb3duXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdkaXNwYXRjaGVyJyk7XG5mdW5jdGlvbiBjbGVhbnNlU3RyaW5nKHNTdHJpbmcpIHtcbiAgICB2YXIgbGVuID0gMDtcbiAgICB3aGlsZSAobGVuICE9PSBzU3RyaW5nLmxlbmd0aCkge1xuICAgICAgICBsZW4gPSBzU3RyaW5nLmxlbmd0aDtcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXFxzXFxzKy9nLCAnICcpO1xuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9cXHNcXHMrL2csICcgJyk7XG4gICAgICAgIHNTdHJpbmcgPSBzU3RyaW5nLnJlcGxhY2UoL15cXHMrLywgJycpO1xuICAgICAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9cXHMrJC8sICcnKTtcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXlssOy5dKy8sICcnKTtcbiAgICAgICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvWyw7Ll0rJC8sICcnKTtcbiAgICB9XG4gICAgcmV0dXJuIHNTdHJpbmc7XG59XG5leHBvcnRzLmNsZWFuc2VTdHJpbmcgPSBjbGVhbnNlU3RyaW5nO1xudmFyIHJlZ2V4cFJlbW92ZURvdWJsZSA9IG5ldyBSZWdFeHAoL15cXFwiKFxcXCIuKlxcXCIpXFxcIiQvKTtcbnZhciBzdHJpcHRhaWwgPSBuZXcgUmVnRXhwKC9eXFxcIihbXlxcXCJdKylcIiQvKTtcbmZ1bmN0aW9uIHRyaW1RdW90ZWQoc1N0cmluZykge1xuICAgIHZhciBza2lwVW50aWwgPSAwO1xuICAgIHZhciBzdHJpcHBlZCA9IHNTdHJpbmc7XG4gICAgdmFyIG0gPSByZWdleHBSZW1vdmVEb3VibGUuZXhlYyhzU3RyaW5nKTtcbiAgICB3aGlsZSAobSkge1xuICAgICAgICBzdHJpcHBlZCA9IG1bMV07XG4gICAgICAgIG0gPSByZWdleHBSZW1vdmVEb3VibGUuZXhlYyhzdHJpcHBlZCk7XG4gICAgfVxuICAgIGRlYnVnbG9nKFwic3RyaXBwZWQgXCIgKyBzdHJpcHBlZCk7XG4gICAgbSA9IHN0cmlwdGFpbC5leGVjKHN0cmlwcGVkKTtcbiAgICBpZiAobSkge1xuICAgICAgICByZXR1cm4gbVsxXTtcbiAgICB9XG4gICAgcmV0dXJuIGNsZWFuc2VTdHJpbmcoc1N0cmluZyk7XG59XG5leHBvcnRzLnRyaW1RdW90ZWQgPSB0cmltUXVvdGVkO1xuZnVuY3Rpb24gdHJpbVF1b3RlZFNwYWNlZChzU3RyaW5nKSB7XG4gICAgdmFyIHNraXBVbnRpbCA9IDA7XG4gICAgc1N0cmluZyA9IHNTdHJpbmcucmVwbGFjZSgvXlwiXFxzKy9nLCAnXCInKTtcbiAgICBzU3RyaW5nID0gc1N0cmluZy5yZXBsYWNlKC9cXHMrXFxcIiQvZywgJ1wiJyk7XG4gICAgcmV0dXJuIHNTdHJpbmc7XG59XG5leHBvcnRzLnRyaW1RdW90ZWRTcGFjZWQgPSB0cmltUXVvdGVkU3BhY2VkO1xuZnVuY3Rpb24gcmVjb21iaW5lUXVvdGVkKGFBcnIpIHtcbiAgICB2YXIgc2tpcFVudGlsID0gMDtcbiAgICBhQXJyID0gYUFyci5tYXAoZnVuY3Rpb24gKHMsIGluZGV4KSB7XG4gICAgICAgIGlmIChpbmRleCA8IHNraXBVbnRpbCkge1xuICAgICAgICAgICAgZGVidWdsb2coXCJza2lwcGluZyA+XCIgKyBzICsgXCI8XCIpO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoL15cIi8uZXhlYyhzKSkge1xuICAgICAgICAgICAgdmFyIGkgPSBpbmRleDtcbiAgICAgICAgICAgIHdoaWxlIChpIDwgYUFyci5sZW5ndGggJiYgKCEvXCIkLy5leGVjKGFBcnJbaV0pIHx8IChpbmRleCA9PT0gaSAmJiBzID09PSAnXCInKSkpIHtcbiAgICAgICAgICAgICAgICBpID0gaSArIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaSA9PT0gYUFyci5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIlVudGVybWluYXRlZCBxdW90ZWQgc3RyaW5nXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgc2tpcFVudGlsID0gaSArIDE7XG4gICAgICAgICAgICAgICAgdmFyIHJlcyA9IGFBcnIuc2xpY2UoaW5kZXgsIGkgKyAxKS5qb2luKFwiIFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHM7XG4gICAgfSkuZmlsdGVyKGZ1bmN0aW9uIChzKSB7XG4gICAgICAgIHJldHVybiBzICE9PSB1bmRlZmluZWQ7XG4gICAgfSkubWFwKGZ1bmN0aW9uIChzKSB7XG4gICAgICAgIHJldHVybiB0cmltUXVvdGVkU3BhY2VkKHMpO1xuICAgIH0pO1xuICAgIHJldHVybiBhQXJyO1xufVxuZXhwb3J0cy5yZWNvbWJpbmVRdW90ZWQgPSByZWNvbWJpbmVRdW90ZWQ7XG5mdW5jdGlvbiBpc1F1b3RlZChzU3RyaW5nKSB7XG4gICAgcmV0dXJuICEhL15cIi4qXCIkLy5leGVjKHNTdHJpbmcpO1xufVxuZXhwb3J0cy5pc1F1b3RlZCA9IGlzUXVvdGVkO1xuZnVuY3Rpb24gY291bnRTcGFjZXMoc1N0cmluZykge1xuICAgIHZhciByID0gMDtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNTdHJpbmcubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgaWYgKHNTdHJpbmcuY2hhckF0KGkpID09PSAnICcpIHtcbiAgICAgICAgICAgIHIgPSByICsgMTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcjtcbn1cbmV4cG9ydHMuY291bnRTcGFjZXMgPSBjb3VudFNwYWNlcztcbi8qKlxuICpAcGFyYW0ge3N0cmluZ30gc1N0cmluZyAsIGUuZy4gXCJhIGIgY1wiXG4gKkByZXR1cm4ge0FycmF5PEFycmF5PFN0cmluZz4+fSBicm9rZW4gZG93biBhcnJheSwgZS5nLlxuICpbW1wiYSBiIGNcIl0sIFtcImFcIiwgXCJiIGNcIl0sIFtcImEgYlwiLCBcImNcIl0sIC4uLi5bXCJhXCIsIFwiYlwiLCBcImNcIl1dXG4gKi9cbmZ1bmN0aW9uIGJyZWFrZG93blN0cmluZyhzU3RyaW5nLCBzcGFjZXNMaW1pdCkge1xuICAgIHZhciByU3RyaW5nID0gY2xlYW5zZVN0cmluZyhzU3RyaW5nKTtcbiAgICBpZiAoc3BhY2VzTGltaXQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBzcGFjZXNMaW1pdCA9IC0xO1xuICAgIH1cbiAgICB2YXIgdSA9IHJTdHJpbmcuc3BsaXQoXCIgXCIpO1xuICAgIHUgPSByZWNvbWJpbmVRdW90ZWQodSk7XG4gICAgdmFyIGsgPSAwO1xuICAgIGlmICh1Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW1tdXTtcbiAgICB9XG4gICAgdmFyIHcgPSBbW3VbMF1dXTtcbiAgICB3aGlsZSAoayA8IHUubGVuZ3RoIC0gMSkge1xuICAgICAgICBrID0gayArIDE7XG4gICAgICAgIHZhciByMSA9IHcubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xuICAgICAgICAgICAgZGVidWdsb2coSlNPTi5zdHJpbmdpZnkoZW50cnkpKTtcbiAgICAgICAgICAgIHZhciBlbnRyeSA9IGVudHJ5LnNsaWNlKDApO1xuICAgICAgICAgICAgZGVidWdsb2coSlNPTi5zdHJpbmdpZnkoZW50cnkpKTtcbiAgICAgICAgICAgIHZhciBwcmV2ZW50cnkgPSBlbnRyeVtlbnRyeS5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgIC8vIGRvIG5vdCBjb21iaW5lIHF1b3RlZCBzdHJpbmdzIVxuICAgICAgICAgICAgaWYgKHByZXZlbnRyeSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoaXNRdW90ZWQodVtrXSkgfHwgaXNRdW90ZWQocHJldmVudHJ5KSkge1xuICAgICAgICAgICAgICAgIGVudHJ5W2VudHJ5Lmxlbmd0aCAtIDFdID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBjb21iaW5lZCA9IHByZXZlbnRyeSArIFwiIFwiICsgdVtrXTtcbiAgICAgICAgICAgICAgICBpZiAoc3BhY2VzTGltaXQgPiAwICYmIGNvdW50U3BhY2VzKGNvbWJpbmVkKSA+IHNwYWNlc0xpbWl0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbWJpbmVkID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZW50cnlbZW50cnkubGVuZ3RoIC0gMV0gPSBjb21iaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBlbnRyeTtcbiAgICAgICAgfSk7XG4gICAgICAgIHZhciByMiA9IHcubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xuICAgICAgICAgICAgZGVidWdsb2coXCIyID5cIiArIEpTT04uc3RyaW5naWZ5KGVudHJ5KSk7XG4gICAgICAgICAgICB2YXIgZW50cnkgPSBlbnRyeS5zbGljZSgwKTtcbiAgICAgICAgICAgIGVudHJ5LnB1c2godVtrXSk7XG4gICAgICAgICAgICByZXR1cm4gZW50cnk7XG4gICAgICAgIH0pO1xuICAgICAgICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShyMSkpO1xuICAgICAgICBkZWJ1Z2xvZyhKU09OLnN0cmluZ2lmeShyMikpO1xuICAgICAgICB3ID0gcjEuY29uY2F0KHIyKTtcbiAgICB9XG4gICAgdyA9IHcuZmlsdGVyKGZ1bmN0aW9uIChvTWFwKSB7XG4gICAgICAgIHJldHVybiBvTWFwLmV2ZXJ5KGZ1bmN0aW9uIChzV29yZCkge1xuICAgICAgICAgICAgcmV0dXJuIHNXb3JkICE9PSBudWxsO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gdy5tYXAoZnVuY3Rpb24gKG9NYXApIHtcbiAgICAgICAgcmV0dXJuIG9NYXAubWFwKGZ1bmN0aW9uIChzV29yZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRyaW1RdW90ZWQoc1dvcmQpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuYnJlYWtkb3duU3RyaW5nID0gYnJlYWtkb3duU3RyaW5nO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
