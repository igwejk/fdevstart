/**
 * @file toolmatch
 * @module jfseb.fdevstart.toolmatch
 * @copyright (c) Gerd Forstmann
 *
 * Methods operating on a matched tool,
 *
 * This will unify matching required and optional category words
 * with the requirements of the tool.
 *
 */
"use strict";
// / <reference path="../../lib/node-4.d.ts" />

var debug = require("debug");
var debuglog = debug('toolmatch');
/*
var oToolFLP = {
  'name': 'FLP',
  'requires': { 'systemId': {}, 'client': {} },
  "optional": {
    "fiori intent": {}
  },
  "sets": {
    "intent": {
      "set": [
        "systemId",
        "client",
        "fiori intent"
      ],
      "response": "_urlpattern1"
    },
    "none": {
      "set": [
        "systemId",
        "client"
      ],
      "response": "_urlpattern2"
    }
  }
};
*/
var Sentence = require("./sentence");
function cmpToolSet(sets, a, b) {
    return -(sets[a].set.length - sets[b].set.length);
}
/**
 * This onyl finds the best matching sets (=longest match)
 * independent of a record
 */
function findMatchingSets(a) {
    var matchingSets = Object.keys(a.tool.sets).filter(function (sSetKey) {
        var oSet = a.tool.sets[sSetKey];
        debuglog('here the set for tool ' + a.tool.name + " " + JSON.stringify(oSet));
        return oSet.set.every(function (category) {
            var word = Sentence.findWordByCategory(a.sentence, category);
            var b = !!(word && word.word !== undefined);
            debuglog("searchign for category " + category + " " + b);
            return b;
        });
    });
    if (matchingSets.length === 0) {
        return []; // undefined;
    }
    var cmpThisToolSet = cmpToolSet.bind(undefined, a.tool.sets);
    matchingSets.sort(cmpThisToolSet);
    debuglog("best sets ordered " + matchingSets.join(","));
    matchingSets = matchingSets.filter(function (sKey) {
        if (!cmpThisToolSet(matchingSets[0], sKey)) {
            return true;
        }
        return false;
    });
    if (matchingSets.length > 1) {
        debuglog("More than one set matches: \"" + matchingSets.join('";"') + "for match:\n" + JSON.stringify(a, undefined, 2));
    }
    return matchingSets.sort();
}
exports.findMatchingSets = findMatchingSets;
function findBestMatchingSet(a) {
    var matchingSets = findMatchingSets(a);
    if (matchingSets && matchingSets.length) {
        return a.tool.sets[matchingSets[0]];
    }
    return undefined;
}
exports.findBestMatchingSet = findBestMatchingSet;
function isMatchingRecord(matchset, setcommand, record) {
    var res = Object.keys(matchset).every(function (category) {
        var value = matchset[category];
        if (value === record[category] || record[category] === '*') {
            return true;
        }
        return false;
    });
    if (!res) {
        return false;
    }
    if (!record[setcommand]) {
        // THROW?
        debuglog("Matching record lacks setcommand" + setcommand + " match:" + JSON.stringify(record) + " match " + JSON.stringify(matchset));
        return false;
    }
    return true;
}
exports.isMatchingRecord = isMatchingRecord;
function makeMatchSet(a, toolset) {
    var res = {};
    toolset.set.forEach(function (category) {
        res[category] = Sentence.findWordByCategory(a.sentence, category).word.matchedString;
    });
    Object.freeze(res);
    return res;
}
exports.makeMatchSet = makeMatchSet;
function findSetRecords(a, setIds, aRecords) {
    var res = [];
    setIds.forEach(function (setId) {
        var set = a.tool.sets[setId];
        var matchset = makeMatchSet(a, set);
        var filteredRecords = aRecords.filter(function (record) {
            return isMatchingRecord(matchset, set.response, record);
        });
        filteredRecords.forEach(function (record) {
            res.push({ setId: setId, record: record });
        });
    });
    // TODO SORT?
    return res;
}
exports.findSetRecords = findSetRecords;
function findFirstSetRecord(toolMatchResult, records) {
    var setIds = findMatchingSets(toolMatchResult);
    var res = findSetRecords(toolMatchResult, setIds, records);
    if (res) {
        return res[0];
    }
    return undefined;
}
exports.findFirstSetRecord = findFirstSetRecord;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC90b29sbWF0Y2gudHMiLCJtYXRjaC90b29sbWF0Y2guanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJTZW50ZW5jZSIsImNtcFRvb2xTZXQiLCJzZXRzIiwiYSIsImIiLCJzZXQiLCJsZW5ndGgiLCJmaW5kTWF0Y2hpbmdTZXRzIiwibWF0Y2hpbmdTZXRzIiwiT2JqZWN0Iiwia2V5cyIsInRvb2wiLCJmaWx0ZXIiLCJzU2V0S2V5Iiwib1NldCIsIm5hbWUiLCJKU09OIiwic3RyaW5naWZ5IiwiZXZlcnkiLCJjYXRlZ29yeSIsIndvcmQiLCJmaW5kV29yZEJ5Q2F0ZWdvcnkiLCJzZW50ZW5jZSIsInVuZGVmaW5lZCIsImNtcFRoaXNUb29sU2V0IiwiYmluZCIsInNvcnQiLCJqb2luIiwic0tleSIsImV4cG9ydHMiLCJmaW5kQmVzdE1hdGNoaW5nU2V0IiwiaXNNYXRjaGluZ1JlY29yZCIsIm1hdGNoc2V0Iiwic2V0Y29tbWFuZCIsInJlY29yZCIsInJlcyIsInZhbHVlIiwibWFrZU1hdGNoU2V0IiwidG9vbHNldCIsImZvckVhY2giLCJtYXRjaGVkU3RyaW5nIiwiZnJlZXplIiwiZmluZFNldFJlY29yZHMiLCJzZXRJZHMiLCJhUmVjb3JkcyIsInNldElkIiwiZmlsdGVyZWRSZWNvcmRzIiwicmVzcG9uc2UiLCJwdXNoIiwiZmluZEZpcnN0U2V0UmVjb3JkIiwidG9vbE1hdGNoUmVzdWx0IiwicmVjb3JkcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7O0FDV0E7QURDQTs7QUFFQSxJQUFBQSxRQUFBQyxRQUFBLE9BQUEsQ0FBQTtBQUVBLElBQU1DLFdBQVdGLE1BQU0sV0FBTixDQUFqQjtBQUVBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTJCQSxJQUFBRyxXQUFBRixRQUFBLFlBQUEsQ0FBQTtBQUVBLFNBQUFHLFVBQUEsQ0FBb0JDLElBQXBCLEVBQTZDQyxDQUE3QyxFQUF5REMsQ0FBekQs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U0FBU2hDLE1BQVQsQ0FBZ0IsVUFBU3NCLE1BQVQsRUFBZTtBQUNuRCxtQkFBT0gsaUJBQWlCQyxRQUFqQixFQUEyQjNCLElBQUkwQyxRQUEvQixFQUF5Q2IsTUFBekMsQ0FBUDtBQUNELFNBRnFCLENBQXRCO0FBR0FZLHdCQUFnQlAsT0FBaEIsQ0FBd0IsVUFBU0wsTUFBVCxFQUFlO0FBQ3JDQyxnQkFBSWEsSUFBSixDQUFTLEVBQUVILE9BQVFBLEtBQVYsRUFBaUJYLFFBQVFBLE1BQXpCLEVBQVQ7QUFDRCxTQUZEO0FBR0QsS0FURDtBQVVBO0FBQ0EsV0FBT0MsR0FBUDtBQUNEO0FBZEROLFFBQUFhLGNBQUEsR0FBQUEsY0FBQTtBQWdCQSxTQUFBTyxrQkFBQSxDQUFtQ0MsZUFBbkMsRUFBdUVDLE9BQXZFLEVBQWdHO0FBQzlGLFFBQUlSLFNBQVNwQyxpQkFBaUIyQyxlQUFqQixDQUFiO0FBQ0EsUUFBSWYsTUFBTU8sZUFBZVEsZUFBZixFQUFnQ1AsTUFBaEMsRUFBd0NRLE9BQXhDLENBQVY7QUFDQSxRQUFJaEIsR0FBSixFQUFTO0FBQ1AsZUFBT0EsSUFBSSxDQUFKLENBQVA7QUFDRDtBQUNELFdBQU9aLFNBQVA7QUFDRDtBQVBETSxRQUFBb0Isa0JBQUEsR0FBQUEsa0JBQUEiLCJmaWxlIjoibWF0Y2gvdG9vbG1hdGNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEBmaWxlIHRvb2xtYXRjaFxyXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC50b29sbWF0Y2hcclxuICogQGNvcHlyaWdodCAoYykgR2VyZCBGb3JzdG1hbm5cclxuICpcclxuICogTWV0aG9kcyBvcGVyYXRpbmcgb24gYSBtYXRjaGVkIHRvb2wsXHJcbiAqXHJcbiAqIFRoaXMgd2lsbCB1bmlmeSBtYXRjaGluZyByZXF1aXJlZCBhbmQgb3B0aW9uYWwgY2F0ZWdvcnkgd29yZHNcclxuICogd2l0aCB0aGUgcmVxdWlyZW1lbnRzIG9mIHRoZSB0b29sLlxyXG4gKlxyXG4gKi9cclxuXHJcbi8vIC8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vbGliL25vZGUtNC5kLnRzXCIgLz5cclxuXHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcclxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XHJcbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ3Rvb2xtYXRjaCcpO1xyXG5cclxuLypcclxudmFyIG9Ub29sRkxQID0ge1xyXG4gICduYW1lJzogJ0ZMUCcsXHJcbiAgJ3JlcXVpcmVzJzogeyAnc3lzdGVtSWQnOiB7fSwgJ2NsaWVudCc6IHt9IH0sXHJcbiAgXCJvcHRpb25hbFwiOiB7XHJcbiAgICBcImZpb3JpIGludGVudFwiOiB7fVxyXG4gIH0sXHJcbiAgXCJzZXRzXCI6IHtcclxuICAgIFwiaW50ZW50XCI6IHtcclxuICAgICAgXCJzZXRcIjogW1xyXG4gICAgICAgIFwic3lzdGVtSWRcIixcclxuICAgICAgICBcImNsaWVudFwiLFxyXG4gICAgICAgIFwiZmlvcmkgaW50ZW50XCJcclxuICAgICAgXSxcclxuICAgICAgXCJyZXNwb25zZVwiOiBcIl91cmxwYXR0ZXJuMVwiXHJcbiAgICB9LFxyXG4gICAgXCJub25lXCI6IHtcclxuICAgICAgXCJzZXRcIjogW1xyXG4gICAgICAgIFwic3lzdGVtSWRcIixcclxuICAgICAgICBcImNsaWVudFwiXHJcbiAgICAgIF0sXHJcbiAgICAgIFwicmVzcG9uc2VcIjogXCJfdXJscGF0dGVybjJcIlxyXG4gICAgfVxyXG4gIH1cclxufTtcclxuKi9cclxuXHJcbmltcG9ydCAqIGFzIFNlbnRlbmNlIGZyb20gJy4vc2VudGVuY2UnO1xyXG5cclxuZnVuY3Rpb24gY21wVG9vbFNldChzZXRzIDogSU1hdGNoLklUb29sU2V0cywgYSA6IHN0cmluZywgYjpzdHJpbmcpIHtcclxuICByZXR1cm4gLShzZXRzW2FdLnNldC5sZW5ndGggLSBzZXRzW2JdLnNldC5sZW5ndGgpO1xyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIFRoaXMgb255bCBmaW5kcyB0aGUgYmVzdCBtYXRjaGluZyBzZXRzICg9bG9uZ2VzdCBtYXRjaClcclxuICogaW5kZXBlbmRlbnQgb2YgYSByZWNvcmRcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kTWF0Y2hpbmdTZXRzKGEgOiBJTWF0Y2guSVRvb2xNYXRjaCApIDogc3RyaW5nW10ge1xyXG4gIHZhciBtYXRjaGluZ1NldHMgPSBPYmplY3Qua2V5cyhhLnRvb2wuc2V0cykuZmlsdGVyKGZ1bmN0aW9uKHNTZXRLZXkpIHtcclxuICAgIHZhciBvU2V0ID0gYS50b29sLnNldHNbc1NldEtleV07XHJcbiAgICBkZWJ1Z2xvZygnaGVyZSB0aGUgc2V0IGZvciB0b29sICcgKyBhLnRvb2wubmFtZSArIFwiIFwiICsgSlNPTi5zdHJpbmdpZnkob1NldCkpO1xyXG4gICAgcmV0dXJuIG9TZXQuc2V0LmV2ZXJ5KGZ1bmN0aW9uKGNhdGVnb3J5IDogc3RyaW5nKSA6Ym9vbGVhbiB7XHJcbiAgICAgIHZhciB3b3JkID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KTtcclxuICAgICAgdmFyIGIgPSAhISh3b3JkICYmICh3b3JkLndvcmQgIT09IHVuZGVmaW5lZCkpO1xyXG4gICAgICBkZWJ1Z2xvZyhcInNlYXJjaGlnbiBmb3IgY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIFwiICsgYik7XHJcbiAgICAgIHJldHVybiBiO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbiAgaWYobWF0Y2hpbmdTZXRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgcmV0dXJuIFtdOyAvLyB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIHZhciBjbXBUaGlzVG9vbFNldCA9IGNtcFRvb2xTZXQuYmluZCh1bmRlZmluZWQsIGEudG9vbC5zZXRzKTtcclxuICBtYXRjaGluZ1NldHMuc29ydChjbXBUaGlzVG9vbFNldCk7XHJcbiAgZGVidWdsb2coXCJiZXN0IHNldHMgb3JkZXJlZCBcIiArIG1hdGNoaW5nU2V0cy5qb2luKFwiLFwiKSk7XHJcbiAgbWF0Y2hpbmdTZXRzID0gbWF0Y2hpbmdTZXRzLmZpbHRlcihmdW5jdGlvbihzS2V5KSB7XHJcbiAgICBpZighY21wVGhpc1Rvb2xTZXQobWF0Y2hpbmdTZXRzWzBdLHNLZXkpKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIGlmIChtYXRjaGluZ1NldHMubGVuZ3RoID4gMSkge1xyXG4gICAgZGVidWdsb2coXCJNb3JlIHRoYW4gb25lIHNldCBtYXRjaGVzOiBcXFwiXCIgKyBtYXRjaGluZ1NldHMuam9pbignXCI7XCInKSArIFwiZm9yIG1hdGNoOlxcblwiICsgSlNPTi5zdHJpbmdpZnkoYSwgdW5kZWZpbmVkLDIpKVxyXG4gIH1cclxuICByZXR1cm4gbWF0Y2hpbmdTZXRzLnNvcnQoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRCZXN0TWF0Y2hpbmdTZXQoYSA6IElNYXRjaC5JVG9vbE1hdGNoKSA6IElNYXRjaC5JVG9vbFNldCB7XHJcbiAgdmFyIG1hdGNoaW5nU2V0cyA9IGZpbmRNYXRjaGluZ1NldHMoYSk7XHJcbiAgaWYobWF0Y2hpbmdTZXRzICYmIG1hdGNoaW5nU2V0cy5sZW5ndGgpIHtcclxuICAgIHJldHVybiBhLnRvb2wuc2V0c1ttYXRjaGluZ1NldHNbMF1dO1xyXG4gIH1cclxuICByZXR1cm4gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTWF0Y2hpbmdSZWNvcmQoIG1hdGNoc2V0IDogSU1hdGNoLklNYXRjaFNldCwgc2V0Y29tbWFuZCA6IHN0cmluZywgcmVjb3JkIDogSU1hdGNoLklSZWNvcmQpIHtcclxuXHJcbiAgdmFyIHJlcyA9IE9iamVjdC5rZXlzKG1hdGNoc2V0KS5ldmVyeShmdW5jdGlvbihjYXRlZ29yeSkge1xyXG4gICAgdmFyIHZhbHVlID0gbWF0Y2hzZXRbY2F0ZWdvcnldO1xyXG4gICAgaWYgKCh2YWx1ZSA9PT0gcmVjb3JkW2NhdGVnb3J5XSkgfHwgIChyZWNvcmRbY2F0ZWdvcnldID09PSAnKicpKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIGlmKCFyZXMpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbiAgaWYoIXJlY29yZFtzZXRjb21tYW5kXSkge1xyXG4gICAgLy8gVEhST1c/XHJcbiAgICBkZWJ1Z2xvZyhcIk1hdGNoaW5nIHJlY29yZCBsYWNrcyBzZXRjb21tYW5kXCIgKyBzZXRjb21tYW5kICsgXCIgbWF0Y2g6XCIgKyBKU09OLnN0cmluZ2lmeShyZWNvcmQpICsgXCIgbWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaHNldCkgKVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gfVxyXG4gIHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZU1hdGNoU2V0KGEgOiBJTWF0Y2guSVRvb2xNYXRjaCwgdG9vbHNldCA6IElNYXRjaC5JVG9vbFNldCkgOiBJTWF0Y2guSU1hdGNoU2V0IHtcclxuICB2YXIgcmVzID0ge30gYXMgSU1hdGNoLklNYXRjaFNldDtcclxuICB0b29sc2V0LnNldC5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICByZXNbY2F0ZWdvcnldID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KS53b3JkLm1hdGNoZWRTdHJpbmc7XHJcbiAgfSk7XHJcbiAgT2JqZWN0LmZyZWV6ZShyZXMpO1xyXG4gIHJldHVybiByZXM7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZFNldFJlY29yZHMoYSA6IElNYXRjaC5JVG9vbE1hdGNoLCBzZXRJZHMgOiBzdHJpbmdbXSwgYVJlY29yZHMgOiBJTWF0Y2guSVJlY29yZFtdKSA6IElNYXRjaC5JTWF0Y2hlZFNldFJlY29yZHMge1xyXG4gIHZhciByZXMgPSBbXSBhcyBJTWF0Y2guSU1hdGNoZWRTZXRSZWNvcmRbXTtcclxuICBzZXRJZHMuZm9yRWFjaChmdW5jdGlvbihzZXRJZCkge1xyXG4gICAgdmFyIHNldCA9IGEudG9vbC5zZXRzW3NldElkXTtcclxuICAgIHZhciBtYXRjaHNldCA9IG1ha2VNYXRjaFNldChhLCBzZXQpO1xyXG4gICAgdmFyIGZpbHRlcmVkUmVjb3JkcyA9IGFSZWNvcmRzLmZpbHRlcihmdW5jdGlvbihyZWNvcmQpIHtcclxuICAgICAgcmV0dXJuIGlzTWF0Y2hpbmdSZWNvcmQobWF0Y2hzZXQsIHNldC5yZXNwb25zZSwgcmVjb3JkKTtcclxuICAgIH0pXHJcbiAgICBmaWx0ZXJlZFJlY29yZHMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpIHtcclxuICAgICAgcmVzLnB1c2goeyBzZXRJZCA6IHNldElkLCByZWNvcmQ6IHJlY29yZH0pO1xyXG4gICAgfSlcclxuICB9KVxyXG4gIC8vIFRPRE8gU09SVD9cclxuICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZEZpcnN0U2V0UmVjb3JkKHRvb2xNYXRjaFJlc3VsdDogSU1hdGNoLklUb29sTWF0Y2gsIHJlY29yZHM6IElNYXRjaC5JUmVjb3JkW10pIDogSU1hdGNoLklNYXRjaGVkU2V0UmVjb3JkIHtcclxuICB2YXIgc2V0SWRzID0gZmluZE1hdGNoaW5nU2V0cyh0b29sTWF0Y2hSZXN1bHQpO1xyXG4gIHZhciByZXMgPSBmaW5kU2V0UmVjb3Jkcyh0b29sTWF0Y2hSZXN1bHQsIHNldElkcywgcmVjb3Jkcyk7XHJcbiAgaWYgKHJlcykge1xyXG4gICAgcmV0dXJuIHJlc1swXTtcclxuICB9XHJcbiAgcmV0dXJuIHVuZGVmaW5lZDtcclxufVxyXG4iLCIvKipcbiAqIEBmaWxlIHRvb2xtYXRjaFxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQudG9vbG1hdGNoXG4gKiBAY29weXJpZ2h0IChjKSBHZXJkIEZvcnN0bWFublxuICpcbiAqIE1ldGhvZHMgb3BlcmF0aW5nIG9uIGEgbWF0Y2hlZCB0b29sLFxuICpcbiAqIFRoaXMgd2lsbCB1bmlmeSBtYXRjaGluZyByZXF1aXJlZCBhbmQgb3B0aW9uYWwgY2F0ZWdvcnkgd29yZHNcbiAqIHdpdGggdGhlIHJlcXVpcmVtZW50cyBvZiB0aGUgdG9vbC5cbiAqXG4gKi9cblwidXNlIHN0cmljdFwiO1xuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ3Rvb2xtYXRjaCcpO1xuLypcbnZhciBvVG9vbEZMUCA9IHtcbiAgJ25hbWUnOiAnRkxQJyxcbiAgJ3JlcXVpcmVzJzogeyAnc3lzdGVtSWQnOiB7fSwgJ2NsaWVudCc6IHt9IH0sXG4gIFwib3B0aW9uYWxcIjoge1xuICAgIFwiZmlvcmkgaW50ZW50XCI6IHt9XG4gIH0sXG4gIFwic2V0c1wiOiB7XG4gICAgXCJpbnRlbnRcIjoge1xuICAgICAgXCJzZXRcIjogW1xuICAgICAgICBcInN5c3RlbUlkXCIsXG4gICAgICAgIFwiY2xpZW50XCIsXG4gICAgICAgIFwiZmlvcmkgaW50ZW50XCJcbiAgICAgIF0sXG4gICAgICBcInJlc3BvbnNlXCI6IFwiX3VybHBhdHRlcm4xXCJcbiAgICB9LFxuICAgIFwibm9uZVwiOiB7XG4gICAgICBcInNldFwiOiBbXG4gICAgICAgIFwic3lzdGVtSWRcIixcbiAgICAgICAgXCJjbGllbnRcIlxuICAgICAgXSxcbiAgICAgIFwicmVzcG9uc2VcIjogXCJfdXJscGF0dGVybjJcIlxuICAgIH1cbiAgfVxufTtcbiovXG52YXIgU2VudGVuY2UgPSByZXF1aXJlKFwiLi9zZW50ZW5jZVwiKTtcbmZ1bmN0aW9uIGNtcFRvb2xTZXQoc2V0cywgYSwgYikge1xuICAgIHJldHVybiAtKHNldHNbYV0uc2V0Lmxlbmd0aCAtIHNldHNbYl0uc2V0Lmxlbmd0aCk7XG59XG4vKipcbiAqIFRoaXMgb255bCBmaW5kcyB0aGUgYmVzdCBtYXRjaGluZyBzZXRzICg9bG9uZ2VzdCBtYXRjaClcbiAqIGluZGVwZW5kZW50IG9mIGEgcmVjb3JkXG4gKi9cbmZ1bmN0aW9uIGZpbmRNYXRjaGluZ1NldHMoYSkge1xuICAgIHZhciBtYXRjaGluZ1NldHMgPSBPYmplY3Qua2V5cyhhLnRvb2wuc2V0cykuZmlsdGVyKGZ1bmN0aW9uIChzU2V0S2V5KSB7XG4gICAgICAgIHZhciBvU2V0ID0gYS50b29sLnNldHNbc1NldEtleV07XG4gICAgICAgIGRlYnVnbG9nKCdoZXJlIHRoZSBzZXQgZm9yIHRvb2wgJyArIGEudG9vbC5uYW1lICsgXCIgXCIgKyBKU09OLnN0cmluZ2lmeShvU2V0KSk7XG4gICAgICAgIHJldHVybiBvU2V0LnNldC5ldmVyeShmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgIHZhciB3b3JkID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KTtcbiAgICAgICAgICAgIHZhciBiID0gISEod29yZCAmJiAod29yZC53b3JkICE9PSB1bmRlZmluZWQpKTtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwic2VhcmNoaWduIGZvciBjYXRlZ29yeSBcIiArIGNhdGVnb3J5ICsgXCIgXCIgKyBiKTtcbiAgICAgICAgICAgIHJldHVybiBiO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICBpZiAobWF0Y2hpbmdTZXRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW107IC8vIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgdmFyIGNtcFRoaXNUb29sU2V0ID0gY21wVG9vbFNldC5iaW5kKHVuZGVmaW5lZCwgYS50b29sLnNldHMpO1xuICAgIG1hdGNoaW5nU2V0cy5zb3J0KGNtcFRoaXNUb29sU2V0KTtcbiAgICBkZWJ1Z2xvZyhcImJlc3Qgc2V0cyBvcmRlcmVkIFwiICsgbWF0Y2hpbmdTZXRzLmpvaW4oXCIsXCIpKTtcbiAgICBtYXRjaGluZ1NldHMgPSBtYXRjaGluZ1NldHMuZmlsdGVyKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgICAgIGlmICghY21wVGhpc1Rvb2xTZXQobWF0Y2hpbmdTZXRzWzBdLCBzS2V5KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pO1xuICAgIGlmIChtYXRjaGluZ1NldHMubGVuZ3RoID4gMSkge1xuICAgICAgICBkZWJ1Z2xvZyhcIk1vcmUgdGhhbiBvbmUgc2V0IG1hdGNoZXM6IFxcXCJcIiArIG1hdGNoaW5nU2V0cy5qb2luKCdcIjtcIicpICsgXCJmb3IgbWF0Y2g6XFxuXCIgKyBKU09OLnN0cmluZ2lmeShhLCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG4gICAgcmV0dXJuIG1hdGNoaW5nU2V0cy5zb3J0KCk7XG59XG5leHBvcnRzLmZpbmRNYXRjaGluZ1NldHMgPSBmaW5kTWF0Y2hpbmdTZXRzO1xuZnVuY3Rpb24gZmluZEJlc3RNYXRjaGluZ1NldChhKSB7XG4gICAgdmFyIG1hdGNoaW5nU2V0cyA9IGZpbmRNYXRjaGluZ1NldHMoYSk7XG4gICAgaWYgKG1hdGNoaW5nU2V0cyAmJiBtYXRjaGluZ1NldHMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBhLnRvb2wuc2V0c1ttYXRjaGluZ1NldHNbMF1dO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5maW5kQmVzdE1hdGNoaW5nU2V0ID0gZmluZEJlc3RNYXRjaGluZ1NldDtcbmZ1bmN0aW9uIGlzTWF0Y2hpbmdSZWNvcmQobWF0Y2hzZXQsIHNldGNvbW1hbmQsIHJlY29yZCkge1xuICAgIHZhciByZXMgPSBPYmplY3Qua2V5cyhtYXRjaHNldCkuZXZlcnkoZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG4gICAgICAgIHZhciB2YWx1ZSA9IG1hdGNoc2V0W2NhdGVnb3J5XTtcbiAgICAgICAgaWYgKCh2YWx1ZSA9PT0gcmVjb3JkW2NhdGVnb3J5XSkgfHwgKHJlY29yZFtjYXRlZ29yeV0gPT09ICcqJykpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9KTtcbiAgICBpZiAoIXJlcykge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmICghcmVjb3JkW3NldGNvbW1hbmRdKSB7XG4gICAgICAgIC8vIFRIUk9XP1xuICAgICAgICBkZWJ1Z2xvZyhcIk1hdGNoaW5nIHJlY29yZCBsYWNrcyBzZXRjb21tYW5kXCIgKyBzZXRjb21tYW5kICsgXCIgbWF0Y2g6XCIgKyBKU09OLnN0cmluZ2lmeShyZWNvcmQpICsgXCIgbWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaHNldCkpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufVxuZXhwb3J0cy5pc01hdGNoaW5nUmVjb3JkID0gaXNNYXRjaGluZ1JlY29yZDtcbmZ1bmN0aW9uIG1ha2VNYXRjaFNldChhLCB0b29sc2V0KSB7XG4gICAgdmFyIHJlcyA9IHt9O1xuICAgIHRvb2xzZXQuc2V0LmZvckVhY2goZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG4gICAgICAgIHJlc1tjYXRlZ29yeV0gPSBTZW50ZW5jZS5maW5kV29yZEJ5Q2F0ZWdvcnkoYS5zZW50ZW5jZSwgY2F0ZWdvcnkpLndvcmQubWF0Y2hlZFN0cmluZztcbiAgICB9KTtcbiAgICBPYmplY3QuZnJlZXplKHJlcyk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMubWFrZU1hdGNoU2V0ID0gbWFrZU1hdGNoU2V0O1xuZnVuY3Rpb24gZmluZFNldFJlY29yZHMoYSwgc2V0SWRzLCBhUmVjb3Jkcykge1xuICAgIHZhciByZXMgPSBbXTtcbiAgICBzZXRJZHMuZm9yRWFjaChmdW5jdGlvbiAoc2V0SWQpIHtcbiAgICAgICAgdmFyIHNldCA9IGEudG9vbC5zZXRzW3NldElkXTtcbiAgICAgICAgdmFyIG1hdGNoc2V0ID0gbWFrZU1hdGNoU2V0KGEsIHNldCk7XG4gICAgICAgIHZhciBmaWx0ZXJlZFJlY29yZHMgPSBhUmVjb3Jkcy5maWx0ZXIoZnVuY3Rpb24gKHJlY29yZCkge1xuICAgICAgICAgICAgcmV0dXJuIGlzTWF0Y2hpbmdSZWNvcmQobWF0Y2hzZXQsIHNldC5yZXNwb25zZSwgcmVjb3JkKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGZpbHRlcmVkUmVjb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJlcy5wdXNoKHsgc2V0SWQ6IHNldElkLCByZWNvcmQ6IHJlY29yZCB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgLy8gVE9ETyBTT1JUP1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmZpbmRTZXRSZWNvcmRzID0gZmluZFNldFJlY29yZHM7XG5mdW5jdGlvbiBmaW5kRmlyc3RTZXRSZWNvcmQodG9vbE1hdGNoUmVzdWx0LCByZWNvcmRzKSB7XG4gICAgdmFyIHNldElkcyA9IGZpbmRNYXRjaGluZ1NldHModG9vbE1hdGNoUmVzdWx0KTtcbiAgICB2YXIgcmVzID0gZmluZFNldFJlY29yZHModG9vbE1hdGNoUmVzdWx0LCBzZXRJZHMsIHJlY29yZHMpO1xuICAgIGlmIChyZXMpIHtcbiAgICAgICAgcmV0dXJuIHJlc1swXTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cbmV4cG9ydHMuZmluZEZpcnN0U2V0UmVjb3JkID0gZmluZEZpcnN0U2V0UmVjb3JkO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
