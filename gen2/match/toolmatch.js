/**
 * @file toolmatch
 * @module jfseb.fdevstart.toolmatch
 * @copyright (c) Gerd Forstmann
 *
 * Methods operating on a matched tool,
 *
 * This will unify matching required and optional category words
 * with the requirements of the tool.
 *
 */
"use strict";
// / <reference path="../../lib/node-4.d.ts" />

var debug = require('debug');
var debuglog = debug('toolmatch');
/*
var oToolFLP = {
  'name': 'FLP',
  'requires': { 'systemId': {}, 'client': {} },
  "optional": {
    "fiori intent": {}
  },
  "sets": {
    "intent": {
      "set": [
        "systemId",
        "client",
        "fiori intent"
      ],
      "response": "_urlpattern1"
    },
    "none": {
      "set": [
        "systemId",
        "client"
      ],
      "response": "_urlpattern2"
    }
  }
};
*/
var Sentence = require('./sentence');
function cmpToolSet(sets, a, b) {
    return -(sets[a].set.length - sets[b].set.length);
}
/**
 * This onyl finds the best matching sets (=longest match)
 * independent of a record
 */
function findMatchingSets(a) {
    var matchingSets = Object.keys(a.tool.sets).filter(function (sSetKey) {
        var oSet = a.tool.sets[sSetKey];
        debuglog('here the set for tool ' + a.tool.name + " " + JSON.stringify(oSet));
        return oSet.set.every(function (category) {
            var word = Sentence.findWordByCategory(a.sentence, category);
            var b = !!(word && word.word !== undefined);
            debuglog("searchign for category " + category + " " + b);
            return b;
        });
    });
    if (matchingSets.length === 0) {
        return undefined;
    }
    var cmpThisToolSet = cmpToolSet.bind(undefined, a.tool.sets);
    matchingSets.sort(cmpThisToolSet);
    debuglog("best sets ordered " + matchingSets.join(","));
    matchingSets = matchingSets.filter(function (sKey) {
        if (!cmpThisToolSet(matchingSets[0], sKey)) {
            return true;
        }
        return false;
    });
    if (matchingSets.length > 1) {
        debuglog("More than one set matches: \"" + matchingSets.join('";"') + "for match:\n" + JSON.stringify(a, undefined, 2));
    }
    return matchingSets.sort();
}
exports.findMatchingSets = findMatchingSets;
function findBestMatchingSet(a) {
    var matchingSets = findMatchingSets(a);
    if (matchingSets && matchingSets.length) {
        return a.tool.sets[matchingSets[0]];
    }
    return undefined;
}
exports.findBestMatchingSet = findBestMatchingSet;
function isMatchingRecord(matchset, setcommand, record) {
    var res = Object.keys(matchset).every(function (category) {
        var value = matchset[category];
        if (value === record[category] || record[category] === '*') {
            return true;
        }
        return false;
    });
    if (!res) {
        return false;
    }
    if (!record[setcommand]) {
        // THROW?
        debuglog("Matching record lacks setcommand" + setcommand + " match:" + JSON.stringify(record) + " match " + JSON.stringify(matchset));
        return false;
    }
    return true;
}
exports.isMatchingRecord = isMatchingRecord;
function makeMatchSet(a, toolset) {
    var res = {};
    toolset.set.forEach(function (category) {
        res[category] = Sentence.findWordByCategory(a.sentence, category).word.matchedString;
    });
    Object.freeze(res);
    return res;
}
exports.makeMatchSet = makeMatchSet;
function findSetRecords(a, setIds, aRecords) {
    var res = [];
    setIds.forEach(function (setId) {
        var set = a.tool.sets[setId];
        var matchset = makeMatchSet(a, set);
        var filteredRecords = aRecords.filter(function (record) {
            return isMatchingRecord(matchset, set.response, record);
        });
        filteredRecords.forEach(function (record) {
            res.push({ setId: setId, record: record });
        });
    });
    // TODO SORT?
    return res;
}
exports.findSetRecords = findSetRecords;
function findFirstSetRecord(toolMatchResult, records) {
    var setIds = findMatchingSets(toolMatchResult);
    var res = findSetRecords(toolMatchResult, setIds, records);
    if (res) {
        return res[0];
    }
    return undefined;
}
exports.findFirstSetRecord = findFirstSetRecord;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC90b29sbWF0Y2gudHMiLCJtYXRjaC90b29sbWF0Y2guanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJTZW50ZW5jZSIsImNtcFRvb2xTZXQiLCJzZXRzIiwiYSIsImIiLCJzZXQiLCJsZW5ndGgiLCJmaW5kTWF0Y2hpbmdTZXRzIiwibWF0Y2hpbmdTZXRzIiwiT2JqZWN0Iiwia2V5cyIsInRvb2wiLCJmaWx0ZXIiLCJzU2V0S2V5Iiwib1NldCIsIm5hbWUiLCJKU09OIiwic3RyaW5naWZ5IiwiZXZlcnkiLCJjYXRlZ29yeSIsIndvcmQiLCJmaW5kV29yZEJ5Q2F0ZWdvcnkiLCJzZW50ZW5jZSIsInVuZGVmaW5lZCIsImNtcFRoaXNUb29sU2V0IiwiYmluZCIsInNvcnQiLCJqb2luIiwic0tleSIsImV4cG9ydHMiLCJmaW5kQmVzdE1hdGNoaW5nU2V0IiwiaXNNYXRjaGluZ1JlY29yZCIsIm1hdGNoc2V0Iiwic2V0Y29tbWFuZCIsInJlY29yZCIsInJlcyIsInZhbHVlIiwibWFrZU1hdGNoU2V0IiwidG9vbHNldCIsImZvckVhY2giLCJtYXRjaGVkU3RyaW5nIiwiZnJlZXplIiwiZmluZFNldFJlY29yZHMiLCJzZXRJZHMiLCJhUmVjb3JkcyIsInNldElkIiwiZmlsdGVyZWRSZWNvcmRzIiwicmVzcG9uc2UiLCJwdXNoIiwiZmluZEZpcnN0U2V0UmVjb3JkIiwidG9vbE1hdGNoUmVzdWx0IiwicmVjb3JkcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7O0FDV0E7QURDQTs7QUFFQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4sQ0FBakI7QUFFQSxJQUFNQyxXQUFXRixNQUFNLFdBQU4sQ0FBakI7QUFFQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUEyQkEsSUFBWUcsV0FBUUYsUUFBTSxZQUFOLENBQXBCO0FBRUEsU0FBQUcsVUFBQSxDQUFvQkMsSUFBcEIsRUFBNkNDLENBQTdDLEVBQXlEQyxDQUF6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LFNBQVNoQyxNQUFULENBQWdCLFVBQVNzQixNQUFULEVBQWU7QUFDbkQsbUJBQU9ILGlCQUFpQkMsUUFBakIsRUFBMkIzQixJQUFJMEMsUUFBL0IsRUFBeUNiLE1BQXpDLENBQVA7QUFDRCxTQUZxQixDQUF0QjtBQUdBWSx3QkFBZ0JQLE9BQWhCLENBQXdCLFVBQVNMLE1BQVQsRUFBZTtBQUNyQ0MsZ0JBQUlhLElBQUosQ0FBUyxFQUFFSCxPQUFRQSxLQUFWLEVBQWlCWCxRQUFRQSxNQUF6QixFQUFUO0FBQ0QsU0FGRDtBQUdELEtBVEQ7QUFVQTtBQUNBLFdBQU9DLEdBQVA7QUFDRDtBQWRlTixRQUFBYSxjQUFBLEdBQWNBLGNBQWQ7QUFnQmhCLFNBQUFPLGtCQUFBLENBQW1DQyxlQUFuQyxFQUF1RUMsT0FBdkUsRUFBZ0c7QUFDOUYsUUFBSVIsU0FBU3BDLGlCQUFpQjJDLGVBQWpCLENBQWI7QUFDQSxRQUFJZixNQUFNTyxlQUFlUSxlQUFmLEVBQWdDUCxNQUFoQyxFQUF3Q1EsT0FBeEMsQ0FBVjtBQUNBLFFBQUloQixHQUFKLEVBQVM7QUFDUCxlQUFPQSxJQUFJLENBQUosQ0FBUDtBQUNEO0FBQ0QsV0FBT1osU0FBUDtBQUNEO0FBUGVNLFFBQUFvQixrQkFBQSxHQUFrQkEsa0JBQWxCIiwiZmlsZSI6Im1hdGNoL3Rvb2xtYXRjaC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAZmlsZSB0b29sbWF0Y2hcclxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQudG9vbG1hdGNoXHJcbiAqIEBjb3B5cmlnaHQgKGMpIEdlcmQgRm9yc3RtYW5uXHJcbiAqXHJcbiAqIE1ldGhvZHMgb3BlcmF0aW5nIG9uIGEgbWF0Y2hlZCB0b29sLFxyXG4gKlxyXG4gKiBUaGlzIHdpbGwgdW5pZnkgbWF0Y2hpbmcgcmVxdWlyZWQgYW5kIG9wdGlvbmFsIGNhdGVnb3J5IHdvcmRzXHJcbiAqIHdpdGggdGhlIHJlcXVpcmVtZW50cyBvZiB0aGUgdG9vbC5cclxuICpcclxuICovXHJcblxyXG4vLyAvIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL2xpYi9ub2RlLTQuZC50c1wiIC8+XHJcblxyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuL2lmbWF0Y2gnO1xyXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2gnKTtcclxuXHJcbi8qXHJcbnZhciBvVG9vbEZMUCA9IHtcclxuICAnbmFtZSc6ICdGTFAnLFxyXG4gICdyZXF1aXJlcyc6IHsgJ3N5c3RlbUlkJzoge30sICdjbGllbnQnOiB7fSB9LFxyXG4gIFwib3B0aW9uYWxcIjoge1xyXG4gICAgXCJmaW9yaSBpbnRlbnRcIjoge31cclxuICB9LFxyXG4gIFwic2V0c1wiOiB7XHJcbiAgICBcImludGVudFwiOiB7XHJcbiAgICAgIFwic2V0XCI6IFtcclxuICAgICAgICBcInN5c3RlbUlkXCIsXHJcbiAgICAgICAgXCJjbGllbnRcIixcclxuICAgICAgICBcImZpb3JpIGludGVudFwiXHJcbiAgICAgIF0sXHJcbiAgICAgIFwicmVzcG9uc2VcIjogXCJfdXJscGF0dGVybjFcIlxyXG4gICAgfSxcclxuICAgIFwibm9uZVwiOiB7XHJcbiAgICAgIFwic2V0XCI6IFtcclxuICAgICAgICBcInN5c3RlbUlkXCIsXHJcbiAgICAgICAgXCJjbGllbnRcIlxyXG4gICAgICBdLFxyXG4gICAgICBcInJlc3BvbnNlXCI6IFwiX3VybHBhdHRlcm4yXCJcclxuICAgIH1cclxuICB9XHJcbn07XHJcbiovXHJcblxyXG5pbXBvcnQgKiBhcyBTZW50ZW5jZSBmcm9tICcuL3NlbnRlbmNlJztcclxuXHJcbmZ1bmN0aW9uIGNtcFRvb2xTZXQoc2V0cyA6IElNYXRjaC5JVG9vbFNldHMsIGEgOiBzdHJpbmcsIGI6c3RyaW5nKSB7XHJcbiAgcmV0dXJuIC0oc2V0c1thXS5zZXQubGVuZ3RoIC0gc2V0c1tiXS5zZXQubGVuZ3RoKTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiBUaGlzIG9ueWwgZmluZHMgdGhlIGJlc3QgbWF0Y2hpbmcgc2V0cyAoPWxvbmdlc3QgbWF0Y2gpXHJcbiAqIGluZGVwZW5kZW50IG9mIGEgcmVjb3JkXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZmluZE1hdGNoaW5nU2V0cyhhIDogSU1hdGNoLklUb29sTWF0Y2ggKSA6IHN0cmluZ1tdIHtcclxuICB2YXIgbWF0Y2hpbmdTZXRzID0gT2JqZWN0LmtleXMoYS50b29sLnNldHMpLmZpbHRlcihmdW5jdGlvbihzU2V0S2V5KSB7XHJcbiAgICB2YXIgb1NldCA9IGEudG9vbC5zZXRzW3NTZXRLZXldO1xyXG4gICAgZGVidWdsb2coJ2hlcmUgdGhlIHNldCBmb3IgdG9vbCAnICsgYS50b29sLm5hbWUgKyBcIiBcIiArIEpTT04uc3RyaW5naWZ5KG9TZXQpKTtcclxuICAgIHJldHVybiBvU2V0LnNldC5ldmVyeShmdW5jdGlvbihjYXRlZ29yeSA6IHN0cmluZykgOmJvb2xlYW4ge1xyXG4gICAgICB2YXIgd29yZCA9IFNlbnRlbmNlLmZpbmRXb3JkQnlDYXRlZ29yeShhLnNlbnRlbmNlLCBjYXRlZ29yeSk7XHJcbiAgICAgIHZhciBiID0gISEod29yZCAmJiAod29yZC53b3JkICE9PSB1bmRlZmluZWQpKTtcclxuICAgICAgZGVidWdsb2coXCJzZWFyY2hpZ24gZm9yIGNhdGVnb3J5IFwiICsgY2F0ZWdvcnkgKyBcIiBcIiArIGIpO1xyXG4gICAgICByZXR1cm4gYjtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG4gIGlmKG1hdGNoaW5nU2V0cy5sZW5ndGggPT09IDApIHtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIHZhciBjbXBUaGlzVG9vbFNldCA9IGNtcFRvb2xTZXQuYmluZCh1bmRlZmluZWQsIGEudG9vbC5zZXRzKTtcclxuICBtYXRjaGluZ1NldHMuc29ydChjbXBUaGlzVG9vbFNldCk7XHJcbiAgZGVidWdsb2coXCJiZXN0IHNldHMgb3JkZXJlZCBcIiArIG1hdGNoaW5nU2V0cy5qb2luKFwiLFwiKSk7XHJcbiAgbWF0Y2hpbmdTZXRzID0gbWF0Y2hpbmdTZXRzLmZpbHRlcihmdW5jdGlvbihzS2V5KSB7XHJcbiAgICBpZighY21wVGhpc1Rvb2xTZXQobWF0Y2hpbmdTZXRzWzBdLHNLZXkpKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIGlmIChtYXRjaGluZ1NldHMubGVuZ3RoID4gMSkge1xyXG4gICAgZGVidWdsb2coXCJNb3JlIHRoYW4gb25lIHNldCBtYXRjaGVzOiBcXFwiXCIgKyBtYXRjaGluZ1NldHMuam9pbignXCI7XCInKSArIFwiZm9yIG1hdGNoOlxcblwiICsgSlNPTi5zdHJpbmdpZnkoYSwgdW5kZWZpbmVkLDIpKVxyXG4gIH1cclxuICByZXR1cm4gbWF0Y2hpbmdTZXRzLnNvcnQoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRCZXN0TWF0Y2hpbmdTZXQoYSA6IElNYXRjaC5JVG9vbE1hdGNoKSA6IElNYXRjaC5JVG9vbFNldCB7XHJcbiAgdmFyIG1hdGNoaW5nU2V0cyA9IGZpbmRNYXRjaGluZ1NldHMoYSk7XHJcbiAgaWYobWF0Y2hpbmdTZXRzICYmIG1hdGNoaW5nU2V0cy5sZW5ndGgpIHtcclxuICAgIHJldHVybiBhLnRvb2wuc2V0c1ttYXRjaGluZ1NldHNbMF1dO1xyXG4gIH1cclxuICByZXR1cm4gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTWF0Y2hpbmdSZWNvcmQoIG1hdGNoc2V0IDogSU1hdGNoLklNYXRjaFNldCwgc2V0Y29tbWFuZCA6IHN0cmluZywgcmVjb3JkIDogSU1hdGNoLklSZWNvcmQpIHtcclxuXHJcbiAgdmFyIHJlcyA9IE9iamVjdC5rZXlzKG1hdGNoc2V0KS5ldmVyeShmdW5jdGlvbihjYXRlZ29yeSkge1xyXG4gICAgdmFyIHZhbHVlID0gbWF0Y2hzZXRbY2F0ZWdvcnldO1xyXG4gICAgaWYgKCh2YWx1ZSA9PT0gcmVjb3JkW2NhdGVnb3J5XSkgfHwgIChyZWNvcmRbY2F0ZWdvcnldID09PSAnKicpKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIGlmKCFyZXMpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbiAgaWYoIXJlY29yZFtzZXRjb21tYW5kXSkge1xyXG4gICAgLy8gVEhST1c/XHJcbiAgICBkZWJ1Z2xvZyhcIk1hdGNoaW5nIHJlY29yZCBsYWNrcyBzZXRjb21tYW5kXCIgKyBzZXRjb21tYW5kICsgXCIgbWF0Y2g6XCIgKyBKU09OLnN0cmluZ2lmeShyZWNvcmQpICsgXCIgbWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaHNldCkgKVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gfVxyXG4gIHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZU1hdGNoU2V0KGEgOiBJTWF0Y2guSVRvb2xNYXRjaCwgdG9vbHNldCA6IElNYXRjaC5JVG9vbFNldCkgOiBJTWF0Y2guSU1hdGNoU2V0IHtcclxuICB2YXIgcmVzID0ge30gYXMgSU1hdGNoLklNYXRjaFNldDtcclxuICB0b29sc2V0LnNldC5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICByZXNbY2F0ZWdvcnldID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KS53b3JkLm1hdGNoZWRTdHJpbmc7XHJcbiAgfSk7XHJcbiAgT2JqZWN0LmZyZWV6ZShyZXMpO1xyXG4gIHJldHVybiByZXM7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZFNldFJlY29yZHMoYSA6IElNYXRjaC5JVG9vbE1hdGNoLCBzZXRJZHMgOiBzdHJpbmdbXSwgYVJlY29yZHMgOiBJTWF0Y2guSVJlY29yZFtdKSA6IElNYXRjaC5JTWF0Y2hlZFNldFJlY29yZHMge1xyXG4gIHZhciByZXMgPSBbXSBhcyBJTWF0Y2guSU1hdGNoZWRTZXRSZWNvcmRbXTtcclxuICBzZXRJZHMuZm9yRWFjaChmdW5jdGlvbihzZXRJZCkge1xyXG4gICAgdmFyIHNldCA9IGEudG9vbC5zZXRzW3NldElkXTtcclxuICAgIHZhciBtYXRjaHNldCA9IG1ha2VNYXRjaFNldChhLCBzZXQpO1xyXG4gICAgdmFyIGZpbHRlcmVkUmVjb3JkcyA9IGFSZWNvcmRzLmZpbHRlcihmdW5jdGlvbihyZWNvcmQpIHtcclxuICAgICAgcmV0dXJuIGlzTWF0Y2hpbmdSZWNvcmQobWF0Y2hzZXQsIHNldC5yZXNwb25zZSwgcmVjb3JkKTtcclxuICAgIH0pXHJcbiAgICBmaWx0ZXJlZFJlY29yZHMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpIHtcclxuICAgICAgcmVzLnB1c2goeyBzZXRJZCA6IHNldElkLCByZWNvcmQ6IHJlY29yZH0pO1xyXG4gICAgfSlcclxuICB9KVxyXG4gIC8vIFRPRE8gU09SVD9cclxuICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZEZpcnN0U2V0UmVjb3JkKHRvb2xNYXRjaFJlc3VsdDogSU1hdGNoLklUb29sTWF0Y2gsIHJlY29yZHM6IElNYXRjaC5JUmVjb3JkW10pIDogSU1hdGNoLklNYXRjaGVkU2V0UmVjb3JkIHtcclxuICB2YXIgc2V0SWRzID0gZmluZE1hdGNoaW5nU2V0cyh0b29sTWF0Y2hSZXN1bHQpO1xyXG4gIHZhciByZXMgPSBmaW5kU2V0UmVjb3Jkcyh0b29sTWF0Y2hSZXN1bHQsIHNldElkcywgcmVjb3Jkcyk7XHJcbiAgaWYgKHJlcykge1xyXG4gICAgcmV0dXJuIHJlc1swXTtcclxuICB9XHJcbiAgcmV0dXJuIHVuZGVmaW5lZDtcclxufVxyXG4iLCIvKipcbiAqIEBmaWxlIHRvb2xtYXRjaFxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQudG9vbG1hdGNoXG4gKiBAY29weXJpZ2h0IChjKSBHZXJkIEZvcnN0bWFublxuICpcbiAqIE1ldGhvZHMgb3BlcmF0aW5nIG9uIGEgbWF0Y2hlZCB0b29sLFxuICpcbiAqIFRoaXMgd2lsbCB1bmlmeSBtYXRjaGluZyByZXF1aXJlZCBhbmQgb3B0aW9uYWwgY2F0ZWdvcnkgd29yZHNcbiAqIHdpdGggdGhlIHJlcXVpcmVtZW50cyBvZiB0aGUgdG9vbC5cbiAqXG4gKi9cblwidXNlIHN0cmljdFwiO1xuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2gnKTtcbi8qXG52YXIgb1Rvb2xGTFAgPSB7XG4gICduYW1lJzogJ0ZMUCcsXG4gICdyZXF1aXJlcyc6IHsgJ3N5c3RlbUlkJzoge30sICdjbGllbnQnOiB7fSB9LFxuICBcIm9wdGlvbmFsXCI6IHtcbiAgICBcImZpb3JpIGludGVudFwiOiB7fVxuICB9LFxuICBcInNldHNcIjoge1xuICAgIFwiaW50ZW50XCI6IHtcbiAgICAgIFwic2V0XCI6IFtcbiAgICAgICAgXCJzeXN0ZW1JZFwiLFxuICAgICAgICBcImNsaWVudFwiLFxuICAgICAgICBcImZpb3JpIGludGVudFwiXG4gICAgICBdLFxuICAgICAgXCJyZXNwb25zZVwiOiBcIl91cmxwYXR0ZXJuMVwiXG4gICAgfSxcbiAgICBcIm5vbmVcIjoge1xuICAgICAgXCJzZXRcIjogW1xuICAgICAgICBcInN5c3RlbUlkXCIsXG4gICAgICAgIFwiY2xpZW50XCJcbiAgICAgIF0sXG4gICAgICBcInJlc3BvbnNlXCI6IFwiX3VybHBhdHRlcm4yXCJcbiAgICB9XG4gIH1cbn07XG4qL1xudmFyIFNlbnRlbmNlID0gcmVxdWlyZSgnLi9zZW50ZW5jZScpO1xuZnVuY3Rpb24gY21wVG9vbFNldChzZXRzLCBhLCBiKSB7XG4gICAgcmV0dXJuIC0oc2V0c1thXS5zZXQubGVuZ3RoIC0gc2V0c1tiXS5zZXQubGVuZ3RoKTtcbn1cbi8qKlxuICogVGhpcyBvbnlsIGZpbmRzIHRoZSBiZXN0IG1hdGNoaW5nIHNldHMgKD1sb25nZXN0IG1hdGNoKVxuICogaW5kZXBlbmRlbnQgb2YgYSByZWNvcmRcbiAqL1xuZnVuY3Rpb24gZmluZE1hdGNoaW5nU2V0cyhhKSB7XG4gICAgdmFyIG1hdGNoaW5nU2V0cyA9IE9iamVjdC5rZXlzKGEudG9vbC5zZXRzKS5maWx0ZXIoZnVuY3Rpb24gKHNTZXRLZXkpIHtcbiAgICAgICAgdmFyIG9TZXQgPSBhLnRvb2wuc2V0c1tzU2V0S2V5XTtcbiAgICAgICAgZGVidWdsb2coJ2hlcmUgdGhlIHNldCBmb3IgdG9vbCAnICsgYS50b29sLm5hbWUgKyBcIiBcIiArIEpTT04uc3RyaW5naWZ5KG9TZXQpKTtcbiAgICAgICAgcmV0dXJuIG9TZXQuc2V0LmV2ZXJ5KGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICAgICAgdmFyIHdvcmQgPSBTZW50ZW5jZS5maW5kV29yZEJ5Q2F0ZWdvcnkoYS5zZW50ZW5jZSwgY2F0ZWdvcnkpO1xuICAgICAgICAgICAgdmFyIGIgPSAhISh3b3JkICYmICh3b3JkLndvcmQgIT09IHVuZGVmaW5lZCkpO1xuICAgICAgICAgICAgZGVidWdsb2coXCJzZWFyY2hpZ24gZm9yIGNhdGVnb3J5IFwiICsgY2F0ZWdvcnkgKyBcIiBcIiArIGIpO1xuICAgICAgICAgICAgcmV0dXJuIGI7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIGlmIChtYXRjaGluZ1NldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHZhciBjbXBUaGlzVG9vbFNldCA9IGNtcFRvb2xTZXQuYmluZCh1bmRlZmluZWQsIGEudG9vbC5zZXRzKTtcbiAgICBtYXRjaGluZ1NldHMuc29ydChjbXBUaGlzVG9vbFNldCk7XG4gICAgZGVidWdsb2coXCJiZXN0IHNldHMgb3JkZXJlZCBcIiArIG1hdGNoaW5nU2V0cy5qb2luKFwiLFwiKSk7XG4gICAgbWF0Y2hpbmdTZXRzID0gbWF0Y2hpbmdTZXRzLmZpbHRlcihmdW5jdGlvbiAoc0tleSkge1xuICAgICAgICBpZiAoIWNtcFRoaXNUb29sU2V0KG1hdGNoaW5nU2V0c1swXSwgc0tleSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9KTtcbiAgICBpZiAobWF0Y2hpbmdTZXRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgZGVidWdsb2coXCJNb3JlIHRoYW4gb25lIHNldCBtYXRjaGVzOiBcXFwiXCIgKyBtYXRjaGluZ1NldHMuam9pbignXCI7XCInKSArIFwiZm9yIG1hdGNoOlxcblwiICsgSlNPTi5zdHJpbmdpZnkoYSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuICAgIHJldHVybiBtYXRjaGluZ1NldHMuc29ydCgpO1xufVxuZXhwb3J0cy5maW5kTWF0Y2hpbmdTZXRzID0gZmluZE1hdGNoaW5nU2V0cztcbmZ1bmN0aW9uIGZpbmRCZXN0TWF0Y2hpbmdTZXQoYSkge1xuICAgIHZhciBtYXRjaGluZ1NldHMgPSBmaW5kTWF0Y2hpbmdTZXRzKGEpO1xuICAgIGlmIChtYXRjaGluZ1NldHMgJiYgbWF0Y2hpbmdTZXRzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gYS50b29sLnNldHNbbWF0Y2hpbmdTZXRzWzBdXTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cbmV4cG9ydHMuZmluZEJlc3RNYXRjaGluZ1NldCA9IGZpbmRCZXN0TWF0Y2hpbmdTZXQ7XG5mdW5jdGlvbiBpc01hdGNoaW5nUmVjb3JkKG1hdGNoc2V0LCBzZXRjb21tYW5kLCByZWNvcmQpIHtcbiAgICB2YXIgcmVzID0gT2JqZWN0LmtleXMobWF0Y2hzZXQpLmV2ZXJ5KGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICB2YXIgdmFsdWUgPSBtYXRjaHNldFtjYXRlZ29yeV07XG4gICAgICAgIGlmICgodmFsdWUgPT09IHJlY29yZFtjYXRlZ29yeV0pIHx8IChyZWNvcmRbY2F0ZWdvcnldID09PSAnKicpKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG4gICAgaWYgKCFyZXMpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoIXJlY29yZFtzZXRjb21tYW5kXSkge1xuICAgICAgICAvLyBUSFJPVz9cbiAgICAgICAgZGVidWdsb2coXCJNYXRjaGluZyByZWNvcmQgbGFja3Mgc2V0Y29tbWFuZFwiICsgc2V0Y29tbWFuZCArIFwiIG1hdGNoOlwiICsgSlNPTi5zdHJpbmdpZnkocmVjb3JkKSArIFwiIG1hdGNoIFwiICsgSlNPTi5zdHJpbmdpZnkobWF0Y2hzZXQpKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cbmV4cG9ydHMuaXNNYXRjaGluZ1JlY29yZCA9IGlzTWF0Y2hpbmdSZWNvcmQ7XG5mdW5jdGlvbiBtYWtlTWF0Y2hTZXQoYSwgdG9vbHNldCkge1xuICAgIHZhciByZXMgPSB7fTtcbiAgICB0b29sc2V0LnNldC5mb3JFYWNoKGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICByZXNbY2F0ZWdvcnldID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KS53b3JkLm1hdGNoZWRTdHJpbmc7XG4gICAgfSk7XG4gICAgT2JqZWN0LmZyZWV6ZShyZXMpO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLm1ha2VNYXRjaFNldCA9IG1ha2VNYXRjaFNldDtcbmZ1bmN0aW9uIGZpbmRTZXRSZWNvcmRzKGEsIHNldElkcywgYVJlY29yZHMpIHtcbiAgICB2YXIgcmVzID0gW107XG4gICAgc2V0SWRzLmZvckVhY2goZnVuY3Rpb24gKHNldElkKSB7XG4gICAgICAgIHZhciBzZXQgPSBhLnRvb2wuc2V0c1tzZXRJZF07XG4gICAgICAgIHZhciBtYXRjaHNldCA9IG1ha2VNYXRjaFNldChhLCBzZXQpO1xuICAgICAgICB2YXIgZmlsdGVyZWRSZWNvcmRzID0gYVJlY29yZHMuZmlsdGVyKGZ1bmN0aW9uIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJldHVybiBpc01hdGNoaW5nUmVjb3JkKG1hdGNoc2V0LCBzZXQucmVzcG9uc2UsIHJlY29yZCk7XG4gICAgICAgIH0pO1xuICAgICAgICBmaWx0ZXJlZFJlY29yZHMuZm9yRWFjaChmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgICAgICAgICByZXMucHVzaCh7IHNldElkOiBzZXRJZCwgcmVjb3JkOiByZWNvcmQgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIC8vIFRPRE8gU09SVD9cbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5maW5kU2V0UmVjb3JkcyA9IGZpbmRTZXRSZWNvcmRzO1xuZnVuY3Rpb24gZmluZEZpcnN0U2V0UmVjb3JkKHRvb2xNYXRjaFJlc3VsdCwgcmVjb3Jkcykge1xuICAgIHZhciBzZXRJZHMgPSBmaW5kTWF0Y2hpbmdTZXRzKHRvb2xNYXRjaFJlc3VsdCk7XG4gICAgdmFyIHJlcyA9IGZpbmRTZXRSZWNvcmRzKHRvb2xNYXRjaFJlc3VsdCwgc2V0SWRzLCByZWNvcmRzKTtcbiAgICBpZiAocmVzKSB7XG4gICAgICAgIHJldHVybiByZXNbMF07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG5leHBvcnRzLmZpbmRGaXJzdFNldFJlY29yZCA9IGZpbmRGaXJzdFNldFJlY29yZDtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
