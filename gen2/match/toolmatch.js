/**
 * @file toolmatch
 * @module jfseb.fdevstart.toolmatch
 * @copyright (c) Gerd Forstmann
 *
 * Methods operating on a matched tool,
 *
 * This will unify matching required and optional category words
 * with the requirements of the tool.
 *
 */
"use strict";
// / <reference path="../../lib/node-4.d.ts" />

var debug = require('debug');
var debuglog = debug('toolmatch');
/*
var oToolFLP = {
  'name': 'FLP',
  'requires': { 'systemId': {}, 'client': {} },
  "optional": {
    "fiori intent": {}
  },
  "sets": {
    "intent": {
      "set": [
        "systemId",
        "client",
        "fiori intent"
      ],
      "response": "_urlpattern1"
    },
    "none": {
      "set": [
        "systemId",
        "client"
      ],
      "response": "_urlpattern2"
    }
  }
};
*/
var Sentence = require('./sentence');
function cmpToolSet(sets, a, b) {
    return -(sets[a].set.length - sets[b].set.length);
}
/**
 * This onyl finds the best matching sets (=longest match)
 * independent of a record
 */
function findMatchingSets(a) {
    var matchingSets = Object.keys(a.tool.sets).filter(function (sSetKey) {
        var oSet = a.tool.sets[sSetKey];
        debuglog('here the set for tool ' + a.tool.name + " " + JSON.stringify(oSet));
        return oSet.set.every(function (category) {
            var word = Sentence.findWordByCategory(a.sentence, category);
            var b = !!(word && word.word !== undefined);
            debuglog("searchign for category " + category + " " + b);
            return b;
        });
    });
    if (matchingSets.length === 0) {
        return []; // undefined;
    }
    var cmpThisToolSet = cmpToolSet.bind(undefined, a.tool.sets);
    matchingSets.sort(cmpThisToolSet);
    debuglog("best sets ordered " + matchingSets.join(","));
    matchingSets = matchingSets.filter(function (sKey) {
        if (!cmpThisToolSet(matchingSets[0], sKey)) {
            return true;
        }
        return false;
    });
    if (matchingSets.length > 1) {
        debuglog("More than one set matches: \"" + matchingSets.join('";"') + "for match:\n" + JSON.stringify(a, undefined, 2));
    }
    return matchingSets.sort();
}
exports.findMatchingSets = findMatchingSets;
function findBestMatchingSet(a) {
    var matchingSets = findMatchingSets(a);
    if (matchingSets && matchingSets.length) {
        return a.tool.sets[matchingSets[0]];
    }
    return undefined;
}
exports.findBestMatchingSet = findBestMatchingSet;
function isMatchingRecord(matchset, setcommand, record) {
    var res = Object.keys(matchset).every(function (category) {
        var value = matchset[category];
        if (value === record[category] || record[category] === '*') {
            return true;
        }
        return false;
    });
    if (!res) {
        return false;
    }
    if (!record[setcommand]) {
        // THROW?
        debuglog("Matching record lacks setcommand" + setcommand + " match:" + JSON.stringify(record) + " match " + JSON.stringify(matchset));
        return false;
    }
    return true;
}
exports.isMatchingRecord = isMatchingRecord;
function makeMatchSet(a, toolset) {
    var res = {};
    toolset.set.forEach(function (category) {
        res[category] = Sentence.findWordByCategory(a.sentence, category).word.matchedString;
    });
    Object.freeze(res);
    return res;
}
exports.makeMatchSet = makeMatchSet;
function findSetRecords(a, setIds, aRecords) {
    var res = [];
    setIds.forEach(function (setId) {
        var set = a.tool.sets[setId];
        var matchset = makeMatchSet(a, set);
        var filteredRecords = aRecords.filter(function (record) {
            return isMatchingRecord(matchset, set.response, record);
        });
        filteredRecords.forEach(function (record) {
            res.push({ setId: setId, record: record });
        });
    });
    // TODO SORT?
    return res;
}
exports.findSetRecords = findSetRecords;
function findFirstSetRecord(toolMatchResult, records) {
    var setIds = findMatchingSets(toolMatchResult);
    var res = findSetRecords(toolMatchResult, setIds, records);
    if (res) {
        return res[0];
    }
    return undefined;
}
exports.findFirstSetRecord = findFirstSetRecord;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXRjaC90b29sbWF0Y2gudHMiLCJtYXRjaC90b29sbWF0Y2guanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJTZW50ZW5jZSIsImNtcFRvb2xTZXQiLCJzZXRzIiwiYSIsImIiLCJzZXQiLCJsZW5ndGgiLCJmaW5kTWF0Y2hpbmdTZXRzIiwibWF0Y2hpbmdTZXRzIiwiT2JqZWN0Iiwia2V5cyIsInRvb2wiLCJmaWx0ZXIiLCJzU2V0S2V5Iiwib1NldCIsIm5hbWUiLCJKU09OIiwic3RyaW5naWZ5IiwiZXZlcnkiLCJjYXRlZ29yeSIsIndvcmQiLCJmaW5kV29yZEJ5Q2F0ZWdvcnkiLCJzZW50ZW5jZSIsInVuZGVmaW5lZCIsImNtcFRoaXNUb29sU2V0IiwiYmluZCIsInNvcnQiLCJqb2luIiwic0tleSIsImV4cG9ydHMiLCJmaW5kQmVzdE1hdGNoaW5nU2V0IiwiaXNNYXRjaGluZ1JlY29yZCIsIm1hdGNoc2V0Iiwic2V0Y29tbWFuZCIsInJlY29yZCIsInJlcyIsInZhbHVlIiwibWFrZU1hdGNoU2V0IiwidG9vbHNldCIsImZvckVhY2giLCJtYXRjaGVkU3RyaW5nIiwiZnJlZXplIiwiZmluZFNldFJlY29yZHMiLCJzZXRJZHMiLCJhUmVjb3JkcyIsInNldElkIiwiZmlsdGVyZWRSZWNvcmRzIiwicmVzcG9uc2UiLCJwdXNoIiwiZmluZEZpcnN0U2V0UmVjb3JkIiwidG9vbE1hdGNoUmVzdWx0IiwicmVjb3JkcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7O0FDV0E7QURDQTs7QUFFQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4sQ0FBakI7QUFFQSxJQUFNQyxXQUFXRixNQUFNLFdBQU4sQ0FBakI7QUFFQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUEyQkEsSUFBWUcsV0FBUUYsUUFBTSxZQUFOLENBQXBCO0FBRUEsU0FBQUcsVUFBQSxDQUFvQkMsSUFBcEIsRUFBNkNDLENBQTdDLEVBQXlEQyxDQUF6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SXlDLGtCQUFrQkYsU0FBU2hDLE1BQVQsQ0FBZ0IsVUFBU3NCLE1BQVQsRUFBZTtBQUNuRCxtQkFBT0gsaUJBQWlCQyxRQUFqQixFQUEyQjNCLElBQUkwQyxRQUEvQixFQUF5Q2IsTUFBekMsQ0FBUDtBQUNELFNBRnFCLENBQXRCO0FBR0FZLHdCQUFnQlAsT0FBaEIsQ0FBd0IsVUFBU0wsTUFBVCxFQUFlO0FBQ3JDQyxnQkFBSWEsSUFBSixDQUFTLEVBQUVILE9BQVFBLEtBQVYsRUFBaUJYLFFBQVFBLE1BQXpCLEVBQVQ7QUFDRCxTQUZEO0FBR0QsS0FURDtBQVVBO0FBQ0EsV0FBT0MsR0FBUDtBQUNEO0FBZGVOLFFBQUFhLGNBQUEsR0FBY0EsY0FBZDtBQWdCaEIsU0FBQU8sa0JBQUEsQ0FBbUNDLGVBQW5DLEVBQXVFQyxPQUF2RSxFQUFnRztBQUM5RixRQUFJUixTQUFTcEMsaUJBQWlCMkMsZUFBakIsQ0FBYjtBQUNBLFFBQUlmLE1BQU1PLGVBQWVRLGVBQWYsRUFBZ0NQLE1BQWhDLEVBQXdDUSxPQUF4QyxDQUFWO0FBQ0EsUUFBSWhCLEdBQUosRUFBUztBQUNQLGVBQU9BLElBQUksQ0FBSixDQUFQO0FBQ0Q7QUFDRCxXQUFPWixTQUFQO0FBQ0Q7QUFQZU0sUUFBQW9CLGtCQUFBLEdBQWtCQSxrQkFBbEIiLCJmaWxlIjoibWF0Y2gvdG9vbG1hdGNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEBmaWxlIHRvb2xtYXRjaFxyXG4gKiBAbW9kdWxlIGpmc2ViLmZkZXZzdGFydC50b29sbWF0Y2hcclxuICogQGNvcHlyaWdodCAoYykgR2VyZCBGb3JzdG1hbm5cclxuICpcclxuICogTWV0aG9kcyBvcGVyYXRpbmcgb24gYSBtYXRjaGVkIHRvb2wsXHJcbiAqXHJcbiAqIFRoaXMgd2lsbCB1bmlmeSBtYXRjaGluZyByZXF1aXJlZCBhbmQgb3B0aW9uYWwgY2F0ZWdvcnkgd29yZHNcclxuICogd2l0aCB0aGUgcmVxdWlyZW1lbnRzIG9mIHRoZSB0b29sLlxyXG4gKlxyXG4gKi9cclxuXHJcbi8vIC8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vbGliL25vZGUtNC5kLnRzXCIgLz5cclxuXHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcclxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4vaWZtYXRjaCc7XHJcbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ3Rvb2xtYXRjaCcpO1xyXG5cclxuLypcclxudmFyIG9Ub29sRkxQID0ge1xyXG4gICduYW1lJzogJ0ZMUCcsXHJcbiAgJ3JlcXVpcmVzJzogeyAnc3lzdGVtSWQnOiB7fSwgJ2NsaWVudCc6IHt9IH0sXHJcbiAgXCJvcHRpb25hbFwiOiB7XHJcbiAgICBcImZpb3JpIGludGVudFwiOiB7fVxyXG4gIH0sXHJcbiAgXCJzZXRzXCI6IHtcclxuICAgIFwiaW50ZW50XCI6IHtcclxuICAgICAgXCJzZXRcIjogW1xyXG4gICAgICAgIFwic3lzdGVtSWRcIixcclxuICAgICAgICBcImNsaWVudFwiLFxyXG4gICAgICAgIFwiZmlvcmkgaW50ZW50XCJcclxuICAgICAgXSxcclxuICAgICAgXCJyZXNwb25zZVwiOiBcIl91cmxwYXR0ZXJuMVwiXHJcbiAgICB9LFxyXG4gICAgXCJub25lXCI6IHtcclxuICAgICAgXCJzZXRcIjogW1xyXG4gICAgICAgIFwic3lzdGVtSWRcIixcclxuICAgICAgICBcImNsaWVudFwiXHJcbiAgICAgIF0sXHJcbiAgICAgIFwicmVzcG9uc2VcIjogXCJfdXJscGF0dGVybjJcIlxyXG4gICAgfVxyXG4gIH1cclxufTtcclxuKi9cclxuXHJcbmltcG9ydCAqIGFzIFNlbnRlbmNlIGZyb20gJy4vc2VudGVuY2UnO1xyXG5cclxuZnVuY3Rpb24gY21wVG9vbFNldChzZXRzIDogSU1hdGNoLklUb29sU2V0cywgYSA6IHN0cmluZywgYjpzdHJpbmcpIHtcclxuICByZXR1cm4gLShzZXRzW2FdLnNldC5sZW5ndGggLSBzZXRzW2JdLnNldC5sZW5ndGgpO1xyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIFRoaXMgb255bCBmaW5kcyB0aGUgYmVzdCBtYXRjaGluZyBzZXRzICg9bG9uZ2VzdCBtYXRjaClcclxuICogaW5kZXBlbmRlbnQgb2YgYSByZWNvcmRcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kTWF0Y2hpbmdTZXRzKGEgOiBJTWF0Y2guSVRvb2xNYXRjaCApIDogc3RyaW5nW10ge1xyXG4gIHZhciBtYXRjaGluZ1NldHMgPSBPYmplY3Qua2V5cyhhLnRvb2wuc2V0cykuZmlsdGVyKGZ1bmN0aW9uKHNTZXRLZXkpIHtcclxuICAgIHZhciBvU2V0ID0gYS50b29sLnNldHNbc1NldEtleV07XHJcbiAgICBkZWJ1Z2xvZygnaGVyZSB0aGUgc2V0IGZvciB0b29sICcgKyBhLnRvb2wubmFtZSArIFwiIFwiICsgSlNPTi5zdHJpbmdpZnkob1NldCkpO1xyXG4gICAgcmV0dXJuIG9TZXQuc2V0LmV2ZXJ5KGZ1bmN0aW9uKGNhdGVnb3J5IDogc3RyaW5nKSA6Ym9vbGVhbiB7XHJcbiAgICAgIHZhciB3b3JkID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KTtcclxuICAgICAgdmFyIGIgPSAhISh3b3JkICYmICh3b3JkLndvcmQgIT09IHVuZGVmaW5lZCkpO1xyXG4gICAgICBkZWJ1Z2xvZyhcInNlYXJjaGlnbiBmb3IgY2F0ZWdvcnkgXCIgKyBjYXRlZ29yeSArIFwiIFwiICsgYik7XHJcbiAgICAgIHJldHVybiBiO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbiAgaWYobWF0Y2hpbmdTZXRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgcmV0dXJuIFtdOyAvLyB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIHZhciBjbXBUaGlzVG9vbFNldCA9IGNtcFRvb2xTZXQuYmluZCh1bmRlZmluZWQsIGEudG9vbC5zZXRzKTtcclxuICBtYXRjaGluZ1NldHMuc29ydChjbXBUaGlzVG9vbFNldCk7XHJcbiAgZGVidWdsb2coXCJiZXN0IHNldHMgb3JkZXJlZCBcIiArIG1hdGNoaW5nU2V0cy5qb2luKFwiLFwiKSk7XHJcbiAgbWF0Y2hpbmdTZXRzID0gbWF0Y2hpbmdTZXRzLmZpbHRlcihmdW5jdGlvbihzS2V5KSB7XHJcbiAgICBpZighY21wVGhpc1Rvb2xTZXQobWF0Y2hpbmdTZXRzWzBdLHNLZXkpKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIGlmIChtYXRjaGluZ1NldHMubGVuZ3RoID4gMSkge1xyXG4gICAgZGVidWdsb2coXCJNb3JlIHRoYW4gb25lIHNldCBtYXRjaGVzOiBcXFwiXCIgKyBtYXRjaGluZ1NldHMuam9pbignXCI7XCInKSArIFwiZm9yIG1hdGNoOlxcblwiICsgSlNPTi5zdHJpbmdpZnkoYSwgdW5kZWZpbmVkLDIpKVxyXG4gIH1cclxuICByZXR1cm4gbWF0Y2hpbmdTZXRzLnNvcnQoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRCZXN0TWF0Y2hpbmdTZXQoYSA6IElNYXRjaC5JVG9vbE1hdGNoKSA6IElNYXRjaC5JVG9vbFNldCB7XHJcbiAgdmFyIG1hdGNoaW5nU2V0cyA9IGZpbmRNYXRjaGluZ1NldHMoYSk7XHJcbiAgaWYobWF0Y2hpbmdTZXRzICYmIG1hdGNoaW5nU2V0cy5sZW5ndGgpIHtcclxuICAgIHJldHVybiBhLnRvb2wuc2V0c1ttYXRjaGluZ1NldHNbMF1dO1xyXG4gIH1cclxuICByZXR1cm4gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTWF0Y2hpbmdSZWNvcmQoIG1hdGNoc2V0IDogSU1hdGNoLklNYXRjaFNldCwgc2V0Y29tbWFuZCA6IHN0cmluZywgcmVjb3JkIDogSU1hdGNoLklSZWNvcmQpIHtcclxuXHJcbiAgdmFyIHJlcyA9IE9iamVjdC5rZXlzKG1hdGNoc2V0KS5ldmVyeShmdW5jdGlvbihjYXRlZ29yeSkge1xyXG4gICAgdmFyIHZhbHVlID0gbWF0Y2hzZXRbY2F0ZWdvcnldO1xyXG4gICAgaWYgKCh2YWx1ZSA9PT0gcmVjb3JkW2NhdGVnb3J5XSkgfHwgIChyZWNvcmRbY2F0ZWdvcnldID09PSAnKicpKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIGlmKCFyZXMpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbiAgaWYoIXJlY29yZFtzZXRjb21tYW5kXSkge1xyXG4gICAgLy8gVEhST1c/XHJcbiAgICBkZWJ1Z2xvZyhcIk1hdGNoaW5nIHJlY29yZCBsYWNrcyBzZXRjb21tYW5kXCIgKyBzZXRjb21tYW5kICsgXCIgbWF0Y2g6XCIgKyBKU09OLnN0cmluZ2lmeShyZWNvcmQpICsgXCIgbWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtYXRjaHNldCkgKVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gfVxyXG4gIHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZU1hdGNoU2V0KGEgOiBJTWF0Y2guSVRvb2xNYXRjaCwgdG9vbHNldCA6IElNYXRjaC5JVG9vbFNldCkgOiBJTWF0Y2guSU1hdGNoU2V0IHtcclxuICB2YXIgcmVzID0ge30gYXMgSU1hdGNoLklNYXRjaFNldDtcclxuICB0b29sc2V0LnNldC5mb3JFYWNoKGZ1bmN0aW9uKGNhdGVnb3J5KSB7XHJcbiAgICByZXNbY2F0ZWdvcnldID0gU2VudGVuY2UuZmluZFdvcmRCeUNhdGVnb3J5KGEuc2VudGVuY2UsIGNhdGVnb3J5KS53b3JkLm1hdGNoZWRTdHJpbmc7XHJcbiAgfSk7XHJcbiAgT2JqZWN0LmZyZWV6ZShyZXMpO1xyXG4gIHJldHVybiByZXM7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZFNldFJlY29yZHMoYSA6IElNYXRjaC5JVG9vbE1hdGNoLCBzZXRJZHMgOiBzdHJpbmdbXSwgYVJlY29yZHMgOiBJTWF0Y2guSVJlY29yZFtdKSA6IElNYXRjaC5JTWF0Y2hlZFNldFJlY29yZHMge1xyXG4gIHZhciByZXMgPSBbXSBhcyBJTWF0Y2guSU1hdGNoZWRTZXRSZWNvcmRbXTtcclxuICBzZXRJZHMuZm9yRWFjaChmdW5jdGlvbihzZXRJZCkge1xyXG4gICAgdmFyIHNldCA9IGEudG9vbC5zZXRzW3NldElkXTtcclxuICAgIHZhciBtYXRjaHNldCA9IG1ha2VNYXRjaFNldChhLCBzZXQpO1xyXG4gICAgdmFyIGZpbHRlcmVkUmVjb3JkcyA9IGFSZWNvcmRzLmZpbHRlcihmdW5jdGlvbihyZWNvcmQpIHtcclxuICAgICAgcmV0dXJuIGlzTWF0Y2hpbmdSZWNvcmQobWF0Y2hzZXQsIHNldC5yZXNwb25zZSwgcmVjb3JkKTtcclxuICAgIH0pXHJcbiAgICBmaWx0ZXJlZFJlY29yZHMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpIHtcclxuICAgICAgcmVzLnB1c2goeyBzZXRJZCA6IHNldElkLCByZWNvcmQ6IHJlY29yZH0pO1xyXG4gICAgfSlcclxuICB9KVxyXG4gIC8vIFRPRE8gU09SVD9cclxuICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZEZpcnN0U2V0UmVjb3JkKHRvb2xNYXRjaFJlc3VsdDogSU1hdGNoLklUb29sTWF0Y2gsIHJlY29yZHM6IElNYXRjaC5JUmVjb3JkW10pIDogSU1hdGNoLklNYXRjaGVkU2V0UmVjb3JkIHtcclxuICB2YXIgc2V0SWRzID0gZmluZE1hdGNoaW5nU2V0cyh0b29sTWF0Y2hSZXN1bHQpO1xyXG4gIHZhciByZXMgPSBmaW5kU2V0UmVjb3Jkcyh0b29sTWF0Y2hSZXN1bHQsIHNldElkcywgcmVjb3Jkcyk7XHJcbiAgaWYgKHJlcykge1xyXG4gICAgcmV0dXJuIHJlc1swXTtcclxuICB9XHJcbiAgcmV0dXJuIHVuZGVmaW5lZDtcclxufVxyXG4iLCIvKipcbiAqIEBmaWxlIHRvb2xtYXRjaFxuICogQG1vZHVsZSBqZnNlYi5mZGV2c3RhcnQudG9vbG1hdGNoXG4gKiBAY29weXJpZ2h0IChjKSBHZXJkIEZvcnN0bWFublxuICpcbiAqIE1ldGhvZHMgb3BlcmF0aW5nIG9uIGEgbWF0Y2hlZCB0b29sLFxuICpcbiAqIFRoaXMgd2lsbCB1bmlmeSBtYXRjaGluZyByZXF1aXJlZCBhbmQgb3B0aW9uYWwgY2F0ZWdvcnkgd29yZHNcbiAqIHdpdGggdGhlIHJlcXVpcmVtZW50cyBvZiB0aGUgdG9vbC5cbiAqXG4gKi9cblwidXNlIHN0cmljdFwiO1xuLy8gLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCd0b29sbWF0Y2gnKTtcbi8qXG52YXIgb1Rvb2xGTFAgPSB7XG4gICduYW1lJzogJ0ZMUCcsXG4gICdyZXF1aXJlcyc6IHsgJ3N5c3RlbUlkJzoge30sICdjbGllbnQnOiB7fSB9LFxuICBcIm9wdGlvbmFsXCI6IHtcbiAgICBcImZpb3JpIGludGVudFwiOiB7fVxuICB9LFxuICBcInNldHNcIjoge1xuICAgIFwiaW50ZW50XCI6IHtcbiAgICAgIFwic2V0XCI6IFtcbiAgICAgICAgXCJzeXN0ZW1JZFwiLFxuICAgICAgICBcImNsaWVudFwiLFxuICAgICAgICBcImZpb3JpIGludGVudFwiXG4gICAgICBdLFxuICAgICAgXCJyZXNwb25zZVwiOiBcIl91cmxwYXR0ZXJuMVwiXG4gICAgfSxcbiAgICBcIm5vbmVcIjoge1xuICAgICAgXCJzZXRcIjogW1xuICAgICAgICBcInN5c3RlbUlkXCIsXG4gICAgICAgIFwiY2xpZW50XCJcbiAgICAgIF0sXG4gICAgICBcInJlc3BvbnNlXCI6IFwiX3VybHBhdHRlcm4yXCJcbiAgICB9XG4gIH1cbn07XG4qL1xudmFyIFNlbnRlbmNlID0gcmVxdWlyZSgnLi9zZW50ZW5jZScpO1xuZnVuY3Rpb24gY21wVG9vbFNldChzZXRzLCBhLCBiKSB7XG4gICAgcmV0dXJuIC0oc2V0c1thXS5zZXQubGVuZ3RoIC0gc2V0c1tiXS5zZXQubGVuZ3RoKTtcbn1cbi8qKlxuICogVGhpcyBvbnlsIGZpbmRzIHRoZSBiZXN0IG1hdGNoaW5nIHNldHMgKD1sb25nZXN0IG1hdGNoKVxuICogaW5kZXBlbmRlbnQgb2YgYSByZWNvcmRcbiAqL1xuZnVuY3Rpb24gZmluZE1hdGNoaW5nU2V0cyhhKSB7XG4gICAgdmFyIG1hdGNoaW5nU2V0cyA9IE9iamVjdC5rZXlzKGEudG9vbC5zZXRzKS5maWx0ZXIoZnVuY3Rpb24gKHNTZXRLZXkpIHtcbiAgICAgICAgdmFyIG9TZXQgPSBhLnRvb2wuc2V0c1tzU2V0S2V5XTtcbiAgICAgICAgZGVidWdsb2coJ2hlcmUgdGhlIHNldCBmb3IgdG9vbCAnICsgYS50b29sLm5hbWUgKyBcIiBcIiArIEpTT04uc3RyaW5naWZ5KG9TZXQpKTtcbiAgICAgICAgcmV0dXJuIG9TZXQuc2V0LmV2ZXJ5KGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICAgICAgdmFyIHdvcmQgPSBTZW50ZW5jZS5maW5kV29yZEJ5Q2F0ZWdvcnkoYS5zZW50ZW5jZSwgY2F0ZWdvcnkpO1xuICAgICAgICAgICAgdmFyIGIgPSAhISh3b3JkICYmICh3b3JkLndvcmQgIT09IHVuZGVmaW5lZCkpO1xuICAgICAgICAgICAgZGVidWdsb2coXCJzZWFyY2hpZ24gZm9yIGNhdGVnb3J5IFwiICsgY2F0ZWdvcnkgKyBcIiBcIiArIGIpO1xuICAgICAgICAgICAgcmV0dXJuIGI7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIGlmIChtYXRjaGluZ1NldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTsgLy8gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB2YXIgY21wVGhpc1Rvb2xTZXQgPSBjbXBUb29sU2V0LmJpbmQodW5kZWZpbmVkLCBhLnRvb2wuc2V0cyk7XG4gICAgbWF0Y2hpbmdTZXRzLnNvcnQoY21wVGhpc1Rvb2xTZXQpO1xuICAgIGRlYnVnbG9nKFwiYmVzdCBzZXRzIG9yZGVyZWQgXCIgKyBtYXRjaGluZ1NldHMuam9pbihcIixcIikpO1xuICAgIG1hdGNoaW5nU2V0cyA9IG1hdGNoaW5nU2V0cy5maWx0ZXIoZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgICAgaWYgKCFjbXBUaGlzVG9vbFNldChtYXRjaGluZ1NldHNbMF0sIHNLZXkpKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG4gICAgaWYgKG1hdGNoaW5nU2V0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiTW9yZSB0aGFuIG9uZSBzZXQgbWF0Y2hlczogXFxcIlwiICsgbWF0Y2hpbmdTZXRzLmpvaW4oJ1wiO1wiJykgKyBcImZvciBtYXRjaDpcXG5cIiArIEpTT04uc3RyaW5naWZ5KGEsIHVuZGVmaW5lZCwgMikpO1xuICAgIH1cbiAgICByZXR1cm4gbWF0Y2hpbmdTZXRzLnNvcnQoKTtcbn1cbmV4cG9ydHMuZmluZE1hdGNoaW5nU2V0cyA9IGZpbmRNYXRjaGluZ1NldHM7XG5mdW5jdGlvbiBmaW5kQmVzdE1hdGNoaW5nU2V0KGEpIHtcbiAgICB2YXIgbWF0Y2hpbmdTZXRzID0gZmluZE1hdGNoaW5nU2V0cyhhKTtcbiAgICBpZiAobWF0Y2hpbmdTZXRzICYmIG1hdGNoaW5nU2V0cy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGEudG9vbC5zZXRzW21hdGNoaW5nU2V0c1swXV07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG5leHBvcnRzLmZpbmRCZXN0TWF0Y2hpbmdTZXQgPSBmaW5kQmVzdE1hdGNoaW5nU2V0O1xuZnVuY3Rpb24gaXNNYXRjaGluZ1JlY29yZChtYXRjaHNldCwgc2V0Y29tbWFuZCwgcmVjb3JkKSB7XG4gICAgdmFyIHJlcyA9IE9iamVjdC5rZXlzKG1hdGNoc2V0KS5ldmVyeShmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgdmFyIHZhbHVlID0gbWF0Y2hzZXRbY2F0ZWdvcnldO1xuICAgICAgICBpZiAoKHZhbHVlID09PSByZWNvcmRbY2F0ZWdvcnldKSB8fCAocmVjb3JkW2NhdGVnb3J5XSA9PT0gJyonKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pO1xuICAgIGlmICghcmVzKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKCFyZWNvcmRbc2V0Y29tbWFuZF0pIHtcbiAgICAgICAgLy8gVEhST1c/XG4gICAgICAgIGRlYnVnbG9nKFwiTWF0Y2hpbmcgcmVjb3JkIGxhY2tzIHNldGNvbW1hbmRcIiArIHNldGNvbW1hbmQgKyBcIiBtYXRjaDpcIiArIEpTT04uc3RyaW5naWZ5KHJlY29yZCkgKyBcIiBtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG1hdGNoc2V0KSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5leHBvcnRzLmlzTWF0Y2hpbmdSZWNvcmQgPSBpc01hdGNoaW5nUmVjb3JkO1xuZnVuY3Rpb24gbWFrZU1hdGNoU2V0KGEsIHRvb2xzZXQpIHtcbiAgICB2YXIgcmVzID0ge307XG4gICAgdG9vbHNldC5zZXQuZm9yRWFjaChmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgcmVzW2NhdGVnb3J5XSA9IFNlbnRlbmNlLmZpbmRXb3JkQnlDYXRlZ29yeShhLnNlbnRlbmNlLCBjYXRlZ29yeSkud29yZC5tYXRjaGVkU3RyaW5nO1xuICAgIH0pO1xuICAgIE9iamVjdC5mcmVlemUocmVzKTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5tYWtlTWF0Y2hTZXQgPSBtYWtlTWF0Y2hTZXQ7XG5mdW5jdGlvbiBmaW5kU2V0UmVjb3JkcyhhLCBzZXRJZHMsIGFSZWNvcmRzKSB7XG4gICAgdmFyIHJlcyA9IFtdO1xuICAgIHNldElkcy5mb3JFYWNoKGZ1bmN0aW9uIChzZXRJZCkge1xuICAgICAgICB2YXIgc2V0ID0gYS50b29sLnNldHNbc2V0SWRdO1xuICAgICAgICB2YXIgbWF0Y2hzZXQgPSBtYWtlTWF0Y2hTZXQoYSwgc2V0KTtcbiAgICAgICAgdmFyIGZpbHRlcmVkUmVjb3JkcyA9IGFSZWNvcmRzLmZpbHRlcihmdW5jdGlvbiAocmVjb3JkKSB7XG4gICAgICAgICAgICByZXR1cm4gaXNNYXRjaGluZ1JlY29yZChtYXRjaHNldCwgc2V0LnJlc3BvbnNlLCByZWNvcmQpO1xuICAgICAgICB9KTtcbiAgICAgICAgZmlsdGVyZWRSZWNvcmRzLmZvckVhY2goZnVuY3Rpb24gKHJlY29yZCkge1xuICAgICAgICAgICAgcmVzLnB1c2goeyBzZXRJZDogc2V0SWQsIHJlY29yZDogcmVjb3JkIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICAvLyBUT0RPIFNPUlQ/XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMuZmluZFNldFJlY29yZHMgPSBmaW5kU2V0UmVjb3JkcztcbmZ1bmN0aW9uIGZpbmRGaXJzdFNldFJlY29yZCh0b29sTWF0Y2hSZXN1bHQsIHJlY29yZHMpIHtcbiAgICB2YXIgc2V0SWRzID0gZmluZE1hdGNoaW5nU2V0cyh0b29sTWF0Y2hSZXN1bHQpO1xuICAgIHZhciByZXMgPSBmaW5kU2V0UmVjb3Jkcyh0b29sTWF0Y2hSZXN1bHQsIHNldElkcywgcmVjb3Jkcyk7XG4gICAgaWYgKHJlcykge1xuICAgICAgICByZXR1cm4gcmVzWzBdO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5maW5kRmlyc3RTZXRSZWNvcmQgPSBmaW5kRmlyc3RTZXRSZWNvcmQ7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
