/**
 * @copyright (c) 2016 Gerd Forstmann
 * @file plainrecognizer.ts
 *
 * A recognizer parametrized by regex expressions
 */
"use strict";

var debug = require('debug');
var debuglog = debug('plainrecognizer');
var AnyObject = Object;
function recognize(sString, mRules) {
    var res = undefined;
    mRules.every(function (oRule) {
        res = matchRegularExpression(sString, oRule);
        return !res;
    });
    return res;
}
exports.recognize = recognize;
function countParenGroups(s) {
    var res = 0;
    for (var i = 0; i < s.length; ++i) {
        if (s.charAt(i) === '(') {
            ++res;
        }
    }
    return res;
}
exports.countParenGroups = countParenGroups;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleString(a) {
    var s = "^" + a + "$";
    var argMaps = {};
    var m = undefined;
    while (m = /<([^>]+)>([?]?)/.exec(s)) {
        var cat = m[1];
        var greedy = m[2];
        var pos = 1 + countParenGroups(s.substring(0, m.index));
        if (greedy) {
            s = s.replace("<" + cat + ">?", "(.*?)");
        } else {
            s = s.replace("<" + cat + ">", "(.*)");
        }
        if (argMaps[cat]) {
            throw Error("Model error duplicate entry!");
        }
        argMaps[cat] = pos;
    }
    return {
        type: 1,
        regexp: new RegExp(s, "i"),
        argsMap: argMaps
    };
}
exports.parseRuleString = parseRuleString;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleArray(a) {
    var s = "^" + a + "$";
    var r = a[0];
    if (typeof a[0] === "string") {
        r = new RegExp(a[0], "i");
    }
    if (!(r instanceof RegExp)) {
        throw Error("illegal state" + JSON.stringify(a));
    }
    return {
        type: 1,
        regexp: r,
        argsMap: a[1]
    };
}
exports.parseRuleArray = parseRuleArray;
function parseRule(a) {
    if (typeof a === 'string') {
        return parseRuleString(a);
    } else if (Array.isArray(a)) {
        return parseRuleArray(a);
    }
    throw new Error("unknown rule definition");
}
exports.parseRule = parseRule;
function parseRules(oJSON) {
    var res = {};
    Object.keys(oJSON).forEach(function (sKey) {
        res[sKey] = oJSON[sKey].map(function (oRule) {
            return parseRule(oRule);
        });
    });
    return res;
}
exports.parseRules = parseRules;
;
function trimValueAdjusting(value) {
    var res = { deltaStart: 0, value: value };
    var m = value.match(/^\s+/);
    if (m) {
        res.deltaStart = m[0].length;
        value = value.substr(res.deltaStart);
    }
    m = value.match(/\s+$/);
    if (m) {
        value = value.substr(0, value.length - m[0].length);
    }
    res.value = value;
    return res;
}
exports.trimValueAdjusting = trimValueAdjusting;
function extractArgsMap(s, match, argsMap) {
    if (!argsMap) {
        return [];
    }
    var result = [];
    Object.keys(argsMap).forEach(function (sKey) {
        var res = {};
        var index = argsMap[sKey];
        var value = match[index];
        if (typeof value === "string" && value.length > 0) {
            res.type = sKey;
            res.entity = value;
            res.startIndex = s.indexOf(value); // this may not be precise
            var trimAdjust = trimValueAdjusting(value);
            res.startIndex += trimAdjust.deltaStart;
            res.entity = trimAdjust.value;
            res.endIndex = res.startIndex + trimAdjust.value.length;
            //res[sKey] = value
            result.push(res);
        }
    });
    return result;
}
exports.extractArgsMap = extractArgsMap;
function matchRegularExpression(text, oRule) {
    debuglog("regexp is " + oRule.regexp.toString());
    debuglog(" text is " + text);
    var m = oRule.regexp.exec(text);
    if (!m) {
        return undefined;
    }
    var res = {};
    res.entities = extractArgsMap(text, m, oRule.argsMap);
    res.score = 0.9;
    debuglog("match " + JSON.stringify(m));
    debuglog('Found one' + JSON.stringify(res, undefined, 2));
    return res;
}
exports.matchRegularExpression = matchRegularExpression;
function trimTrailingSentenceDelimiters(text) {
    var m = /([!.;, ?]|\s)+$/.exec(text);
    if (m) {
        text = text.substr(0, text.length - m[0].length);
    }
    return text;
}
exports.trimTrailingSentenceDelimiters = trimTrailingSentenceDelimiters;
function normalizeWhitespace(text) {
    text = text.replace(/\s+/g, ' ');
    return text;
}
exports.normalizeWhitespace = normalizeWhitespace;
/**
 * Givena string, replace all "....."  with <word>
 */
function compactQuoted(text) {
    text = text.replace(/"[^"]+"/g, "<word>");
    return text;
}
exports.compactQuoted = compactQuoted;
function countCompactWords(text) {
    text = text.replace(/,/g, ' ');
    text = text.replace(/ \s+/g, ' ');
    return text.split(" ").length;
}
exports.countCompactWords = countCompactWords;
function checkForLength(text) {
    var textStripped = trimTrailingSentenceDelimiters(text);
    if (textStripped.length > 200 || countCompactWords(compactQuoted(text)) > 20) {
        return {
            intent: "TooLong",
            score: 1.0,
            entities: []
        };
    }
    return undefined;
}
exports.checkForLength = checkForLength;
function recognizeText(text, aRules) {
    var res = undefined;
    aRules.every(function (oRule) {
        res = matchRegularExpression(text, oRule);
        return !res;
    });
    return res;
}
exports.recognizeText = recognizeText;
var RegExpRecognizer = function () {
    function RegExpRecognizer(xRules) {
        this.oRules = xRules;
        debuglog("rules " + JSON.stringify(this.oRules));
    }
    ;
    RegExpRecognizer.prototype.recognize = function (context, callback) {
        var u = {};
        var text = context.message.text;
        var that = this;
        var r = checkForLength(text);
        if (r) {
            callback(undefined, r);
            return;
        }
        debuglog("rules " + JSON.stringify(this.oRules));
        var text = trimTrailingSentenceDelimiters(text);
        var results = Object.keys(this.oRules).map(function (sKey) {
            var u = recognizeText(text, that.oRules[sKey]);
            if (u) {
                u.intent = sKey;
            }
            return u ? u : undefined;
        }).filter(function (o) {
            return !!o;
        });
        if (results.length > 1) {
            /* TODO abiguous */
            debuglog("ambiguous result for >" + text + "<" + JSON.stringify(res));
        }
        if (results.length > 0) {
            var res = results[0];
            callback(undefined, res);
            return;
        }
        debuglog('recognizing nothing');
        u.intent = "None";
        u.score = 0.1;
        var e1 = {};
        e1.startIndex = "exit ".length;
        e1.endIndex = context.message.text.length;
        e1.score = 0.1;
        u.entities = [];
        callback(undefined, u);
    };
    return RegExpRecognizer;
}();
exports.RegExpRecognizer = RegExpRecognizer; // class
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ib3QvcGxhaW5yZWNvZ25pemVyLnRzIiwiYm90L3BsYWlucmVjb2duaXplci5qcyJdLCJuYW1lcyI6WyJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsIkFueU9iamVjdCIsIk9iamVjdCIsInJlY29nbml6ZSIsInNTdHJpbmciLCJtUnVsZXMiLCJyZXMiLCJ1bmRlZmluZWQiLCJldmVyeSIsIm9SdWxlIiwibWF0Y2hSZWd1bGFyRXhwcmVzc2lvbiIsImV4cG9ydHMiLCJjb3VudFBhcmVuR3JvdXBzIiwicyIsImkiLCJsZW5ndGgiLCJjaGFyQXQiLCJwYXJzZVJ1bGVTdHJpbmciLCJhIiwiYXJnTWFwcyIsIm0iLCJleGVjIiwiY2F0IiwiZ3JlZWR5IiwicG9zIiwic3Vic3RyaW5nIiwiaW5kZXgiLCJyZXBsYWNlIiwiRXJyb3IiLCJ0eXBlIiwicmVnZXhwIiwiUmVnRXhwIiwiYXJnc01hcCIsInBhcnNlUnVsZUFycmF5IiwiciIsIkpTT04iLCJzdHJpbmdpZnkiLCJwYXJzZVJ1bGUiLCJBcnJheSIsImlzQXJyYXkiLCJwYXJzZVJ1bGVzIiwib0pTT04iLCJrZXlzIiwiZm9yRWFjaCIsInNLZXkiLCJtYXAiLCJ0cmltVmFsdWVBZGp1c3RpbmciLCJ2YWx1ZSIsImRlbHRhU3RhcnQiLCJtYXRjaCIsInN1YnN0ciIsImV4dHJhY3RBcmdzTWFwIiwicmVzdWx0IiwiZW50aXR5Iiwic3RhcnRJbmRleCIsImluZGV4T2YiLCJ0cmltQWRqdXN0IiwiZW5kSW5kZXgiLCJwdXNoIiwidGV4dCIsInRvU3RyaW5nIiwiZW50aXRpZXMiLCJzY29yZSIsInRyaW1UcmFpbGluZ1NlbnRlbmNlRGVsaW1pdGVycyIsIm5vcm1hbGl6ZVdoaXRlc3BhY2UiLCJjb21wYWN0UXVvdGVkIiwiY291bnRDb21wYWN0V29yZHMiLCJzcGxpdCIsImNoZWNrRm9yTGVuZ3RoIiwidGV4dFN0cmlwcGVkIiwiaW50ZW50IiwicmVjb2duaXplVGV4dCIsImFSdWxlcyIsIlJlZ0V4cFJlY29nbml6ZXIiLCJ4UnVsZXMiLCJvUnVsZXMiLCJwcm90b3R5cGUiLCJjb250ZXh0IiwiY2FsbGJhY2siLCJ1IiwibWVzc2FnZSIsInRoYXQiLCJyZXN1bHRzIiwiZmlsdGVyIiwibyIsImUxIl0sIm1hcHBpbmdzIjoiQUFDQTs7Ozs7O0FDS0E7O0FES0EsSUFBWUEsUUFBS0MsUUFBTSxPQUFOLENBQWpCO0FBQ0EsSUFBTUMsV0FBV0YsTUFBTSxpQkFBTixDQUFqQjtBQUVBLElBQU1HLFlBQVlDLE1BQWxCO0FBRUEsU0FBQUMsU0FBQSxDQUEwQkMsT0FBMUIsRUFBbUNDLE1BQW5DLEVBQW1FO0FBQ2pFLFFBQUlDLE1BQU1DLFNBQVY7QUFDQUYsV0FBT0csS0FBUCxDQUFhLFVBQVVDLEtBQVYsRUFBZTtBQUMxQkgsY0FBTUksdUJBQXVCTixPQUF2QixFQUFnQ0ssS0FBaEMsQ0FBTjtBQUNBLGVBQU8sQ0FBQ0gsR0FBUjtBQUNELEtBSEQ7QUFJQSxXQUFPQSxHQUFQO0FBQ0Q7QUFQZUssUUFBQVIsU0FBQSxHQUFTQSxTQUFUO0FBU2hCLFNBQUFTLGdCQUFBLENBQWlDQyxDQUFqQyxFQUEwQztBQUN4QyxRQUFJUCxNQUFNLENBQVY7QUFDQSxTQUFLLElBQUlRLElBQUksQ0FBYixFQUFnQkEsSUFBSUQsRUFBRUUsTUFBdEIsRUFBOEIsRUFBRUQsQ0FBaEMsRUFBbUM7QUFDakMsWUFBSUQsRUFBRUcsTUFBRixDQUFTRixDQUFULE1BQWdCLEdBQXBCLEVBQXlCO0FBQ3ZCLGNBQUVSLEdBQUY7QUFDRDtBQUNGO0FBQ0QsV0FBT0EsR0FBUDtBQUNEO0FBUmVLLFFBQUFDLGdCQUFBLEdBQWdCQSxnQkFBaEI7QUFVaEI7Ozs7OztBQU1BLFNBQUFLLGVBQUEsQ0FBZ0NDLENBQWhDLEVBQXlDO0FBQ3ZDLFFBQUlMLElBQUksTUFBTUssQ0FBTixHQUFVLEdBQWxCO0FBQ0EsUUFBSUMsVUFBVSxFQUFkO0FBQ0EsUUFBSUMsSUFBSWIsU0FBUjtBQUNBLFdBQU9hLElBQUksa0JBQWtCQyxJQUFsQixDQUF1QlIsQ0FB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a0JBQUVULE1BQUYsR0FBVzFCLElBQVg7QUFDRDtBQUNELG1CQUFPbUMsSUFBS0EsQ0FBTCxHQUFTeEUsU0FBaEI7QUFDRCxTQU5hLEVBTVg0RSxNQU5XLENBTUosVUFBVUMsQ0FBVixFQUFXO0FBQUksbUJBQU8sQ0FBQyxDQUFDQSxDQUFUO0FBQWEsU0FOeEIsQ0FBZDtBQU9BLFlBQUlGLFFBQVFuRSxNQUFSLEdBQWlCLENBQXJCLEVBQXdCO0FBQ3RCO0FBQ0FmLHFCQUFTLDJCQUEyQjJELElBQTNCLEdBQWtDLEdBQWxDLEdBQXdDeEIsS0FBS0MsU0FBTCxDQUFlOUIsR0FBZixDQUFqRDtBQUNEO0FBQ0QsWUFBSTRFLFFBQVFuRSxNQUFSLEdBQWlCLENBQXJCLEVBQXdCO0FBQ3RCLGdCQUFJVCxNQUFNNEUsUUFBUSxDQUFSLENBQVY7QUFDQUoscUJBQVN2RSxTQUFULEVBQW9CRCxHQUFwQjtBQUNBO0FBQ0Q7QUFDRE4saUJBQVMscUJBQVQ7QUFDQStFLFVBQUVULE1BQUYsR0FBVyxNQUFYO0FBQ0FTLFVBQUVqQixLQUFGLEdBQVUsR0FBVjtBQUNBLFlBQUl1QixLQUFLLEVBQVQ7QUFDQUEsV0FBRy9CLFVBQUgsR0FBZ0IsUUFBUXZDLE1BQXhCO0FBQ0FzRSxXQUFHNUIsUUFBSCxHQUFjb0IsUUFBUUcsT0FBUixDQUFnQnJCLElBQWhCLENBQXFCNUMsTUFBbkM7QUFDQXNFLFdBQUd2QixLQUFILEdBQVcsR0FBWDtBQUNBaUIsVUFBRWxCLFFBQUYsR0FBYSxFQUFiO0FBQ0FpQixpQkFBU3ZFLFNBQVQsRUFBb0J3RSxDQUFwQjtBQUNELEtBdENEO0FBdUNGLFdBQUFOLGdCQUFBO0FBL0NBLENBQUEsRUFBQTtBQUFhOUQsUUFBQThELGdCQUFBLEdBQWdCQSxnQkFBaEIsQyxDQStDWCIsImZpbGUiOiJib3QvcGxhaW5yZWNvZ25pemVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vKipcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqIEBmaWxlIHBsYWlucmVjb2duaXplci50c1xuICpcbiAqIEEgcmVjb2duaXplciBwYXJhbWV0cml6ZWQgYnkgcmVnZXggZXhwcmVzc2lvbnNcbiAqL1xuXG5pbXBvcnQgKiBhcyBidWlsZGVyIGZyb20gJ2JvdGJ1aWxkZXInO1xuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXIgZnJvbSAnLi4vbWF0Y2gvaW5wdXRGaWx0ZXInO1xuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygncGxhaW5yZWNvZ25pemVyJyk7XG5cbmNvbnN0IEFueU9iamVjdCA9IE9iamVjdCBhcyBhbnk7XG5cbmV4cG9ydCBmdW5jdGlvbiByZWNvZ25pemUoc1N0cmluZywgbVJ1bGVzOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4pIHtcbiAgdmFyIHJlcyA9IHVuZGVmaW5lZDtcbiAgbVJ1bGVzLmV2ZXJ5KGZ1bmN0aW9uIChvUnVsZSkge1xuICAgIHJlcyA9IG1hdGNoUmVndWxhckV4cHJlc3Npb24oc1N0cmluZywgb1J1bGUpO1xuICAgIHJldHVybiAhcmVzO1xuICB9KVxuICByZXR1cm4gcmVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY291bnRQYXJlbkdyb3VwcyhzOiBzdHJpbmcpIHtcbiAgdmFyIHJlcyA9IDA7XG4gIGZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7ICsraSkge1xuICAgIGlmIChzLmNoYXJBdChpKSA9PT0gJygnKSB7XG4gICAgICArK3JlcztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlcztcbn1cblxuLyoqXG4gKiBnaXZlbiBhIHN0cmluZywgZS5nLlxuICogXCJ3aG8gaXMgdGhlIDxjYXRlZ29yeT4gb2YgPEExPlwiLFxuICogQHBhcmFtIHtzdHJpbmd9IGFcbiAqIEByZXR1cm5zIHtJTWF0Y2guSVJ1bGV9IGEgcmVnZXhwIHJ1bGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlUnVsZVN0cmluZyhhOiBzdHJpbmcpOiBJTWF0Y2guSW50ZW50UnVsZSB7XG4gIHZhciBzID0gXCJeXCIgKyBhICsgXCIkXCI7XG4gIHZhciBhcmdNYXBzID0ge307XG4gIHZhciBtID0gdW5kZWZpbmVkO1xuICB3aGlsZSAobSA9IC88KFtePl0rKT4oWz9dPykvLmV4ZWMocykpIHtcbiAgICB2YXIgY2F0ID0gbVsxXTtcbiAgICB2YXIgZ3JlZWR5ID0gbVsyXTtcbiAgICB2YXIgcG9zID0gMSArIGNvdW50UGFyZW5Hcm91cHMocy5zdWJzdHJpbmcoMCwgbS5pbmRleCkpO1xuICAgIGlmKGdyZWVkeSkge1xuICAgICAgcyA9IHMucmVwbGFjZShcIjxcIiArIGNhdCArIFwiPj9cIiwgXCIoLio/KVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzID0gcy5yZXBsYWNlKFwiPFwiICsgY2F0ICsgXCI+XCIsIFwiKC4qKVwiKTtcbiAgICAgIH1cbiAgICBpZiAoYXJnTWFwc1tjYXRdKSB7XG4gICAgICB0aHJvdyBFcnJvcihcIk1vZGVsIGVycm9yIGR1cGxpY2F0ZSBlbnRyeSFcIilcbiAgICB9XG4gICAgYXJnTWFwc1tjYXRdID0gcG9zO1xuICB9XG4gIHJldHVybiB7XG4gICAgdHlwZTogMSxcbiAgICByZWdleHA6IG5ldyBSZWdFeHAocywgXCJpXCIpLFxuICAgIGFyZ3NNYXA6IGFyZ01hcHNcbiAgfTtcbn1cblxuXG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VSdWxlQXJyYXkoYTogQXJyYXk8YW55Pik6IElNYXRjaC5JbnRlbnRSdWxlIHtcbiAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgdmFyIHIgPSBhWzBdO1xuICBpZih0eXBlb2YgYVswXSA9PT0gXCJzdHJpbmdcIikge1xuICAgIHIgPSBuZXcgUmVnRXhwKGFbMF0sXCJpXCIpO1xuICB9XG4gIGlmICghKHIgaW5zdGFuY2VvZiBSZWdFeHApKSB7XG4gICAgdGhyb3cgRXJyb3IoXCJpbGxlZ2FsIHN0YXRlXCIgKyBKU09OLnN0cmluZ2lmeShhKSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAxLFxuICAgIHJlZ2V4cDogcixcbiAgICBhcmdzTWFwOiBhWzFdXG4gIH07XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlUnVsZShhOiBhbnkpOiBJTWF0Y2guSW50ZW50UnVsZSB7XG4gIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gcGFyc2VSdWxlU3RyaW5nKGEpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoYSkpIHtcbiAgICByZXR1cm4gcGFyc2VSdWxlQXJyYXkoYSk7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKFwidW5rbm93biBydWxlIGRlZmluaXRpb25cIik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVJ1bGVzKG9KU09OOiB7IFtrZXk6IHN0cmluZ106IGFueSB9KTogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4gfSB7XG4gIHZhciByZXMgPSB7fTtcbiAgT2JqZWN0LmtleXMob0pTT04pLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICByZXNbc0tleV0gPSBvSlNPTltzS2V5XS5tYXAoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICByZXR1cm4gcGFyc2VSdWxlKG9SdWxlKTtcbiAgICB9KVxuICB9KTtcbiAgcmV0dXJuIHJlcztcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiB0cmltVmFsdWVBZGp1c3RpbmcodmFsdWUgOiBzdHJpbmcpIDogeyBkZWx0YVN0YXJ0IDpudW1iZXIsIHZhbHVlIDogc3RyaW5nfSB7XG4gIHZhciByZXMgPSB7IGRlbHRhU3RhcnQgOiAwLCB2YWx1ZSA6IHZhbHVlIH07XG4gIHZhciBtID0gdmFsdWUubWF0Y2goL15cXHMrLyk7XG4gIGlmKG0pIHtcbiAgICByZXMuZGVsdGFTdGFydCA9IG1bMF0ubGVuZ3RoO1xuICAgIHZhbHVlID0gdmFsdWUuc3Vic3RyKHJlcy5kZWx0YVN0YXJ0KTtcbiAgfVxuICBtID0gdmFsdWUubWF0Y2goL1xccyskLyk7XG4gIGlmKG0pIHtcbiAgICB2YWx1ZSA9IHZhbHVlLnN1YnN0cigwLCB2YWx1ZS5sZW5ndGggLSBtWzBdLmxlbmd0aCk7XG4gIH1cbiAgcmVzLnZhbHVlID0gdmFsdWU7XG4gIHJldHVybiByZXM7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4dHJhY3RBcmdzTWFwKHMgOiBzdHJpbmcsIG1hdGNoOiBBcnJheTxzdHJpbmc+LCBhcmdzTWFwOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9KTogQXJyYXk8YnVpbGRlci5JRW50aXR5PiB7XG4gIGlmICghYXJnc01hcCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuICB2YXIgcmVzdWx0ID0gW107XG4gIE9iamVjdC5rZXlzKGFyZ3NNYXApLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICB2YXIgcmVzID0ge30gYXMgYnVpbGRlci5JRW50aXR5O1xuICAgIHZhciBpbmRleCA9IGFyZ3NNYXBbc0tleV07XG4gICAgdmFyIHZhbHVlID0gbWF0Y2hbaW5kZXhdXG4gICAgaWYgKCh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpICYmIHZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgIHJlcy50eXBlID0gc0tleTtcbiAgICAgIHJlcy5lbnRpdHkgPSB2YWx1ZTtcbiAgICAgIHJlcy5zdGFydEluZGV4ID0gcy5pbmRleE9mKHZhbHVlKTsgLy8gdGhpcyBtYXkgbm90IGJlIHByZWNpc2VcbiAgICAgIHZhciB0cmltQWRqdXN0ID0gdHJpbVZhbHVlQWRqdXN0aW5nKHZhbHVlKTtcbiAgICAgIHJlcy5zdGFydEluZGV4ICs9IHRyaW1BZGp1c3QuZGVsdGFTdGFydDtcbiAgICAgIHJlcy5lbnRpdHkgPSB0cmltQWRqdXN0LnZhbHVlO1xuICAgICAgcmVzLmVuZEluZGV4ID0gcmVzLnN0YXJ0SW5kZXggKyB0cmltQWRqdXN0LnZhbHVlLmxlbmd0aDtcbiAgICAgIC8vcmVzW3NLZXldID0gdmFsdWVcbiAgICAgIHJlc3VsdC5wdXNoKHJlcyk7XG4gICAgfVxuICB9XG4gICk7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHRleHQgOiBzdHJpbmcsIG9SdWxlIDogSU1hdGNoLkludGVudFJ1bGUpIDogYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdCB7XG4gIGRlYnVnbG9nKFwicmVnZXhwIGlzIFwiICsgb1J1bGUucmVnZXhwLnRvU3RyaW5nKCkpO1xuICBkZWJ1Z2xvZyhcIiB0ZXh0IGlzIFwiICsgdGV4dCk7XG4gIHZhciBtID0gb1J1bGUucmVnZXhwLmV4ZWModGV4dCk7XG4gIGlmICghbSkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgdmFyIHJlcyA9IHt9IGFzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQ7XG4gIHJlcy5lbnRpdGllcyA9IGV4dHJhY3RBcmdzTWFwKHRleHQsIG0sIG9SdWxlLmFyZ3NNYXApO1xuICByZXMuc2NvcmUgPSAwLjk7XG4gIGRlYnVnbG9nKFwibWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtKSk7XG4gIGRlYnVnbG9nKCdGb3VuZCBvbmUnICsgSlNPTi5zdHJpbmdpZnkocmVzLCB1bmRlZmluZWQsIDIpKTtcbiAgcmV0dXJuIHJlcztcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gdHJpbVRyYWlsaW5nU2VudGVuY2VEZWxpbWl0ZXJzKHRleHQgOiBzdHJpbmcpIDogc3RyaW5nIHtcbiAgdmFyIG0gPSAvKFshLjssID9dfFxccykrJC8uZXhlYyh0ZXh0KTtcbiAgaWYgKG0pIHtcbiAgICB0ZXh0ID0gdGV4dC5zdWJzdHIoMCx0ZXh0Lmxlbmd0aC0gbVswXS5sZW5ndGgpO1xuICB9XG4gIHJldHVybiB0ZXh0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplV2hpdGVzcGFjZSh0ZXh0IDogc3RyaW5nKSA6IHN0cmluZyB7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1xccysvZywnICcpO1xuICByZXR1cm4gdGV4dDtcbn1cblxuLyoqXG4gKiBHaXZlbmEgc3RyaW5nLCByZXBsYWNlIGFsbCBcIi4uLi4uXCIgIHdpdGggPHdvcmQ+XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21wYWN0UXVvdGVkKHRleHQ6IHN0cmluZykgOiBzdHJpbmcge1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cIlteXCJdK1wiL2csIFwiPHdvcmQ+XCIpO1xuICByZXR1cm4gdGV4dDtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gY291bnRDb21wYWN0V29yZHModGV4dDogc3RyaW5nKSA6IG51bWJlciB7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoLywvZywgJyAnKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvIFxccysvZywgJyAnKTtcbiAgcmV0dXJuIHRleHQuc3BsaXQoXCIgXCIpLmxlbmd0aDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrRm9yTGVuZ3RoKHRleHQpIDogYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdCB7XG4gICAgdmFyIHRleHRTdHJpcHBlZCA9IHRyaW1UcmFpbGluZ1NlbnRlbmNlRGVsaW1pdGVycyh0ZXh0KTtcbiAgICBpZigodGV4dFN0cmlwcGVkLmxlbmd0aCA+IDIwMCkgfHwgKGNvdW50Q29tcGFjdFdvcmRzKGNvbXBhY3RRdW90ZWQodGV4dCkpID4gMjApKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpbnRlbnQ6IFwiVG9vTG9uZ1wiLFxuICAgICAgICBzY29yZSA6IDEuMCxcbiAgICAgICAgZW50aXRpZXMgOiBbXVxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlY29nbml6ZVRleHQodGV4dCA6IHN0cmluZywgYVJ1bGVzIDogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+KSA6IGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHR7XG4gICAgdmFyIHJlcyA9IHVuZGVmaW5lZDtcbiAgICBhUnVsZXMuZXZlcnkoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICAgIHJlcyA9IG1hdGNoUmVndWxhckV4cHJlc3Npb24odGV4dCwgb1J1bGUpO1xuICAgICAgICByZXR1cm4gIXJlcztcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuXG5leHBvcnQgY2xhc3MgUmVnRXhwUmVjb2duaXplciBpbXBsZW1lbnRzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXIge1xuICBvUnVsZXM6IHsgW2tleTogc3RyaW5nXTogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+IH07XG5cbiAgY29uc3RydWN0b3IoeFJ1bGVzOiB7IFtrZXk6IHN0cmluZ106IEFycmF5PElNYXRjaC5JbnRlbnRSdWxlPiB9KSB7XG4gICAgdGhpcy5vUnVsZXMgPSB4UnVsZXM7XG4gICAgZGVidWdsb2coXCJydWxlcyBcIiArIEpTT04uc3RyaW5naWZ5KHRoaXMub1J1bGVzKSk7XG4gIH07XG5cbiAgcmVjb2duaXplKGNvbnRleHQ6IGJ1aWxkZXIuSVJlY29nbml6ZUNvbnRleHQsIGNhbGxiYWNrOiAoZXJyOiBFcnJvciwgcmVzdWx0OiBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdmFyIHUgPSB7fSBhcyBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0O1xuICAgIHZhciB0ZXh0ID0gY29udGV4dC5tZXNzYWdlLnRleHQ7XG4gICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgIHZhciByID0gY2hlY2tGb3JMZW5ndGgodGV4dCk7XG4gICAgaWYocikge1xuICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLHIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkZWJ1Z2xvZyhcInJ1bGVzIFwiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5vUnVsZXMpKTtcblxuICAgIHZhciB0ZXh0ID0gdHJpbVRyYWlsaW5nU2VudGVuY2VEZWxpbWl0ZXJzKHRleHQpO1xuXG4gICAgdmFyIHJlc3VsdHMgPSBPYmplY3Qua2V5cyh0aGlzLm9SdWxlcykubWFwKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgICB2YXIgdSA9IHJlY29nbml6ZVRleHQodGV4dCwgdGhhdC5vUnVsZXNbc0tleV0pO1xuICAgICAgaWYgKHUpIHtcbiAgICAgICAgdS5pbnRlbnQgPSBzS2V5O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHUgPyAgdSA6IHVuZGVmaW5lZDtcbiAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKG8pIHsgcmV0dXJuICEhbzsgfSk7XG4gICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMSkge1xuICAgICAgLyogVE9ETyBhYmlndW91cyAqL1xuICAgICAgZGVidWdsb2coXCJhbWJpZ3VvdXMgcmVzdWx0IGZvciA+XCIgKyB0ZXh0ICsgXCI8XCIgKyBKU09OLnN0cmluZ2lmeShyZXMpKTtcbiAgICB9XG4gICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMCkge1xuICAgICAgdmFyIHJlcyA9IHJlc3VsdHNbMF07XG4gICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHJlcyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGRlYnVnbG9nKCdyZWNvZ25pemluZyBub3RoaW5nJyk7XG4gICAgdS5pbnRlbnQgPSBcIk5vbmVcIjtcbiAgICB1LnNjb3JlID0gMC4xO1xuICAgIHZhciBlMSA9IHt9IGFzIGJ1aWxkZXIuSUVudGl0eTtcbiAgICBlMS5zdGFydEluZGV4ID0gXCJleGl0IFwiLmxlbmd0aDtcbiAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICBlMS5zY29yZSA9IDAuMTtcbiAgICB1LmVudGl0aWVzID0gW107XG4gICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgfVxufSAvLyBjbGFzc1xuXG5cblxuIiwiLyoqXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKiBAZmlsZSBwbGFpbnJlY29nbml6ZXIudHNcbiAqXG4gKiBBIHJlY29nbml6ZXIgcGFyYW1ldHJpemVkIGJ5IHJlZ2V4IGV4cHJlc3Npb25zXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdwbGFpbnJlY29nbml6ZXInKTtcbnZhciBBbnlPYmplY3QgPSBPYmplY3Q7XG5mdW5jdGlvbiByZWNvZ25pemUoc1N0cmluZywgbVJ1bGVzKSB7XG4gICAgdmFyIHJlcyA9IHVuZGVmaW5lZDtcbiAgICBtUnVsZXMuZXZlcnkoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICAgIHJlcyA9IG1hdGNoUmVndWxhckV4cHJlc3Npb24oc1N0cmluZywgb1J1bGUpO1xuICAgICAgICByZXR1cm4gIXJlcztcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5yZWNvZ25pemUgPSByZWNvZ25pemU7XG5mdW5jdGlvbiBjb3VudFBhcmVuR3JvdXBzKHMpIHtcbiAgICB2YXIgcmVzID0gMDtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgaWYgKHMuY2hhckF0KGkpID09PSAnKCcpIHtcbiAgICAgICAgICAgICsrcmVzO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmNvdW50UGFyZW5Hcm91cHMgPSBjb3VudFBhcmVuR3JvdXBzO1xuLyoqXG4gKiBnaXZlbiBhIHN0cmluZywgZS5nLlxuICogXCJ3aG8gaXMgdGhlIDxjYXRlZ29yeT4gb2YgPEExPlwiLFxuICogQHBhcmFtIHtzdHJpbmd9IGFcbiAqIEByZXR1cm5zIHtJTWF0Y2guSVJ1bGV9IGEgcmVnZXhwIHJ1bGVcbiAqL1xuZnVuY3Rpb24gcGFyc2VSdWxlU3RyaW5nKGEpIHtcbiAgICB2YXIgcyA9IFwiXlwiICsgYSArIFwiJFwiO1xuICAgIHZhciBhcmdNYXBzID0ge307XG4gICAgdmFyIG0gPSB1bmRlZmluZWQ7XG4gICAgd2hpbGUgKG0gPSAvPChbXj5dKyk+KFs/XT8pLy5leGVjKHMpKSB7XG4gICAgICAgIHZhciBjYXQgPSBtWzFdO1xuICAgICAgICB2YXIgZ3JlZWR5ID0gbVsyXTtcbiAgICAgICAgdmFyIHBvcyA9IDEgKyBjb3VudFBhcmVuR3JvdXBzKHMuc3Vic3RyaW5nKDAsIG0uaW5kZXgpKTtcbiAgICAgICAgaWYgKGdyZWVkeSkge1xuICAgICAgICAgICAgcyA9IHMucmVwbGFjZShcIjxcIiArIGNhdCArIFwiPj9cIiwgXCIoLio/KVwiKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHMgPSBzLnJlcGxhY2UoXCI8XCIgKyBjYXQgKyBcIj5cIiwgXCIoLiopXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhcmdNYXBzW2NhdF0pIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFwiTW9kZWwgZXJyb3IgZHVwbGljYXRlIGVudHJ5IVwiKTtcbiAgICAgICAgfVxuICAgICAgICBhcmdNYXBzW2NhdF0gPSBwb3M7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IDEsXG4gICAgICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChzLCBcImlcIiksXG4gICAgICAgIGFyZ3NNYXA6IGFyZ01hcHNcbiAgICB9O1xufVxuZXhwb3J0cy5wYXJzZVJ1bGVTdHJpbmcgPSBwYXJzZVJ1bGVTdHJpbmc7XG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5mdW5jdGlvbiBwYXJzZVJ1bGVBcnJheShhKSB7XG4gICAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgICB2YXIgciA9IGFbMF07XG4gICAgaWYgKHR5cGVvZiBhWzBdID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHIgPSBuZXcgUmVnRXhwKGFbMF0sIFwiaVwiKTtcbiAgICB9XG4gICAgaWYgKCEociBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXCJpbGxlZ2FsIHN0YXRlXCIgKyBKU09OLnN0cmluZ2lmeShhKSk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IDEsXG4gICAgICAgIHJlZ2V4cDogcixcbiAgICAgICAgYXJnc01hcDogYVsxXVxuICAgIH07XG59XG5leHBvcnRzLnBhcnNlUnVsZUFycmF5ID0gcGFyc2VSdWxlQXJyYXk7XG5mdW5jdGlvbiBwYXJzZVJ1bGUoYSkge1xuICAgIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIHBhcnNlUnVsZVN0cmluZyhhKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShhKSkge1xuICAgICAgICByZXR1cm4gcGFyc2VSdWxlQXJyYXkoYSk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihcInVua25vd24gcnVsZSBkZWZpbml0aW9uXCIpO1xufVxuZXhwb3J0cy5wYXJzZVJ1bGUgPSBwYXJzZVJ1bGU7XG5mdW5jdGlvbiBwYXJzZVJ1bGVzKG9KU09OKSB7XG4gICAgdmFyIHJlcyA9IHt9O1xuICAgIE9iamVjdC5rZXlzKG9KU09OKS5mb3JFYWNoKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgICAgIHJlc1tzS2V5XSA9IG9KU09OW3NLZXldLm1hcChmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJzZVJ1bGUob1J1bGUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5wYXJzZVJ1bGVzID0gcGFyc2VSdWxlcztcbjtcbmZ1bmN0aW9uIHRyaW1WYWx1ZUFkanVzdGluZyh2YWx1ZSkge1xuICAgIHZhciByZXMgPSB7IGRlbHRhU3RhcnQ6IDAsIHZhbHVlOiB2YWx1ZSB9O1xuICAgIHZhciBtID0gdmFsdWUubWF0Y2goL15cXHMrLyk7XG4gICAgaWYgKG0pIHtcbiAgICAgICAgcmVzLmRlbHRhU3RhcnQgPSBtWzBdLmxlbmd0aDtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5zdWJzdHIocmVzLmRlbHRhU3RhcnQpO1xuICAgIH1cbiAgICBtID0gdmFsdWUubWF0Y2goL1xccyskLyk7XG4gICAgaWYgKG0pIHtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5zdWJzdHIoMCwgdmFsdWUubGVuZ3RoIC0gbVswXS5sZW5ndGgpO1xuICAgIH1cbiAgICByZXMudmFsdWUgPSB2YWx1ZTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy50cmltVmFsdWVBZGp1c3RpbmcgPSB0cmltVmFsdWVBZGp1c3Rpbmc7XG5mdW5jdGlvbiBleHRyYWN0QXJnc01hcChzLCBtYXRjaCwgYXJnc01hcCkge1xuICAgIGlmICghYXJnc01hcCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHZhciByZXN1bHQgPSBbXTtcbiAgICBPYmplY3Qua2V5cyhhcmdzTWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgICAgIHZhciByZXMgPSB7fTtcbiAgICAgICAgdmFyIGluZGV4ID0gYXJnc01hcFtzS2V5XTtcbiAgICAgICAgdmFyIHZhbHVlID0gbWF0Y2hbaW5kZXhdO1xuICAgICAgICBpZiAoKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikgJiYgdmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmVzLnR5cGUgPSBzS2V5O1xuICAgICAgICAgICAgcmVzLmVudGl0eSA9IHZhbHVlO1xuICAgICAgICAgICAgcmVzLnN0YXJ0SW5kZXggPSBzLmluZGV4T2YodmFsdWUpOyAvLyB0aGlzIG1heSBub3QgYmUgcHJlY2lzZVxuICAgICAgICAgICAgdmFyIHRyaW1BZGp1c3QgPSB0cmltVmFsdWVBZGp1c3RpbmcodmFsdWUpO1xuICAgICAgICAgICAgcmVzLnN0YXJ0SW5kZXggKz0gdHJpbUFkanVzdC5kZWx0YVN0YXJ0O1xuICAgICAgICAgICAgcmVzLmVudGl0eSA9IHRyaW1BZGp1c3QudmFsdWU7XG4gICAgICAgICAgICByZXMuZW5kSW5kZXggPSByZXMuc3RhcnRJbmRleCArIHRyaW1BZGp1c3QudmFsdWUubGVuZ3RoO1xuICAgICAgICAgICAgLy9yZXNbc0tleV0gPSB2YWx1ZVxuICAgICAgICAgICAgcmVzdWx0LnB1c2gocmVzKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG59XG5leHBvcnRzLmV4dHJhY3RBcmdzTWFwID0gZXh0cmFjdEFyZ3NNYXA7XG5mdW5jdGlvbiBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHRleHQsIG9SdWxlKSB7XG4gICAgZGVidWdsb2coXCJyZWdleHAgaXMgXCIgKyBvUnVsZS5yZWdleHAudG9TdHJpbmcoKSk7XG4gICAgZGVidWdsb2coXCIgdGV4dCBpcyBcIiArIHRleHQpO1xuICAgIHZhciBtID0gb1J1bGUucmVnZXhwLmV4ZWModGV4dCk7XG4gICAgaWYgKCFtKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHZhciByZXMgPSB7fTtcbiAgICByZXMuZW50aXRpZXMgPSBleHRyYWN0QXJnc01hcCh0ZXh0LCBtLCBvUnVsZS5hcmdzTWFwKTtcbiAgICByZXMuc2NvcmUgPSAwLjk7XG4gICAgZGVidWdsb2coXCJtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG0pKTtcbiAgICBkZWJ1Z2xvZygnRm91bmQgb25lJyArIEpTT04uc3RyaW5naWZ5KHJlcywgdW5kZWZpbmVkLCAyKSk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMubWF0Y2hSZWd1bGFyRXhwcmVzc2lvbiA9IG1hdGNoUmVndWxhckV4cHJlc3Npb247XG5mdW5jdGlvbiB0cmltVHJhaWxpbmdTZW50ZW5jZURlbGltaXRlcnModGV4dCkge1xuICAgIHZhciBtID0gLyhbIS47LCA/XXxcXHMpKyQvLmV4ZWModGV4dCk7XG4gICAgaWYgKG0pIHtcbiAgICAgICAgdGV4dCA9IHRleHQuc3Vic3RyKDAsIHRleHQubGVuZ3RoIC0gbVswXS5sZW5ndGgpO1xuICAgIH1cbiAgICByZXR1cm4gdGV4dDtcbn1cbmV4cG9ydHMudHJpbVRyYWlsaW5nU2VudGVuY2VEZWxpbWl0ZXJzID0gdHJpbVRyYWlsaW5nU2VudGVuY2VEZWxpbWl0ZXJzO1xuZnVuY3Rpb24gbm9ybWFsaXplV2hpdGVzcGFjZSh0ZXh0KSB7XG4gICAgdGV4dCA9IHRleHQucmVwbGFjZSgvXFxzKy9nLCAnICcpO1xuICAgIHJldHVybiB0ZXh0O1xufVxuZXhwb3J0cy5ub3JtYWxpemVXaGl0ZXNwYWNlID0gbm9ybWFsaXplV2hpdGVzcGFjZTtcbi8qKlxuICogR2l2ZW5hIHN0cmluZywgcmVwbGFjZSBhbGwgXCIuLi4uLlwiICB3aXRoIDx3b3JkPlxuICovXG5mdW5jdGlvbiBjb21wYWN0UXVvdGVkKHRleHQpIHtcbiAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cIlteXCJdK1wiL2csIFwiPHdvcmQ+XCIpO1xuICAgIHJldHVybiB0ZXh0O1xufVxuZXhwb3J0cy5jb21wYWN0UXVvdGVkID0gY29tcGFjdFF1b3RlZDtcbmZ1bmN0aW9uIGNvdW50Q29tcGFjdFdvcmRzKHRleHQpIHtcbiAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8sL2csICcgJyk7XG4gICAgdGV4dCA9IHRleHQucmVwbGFjZSgvIFxccysvZywgJyAnKTtcbiAgICByZXR1cm4gdGV4dC5zcGxpdChcIiBcIikubGVuZ3RoO1xufVxuZXhwb3J0cy5jb3VudENvbXBhY3RXb3JkcyA9IGNvdW50Q29tcGFjdFdvcmRzO1xuZnVuY3Rpb24gY2hlY2tGb3JMZW5ndGgodGV4dCkge1xuICAgIHZhciB0ZXh0U3RyaXBwZWQgPSB0cmltVHJhaWxpbmdTZW50ZW5jZURlbGltaXRlcnModGV4dCk7XG4gICAgaWYgKCh0ZXh0U3RyaXBwZWQubGVuZ3RoID4gMjAwKSB8fCAoY291bnRDb21wYWN0V29yZHMoY29tcGFjdFF1b3RlZCh0ZXh0KSkgPiAyMCkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGludGVudDogXCJUb29Mb25nXCIsXG4gICAgICAgICAgICBzY29yZTogMS4wLFxuICAgICAgICAgICAgZW50aXRpZXM6IFtdXG4gICAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG59XG5leHBvcnRzLmNoZWNrRm9yTGVuZ3RoID0gY2hlY2tGb3JMZW5ndGg7XG5mdW5jdGlvbiByZWNvZ25pemVUZXh0KHRleHQsIGFSdWxlcykge1xuICAgIHZhciByZXMgPSB1bmRlZmluZWQ7XG4gICAgYVJ1bGVzLmV2ZXJ5KGZ1bmN0aW9uIChvUnVsZSkge1xuICAgICAgICByZXMgPSBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHRleHQsIG9SdWxlKTtcbiAgICAgICAgcmV0dXJuICFyZXM7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMucmVjb2duaXplVGV4dCA9IHJlY29nbml6ZVRleHQ7XG52YXIgUmVnRXhwUmVjb2duaXplciA9IChmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gUmVnRXhwUmVjb2duaXplcih4UnVsZXMpIHtcbiAgICAgICAgdGhpcy5vUnVsZXMgPSB4UnVsZXM7XG4gICAgICAgIGRlYnVnbG9nKFwicnVsZXMgXCIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLm9SdWxlcykpO1xuICAgIH1cbiAgICA7XG4gICAgUmVnRXhwUmVjb2duaXplci5wcm90b3R5cGUucmVjb2duaXplID0gZnVuY3Rpb24gKGNvbnRleHQsIGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciB1ID0ge307XG4gICAgICAgIHZhciB0ZXh0ID0gY29udGV4dC5tZXNzYWdlLnRleHQ7XG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgdmFyIHIgPSBjaGVja0Zvckxlbmd0aCh0ZXh0KTtcbiAgICAgICAgaWYgKHIpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgcik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZGVidWdsb2coXCJydWxlcyBcIiArIEpTT04uc3RyaW5naWZ5KHRoaXMub1J1bGVzKSk7XG4gICAgICAgIHZhciB0ZXh0ID0gdHJpbVRyYWlsaW5nU2VudGVuY2VEZWxpbWl0ZXJzKHRleHQpO1xuICAgICAgICB2YXIgcmVzdWx0cyA9IE9iamVjdC5rZXlzKHRoaXMub1J1bGVzKS5tYXAoZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgICAgICAgIHZhciB1ID0gcmVjb2duaXplVGV4dCh0ZXh0LCB0aGF0Lm9SdWxlc1tzS2V5XSk7XG4gICAgICAgICAgICBpZiAodSkge1xuICAgICAgICAgICAgICAgIHUuaW50ZW50ID0gc0tleTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB1ID8gdSA6IHVuZGVmaW5lZDtcbiAgICAgICAgfSkuZmlsdGVyKGZ1bmN0aW9uIChvKSB7IHJldHVybiAhIW87IH0pO1xuICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAvKiBUT0RPIGFiaWd1b3VzICovXG4gICAgICAgICAgICBkZWJ1Z2xvZyhcImFtYmlndW91cyByZXN1bHQgZm9yID5cIiArIHRleHQgKyBcIjxcIiArIEpTT04uc3RyaW5naWZ5KHJlcykpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHZhciByZXMgPSByZXN1bHRzWzBdO1xuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCByZXMpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGRlYnVnbG9nKCdyZWNvZ25pemluZyBub3RoaW5nJyk7XG4gICAgICAgIHUuaW50ZW50ID0gXCJOb25lXCI7XG4gICAgICAgIHUuc2NvcmUgPSAwLjE7XG4gICAgICAgIHZhciBlMSA9IHt9O1xuICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJleGl0IFwiLmxlbmd0aDtcbiAgICAgICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgICAgIGUxLnNjb3JlID0gMC4xO1xuICAgICAgICB1LmVudGl0aWVzID0gW107XG4gICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgfTtcbiAgICByZXR1cm4gUmVnRXhwUmVjb2duaXplcjtcbn0oKSk7XG5leHBvcnRzLlJlZ0V4cFJlY29nbml6ZXIgPSBSZWdFeHBSZWNvZ25pemVyOyAvLyBjbGFzc1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
