/**
 * @copyright (c) 2016 Gerd Forstmann
 * @file plainrecognizer.ts
 *
 * A recognizer parametrized by regex expressions
 */
"use strict";

var debug = require('debug');
var debuglog = debug('plainrecognizer');
var AnyObject = Object;
function recognize(sString, mRules) {
    var res = undefined;
    mRules.every(function (oRule) {
        res = matchRegularExpression(sString, oRule);
        return !res;
    });
    return res;
}
exports.recognize = recognize;
function countParenGroups(s) {
    var res = 0;
    for (var i = 0; i < s.length; ++i) {
        if (s.charAt(i) === '(') {
            ++res;
        }
    }
    return res;
}
exports.countParenGroups = countParenGroups;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleString(a) {
    var s = "^" + a + "$";
    var argMaps = {};
    var m = undefined;
    while (m = /<([^>]+)>([?]?)/.exec(s)) {
        var cat = m[1];
        var greedy = m[2];
        var pos = 1 + countParenGroups(s.substring(0, m.index));
        if (greedy) {
            s = s.replace("<" + cat + ">?", "(.*?)");
        } else {
            s = s.replace("<" + cat + ">", "(.*)");
        }
        if (argMaps[cat]) {
            throw Error("Model error duplicate entry!");
        }
        argMaps[cat] = pos;
    }
    return {
        type: 1,
        regexp: new RegExp(s, "i"),
        argsMap: argMaps
    };
}
exports.parseRuleString = parseRuleString;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleArray(a) {
    var s = "^" + a + "$";
    var r = a[0];
    if (typeof a[0] === "string") {
        r = new RegExp(a[0], "i");
    }
    if (!(r instanceof RegExp)) {
        throw Error("illegal state" + JSON.stringify(a));
    }
    return {
        type: 1,
        regexp: r,
        argsMap: a[1]
    };
}
exports.parseRuleArray = parseRuleArray;
function parseRule(a) {
    if (typeof a === 'string') {
        return parseRuleString(a);
    } else if (Array.isArray(a)) {
        return parseRuleArray(a);
    }
    throw new Error("unknown rule definition");
}
exports.parseRule = parseRule;
function parseRules(oJSON) {
    var res = {};
    Object.keys(oJSON).forEach(function (sKey) {
        res[sKey] = oJSON[sKey].map(function (oRule) {
            return parseRule(oRule);
        });
    });
    return res;
}
exports.parseRules = parseRules;
;
function trimValueAdjusting(value) {
    var res = { deltaStart: 0, value: value };
    var m = value.match(/^\s+/);
    if (m) {
        res.deltaStart = m[0].length;
        value = value.substr(res.deltaStart);
    }
    m = value.match(/\s+$/);
    if (m) {
        value = value.substr(0, value.length - m[0].length);
    }
    res.value = value;
    return res;
}
exports.trimValueAdjusting = trimValueAdjusting;
function extractArgsMap(s, match, argsMap) {
    if (!argsMap) {
        return [];
    }
    var result = [];
    Object.keys(argsMap).forEach(function (sKey) {
        var res = {};
        var index = argsMap[sKey];
        var value = match[index];
        if (typeof value === "string" && value.length > 0) {
            res.type = sKey;
            res.entity = value;
            res.startIndex = s.indexOf(value); // this may not be precise
            var trimAdjust = trimValueAdjusting(value);
            res.startIndex += trimAdjust.deltaStart;
            res.entity = trimAdjust.value;
            res.endIndex = res.startIndex + trimAdjust.value.length;
            //res[sKey] = value
            result.push(res);
        }
    });
    return result;
}
exports.extractArgsMap = extractArgsMap;
function matchRegularExpression(text, oRule) {
    debuglog("regexp is " + oRule.regexp.toString());
    debuglog(" text is " + text);
    var m = oRule.regexp.exec(text);
    if (!m) {
        return undefined;
    }
    var res = {};
    res.entities = extractArgsMap(text, m, oRule.argsMap);
    res.score = 0.9;
    debuglog("match " + JSON.stringify(m));
    debuglog('Found one' + JSON.stringify(res, undefined, 2));
    return res;
}
exports.matchRegularExpression = matchRegularExpression;
function recognizeText(text, aRules) {
    var res = undefined;
    aRules.every(function (oRule) {
        res = matchRegularExpression(text, oRule);
        return !res;
    });
    return res;
}
exports.recognizeText = recognizeText;
var RegExpRecognizer = function () {
    function RegExpRecognizer(xRules) {
        this.oRules = xRules;
        debuglog("rules " + JSON.stringify(this.oRules));
    }
    ;
    RegExpRecognizer.prototype.recognize = function (context, callback) {
        var u = {};
        var text = context.message.text;
        var that = this;
        debuglog("rules " + JSON.stringify(this.oRules));
        var results = Object.keys(this.oRules).map(function (sKey) {
            var u = recognizeText(text, that.oRules[sKey]);
            if (u) {
                u.intent = sKey;
            }
            return u ? u : undefined;
        }).filter(function (o) {
            return !!o;
        });
        if (results.length > 1) {
            /* TODO abiguous */
            debuglog("ambiguous result for >" + text + "<" + JSON.stringify(res));
        }
        if (results.length > 0) {
            var res = results[0];
            callback(undefined, res);
            return;
        }
        debuglog('recognizing nothing');
        u.intent = "None";
        u.score = 0.1;
        var e1 = {};
        e1.startIndex = "exit ".length;
        e1.endIndex = context.message.text.length;
        e1.score = 0.1;
        u.entities = [];
        callback(undefined, u);
    };
    return RegExpRecognizer;
}();
exports.RegExpRecognizer = RegExpRecognizer; // class
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ib3QvcGxhaW5yZWNvZ25pemVyLnRzIiwiYm90L3BsYWlucmVjb2duaXplci5qcyJdLCJuYW1lcyI6WyJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsIkFueU9iamVjdCIsIk9iamVjdCIsInJlY29nbml6ZSIsInNTdHJpbmciLCJtUnVsZXMiLCJyZXMiLCJ1bmRlZmluZWQiLCJldmVyeSIsIm9SdWxlIiwibWF0Y2hSZWd1bGFyRXhwcmVzc2lvbiIsImV4cG9ydHMiLCJjb3VudFBhcmVuR3JvdXBzIiwicyIsImkiLCJsZW5ndGgiLCJjaGFyQXQiLCJwYXJzZVJ1bGVTdHJpbmciLCJhIiwiYXJnTWFwcyIsIm0iLCJleGVjIiwiY2F0IiwiZ3JlZWR5IiwicG9zIiwic3Vic3RyaW5nIiwiaW5kZXgiLCJyZXBsYWNlIiwiRXJyb3IiLCJ0eXBlIiwicmVnZXhwIiwiUmVnRXhwIiwiYXJnc01hcCIsInBhcnNlUnVsZUFycmF5IiwiciIsIkpTT04iLCJzdHJpbmdpZnkiLCJwYXJzZVJ1bGUiLCJBcnJheSIsImlzQXJyYXkiLCJwYXJzZVJ1bGVzIiwib0pTT04iLCJrZXlzIiwiZm9yRWFjaCIsInNLZXkiLCJtYXAiLCJ0cmltVmFsdWVBZGp1c3RpbmciLCJ2YWx1ZSIsImRlbHRhU3RhcnQiLCJtYXRjaCIsInN1YnN0ciIsImV4dHJhY3RBcmdzTWFwIiwicmVzdWx0IiwiZW50aXR5Iiwic3RhcnRJbmRleCIsImluZGV4T2YiLCJ0cmltQWRqdXN0IiwiZW5kSW5kZXgiLCJwdXNoIiwidGV4dCIsInRvU3RyaW5nIiwiZW50aXRpZXMiLCJzY29yZSIsInJlY29nbml6ZVRleHQiLCJhUnVsZXMiLCJSZWdFeHBSZWNvZ25pemVyIiwieFJ1bGVzIiwib1J1bGVzIiwicHJvdG90eXBlIiwiY29udGV4dCIsImNhbGxiYWNrIiwidSIsIm1lc3NhZ2UiLCJ0aGF0IiwicmVzdWx0cyIsImludGVudCIsImZpbHRlciIsIm8iLCJlMSJdLCJtYXBwaW5ncyI6IkFBQ0E7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RixHQUFXLE1BQVg7QUFDQUosVUFBRVQsS0FBRixHQUFVLEdBQVY7QUFDQSxZQUFJZ0IsS0FBSyxFQUFUO0FBQ0FBLFdBQUd4QixVQUFILEdBQWdCLFFBQVF2QyxNQUF4QjtBQUNBK0QsV0FBR3JCLFFBQUgsR0FBY1ksUUFBUUcsT0FBUixDQUFnQmIsSUFBaEIsQ0FBcUI1QyxNQUFuQztBQUNBK0QsV0FBR2hCLEtBQUgsR0FBVyxHQUFYO0FBQ0FTLFVBQUVWLFFBQUYsR0FBYSxFQUFiO0FBQ0FTLGlCQUFTL0QsU0FBVCxFQUFvQmdFLENBQXBCO0FBQ0QsS0E5QkQ7QUErQkYsV0FBQU4sZ0JBQUE7QUF2Q0EsQ0FBQSxFQUFBO0FBQWF0RCxRQUFBc0QsZ0JBQUEsR0FBZ0JBLGdCQUFoQixDLENBdUNYIiwiZmlsZSI6ImJvdC9wbGFpbnJlY29nbml6ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8qKlxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICogQGZpbGUgcGxhaW5yZWNvZ25pemVyLnRzXG4gKlxuICogQSByZWNvZ25pemVyIHBhcmFtZXRyaXplZCBieSByZWdleCBleHByZXNzaW9uc1xuICovXG5cbmltcG9ydCAqIGFzIGJ1aWxkZXIgZnJvbSAnYm90YnVpbGRlcic7XG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlciBmcm9tICcuLi9tYXRjaC9pbnB1dEZpbHRlcic7XG5pbXBvcnQgKiBhcyBJTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvaWZtYXRjaCc7XG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdwbGFpbnJlY29nbml6ZXInKTtcblxuY29uc3QgQW55T2JqZWN0ID0gT2JqZWN0IGFzIGFueTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJlY29nbml6ZShzU3RyaW5nLCBtUnVsZXM6IEFycmF5PElNYXRjaC5JbnRlbnRSdWxlPikge1xuICB2YXIgcmVzID0gdW5kZWZpbmVkO1xuICBtUnVsZXMuZXZlcnkoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgcmVzID0gbWF0Y2hSZWd1bGFyRXhwcmVzc2lvbihzU3RyaW5nLCBvUnVsZSk7XG4gICAgcmV0dXJuICFyZXM7XG4gIH0pXG4gIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb3VudFBhcmVuR3JvdXBzKHM6IHN0cmluZykge1xuICB2YXIgcmVzID0gMDtcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgKytpKSB7XG4gICAgaWYgKHMuY2hhckF0KGkpID09PSAnKCcpIHtcbiAgICAgICsrcmVzO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzO1xufVxuXG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VSdWxlU3RyaW5nKGE6IHN0cmluZyk6IElNYXRjaC5JbnRlbnRSdWxlIHtcbiAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgdmFyIGFyZ01hcHMgPSB7fTtcbiAgdmFyIG0gPSB1bmRlZmluZWQ7XG4gIHdoaWxlIChtID0gLzwoW14+XSspPihbP10/KS8uZXhlYyhzKSkge1xuICAgIHZhciBjYXQgPSBtWzFdO1xuICAgIHZhciBncmVlZHkgPSBtWzJdO1xuICAgIHZhciBwb3MgPSAxICsgY291bnRQYXJlbkdyb3VwcyhzLnN1YnN0cmluZygwLCBtLmluZGV4KSk7XG4gICAgaWYoZ3JlZWR5KSB7XG4gICAgICBzID0gcy5yZXBsYWNlKFwiPFwiICsgY2F0ICsgXCI+P1wiLCBcIiguKj8pXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHMgPSBzLnJlcGxhY2UoXCI8XCIgKyBjYXQgKyBcIj5cIiwgXCIoLiopXCIpO1xuICAgICAgfVxuICAgIGlmIChhcmdNYXBzW2NhdF0pIHtcbiAgICAgIHRocm93IEVycm9yKFwiTW9kZWwgZXJyb3IgZHVwbGljYXRlIGVudHJ5IVwiKVxuICAgIH1cbiAgICBhcmdNYXBzW2NhdF0gPSBwb3M7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAxLFxuICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChzLCBcImlcIiksXG4gICAgYXJnc01hcDogYXJnTWFwc1xuICB9O1xufVxuXG5cbi8qKlxuICogZ2l2ZW4gYSBzdHJpbmcsIGUuZy5cbiAqIFwid2hvIGlzIHRoZSA8Y2F0ZWdvcnk+IG9mIDxBMT5cIixcbiAqIEBwYXJhbSB7c3RyaW5nfSBhXG4gKiBAcmV0dXJucyB7SU1hdGNoLklSdWxlfSBhIHJlZ2V4cCBydWxlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVJ1bGVBcnJheShhOiBBcnJheTxhbnk+KTogSU1hdGNoLkludGVudFJ1bGUge1xuICB2YXIgcyA9IFwiXlwiICsgYSArIFwiJFwiO1xuICB2YXIgciA9IGFbMF07XG4gIGlmKHR5cGVvZiBhWzBdID09PSBcInN0cmluZ1wiKSB7XG4gICAgciA9IG5ldyBSZWdFeHAoYVswXSxcImlcIik7XG4gIH1cbiAgaWYgKCEociBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcbiAgICB0aHJvdyBFcnJvcihcImlsbGVnYWwgc3RhdGVcIiArIEpTT04uc3RyaW5naWZ5KGEpKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHR5cGU6IDEsXG4gICAgcmVnZXhwOiByLFxuICAgIGFyZ3NNYXA6IGFbMV1cbiAgfTtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VSdWxlKGE6IGFueSk6IElNYXRjaC5JbnRlbnRSdWxlIHtcbiAgaWYgKHR5cGVvZiBhID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBwYXJzZVJ1bGVTdHJpbmcoYSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShhKSkge1xuICAgIHJldHVybiBwYXJzZVJ1bGVBcnJheShhKTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoXCJ1bmtub3duIHJ1bGUgZGVmaW5pdGlvblwiKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlUnVsZXMob0pTT046IHsgW2tleTogc3RyaW5nXTogYW55IH0pOiB7IFtrZXk6IHN0cmluZ106IEFycmF5PElNYXRjaC5JbnRlbnRSdWxlPiB9IHtcbiAgdmFyIHJlcyA9IHt9O1xuICBPYmplY3Qua2V5cyhvSlNPTikuZm9yRWFjaChmdW5jdGlvbiAoc0tleSkge1xuICAgIHJlc1tzS2V5XSA9IG9KU09OW3NLZXldLm1hcChmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgIHJldHVybiBwYXJzZVJ1bGUob1J1bGUpO1xuICAgIH0pXG4gIH0pO1xuICByZXR1cm4gcmVzO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHRyaW1WYWx1ZUFkanVzdGluZyh2YWx1ZSA6IHN0cmluZykgOiB7IGRlbHRhU3RhcnQgOm51bWJlciwgdmFsdWUgOiBzdHJpbmd9IHtcbiAgdmFyIHJlcyA9IHsgZGVsdGFTdGFydCA6IDAsIHZhbHVlIDogdmFsdWUgfTtcbiAgdmFyIG0gPSB2YWx1ZS5tYXRjaCgvXlxccysvKTtcbiAgaWYobSkge1xuICAgIHJlcy5kZWx0YVN0YXJ0ID0gbVswXS5sZW5ndGg7XG4gICAgdmFsdWUgPSB2YWx1ZS5zdWJzdHIocmVzLmRlbHRhU3RhcnQpO1xuICB9XG4gIG0gPSB2YWx1ZS5tYXRjaCgvXFxzKyQvKTtcbiAgaWYobSkge1xuICAgIHZhbHVlID0gdmFsdWUuc3Vic3RyKDAsIHZhbHVlLmxlbmd0aCAtIG1bMF0ubGVuZ3RoKTtcbiAgfVxuICByZXMudmFsdWUgPSB2YWx1ZTtcbiAgcmV0dXJuIHJlcztcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdEFyZ3NNYXAocyA6IHN0cmluZywgbWF0Y2g6IEFycmF5PHN0cmluZz4sIGFyZ3NNYXA6IHsgW2tleTogc3RyaW5nXTogbnVtYmVyIH0pOiBBcnJheTxidWlsZGVyLklFbnRpdHk+IHtcbiAgaWYgKCFhcmdzTWFwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIHZhciByZXN1bHQgPSBbXTtcbiAgT2JqZWN0LmtleXMoYXJnc01hcCkuZm9yRWFjaChmdW5jdGlvbiAoc0tleSkge1xuICAgIHZhciByZXMgPSB7fSBhcyBidWlsZGVyLklFbnRpdHk7XG4gICAgdmFyIGluZGV4ID0gYXJnc01hcFtzS2V5XTtcbiAgICB2YXIgdmFsdWUgPSBtYXRjaFtpbmRleF1cbiAgICBpZiAoKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikgJiYgdmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgcmVzLnR5cGUgPSBzS2V5O1xuICAgICAgcmVzLmVudGl0eSA9IHZhbHVlO1xuICAgICAgcmVzLnN0YXJ0SW5kZXggPSBzLmluZGV4T2YodmFsdWUpOyAvLyB0aGlzIG1heSBub3QgYmUgcHJlY2lzZVxuICAgICAgdmFyIHRyaW1BZGp1c3QgPSB0cmltVmFsdWVBZGp1c3RpbmcodmFsdWUpO1xuICAgICAgcmVzLnN0YXJ0SW5kZXggKz0gdHJpbUFkanVzdC5kZWx0YVN0YXJ0O1xuICAgICAgcmVzLmVudGl0eSA9IHRyaW1BZGp1c3QudmFsdWU7XG4gICAgICByZXMuZW5kSW5kZXggPSByZXMuc3RhcnRJbmRleCArIHRyaW1BZGp1c3QudmFsdWUubGVuZ3RoO1xuICAgICAgLy9yZXNbc0tleV0gPSB2YWx1ZVxuICAgICAgcmVzdWx0LnB1c2gocmVzKTtcbiAgICB9XG4gIH1cbiAgKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoUmVndWxhckV4cHJlc3Npb24odGV4dCA6IHN0cmluZywgb1J1bGUgOiBJTWF0Y2guSW50ZW50UnVsZSkgOiBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0IHtcbiAgZGVidWdsb2coXCJyZWdleHAgaXMgXCIgKyBvUnVsZS5yZWdleHAudG9TdHJpbmcoKSk7XG4gIGRlYnVnbG9nKFwiIHRleHQgaXMgXCIgKyB0ZXh0KTtcbiAgdmFyIG0gPSBvUnVsZS5yZWdleHAuZXhlYyh0ZXh0KTtcbiAgaWYgKCFtKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICB2YXIgcmVzID0ge30gYXMgYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdDtcbiAgcmVzLmVudGl0aWVzID0gZXh0cmFjdEFyZ3NNYXAodGV4dCwgbSwgb1J1bGUuYXJnc01hcCk7XG4gIHJlcy5zY29yZSA9IDAuOTtcbiAgZGVidWdsb2coXCJtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG0pKTtcbiAgZGVidWdsb2coJ0ZvdW5kIG9uZScgKyBKU09OLnN0cmluZ2lmeShyZXMsIHVuZGVmaW5lZCwgMikpO1xuICByZXR1cm4gcmVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVjb2duaXplVGV4dCh0ZXh0IDogc3RyaW5nLCBhUnVsZXMgOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4pIDogYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdHtcbiAgICB2YXIgcmVzID0gdW5kZWZpbmVkO1xuICAgIGFSdWxlcy5ldmVyeShmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgICAgcmVzID0gbWF0Y2hSZWd1bGFyRXhwcmVzc2lvbih0ZXh0LCBvUnVsZSk7XG4gICAgICAgIHJldHVybiAhcmVzO1xuICAgIH0pO1xuICAgIHJldHVybiByZXM7XG59XG5cbmV4cG9ydCBjbGFzcyBSZWdFeHBSZWNvZ25pemVyIGltcGxlbWVudHMgYnVpbGRlci5JSW50ZW50UmVjb2duaXplciB7XG4gIG9SdWxlczogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4gfTtcblxuICBjb25zdHJ1Y3Rvcih4UnVsZXM6IHsgW2tleTogc3RyaW5nXTogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+IH0pIHtcbiAgICB0aGlzLm9SdWxlcyA9IHhSdWxlcztcbiAgICBkZWJ1Z2xvZyhcInJ1bGVzIFwiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5vUnVsZXMpKTtcbiAgfTtcblxuICByZWNvZ25pemUoY29udGV4dDogYnVpbGRlci5JUmVjb2duaXplQ29udGV4dCwgY2FsbGJhY2s6IChlcnI6IEVycm9yLCByZXN1bHQ6IGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB2YXIgdSA9IHt9IGFzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQ7XG4gICAgdmFyIHRleHQgPSBjb250ZXh0Lm1lc3NhZ2UudGV4dDtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgZGVidWdsb2coXCJydWxlcyBcIiArIEpTT04uc3RyaW5naWZ5KHRoaXMub1J1bGVzKSk7XG4gICAgdmFyIHJlc3VsdHMgPSBPYmplY3Qua2V5cyh0aGlzLm9SdWxlcykubWFwKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgICB2YXIgdSA9IHJlY29nbml6ZVRleHQodGV4dCwgdGhhdC5vUnVsZXNbc0tleV0pO1xuICAgICAgaWYgKHUpIHtcbiAgICAgICAgdS5pbnRlbnQgPSBzS2V5O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHUgPyAgdSA6IHVuZGVmaW5lZDtcbiAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKG8pIHsgcmV0dXJuICEhbzsgfSk7XG4gICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMSkge1xuICAgICAgLyogVE9ETyBhYmlndW91cyAqL1xuICAgICAgZGVidWdsb2coXCJhbWJpZ3VvdXMgcmVzdWx0IGZvciA+XCIgKyB0ZXh0ICsgXCI8XCIgKyBKU09OLnN0cmluZ2lmeShyZXMpKTtcbiAgICB9XG4gICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMCkge1xuICAgICAgdmFyIHJlcyA9IHJlc3VsdHNbMF07XG4gICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHJlcyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGRlYnVnbG9nKCdyZWNvZ25pemluZyBub3RoaW5nJyk7XG4gICAgdS5pbnRlbnQgPSBcIk5vbmVcIjtcbiAgICB1LnNjb3JlID0gMC4xO1xuICAgIHZhciBlMSA9IHt9IGFzIGJ1aWxkZXIuSUVudGl0eTtcbiAgICBlMS5zdGFydEluZGV4ID0gXCJleGl0IFwiLmxlbmd0aDtcbiAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICBlMS5zY29yZSA9IDAuMTtcbiAgICB1LmVudGl0aWVzID0gW107XG4gICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgfVxufSAvLyBjbGFzc1xuXG5cblxuIiwiLyoqXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKiBAZmlsZSBwbGFpbnJlY29nbml6ZXIudHNcbiAqXG4gKiBBIHJlY29nbml6ZXIgcGFyYW1ldHJpemVkIGJ5IHJlZ2V4IGV4cHJlc3Npb25zXG4gKi9cblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdwbGFpbnJlY29nbml6ZXInKTtcbnZhciBBbnlPYmplY3QgPSBPYmplY3Q7XG5mdW5jdGlvbiByZWNvZ25pemUoc1N0cmluZywgbVJ1bGVzKSB7XG4gICAgdmFyIHJlcyA9IHVuZGVmaW5lZDtcbiAgICBtUnVsZXMuZXZlcnkoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICAgIHJlcyA9IG1hdGNoUmVndWxhckV4cHJlc3Npb24oc1N0cmluZywgb1J1bGUpO1xuICAgICAgICByZXR1cm4gIXJlcztcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5yZWNvZ25pemUgPSByZWNvZ25pemU7XG5mdW5jdGlvbiBjb3VudFBhcmVuR3JvdXBzKHMpIHtcbiAgICB2YXIgcmVzID0gMDtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgaWYgKHMuY2hhckF0KGkpID09PSAnKCcpIHtcbiAgICAgICAgICAgICsrcmVzO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLmNvdW50UGFyZW5Hcm91cHMgPSBjb3VudFBhcmVuR3JvdXBzO1xuLyoqXG4gKiBnaXZlbiBhIHN0cmluZywgZS5nLlxuICogXCJ3aG8gaXMgdGhlIDxjYXRlZ29yeT4gb2YgPEExPlwiLFxuICogQHBhcmFtIHtzdHJpbmd9IGFcbiAqIEByZXR1cm5zIHtJTWF0Y2guSVJ1bGV9IGEgcmVnZXhwIHJ1bGVcbiAqL1xuZnVuY3Rpb24gcGFyc2VSdWxlU3RyaW5nKGEpIHtcbiAgICB2YXIgcyA9IFwiXlwiICsgYSArIFwiJFwiO1xuICAgIHZhciBhcmdNYXBzID0ge307XG4gICAgdmFyIG0gPSB1bmRlZmluZWQ7XG4gICAgd2hpbGUgKG0gPSAvPChbXj5dKyk+KFs/XT8pLy5leGVjKHMpKSB7XG4gICAgICAgIHZhciBjYXQgPSBtWzFdO1xuICAgICAgICB2YXIgZ3JlZWR5ID0gbVsyXTtcbiAgICAgICAgdmFyIHBvcyA9IDEgKyBjb3VudFBhcmVuR3JvdXBzKHMuc3Vic3RyaW5nKDAsIG0uaW5kZXgpKTtcbiAgICAgICAgaWYgKGdyZWVkeSkge1xuICAgICAgICAgICAgcyA9IHMucmVwbGFjZShcIjxcIiArIGNhdCArIFwiPj9cIiwgXCIoLio/KVwiKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHMgPSBzLnJlcGxhY2UoXCI8XCIgKyBjYXQgKyBcIj5cIiwgXCIoLiopXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhcmdNYXBzW2NhdF0pIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFwiTW9kZWwgZXJyb3IgZHVwbGljYXRlIGVudHJ5IVwiKTtcbiAgICAgICAgfVxuICAgICAgICBhcmdNYXBzW2NhdF0gPSBwb3M7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IDEsXG4gICAgICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChzLCBcImlcIiksXG4gICAgICAgIGFyZ3NNYXA6IGFyZ01hcHNcbiAgICB9O1xufVxuZXhwb3J0cy5wYXJzZVJ1bGVTdHJpbmcgPSBwYXJzZVJ1bGVTdHJpbmc7XG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5mdW5jdGlvbiBwYXJzZVJ1bGVBcnJheShhKSB7XG4gICAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgICB2YXIgciA9IGFbMF07XG4gICAgaWYgKHR5cGVvZiBhWzBdID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHIgPSBuZXcgUmVnRXhwKGFbMF0sIFwiaVwiKTtcbiAgICB9XG4gICAgaWYgKCEociBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXCJpbGxlZ2FsIHN0YXRlXCIgKyBKU09OLnN0cmluZ2lmeShhKSk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IDEsXG4gICAgICAgIHJlZ2V4cDogcixcbiAgICAgICAgYXJnc01hcDogYVsxXVxuICAgIH07XG59XG5leHBvcnRzLnBhcnNlUnVsZUFycmF5ID0gcGFyc2VSdWxlQXJyYXk7XG5mdW5jdGlvbiBwYXJzZVJ1bGUoYSkge1xuICAgIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIHBhcnNlUnVsZVN0cmluZyhhKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShhKSkge1xuICAgICAgICByZXR1cm4gcGFyc2VSdWxlQXJyYXkoYSk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihcInVua25vd24gcnVsZSBkZWZpbml0aW9uXCIpO1xufVxuZXhwb3J0cy5wYXJzZVJ1bGUgPSBwYXJzZVJ1bGU7XG5mdW5jdGlvbiBwYXJzZVJ1bGVzKG9KU09OKSB7XG4gICAgdmFyIHJlcyA9IHt9O1xuICAgIE9iamVjdC5rZXlzKG9KU09OKS5mb3JFYWNoKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgICAgIHJlc1tzS2V5XSA9IG9KU09OW3NLZXldLm1hcChmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJzZVJ1bGUob1J1bGUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5wYXJzZVJ1bGVzID0gcGFyc2VSdWxlcztcbjtcbmZ1bmN0aW9uIHRyaW1WYWx1ZUFkanVzdGluZyh2YWx1ZSkge1xuICAgIHZhciByZXMgPSB7IGRlbHRhU3RhcnQ6IDAsIHZhbHVlOiB2YWx1ZSB9O1xuICAgIHZhciBtID0gdmFsdWUubWF0Y2goL15cXHMrLyk7XG4gICAgaWYgKG0pIHtcbiAgICAgICAgcmVzLmRlbHRhU3RhcnQgPSBtWzBdLmxlbmd0aDtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5zdWJzdHIocmVzLmRlbHRhU3RhcnQpO1xuICAgIH1cbiAgICBtID0gdmFsdWUubWF0Y2goL1xccyskLyk7XG4gICAgaWYgKG0pIHtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5zdWJzdHIoMCwgdmFsdWUubGVuZ3RoIC0gbVswXS5sZW5ndGgpO1xuICAgIH1cbiAgICByZXMudmFsdWUgPSB2YWx1ZTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy50cmltVmFsdWVBZGp1c3RpbmcgPSB0cmltVmFsdWVBZGp1c3Rpbmc7XG5mdW5jdGlvbiBleHRyYWN0QXJnc01hcChzLCBtYXRjaCwgYXJnc01hcCkge1xuICAgIGlmICghYXJnc01hcCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHZhciByZXN1bHQgPSBbXTtcbiAgICBPYmplY3Qua2V5cyhhcmdzTWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgICAgIHZhciByZXMgPSB7fTtcbiAgICAgICAgdmFyIGluZGV4ID0gYXJnc01hcFtzS2V5XTtcbiAgICAgICAgdmFyIHZhbHVlID0gbWF0Y2hbaW5kZXhdO1xuICAgICAgICBpZiAoKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikgJiYgdmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmVzLnR5cGUgPSBzS2V5O1xuICAgICAgICAgICAgcmVzLmVudGl0eSA9IHZhbHVlO1xuICAgICAgICAgICAgcmVzLnN0YXJ0SW5kZXggPSBzLmluZGV4T2YodmFsdWUpOyAvLyB0aGlzIG1heSBub3QgYmUgcHJlY2lzZVxuICAgICAgICAgICAgdmFyIHRyaW1BZGp1c3QgPSB0cmltVmFsdWVBZGp1c3RpbmcodmFsdWUpO1xuICAgICAgICAgICAgcmVzLnN0YXJ0SW5kZXggKz0gdHJpbUFkanVzdC5kZWx0YVN0YXJ0O1xuICAgICAgICAgICAgcmVzLmVudGl0eSA9IHRyaW1BZGp1c3QudmFsdWU7XG4gICAgICAgICAgICByZXMuZW5kSW5kZXggPSByZXMuc3RhcnRJbmRleCArIHRyaW1BZGp1c3QudmFsdWUubGVuZ3RoO1xuICAgICAgICAgICAgLy9yZXNbc0tleV0gPSB2YWx1ZVxuICAgICAgICAgICAgcmVzdWx0LnB1c2gocmVzKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG59XG5leHBvcnRzLmV4dHJhY3RBcmdzTWFwID0gZXh0cmFjdEFyZ3NNYXA7XG5mdW5jdGlvbiBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHRleHQsIG9SdWxlKSB7XG4gICAgZGVidWdsb2coXCJyZWdleHAgaXMgXCIgKyBvUnVsZS5yZWdleHAudG9TdHJpbmcoKSk7XG4gICAgZGVidWdsb2coXCIgdGV4dCBpcyBcIiArIHRleHQpO1xuICAgIHZhciBtID0gb1J1bGUucmVnZXhwLmV4ZWModGV4dCk7XG4gICAgaWYgKCFtKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHZhciByZXMgPSB7fTtcbiAgICByZXMuZW50aXRpZXMgPSBleHRyYWN0QXJnc01hcCh0ZXh0LCBtLCBvUnVsZS5hcmdzTWFwKTtcbiAgICByZXMuc2NvcmUgPSAwLjk7XG4gICAgZGVidWdsb2coXCJtYXRjaCBcIiArIEpTT04uc3RyaW5naWZ5KG0pKTtcbiAgICBkZWJ1Z2xvZygnRm91bmQgb25lJyArIEpTT04uc3RyaW5naWZ5KHJlcywgdW5kZWZpbmVkLCAyKSk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMubWF0Y2hSZWd1bGFyRXhwcmVzc2lvbiA9IG1hdGNoUmVndWxhckV4cHJlc3Npb247XG5mdW5jdGlvbiByZWNvZ25pemVUZXh0KHRleHQsIGFSdWxlcykge1xuICAgIHZhciByZXMgPSB1bmRlZmluZWQ7XG4gICAgYVJ1bGVzLmV2ZXJ5KGZ1bmN0aW9uIChvUnVsZSkge1xuICAgICAgICByZXMgPSBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHRleHQsIG9SdWxlKTtcbiAgICAgICAgcmV0dXJuICFyZXM7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMucmVjb2duaXplVGV4dCA9IHJlY29nbml6ZVRleHQ7XG52YXIgUmVnRXhwUmVjb2duaXplciA9IChmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gUmVnRXhwUmVjb2duaXplcih4UnVsZXMpIHtcbiAgICAgICAgdGhpcy5vUnVsZXMgPSB4UnVsZXM7XG4gICAgICAgIGRlYnVnbG9nKFwicnVsZXMgXCIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLm9SdWxlcykpO1xuICAgIH1cbiAgICA7XG4gICAgUmVnRXhwUmVjb2duaXplci5wcm90b3R5cGUucmVjb2duaXplID0gZnVuY3Rpb24gKGNvbnRleHQsIGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciB1ID0ge307XG4gICAgICAgIHZhciB0ZXh0ID0gY29udGV4dC5tZXNzYWdlLnRleHQ7XG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgZGVidWdsb2coXCJydWxlcyBcIiArIEpTT04uc3RyaW5naWZ5KHRoaXMub1J1bGVzKSk7XG4gICAgICAgIHZhciByZXN1bHRzID0gT2JqZWN0LmtleXModGhpcy5vUnVsZXMpLm1hcChmdW5jdGlvbiAoc0tleSkge1xuICAgICAgICAgICAgdmFyIHUgPSByZWNvZ25pemVUZXh0KHRleHQsIHRoYXQub1J1bGVzW3NLZXldKTtcbiAgICAgICAgICAgIGlmICh1KSB7XG4gICAgICAgICAgICAgICAgdS5pbnRlbnQgPSBzS2V5O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHUgPyB1IDogdW5kZWZpbmVkO1xuICAgICAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKG8pIHsgcmV0dXJuICEhbzsgfSk7XG4gICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIC8qIFRPRE8gYWJpZ3VvdXMgKi9cbiAgICAgICAgICAgIGRlYnVnbG9nKFwiYW1iaWd1b3VzIHJlc3VsdCBmb3IgPlwiICsgdGV4dCArIFwiPFwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdmFyIHJlcyA9IHJlc3VsdHNbMF07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHJlcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZGVidWdsb2coJ3JlY29nbml6aW5nIG5vdGhpbmcnKTtcbiAgICAgICAgdS5pbnRlbnQgPSBcIk5vbmVcIjtcbiAgICAgICAgdS5zY29yZSA9IDAuMTtcbiAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgIGUxLnN0YXJ0SW5kZXggPSBcImV4aXQgXCIubGVuZ3RoO1xuICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgZTEuc2NvcmUgPSAwLjE7XG4gICAgICAgIHUuZW50aXRpZXMgPSBbXTtcbiAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgICB9O1xuICAgIHJldHVybiBSZWdFeHBSZWNvZ25pemVyO1xufSgpKTtcbmV4cG9ydHMuUmVnRXhwUmVjb2duaXplciA9IFJlZ0V4cFJlY29nbml6ZXI7IC8vIGNsYXNzXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
