/**
 * @copyright (c) 2016 Gerd Forstmann
 */
"use strict";

var debug = require('debug');
var debuglog = debug('plainrecognizer');
var AnyObject = Object;
function recognize(sString, mRules) {
    var res = undefined;
    mRules.every(function (oRule) {
        res = matchRegularExpression(sString, oRule);
        return !res;
    });
    return res;
}
exports.recognize = recognize;
function countParenGroups(s) {
    var res = 0;
    for (var i = 0; i < s.length; ++i) {
        if (s.charAt(i) === '(') {
            ++res;
        }
    }
    return res;
}
exports.countParenGroups = countParenGroups;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleString(a) {
    var s = "^" + a + "$";
    var argMaps = {};
    var m = undefined;
    while (m = /<([^>]+)>/.exec(s)) {
        var cat = m[1];
        var pos = 1 + countParenGroups(s.substring(0, m.index));
        s = s.replace("<" + cat + ">", "(.*)");
        if (argMaps[cat]) {
            throw Error("Model error duplicate entry!");
        }
        argMaps[cat] = pos;
    }
    return {
        type: 1,
        regexp: new RegExp(s, "i"),
        argsMap: argMaps
    };
}
exports.parseRuleString = parseRuleString;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleArray(a) {
    var s = "^" + a + "$";
    var r = a[0];
    if (typeof a[0] === "string") {
        r = new RegExp(a[0], "i");
    }
    if (!(r instanceof RegExp)) {
        throw Error("illegal state" + JSON.stringify(a));
    }
    return {
        type: 1,
        regexp: r,
        argsMap: a[1]
    };
}
exports.parseRuleArray = parseRuleArray;
function parseRule(a) {
    if (typeof a === 'string') {
        return parseRuleString(a);
    } else if (Array.isArray(a)) {
        return parseRuleArray(a);
    }
    throw new Error("unknown rule definition");
}
exports.parseRule = parseRule;
function parseRules(oJSON) {
    var res = {};
    Object.keys(oJSON).forEach(function (sKey) {
        res[sKey] = oJSON[sKey].map(function (oRule) {
            return parseRule(oRule);
        });
    });
    return res;
}
exports.parseRules = parseRules;
;
function extractArgsMap(s, match, argsMap) {
    if (!argsMap) {
        return [];
    }
    var result = [];
    Object.keys(argsMap).forEach(function (sKey) {
        var res = {};
        var index = argsMap[sKey];
        var value = match[index];
        if (typeof value === "string" && value.length > 0) {
            res.type = sKey;
            res.entity = value;
            res.startIndex = s.indexOf(value); // this may not be precise
            res.endIndex = res.startIndex + value.length;
            //res[sKey] = value
            result.push(res);
        }
    });
    return result;
}
exports.extractArgsMap = extractArgsMap;
function matchRegularExpression(text, oRule) {
    debuglog("regexp is " + oRule.regexp.toString());
    debuglog(" text is " + text);
    var m = oRule.regexp.exec(text);
    if (!m) {
        return undefined;
    }
    var res = {};
    res.entities = extractArgsMap(text, m, oRule.argsMap);
    res.score = 0.9;
    debuglog("match " + JSON.stringify(m));
    debuglog('Found one' + JSON.stringify(res, undefined, 2));
    return res;
}
exports.matchRegularExpression = matchRegularExpression;
function recognizeText(text, aRules) {
    var res = undefined;
    aRules.every(function (oRule) {
        res = matchRegularExpression(text, oRule);
        return !res;
    });
    return res;
}
exports.recognizeText = recognizeText;
var RegExpRecognizer = function () {
    function RegExpRecognizer(xRules) {
        this.oRules = xRules;
        debuglog("rules " + JSON.stringify(this.oRules));
    }
    ;
    RegExpRecognizer.prototype.recognize = function (context, callback) {
        var u = {};
        var text = context.message.text;
        var that = this;
        debuglog("rules " + JSON.stringify(this.oRules));
        var results = Object.keys(this.oRules).map(function (sKey) {
            var u = recognizeText(text, that.oRules[sKey]);
            if (u) {
                u.intent = sKey;
            }
            return u ? u : undefined;
        }).filter(function (o) {
            return !!o;
        });
        if (results.length > 1) {
            /* TODO abiguous */
            debuglog("ambiguous result for >" + text + "<" + JSON.stringify(res));
        }
        if (results.length > 0) {
            var res = results[0];
            callback(undefined, res);
            return;
        }
        debuglog('recognizing nothing');
        u.intent = "None";
        u.score = 0.1;
        var e1 = {};
        e1.startIndex = "exit ".length;
        e1.endIndex = context.message.text.length;
        e1.score = 0.1;
        u.entities = [];
        callback(undefined, u);
    };
    return RegExpRecognizer;
}();
exports.RegExpRecognizer = RegExpRecognizer; // class
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ib3QvcGxhaW5yZWNvZ25pemVyLnRzIiwiYm90L3BsYWlucmVjb2duaXplci5qcyJdLCJuYW1lcyI6WyJkZWJ1ZyIsInJlcXVpcmUiLCJkZWJ1Z2xvZyIsIkFueU9iamVjdCIsIk9iamVjdCIsInJlY29nbml6ZSIsInNTdHJpbmciLCJtUnVsZXMiLCJyZXMiLCJ1bmRlZmluZWQiLCJldmVyeSIsIm9SdWxlIiwibWF0Y2hSZWd1bGFyRXhwcmVzc2lvbiIsImV4cG9ydHMiLCJjb3VudFBhcmVuR3JvdXBzIiwicyIsImkiLCJsZW5ndGgiLCJjaGFyQXQiLCJwYXJzZVJ1bGVTdHJpbmciLCJhIiwiYXJnTWFwcyIsIm0iLCJleGVjIiwiY2F0IiwicG9zIiwic3Vic3RyaW5nIiwiaW5kZXgiLCJyZXBsYWNlIiwiRXJyb3IiLCJ0eXBlIiwicmVnZXhwIiwiUmVnRXhwIiwiYXJnc01hcCIsInBhcnNlUnVsZUFycmF5IiwiciIsIkpTT04iLCJzdHJpbmdpZnkiLCJwYXJzZVJ1bGUiLCJBcnJheSIsImlzQXJyYXkiLCJwYXJzZVJ1bGVzIiwib0pTT04iLCJrZXlzIiwiZm9yRWFjaCIsInNLZXkiLCJtYXAiLCJleHRyYWN0QXJnc01hcCIsIm1hdGNoIiwicmVzdWx0IiwidmFsdWUiLCJlbnRpdHkiLCJzdGFydEluZGV4IiwiaW5kZXhPZiIsImVuZEluZGV4IiwicHVzaCIsInRleHQiLCJ0b1N0cmluZyIsImVudGl0aWVzIiwic2NvcmUiLCJyZWNvZ25pemVUZXh0IiwiYVJ1bGVzIiwiUmVnRXhwUmVjb2duaXplciIsInhSdWxlcyIsIm9SdWxlcyIsInByb3RvdHlwZSIsImNvbnRleHQiLCJjYWxsYmFjayIsInUiLCJtZXNzYWdlIiwidGhhdCIsInJlc3VsdHMiLCJpbnRlbnQiLCJmaWx0ZXIiLCJvIiwiZTEiXSwibWFwcGluZ3MiOiJBQUNBOzs7QUNFQTs7QURLQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4sQ0FBakI7QUFDQSxJQUFNQyxXQUFXRixNQUFNLGlC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cEI7QUFDQTtBQUNEO0FBQ0ROLGlCQUFTLHFCQUFUO0FBQ0FrRSxVQUFFSSxNQUFGLEdBQVcsTUFBWDtBQUNBSixVQUFFVCxLQUFGLEdBQVUsR0FBVjtBQUNBLFlBQUlnQixLQUFLLEVBQVQ7QUFDQUEsV0FBR3ZCLFVBQUgsR0FBZ0IsUUFBUW5DLE1BQXhCO0FBQ0EwRCxXQUFHckIsUUFBSCxHQUFjWSxRQUFRRyxPQUFSLENBQWdCYixJQUFoQixDQUFxQnZDLE1BQW5DO0FBQ0EwRCxXQUFHaEIsS0FBSCxHQUFXLEdBQVg7QUFDQVMsVUFBRVYsUUFBRixHQUFhLEVBQWI7QUFDQVMsaUJBQVMxRCxTQUFULEVBQW9CMkQsQ0FBcEI7QUFDRCxLQTlCRDtBQStCRixXQUFBTixnQkFBQTtBQXZDQSxDQUFBLEVBQUE7QUFBYWpELFFBQUFpRCxnQkFBQSxHQUFnQkEsZ0JBQWhCLEMsQ0F1Q1giLCJmaWxlIjoiYm90L3BsYWlucmVjb2duaXplci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLyoqXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cblxuaW1wb3J0ICogYXMgYnVpbGRlciBmcm9tICdib3RidWlsZGVyJztcbmltcG9ydCAqIGFzIElucHV0RmlsdGVyIGZyb20gJy4uL21hdGNoL2lucHV0RmlsdGVyJztcbmltcG9ydCAqIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ3BsYWlucmVjb2duaXplcicpO1xuXG5jb25zdCBBbnlPYmplY3QgPSBPYmplY3QgYXMgYW55O1xuXG5leHBvcnQgZnVuY3Rpb24gcmVjb2duaXplKHNTdHJpbmcsIG1SdWxlczogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+KSB7XG4gIHZhciByZXMgPSB1bmRlZmluZWQ7XG4gIG1SdWxlcy5ldmVyeShmdW5jdGlvbiAob1J1bGUpIHtcbiAgICByZXMgPSBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHNTdHJpbmcsIG9SdWxlKTtcbiAgICByZXR1cm4gIXJlcztcbiAgfSlcbiAgcmV0dXJuIHJlcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvdW50UGFyZW5Hcm91cHMoczogc3RyaW5nKSB7XG4gIHZhciByZXMgPSAwO1xuICBmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyArK2kpIHtcbiAgICBpZiAocy5jaGFyQXQoaSkgPT09ICcoJykge1xuICAgICAgKytyZXM7XG4gICAgfVxuICB9XG4gIHJldHVybiByZXM7XG59XG5cbi8qKlxuICogZ2l2ZW4gYSBzdHJpbmcsIGUuZy5cbiAqIFwid2hvIGlzIHRoZSA8Y2F0ZWdvcnk+IG9mIDxBMT5cIixcbiAqIEBwYXJhbSB7c3RyaW5nfSBhXG4gKiBAcmV0dXJucyB7SU1hdGNoLklSdWxlfSBhIHJlZ2V4cCBydWxlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVJ1bGVTdHJpbmcoYTogc3RyaW5nKTogSU1hdGNoLkludGVudFJ1bGUge1xuICB2YXIgcyA9IFwiXlwiICsgYSArIFwiJFwiO1xuICB2YXIgYXJnTWFwcyA9IHt9O1xuICB2YXIgbSA9IHVuZGVmaW5lZDtcbiAgd2hpbGUgKG0gPSAvPChbXj5dKyk+Ly5leGVjKHMpKSB7XG4gICAgdmFyIGNhdCA9IG1bMV07XG4gICAgdmFyIHBvcyA9IDEgKyBjb3VudFBhcmVuR3JvdXBzKHMuc3Vic3RyaW5nKDAsIG0uaW5kZXgpKTtcbiAgICBzID0gcy5yZXBsYWNlKFwiPFwiICsgY2F0ICsgXCI+XCIsIFwiKC4qKVwiKTtcbiAgICBpZiAoYXJnTWFwc1tjYXRdKSB7XG4gICAgICB0aHJvdyBFcnJvcihcIk1vZGVsIGVycm9yIGR1cGxpY2F0ZSBlbnRyeSFcIilcbiAgICB9XG4gICAgYXJnTWFwc1tjYXRdID0gcG9zO1xuICB9XG4gIHJldHVybiB7XG4gICAgdHlwZTogMSxcbiAgICByZWdleHA6IG5ldyBSZWdFeHAocywgXCJpXCIpLFxuICAgIGFyZ3NNYXA6IGFyZ01hcHNcbiAgfTtcbn1cblxuXG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VSdWxlQXJyYXkoYTogQXJyYXk8YW55Pik6IElNYXRjaC5JbnRlbnRSdWxlIHtcbiAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgdmFyIHIgPSBhWzBdO1xuICBpZih0eXBlb2YgYVswXSA9PT0gXCJzdHJpbmdcIikge1xuICAgIHIgPSBuZXcgUmVnRXhwKGFbMF0sXCJpXCIpO1xuICB9XG4gIGlmICghKHIgaW5zdGFuY2VvZiBSZWdFeHApKSB7XG4gICAgdGhyb3cgRXJyb3IoXCJpbGxlZ2FsIHN0YXRlXCIgKyBKU09OLnN0cmluZ2lmeShhKSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAxLFxuICAgIHJlZ2V4cDogcixcbiAgICBhcmdzTWFwOiBhWzFdXG4gIH07XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlUnVsZShhOiBhbnkpOiBJTWF0Y2guSW50ZW50UnVsZSB7XG4gIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gcGFyc2VSdWxlU3RyaW5nKGEpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoYSkpIHtcbiAgICByZXR1cm4gcGFyc2VSdWxlQXJyYXkoYSk7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKFwidW5rbm93biBydWxlIGRlZmluaXRpb25cIik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVJ1bGVzKG9KU09OOiB7IFtrZXk6IHN0cmluZ106IGFueSB9KTogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4gfSB7XG4gIHZhciByZXMgPSB7fTtcbiAgT2JqZWN0LmtleXMob0pTT04pLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICByZXNbc0tleV0gPSBvSlNPTltzS2V5XS5tYXAoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICByZXR1cm4gcGFyc2VSdWxlKG9SdWxlKTtcbiAgICB9KVxuICB9KTtcbiAgcmV0dXJuIHJlcztcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBleHRyYWN0QXJnc01hcChzIDogc3RyaW5nLCBtYXRjaDogQXJyYXk8c3RyaW5nPiwgYXJnc01hcDogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfSk6IEFycmF5PGJ1aWxkZXIuSUVudGl0eT4ge1xuICBpZiAoIWFyZ3NNYXApIHtcbiAgICByZXR1cm4gW107XG4gIH1cbiAgdmFyIHJlc3VsdCA9IFtdO1xuICBPYmplY3Qua2V5cyhhcmdzTWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgdmFyIHJlcyA9IHt9IGFzIGJ1aWxkZXIuSUVudGl0eTtcbiAgICB2YXIgaW5kZXggPSBhcmdzTWFwW3NLZXldO1xuICAgIHZhciB2YWx1ZSA9IG1hdGNoW2luZGV4XVxuICAgIGlmICgodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSAmJiB2YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICByZXMudHlwZSA9IHNLZXk7XG4gICAgICByZXMuZW50aXR5ID0gdmFsdWU7XG4gICAgICByZXMuc3RhcnRJbmRleCA9IHMuaW5kZXhPZih2YWx1ZSk7IC8vIHRoaXMgbWF5IG5vdCBiZSBwcmVjaXNlXG4gICAgICByZXMuZW5kSW5kZXggPSByZXMuc3RhcnRJbmRleCArIHZhbHVlLmxlbmd0aDtcbiAgICAgIC8vcmVzW3NLZXldID0gdmFsdWVcbiAgICAgIHJlc3VsdC5wdXNoKHJlcyk7XG4gICAgfVxuICB9XG4gICk7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHRleHQgOiBzdHJpbmcsIG9SdWxlIDogSU1hdGNoLkludGVudFJ1bGUpIDogYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdCB7XG4gIGRlYnVnbG9nKFwicmVnZXhwIGlzIFwiICsgb1J1bGUucmVnZXhwLnRvU3RyaW5nKCkpO1xuICBkZWJ1Z2xvZyhcIiB0ZXh0IGlzIFwiICsgdGV4dCk7XG4gIHZhciBtID0gb1J1bGUucmVnZXhwLmV4ZWModGV4dCk7XG4gIGlmICghbSkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgdmFyIHJlcyA9IHt9IGFzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQ7XG4gIHJlcy5lbnRpdGllcyA9IGV4dHJhY3RBcmdzTWFwKHRleHQsIG0sIG9SdWxlLmFyZ3NNYXApO1xuICByZXMuc2NvcmUgPSAwLjk7XG4gIGRlYnVnbG9nKFwibWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtKSk7XG4gIGRlYnVnbG9nKCdGb3VuZCBvbmUnICsgSlNPTi5zdHJpbmdpZnkocmVzLCB1bmRlZmluZWQsIDIpKTtcbiAgcmV0dXJuIHJlcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlY29nbml6ZVRleHQodGV4dCA6IHN0cmluZywgYVJ1bGVzIDogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+KSA6IGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHR7XG4gICAgdmFyIHJlcyA9IHVuZGVmaW5lZDtcbiAgICBhUnVsZXMuZXZlcnkoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICAgIHJlcyA9IG1hdGNoUmVndWxhckV4cHJlc3Npb24odGV4dCwgb1J1bGUpO1xuICAgICAgICByZXR1cm4gIXJlcztcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuXG5leHBvcnQgY2xhc3MgUmVnRXhwUmVjb2duaXplciBpbXBsZW1lbnRzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXIge1xuICBvUnVsZXM6IHsgW2tleTogc3RyaW5nXTogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+IH07XG5cbiAgY29uc3RydWN0b3IoeFJ1bGVzOiB7IFtrZXk6IHN0cmluZ106IEFycmF5PElNYXRjaC5JbnRlbnRSdWxlPiB9KSB7XG4gICAgdGhpcy5vUnVsZXMgPSB4UnVsZXM7XG4gICAgZGVidWdsb2coXCJydWxlcyBcIiArIEpTT04uc3RyaW5naWZ5KHRoaXMub1J1bGVzKSk7XG4gIH07XG5cbiAgcmVjb2duaXplKGNvbnRleHQ6IGJ1aWxkZXIuSVJlY29nbml6ZUNvbnRleHQsIGNhbGxiYWNrOiAoZXJyOiBFcnJvciwgcmVzdWx0OiBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdmFyIHUgPSB7fSBhcyBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0O1xuICAgIHZhciB0ZXh0ID0gY29udGV4dC5tZXNzYWdlLnRleHQ7XG4gICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgIGRlYnVnbG9nKFwicnVsZXMgXCIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLm9SdWxlcykpO1xuICAgIHZhciByZXN1bHRzID0gT2JqZWN0LmtleXModGhpcy5vUnVsZXMpLm1hcChmdW5jdGlvbiAoc0tleSkge1xuICAgICAgdmFyIHUgPSByZWNvZ25pemVUZXh0KHRleHQsIHRoYXQub1J1bGVzW3NLZXldKTtcbiAgICAgIGlmICh1KSB7XG4gICAgICAgIHUuaW50ZW50ID0gc0tleTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB1ID8gIHUgOiB1bmRlZmluZWQ7XG4gICAgfSkuZmlsdGVyKGZ1bmN0aW9uIChvKSB7IHJldHVybiAhIW87IH0pO1xuICAgIGlmIChyZXN1bHRzLmxlbmd0aCA+IDEpIHtcbiAgICAgIC8qIFRPRE8gYWJpZ3VvdXMgKi9cbiAgICAgIGRlYnVnbG9nKFwiYW1iaWd1b3VzIHJlc3VsdCBmb3IgPlwiICsgdGV4dCArIFwiPFwiICsgSlNPTi5zdHJpbmdpZnkocmVzKSk7XG4gICAgfVxuICAgIGlmIChyZXN1bHRzLmxlbmd0aCA+IDApIHtcbiAgICAgIHZhciByZXMgPSByZXN1bHRzWzBdO1xuICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCByZXMpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkZWJ1Z2xvZygncmVjb2duaXppbmcgbm90aGluZycpO1xuICAgIHUuaW50ZW50ID0gXCJOb25lXCI7XG4gICAgdS5zY29yZSA9IDAuMTtcbiAgICB2YXIgZTEgPSB7fSBhcyBidWlsZGVyLklFbnRpdHk7XG4gICAgZTEuc3RhcnRJbmRleCA9IFwiZXhpdCBcIi5sZW5ndGg7XG4gICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgZTEuc2NvcmUgPSAwLjE7XG4gICAgdS5lbnRpdGllcyA9IFtdO1xuICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gIH1cbn0gLy8gY2xhc3NcblxuXG5cbiIsIi8qKlxuICogQGNvcHlyaWdodCAoYykgMjAxNiBHZXJkIEZvcnN0bWFublxuICovXG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygncGxhaW5yZWNvZ25pemVyJyk7XG52YXIgQW55T2JqZWN0ID0gT2JqZWN0O1xuZnVuY3Rpb24gcmVjb2duaXplKHNTdHJpbmcsIG1SdWxlcykge1xuICAgIHZhciByZXMgPSB1bmRlZmluZWQ7XG4gICAgbVJ1bGVzLmV2ZXJ5KGZ1bmN0aW9uIChvUnVsZSkge1xuICAgICAgICByZXMgPSBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHNTdHJpbmcsIG9SdWxlKTtcbiAgICAgICAgcmV0dXJuICFyZXM7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcztcbn1cbmV4cG9ydHMucmVjb2duaXplID0gcmVjb2duaXplO1xuZnVuY3Rpb24gY291bnRQYXJlbkdyb3VwcyhzKSB7XG4gICAgdmFyIHJlcyA9IDA7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgIGlmIChzLmNoYXJBdChpKSA9PT0gJygnKSB7XG4gICAgICAgICAgICArK3JlcztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5jb3VudFBhcmVuR3JvdXBzID0gY291bnRQYXJlbkdyb3Vwcztcbi8qKlxuICogZ2l2ZW4gYSBzdHJpbmcsIGUuZy5cbiAqIFwid2hvIGlzIHRoZSA8Y2F0ZWdvcnk+IG9mIDxBMT5cIixcbiAqIEBwYXJhbSB7c3RyaW5nfSBhXG4gKiBAcmV0dXJucyB7SU1hdGNoLklSdWxlfSBhIHJlZ2V4cCBydWxlXG4gKi9cbmZ1bmN0aW9uIHBhcnNlUnVsZVN0cmluZyhhKSB7XG4gICAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgICB2YXIgYXJnTWFwcyA9IHt9O1xuICAgIHZhciBtID0gdW5kZWZpbmVkO1xuICAgIHdoaWxlIChtID0gLzwoW14+XSspPi8uZXhlYyhzKSkge1xuICAgICAgICB2YXIgY2F0ID0gbVsxXTtcbiAgICAgICAgdmFyIHBvcyA9IDEgKyBjb3VudFBhcmVuR3JvdXBzKHMuc3Vic3RyaW5nKDAsIG0uaW5kZXgpKTtcbiAgICAgICAgcyA9IHMucmVwbGFjZShcIjxcIiArIGNhdCArIFwiPlwiLCBcIiguKilcIik7XG4gICAgICAgIGlmIChhcmdNYXBzW2NhdF0pIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFwiTW9kZWwgZXJyb3IgZHVwbGljYXRlIGVudHJ5IVwiKTtcbiAgICAgICAgfVxuICAgICAgICBhcmdNYXBzW2NhdF0gPSBwb3M7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IDEsXG4gICAgICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChzLCBcImlcIiksXG4gICAgICAgIGFyZ3NNYXA6IGFyZ01hcHNcbiAgICB9O1xufVxuZXhwb3J0cy5wYXJzZVJ1bGVTdHJpbmcgPSBwYXJzZVJ1bGVTdHJpbmc7XG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5mdW5jdGlvbiBwYXJzZVJ1bGVBcnJheShhKSB7XG4gICAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgICB2YXIgciA9IGFbMF07XG4gICAgaWYgKHR5cGVvZiBhWzBdID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHIgPSBuZXcgUmVnRXhwKGFbMF0sIFwiaVwiKTtcbiAgICB9XG4gICAgaWYgKCEociBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXCJpbGxlZ2FsIHN0YXRlXCIgKyBKU09OLnN0cmluZ2lmeShhKSk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IDEsXG4gICAgICAgIHJlZ2V4cDogcixcbiAgICAgICAgYXJnc01hcDogYVsxXVxuICAgIH07XG59XG5leHBvcnRzLnBhcnNlUnVsZUFycmF5ID0gcGFyc2VSdWxlQXJyYXk7XG5mdW5jdGlvbiBwYXJzZVJ1bGUoYSkge1xuICAgIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIHBhcnNlUnVsZVN0cmluZyhhKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShhKSkge1xuICAgICAgICByZXR1cm4gcGFyc2VSdWxlQXJyYXkoYSk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihcInVua25vd24gcnVsZSBkZWZpbml0aW9uXCIpO1xufVxuZXhwb3J0cy5wYXJzZVJ1bGUgPSBwYXJzZVJ1bGU7XG5mdW5jdGlvbiBwYXJzZVJ1bGVzKG9KU09OKSB7XG4gICAgdmFyIHJlcyA9IHt9O1xuICAgIE9iamVjdC5rZXlzKG9KU09OKS5mb3JFYWNoKGZ1bmN0aW9uIChzS2V5KSB7XG4gICAgICAgIHJlc1tzS2V5XSA9IG9KU09OW3NLZXldLm1hcChmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJzZVJ1bGUob1J1bGUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuZXhwb3J0cy5wYXJzZVJ1bGVzID0gcGFyc2VSdWxlcztcbjtcbmZ1bmN0aW9uIGV4dHJhY3RBcmdzTWFwKHMsIG1hdGNoLCBhcmdzTWFwKSB7XG4gICAgaWYgKCFhcmdzTWFwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgdmFyIHJlc3VsdCA9IFtdO1xuICAgIE9iamVjdC5rZXlzKGFyZ3NNYXApLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgICAgdmFyIHJlcyA9IHt9O1xuICAgICAgICB2YXIgaW5kZXggPSBhcmdzTWFwW3NLZXldO1xuICAgICAgICB2YXIgdmFsdWUgPSBtYXRjaFtpbmRleF07XG4gICAgICAgIGlmICgodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSAmJiB2YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXMudHlwZSA9IHNLZXk7XG4gICAgICAgICAgICByZXMuZW50aXR5ID0gdmFsdWU7XG4gICAgICAgICAgICByZXMuc3RhcnRJbmRleCA9IHMuaW5kZXhPZih2YWx1ZSk7IC8vIHRoaXMgbWF5IG5vdCBiZSBwcmVjaXNlXG4gICAgICAgICAgICByZXMuZW5kSW5kZXggPSByZXMuc3RhcnRJbmRleCArIHZhbHVlLmxlbmd0aDtcbiAgICAgICAgICAgIC8vcmVzW3NLZXldID0gdmFsdWVcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHJlcyk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xufVxuZXhwb3J0cy5leHRyYWN0QXJnc01hcCA9IGV4dHJhY3RBcmdzTWFwO1xuZnVuY3Rpb24gbWF0Y2hSZWd1bGFyRXhwcmVzc2lvbih0ZXh0LCBvUnVsZSkge1xuICAgIGRlYnVnbG9nKFwicmVnZXhwIGlzIFwiICsgb1J1bGUucmVnZXhwLnRvU3RyaW5nKCkpO1xuICAgIGRlYnVnbG9nKFwiIHRleHQgaXMgXCIgKyB0ZXh0KTtcbiAgICB2YXIgbSA9IG9SdWxlLnJlZ2V4cC5leGVjKHRleHQpO1xuICAgIGlmICghbSkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB2YXIgcmVzID0ge307XG4gICAgcmVzLmVudGl0aWVzID0gZXh0cmFjdEFyZ3NNYXAodGV4dCwgbSwgb1J1bGUuYXJnc01hcCk7XG4gICAgcmVzLnNjb3JlID0gMC45O1xuICAgIGRlYnVnbG9nKFwibWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtKSk7XG4gICAgZGVidWdsb2coJ0ZvdW5kIG9uZScgKyBKU09OLnN0cmluZ2lmeShyZXMsIHVuZGVmaW5lZCwgMikpO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLm1hdGNoUmVndWxhckV4cHJlc3Npb24gPSBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uO1xuZnVuY3Rpb24gcmVjb2duaXplVGV4dCh0ZXh0LCBhUnVsZXMpIHtcbiAgICB2YXIgcmVzID0gdW5kZWZpbmVkO1xuICAgIGFSdWxlcy5ldmVyeShmdW5jdGlvbiAob1J1bGUpIHtcbiAgICAgICAgcmVzID0gbWF0Y2hSZWd1bGFyRXhwcmVzc2lvbih0ZXh0LCBvUnVsZSk7XG4gICAgICAgIHJldHVybiAhcmVzO1xuICAgIH0pO1xuICAgIHJldHVybiByZXM7XG59XG5leHBvcnRzLnJlY29nbml6ZVRleHQgPSByZWNvZ25pemVUZXh0O1xudmFyIFJlZ0V4cFJlY29nbml6ZXIgPSAoZnVuY3Rpb24gKCkge1xuICAgIGZ1bmN0aW9uIFJlZ0V4cFJlY29nbml6ZXIoeFJ1bGVzKSB7XG4gICAgICAgIHRoaXMub1J1bGVzID0geFJ1bGVzO1xuICAgICAgICBkZWJ1Z2xvZyhcInJ1bGVzIFwiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5vUnVsZXMpKTtcbiAgICB9XG4gICAgO1xuICAgIFJlZ0V4cFJlY29nbml6ZXIucHJvdG90eXBlLnJlY29nbml6ZSA9IGZ1bmN0aW9uIChjb250ZXh0LCBjYWxsYmFjaykge1xuICAgICAgICB2YXIgdSA9IHt9O1xuICAgICAgICB2YXIgdGV4dCA9IGNvbnRleHQubWVzc2FnZS50ZXh0O1xuICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgICAgIGRlYnVnbG9nKFwicnVsZXMgXCIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLm9SdWxlcykpO1xuICAgICAgICB2YXIgcmVzdWx0cyA9IE9iamVjdC5rZXlzKHRoaXMub1J1bGVzKS5tYXAoZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgICAgICAgIHZhciB1ID0gcmVjb2duaXplVGV4dCh0ZXh0LCB0aGF0Lm9SdWxlc1tzS2V5XSk7XG4gICAgICAgICAgICBpZiAodSkge1xuICAgICAgICAgICAgICAgIHUuaW50ZW50ID0gc0tleTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB1ID8gdSA6IHVuZGVmaW5lZDtcbiAgICAgICAgfSkuZmlsdGVyKGZ1bmN0aW9uIChvKSB7IHJldHVybiAhIW87IH0pO1xuICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAvKiBUT0RPIGFiaWd1b3VzICovXG4gICAgICAgICAgICBkZWJ1Z2xvZyhcImFtYmlndW91cyByZXN1bHQgZm9yID5cIiArIHRleHQgKyBcIjxcIiArIEpTT04uc3RyaW5naWZ5KHJlcykpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHZhciByZXMgPSByZXN1bHRzWzBdO1xuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCByZXMpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGRlYnVnbG9nKCdyZWNvZ25pemluZyBub3RoaW5nJyk7XG4gICAgICAgIHUuaW50ZW50ID0gXCJOb25lXCI7XG4gICAgICAgIHUuc2NvcmUgPSAwLjE7XG4gICAgICAgIHZhciBlMSA9IHt9O1xuICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJleGl0IFwiLmxlbmd0aDtcbiAgICAgICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgICAgIGUxLnNjb3JlID0gMC4xO1xuICAgICAgICB1LmVudGl0aWVzID0gW107XG4gICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgfTtcbiAgICByZXR1cm4gUmVnRXhwUmVjb2duaXplcjtcbn0oKSk7XG5leHBvcnRzLlJlZ0V4cFJlY29nbml6ZXIgPSBSZWdFeHBSZWNvZ25pemVyOyAvLyBjbGFzc1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
