/**
 * The bot implementation
 *
 * Instantiate apssing a connector via
 * makeBot
 *
 */
/**
 * @file
 * @module jfseb.fdevstart.smartdialog
 * @copyright (c) 2016 Gerd Forstmann
 */
//declare module 'elizabot' { };
//declare module 'winston-pg' { };
//delcare module 'winston' {};
"use strict";

var builder = require('botbuilder');
var debug = require('debug');
var Match = require('../match/match');
var Analyze = require('../match/analyze');
var WhatIs = require('../match/whatis');
var ListAll = require('../match/listall');
var DialogLogger = require('../utils/dialoglogger');
var process = require('process');
var dburl = process.env.DATABASE_URL || "";
var pglocalurl = "postgres://joe:abcdef@localhost:5432/abot";
var dburl = process.env.DATABASE_URL || pglocalurl;
var pg = require('pg');
var o = pg;
o.defaults.ssl = true;
var dialogLogger = DialogLogger.logger("smartbot", dburl, pg);
function send(o) {
    return o;
}
;
function dialoglog(intent, session, response) {
    var sResponse;
    var sAction;
    if (typeof response === "string") {
        sAction = "";
        sResponse = response;
    } else {
        var aMessage = response;
        var iMessage = aMessage.toMessage();
        sResponse = iMessage.text;
        sAction = iMessage.entities && iMessage.entities[0] ? JSON.stringify(iMessage.entities && iMessage.entities[0]) : "";
    }
    dialogLogger({
        intent: intent,
        session: session,
        response: sResponse,
        action: sAction
    });
    session.send(response);
}
//const pgLogger = new PgLogger({
//  name: 'test-logger',
//  level: 'debug',
//  connString: 'postgres://ubuntu@localhost:5432/circle_test',
//  tableName: 'winston_logs',
//});
//winston.add(winston.transports.File, { filename: 'winston_out.log', timestamp : true });
//  winston.remove(winston.transports.Console);
//winston.add(pgLogger);
/*
const logger = new winston.Logger({
  transports: [
    new winston.transports.Console({
      color: true,
      timestamp: true,
    }),
    pgLogger,
  ]
});
*/
//pgLogger.initTable(done);
var elizabot = require('../extern/elizabot/elizabot.js');
//import * as elizabot from 'elizabot';
var debuglog = debug('smartdialog');
var PlainRecognizer = require('./plainrecognizer');
//var builder = require('botbuilder');
var dispatcher = require('../match/dispatcher.js').dispatcher;
function getConversationId(session) {
    return session.message && session.message.address && session.message.address.conversation.id;
}
var elizabots = {};
function getElizaBot(id) {
    if (!elizabots[id]) {
        elizabots[id] = {
            access: new Date(),
            elizabot: new elizabot()
        };
    }
    elizabots[id].access = new Date();
    return elizabots[id].elizabot;
}
var newFlow = true;
var Model = require('../model/model');
var ExecServer = require('../exec/execserver');
var theModel = Model.loadModels();
if (newFlow) {} else {}
function isAnonymous(userid) {
    return userid.indexOf("ano:") === 0;
}
function restrictLoggedOn(session, arr) {
    var userid = session.message.address && session.message.address.user && session.message.address.user.id || "";
    if (process.env.ABOT_EMAIL_USER && isAnonymous(userid)) {
        if (arr.length < 6) {
            return arr;
        }
        var len = arr.length;
        var res = arr.slice(0, Math.min(Math.max(Math.floor(arr.length / 3), 7), arr.length));
        if (typeof arr[0] === "string") {
            var delta = len - res.length;
            res.push("... and " + delta + " more entries for registered users");
        }
        return res;
    }
    return arr;
}
var SimpleRecognizer = function () {
    function SimpleRecognizer() {}
    SimpleRecognizer.prototype.recognize = function (context, callback) {
        var u = {};
        debuglog("recognizing " + context.message.text);
        if (context.message.text.indexOf("start") >= 0) {
            u.intent = "ShowEntity";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "start ".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("train") >= 0) {
            u.intent = "train";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "train ".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("learn") >= 0) {
            u.intent = "learn";
            u.score = 0.9;
            var e1 = {};
            e1.type = "trainFact";
            e1.startIndex = "train ".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("help") >= 0) {
            u.intent = "help";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "train ".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("exit") >= 0) {
            u.intent = "exit";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "exit ".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("wrong") >= 0) {
            u.intent = "wrong";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "exit ".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        debuglog('recognizing nothing');
        u.intent = "None";
        u.score = 0.1;
        var e1 = {};
        e1.startIndex = "exit ".length;
        e1.endIndex = context.message.text.length;
        e1.score = 0.1;
        u.entities = [];
        callback(undefined, u);
    };
    return SimpleRecognizer;
}();
var aTrainReplies = ["Thank you for sharing this suggestion with us", "Thank for for this valuable information.", "Thank for for this interesting fact!", "Thats a plethoria of information.", "That's a nugget of information.", "Lovely, I may consider you input.", "Well done, anything more to let me know?", "I do appreciate your teaching and my learning experience, or was it the other way round?", "Your helpful input has been stored in some dusty corner of the World wide web!", "Thank you for my learning experience!", "I have incorporated your valuable suggestion in the wisdom of the internet"];
var aTrainDialog = aTrainReplies;
var aTrainExitHint = ["\ntype \"done\" when you are done training me.", "", "", "", "\nremember, you are stuck here instructing me, type \"done\" to return.", ""];
var aEnterTrain = ["So you think this is wrong? You can offer your advise here.\n Type \"done\" if you are done with instructing me", "Feel free to offer me your better solution here.\n", "Some say \"The secret to happiness is to lower your expectations to the point they are already met.\", \nt if you could help me to becomde better, instruct me.", "Feel free to offer me your better solution here.\n Type \"done\" if you are done with instructing me", "Feel free to offer me your better solution here.\n Type \"done\" if you are done with instructing me"];
var aBackFromTraining = ["Puuh, back from training! Now for the easy part ...", "Live and don't learn, that's us. Naah, we'll see.", "The secret to happiness is to lower your expectations to the point they are already met.", "Thanks for having this lecture session, now back to our usual self."];
var aTrainNoKlingon = ["He who master the dark arts of SAP must not dwell in the earthly realms of Start Trek.", "SAP is a cloud company, not a space company.", "The depth of R/3 are deeper than Deep Space 42.", "My brainpower is fully absorbed with mastering other realms.", "For the wosap, the sky is the limit. Feel free to check out nasa.gov .", "The future is SAP or IBM blue, not space black.", "That's left to some musky future."];
function getRandomResult(arr) {
    return arr[Math.floor(Math.random() * arr.length) % arr.length];
}
var SimpleUpDownRecognizer = function () {
    function SimpleUpDownRecognizer() {}
    SimpleUpDownRecognizer.prototype.recognize = function (context, callback) {
        var u = {};
        debuglog("recognizing " + context.message.text);
        if (context.message.text.indexOf("down") >= 0) {
            u.intent = "intent.down";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "start ".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("up") >= 0) {
            u.intent = "intent.up";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "up".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("done") >= 0) {
            u.intent = "intent.up";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "up".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("exit") >= 0) {
            u.intent = "intent.up";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "up".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        if (context.message.text.indexOf("quit") >= 0) {
            u.intent = "intent.up";
            u.score = 0.9;
            var e1 = {};
            e1.startIndex = "up".length;
            e1.endIndex = context.message.text.length;
            e1.score = 0.3;
            u.entities = [e1];
            callback(undefined, u);
            return;
        }
        debuglog('recognizing nothing');
        u.intent = "None";
        u.score = 0.1;
        var e1 = {};
        e1.startIndex = "exit ".length;
        e1.endIndex = context.message.text.length;
        e1.score = 0.1;
        u.entities = [];
        callback(undefined, u);
    };
    return SimpleUpDownRecognizer;
}();
var AnyObject = Object;
// globalTunnel.initialize({
//  host: 'proxy.exxxample.com',
//  port: 8080
// })
// Create bot and bind to console
// var connector = new htmlconnector.HTMLConnector()
// connector.setAnswerHook(function (sAnswer) {
//  console.log('Got answer : ' + sAnswer + '\n')
// })
var bot;
// setTimeout(function () {
//   connector.processMessage('start unit test ABC ')
// }, 5000)
var fs = require('fs');
var oJSON = JSON.parse('' + fs.readFileSync('./resources/model/intents.json'));
var oRules = PlainRecognizer.parseRules(oJSON);
// var Recognizer = new (recognizer.RegExpRecognizer)(oRules);
function logQuery(session, intent, result) {
    fs.appendFile('./logs/showmequeries.txt', "\n" + JSON.stringify({
        text: session.message.text,
        timestamp: session.message.timestamp,
        intent: intent,
        res: result && result.length && Match.ToolMatch.dumpNice(result[0]) || "0",
        conversationId: session.message.address && session.message.address.conversation && session.message.address.conversation.id || "",
        userid: session.message.address && session.message.address.user && session.message.address.user.id || ""
    }), function (err, res) {
        if (err) {
            debuglog("logging failed " + err);
        }
    });
}
function logQueryWhatIs(session, intent, result) {
    fs.appendFile('./logs/showmequeries.txt', "\n" + JSON.stringify({
        text: session.message.text,
        timestamp: session.message.timestamp,
        intent: intent,
        res: result && result.length && WhatIs.dumpNice(result[0]) || "0",
        conversationId: session.message.address && session.message.address.conversation && session.message.address.conversation.id || "",
        userid: session.message.address && session.message.address.user && session.message.address.user.id || ""
    }), function (err, res) {
        if (err) {
            debuglog("logging failed " + err);
        }
    });
}
var gwords = {};
/**
 * Construct a bot
 * @param connector {Connector} the connector to use
 * HTMLConnector
 * or connector = new builder.ConsoleConnector().listen()
 */
function makeBot(connector) {
    bot = new builder.UniversalBot(connector);
    // Create LUIS recognizer that points at our model and add it as the root '/' dialog for our Cortana Bot.
    // var model = sensitive.modelurl;
    // var model = 'https://api.projectoxford.ai/luis/v2.0/apps/c413b2ef-382c-45bd-8ff0-f76d60e2a821?subscription-key=c21398b5980a4ce09f474bbfee93b892&q='
    var recognizer = new PlainRecognizer.RegExpRecognizer(oRules);
    var dialog = new builder.IntentDialog({ recognizers: [recognizer] });
    // dialog.onBegin(function(session,args) {
    // console.log("beginning ...")
    // session.dialogData.retryPrompt = args && args.retryPrompt || "I am sorry"
    // session.send("What do you want?")
    //
    // })
    var dialogUpDown = new builder.IntentDialog({ recognizers: [new SimpleUpDownRecognizer()] });
    bot.dialog('/updown', dialogUpDown);
    dialogUpDown.onBegin(function (session) {
        dialoglog("TrainMe", session, send(getRandomResult(aEnterTrain)));
        //session.send("Hi there, updown is waiting for you");
    });
    dialogUpDown.matches('intent.up', [function (session, args, next) {
        session.dialogData.abc = args || {};
        builder.Prompts.text(session, 'you want to exit training? type \"done\" again.');
    }, function (session, results, next) {
        session.dialogData.abc = results.reponse;
        next();
    }, function (session, results) {
        session.endDialogWithResult({ response: session.dialogData.abc });
    }]);
    dialogUpDown.matches('intent.down', [function (session, args, next) {
        session.dialogData.abc = args || {};
        builder.Prompts.text(session, 'you want to go down!');
    }, function (session, results, next) {
        session.dialogData.abc = -1; // results.reponse;
        next();
    }, function (session, results) {
        session.send("still going down?");
    }]);
    dialogUpDown.onDefault(function (session) {
        logQuery(session, "onDefault");
        var res = getRandomResult(aTrainDialog) + getRandomResult(aTrainExitHint);
        dialoglog("TrainMe", session, send(res));
    });
    bot.dialog('/train', [function (session, args, next) {
        session.dialgoData.abc = args || {};
        builder.Prompts.text(session, 'Do you want to train me');
    }, function (session, results, next) {
        session.dialogData.abc = results.reponse;
    }, function (session, results) {
        session.endDialogWithResult({ response: session.DialogData.abc });
    }]);
    bot.dialog('/', dialog);
    dialog.matches('ShowMe', [function (session, args, next) {
        var isCombinedIndex = {};
        var oNewEntity;
        // expecting entity A1
        debuglog("Show Entity");
        debuglog('raw: ' + JSON.stringify(args.entities), undefined, 2);
        var a1 = builder.EntityRecognizer.findEntity(args.entities, 'A1');
        var result = Analyze.analyzeAll(a1.entity, theModel.mRules, theModel.tools, gwords);
        logQuery(session, 'ShowMe', result);
        // test.expect(3)
        //  test.deepEqual(result.weight, 120, 'correct weight');
        if (!result || result.length === 0) {
            next();
        }
        // debuglog('result : ' + JSON.stringify(result, undefined, 2));
        debuglog('best result : ' + JSON.stringify(result[0] || {}, undefined, 2));
        debuglog('top : ' + Match.ToolMatch.dumpWeightsTop(result, { top: 3 }));
        if (Analyze.isComplete(result[0])) {
            session.dialogData.result = result[0];
            //    session.send('Showing entity ...');
            next();
        } else if (Analyze.getPrompt(result[0])) {
            var prompt = Analyze.getPrompt(result[0]);
            session.dialogData.result = result[0];
            session.dialogData.prompt = prompt;
            dialoglog("ShowMe", session, send("Not enough information supplied: " + Match.ToolMatch.dumpNice(session.dialogData.result)));
            builder.Prompts.text(session, prompt.text);
        } else {
            var best = result.length ? Match.ToolMatch.dumpNice(result[0]) : "<nothing>";
            dialoglog("ShowMe", session, send('I did not understand this' + best));
        }
    }, function (session, results, next) {
        var result = session.dialogData.result;
        if (!result || result.length === 0) {
            next();
        }
        if (results.response) {
            // some prompting
            Analyze.setPrompt(session.dialogData.result, session.dialogData.prompt, results.response);
        }
        if (Analyze.isComplete(session.dialogData.result)) {
            next();
        } else if (Analyze.getPrompt(session.dialogData.result)) {
            var prompt = Analyze.getPrompt(session.dialogData.result);
            session.dialogData.prompt = prompt;
            builder.Prompts.text(session, prompt.text);
        }
    }, function (session, results, next) {
        var result = session.dialogData.result;
        if (results.response) {
            // some prompting
            Analyze.setPrompt(session.dialogData.result, session.dialogData.prompt, results.response);
        }
        if (Analyze.isComplete(session.dialogData.result)) {
            var exec = ExecServer.execTool(session.dialogData.result, theModel.records);
            var reply = new builder.Message(session).text(exec.text).addEntity(exec.action);
            // .addAttachment({ fallbackText: "I don't know", contentType: 'image/jpeg', contentUrl: "www.wombat.org" });
            dialoglog("ShowMe", session, send(reply));
        } else {
            if (session.dialogData.result) {
                dialoglog("ShowMe", session, send("Not enough information supplied: " + Match.ToolMatch.dumpNice(session.dialogData.result)));
            } else {
                dialoglog("ShowMe", session, send("I did not get what you want"));
            }
        }
    }]);
    dialog.matches('WhatIs', [function (session, args, next) {
        var isCombinedIndex = {};
        var oNewEntity;
        // expecting entity A1
        var message = session.message.text;
        debuglog("WhatIs Entities");
        debuglog('raw: ' + JSON.stringify(args.entities), undefined, 2);
        var categoryEntity = builder.EntityRecognizer.findEntity(args.entities, 'category');
        var category = categoryEntity.entity;
        var a1 = builder.EntityRecognizer.findEntity(args.entities, 'A1');
        var cat = WhatIs.analyzeCategory(category, theModel.mRules, message);
        if (!cat) {
            session.send('I don\'t know anything about "' + category + '"');
            // next();
            return;
        }
        debuglog('category identified:' + cat);
        var result = WhatIs.resolveCategory(cat, a1.entity, theModel.mRules, theModel.records);
        debuglog('whatis result:' + JSON.stringify(result));
        logQueryWhatIs(session, 'WhatIs', result);
        var indis = WhatIs.isIndiscriminateResult(result);
        if (indis) {
            session.send(indis);
            // next();
            return;
        }
        if (!result || result.length === 0) {
            dialoglog("WhatIs", session, send('I don\'t know anything about "' + cat + " (" + category + ')\" in relation to "' + a1.entity + '"'));
            // next();
            return;
        } else {
            // debuglog('result : ' + JSON.stringify(result, undefined, 2));
            debuglog('best result : ' + JSON.stringify(result[0] || {}, undefined, 2));
            debuglog('top : ' + WhatIs.dumpWeightsTop(result, { top: 3 }));
            // TODO cleansed sentence
            dialoglog("WhatIs", session, send('The ' + category + ' of ' + a1.entity + ' is ' + result[0].result + "\n")); //  + JSON.stringify(result[0]));
        }
    }]);
    dialog.matches('ListAll', [function (session, args, next) {
        var isCombinedIndex = {};
        var oNewEntity;
        // expecting entity A1
        var message = session.message.text;
        debuglog("Intent : ListAll");
        debuglog('raw: ' + JSON.stringify(args.entities), undefined, 2);
        var categoryEntity = builder.EntityRecognizer.findEntity(args.entities, 'categories');
        var category = categoryEntity.entity;
        var a1 = builder.EntityRecognizer.findEntity(args.entities, 'insth');
        if (category === "categories") {
            // do we have a filter ?
            var domain = undefined;
            if (a1 && a1.entity) {
                domain = ListAll.inferDomain(theModel, a1.entity);
            }
            if (!domain) {
                var res = restrictLoggedOn(session, theModel.category).join(";\n");
                if (a1 && a1.entity) {
                    dialoglog("ListAll", session, send("I did not infer a domain restriction from \"" + a1.entity + "\", all my categories are ...\n" + res));
                } else {
                    dialoglog("ListAll", session, send("my categories are ...\n" + res));
                }
                return;
            } else {
                var aRes = Model.getCategoriesForDomain(theModel, domain);
                var res = restrictLoggedOn(session, aRes).join(";\n");
                dialoglog("ListAll", session, send("my categories in domain \"" + domain + "\" are ...\n" + res));
                return;
            }
        }
        if (category === "domains") {
            var res = restrictLoggedOn(session, theModel.domains).join(";\n");
            session.send("my domains are ...\n" + res);
            return;
        }
        if (category === "tools") {
            var res = restrictLoggedOn(session, theModel.tools).map(function (oTool) {
                return oTool.name;
            }).join(";\n");
            dialoglog("ListAll", session, send("my tools are ...\n" + res));
            return;
        }
        var cat = WhatIs.analyzeCategory(category, theModel.mRules, message);
        if (!cat) {
            dialoglog("ListAll", session, send('I don\'t know anything about "' + category + '"'));
            // next();
            return;
        }
        debuglog('category identified:' + cat);
        if (a1 && a1.entity) {
            debuglog('got filter:' + a1.entity);
            var result1 = ListAll.listAllWithContext(cat, a1.entity, theModel.mRules, theModel.records);
            // TODO classifying the string twice is a terrible waste
            if (!result1.length) {
                debuglog('going for having');
                result1 = ListAll.listAllHavingContext(cat, a1.entity, theModel.mRules, theModel.records);
            }
            debuglog('listall result:' + JSON.stringify(result1));
            var joinresults = restrictLoggedOn(session, ListAll.joinResults(result1));
            logQueryWhatIs(session, 'ListAll', result1);
            if (joinresults.length) {
                dialoglog("ListAll", session, send("the " + category + " for " + a1.entity + " are ...\n" + joinresults.join(";\n")));
            } else {
                dialoglog("ListAll", session, send("i did not find any " + category + " for " + a1.entity + ".\n" + joinresults.join(";\n")));
            }
            return;
        } else {
            // no entity, e.g. list all countries
            //
            var result = ListAll.listAllHavingContext(cat, cat, theModel.mRules, theModel.records);
            logQueryWhatIs(session, 'ListAll', result);
            if (result.length) {
                debuglog('listall result:' + JSON.stringify(result));
                var joinresults = [];
                debuglog("here is cat>" + cat);
                if (cat !== "example question") {
                    joinresults = restrictLoggedOn(session, ListAll.joinResults(result));
                } else {
                    joinresults = ListAll.joinResults(result);
                }
                var response = "the " + category + " are ...\n" + joinresults.join(";\n");
                dialoglog("ListAll", session, send(response));
                return;
            } else {
                var response = "Found no data having \"" + cat + "\"";
                dialoglog("ListAll", session, send(response));
                return;
            }
        }
    }]);
    dialog.matches('TrainMe', [function (session, args, next) {
        var isCombinedIndex = {};
        var oNewEntity;
        // expecting entity A1
        var message = session.message.text;
        debuglog("Intent : Train");
        debuglog('raw: ' + JSON.stringify(args.entities), undefined, 2);
        var categoryEntity = builder.EntityRecognizer.findEntity(args.entities, 'categories');
        if (message.toLowerCase().indexOf("kronos") >= 0 || message.toLowerCase().indexOf("klingon") >= 0) {
            dialoglog("TrainMe", session, send(getRandomResult(aTrainNoKlingon)));
            return;
        }
        var res = getRandomResult(aTrainReplies);
        dialoglog("TrainMe", session, send(res));
    }]);
    dialog.matches('Wrong', [function (session, args, next) {
        dialogLogger({
            session: session,
            intent: "Wrong",
            response: '<begin updown>'
        });
        session.beginDialog('/updown', session.userData.count);
    }, function (session, results, next) {
        var alarm = session.dialogData.alarm;
        next();
    }, function (session, results) {
        session.send(getRandomResult(aBackFromTraining)); //  + JSON.stringify(results));
        //session.send('end of wrong');
    }]);
    dialog.matches('Exit', [function (session, args, next) {
        debuglog('exit :');
        debuglog('exit' + JSON.stringify(args.entities));
        dialogLogger({
            session: session,
            intent: "Exit",
            response: 'you are in a logic loop'
        });
        session.send("you are in a logic loop ");
    }]);
    dialog.matches('Help', [function (session, args, next) {
        debuglog('help :');
        debuglog('help');
        session.send("I know about .... <categories>>");
    }]);
    // Add intent handlers
    dialog.matches('train', [function (session, args, next) {
        debuglog('train');
        // Resolve and store any entities passed from LUIS.
        var title = builder.EntityRecognizer.findEntity(args.entities, 'builtin.alarm.title');
        var time = builder.EntityRecognizer.resolveTime(args.entities);
        var alarm = session.dialogData.alarm = {
            title: title ? title.entity : null,
            timestamp: time ? time.getTime() : null
        };
        // Prompt for title
        if (!alarm.title) {
            dialogLogger({
                session: session,
                intent: "train",
                response: 'What fact would you like to train?'
            });
            builder.Prompts.text(session, 'What fact would you like to train?');
        } else {
            next();
        }
    }, function (session, results, next) {
        var alarm = session.dialogData.alarm;
        if (results.response) {
            alarm.title = results.response;
        }
        // Prompt for time (title will be blank if the user said cancel)
        if (alarm.title && !alarm.timestamp) {
            builder.Prompts.time(session, 'What time would you like to set the alarm for?');
        } else {
            next();
        }
    }, function (session, results) {
        var alarm = session.dialogData.alarm;
        if (results.response) {
            var time = builder.EntityRecognizer.resolveTime([results.response]);
            alarm.timestamp = time ? time.getTime() : null;
        }
        // Set the alarm (if title or timestamp is blank the user said cancel)
        if (alarm.title && alarm.timestamp) {
            // Save address of who to notify and write to scheduler.
            alarm.address = session.message.address;
            //alarms[alarm.title] = alarm;
            // Send confirmation to user
            var date = new Date(alarm.timestamp);
            var isAM = date.getHours() < 12;
            session.send('Creating alarm named "%s" for %d/%d/%d %d:%02d%s', alarm.title, date.getMonth() + 1, date.getDate(), date.getFullYear(), isAM ? date.getHours() : date.getHours() - 12, date.getMinutes(), isAM ? 'am' : 'pm');
        } else {
            session.send('Ok... no problem.');
        }
    }]);
    dialog.onDefault(function (session) {
        logQuery(session, "onDefault");
        var eliza = getElizaBot(getConversationId(session));
        var reply = eliza.transform(session.message.text);
        dialoglog("eliza", session, send(reply));
        //new Eilzabot
        //session.send("I do not understand this at all");
        //builder.DialogAction.send('I\'m sorry I didn\'t understand. I can only show start and ring');
    });
    /*
    // Very simple alarm scheduler
    var alarms = {};
    setInterval(function () {
      var now = new Date().getTime();
      for (var key in alarms) {
        var alarm = alarms[key];
        if (now >= alarm.timestamp) {
          var msg = new builder.Message()
            .address(alarm.address)
            .text('Here\'s your \'%s\' alarm.', alarm.title);
          bot.send(msg);
          delete alarms[key];
        }
      }
    }, 15000);
    */
}
if (module) {
    module.exports = {
        makeBot: makeBot
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ib3Qvc21hcnRkaWFsb2cudHMiLCJib3Qvc21hcnRkaWFsb2cuanMiXSwibmFtZXMiOlsiYnVpbGRlciIsInJlcXVpcmUiLCJkZWJ1ZyIsIk1hdGNoIiwiQW5hbHl6ZSIsIldoYXRJcyIsIkxpc3RBbGwiLCJEaWFsb2dMb2dnZXIiLCJwcm9jZXNzIiwiZGJ1cmwiLCJlbnYiLCJEQVRBQkFTRV9VUkwiLCJwZ2xvY2FsdXJsIiwicGciLCJvIiwiZGVmYXVsdHMiLCJzc2wiLCJkaWFsb2dMb2dnZXIiLCJsb2dnZXIiLCJzZW5kIiwiZGlhbG9nbG9nIiwiaW50ZW50Iiwic2Vzc2lvbiIsInJlc3BvbnNlIiwic1Jlc3BvbnNlIiwic0FjdGlvbiIsImFNZXNzYWdlIiwiaU1lc3NhZ2UiLCJ0b01lc3NhZ2UiLCJ0ZXh0IiwiZW50aXRpZXMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWN0aW9uIiwiZWxpemFib3QiLCJkZWJ1Z2xvZyIsIlBsYWluUmVjb2duaXplciIsImRpc3BhdGNoZXIiLCJnZXRDb252ZXJzYXRpb25JZCIsIm1lc3NhZ2UiLCJhZGRyZXNzIiwiY29udmVyc2F0aW9uIiwiaWQiLCJlbGl6YWJvdHMiLCJnZXRFbGl6YUJvdCIsImFjY2VzcyIsIkRhdGUiLCJuZXdGbG93IiwiTW9kZWwiLCJFeGVjU2VydmVyIiwidGhlTW9kZWwiLCJsb2FkTW9kZWxzIiwiaXNBbm9ueW1vdXMiLCJ1c2VyaWQiLCJpbmRleE9mIiwicmVzdHJpY3RMb2dnZWRPbiIsImFyciIsInVzZXIiLCJBQk9UX0VNQUlMX1VTRVIiLCJsZW5ndGgiLCJsZW4iLCJyZXMiLCJzbGljZSIsIk1hdGgiLCJtaW4iLCJtYXgiLCJmbG9vciIsImRlbHRhIiwicHVzaCIsIlNpbXBsZVJlY29nbml6ZXIiLCJwcm90b3R5cGUiLCJyZWNvZ25pemUiLCJjb250ZXh0IiwiY2FsbGJhY2siLCJ1Iiwic2NvcmUiLCJlMSIsInN0YXJ0SW5kZXgiLCJlbmRJbmRleCIsInVuZGVmaW5lZCIsInR5cGUiLCJhVHJhaW5SZXBsaWVzIiwiYVRyYWluRGlhbG9nIiwiYVRyYWluRXhpdEhpbnQiLCJhRW50ZXJUcmFpbiIsImFCYWNrRnJvbVRyYWluaW5nIiwiYVRyYWluTm9LbGluZ29uIiwiZ2V0UmFuZG9tUmVzdWx0IiwicmFuZG9tIiwiU2ltcGxlVXBEb3duUmVjb2duaXplciIsIkFueU9iamVjdCIsIk9iamVjdCIsImJvdCIsImZzIiwib0pTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsIm9SdWxlcyIsInBhcnNlUnVsZXMiLCJsb2dRdWVyeSIsInJlc3VsdCIsImFwcGVuZEZpbGUiLCJ0aW1lc3RhbXAiLCJUb29sTWF0Y2giLCJkdW1wTmljZSIsImNvbnZlcnNhdGlvbklkIiwiZXJyIiwibG9nUXVlcnlXaGF0SXMiLCJnd29yZHMiLCJtYWtlQm90IiwiY29ubmVjdG9yIiwiVW5pdmVyc2FsQm90IiwicmVjb2duaXplciIsIlJlZ0V4cFJlY29nbml6ZXIiLCJkaWFsb2ciLCJJbnRlbnREaWFsb2ciLCJyZWNvZ25pemVycyIsImRpYWxvZ1VwRG93biIsIm9uQmVnaW4iLCJtYXRjaGVzIiwiYXJncyIsIm5leHQiLCJkaWFsb2dEYXRhIiwiYWJjIiwiUHJvbXB0cyIsInJlc3VsdHMiLCJyZXBvbnNlIiwiZW5kRGlhbG9nV2l0aFJlc3VsdCIsIm9uRGVmYXVsdCIsImRpYWxnb0RhdGEiLCJEaWFsb2dEYXRhIiwiaXNDb21iaW5lZEluZGV4Iiwib05ld0VudGl0eSIsImExIiwiRW50aXR5UmVjb2duaXplciIsImZpbmRFbnRpdHkiLCJhbmFseXplQWxsIiwiZW50aXR5IiwibVJ1bGVzIiwidG9vbHMiLCJkdW1wV2VpZ2h0c1RvcCIsInRvcCIsImlzQ29tcGxldGUiLCJnZXRQcm9tcHQiLCJwcm9tcHQiLCJiZXN0Iiwic2V0UHJvbXB0IiwiZXhlYyIsImV4ZWNUb29sIiwicmVjb3JkcyIsInJlcGx5IiwiTWVzc2FnZSIsImFkZEVudGl0eSIsImNhdGVnb3J5RW50aXR5IiwiY2F0ZWdvcnkiLCJjYXQiLCJhbmFseXplQ2F0ZWdvcnkiLCJyZXNvbHZlQ2F0ZWdvcnkiLCJpbmRpcyIsImlzSW5kaXNjcmltaW5hdGVSZXN1bHQiLCJkb21haW4iLCJpbmZlckRvbWFpbiIsImpvaW4iLCJhUmVzIiwiZ2V0Q2F0ZWdvcmllc0ZvckRvbWFpbiIsImRvbWFpbnMiLCJtYXAiLCJvVG9vbCIsIm5hbWUiLCJyZXN1bHQxIiwibGlzdEFsbFdpdGhDb250ZXh0IiwibGlzdEFsbEhhdmluZ0NvbnRleHQiLCJqb2lucmVzdWx0cyIsImpvaW5SZXN1bHRzIiwidG9Mb3dlckNhc2UiLCJiZWdpbkRpYWxvZyIsInVzZXJEYXRhIiwiY291bnQiLCJhbGFybSIsInRpdGxlIiwidGltZSIsInJlc29sdmVUaW1lIiwiZ2V0VGltZSIsImRhdGUiLCJpc0FNIiwiZ2V0SG91cnMiLCJnZXRNb250aCIsImdldERhdGUiLCJnZXRGdWxsWWVhciIsImdldE1pbnV0ZXMiLCJlbGl6YSIsInRyYW5zZm9ybSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBT0E7Ozs7O0FBS0E7QUFDQTtBQUNBO0FDQ0E7O0FEQ0EsSUFBWUEsVUFBT0MsUUFBTSxZQUFOLENBQW5CO0FBQ0EsSUFBWUMsUUFBS0QsUUFBTSxPQUFOLENBQWpCO0FBR0EsSUFBWUUsUUFBS0YsUUFBTSxnQkFBTixDQUFqQjtBQUVBLElBQVlHLFVBQU9ILFFBQU0sa0JBQU4sQ0FBbkI7QUFFQSxJQUFZSSxTQUFNSixRQUFNLGlCQUFOLENBQWxCO0FBQ0EsSUFBWUssVUFBT0wsUUFBTSxrQkFBTixDQUFuQjtBQUVBLElBQVlNLGVBQVlOLFFBQU0sdUJBQU4sQ0FBeEI7QUFFQSxJQUFZTyxVQUFPUCxRQUFNLFNBQU4sQ0FBbkI7QUFFQSxJQUFJUSxRQUFRRCxRQUFRRSxHQUFSLENBQVlDLFlBQVosSUFBNEIsRUFBeEM7QUFFQSxJQUFJQyxhQUFhLDJDQUFqQjtBQUNBLElBQUlILFFBQVFELFFBQVFFLEdBQVIsQ0FBWUMsWUFBWixJQUE0QkMsVUFBeEM7QUFF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QU9ELEtBQUtFLFFBQUwsRUFBUCxHQUF5QkYsS0FBS0UsUUFBTCxLQUFrQixFQUg3QyxFQUdpREYsS0FBS00sVUFBTCxFQUhqRCxFQUdvRUwsT0FBTyxJQUFQLEdBQWMsSUFIbEY7QUFJRCxTQVpELE1BWU87QUFDTGxLLG9CQUFRSCxJQUFSLENBQWEsbUJBQWI7QUFDRDtBQUNGLEtBM0RxQixDQUF4QjtBQThEQStGLFdBQU9jLFNBQVAsQ0FBaUIsVUFBVTFHLE9BQVYsRUFBaUI7QUFDaEM2RSxpQkFBUzdFLE9BQVQsRUFBa0IsV0FBbEI7QUFDQSxZQUFJd0ssUUFBUWxKLFlBQVlOLGtCQUFrQmhCLE9BQWxCLENBQVosQ0FBWjtBQUNBLFlBQUlnSSxRQUFRd0MsTUFBTUMsU0FBTixDQUFnQnpLLFFBQVFpQixPQUFSLENBQWdCVixJQUFoQyxDQUFaO0FBQ0FULGtCQUFVLE9BQVYsRUFBa0JFLE9BQWxCLEVBQTBCSCxLQUFLbUksS0FBTCxDQUExQjtBQUNBO0FBQ0E7QUFDQTtBQUNELEtBUkQ7QUFVQTs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkQ7QUFFRCxJQUFJMEMsTUFBSixFQUFZO0FBQ1ZBLFdBQU9DLE9BQVAsR0FBaUI7QUFDZnBGLGlCQUFTQTtBQURNLEtBQWpCO0FBR0QiLCJmaWxlIjoiYm90L3NtYXJ0ZGlhbG9nLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUaGUgYm90IGltcGxlbWVudGF0aW9uXG4gKlxuICogSW5zdGFudGlhdGUgYXBzc2luZyBhIGNvbm5lY3RvciB2aWFcbiAqIG1ha2VCb3RcbiAqXG4gKi9cbi8qKlxuICogQGZpbGVcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LnNtYXJ0ZGlhbG9nXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cbi8vZGVjbGFyZSBtb2R1bGUgJ2VsaXphYm90JyB7IH07XG4vL2RlY2xhcmUgbW9kdWxlICd3aW5zdG9uLXBnJyB7IH07XG4vL2RlbGNhcmUgbW9kdWxlICd3aW5zdG9uJyB7fTtcblxuaW1wb3J0ICogYXMgYnVpbGRlciBmcm9tICdib3RidWlsZGVyJztcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuaW1wb3J0ICogYXMgRXhlYyBmcm9tICcuLi9leGVjL2V4ZWMnO1xuaW1wb3J0ICogYXMgTWF0Y2ggZnJvbSAnLi4vbWF0Y2gvbWF0Y2gnO1xuXG5pbXBvcnQgKiBhcyBBbmFseXplIGZyb20gJy4uL21hdGNoL2FuYWx5emUnO1xuXG5pbXBvcnQgKiBhcyBXaGF0SXMgZnJvbSAnLi4vbWF0Y2gvd2hhdGlzJztcbmltcG9ydCAqIGFzIExpc3RBbGwgZnJvbSAnLi4vbWF0Y2gvbGlzdGFsbCc7XG5cbmltcG9ydCAqIGFzIERpYWxvZ0xvZ2dlciBmcm9tICcuLi91dGlscy9kaWFsb2dsb2dnZXInO1xuXG5pbXBvcnQgKiBhcyBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xuXG52YXIgZGJ1cmwgPSBwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwgfHwgXCJcIjtcblxudmFyIHBnbG9jYWx1cmwgPSBcInBvc3RncmVzOi8vam9lOmFiY2RlZkBsb2NhbGhvc3Q6NTQzMi9hYm90XCI7XG52YXIgZGJ1cmwgPSBwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwgfHwgcGdsb2NhbHVybDtcblxuaW1wb3J0ICogYXMgcGcgZnJvbSAncGcnO1xudmFyIG8gPSBwZyBhcyBhbnk7XG5vLmRlZmF1bHRzLnNzbCA9IHRydWU7XG52YXIgZGlhbG9nTG9nZ2VyID0gRGlhbG9nTG9nZ2VyLmxvZ2dlcihcInNtYXJ0Ym90XCIsIGRidXJsLCBwZyk7XG5cbnR5cGUgc3RyaW5nT3JNZXNzYWdlID0gc3RyaW5nIHwgYnVpbGRlci5NZXNzYWdlO1xuZnVuY3Rpb24gc2VuZDxUIGV4dGVuZHMgc3RyaW5nT3JNZXNzYWdlPihvIDogVCkgOiBUIHsgcmV0dXJuIG87IH07XG5mdW5jdGlvbiBkaWFsb2dsb2coaW50ZW50OiBzdHJpbmcsIHNlc3Npb24gOiBidWlsZGVyLlNlc3Npb24sIHJlc3BvbnNlIDogc3RyaW5nT3JNZXNzYWdlKSB7XG4gIHZhciBzUmVzcG9uc2UgOiBzdHJpbmc7XG4gIHZhciBzQWN0aW9uIDogc3RyaW5nO1xuICBpZiggdHlwZW9mIHJlc3BvbnNlID09PSBcInN0cmluZ1wiKSB7XG4gICAgc0FjdGlvbiA9IFwiXCI7XG4gICAgc1Jlc3BvbnNlID0gcmVzcG9uc2U7XG4gIH0gZWxzZSB7XG4gICAgdmFyIGFNZXNzYWdlIDogYnVpbGRlci5NZXNzYWdlID0gcmVzcG9uc2U7XG4gICAgdmFyIGlNZXNzYWdlIDogYnVpbGRlci5JTWVzc2FnZSA9IGFNZXNzYWdlLnRvTWVzc2FnZSgpO1xuICAgIHNSZXNwb25zZSA9IGlNZXNzYWdlLnRleHQ7XG4gICAgc0FjdGlvbiA9IChpTWVzc2FnZS5lbnRpdGllcyAmJiBpTWVzc2FnZS5lbnRpdGllc1swXSkgPyAgKEpTT04uc3RyaW5naWZ5KGlNZXNzYWdlLmVudGl0aWVzICYmIGlNZXNzYWdlLmVudGl0aWVzWzBdKSkgOiBcIlwiO1xuICB9XG4gIGRpYWxvZ0xvZ2dlcih7XG4gICAgaW50ZW50OiBpbnRlbnQsXG4gICAgc2Vzc2lvbjogc2Vzc2lvbixcbiAgICByZXNwb25zZSA6IHNSZXNwb25zZSxcbiAgICBhY3Rpb24gOiBzQWN0aW9uXG4gIH0pO1xuICBzZXNzaW9uLnNlbmQocmVzcG9uc2UpO1xufVxuXG4vL2NvbnN0IHBnTG9nZ2VyID0gbmV3IFBnTG9nZ2VyKHtcbi8vICBuYW1lOiAndGVzdC1sb2dnZXInLFxuLy8gIGxldmVsOiAnZGVidWcnLFxuLy8gIGNvbm5TdHJpbmc6ICdwb3N0Z3JlczovL3VidW50dUBsb2NhbGhvc3Q6NTQzMi9jaXJjbGVfdGVzdCcsXG4vLyAgdGFibGVOYW1lOiAnd2luc3Rvbl9sb2dzJyxcbi8vfSk7XG5cblxuXG4vL3dpbnN0b24uYWRkKHdpbnN0b24udHJhbnNwb3J0cy5GaWxlLCB7IGZpbGVuYW1lOiAnd2luc3Rvbl9vdXQubG9nJywgdGltZXN0YW1wIDogdHJ1ZSB9KTtcbi8vICB3aW5zdG9uLnJlbW92ZSh3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSk7XG4vL3dpbnN0b24uYWRkKHBnTG9nZ2VyKTtcblxuLypcbmNvbnN0IGxvZ2dlciA9IG5ldyB3aW5zdG9uLkxvZ2dlcih7XG4gIHRyYW5zcG9ydHM6IFtcbiAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xuICAgICAgY29sb3I6IHRydWUsXG4gICAgICB0aW1lc3RhbXA6IHRydWUsXG4gICAgfSksXG4gICAgcGdMb2dnZXIsXG4gIF1cbn0pO1xuKi9cbi8vcGdMb2dnZXIuaW5pdFRhYmxlKGRvbmUpO1xuXG5cbnZhciBlbGl6YWJvdCA9IHJlcXVpcmUoJy4uL2V4dGVybi9lbGl6YWJvdC9lbGl6YWJvdC5qcycpO1xuLy9pbXBvcnQgKiBhcyBlbGl6YWJvdCBmcm9tICdlbGl6YWJvdCc7XG5cbmxldCBkZWJ1Z2xvZyA9IGRlYnVnKCdzbWFydGRpYWxvZycpO1xuaW1wb3J0ICogYXMgUGxhaW5SZWNvZ25pemVyIGZyb20gJy4vcGxhaW5yZWNvZ25pemVyJztcbi8vdmFyIGJ1aWxkZXIgPSByZXF1aXJlKCdib3RidWlsZGVyJyk7XG5cbnZhciBkaXNwYXRjaGVyID0gcmVxdWlyZSgnLi4vbWF0Y2gvZGlzcGF0Y2hlci5qcycpLmRpc3BhdGNoZXI7XG5cblxuZnVuY3Rpb24gZ2V0Q29udmVyc2F0aW9uSWQoc2Vzc2lvbjogYnVpbGRlci5TZXNzaW9uKTogc3RyaW5nIHtcbiAgcmV0dXJuIHNlc3Npb24ubWVzc2FnZSAmJlxuICAgIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzICYmXG4gICAgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uLmlkO1xufVxuXG52YXIgZWxpemFib3RzID0ge307XG5cbmZ1bmN0aW9uIGdldEVsaXphQm90KGlkOiBzdHJpbmcpIHtcbiAgaWYgKCFlbGl6YWJvdHNbaWRdKSB7XG4gICAgZWxpemFib3RzW2lkXSA9IHtcbiAgICAgIGFjY2VzczogbmV3IERhdGUoKSxcbiAgICAgIGVsaXphYm90OiBuZXcgZWxpemFib3QoKVxuICAgIH07XG4gIH1cbiAgZWxpemFib3RzW2lkXS5hY2Nlc3MgPSBuZXcgRGF0ZSgpO1xuICByZXR1cm4gZWxpemFib3RzW2lkXS5lbGl6YWJvdDtcbn1cblxuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xuaW1wb3J0ICogYXMgVG9vbHMgZnJvbSAnLi4vbWF0Y2gvdG9vbHMnO1xuXG52YXIgbmV3RmxvdyA9IHRydWU7XG5cbmltcG9ydCAqIGFzIE1vZGVsIGZyb20gJy4uL21vZGVsL21vZGVsJztcbmltcG9ydCAqIGFzIEV4ZWNTZXJ2ZXIgZnJvbSAnLi4vZXhlYy9leGVjc2VydmVyJztcblxuY29uc3QgdGhlTW9kZWwgPSBNb2RlbC5sb2FkTW9kZWxzKCk7XG5pZiAobmV3Rmxvdykge1xuXG59IGVsc2Uge1xuXG4gIC8vY29uc3QgdG9vbHMgPSBUb29scy5nZXRUb29scygpO1xuICAvL2NvbnN0IElucHV0RmlsdGVyUnVsZXMgPSByZXF1aXJlKCcuLi9tYXRjaC9pbnB1dEZpbHRlclJ1bGVzLmpzJyk7XG4gIC8vY29uc3QgbVJ1bGVzID0gSW5wdXRGaWx0ZXJSdWxlcy5nZXRNUnVsZXNTYW1wbGUoKTtcbn1cblxuZnVuY3Rpb24gaXNBbm9ueW1vdXModXNlcmlkIDogc3RyaW5nKSA6IGJvb2xlYW4ge1xuICByZXR1cm4gdXNlcmlkLmluZGV4T2YoXCJhbm86XCIpID09PSAwO1xufVxuXG5mdW5jdGlvbiByZXN0cmljdExvZ2dlZE9uKHNlc3Npb24gOiBidWlsZGVyLlNlc3Npb24sIGFyciA6IGFueVtdKSA6IGFueVtdIHtcbiAgdmFyIHVzZXJpZCA9IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlclxuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIuaWQgfHwgXCJcIjtcbiAgaWYocHJvY2Vzcy5lbnYuQUJPVF9FTUFJTF9VU0VSICYmIGlzQW5vbnltb3VzKHVzZXJpZCkpICB7XG4gICAgaWYoYXJyLmxlbmd0aCAgPCA2KSB7XG4gICAgICByZXR1cm4gYXJyO1xuICAgIH1cbiAgICB2YXIgbGVuID0gYXJyLmxlbmd0aDtcbiAgICB2YXIgcmVzID0gYXJyLnNsaWNlKDAsIE1hdGgubWluKE1hdGgubWF4KE1hdGguZmxvb3IoYXJyLmxlbmd0aCAvIDMpLCA3KSwgYXJyLmxlbmd0aCkpO1xuICAgIGlmKHR5cGVvZiBhcnJbMF0gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHZhciBkZWx0YSA9IGxlbiAtIHJlcy5sZW5ndGg7XG4gICAgICByZXMucHVzaChcIi4uLiBhbmQgXCIgKyBkZWx0YSArIFwiIG1vcmUgZW50cmllcyBmb3IgcmVnaXN0ZXJlZCB1c2Vyc1wiKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuICByZXR1cm4gYXJyO1xufVxuXG5cbmNsYXNzIFNpbXBsZVJlY29nbml6ZXIgaW1wbGVtZW50cyBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyIHtcbiAgY29uc3RydWN0b3IoKSB7XG5cbiAgfVxuXG4gIHJlY29nbml6ZShjb250ZXh0OiBidWlsZGVyLklSZWNvZ25pemVDb250ZXh0LCBjYWxsYmFjazogKGVycjogRXJyb3IsIHJlc3VsdDogYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHZhciB1ID0ge30gYXMgYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdDtcblxuICAgIGRlYnVnbG9nKFwicmVjb2duaXppbmcgXCIgKyBjb250ZXh0Lm1lc3NhZ2UudGV4dCk7XG4gICAgaWYgKGNvbnRleHQubWVzc2FnZS50ZXh0LmluZGV4T2YoXCJzdGFydFwiKSA+PSAwKSB7XG4gICAgICB1LmludGVudCA9IFwiU2hvd0VudGl0eVwiO1xuICAgICAgdS5zY29yZSA9IDAuOTtcbiAgICAgIHZhciBlMSA9IHt9IGFzIGJ1aWxkZXIuSUVudGl0eTtcbiAgICAgIGUxLnN0YXJ0SW5kZXggPSBcInN0YXJ0IFwiLmxlbmd0aDtcbiAgICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgICAgZTEuc2NvcmUgPSAwLjM7XG4gICAgICB1LmVudGl0aWVzID0gW2UxXTtcbiAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGNvbnRleHQubWVzc2FnZS50ZXh0LmluZGV4T2YoXCJ0cmFpblwiKSA+PSAwKSB7XG4gICAgICB1LmludGVudCA9IFwidHJhaW5cIjtcbiAgICAgIHUuc2NvcmUgPSAwLjk7XG4gICAgICB2YXIgZTEgPSB7fSBhcyBidWlsZGVyLklFbnRpdHk7XG4gICAgICBlMS5zdGFydEluZGV4ID0gXCJ0cmFpbiBcIi5sZW5ndGg7XG4gICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY29udGV4dC5tZXNzYWdlLnRleHQuaW5kZXhPZihcImxlYXJuXCIpID49IDApIHtcbiAgICAgIHUuaW50ZW50ID0gXCJsZWFyblwiO1xuICAgICAgdS5zY29yZSA9IDAuOTtcbiAgICAgIHZhciBlMSA9IHt9IGFzIGJ1aWxkZXIuSUVudGl0eTtcbiAgICAgIGUxLnR5cGUgPSBcInRyYWluRmFjdFwiO1xuICAgICAgZTEuc3RhcnRJbmRleCA9IFwidHJhaW4gXCIubGVuZ3RoO1xuICAgICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgICBlMS5zY29yZSA9IDAuMztcbiAgICAgIHUuZW50aXRpZXMgPSBbZTFdO1xuICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGNvbnRleHQubWVzc2FnZS50ZXh0LmluZGV4T2YoXCJoZWxwXCIpID49IDApIHtcbiAgICAgIHUuaW50ZW50ID0gXCJoZWxwXCI7XG4gICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgdmFyIGUxID0ge30gYXMgYnVpbGRlci5JRW50aXR5O1xuICAgICAgZTEuc3RhcnRJbmRleCA9IFwidHJhaW4gXCIubGVuZ3RoO1xuICAgICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgICBlMS5zY29yZSA9IDAuMztcbiAgICAgIHUuZW50aXRpZXMgPSBbZTFdO1xuICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGNvbnRleHQubWVzc2FnZS50ZXh0LmluZGV4T2YoXCJleGl0XCIpID49IDApIHtcbiAgICAgIHUuaW50ZW50ID0gXCJleGl0XCI7XG4gICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgdmFyIGUxID0ge30gYXMgYnVpbGRlci5JRW50aXR5O1xuICAgICAgZTEuc3RhcnRJbmRleCA9IFwiZXhpdCBcIi5sZW5ndGg7XG4gICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY29udGV4dC5tZXNzYWdlLnRleHQuaW5kZXhPZihcIndyb25nXCIpID49IDApIHtcbiAgICAgIHUuaW50ZW50ID0gXCJ3cm9uZ1wiO1xuICAgICAgdS5zY29yZSA9IDAuOTtcbiAgICAgIHZhciBlMSA9IHt9IGFzIGJ1aWxkZXIuSUVudGl0eTtcbiAgICAgIGUxLnN0YXJ0SW5kZXggPSBcImV4aXQgXCIubGVuZ3RoO1xuICAgICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgICBlMS5zY29yZSA9IDAuMztcbiAgICAgIHUuZW50aXRpZXMgPSBbZTFdO1xuICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZGVidWdsb2coJ3JlY29nbml6aW5nIG5vdGhpbmcnKTtcbiAgICB1LmludGVudCA9IFwiTm9uZVwiO1xuICAgIHUuc2NvcmUgPSAwLjE7XG4gICAgdmFyIGUxID0ge30gYXMgYnVpbGRlci5JRW50aXR5O1xuICAgIGUxLnN0YXJ0SW5kZXggPSBcImV4aXQgXCIubGVuZ3RoO1xuICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgIGUxLnNjb3JlID0gMC4xO1xuICAgIHUuZW50aXRpZXMgPSBbXTtcbiAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICB9XG59XG5cbmNvbnN0IGFUcmFpblJlcGxpZXMgPSBbIFwiVGhhbmsgeW91IGZvciBzaGFyaW5nIHRoaXMgc3VnZ2VzdGlvbiB3aXRoIHVzXCIsXG5cIlRoYW5rIGZvciBmb3IgdGhpcyB2YWx1YWJsZSBpbmZvcm1hdGlvbi5cIixcblwiVGhhbmsgZm9yIGZvciB0aGlzIGludGVyZXN0aW5nIGZhY3QhXCIsXG5cIlRoYXRzIGEgcGxldGhvcmlhIG9mIGluZm9ybWF0aW9uLlwiLFxuXCJUaGF0J3MgYSBudWdnZXQgb2YgaW5mb3JtYXRpb24uXCIsXG5cIkxvdmVseSwgSSBtYXkgY29uc2lkZXIgeW91IGlucHV0LlwiLFxuXCJXZWxsIGRvbmUsIGFueXRoaW5nIG1vcmUgdG8gbGV0IG1lIGtub3c/XCIsXG5cIkkgZG8gYXBwcmVjaWF0ZSB5b3VyIHRlYWNoaW5nIGFuZCBteSBsZWFybmluZyBleHBlcmllbmNlLCBvciB3YXMgaXQgdGhlIG90aGVyIHdheSByb3VuZD9cIixcblwiWW91ciBoZWxwZnVsIGlucHV0IGhhcyBiZWVuIHN0b3JlZCBpbiBzb21lIGR1c3R5IGNvcm5lciBvZiB0aGUgV29ybGQgd2lkZSB3ZWIhXCIsXG5cIlRoYW5rIHlvdSBmb3IgbXkgbGVhcm5pbmcgZXhwZXJpZW5jZSFcIixcblwiSSBoYXZlIGluY29ycG9yYXRlZCB5b3VyIHZhbHVhYmxlIHN1Z2dlc3Rpb24gaW4gdGhlIHdpc2RvbSBvZiB0aGUgaW50ZXJuZXRcIlxuXTtcblxudmFyIGFUcmFpbkRpYWxvZyA9IGFUcmFpblJlcGxpZXM7XG5cbnZhciBhVHJhaW5FeGl0SGludCA9IFtcblwiXFxudHlwZSBcXFwiZG9uZVxcXCIgd2hlbiB5b3UgYXJlIGRvbmUgdHJhaW5pbmcgbWUuXCIsXG5cIlwiLFxuXCJcIixcblwiXCIsXG5cIlxcbnJlbWVtYmVyLCB5b3UgYXJlIHN0dWNrIGhlcmUgaW5zdHJ1Y3RpbmcgbWUsIHR5cGUgXFxcImRvbmVcXFwiIHRvIHJldHVybi5cIixcblwiXCJdO1xuXG5jb25zdCBhRW50ZXJUcmFpbiA9IFtcIlNvIHlvdSB0aGluayB0aGlzIGlzIHdyb25nPyBZb3UgY2FuIG9mZmVyIHlvdXIgYWR2aXNlIGhlcmUuXFxuIFR5cGUgXFxcImRvbmVcXFwiIGlmIHlvdSBhcmUgZG9uZSB3aXRoIGluc3RydWN0aW5nIG1lXCIsXG5cIkZlZWwgZnJlZSB0byBvZmZlciBtZSB5b3VyIGJldHRlciBzb2x1dGlvbiBoZXJlLlxcblwiLFxuXCJTb21lIHNheSBcXFwiVGhlIHNlY3JldCB0byBoYXBwaW5lc3MgaXMgdG8gbG93ZXIgeW91ciBleHBlY3RhdGlvbnMgdG8gdGhlIHBvaW50IHRoZXkgYXJlIGFscmVhZHkgbWV0LlxcXCIsIFxcbnQgaWYgeW91IGNvdWxkIGhlbHAgbWUgdG8gYmVjb21kZSBiZXR0ZXIsIGluc3RydWN0IG1lLlwiLFxuXCJGZWVsIGZyZWUgdG8gb2ZmZXIgbWUgeW91ciBiZXR0ZXIgc29sdXRpb24gaGVyZS5cXG4gVHlwZSBcXFwiZG9uZVxcXCIgaWYgeW91IGFyZSBkb25lIHdpdGggaW5zdHJ1Y3RpbmcgbWVcIixcblwiRmVlbCBmcmVlIHRvIG9mZmVyIG1lIHlvdXIgYmV0dGVyIHNvbHV0aW9uIGhlcmUuXFxuIFR5cGUgXFxcImRvbmVcXFwiIGlmIHlvdSBhcmUgZG9uZSB3aXRoIGluc3RydWN0aW5nIG1lXCIsXG5dO1xuXG5cbmNvbnN0IGFCYWNrRnJvbVRyYWluaW5nID0gW1xuICBcIlB1dWgsIGJhY2sgZnJvbSB0cmFpbmluZyEgTm93IGZvciB0aGUgZWFzeSBwYXJ0IC4uLlwiLFxuICBcIkxpdmUgYW5kIGRvbid0IGxlYXJuLCB0aGF0J3MgdXMuIE5hYWgsIHdlJ2xsIHNlZS5cIixcbiAgXCJUaGUgc2VjcmV0IHRvIGhhcHBpbmVzcyBpcyB0byBsb3dlciB5b3VyIGV4cGVjdGF0aW9ucyB0byB0aGUgcG9pbnQgdGhleSBhcmUgYWxyZWFkeSBtZXQuXCIsXG4gIFwiVGhhbmtzIGZvciBoYXZpbmcgdGhpcyBsZWN0dXJlIHNlc3Npb24sIG5vdyBiYWNrIHRvIG91ciB1c3VhbCBzZWxmLlwiXG5dO1xuXG5cbmNvbnN0IGFUcmFpbk5vS2xpbmdvbiA9IFtcbiAgXCJIZSB3aG8gbWFzdGVyIHRoZSBkYXJrIGFydHMgb2YgU0FQIG11c3Qgbm90IGR3ZWxsIGluIHRoZSBlYXJ0aGx5IHJlYWxtcyBvZiBTdGFydCBUcmVrLlwiLFxuICBcIlNBUCBpcyBhIGNsb3VkIGNvbXBhbnksIG5vdCBhIHNwYWNlIGNvbXBhbnkuXCIsXG4gIFwiVGhlIGRlcHRoIG9mIFIvMyBhcmUgZGVlcGVyIHRoYW4gRGVlcCBTcGFjZSA0Mi5cIixcbiAgXCJNeSBicmFpbnBvd2VyIGlzIGZ1bGx5IGFic29yYmVkIHdpdGggbWFzdGVyaW5nIG90aGVyIHJlYWxtcy5cIixcbiAgXCJGb3IgdGhlIHdvc2FwLCB0aGUgc2t5IGlzIHRoZSBsaW1pdC4gRmVlbCBmcmVlIHRvIGNoZWNrIG91dCBuYXNhLmdvdiAuXCIsXG4gIFwiVGhlIGZ1dHVyZSBpcyBTQVAgb3IgSUJNIGJsdWUsIG5vdCBzcGFjZSBibGFjay5cIixcbiAgXCJUaGF0J3MgbGVmdCB0byBzb21lIG11c2t5IGZ1dHVyZS5cIlxuXVxuXG5mdW5jdGlvbiBnZXRSYW5kb21SZXN1bHQoYXJyIDogc3RyaW5nW10pIDogc3RyaW5nIHtcbiAgcmV0dXJuIGFycltNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBhcnIubGVuZ3RoKSAlIGFyci5sZW5ndGhdO1xufVxuXG5jbGFzcyBTaW1wbGVVcERvd25SZWNvZ25pemVyIGltcGxlbWVudHMgYnVpbGRlci5JSW50ZW50UmVjb2duaXplciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuXG4gIH1cblxuICByZWNvZ25pemUoY29udGV4dDogYnVpbGRlci5JUmVjb2duaXplQ29udGV4dCwgY2FsbGJhY2s6IChlcnI6IEVycm9yLCByZXN1bHQ6IGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB2YXIgdSA9IHt9IGFzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQ7XG5cbiAgICBkZWJ1Z2xvZyhcInJlY29nbml6aW5nIFwiICsgY29udGV4dC5tZXNzYWdlLnRleHQpO1xuICAgIGlmIChjb250ZXh0Lm1lc3NhZ2UudGV4dC5pbmRleE9mKFwiZG93blwiKSA+PSAwKSB7XG4gICAgICB1LmludGVudCA9IFwiaW50ZW50LmRvd25cIjtcbiAgICAgIHUuc2NvcmUgPSAwLjk7XG4gICAgICB2YXIgZTEgPSB7fSBhcyBidWlsZGVyLklFbnRpdHk7XG4gICAgICBlMS5zdGFydEluZGV4ID0gXCJzdGFydCBcIi5sZW5ndGg7XG4gICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY29udGV4dC5tZXNzYWdlLnRleHQuaW5kZXhPZihcInVwXCIpID49IDApIHtcbiAgICAgIHUuaW50ZW50ID0gXCJpbnRlbnQudXBcIjtcbiAgICAgIHUuc2NvcmUgPSAwLjk7XG4gICAgICB2YXIgZTEgPSB7fSBhcyBidWlsZGVyLklFbnRpdHk7XG4gICAgICBlMS5zdGFydEluZGV4ID0gXCJ1cFwiLmxlbmd0aDtcbiAgICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgICAgZTEuc2NvcmUgPSAwLjM7XG4gICAgICB1LmVudGl0aWVzID0gW2UxXTtcbiAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjb250ZXh0Lm1lc3NhZ2UudGV4dC5pbmRleE9mKFwiZG9uZVwiKSA+PSAwKSB7XG4gICAgICB1LmludGVudCA9IFwiaW50ZW50LnVwXCI7XG4gICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgdmFyIGUxID0ge30gYXMgYnVpbGRlci5JRW50aXR5O1xuICAgICAgZTEuc3RhcnRJbmRleCA9IFwidXBcIi5sZW5ndGg7XG4gICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY29udGV4dC5tZXNzYWdlLnRleHQuaW5kZXhPZihcImV4aXRcIikgPj0gMCkge1xuICAgICAgdS5pbnRlbnQgPSBcImludGVudC51cFwiO1xuICAgICAgdS5zY29yZSA9IDAuOTtcbiAgICAgIHZhciBlMSA9IHt9IGFzIGJ1aWxkZXIuSUVudGl0eTtcbiAgICAgIGUxLnN0YXJ0SW5kZXggPSBcInVwXCIubGVuZ3RoO1xuICAgICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgICBlMS5zY29yZSA9IDAuMztcbiAgICAgIHUuZW50aXRpZXMgPSBbZTFdO1xuICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGNvbnRleHQubWVzc2FnZS50ZXh0LmluZGV4T2YoXCJxdWl0XCIpID49IDApIHtcbiAgICAgIHUuaW50ZW50ID0gXCJpbnRlbnQudXBcIjtcbiAgICAgIHUuc2NvcmUgPSAwLjk7XG4gICAgICB2YXIgZTEgPSB7fSBhcyBidWlsZGVyLklFbnRpdHk7XG4gICAgICBlMS5zdGFydEluZGV4ID0gXCJ1cFwiLmxlbmd0aDtcbiAgICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgICAgZTEuc2NvcmUgPSAwLjM7XG4gICAgICB1LmVudGl0aWVzID0gW2UxXTtcbiAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGRlYnVnbG9nKCdyZWNvZ25pemluZyBub3RoaW5nJyk7XG4gICAgdS5pbnRlbnQgPSBcIk5vbmVcIjtcbiAgICB1LnNjb3JlID0gMC4xO1xuICAgIHZhciBlMSA9IHt9IGFzIGJ1aWxkZXIuSUVudGl0eTtcbiAgICBlMS5zdGFydEluZGV4ID0gXCJleGl0IFwiLmxlbmd0aDtcbiAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICBlMS5zY29yZSA9IDAuMTtcbiAgICB1LmVudGl0aWVzID0gW107XG4gICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgfVxufVxuXG5jb25zdCBBbnlPYmplY3QgPSBPYmplY3QgYXMgYW55O1xuLy8gZ2xvYmFsVHVubmVsLmluaXRpYWxpemUoe1xuLy8gIGhvc3Q6ICdwcm94eS5leHh4YW1wbGUuY29tJyxcbi8vICBwb3J0OiA4MDgwXG4vLyB9KVxuXG4vLyBDcmVhdGUgYm90IGFuZCBiaW5kIHRvIGNvbnNvbGVcbi8vIHZhciBjb25uZWN0b3IgPSBuZXcgaHRtbGNvbm5lY3Rvci5IVE1MQ29ubmVjdG9yKClcblxuLy8gY29ubmVjdG9yLnNldEFuc3dlckhvb2soZnVuY3Rpb24gKHNBbnN3ZXIpIHtcbi8vICBjb25zb2xlLmxvZygnR290IGFuc3dlciA6ICcgKyBzQW5zd2VyICsgJ1xcbicpXG4vLyB9KVxuXG52YXIgYm90O1xuLy8gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4vLyAgIGNvbm5lY3Rvci5wcm9jZXNzTWVzc2FnZSgnc3RhcnQgdW5pdCB0ZXN0IEFCQyAnKVxuLy8gfSwgNTAwMClcblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuXG52YXIgb0pTT04gPSBKU09OLnBhcnNlKCcnICsgZnMucmVhZEZpbGVTeW5jKCcuL3Jlc291cmNlcy9tb2RlbC9pbnRlbnRzLmpzb24nKSk7XG52YXIgb1J1bGVzID0gUGxhaW5SZWNvZ25pemVyLnBhcnNlUnVsZXMob0pTT04pO1xuLy8gdmFyIFJlY29nbml6ZXIgPSBuZXcgKHJlY29nbml6ZXIuUmVnRXhwUmVjb2duaXplcikob1J1bGVzKTtcblxuXG5mdW5jdGlvbiBsb2dRdWVyeShzZXNzaW9uOiBidWlsZGVyLlNlc3Npb24sIGludGVudDogc3RyaW5nLCByZXN1bHQ/OiBBcnJheTxJTWF0Y2guSVRvb2xNYXRjaD4pIHtcblxuICBmcy5hcHBlbmRGaWxlKCcuL2xvZ3Mvc2hvd21lcXVlcmllcy50eHQnLCBcIlxcblwiICsgSlNPTi5zdHJpbmdpZnkoe1xuICAgIHRleHQ6IHNlc3Npb24ubWVzc2FnZS50ZXh0LFxuICAgIHRpbWVzdGFtcDogc2Vzc2lvbi5tZXNzYWdlLnRpbWVzdGFtcCxcbiAgICBpbnRlbnQ6IGludGVudCxcbiAgICByZXM6IHJlc3VsdCAmJiByZXN1bHQubGVuZ3RoICYmIE1hdGNoLlRvb2xNYXRjaC5kdW1wTmljZShyZXN1bHRbMF0pIHx8IFwiMFwiLFxuICAgIGNvbnZlcnNhdGlvbklkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvblxuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvbi5pZCB8fCBcIlwiLFxuICAgIHVzZXJpZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlci5pZCB8fCBcIlwiXG4gIH0pLCBmdW5jdGlvbiAoZXJyLCByZXMpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBkZWJ1Z2xvZyhcImxvZ2dpbmcgZmFpbGVkIFwiICsgZXJyKTtcbiAgICB9XG4gIH0pO1xufVxuXG5cblxuZnVuY3Rpb24gbG9nUXVlcnlXaGF0SXMoc2Vzc2lvbjogYnVpbGRlci5TZXNzaW9uLCBpbnRlbnQ6IHN0cmluZywgcmVzdWx0PzogQXJyYXk8SU1hdGNoLklXaGF0SXNBbnN3ZXI+KSB7XG5cbiAgZnMuYXBwZW5kRmlsZSgnLi9sb2dzL3Nob3dtZXF1ZXJpZXMudHh0JywgXCJcXG5cIiArIEpTT04uc3RyaW5naWZ5KHtcbiAgICB0ZXh0OiBzZXNzaW9uLm1lc3NhZ2UudGV4dCxcbiAgICB0aW1lc3RhbXA6IHNlc3Npb24ubWVzc2FnZS50aW1lc3RhbXAsXG4gICAgaW50ZW50OiBpbnRlbnQsXG4gICAgcmVzOiByZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCAmJiBXaGF0SXMuZHVtcE5pY2UocmVzdWx0WzBdKSB8fCBcIjBcIixcbiAgICBjb252ZXJzYXRpb25JZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5jb252ZXJzYXRpb25cbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5jb252ZXJzYXRpb24uaWQgfHwgXCJcIixcbiAgICB1c2VyaWQ6IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlclxuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIuaWQgfHwgXCJcIlxuICB9KSwgZnVuY3Rpb24gKGVyciwgcmVzKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgZGVidWdsb2coXCJsb2dnaW5nIGZhaWxlZCBcIiArIGVycik7XG4gICAgfVxuICB9KTtcbn1cblxudmFyIGd3b3JkcyA9IHt9O1xuLyoqXG4gKiBDb25zdHJ1Y3QgYSBib3RcbiAqIEBwYXJhbSBjb25uZWN0b3Ige0Nvbm5lY3Rvcn0gdGhlIGNvbm5lY3RvciB0byB1c2VcbiAqIEhUTUxDb25uZWN0b3JcbiAqIG9yIGNvbm5lY3RvciA9IG5ldyBidWlsZGVyLkNvbnNvbGVDb25uZWN0b3IoKS5saXN0ZW4oKVxuICovXG5mdW5jdGlvbiBtYWtlQm90KGNvbm5lY3Rvcikge1xuICBib3QgPSBuZXcgYnVpbGRlci5Vbml2ZXJzYWxCb3QoY29ubmVjdG9yKTtcblxuXG5cbiAgLy8gQ3JlYXRlIExVSVMgcmVjb2duaXplciB0aGF0IHBvaW50cyBhdCBvdXIgbW9kZWwgYW5kIGFkZCBpdCBhcyB0aGUgcm9vdCAnLycgZGlhbG9nIGZvciBvdXIgQ29ydGFuYSBCb3QuXG4gIC8vIHZhciBtb2RlbCA9IHNlbnNpdGl2ZS5tb2RlbHVybDtcbiAgLy8gdmFyIG1vZGVsID0gJ2h0dHBzOi8vYXBpLnByb2plY3RveGZvcmQuYWkvbHVpcy92Mi4wL2FwcHMvYzQxM2IyZWYtMzgyYy00NWJkLThmZjAtZjc2ZDYwZTJhODIxP3N1YnNjcmlwdGlvbi1rZXk9YzIxMzk4YjU5ODBhNGNlMDlmNDc0YmJmZWU5M2I4OTImcT0nXG4gIHZhciByZWNvZ25pemVyID0gbmV3IFBsYWluUmVjb2duaXplci5SZWdFeHBSZWNvZ25pemVyKG9SdWxlcyk7XG5cbiAgdmFyIGRpYWxvZyA9IG5ldyBidWlsZGVyLkludGVudERpYWxvZyh7IHJlY29nbml6ZXJzOiBbcmVjb2duaXplcl0gfSk7XG4gIC8vIGRpYWxvZy5vbkJlZ2luKGZ1bmN0aW9uKHNlc3Npb24sYXJncykge1xuICAvLyBjb25zb2xlLmxvZyhcImJlZ2lubmluZyAuLi5cIilcbiAgLy8gc2Vzc2lvbi5kaWFsb2dEYXRhLnJldHJ5UHJvbXB0ID0gYXJncyAmJiBhcmdzLnJldHJ5UHJvbXB0IHx8IFwiSSBhbSBzb3JyeVwiXG4gIC8vIHNlc3Npb24uc2VuZChcIldoYXQgZG8geW91IHdhbnQ/XCIpXG4gIC8vXG4gIC8vIH0pXG5cbiAgdmFyIGRpYWxvZ1VwRG93biA9IG5ldyBidWlsZGVyLkludGVudERpYWxvZyh7IHJlY29nbml6ZXJzOiBbbmV3IFNpbXBsZVVwRG93blJlY29nbml6ZXIoKV0gfSk7XG5cbiAgYm90LmRpYWxvZygnL3VwZG93bicsIGRpYWxvZ1VwRG93bik7XG4gIGRpYWxvZ1VwRG93bi5vbkJlZ2luKGZ1bmN0aW9uIChzZXNzaW9uKSB7XG4gICAgZGlhbG9nbG9nKFwiVHJhaW5NZVwiLCBzZXNzaW9uLCBzZW5kKGdldFJhbmRvbVJlc3VsdChhRW50ZXJUcmFpbikpKTtcbiAgICAvL3Nlc3Npb24uc2VuZChcIkhpIHRoZXJlLCB1cGRvd24gaXMgd2FpdGluZyBmb3IgeW91XCIpO1xuICB9KVxuXG4gIGRpYWxvZ1VwRG93bi5tYXRjaGVzKCdpbnRlbnQudXAnLCBbXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIGFyZ3MsIG5leHQpIHtcbiAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5hYmMgPSBhcmdzIHx8IHt9O1xuICAgICAgYnVpbGRlci5Qcm9tcHRzLnRleHQoc2Vzc2lvbiwgJ3lvdSB3YW50IHRvIGV4aXQgdHJhaW5pbmc/IHR5cGUgXFxcImRvbmVcXFwiIGFnYWluLicpO1xuICAgIH0sXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIHJlc3VsdHMsIG5leHQpIHtcbiAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5hYmMgPSByZXN1bHRzLnJlcG9uc2U7XG4gICAgICBuZXh0KCk7XG4gICAgfSxcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cykge1xuICAgICAgc2Vzc2lvbi5lbmREaWFsb2dXaXRoUmVzdWx0KHsgcmVzcG9uc2U6IHNlc3Npb24uZGlhbG9nRGF0YS5hYmMgfSk7XG4gICAgfVxuICBdXG4gICk7XG5cbiAgZGlhbG9nVXBEb3duLm1hdGNoZXMoJ2ludGVudC5kb3duJywgW1xuICAgIGZ1bmN0aW9uIChzZXNzaW9uLCBhcmdzLCBuZXh0KSB7XG4gICAgICBzZXNzaW9uLmRpYWxvZ0RhdGEuYWJjID0gYXJncyB8fCB7fTtcbiAgICAgIGJ1aWxkZXIuUHJvbXB0cy50ZXh0KHNlc3Npb24sICd5b3Ugd2FudCB0byBnbyBkb3duIScpO1xuICAgIH0sXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIHJlc3VsdHMsIG5leHQpIHtcbiAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5hYmMgPSAtMTsgLy8gcmVzdWx0cy5yZXBvbnNlO1xuICAgICAgbmV4dCgpO1xuICAgIH0sXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIHJlc3VsdHMpIHtcbiAgICAgIHNlc3Npb24uc2VuZChcInN0aWxsIGdvaW5nIGRvd24/XCIpO1xuICAgIH1cbiAgXVxuICApO1xuICBkaWFsb2dVcERvd24ub25EZWZhdWx0KGZ1bmN0aW9uIChzZXNzaW9uKSB7XG4gICAgbG9nUXVlcnkoc2Vzc2lvbiwgXCJvbkRlZmF1bHRcIik7XG4gICAgdmFyIHJlcyA9IGdldFJhbmRvbVJlc3VsdChhVHJhaW5EaWFsb2cpICsgZ2V0UmFuZG9tUmVzdWx0KGFUcmFpbkV4aXRIaW50KTtcbiAgICBkaWFsb2dsb2coXCJUcmFpbk1lXCIsIHNlc3Npb24sIHNlbmQocmVzKSk7XG4gIH0pO1xuXG5cbiAgYm90LmRpYWxvZygnL3RyYWluJywgW1xuICAgIGZ1bmN0aW9uIChzZXNzaW9uLCBhcmdzLCBuZXh0KSB7XG4gICAgICBzZXNzaW9uLmRpYWxnb0RhdGEuYWJjID0gYXJncyB8fCB7fTtcbiAgICAgIGJ1aWxkZXIuUHJvbXB0cy50ZXh0KHNlc3Npb24sICdEbyB5b3Ugd2FudCB0byB0cmFpbiBtZScpO1xuICAgIH0sXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIHJlc3VsdHMsIG5leHQpIHtcbiAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5hYmMgPSByZXN1bHRzLnJlcG9uc2U7XG4gICAgfSxcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cykge1xuICAgICAgc2Vzc2lvbi5lbmREaWFsb2dXaXRoUmVzdWx0KHsgcmVzcG9uc2U6IHNlc3Npb24uRGlhbG9nRGF0YS5hYmMgfSk7XG4gICAgfVxuICBdKTtcblxuXG4gIGJvdC5kaWFsb2coJy8nLCBkaWFsb2cpO1xuXG4gIGRpYWxvZy5tYXRjaGVzKCdTaG93TWUnLCBbXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIGFyZ3MsIG5leHQpIHtcbiAgICAgIHZhciBpc0NvbWJpbmVkSW5kZXggPSB7fTtcbiAgICAgIHZhciBvTmV3RW50aXR5O1xuICAgICAgLy8gZXhwZWN0aW5nIGVudGl0eSBBMVxuICAgICAgZGVidWdsb2coXCJTaG93IEVudGl0eVwiKTtcbiAgICAgIGRlYnVnbG9nKCdyYXc6ICcgKyBKU09OLnN0cmluZ2lmeShhcmdzLmVudGl0aWVzKSwgdW5kZWZpbmVkLCAyKTtcbiAgICAgIHZhciBhMSA9IGJ1aWxkZXIuRW50aXR5UmVjb2duaXplci5maW5kRW50aXR5KGFyZ3MuZW50aXRpZXMsICdBMScpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gQW5hbHl6ZS5hbmFseXplQWxsKGExLmVudGl0eSxcbiAgICAgICAgdGhlTW9kZWwubVJ1bGVzLCB0aGVNb2RlbC50b29scywgZ3dvcmRzKTtcbiAgICAgIGxvZ1F1ZXJ5KHNlc3Npb24sICdTaG93TWUnLCByZXN1bHQpO1xuICAgICAgLy8gdGVzdC5leHBlY3QoMylcbiAgICAgIC8vICB0ZXN0LmRlZXBFcXVhbChyZXN1bHQud2VpZ2h0LCAxMjAsICdjb3JyZWN0IHdlaWdodCcpO1xuICAgICAgaWYgKCFyZXN1bHQgfHwgcmVzdWx0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBuZXh0KCk7XG4gICAgICB9XG4gICAgICAvLyBkZWJ1Z2xvZygncmVzdWx0IDogJyArIEpTT04uc3RyaW5naWZ5KHJlc3VsdCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICBkZWJ1Z2xvZygnYmVzdCByZXN1bHQgOiAnICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0WzBdIHx8IHt9LCB1bmRlZmluZWQsIDIpKTtcbiAgICAgIGRlYnVnbG9nKCd0b3AgOiAnICsgTWF0Y2guVG9vbE1hdGNoLmR1bXBXZWlnaHRzVG9wKHJlc3VsdCwgeyB0b3A6IDMgfSkpO1xuXG5cbiAgICAgIGlmIChBbmFseXplLmlzQ29tcGxldGUocmVzdWx0WzBdKSkge1xuICAgICAgICBzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0ID0gcmVzdWx0WzBdO1xuICAgICAgICAvLyAgICBzZXNzaW9uLnNlbmQoJ1Nob3dpbmcgZW50aXR5IC4uLicpO1xuICAgICAgICBuZXh0KCk7XG4gICAgICB9IGVsc2UgaWYgKEFuYWx5emUuZ2V0UHJvbXB0KHJlc3VsdFswXSkpIHtcbiAgICAgICAgdmFyIHByb21wdCA9IEFuYWx5emUuZ2V0UHJvbXB0KHJlc3VsdFswXSk7XG4gICAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5yZXN1bHQgPSByZXN1bHRbMF07XG4gICAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5wcm9tcHQgPSBwcm9tcHQ7XG4gICAgICAgIGRpYWxvZ2xvZyhcIlNob3dNZVwiLCBzZXNzaW9uLHNlbmQoXCJOb3QgZW5vdWdoIGluZm9ybWF0aW9uIHN1cHBsaWVkOiBcIiArIE1hdGNoLlRvb2xNYXRjaC5kdW1wTmljZShcbiAgICAgICAgICBzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0XG4gICAgICAgICkpKTtcbiAgICAgICAgYnVpbGRlci5Qcm9tcHRzLnRleHQoc2Vzc2lvbiwgcHJvbXB0LnRleHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGJlc3QgPSByZXN1bHQubGVuZ3RoID8gTWF0Y2guVG9vbE1hdGNoLmR1bXBOaWNlKHJlc3VsdFswXSkgOiBcIjxub3RoaW5nPlwiO1xuICAgICAgICBkaWFsb2dsb2coXCJTaG93TWVcIiwgc2Vzc2lvbiwgc2VuZCgnSSBkaWQgbm90IHVuZGVyc3RhbmQgdGhpcycgKyBiZXN0KSk7XG4gICAgICB9XG4gICAgfSxcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cywgbmV4dCkge1xuICAgICAgdmFyIHJlc3VsdCA9IHNlc3Npb24uZGlhbG9nRGF0YS5yZXN1bHQ7XG4gICAgICBpZiAoIXJlc3VsdCB8fCByZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJlc3VsdHMucmVzcG9uc2UpIHtcbiAgICAgICAgLy8gc29tZSBwcm9tcHRpbmdcbiAgICAgICAgQW5hbHl6ZS5zZXRQcm9tcHQoc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCwgc2Vzc2lvbi5kaWFsb2dEYXRhLnByb21wdCwgcmVzdWx0cy5yZXNwb25zZSk7XG4gICAgICB9XG4gICAgICBpZiAoQW5hbHl6ZS5pc0NvbXBsZXRlKHNlc3Npb24uZGlhbG9nRGF0YS5yZXN1bHQpKSB7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0gZWxzZSBpZiAoQW5hbHl6ZS5nZXRQcm9tcHQoc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCkpIHtcbiAgICAgICAgdmFyIHByb21wdCA9IEFuYWx5emUuZ2V0UHJvbXB0KHNlc3Npb24uZGlhbG9nRGF0YS5yZXN1bHQpO1xuICAgICAgICBzZXNzaW9uLmRpYWxvZ0RhdGEucHJvbXB0ID0gcHJvbXB0O1xuICAgICAgICBidWlsZGVyLlByb21wdHMudGV4dChzZXNzaW9uLCBwcm9tcHQudGV4dCk7XG4gICAgICB9XG4gICAgfSxcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cywgbmV4dCkge1xuICAgICAgdmFyIHJlc3VsdCA9IHNlc3Npb24uZGlhbG9nRGF0YS5yZXN1bHQ7XG4gICAgICBpZiAocmVzdWx0cy5yZXNwb25zZSkge1xuICAgICAgICAvLyBzb21lIHByb21wdGluZ1xuICAgICAgICBBbmFseXplLnNldFByb21wdChzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0LFxuICAgICAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5wcm9tcHQsIHJlc3VsdHMucmVzcG9uc2UpO1xuICAgICAgfVxuICAgICAgaWYgKEFuYWx5emUuaXNDb21wbGV0ZShzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0KSkge1xuICAgICAgICBjb25zdCBleGVjID0gRXhlY1NlcnZlci5leGVjVG9vbChzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0IGFzIElNYXRjaC5JVG9vbE1hdGNoLCB0aGVNb2RlbC5yZWNvcmRzKTtcblxuICAgICAgICB2YXIgcmVwbHkgPSBuZXcgYnVpbGRlci5NZXNzYWdlKHNlc3Npb24pXG4gICAgICAgICAgLnRleHQoZXhlYy50ZXh0KVxuICAgICAgICAgIC5hZGRFbnRpdHkoZXhlYy5hY3Rpb24pO1xuICAgICAgICAvLyAuYWRkQXR0YWNobWVudCh7IGZhbGxiYWNrVGV4dDogXCJJIGRvbid0IGtub3dcIiwgY29udGVudFR5cGU6ICdpbWFnZS9qcGVnJywgY29udGVudFVybDogXCJ3d3cud29tYmF0Lm9yZ1wiIH0pO1xuICAgICAgICBkaWFsb2dsb2coXCJTaG93TWVcIixzZXNzaW9uLHNlbmQocmVwbHkpKTtcblxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHNlc3Npb24uZGlhbG9nRGF0YS5yZXN1bHQpIHtcbiAgICAgICAgICBkaWFsb2dsb2coXCJTaG93TWVcIixcbiAgICAgICAgICBzZXNzaW9uLHNlbmQoXCJOb3QgZW5vdWdoIGluZm9ybWF0aW9uIHN1cHBsaWVkOiBcIiArIE1hdGNoLlRvb2xNYXRjaC5kdW1wTmljZShcbiAgICAgICAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5yZXN1bHRcbiAgICAgICAgICApKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGlhbG9nbG9nKFwiU2hvd01lXCIsIHNlc3Npb24sIHNlbmQoXCJJIGRpZCBub3QgZ2V0IHdoYXQgeW91IHdhbnRcIikpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSxcbiAgXSk7XG5cbiAgZGlhbG9nLm1hdGNoZXMoJ1doYXRJcycsIFtcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgYXJncywgbmV4dCkge1xuICAgICAgdmFyIGlzQ29tYmluZWRJbmRleCA9IHt9O1xuICAgICAgdmFyIG9OZXdFbnRpdHk7XG4gICAgICAvLyBleHBlY3RpbmcgZW50aXR5IEExXG4gICAgICB2YXIgbWVzc2FnZSA9IHNlc3Npb24ubWVzc2FnZS50ZXh0O1xuICAgICAgZGVidWdsb2coXCJXaGF0SXMgRW50aXRpZXNcIik7XG4gICAgICBkZWJ1Z2xvZygncmF3OiAnICsgSlNPTi5zdHJpbmdpZnkoYXJncy5lbnRpdGllcyksIHVuZGVmaW5lZCwgMik7XG4gICAgICB2YXIgY2F0ZWdvcnlFbnRpdHkgPSBidWlsZGVyLkVudGl0eVJlY29nbml6ZXIuZmluZEVudGl0eShhcmdzLmVudGl0aWVzLCAnY2F0ZWdvcnknKTtcbiAgICAgIHZhciBjYXRlZ29yeSA9IGNhdGVnb3J5RW50aXR5LmVudGl0eTtcbiAgICAgIHZhciBhMSA9IGJ1aWxkZXIuRW50aXR5UmVjb2duaXplci5maW5kRW50aXR5KGFyZ3MuZW50aXRpZXMsICdBMScpO1xuXG4gICAgICB2YXIgY2F0ID0gV2hhdElzLmFuYWx5emVDYXRlZ29yeShjYXRlZ29yeSwgdGhlTW9kZWwubVJ1bGVzLCBtZXNzYWdlKTtcbiAgICAgIGlmICghY2F0KSB7XG4gICAgICAgIHNlc3Npb24uc2VuZCgnSSBkb25cXCd0IGtub3cgYW55dGhpbmcgYWJvdXQgXCInICsgY2F0ZWdvcnkgKyAnXCInKTtcbiAgICAgICAgLy8gbmV4dCgpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBkZWJ1Z2xvZygnY2F0ZWdvcnkgaWRlbnRpZmllZDonICsgY2F0KTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksXG4gICAgICAgIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwucmVjb3Jkcyk7XG4gICAgICBkZWJ1Z2xvZygnd2hhdGlzIHJlc3VsdDonICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0KSk7XG4gICAgICBsb2dRdWVyeVdoYXRJcyhzZXNzaW9uLCAnV2hhdElzJywgcmVzdWx0KTtcbiAgICAgIHZhciBpbmRpcyA9IFdoYXRJcy5pc0luZGlzY3JpbWluYXRlUmVzdWx0KHJlc3VsdCk7XG4gICAgICBpZiAoaW5kaXMpIHtcbiAgICAgICAgc2Vzc2lvbi5zZW5kKGluZGlzKTtcbiAgICAgICAgLy8gbmV4dCgpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoIXJlc3VsdCB8fCByZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGRpYWxvZ2xvZyhcIldoYXRJc1wiLHNlc3Npb24sc2VuZCgnSSBkb25cXCd0IGtub3cgYW55dGhpbmcgYWJvdXQgXCInICsgY2F0ICsgXCIgKFwiICsgY2F0ZWdvcnkgKyAnKVxcXCIgaW4gcmVsYXRpb24gdG8gXCInICsgYTEuZW50aXR5ICsgJ1wiJykpO1xuICAgICAgICAvLyBuZXh0KCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGRlYnVnbG9nKCdyZXN1bHQgOiAnICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0LCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgZGVidWdsb2coJ2Jlc3QgcmVzdWx0IDogJyArIEpTT04uc3RyaW5naWZ5KHJlc3VsdFswXSB8fCB7fSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgIGRlYnVnbG9nKCd0b3AgOiAnICsgV2hhdElzLmR1bXBXZWlnaHRzVG9wKHJlc3VsdCwgeyB0b3A6IDMgfSkpO1xuICAgICAgICAvLyBUT0RPIGNsZWFuc2VkIHNlbnRlbmNlXG4gICAgICAgIGRpYWxvZ2xvZyhcIldoYXRJc1wiLHNlc3Npb24sc2VuZCgnVGhlICcgKyBjYXRlZ29yeSArICcgb2YgJyArIGExLmVudGl0eSArICcgaXMgJyArIHJlc3VsdFswXS5yZXN1bHQgKyBcIlxcblwiKSk7IC8vICArIEpTT04uc3RyaW5naWZ5KHJlc3VsdFswXSkpO1xuICAgICAgfVxuICAgIH1cbiAgXSk7XG5cblxuICBkaWFsb2cubWF0Y2hlcygnTGlzdEFsbCcsIFtcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgYXJncywgbmV4dCkge1xuICAgICAgdmFyIGlzQ29tYmluZWRJbmRleCA9IHt9O1xuICAgICAgdmFyIG9OZXdFbnRpdHk7XG4gICAgICAvLyBleHBlY3RpbmcgZW50aXR5IEExXG4gICAgICB2YXIgbWVzc2FnZSA9IHNlc3Npb24ubWVzc2FnZS50ZXh0O1xuICAgICAgZGVidWdsb2coXCJJbnRlbnQgOiBMaXN0QWxsXCIpO1xuICAgICAgZGVidWdsb2coJ3JhdzogJyArIEpTT04uc3RyaW5naWZ5KGFyZ3MuZW50aXRpZXMpLCB1bmRlZmluZWQsIDIpO1xuICAgICAgdmFyIGNhdGVnb3J5RW50aXR5ID0gYnVpbGRlci5FbnRpdHlSZWNvZ25pemVyLmZpbmRFbnRpdHkoYXJncy5lbnRpdGllcywgJ2NhdGVnb3JpZXMnKTtcbiAgICAgIHZhciBjYXRlZ29yeSA9IGNhdGVnb3J5RW50aXR5LmVudGl0eTtcbiAgICAgIHZhciBhMSA9IGJ1aWxkZXIuRW50aXR5UmVjb2duaXplci5maW5kRW50aXR5KGFyZ3MuZW50aXRpZXMsICdpbnN0aCcpO1xuICAgICAgaWYgKGNhdGVnb3J5ID09PSBcImNhdGVnb3JpZXNcIikge1xuICAgICAgICAvLyBkbyB3ZSBoYXZlIGEgZmlsdGVyID9cbiAgICAgICAgdmFyIGRvbWFpbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgaWYoYTEgJiYgYTEuZW50aXR5KSB7XG4gICAgICAgICAgZG9tYWluID0gTGlzdEFsbC5pbmZlckRvbWFpbih0aGVNb2RlbCwgYTEuZW50aXR5KTtcbiAgICAgICAgfVxuICAgICAgICBpZighZG9tYWluKSB7XG4gICAgICAgICAgdmFyIHJlcyA9IHJlc3RyaWN0TG9nZ2VkT24oc2Vzc2lvbiwgdGhlTW9kZWwuY2F0ZWdvcnkpLmpvaW4oXCI7XFxuXCIpO1xuICAgICAgICAgIGlmKGExICYmIGExLmVudGl0eSkge1xuICAgICAgICAgICAgZGlhbG9nbG9nKFwiTGlzdEFsbFwiLHNlc3Npb24sc2VuZChcIkkgZGlkIG5vdCBpbmZlciBhIGRvbWFpbiByZXN0cmljdGlvbiBmcm9tIFxcXCJcIiArIGExLmVudGl0eSArIFwiXFxcIiwgYWxsIG15IGNhdGVnb3JpZXMgYXJlIC4uLlxcblwiICsgcmVzKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRpYWxvZ2xvZyhcIkxpc3RBbGxcIixzZXNzaW9uLHNlbmQoXCJteSBjYXRlZ29yaWVzIGFyZSAuLi5cXG5cIiArIHJlcykpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdmFyIGFSZXMgPSBNb2RlbC5nZXRDYXRlZ29yaWVzRm9yRG9tYWluKHRoZU1vZGVsLCBkb21haW4pO1xuICAgICAgICAgICB2YXIgcmVzID0gcmVzdHJpY3RMb2dnZWRPbihzZXNzaW9uLCBhUmVzKS5qb2luKFwiO1xcblwiKTtcbiAgICAgICAgICBkaWFsb2dsb2coXCJMaXN0QWxsXCIsc2Vzc2lvbixzZW5kKFwibXkgY2F0ZWdvcmllcyBpbiBkb21haW4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiIGFyZSAuLi5cXG5cIiArIHJlcykpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGNhdGVnb3J5ID09PSBcImRvbWFpbnNcIikge1xuICAgICAgICB2YXIgcmVzID0gcmVzdHJpY3RMb2dnZWRPbihzZXNzaW9uLCB0aGVNb2RlbC5kb21haW5zKS5qb2luKFwiO1xcblwiKTtcbiAgICAgICAgc2Vzc2lvbi5zZW5kKFwibXkgZG9tYWlucyBhcmUgLi4uXFxuXCIgKyByZXMpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoY2F0ZWdvcnkgPT09IFwidG9vbHNcIikge1xuICAgICAgICB2YXIgcmVzID0gcmVzdHJpY3RMb2dnZWRPbihzZXNzaW9uLCB0aGVNb2RlbC50b29scykubWFwKGZ1bmN0aW9uIChvVG9vbCkge1xuICAgICAgICAgIHJldHVybiBvVG9vbC5uYW1lO1xuICAgICAgICB9KS5qb2luKFwiO1xcblwiKTtcbiAgICAgICAgZGlhbG9nbG9nKFwiTGlzdEFsbFwiLCBzZXNzaW9uLHNlbmQoXCJteSB0b29scyBhcmUgLi4uXFxuXCIgKyByZXMpKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdmFyIGNhdCA9IFdoYXRJcy5hbmFseXplQ2F0ZWdvcnkoY2F0ZWdvcnksIHRoZU1vZGVsLm1SdWxlcywgbWVzc2FnZSk7XG4gICAgICBpZiAoIWNhdCkge1xuICAgICAgICBkaWFsb2dsb2coXCJMaXN0QWxsXCIsc2Vzc2lvbixzZW5kKCdJIGRvblxcJ3Qga25vdyBhbnl0aGluZyBhYm91dCBcIicgKyBjYXRlZ29yeSArICdcIicpKTtcbiAgICAgICAgLy8gbmV4dCgpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBkZWJ1Z2xvZygnY2F0ZWdvcnkgaWRlbnRpZmllZDonICsgY2F0KTtcbiAgICAgIGlmIChhMSAmJiBhMS5lbnRpdHkpIHtcbiAgICAgICAgZGVidWdsb2coJ2dvdCBmaWx0ZXI6JyArIGExLmVudGl0eSk7XG4gICAgICAgIHZhciByZXN1bHQxID0gTGlzdEFsbC5saXN0QWxsV2l0aENvbnRleHQoY2F0LCBhMS5lbnRpdHksXG4gICAgICAgICAgdGhlTW9kZWwubVJ1bGVzLCB0aGVNb2RlbC5yZWNvcmRzKTtcbiAgICAgICAgLy8gVE9ETyBjbGFzc2lmeWluZyB0aGUgc3RyaW5nIHR3aWNlIGlzIGEgdGVycmlibGUgd2FzdGVcbiAgICAgICAgaWYgKCFyZXN1bHQxLmxlbmd0aCkge1xuICAgICAgICAgIGRlYnVnbG9nKCdnb2luZyBmb3IgaGF2aW5nJyk7XG4gICAgICAgICAgcmVzdWx0MSA9IExpc3RBbGwubGlzdEFsbEhhdmluZ0NvbnRleHQoY2F0LCBhMS5lbnRpdHksIHRoZU1vZGVsLm1SdWxlcyxcbiAgICAgICAgICAgIHRoZU1vZGVsLnJlY29yZHMpO1xuICAgICAgICB9XG4gICAgICAgIGRlYnVnbG9nKCdsaXN0YWxsIHJlc3VsdDonICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0MSkpO1xuICAgICAgICB2YXIgam9pbnJlc3VsdHMgPSByZXN0cmljdExvZ2dlZE9uKHNlc3Npb24sIExpc3RBbGwuam9pblJlc3VsdHMocmVzdWx0MSkpO1xuICAgICAgICBsb2dRdWVyeVdoYXRJcyhzZXNzaW9uLCAnTGlzdEFsbCcsIHJlc3VsdDEpO1xuICAgICAgICBpZihqb2lucmVzdWx0cy5sZW5ndGggKXtcbiAgICAgICAgICBkaWFsb2dsb2coXCJMaXN0QWxsXCIsc2Vzc2lvbixzZW5kKFwidGhlIFwiICsgY2F0ZWdvcnkgKyBcIiBmb3IgXCIgKyBhMS5lbnRpdHkgKyBcIiBhcmUgLi4uXFxuXCIgKyBqb2lucmVzdWx0cy5qb2luKFwiO1xcblwiKSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRpYWxvZ2xvZyhcIkxpc3RBbGxcIixzZXNzaW9uLHNlbmQoXCJpIGRpZCBub3QgZmluZCBhbnkgXCIgKyBjYXRlZ29yeSArIFwiIGZvciBcIiArIGExLmVudGl0eSArIFwiLlxcblwiICsgam9pbnJlc3VsdHMuam9pbihcIjtcXG5cIikpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBubyBlbnRpdHksIGUuZy4gbGlzdCBhbGwgY291bnRyaWVzXG4gICAgICAgIC8vXG4gICAgICAgIHZhciByZXN1bHQgPSBMaXN0QWxsLmxpc3RBbGxIYXZpbmdDb250ZXh0KGNhdCwgY2F0LCB0aGVNb2RlbC5tUnVsZXMsIHRoZU1vZGVsLnJlY29yZHMpO1xuICAgICAgICBsb2dRdWVyeVdoYXRJcyhzZXNzaW9uLCAnTGlzdEFsbCcsIHJlc3VsdCk7XG4gICAgICAgIGlmIChyZXN1bHQubGVuZ3RoKSB7XG4gICAgICAgICAgZGVidWdsb2coJ2xpc3RhbGwgcmVzdWx0OicgKyBKU09OLnN0cmluZ2lmeShyZXN1bHQpKTtcbiAgICAgICAgICB2YXIgam9pbnJlc3VsdHMgPSBbXTtcbiAgICAgICAgICBkZWJ1Z2xvZyhcImhlcmUgaXMgY2F0PlwiICsgY2F0KTtcbiAgICAgICAgICBpZihjYXQgIT09IFwiZXhhbXBsZSBxdWVzdGlvblwiKSB7XG4gICAgICAgICAgICBqb2lucmVzdWx0cyA9IHJlc3RyaWN0TG9nZ2VkT24oc2Vzc2lvbiwgTGlzdEFsbC5qb2luUmVzdWx0cyhyZXN1bHQpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgam9pbnJlc3VsdHMgPSBMaXN0QWxsLmpvaW5SZXN1bHRzKHJlc3VsdCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhciByZXNwb25zZSA9IFwidGhlIFwiICsgY2F0ZWdvcnkgKyBcIiBhcmUgLi4uXFxuXCIgKyBqb2lucmVzdWx0cy5qb2luKFwiO1xcblwiKTtcbiAgICAgICAgICBkaWFsb2dsb2coXCJMaXN0QWxsXCIsc2Vzc2lvbixzZW5kKHJlc3BvbnNlKSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHZhciByZXNwb25zZSA9IFwiRm91bmQgbm8gZGF0YSBoYXZpbmcgXFxcIlwiICsgY2F0ICsgXCJcXFwiXCJcbiAgICAgICAgICBkaWFsb2dsb2coXCJMaXN0QWxsXCIsc2Vzc2lvbixzZW5kKHJlc3BvbnNlKSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICBdKTtcblxuICBkaWFsb2cubWF0Y2hlcygnVHJhaW5NZScsIFtcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgYXJncywgbmV4dCkge1xuICAgICAgdmFyIGlzQ29tYmluZWRJbmRleCA9IHt9O1xuICAgICAgdmFyIG9OZXdFbnRpdHk7XG4gICAgICAvLyBleHBlY3RpbmcgZW50aXR5IEExXG4gICAgICB2YXIgbWVzc2FnZSA9IHNlc3Npb24ubWVzc2FnZS50ZXh0O1xuICAgICAgZGVidWdsb2coXCJJbnRlbnQgOiBUcmFpblwiKTtcbiAgICAgIGRlYnVnbG9nKCdyYXc6ICcgKyBKU09OLnN0cmluZ2lmeShhcmdzLmVudGl0aWVzKSwgdW5kZWZpbmVkLCAyKTtcbiAgICAgIHZhciBjYXRlZ29yeUVudGl0eSA9IGJ1aWxkZXIuRW50aXR5UmVjb2duaXplci5maW5kRW50aXR5KGFyZ3MuZW50aXRpZXMsICdjYXRlZ29yaWVzJyk7XG4gICAgICBpZiAobWVzc2FnZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoXCJrcm9ub3NcIikgPj0gMCB8fCBtZXNzYWdlLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihcImtsaW5nb25cIikgPj0gMCkge1xuICAgICAgICBkaWFsb2dsb2coXCJUcmFpbk1lXCIsc2Vzc2lvbixzZW5kKGdldFJhbmRvbVJlc3VsdChhVHJhaW5Ob0tsaW5nb24pKSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHZhciByZXMgPSBnZXRSYW5kb21SZXN1bHQoYVRyYWluUmVwbGllcyk7XG4gICAgICBkaWFsb2dsb2coXCJUcmFpbk1lXCIsc2Vzc2lvbixzZW5kKHJlcykpO1xuICAgIH1cbiAgXSk7XG5cblxuXG4gIGRpYWxvZy5tYXRjaGVzKCdXcm9uZycsIFtcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgYXJncywgbmV4dCkge1xuICAgICAgICBkaWFsb2dMb2dnZXIoIHtcbiAgICAgICAgICBzZXNzaW9uOiBzZXNzaW9uLFxuICAgICAgICAgIGludGVudCA6IFwiV3JvbmdcIixcbiAgICAgICAgICByZXNwb25zZSA6ICc8YmVnaW4gdXBkb3duPidcbiAgICAgICAgfSk7XG4gICAgICBzZXNzaW9uLmJlZ2luRGlhbG9nKCcvdXBkb3duJywgc2Vzc2lvbi51c2VyRGF0YS5jb3VudCk7XG4gICAgfSxcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cywgbmV4dCkge1xuICAgICAgdmFyIGFsYXJtID0gc2Vzc2lvbi5kaWFsb2dEYXRhLmFsYXJtO1xuICAgICAgbmV4dCgpO1xuICAgIH0sXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIHJlc3VsdHMpIHtcbiAgICAgIHNlc3Npb24uc2VuZChnZXRSYW5kb21SZXN1bHQoYUJhY2tGcm9tVHJhaW5pbmcpKTsgLy8gICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0cykpO1xuICAgICAgLy9zZXNzaW9uLnNlbmQoJ2VuZCBvZiB3cm9uZycpO1xuICAgIH1cbiAgXSk7XG5cbiAgZGlhbG9nLm1hdGNoZXMoJ0V4aXQnLCBbXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIGFyZ3MsIG5leHQpIHtcbiAgICAgIGRlYnVnbG9nKCdleGl0IDonKTtcbiAgICAgIGRlYnVnbG9nKCdleGl0JyArIEpTT04uc3RyaW5naWZ5KGFyZ3MuZW50aXRpZXMpKTtcbiAgICAgICAgZGlhbG9nTG9nZ2VyKCB7XG4gICAgICAgICAgc2Vzc2lvbjogc2Vzc2lvbixcbiAgICAgICAgICBpbnRlbnQgOiBcIkV4aXRcIixcbiAgICAgICAgICByZXNwb25zZSA6ICd5b3UgYXJlIGluIGEgbG9naWMgbG9vcCdcbiAgICAgICAgfSk7XG4gICAgICBzZXNzaW9uLnNlbmQoXCJ5b3UgYXJlIGluIGEgbG9naWMgbG9vcCBcIik7XG4gICAgfVxuICBdKTtcbiAgZGlhbG9nLm1hdGNoZXMoJ0hlbHAnLCBbXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIGFyZ3MsIG5leHQpIHtcbiAgICAgIGRlYnVnbG9nKCdoZWxwIDonKTtcbiAgICAgIGRlYnVnbG9nKCdoZWxwJyk7XG4gICAgICBzZXNzaW9uLnNlbmQoXCJJIGtub3cgYWJvdXQgLi4uLiA8Y2F0ZWdvcmllcz4+XCIpO1xuICAgIH1cbiAgXSk7XG5cbiAgLy8gQWRkIGludGVudCBoYW5kbGVyc1xuICBkaWFsb2cubWF0Y2hlcygndHJhaW4nLCBbXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIGFyZ3MsIG5leHQpIHtcbiAgICAgIGRlYnVnbG9nKCd0cmFpbicpO1xuICAgICAgLy8gUmVzb2x2ZSBhbmQgc3RvcmUgYW55IGVudGl0aWVzIHBhc3NlZCBmcm9tIExVSVMuXG4gICAgICB2YXIgdGl0bGUgPSBidWlsZGVyLkVudGl0eVJlY29nbml6ZXIuZmluZEVudGl0eShhcmdzLmVudGl0aWVzLCAnYnVpbHRpbi5hbGFybS50aXRsZScpO1xuICAgICAgdmFyIHRpbWUgPSBidWlsZGVyLkVudGl0eVJlY29nbml6ZXIucmVzb2x2ZVRpbWUoYXJncy5lbnRpdGllcyk7XG4gICAgICB2YXIgYWxhcm0gPSBzZXNzaW9uLmRpYWxvZ0RhdGEuYWxhcm0gPSB7XG4gICAgICAgIHRpdGxlOiB0aXRsZSA/IHRpdGxlLmVudGl0eSA6IG51bGwsXG4gICAgICAgIHRpbWVzdGFtcDogdGltZSA/IHRpbWUuZ2V0VGltZSgpIDogbnVsbFxuICAgICAgfTtcbiAgICAgIC8vIFByb21wdCBmb3IgdGl0bGVcbiAgICAgICAgaWYgKCFhbGFybS50aXRsZSkge1xuICAgICAgICAgIGRpYWxvZ0xvZ2dlcigge1xuICAgICAgICAgIHNlc3Npb246IHNlc3Npb24sXG4gICAgICAgICAgaW50ZW50IDogXCJ0cmFpblwiLFxuICAgICAgICAgIHJlc3BvbnNlIDogJ1doYXQgZmFjdCB3b3VsZCB5b3UgbGlrZSB0byB0cmFpbj8nXG4gICAgICAgIH0pO1xuICAgICAgICBidWlsZGVyLlByb21wdHMudGV4dChzZXNzaW9uLCAnV2hhdCBmYWN0IHdvdWxkIHlvdSBsaWtlIHRvIHRyYWluPycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dCgpO1xuICAgICAgfVxuICAgIH0sXG4gICAgZnVuY3Rpb24gKHNlc3Npb24sIHJlc3VsdHMsIG5leHQpIHtcbiAgICAgIHZhciBhbGFybSA9IHNlc3Npb24uZGlhbG9nRGF0YS5hbGFybTtcbiAgICAgIGlmIChyZXN1bHRzLnJlc3BvbnNlKSB7XG4gICAgICAgIGFsYXJtLnRpdGxlID0gcmVzdWx0cy5yZXNwb25zZTtcbiAgICAgIH1cblxuICAgICAgLy8gUHJvbXB0IGZvciB0aW1lICh0aXRsZSB3aWxsIGJlIGJsYW5rIGlmIHRoZSB1c2VyIHNhaWQgY2FuY2VsKVxuICAgICAgaWYgKGFsYXJtLnRpdGxlICYmICFhbGFybS50aW1lc3RhbXApIHtcblxuXG4gICAgICAgIGJ1aWxkZXIuUHJvbXB0cy50aW1lKHNlc3Npb24sICdXaGF0IHRpbWUgd291bGQgeW91IGxpa2UgdG8gc2V0IHRoZSBhbGFybSBmb3I/Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXh0KCk7XG4gICAgICB9XG4gICAgfSxcbiAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cykge1xuICAgICAgdmFyIGFsYXJtID0gc2Vzc2lvbi5kaWFsb2dEYXRhLmFsYXJtO1xuICAgICAgaWYgKHJlc3VsdHMucmVzcG9uc2UpIHtcbiAgICAgICAgdmFyIHRpbWUgPSBidWlsZGVyLkVudGl0eVJlY29nbml6ZXIucmVzb2x2ZVRpbWUoW3Jlc3VsdHMucmVzcG9uc2VdKTtcbiAgICAgICAgYWxhcm0udGltZXN0YW1wID0gdGltZSA/IHRpbWUuZ2V0VGltZSgpIDogbnVsbDtcbiAgICAgIH1cbiAgICAgIC8vIFNldCB0aGUgYWxhcm0gKGlmIHRpdGxlIG9yIHRpbWVzdGFtcCBpcyBibGFuayB0aGUgdXNlciBzYWlkIGNhbmNlbClcbiAgICAgIGlmIChhbGFybS50aXRsZSAmJiBhbGFybS50aW1lc3RhbXApIHtcbiAgICAgICAgLy8gU2F2ZSBhZGRyZXNzIG9mIHdobyB0byBub3RpZnkgYW5kIHdyaXRlIHRvIHNjaGVkdWxlci5cbiAgICAgICAgYWxhcm0uYWRkcmVzcyA9IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzO1xuICAgICAgICAvL2FsYXJtc1thbGFybS50aXRsZV0gPSBhbGFybTtcblxuICAgICAgICAvLyBTZW5kIGNvbmZpcm1hdGlvbiB0byB1c2VyXG4gICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoYWxhcm0udGltZXN0YW1wKTtcbiAgICAgICAgdmFyIGlzQU0gPSBkYXRlLmdldEhvdXJzKCkgPCAxMjtcbiAgICAgICAgc2Vzc2lvbi5zZW5kKCdDcmVhdGluZyBhbGFybSBuYW1lZCBcIiVzXCIgZm9yICVkLyVkLyVkICVkOiUwMmQlcycsXG4gICAgICAgICAgYWxhcm0udGl0bGUsXG4gICAgICAgICAgZGF0ZS5nZXRNb250aCgpICsgMSwgZGF0ZS5nZXREYXRlKCksIGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgICBpc0FNID8gZGF0ZS5nZXRIb3VycygpIDogZGF0ZS5nZXRIb3VycygpIC0gMTIsIGRhdGUuZ2V0TWludXRlcygpLCBpc0FNID8gJ2FtJyA6ICdwbScpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2Vzc2lvbi5zZW5kKCdPay4uLiBubyBwcm9ibGVtLicpO1xuICAgICAgfVxuICAgIH1cbiAgXSk7XG5cbiAgZGlhbG9nLm9uRGVmYXVsdChmdW5jdGlvbiAoc2Vzc2lvbikge1xuICAgIGxvZ1F1ZXJ5KHNlc3Npb24sIFwib25EZWZhdWx0XCIpO1xuICAgIHZhciBlbGl6YSA9IGdldEVsaXphQm90KGdldENvbnZlcnNhdGlvbklkKHNlc3Npb24pKTtcbiAgICB2YXIgcmVwbHkgPSBlbGl6YS50cmFuc2Zvcm0oc2Vzc2lvbi5tZXNzYWdlLnRleHQpO1xuICAgIGRpYWxvZ2xvZyhcImVsaXphXCIsc2Vzc2lvbixzZW5kKHJlcGx5KSk7XG4gICAgLy9uZXcgRWlsemFib3RcbiAgICAvL3Nlc3Npb24uc2VuZChcIkkgZG8gbm90IHVuZGVyc3RhbmQgdGhpcyBhdCBhbGxcIik7XG4gICAgLy9idWlsZGVyLkRpYWxvZ0FjdGlvbi5zZW5kKCdJXFwnbSBzb3JyeSBJIGRpZG5cXCd0IHVuZGVyc3RhbmQuIEkgY2FuIG9ubHkgc2hvdyBzdGFydCBhbmQgcmluZycpO1xuICB9KTtcblxuICAvKlxuICAvLyBWZXJ5IHNpbXBsZSBhbGFybSBzY2hlZHVsZXJcbiAgdmFyIGFsYXJtcyA9IHt9O1xuICBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7XG4gICAgdmFyIG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgIGZvciAodmFyIGtleSBpbiBhbGFybXMpIHtcbiAgICAgIHZhciBhbGFybSA9IGFsYXJtc1trZXldO1xuICAgICAgaWYgKG5vdyA+PSBhbGFybS50aW1lc3RhbXApIHtcbiAgICAgICAgdmFyIG1zZyA9IG5ldyBidWlsZGVyLk1lc3NhZ2UoKVxuICAgICAgICAgIC5hZGRyZXNzKGFsYXJtLmFkZHJlc3MpXG4gICAgICAgICAgLnRleHQoJ0hlcmVcXCdzIHlvdXIgXFwnJXNcXCcgYWxhcm0uJywgYWxhcm0udGl0bGUpO1xuICAgICAgICBib3Quc2VuZChtc2cpO1xuICAgICAgICBkZWxldGUgYWxhcm1zW2tleV07XG4gICAgICB9XG4gICAgfVxuICB9LCAxNTAwMCk7XG4gICovXG59XG5cbmlmIChtb2R1bGUpIHtcbiAgbW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgbWFrZUJvdDogbWFrZUJvdFxuICB9O1xufVxuIiwiLyoqXG4gKiBUaGUgYm90IGltcGxlbWVudGF0aW9uXG4gKlxuICogSW5zdGFudGlhdGUgYXBzc2luZyBhIGNvbm5lY3RvciB2aWFcbiAqIG1ha2VCb3RcbiAqXG4gKi9cbi8qKlxuICogQGZpbGVcbiAqIEBtb2R1bGUgamZzZWIuZmRldnN0YXJ0LnNtYXJ0ZGlhbG9nXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2IEdlcmQgRm9yc3RtYW5uXG4gKi9cbi8vZGVjbGFyZSBtb2R1bGUgJ2VsaXphYm90JyB7IH07XG4vL2RlY2xhcmUgbW9kdWxlICd3aW5zdG9uLXBnJyB7IH07XG4vL2RlbGNhcmUgbW9kdWxlICd3aW5zdG9uJyB7fTtcblwidXNlIHN0cmljdFwiO1xudmFyIGJ1aWxkZXIgPSByZXF1aXJlKCdib3RidWlsZGVyJyk7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIE1hdGNoID0gcmVxdWlyZSgnLi4vbWF0Y2gvbWF0Y2gnKTtcbnZhciBBbmFseXplID0gcmVxdWlyZSgnLi4vbWF0Y2gvYW5hbHl6ZScpO1xudmFyIFdoYXRJcyA9IHJlcXVpcmUoJy4uL21hdGNoL3doYXRpcycpO1xudmFyIExpc3RBbGwgPSByZXF1aXJlKCcuLi9tYXRjaC9saXN0YWxsJyk7XG52YXIgRGlhbG9nTG9nZ2VyID0gcmVxdWlyZSgnLi4vdXRpbHMvZGlhbG9nbG9nZ2VyJyk7XG52YXIgcHJvY2VzcyA9IHJlcXVpcmUoJ3Byb2Nlc3MnKTtcbnZhciBkYnVybCA9IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCB8fCBcIlwiO1xudmFyIHBnbG9jYWx1cmwgPSBcInBvc3RncmVzOi8vam9lOmFiY2RlZkBsb2NhbGhvc3Q6NTQzMi9hYm90XCI7XG52YXIgZGJ1cmwgPSBwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwgfHwgcGdsb2NhbHVybDtcbnZhciBwZyA9IHJlcXVpcmUoJ3BnJyk7XG52YXIgbyA9IHBnO1xuby5kZWZhdWx0cy5zc2wgPSB0cnVlO1xudmFyIGRpYWxvZ0xvZ2dlciA9IERpYWxvZ0xvZ2dlci5sb2dnZXIoXCJzbWFydGJvdFwiLCBkYnVybCwgcGcpO1xuZnVuY3Rpb24gc2VuZChvKSB7IHJldHVybiBvOyB9XG47XG5mdW5jdGlvbiBkaWFsb2dsb2coaW50ZW50LCBzZXNzaW9uLCByZXNwb25zZSkge1xuICAgIHZhciBzUmVzcG9uc2U7XG4gICAgdmFyIHNBY3Rpb247XG4gICAgaWYgKHR5cGVvZiByZXNwb25zZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBzQWN0aW9uID0gXCJcIjtcbiAgICAgICAgc1Jlc3BvbnNlID0gcmVzcG9uc2U7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICB2YXIgYU1lc3NhZ2UgPSByZXNwb25zZTtcbiAgICAgICAgdmFyIGlNZXNzYWdlID0gYU1lc3NhZ2UudG9NZXNzYWdlKCk7XG4gICAgICAgIHNSZXNwb25zZSA9IGlNZXNzYWdlLnRleHQ7XG4gICAgICAgIHNBY3Rpb24gPSAoaU1lc3NhZ2UuZW50aXRpZXMgJiYgaU1lc3NhZ2UuZW50aXRpZXNbMF0pID8gKEpTT04uc3RyaW5naWZ5KGlNZXNzYWdlLmVudGl0aWVzICYmIGlNZXNzYWdlLmVudGl0aWVzWzBdKSkgOiBcIlwiO1xuICAgIH1cbiAgICBkaWFsb2dMb2dnZXIoe1xuICAgICAgICBpbnRlbnQ6IGludGVudCxcbiAgICAgICAgc2Vzc2lvbjogc2Vzc2lvbixcbiAgICAgICAgcmVzcG9uc2U6IHNSZXNwb25zZSxcbiAgICAgICAgYWN0aW9uOiBzQWN0aW9uXG4gICAgfSk7XG4gICAgc2Vzc2lvbi5zZW5kKHJlc3BvbnNlKTtcbn1cbi8vY29uc3QgcGdMb2dnZXIgPSBuZXcgUGdMb2dnZXIoe1xuLy8gIG5hbWU6ICd0ZXN0LWxvZ2dlcicsXG4vLyAgbGV2ZWw6ICdkZWJ1ZycsXG4vLyAgY29ublN0cmluZzogJ3Bvc3RncmVzOi8vdWJ1bnR1QGxvY2FsaG9zdDo1NDMyL2NpcmNsZV90ZXN0Jyxcbi8vICB0YWJsZU5hbWU6ICd3aW5zdG9uX2xvZ3MnLFxuLy99KTtcbi8vd2luc3Rvbi5hZGQod2luc3Rvbi50cmFuc3BvcnRzLkZpbGUsIHsgZmlsZW5hbWU6ICd3aW5zdG9uX291dC5sb2cnLCB0aW1lc3RhbXAgOiB0cnVlIH0pO1xuLy8gIHdpbnN0b24ucmVtb3ZlKHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKTtcbi8vd2luc3Rvbi5hZGQocGdMb2dnZXIpO1xuLypcbmNvbnN0IGxvZ2dlciA9IG5ldyB3aW5zdG9uLkxvZ2dlcih7XG4gIHRyYW5zcG9ydHM6IFtcbiAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xuICAgICAgY29sb3I6IHRydWUsXG4gICAgICB0aW1lc3RhbXA6IHRydWUsXG4gICAgfSksXG4gICAgcGdMb2dnZXIsXG4gIF1cbn0pO1xuKi9cbi8vcGdMb2dnZXIuaW5pdFRhYmxlKGRvbmUpO1xudmFyIGVsaXphYm90ID0gcmVxdWlyZSgnLi4vZXh0ZXJuL2VsaXphYm90L2VsaXphYm90LmpzJyk7XG4vL2ltcG9ydCAqIGFzIGVsaXphYm90IGZyb20gJ2VsaXphYm90JztcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdzbWFydGRpYWxvZycpO1xudmFyIFBsYWluUmVjb2duaXplciA9IHJlcXVpcmUoJy4vcGxhaW5yZWNvZ25pemVyJyk7XG4vL3ZhciBidWlsZGVyID0gcmVxdWlyZSgnYm90YnVpbGRlcicpO1xudmFyIGRpc3BhdGNoZXIgPSByZXF1aXJlKCcuLi9tYXRjaC9kaXNwYXRjaGVyLmpzJykuZGlzcGF0Y2hlcjtcbmZ1bmN0aW9uIGdldENvbnZlcnNhdGlvbklkKHNlc3Npb24pIHtcbiAgICByZXR1cm4gc2Vzc2lvbi5tZXNzYWdlICYmXG4gICAgICAgIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzICYmXG4gICAgICAgIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvbi5pZDtcbn1cbnZhciBlbGl6YWJvdHMgPSB7fTtcbmZ1bmN0aW9uIGdldEVsaXphQm90KGlkKSB7XG4gICAgaWYgKCFlbGl6YWJvdHNbaWRdKSB7XG4gICAgICAgIGVsaXphYm90c1tpZF0gPSB7XG4gICAgICAgICAgICBhY2Nlc3M6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICBlbGl6YWJvdDogbmV3IGVsaXphYm90KClcbiAgICAgICAgfTtcbiAgICB9XG4gICAgZWxpemFib3RzW2lkXS5hY2Nlc3MgPSBuZXcgRGF0ZSgpO1xuICAgIHJldHVybiBlbGl6YWJvdHNbaWRdLmVsaXphYm90O1xufVxudmFyIG5ld0Zsb3cgPSB0cnVlO1xudmFyIE1vZGVsID0gcmVxdWlyZSgnLi4vbW9kZWwvbW9kZWwnKTtcbnZhciBFeGVjU2VydmVyID0gcmVxdWlyZSgnLi4vZXhlYy9leGVjc2VydmVyJyk7XG52YXIgdGhlTW9kZWwgPSBNb2RlbC5sb2FkTW9kZWxzKCk7XG5pZiAobmV3Rmxvdykge1xufVxuZWxzZSB7XG59XG5mdW5jdGlvbiBpc0Fub255bW91cyh1c2VyaWQpIHtcbiAgICByZXR1cm4gdXNlcmlkLmluZGV4T2YoXCJhbm86XCIpID09PSAwO1xufVxuZnVuY3Rpb24gcmVzdHJpY3RMb2dnZWRPbihzZXNzaW9uLCBhcnIpIHtcbiAgICB2YXIgdXNlcmlkID0gc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlclxuICAgICAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyLmlkIHx8IFwiXCI7XG4gICAgaWYgKHByb2Nlc3MuZW52LkFCT1RfRU1BSUxfVVNFUiAmJiBpc0Fub255bW91cyh1c2VyaWQpKSB7XG4gICAgICAgIGlmIChhcnIubGVuZ3RoIDwgNikge1xuICAgICAgICAgICAgcmV0dXJuIGFycjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbGVuID0gYXJyLmxlbmd0aDtcbiAgICAgICAgdmFyIHJlcyA9IGFyci5zbGljZSgwLCBNYXRoLm1pbihNYXRoLm1heChNYXRoLmZsb29yKGFyci5sZW5ndGggLyAzKSwgNyksIGFyci5sZW5ndGgpKTtcbiAgICAgICAgaWYgKHR5cGVvZiBhcnJbMF0gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHZhciBkZWx0YSA9IGxlbiAtIHJlcy5sZW5ndGg7XG4gICAgICAgICAgICByZXMucHVzaChcIi4uLiBhbmQgXCIgKyBkZWx0YSArIFwiIG1vcmUgZW50cmllcyBmb3IgcmVnaXN0ZXJlZCB1c2Vyc1wiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzO1xuICAgIH1cbiAgICByZXR1cm4gYXJyO1xufVxudmFyIFNpbXBsZVJlY29nbml6ZXIgPSAoZnVuY3Rpb24gKCkge1xuICAgIGZ1bmN0aW9uIFNpbXBsZVJlY29nbml6ZXIoKSB7XG4gICAgfVxuICAgIFNpbXBsZVJlY29nbml6ZXIucHJvdG90eXBlLnJlY29nbml6ZSA9IGZ1bmN0aW9uIChjb250ZXh0LCBjYWxsYmFjaykge1xuICAgICAgICB2YXIgdSA9IHt9O1xuICAgICAgICBkZWJ1Z2xvZyhcInJlY29nbml6aW5nIFwiICsgY29udGV4dC5tZXNzYWdlLnRleHQpO1xuICAgICAgICBpZiAoY29udGV4dC5tZXNzYWdlLnRleHQuaW5kZXhPZihcInN0YXJ0XCIpID49IDApIHtcbiAgICAgICAgICAgIHUuaW50ZW50ID0gXCJTaG93RW50aXR5XCI7XG4gICAgICAgICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJzdGFydCBcIi5sZW5ndGg7XG4gICAgICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjb250ZXh0Lm1lc3NhZ2UudGV4dC5pbmRleE9mKFwidHJhaW5cIikgPj0gMCkge1xuICAgICAgICAgICAgdS5pbnRlbnQgPSBcInRyYWluXCI7XG4gICAgICAgICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJ0cmFpbiBcIi5sZW5ndGg7XG4gICAgICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjb250ZXh0Lm1lc3NhZ2UudGV4dC5pbmRleE9mKFwibGVhcm5cIikgPj0gMCkge1xuICAgICAgICAgICAgdS5pbnRlbnQgPSBcImxlYXJuXCI7XG4gICAgICAgICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgICAgICBlMS50eXBlID0gXCJ0cmFpbkZhY3RcIjtcbiAgICAgICAgICAgIGUxLnN0YXJ0SW5kZXggPSBcInRyYWluIFwiLmxlbmd0aDtcbiAgICAgICAgICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgICAgICAgICAgZTEuc2NvcmUgPSAwLjM7XG4gICAgICAgICAgICB1LmVudGl0aWVzID0gW2UxXTtcbiAgICAgICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbnRleHQubWVzc2FnZS50ZXh0LmluZGV4T2YoXCJoZWxwXCIpID49IDApIHtcbiAgICAgICAgICAgIHUuaW50ZW50ID0gXCJoZWxwXCI7XG4gICAgICAgICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJ0cmFpbiBcIi5sZW5ndGg7XG4gICAgICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjb250ZXh0Lm1lc3NhZ2UudGV4dC5pbmRleE9mKFwiZXhpdFwiKSA+PSAwKSB7XG4gICAgICAgICAgICB1LmludGVudCA9IFwiZXhpdFwiO1xuICAgICAgICAgICAgdS5zY29yZSA9IDAuOTtcbiAgICAgICAgICAgIHZhciBlMSA9IHt9O1xuICAgICAgICAgICAgZTEuc3RhcnRJbmRleCA9IFwiZXhpdCBcIi5sZW5ndGg7XG4gICAgICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjb250ZXh0Lm1lc3NhZ2UudGV4dC5pbmRleE9mKFwid3JvbmdcIikgPj0gMCkge1xuICAgICAgICAgICAgdS5pbnRlbnQgPSBcIndyb25nXCI7XG4gICAgICAgICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJleGl0IFwiLmxlbmd0aDtcbiAgICAgICAgICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgICAgICAgICAgZTEuc2NvcmUgPSAwLjM7XG4gICAgICAgICAgICB1LmVudGl0aWVzID0gW2UxXTtcbiAgICAgICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZGVidWdsb2coJ3JlY29nbml6aW5nIG5vdGhpbmcnKTtcbiAgICAgICAgdS5pbnRlbnQgPSBcIk5vbmVcIjtcbiAgICAgICAgdS5zY29yZSA9IDAuMTtcbiAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgIGUxLnN0YXJ0SW5kZXggPSBcImV4aXQgXCIubGVuZ3RoO1xuICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgZTEuc2NvcmUgPSAwLjE7XG4gICAgICAgIHUuZW50aXRpZXMgPSBbXTtcbiAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgICB9O1xuICAgIHJldHVybiBTaW1wbGVSZWNvZ25pemVyO1xufSgpKTtcbnZhciBhVHJhaW5SZXBsaWVzID0gW1wiVGhhbmsgeW91IGZvciBzaGFyaW5nIHRoaXMgc3VnZ2VzdGlvbiB3aXRoIHVzXCIsXG4gICAgXCJUaGFuayBmb3IgZm9yIHRoaXMgdmFsdWFibGUgaW5mb3JtYXRpb24uXCIsXG4gICAgXCJUaGFuayBmb3IgZm9yIHRoaXMgaW50ZXJlc3RpbmcgZmFjdCFcIixcbiAgICBcIlRoYXRzIGEgcGxldGhvcmlhIG9mIGluZm9ybWF0aW9uLlwiLFxuICAgIFwiVGhhdCdzIGEgbnVnZ2V0IG9mIGluZm9ybWF0aW9uLlwiLFxuICAgIFwiTG92ZWx5LCBJIG1heSBjb25zaWRlciB5b3UgaW5wdXQuXCIsXG4gICAgXCJXZWxsIGRvbmUsIGFueXRoaW5nIG1vcmUgdG8gbGV0IG1lIGtub3c/XCIsXG4gICAgXCJJIGRvIGFwcHJlY2lhdGUgeW91ciB0ZWFjaGluZyBhbmQgbXkgbGVhcm5pbmcgZXhwZXJpZW5jZSwgb3Igd2FzIGl0IHRoZSBvdGhlciB3YXkgcm91bmQ/XCIsXG4gICAgXCJZb3VyIGhlbHBmdWwgaW5wdXQgaGFzIGJlZW4gc3RvcmVkIGluIHNvbWUgZHVzdHkgY29ybmVyIG9mIHRoZSBXb3JsZCB3aWRlIHdlYiFcIixcbiAgICBcIlRoYW5rIHlvdSBmb3IgbXkgbGVhcm5pbmcgZXhwZXJpZW5jZSFcIixcbiAgICBcIkkgaGF2ZSBpbmNvcnBvcmF0ZWQgeW91ciB2YWx1YWJsZSBzdWdnZXN0aW9uIGluIHRoZSB3aXNkb20gb2YgdGhlIGludGVybmV0XCJcbl07XG52YXIgYVRyYWluRGlhbG9nID0gYVRyYWluUmVwbGllcztcbnZhciBhVHJhaW5FeGl0SGludCA9IFtcbiAgICBcIlxcbnR5cGUgXFxcImRvbmVcXFwiIHdoZW4geW91IGFyZSBkb25lIHRyYWluaW5nIG1lLlwiLFxuICAgIFwiXCIsXG4gICAgXCJcIixcbiAgICBcIlwiLFxuICAgIFwiXFxucmVtZW1iZXIsIHlvdSBhcmUgc3R1Y2sgaGVyZSBpbnN0cnVjdGluZyBtZSwgdHlwZSBcXFwiZG9uZVxcXCIgdG8gcmV0dXJuLlwiLFxuICAgIFwiXCJdO1xudmFyIGFFbnRlclRyYWluID0gW1wiU28geW91IHRoaW5rIHRoaXMgaXMgd3Jvbmc/IFlvdSBjYW4gb2ZmZXIgeW91ciBhZHZpc2UgaGVyZS5cXG4gVHlwZSBcXFwiZG9uZVxcXCIgaWYgeW91IGFyZSBkb25lIHdpdGggaW5zdHJ1Y3RpbmcgbWVcIixcbiAgICBcIkZlZWwgZnJlZSB0byBvZmZlciBtZSB5b3VyIGJldHRlciBzb2x1dGlvbiBoZXJlLlxcblwiLFxuICAgIFwiU29tZSBzYXkgXFxcIlRoZSBzZWNyZXQgdG8gaGFwcGluZXNzIGlzIHRvIGxvd2VyIHlvdXIgZXhwZWN0YXRpb25zIHRvIHRoZSBwb2ludCB0aGV5IGFyZSBhbHJlYWR5IG1ldC5cXFwiLCBcXG50IGlmIHlvdSBjb3VsZCBoZWxwIG1lIHRvIGJlY29tZGUgYmV0dGVyLCBpbnN0cnVjdCBtZS5cIixcbiAgICBcIkZlZWwgZnJlZSB0byBvZmZlciBtZSB5b3VyIGJldHRlciBzb2x1dGlvbiBoZXJlLlxcbiBUeXBlIFxcXCJkb25lXFxcIiBpZiB5b3UgYXJlIGRvbmUgd2l0aCBpbnN0cnVjdGluZyBtZVwiLFxuICAgIFwiRmVlbCBmcmVlIHRvIG9mZmVyIG1lIHlvdXIgYmV0dGVyIHNvbHV0aW9uIGhlcmUuXFxuIFR5cGUgXFxcImRvbmVcXFwiIGlmIHlvdSBhcmUgZG9uZSB3aXRoIGluc3RydWN0aW5nIG1lXCIsXG5dO1xudmFyIGFCYWNrRnJvbVRyYWluaW5nID0gW1xuICAgIFwiUHV1aCwgYmFjayBmcm9tIHRyYWluaW5nISBOb3cgZm9yIHRoZSBlYXN5IHBhcnQgLi4uXCIsXG4gICAgXCJMaXZlIGFuZCBkb24ndCBsZWFybiwgdGhhdCdzIHVzLiBOYWFoLCB3ZSdsbCBzZWUuXCIsXG4gICAgXCJUaGUgc2VjcmV0IHRvIGhhcHBpbmVzcyBpcyB0byBsb3dlciB5b3VyIGV4cGVjdGF0aW9ucyB0byB0aGUgcG9pbnQgdGhleSBhcmUgYWxyZWFkeSBtZXQuXCIsXG4gICAgXCJUaGFua3MgZm9yIGhhdmluZyB0aGlzIGxlY3R1cmUgc2Vzc2lvbiwgbm93IGJhY2sgdG8gb3VyIHVzdWFsIHNlbGYuXCJcbl07XG52YXIgYVRyYWluTm9LbGluZ29uID0gW1xuICAgIFwiSGUgd2hvIG1hc3RlciB0aGUgZGFyayBhcnRzIG9mIFNBUCBtdXN0IG5vdCBkd2VsbCBpbiB0aGUgZWFydGhseSByZWFsbXMgb2YgU3RhcnQgVHJlay5cIixcbiAgICBcIlNBUCBpcyBhIGNsb3VkIGNvbXBhbnksIG5vdCBhIHNwYWNlIGNvbXBhbnkuXCIsXG4gICAgXCJUaGUgZGVwdGggb2YgUi8zIGFyZSBkZWVwZXIgdGhhbiBEZWVwIFNwYWNlIDQyLlwiLFxuICAgIFwiTXkgYnJhaW5wb3dlciBpcyBmdWxseSBhYnNvcmJlZCB3aXRoIG1hc3RlcmluZyBvdGhlciByZWFsbXMuXCIsXG4gICAgXCJGb3IgdGhlIHdvc2FwLCB0aGUgc2t5IGlzIHRoZSBsaW1pdC4gRmVlbCBmcmVlIHRvIGNoZWNrIG91dCBuYXNhLmdvdiAuXCIsXG4gICAgXCJUaGUgZnV0dXJlIGlzIFNBUCBvciBJQk0gYmx1ZSwgbm90IHNwYWNlIGJsYWNrLlwiLFxuICAgIFwiVGhhdCdzIGxlZnQgdG8gc29tZSBtdXNreSBmdXR1cmUuXCJcbl07XG5mdW5jdGlvbiBnZXRSYW5kb21SZXN1bHQoYXJyKSB7XG4gICAgcmV0dXJuIGFycltNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBhcnIubGVuZ3RoKSAlIGFyci5sZW5ndGhdO1xufVxudmFyIFNpbXBsZVVwRG93blJlY29nbml6ZXIgPSAoZnVuY3Rpb24gKCkge1xuICAgIGZ1bmN0aW9uIFNpbXBsZVVwRG93blJlY29nbml6ZXIoKSB7XG4gICAgfVxuICAgIFNpbXBsZVVwRG93blJlY29nbml6ZXIucHJvdG90eXBlLnJlY29nbml6ZSA9IGZ1bmN0aW9uIChjb250ZXh0LCBjYWxsYmFjaykge1xuICAgICAgICB2YXIgdSA9IHt9O1xuICAgICAgICBkZWJ1Z2xvZyhcInJlY29nbml6aW5nIFwiICsgY29udGV4dC5tZXNzYWdlLnRleHQpO1xuICAgICAgICBpZiAoY29udGV4dC5tZXNzYWdlLnRleHQuaW5kZXhPZihcImRvd25cIikgPj0gMCkge1xuICAgICAgICAgICAgdS5pbnRlbnQgPSBcImludGVudC5kb3duXCI7XG4gICAgICAgICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJzdGFydCBcIi5sZW5ndGg7XG4gICAgICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjb250ZXh0Lm1lc3NhZ2UudGV4dC5pbmRleE9mKFwidXBcIikgPj0gMCkge1xuICAgICAgICAgICAgdS5pbnRlbnQgPSBcImludGVudC51cFwiO1xuICAgICAgICAgICAgdS5zY29yZSA9IDAuOTtcbiAgICAgICAgICAgIHZhciBlMSA9IHt9O1xuICAgICAgICAgICAgZTEuc3RhcnRJbmRleCA9IFwidXBcIi5sZW5ndGg7XG4gICAgICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjb250ZXh0Lm1lc3NhZ2UudGV4dC5pbmRleE9mKFwiZG9uZVwiKSA+PSAwKSB7XG4gICAgICAgICAgICB1LmludGVudCA9IFwiaW50ZW50LnVwXCI7XG4gICAgICAgICAgICB1LnNjb3JlID0gMC45O1xuICAgICAgICAgICAgdmFyIGUxID0ge307XG4gICAgICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJ1cFwiLmxlbmd0aDtcbiAgICAgICAgICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgICAgICAgICAgZTEuc2NvcmUgPSAwLjM7XG4gICAgICAgICAgICB1LmVudGl0aWVzID0gW2UxXTtcbiAgICAgICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbnRleHQubWVzc2FnZS50ZXh0LmluZGV4T2YoXCJleGl0XCIpID49IDApIHtcbiAgICAgICAgICAgIHUuaW50ZW50ID0gXCJpbnRlbnQudXBcIjtcbiAgICAgICAgICAgIHUuc2NvcmUgPSAwLjk7XG4gICAgICAgICAgICB2YXIgZTEgPSB7fTtcbiAgICAgICAgICAgIGUxLnN0YXJ0SW5kZXggPSBcInVwXCIubGVuZ3RoO1xuICAgICAgICAgICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgICAgICAgICBlMS5zY29yZSA9IDAuMztcbiAgICAgICAgICAgIHUuZW50aXRpZXMgPSBbZTFdO1xuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB1KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY29udGV4dC5tZXNzYWdlLnRleHQuaW5kZXhPZihcInF1aXRcIikgPj0gMCkge1xuICAgICAgICAgICAgdS5pbnRlbnQgPSBcImludGVudC51cFwiO1xuICAgICAgICAgICAgdS5zY29yZSA9IDAuOTtcbiAgICAgICAgICAgIHZhciBlMSA9IHt9O1xuICAgICAgICAgICAgZTEuc3RhcnRJbmRleCA9IFwidXBcIi5sZW5ndGg7XG4gICAgICAgICAgICBlMS5lbmRJbmRleCA9IGNvbnRleHQubWVzc2FnZS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgIGUxLnNjb3JlID0gMC4zO1xuICAgICAgICAgICAgdS5lbnRpdGllcyA9IFtlMV07XG4gICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGRlYnVnbG9nKCdyZWNvZ25pemluZyBub3RoaW5nJyk7XG4gICAgICAgIHUuaW50ZW50ID0gXCJOb25lXCI7XG4gICAgICAgIHUuc2NvcmUgPSAwLjE7XG4gICAgICAgIHZhciBlMSA9IHt9O1xuICAgICAgICBlMS5zdGFydEluZGV4ID0gXCJleGl0IFwiLmxlbmd0aDtcbiAgICAgICAgZTEuZW5kSW5kZXggPSBjb250ZXh0Lm1lc3NhZ2UudGV4dC5sZW5ndGg7XG4gICAgICAgIGUxLnNjb3JlID0gMC4xO1xuICAgICAgICB1LmVudGl0aWVzID0gW107XG4gICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgdSk7XG4gICAgfTtcbiAgICByZXR1cm4gU2ltcGxlVXBEb3duUmVjb2duaXplcjtcbn0oKSk7XG52YXIgQW55T2JqZWN0ID0gT2JqZWN0O1xuLy8gZ2xvYmFsVHVubmVsLmluaXRpYWxpemUoe1xuLy8gIGhvc3Q6ICdwcm94eS5leHh4YW1wbGUuY29tJyxcbi8vICBwb3J0OiA4MDgwXG4vLyB9KVxuLy8gQ3JlYXRlIGJvdCBhbmQgYmluZCB0byBjb25zb2xlXG4vLyB2YXIgY29ubmVjdG9yID0gbmV3IGh0bWxjb25uZWN0b3IuSFRNTENvbm5lY3RvcigpXG4vLyBjb25uZWN0b3Iuc2V0QW5zd2VySG9vayhmdW5jdGlvbiAoc0Fuc3dlcikge1xuLy8gIGNvbnNvbGUubG9nKCdHb3QgYW5zd2VyIDogJyArIHNBbnN3ZXIgKyAnXFxuJylcbi8vIH0pXG52YXIgYm90O1xuLy8gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4vLyAgIGNvbm5lY3Rvci5wcm9jZXNzTWVzc2FnZSgnc3RhcnQgdW5pdCB0ZXN0IEFCQyAnKVxuLy8gfSwgNTAwMClcbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG52YXIgb0pTT04gPSBKU09OLnBhcnNlKCcnICsgZnMucmVhZEZpbGVTeW5jKCcuL3Jlc291cmNlcy9tb2RlbC9pbnRlbnRzLmpzb24nKSk7XG52YXIgb1J1bGVzID0gUGxhaW5SZWNvZ25pemVyLnBhcnNlUnVsZXMob0pTT04pO1xuLy8gdmFyIFJlY29nbml6ZXIgPSBuZXcgKHJlY29nbml6ZXIuUmVnRXhwUmVjb2duaXplcikob1J1bGVzKTtcbmZ1bmN0aW9uIGxvZ1F1ZXJ5KHNlc3Npb24sIGludGVudCwgcmVzdWx0KSB7XG4gICAgZnMuYXBwZW5kRmlsZSgnLi9sb2dzL3Nob3dtZXF1ZXJpZXMudHh0JywgXCJcXG5cIiArIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgdGV4dDogc2Vzc2lvbi5tZXNzYWdlLnRleHQsXG4gICAgICAgIHRpbWVzdGFtcDogc2Vzc2lvbi5tZXNzYWdlLnRpbWVzdGFtcCxcbiAgICAgICAgaW50ZW50OiBpbnRlbnQsXG4gICAgICAgIHJlczogcmVzdWx0ICYmIHJlc3VsdC5sZW5ndGggJiYgTWF0Y2guVG9vbE1hdGNoLmR1bXBOaWNlKHJlc3VsdFswXSkgfHwgXCIwXCIsXG4gICAgICAgIGNvbnZlcnNhdGlvbklkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uXG4gICAgICAgICAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5jb252ZXJzYXRpb24uaWQgfHwgXCJcIixcbiAgICAgICAgdXNlcmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlclxuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlci5pZCB8fCBcIlwiXG4gICAgfSksIGZ1bmN0aW9uIChlcnIsIHJlcykge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcImxvZ2dpbmcgZmFpbGVkIFwiICsgZXJyKTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuZnVuY3Rpb24gbG9nUXVlcnlXaGF0SXMoc2Vzc2lvbiwgaW50ZW50LCByZXN1bHQpIHtcbiAgICBmcy5hcHBlbmRGaWxlKCcuL2xvZ3Mvc2hvd21lcXVlcmllcy50eHQnLCBcIlxcblwiICsgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICB0ZXh0OiBzZXNzaW9uLm1lc3NhZ2UudGV4dCxcbiAgICAgICAgdGltZXN0YW1wOiBzZXNzaW9uLm1lc3NhZ2UudGltZXN0YW1wLFxuICAgICAgICBpbnRlbnQ6IGludGVudCxcbiAgICAgICAgcmVzOiByZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCAmJiBXaGF0SXMuZHVtcE5pY2UocmVzdWx0WzBdKSB8fCBcIjBcIixcbiAgICAgICAgY29udmVyc2F0aW9uSWQ6IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzXG4gICAgICAgICAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5jb252ZXJzYXRpb25cbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvbi5pZCB8fCBcIlwiLFxuICAgICAgICB1c2VyaWQ6IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzXG4gICAgICAgICAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyXG4gICAgICAgICAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyLmlkIHx8IFwiXCJcbiAgICB9KSwgZnVuY3Rpb24gKGVyciwgcmVzKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwibG9nZ2luZyBmYWlsZWQgXCIgKyBlcnIpO1xuICAgICAgICB9XG4gICAgfSk7XG59XG52YXIgZ3dvcmRzID0ge307XG4vKipcbiAqIENvbnN0cnVjdCBhIGJvdFxuICogQHBhcmFtIGNvbm5lY3RvciB7Q29ubmVjdG9yfSB0aGUgY29ubmVjdG9yIHRvIHVzZVxuICogSFRNTENvbm5lY3RvclxuICogb3IgY29ubmVjdG9yID0gbmV3IGJ1aWxkZXIuQ29uc29sZUNvbm5lY3RvcigpLmxpc3RlbigpXG4gKi9cbmZ1bmN0aW9uIG1ha2VCb3QoY29ubmVjdG9yKSB7XG4gICAgYm90ID0gbmV3IGJ1aWxkZXIuVW5pdmVyc2FsQm90KGNvbm5lY3Rvcik7XG4gICAgLy8gQ3JlYXRlIExVSVMgcmVjb2duaXplciB0aGF0IHBvaW50cyBhdCBvdXIgbW9kZWwgYW5kIGFkZCBpdCBhcyB0aGUgcm9vdCAnLycgZGlhbG9nIGZvciBvdXIgQ29ydGFuYSBCb3QuXG4gICAgLy8gdmFyIG1vZGVsID0gc2Vuc2l0aXZlLm1vZGVsdXJsO1xuICAgIC8vIHZhciBtb2RlbCA9ICdodHRwczovL2FwaS5wcm9qZWN0b3hmb3JkLmFpL2x1aXMvdjIuMC9hcHBzL2M0MTNiMmVmLTM4MmMtNDViZC04ZmYwLWY3NmQ2MGUyYTgyMT9zdWJzY3JpcHRpb24ta2V5PWMyMTM5OGI1OTgwYTRjZTA5ZjQ3NGJiZmVlOTNiODkyJnE9J1xuICAgIHZhciByZWNvZ25pemVyID0gbmV3IFBsYWluUmVjb2duaXplci5SZWdFeHBSZWNvZ25pemVyKG9SdWxlcyk7XG4gICAgdmFyIGRpYWxvZyA9IG5ldyBidWlsZGVyLkludGVudERpYWxvZyh7IHJlY29nbml6ZXJzOiBbcmVjb2duaXplcl0gfSk7XG4gICAgLy8gZGlhbG9nLm9uQmVnaW4oZnVuY3Rpb24oc2Vzc2lvbixhcmdzKSB7XG4gICAgLy8gY29uc29sZS5sb2coXCJiZWdpbm5pbmcgLi4uXCIpXG4gICAgLy8gc2Vzc2lvbi5kaWFsb2dEYXRhLnJldHJ5UHJvbXB0ID0gYXJncyAmJiBhcmdzLnJldHJ5UHJvbXB0IHx8IFwiSSBhbSBzb3JyeVwiXG4gICAgLy8gc2Vzc2lvbi5zZW5kKFwiV2hhdCBkbyB5b3Ugd2FudD9cIilcbiAgICAvL1xuICAgIC8vIH0pXG4gICAgdmFyIGRpYWxvZ1VwRG93biA9IG5ldyBidWlsZGVyLkludGVudERpYWxvZyh7IHJlY29nbml6ZXJzOiBbbmV3IFNpbXBsZVVwRG93blJlY29nbml6ZXIoKV0gfSk7XG4gICAgYm90LmRpYWxvZygnL3VwZG93bicsIGRpYWxvZ1VwRG93bik7XG4gICAgZGlhbG9nVXBEb3duLm9uQmVnaW4oZnVuY3Rpb24gKHNlc3Npb24pIHtcbiAgICAgICAgZGlhbG9nbG9nKFwiVHJhaW5NZVwiLCBzZXNzaW9uLCBzZW5kKGdldFJhbmRvbVJlc3VsdChhRW50ZXJUcmFpbikpKTtcbiAgICAgICAgLy9zZXNzaW9uLnNlbmQoXCJIaSB0aGVyZSwgdXBkb3duIGlzIHdhaXRpbmcgZm9yIHlvdVwiKTtcbiAgICB9KTtcbiAgICBkaWFsb2dVcERvd24ubWF0Y2hlcygnaW50ZW50LnVwJywgW1xuICAgICAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgYXJncywgbmV4dCkge1xuICAgICAgICAgICAgc2Vzc2lvbi5kaWFsb2dEYXRhLmFiYyA9IGFyZ3MgfHwge307XG4gICAgICAgICAgICBidWlsZGVyLlByb21wdHMudGV4dChzZXNzaW9uLCAneW91IHdhbnQgdG8gZXhpdCB0cmFpbmluZz8gdHlwZSBcXFwiZG9uZVxcXCIgYWdhaW4uJyk7XG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCByZXN1bHRzLCBuZXh0KSB7XG4gICAgICAgICAgICBzZXNzaW9uLmRpYWxvZ0RhdGEuYWJjID0gcmVzdWx0cy5yZXBvbnNlO1xuICAgICAgICAgICAgbmV4dCgpO1xuICAgICAgICB9LFxuICAgICAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cykge1xuICAgICAgICAgICAgc2Vzc2lvbi5lbmREaWFsb2dXaXRoUmVzdWx0KHsgcmVzcG9uc2U6IHNlc3Npb24uZGlhbG9nRGF0YS5hYmMgfSk7XG4gICAgICAgIH1cbiAgICBdKTtcbiAgICBkaWFsb2dVcERvd24ubWF0Y2hlcygnaW50ZW50LmRvd24nLCBbXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCBhcmdzLCBuZXh0KSB7XG4gICAgICAgICAgICBzZXNzaW9uLmRpYWxvZ0RhdGEuYWJjID0gYXJncyB8fCB7fTtcbiAgICAgICAgICAgIGJ1aWxkZXIuUHJvbXB0cy50ZXh0KHNlc3Npb24sICd5b3Ugd2FudCB0byBnbyBkb3duIScpO1xuICAgICAgICB9LFxuICAgICAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cywgbmV4dCkge1xuICAgICAgICAgICAgc2Vzc2lvbi5kaWFsb2dEYXRhLmFiYyA9IC0xOyAvLyByZXN1bHRzLnJlcG9uc2U7XG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCByZXN1bHRzKSB7XG4gICAgICAgICAgICBzZXNzaW9uLnNlbmQoXCJzdGlsbCBnb2luZyBkb3duP1wiKTtcbiAgICAgICAgfVxuICAgIF0pO1xuICAgIGRpYWxvZ1VwRG93bi5vbkRlZmF1bHQoZnVuY3Rpb24gKHNlc3Npb24pIHtcbiAgICAgICAgbG9nUXVlcnkoc2Vzc2lvbiwgXCJvbkRlZmF1bHRcIik7XG4gICAgICAgIHZhciByZXMgPSBnZXRSYW5kb21SZXN1bHQoYVRyYWluRGlhbG9nKSArIGdldFJhbmRvbVJlc3VsdChhVHJhaW5FeGl0SGludCk7XG4gICAgICAgIGRpYWxvZ2xvZyhcIlRyYWluTWVcIiwgc2Vzc2lvbiwgc2VuZChyZXMpKTtcbiAgICB9KTtcbiAgICBib3QuZGlhbG9nKCcvdHJhaW4nLCBbXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCBhcmdzLCBuZXh0KSB7XG4gICAgICAgICAgICBzZXNzaW9uLmRpYWxnb0RhdGEuYWJjID0gYXJncyB8fCB7fTtcbiAgICAgICAgICAgIGJ1aWxkZXIuUHJvbXB0cy50ZXh0KHNlc3Npb24sICdEbyB5b3Ugd2FudCB0byB0cmFpbiBtZScpO1xuICAgICAgICB9LFxuICAgICAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cywgbmV4dCkge1xuICAgICAgICAgICAgc2Vzc2lvbi5kaWFsb2dEYXRhLmFiYyA9IHJlc3VsdHMucmVwb25zZTtcbiAgICAgICAgfSxcbiAgICAgICAgZnVuY3Rpb24gKHNlc3Npb24sIHJlc3VsdHMpIHtcbiAgICAgICAgICAgIHNlc3Npb24uZW5kRGlhbG9nV2l0aFJlc3VsdCh7IHJlc3BvbnNlOiBzZXNzaW9uLkRpYWxvZ0RhdGEuYWJjIH0pO1xuICAgICAgICB9XG4gICAgXSk7XG4gICAgYm90LmRpYWxvZygnLycsIGRpYWxvZyk7XG4gICAgZGlhbG9nLm1hdGNoZXMoJ1Nob3dNZScsIFtcbiAgICAgICAgZnVuY3Rpb24gKHNlc3Npb24sIGFyZ3MsIG5leHQpIHtcbiAgICAgICAgICAgIHZhciBpc0NvbWJpbmVkSW5kZXggPSB7fTtcbiAgICAgICAgICAgIHZhciBvTmV3RW50aXR5O1xuICAgICAgICAgICAgLy8gZXhwZWN0aW5nIGVudGl0eSBBMVxuICAgICAgICAgICAgZGVidWdsb2coXCJTaG93IEVudGl0eVwiKTtcbiAgICAgICAgICAgIGRlYnVnbG9nKCdyYXc6ICcgKyBKU09OLnN0cmluZ2lmeShhcmdzLmVudGl0aWVzKSwgdW5kZWZpbmVkLCAyKTtcbiAgICAgICAgICAgIHZhciBhMSA9IGJ1aWxkZXIuRW50aXR5UmVjb2duaXplci5maW5kRW50aXR5KGFyZ3MuZW50aXRpZXMsICdBMScpO1xuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IEFuYWx5emUuYW5hbHl6ZUFsbChhMS5lbnRpdHksIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwudG9vbHMsIGd3b3Jkcyk7XG4gICAgICAgICAgICBsb2dRdWVyeShzZXNzaW9uLCAnU2hvd01lJywgcmVzdWx0KTtcbiAgICAgICAgICAgIC8vIHRlc3QuZXhwZWN0KDMpXG4gICAgICAgICAgICAvLyAgdGVzdC5kZWVwRXF1YWwocmVzdWx0LndlaWdodCwgMTIwLCAnY29ycmVjdCB3ZWlnaHQnKTtcbiAgICAgICAgICAgIGlmICghcmVzdWx0IHx8IHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBkZWJ1Z2xvZygncmVzdWx0IDogJyArIEpTT04uc3RyaW5naWZ5KHJlc3VsdCwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgICAgICBkZWJ1Z2xvZygnYmVzdCByZXN1bHQgOiAnICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0WzBdIHx8IHt9LCB1bmRlZmluZWQsIDIpKTtcbiAgICAgICAgICAgIGRlYnVnbG9nKCd0b3AgOiAnICsgTWF0Y2guVG9vbE1hdGNoLmR1bXBXZWlnaHRzVG9wKHJlc3VsdCwgeyB0b3A6IDMgfSkpO1xuICAgICAgICAgICAgaWYgKEFuYWx5emUuaXNDb21wbGV0ZShyZXN1bHRbMF0pKSB7XG4gICAgICAgICAgICAgICAgc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCA9IHJlc3VsdFswXTtcbiAgICAgICAgICAgICAgICAvLyAgICBzZXNzaW9uLnNlbmQoJ1Nob3dpbmcgZW50aXR5IC4uLicpO1xuICAgICAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKEFuYWx5emUuZ2V0UHJvbXB0KHJlc3VsdFswXSkpIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJvbXB0ID0gQW5hbHl6ZS5nZXRQcm9tcHQocmVzdWx0WzBdKTtcbiAgICAgICAgICAgICAgICBzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0ID0gcmVzdWx0WzBdO1xuICAgICAgICAgICAgICAgIHNlc3Npb24uZGlhbG9nRGF0YS5wcm9tcHQgPSBwcm9tcHQ7XG4gICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiU2hvd01lXCIsIHNlc3Npb24sIHNlbmQoXCJOb3QgZW5vdWdoIGluZm9ybWF0aW9uIHN1cHBsaWVkOiBcIiArIE1hdGNoLlRvb2xNYXRjaC5kdW1wTmljZShzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0KSkpO1xuICAgICAgICAgICAgICAgIGJ1aWxkZXIuUHJvbXB0cy50ZXh0KHNlc3Npb24sIHByb21wdC50ZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBiZXN0ID0gcmVzdWx0Lmxlbmd0aCA/IE1hdGNoLlRvb2xNYXRjaC5kdW1wTmljZShyZXN1bHRbMF0pIDogXCI8bm90aGluZz5cIjtcbiAgICAgICAgICAgICAgICBkaWFsb2dsb2coXCJTaG93TWVcIiwgc2Vzc2lvbiwgc2VuZCgnSSBkaWQgbm90IHVuZGVyc3RhbmQgdGhpcycgKyBiZXN0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCByZXN1bHRzLCBuZXh0KSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdDtcbiAgICAgICAgICAgIGlmICghcmVzdWx0IHx8IHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzdWx0cy5yZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIC8vIHNvbWUgcHJvbXB0aW5nXG4gICAgICAgICAgICAgICAgQW5hbHl6ZS5zZXRQcm9tcHQoc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCwgc2Vzc2lvbi5kaWFsb2dEYXRhLnByb21wdCwgcmVzdWx0cy5yZXNwb25zZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoQW5hbHl6ZS5pc0NvbXBsZXRlKHNlc3Npb24uZGlhbG9nRGF0YS5yZXN1bHQpKSB7XG4gICAgICAgICAgICAgICAgbmV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoQW5hbHl6ZS5nZXRQcm9tcHQoc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCkpIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJvbXB0ID0gQW5hbHl6ZS5nZXRQcm9tcHQoc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCk7XG4gICAgICAgICAgICAgICAgc2Vzc2lvbi5kaWFsb2dEYXRhLnByb21wdCA9IHByb21wdDtcbiAgICAgICAgICAgICAgICBidWlsZGVyLlByb21wdHMudGV4dChzZXNzaW9uLCBwcm9tcHQudGV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCByZXN1bHRzLCBuZXh0KSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdDtcbiAgICAgICAgICAgIGlmIChyZXN1bHRzLnJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgLy8gc29tZSBwcm9tcHRpbmdcbiAgICAgICAgICAgICAgICBBbmFseXplLnNldFByb21wdChzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0LCBzZXNzaW9uLmRpYWxvZ0RhdGEucHJvbXB0LCByZXN1bHRzLnJlc3BvbnNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChBbmFseXplLmlzQ29tcGxldGUoc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCkpIHtcbiAgICAgICAgICAgICAgICB2YXIgZXhlYyA9IEV4ZWNTZXJ2ZXIuZXhlY1Rvb2woc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCwgdGhlTW9kZWwucmVjb3Jkcyk7XG4gICAgICAgICAgICAgICAgdmFyIHJlcGx5ID0gbmV3IGJ1aWxkZXIuTWVzc2FnZShzZXNzaW9uKVxuICAgICAgICAgICAgICAgICAgICAudGV4dChleGVjLnRleHQpXG4gICAgICAgICAgICAgICAgICAgIC5hZGRFbnRpdHkoZXhlYy5hY3Rpb24pO1xuICAgICAgICAgICAgICAgIC8vIC5hZGRBdHRhY2htZW50KHsgZmFsbGJhY2tUZXh0OiBcIkkgZG9uJ3Qga25vd1wiLCBjb250ZW50VHlwZTogJ2ltYWdlL2pwZWcnLCBjb250ZW50VXJsOiBcInd3dy53b21iYXQub3JnXCIgfSk7XG4gICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiU2hvd01lXCIsIHNlc3Npb24sIHNlbmQocmVwbHkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChzZXNzaW9uLmRpYWxvZ0RhdGEucmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZ2xvZyhcIlNob3dNZVwiLCBzZXNzaW9uLCBzZW5kKFwiTm90IGVub3VnaCBpbmZvcm1hdGlvbiBzdXBwbGllZDogXCIgKyBNYXRjaC5Ub29sTWF0Y2guZHVtcE5pY2Uoc2Vzc2lvbi5kaWFsb2dEYXRhLnJlc3VsdCkpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZ2xvZyhcIlNob3dNZVwiLCBzZXNzaW9uLCBzZW5kKFwiSSBkaWQgbm90IGdldCB3aGF0IHlvdSB3YW50XCIpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgXSk7XG4gICAgZGlhbG9nLm1hdGNoZXMoJ1doYXRJcycsIFtcbiAgICAgICAgZnVuY3Rpb24gKHNlc3Npb24sIGFyZ3MsIG5leHQpIHtcbiAgICAgICAgICAgIHZhciBpc0NvbWJpbmVkSW5kZXggPSB7fTtcbiAgICAgICAgICAgIHZhciBvTmV3RW50aXR5O1xuICAgICAgICAgICAgLy8gZXhwZWN0aW5nIGVudGl0eSBBMVxuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBzZXNzaW9uLm1lc3NhZ2UudGV4dDtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiV2hhdElzIEVudGl0aWVzXCIpO1xuICAgICAgICAgICAgZGVidWdsb2coJ3JhdzogJyArIEpTT04uc3RyaW5naWZ5KGFyZ3MuZW50aXRpZXMpLCB1bmRlZmluZWQsIDIpO1xuICAgICAgICAgICAgdmFyIGNhdGVnb3J5RW50aXR5ID0gYnVpbGRlci5FbnRpdHlSZWNvZ25pemVyLmZpbmRFbnRpdHkoYXJncy5lbnRpdGllcywgJ2NhdGVnb3J5Jyk7XG4gICAgICAgICAgICB2YXIgY2F0ZWdvcnkgPSBjYXRlZ29yeUVudGl0eS5lbnRpdHk7XG4gICAgICAgICAgICB2YXIgYTEgPSBidWlsZGVyLkVudGl0eVJlY29nbml6ZXIuZmluZEVudGl0eShhcmdzLmVudGl0aWVzLCAnQTEnKTtcbiAgICAgICAgICAgIHZhciBjYXQgPSBXaGF0SXMuYW5hbHl6ZUNhdGVnb3J5KGNhdGVnb3J5LCB0aGVNb2RlbC5tUnVsZXMsIG1lc3NhZ2UpO1xuICAgICAgICAgICAgaWYgKCFjYXQpIHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uLnNlbmQoJ0kgZG9uXFwndCBrbm93IGFueXRoaW5nIGFib3V0IFwiJyArIGNhdGVnb3J5ICsgJ1wiJyk7XG4gICAgICAgICAgICAgICAgLy8gbmV4dCgpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlYnVnbG9nKCdjYXRlZ29yeSBpZGVudGlmaWVkOicgKyBjYXQpO1xuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFdoYXRJcy5yZXNvbHZlQ2F0ZWdvcnkoY2F0LCBhMS5lbnRpdHksIHRoZU1vZGVsLm1SdWxlcywgdGhlTW9kZWwucmVjb3Jkcyk7XG4gICAgICAgICAgICBkZWJ1Z2xvZygnd2hhdGlzIHJlc3VsdDonICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0KSk7XG4gICAgICAgICAgICBsb2dRdWVyeVdoYXRJcyhzZXNzaW9uLCAnV2hhdElzJywgcmVzdWx0KTtcbiAgICAgICAgICAgIHZhciBpbmRpcyA9IFdoYXRJcy5pc0luZGlzY3JpbWluYXRlUmVzdWx0KHJlc3VsdCk7XG4gICAgICAgICAgICBpZiAoaW5kaXMpIHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uLnNlbmQoaW5kaXMpO1xuICAgICAgICAgICAgICAgIC8vIG5leHQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXJlc3VsdCB8fCByZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiV2hhdElzXCIsIHNlc3Npb24sIHNlbmQoJ0kgZG9uXFwndCBrbm93IGFueXRoaW5nIGFib3V0IFwiJyArIGNhdCArIFwiIChcIiArIGNhdGVnb3J5ICsgJylcXFwiIGluIHJlbGF0aW9uIHRvIFwiJyArIGExLmVudGl0eSArICdcIicpKTtcbiAgICAgICAgICAgICAgICAvLyBuZXh0KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gZGVidWdsb2coJ3Jlc3VsdCA6ICcgKyBKU09OLnN0cmluZ2lmeShyZXN1bHQsIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICAgICAgICAgIGRlYnVnbG9nKCdiZXN0IHJlc3VsdCA6ICcgKyBKU09OLnN0cmluZ2lmeShyZXN1bHRbMF0gfHwge30sIHVuZGVmaW5lZCwgMikpO1xuICAgICAgICAgICAgICAgIGRlYnVnbG9nKCd0b3AgOiAnICsgV2hhdElzLmR1bXBXZWlnaHRzVG9wKHJlc3VsdCwgeyB0b3A6IDMgfSkpO1xuICAgICAgICAgICAgICAgIC8vIFRPRE8gY2xlYW5zZWQgc2VudGVuY2VcbiAgICAgICAgICAgICAgICBkaWFsb2dsb2coXCJXaGF0SXNcIiwgc2Vzc2lvbiwgc2VuZCgnVGhlICcgKyBjYXRlZ29yeSArICcgb2YgJyArIGExLmVudGl0eSArICcgaXMgJyArIHJlc3VsdFswXS5yZXN1bHQgKyBcIlxcblwiKSk7IC8vICArIEpTT04uc3RyaW5naWZ5KHJlc3VsdFswXSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgXSk7XG4gICAgZGlhbG9nLm1hdGNoZXMoJ0xpc3RBbGwnLCBbXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCBhcmdzLCBuZXh0KSB7XG4gICAgICAgICAgICB2YXIgaXNDb21iaW5lZEluZGV4ID0ge307XG4gICAgICAgICAgICB2YXIgb05ld0VudGl0eTtcbiAgICAgICAgICAgIC8vIGV4cGVjdGluZyBlbnRpdHkgQTFcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gc2Vzc2lvbi5tZXNzYWdlLnRleHQ7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIkludGVudCA6IExpc3RBbGxcIik7XG4gICAgICAgICAgICBkZWJ1Z2xvZygncmF3OiAnICsgSlNPTi5zdHJpbmdpZnkoYXJncy5lbnRpdGllcyksIHVuZGVmaW5lZCwgMik7XG4gICAgICAgICAgICB2YXIgY2F0ZWdvcnlFbnRpdHkgPSBidWlsZGVyLkVudGl0eVJlY29nbml6ZXIuZmluZEVudGl0eShhcmdzLmVudGl0aWVzLCAnY2F0ZWdvcmllcycpO1xuICAgICAgICAgICAgdmFyIGNhdGVnb3J5ID0gY2F0ZWdvcnlFbnRpdHkuZW50aXR5O1xuICAgICAgICAgICAgdmFyIGExID0gYnVpbGRlci5FbnRpdHlSZWNvZ25pemVyLmZpbmRFbnRpdHkoYXJncy5lbnRpdGllcywgJ2luc3RoJyk7XG4gICAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09IFwiY2F0ZWdvcmllc1wiKSB7XG4gICAgICAgICAgICAgICAgLy8gZG8gd2UgaGF2ZSBhIGZpbHRlciA/XG4gICAgICAgICAgICAgICAgdmFyIGRvbWFpbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBpZiAoYTEgJiYgYTEuZW50aXR5KSB7XG4gICAgICAgICAgICAgICAgICAgIGRvbWFpbiA9IExpc3RBbGwuaW5mZXJEb21haW4odGhlTW9kZWwsIGExLmVudGl0eSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghZG9tYWluKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSByZXN0cmljdExvZ2dlZE9uKHNlc3Npb24sIHRoZU1vZGVsLmNhdGVnb3J5KS5qb2luKFwiO1xcblwiKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGExICYmIGExLmVudGl0eSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiTGlzdEFsbFwiLCBzZXNzaW9uLCBzZW5kKFwiSSBkaWQgbm90IGluZmVyIGEgZG9tYWluIHJlc3RyaWN0aW9uIGZyb20gXFxcIlwiICsgYTEuZW50aXR5ICsgXCJcXFwiLCBhbGwgbXkgY2F0ZWdvcmllcyBhcmUgLi4uXFxuXCIgKyByZXMpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZ2xvZyhcIkxpc3RBbGxcIiwgc2Vzc2lvbiwgc2VuZChcIm15IGNhdGVnb3JpZXMgYXJlIC4uLlxcblwiICsgcmVzKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFSZXMgPSBNb2RlbC5nZXRDYXRlZ29yaWVzRm9yRG9tYWluKHRoZU1vZGVsLCBkb21haW4pO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmVzID0gcmVzdHJpY3RMb2dnZWRPbihzZXNzaW9uLCBhUmVzKS5qb2luKFwiO1xcblwiKTtcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiTGlzdEFsbFwiLCBzZXNzaW9uLCBzZW5kKFwibXkgY2F0ZWdvcmllcyBpbiBkb21haW4gXFxcIlwiICsgZG9tYWluICsgXCJcXFwiIGFyZSAuLi5cXG5cIiArIHJlcykpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNhdGVnb3J5ID09PSBcImRvbWFpbnNcIikge1xuICAgICAgICAgICAgICAgIHZhciByZXMgPSByZXN0cmljdExvZ2dlZE9uKHNlc3Npb24sIHRoZU1vZGVsLmRvbWFpbnMpLmpvaW4oXCI7XFxuXCIpO1xuICAgICAgICAgICAgICAgIHNlc3Npb24uc2VuZChcIm15IGRvbWFpbnMgYXJlIC4uLlxcblwiICsgcmVzKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09IFwidG9vbHNcIikge1xuICAgICAgICAgICAgICAgIHZhciByZXMgPSByZXN0cmljdExvZ2dlZE9uKHNlc3Npb24sIHRoZU1vZGVsLnRvb2xzKS5tYXAoZnVuY3Rpb24gKG9Ub29sKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvVG9vbC5uYW1lO1xuICAgICAgICAgICAgICAgIH0pLmpvaW4oXCI7XFxuXCIpO1xuICAgICAgICAgICAgICAgIGRpYWxvZ2xvZyhcIkxpc3RBbGxcIiwgc2Vzc2lvbiwgc2VuZChcIm15IHRvb2xzIGFyZSAuLi5cXG5cIiArIHJlcykpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBjYXQgPSBXaGF0SXMuYW5hbHl6ZUNhdGVnb3J5KGNhdGVnb3J5LCB0aGVNb2RlbC5tUnVsZXMsIG1lc3NhZ2UpO1xuICAgICAgICAgICAgaWYgKCFjYXQpIHtcbiAgICAgICAgICAgICAgICBkaWFsb2dsb2coXCJMaXN0QWxsXCIsIHNlc3Npb24sIHNlbmQoJ0kgZG9uXFwndCBrbm93IGFueXRoaW5nIGFib3V0IFwiJyArIGNhdGVnb3J5ICsgJ1wiJykpO1xuICAgICAgICAgICAgICAgIC8vIG5leHQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWJ1Z2xvZygnY2F0ZWdvcnkgaWRlbnRpZmllZDonICsgY2F0KTtcbiAgICAgICAgICAgIGlmIChhMSAmJiBhMS5lbnRpdHkpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZygnZ290IGZpbHRlcjonICsgYTEuZW50aXR5KTtcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0MSA9IExpc3RBbGwubGlzdEFsbFdpdGhDb250ZXh0KGNhdCwgYTEuZW50aXR5LCB0aGVNb2RlbC5tUnVsZXMsIHRoZU1vZGVsLnJlY29yZHMpO1xuICAgICAgICAgICAgICAgIC8vIFRPRE8gY2xhc3NpZnlpbmcgdGhlIHN0cmluZyB0d2ljZSBpcyBhIHRlcnJpYmxlIHdhc3RlXG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQxLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBkZWJ1Z2xvZygnZ29pbmcgZm9yIGhhdmluZycpO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQxID0gTGlzdEFsbC5saXN0QWxsSGF2aW5nQ29udGV4dChjYXQsIGExLmVudGl0eSwgdGhlTW9kZWwubVJ1bGVzLCB0aGVNb2RlbC5yZWNvcmRzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZGVidWdsb2coJ2xpc3RhbGwgcmVzdWx0OicgKyBKU09OLnN0cmluZ2lmeShyZXN1bHQxKSk7XG4gICAgICAgICAgICAgICAgdmFyIGpvaW5yZXN1bHRzID0gcmVzdHJpY3RMb2dnZWRPbihzZXNzaW9uLCBMaXN0QWxsLmpvaW5SZXN1bHRzKHJlc3VsdDEpKTtcbiAgICAgICAgICAgICAgICBsb2dRdWVyeVdoYXRJcyhzZXNzaW9uLCAnTGlzdEFsbCcsIHJlc3VsdDEpO1xuICAgICAgICAgICAgICAgIGlmIChqb2lucmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiTGlzdEFsbFwiLCBzZXNzaW9uLCBzZW5kKFwidGhlIFwiICsgY2F0ZWdvcnkgKyBcIiBmb3IgXCIgKyBhMS5lbnRpdHkgKyBcIiBhcmUgLi4uXFxuXCIgKyBqb2lucmVzdWx0cy5qb2luKFwiO1xcblwiKSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiTGlzdEFsbFwiLCBzZXNzaW9uLCBzZW5kKFwiaSBkaWQgbm90IGZpbmQgYW55IFwiICsgY2F0ZWdvcnkgKyBcIiBmb3IgXCIgKyBhMS5lbnRpdHkgKyBcIi5cXG5cIiArIGpvaW5yZXN1bHRzLmpvaW4oXCI7XFxuXCIpKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIG5vIGVudGl0eSwgZS5nLiBsaXN0IGFsbCBjb3VudHJpZXNcbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBMaXN0QWxsLmxpc3RBbGxIYXZpbmdDb250ZXh0KGNhdCwgY2F0LCB0aGVNb2RlbC5tUnVsZXMsIHRoZU1vZGVsLnJlY29yZHMpO1xuICAgICAgICAgICAgICAgIGxvZ1F1ZXJ5V2hhdElzKHNlc3Npb24sICdMaXN0QWxsJywgcmVzdWx0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBkZWJ1Z2xvZygnbGlzdGFsbCByZXN1bHQ6JyArIEpTT04uc3RyaW5naWZ5KHJlc3VsdCkpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgam9pbnJlc3VsdHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coXCJoZXJlIGlzIGNhdD5cIiArIGNhdCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjYXQgIT09IFwiZXhhbXBsZSBxdWVzdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBqb2lucmVzdWx0cyA9IHJlc3RyaWN0TG9nZ2VkT24oc2Vzc2lvbiwgTGlzdEFsbC5qb2luUmVzdWx0cyhyZXN1bHQpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpvaW5yZXN1bHRzID0gTGlzdEFsbC5qb2luUmVzdWx0cyhyZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZSA9IFwidGhlIFwiICsgY2F0ZWdvcnkgKyBcIiBhcmUgLi4uXFxuXCIgKyBqb2lucmVzdWx0cy5qb2luKFwiO1xcblwiKTtcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiTGlzdEFsbFwiLCBzZXNzaW9uLCBzZW5kKHJlc3BvbnNlKSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZSA9IFwiRm91bmQgbm8gZGF0YSBoYXZpbmcgXFxcIlwiICsgY2F0ICsgXCJcXFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZ2xvZyhcIkxpc3RBbGxcIiwgc2Vzc2lvbiwgc2VuZChyZXNwb25zZSkpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgXSk7XG4gICAgZGlhbG9nLm1hdGNoZXMoJ1RyYWluTWUnLCBbXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCBhcmdzLCBuZXh0KSB7XG4gICAgICAgICAgICB2YXIgaXNDb21iaW5lZEluZGV4ID0ge307XG4gICAgICAgICAgICB2YXIgb05ld0VudGl0eTtcbiAgICAgICAgICAgIC8vIGV4cGVjdGluZyBlbnRpdHkgQTFcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gc2Vzc2lvbi5tZXNzYWdlLnRleHQ7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIkludGVudCA6IFRyYWluXCIpO1xuICAgICAgICAgICAgZGVidWdsb2coJ3JhdzogJyArIEpTT04uc3RyaW5naWZ5KGFyZ3MuZW50aXRpZXMpLCB1bmRlZmluZWQsIDIpO1xuICAgICAgICAgICAgdmFyIGNhdGVnb3J5RW50aXR5ID0gYnVpbGRlci5FbnRpdHlSZWNvZ25pemVyLmZpbmRFbnRpdHkoYXJncy5lbnRpdGllcywgJ2NhdGVnb3JpZXMnKTtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihcImtyb25vc1wiKSA+PSAwIHx8IG1lc3NhZ2UudG9Mb3dlckNhc2UoKS5pbmRleE9mKFwia2xpbmdvblwiKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgZGlhbG9nbG9nKFwiVHJhaW5NZVwiLCBzZXNzaW9uLCBzZW5kKGdldFJhbmRvbVJlc3VsdChhVHJhaW5Ob0tsaW5nb24pKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHJlcyA9IGdldFJhbmRvbVJlc3VsdChhVHJhaW5SZXBsaWVzKTtcbiAgICAgICAgICAgIGRpYWxvZ2xvZyhcIlRyYWluTWVcIiwgc2Vzc2lvbiwgc2VuZChyZXMpKTtcbiAgICAgICAgfVxuICAgIF0pO1xuICAgIGRpYWxvZy5tYXRjaGVzKCdXcm9uZycsIFtcbiAgICAgICAgZnVuY3Rpb24gKHNlc3Npb24sIGFyZ3MsIG5leHQpIHtcbiAgICAgICAgICAgIGRpYWxvZ0xvZ2dlcih7XG4gICAgICAgICAgICAgICAgc2Vzc2lvbjogc2Vzc2lvbixcbiAgICAgICAgICAgICAgICBpbnRlbnQ6IFwiV3JvbmdcIixcbiAgICAgICAgICAgICAgICByZXNwb25zZTogJzxiZWdpbiB1cGRvd24+J1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBzZXNzaW9uLmJlZ2luRGlhbG9nKCcvdXBkb3duJywgc2Vzc2lvbi51c2VyRGF0YS5jb3VudCk7XG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCByZXN1bHRzLCBuZXh0KSB7XG4gICAgICAgICAgICB2YXIgYWxhcm0gPSBzZXNzaW9uLmRpYWxvZ0RhdGEuYWxhcm07XG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCByZXN1bHRzKSB7XG4gICAgICAgICAgICBzZXNzaW9uLnNlbmQoZ2V0UmFuZG9tUmVzdWx0KGFCYWNrRnJvbVRyYWluaW5nKSk7IC8vICArIEpTT04uc3RyaW5naWZ5KHJlc3VsdHMpKTtcbiAgICAgICAgICAgIC8vc2Vzc2lvbi5zZW5kKCdlbmQgb2Ygd3JvbmcnKTtcbiAgICAgICAgfVxuICAgIF0pO1xuICAgIGRpYWxvZy5tYXRjaGVzKCdFeGl0JywgW1xuICAgICAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgYXJncywgbmV4dCkge1xuICAgICAgICAgICAgZGVidWdsb2coJ2V4aXQgOicpO1xuICAgICAgICAgICAgZGVidWdsb2coJ2V4aXQnICsgSlNPTi5zdHJpbmdpZnkoYXJncy5lbnRpdGllcykpO1xuICAgICAgICAgICAgZGlhbG9nTG9nZ2VyKHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBzZXNzaW9uLFxuICAgICAgICAgICAgICAgIGludGVudDogXCJFeGl0XCIsXG4gICAgICAgICAgICAgICAgcmVzcG9uc2U6ICd5b3UgYXJlIGluIGEgbG9naWMgbG9vcCdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgc2Vzc2lvbi5zZW5kKFwieW91IGFyZSBpbiBhIGxvZ2ljIGxvb3AgXCIpO1xuICAgICAgICB9XG4gICAgXSk7XG4gICAgZGlhbG9nLm1hdGNoZXMoJ0hlbHAnLCBbXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCBhcmdzLCBuZXh0KSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZygnaGVscCA6Jyk7XG4gICAgICAgICAgICBkZWJ1Z2xvZygnaGVscCcpO1xuICAgICAgICAgICAgc2Vzc2lvbi5zZW5kKFwiSSBrbm93IGFib3V0IC4uLi4gPGNhdGVnb3JpZXM+PlwiKTtcbiAgICAgICAgfVxuICAgIF0pO1xuICAgIC8vIEFkZCBpbnRlbnQgaGFuZGxlcnNcbiAgICBkaWFsb2cubWF0Y2hlcygndHJhaW4nLCBbXG4gICAgICAgIGZ1bmN0aW9uIChzZXNzaW9uLCBhcmdzLCBuZXh0KSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZygndHJhaW4nKTtcbiAgICAgICAgICAgIC8vIFJlc29sdmUgYW5kIHN0b3JlIGFueSBlbnRpdGllcyBwYXNzZWQgZnJvbSBMVUlTLlxuICAgICAgICAgICAgdmFyIHRpdGxlID0gYnVpbGRlci5FbnRpdHlSZWNvZ25pemVyLmZpbmRFbnRpdHkoYXJncy5lbnRpdGllcywgJ2J1aWx0aW4uYWxhcm0udGl0bGUnKTtcbiAgICAgICAgICAgIHZhciB0aW1lID0gYnVpbGRlci5FbnRpdHlSZWNvZ25pemVyLnJlc29sdmVUaW1lKGFyZ3MuZW50aXRpZXMpO1xuICAgICAgICAgICAgdmFyIGFsYXJtID0gc2Vzc2lvbi5kaWFsb2dEYXRhLmFsYXJtID0ge1xuICAgICAgICAgICAgICAgIHRpdGxlOiB0aXRsZSA/IHRpdGxlLmVudGl0eSA6IG51bGwsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiB0aW1lID8gdGltZS5nZXRUaW1lKCkgOiBudWxsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gUHJvbXB0IGZvciB0aXRsZVxuICAgICAgICAgICAgaWYgKCFhbGFybS50aXRsZSkge1xuICAgICAgICAgICAgICAgIGRpYWxvZ0xvZ2dlcih7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb246IHNlc3Npb24sXG4gICAgICAgICAgICAgICAgICAgIGludGVudDogXCJ0cmFpblwiLFxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZTogJ1doYXQgZmFjdCB3b3VsZCB5b3UgbGlrZSB0byB0cmFpbj8nXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYnVpbGRlci5Qcm9tcHRzLnRleHQoc2Vzc2lvbiwgJ1doYXQgZmFjdCB3b3VsZCB5b3UgbGlrZSB0byB0cmFpbj8nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZnVuY3Rpb24gKHNlc3Npb24sIHJlc3VsdHMsIG5leHQpIHtcbiAgICAgICAgICAgIHZhciBhbGFybSA9IHNlc3Npb24uZGlhbG9nRGF0YS5hbGFybTtcbiAgICAgICAgICAgIGlmIChyZXN1bHRzLnJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgYWxhcm0udGl0bGUgPSByZXN1bHRzLnJlc3BvbnNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gUHJvbXB0IGZvciB0aW1lICh0aXRsZSB3aWxsIGJlIGJsYW5rIGlmIHRoZSB1c2VyIHNhaWQgY2FuY2VsKVxuICAgICAgICAgICAgaWYgKGFsYXJtLnRpdGxlICYmICFhbGFybS50aW1lc3RhbXApIHtcbiAgICAgICAgICAgICAgICBidWlsZGVyLlByb21wdHMudGltZShzZXNzaW9uLCAnV2hhdCB0aW1lIHdvdWxkIHlvdSBsaWtlIHRvIHNldCB0aGUgYWxhcm0gZm9yPycpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBmdW5jdGlvbiAoc2Vzc2lvbiwgcmVzdWx0cykge1xuICAgICAgICAgICAgdmFyIGFsYXJtID0gc2Vzc2lvbi5kaWFsb2dEYXRhLmFsYXJtO1xuICAgICAgICAgICAgaWYgKHJlc3VsdHMucmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgdGltZSA9IGJ1aWxkZXIuRW50aXR5UmVjb2duaXplci5yZXNvbHZlVGltZShbcmVzdWx0cy5yZXNwb25zZV0pO1xuICAgICAgICAgICAgICAgIGFsYXJtLnRpbWVzdGFtcCA9IHRpbWUgPyB0aW1lLmdldFRpbWUoKSA6IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBTZXQgdGhlIGFsYXJtIChpZiB0aXRsZSBvciB0aW1lc3RhbXAgaXMgYmxhbmsgdGhlIHVzZXIgc2FpZCBjYW5jZWwpXG4gICAgICAgICAgICBpZiAoYWxhcm0udGl0bGUgJiYgYWxhcm0udGltZXN0YW1wKSB7XG4gICAgICAgICAgICAgICAgLy8gU2F2ZSBhZGRyZXNzIG9mIHdobyB0byBub3RpZnkgYW5kIHdyaXRlIHRvIHNjaGVkdWxlci5cbiAgICAgICAgICAgICAgICBhbGFybS5hZGRyZXNzID0gc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3M7XG4gICAgICAgICAgICAgICAgLy9hbGFybXNbYWxhcm0udGl0bGVdID0gYWxhcm07XG4gICAgICAgICAgICAgICAgLy8gU2VuZCBjb25maXJtYXRpb24gdG8gdXNlclxuICAgICAgICAgICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoYWxhcm0udGltZXN0YW1wKTtcbiAgICAgICAgICAgICAgICB2YXIgaXNBTSA9IGRhdGUuZ2V0SG91cnMoKSA8IDEyO1xuICAgICAgICAgICAgICAgIHNlc3Npb24uc2VuZCgnQ3JlYXRpbmcgYWxhcm0gbmFtZWQgXCIlc1wiIGZvciAlZC8lZC8lZCAlZDolMDJkJXMnLCBhbGFybS50aXRsZSwgZGF0ZS5nZXRNb250aCgpICsgMSwgZGF0ZS5nZXREYXRlKCksIGRhdGUuZ2V0RnVsbFllYXIoKSwgaXNBTSA/IGRhdGUuZ2V0SG91cnMoKSA6IGRhdGUuZ2V0SG91cnMoKSAtIDEyLCBkYXRlLmdldE1pbnV0ZXMoKSwgaXNBTSA/ICdhbScgOiAncG0nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHNlc3Npb24uc2VuZCgnT2suLi4gbm8gcHJvYmxlbS4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIF0pO1xuICAgIGRpYWxvZy5vbkRlZmF1bHQoZnVuY3Rpb24gKHNlc3Npb24pIHtcbiAgICAgICAgbG9nUXVlcnkoc2Vzc2lvbiwgXCJvbkRlZmF1bHRcIik7XG4gICAgICAgIHZhciBlbGl6YSA9IGdldEVsaXphQm90KGdldENvbnZlcnNhdGlvbklkKHNlc3Npb24pKTtcbiAgICAgICAgdmFyIHJlcGx5ID0gZWxpemEudHJhbnNmb3JtKHNlc3Npb24ubWVzc2FnZS50ZXh0KTtcbiAgICAgICAgZGlhbG9nbG9nKFwiZWxpemFcIiwgc2Vzc2lvbiwgc2VuZChyZXBseSkpO1xuICAgICAgICAvL25ldyBFaWx6YWJvdFxuICAgICAgICAvL3Nlc3Npb24uc2VuZChcIkkgZG8gbm90IHVuZGVyc3RhbmQgdGhpcyBhdCBhbGxcIik7XG4gICAgICAgIC8vYnVpbGRlci5EaWFsb2dBY3Rpb24uc2VuZCgnSVxcJ20gc29ycnkgSSBkaWRuXFwndCB1bmRlcnN0YW5kLiBJIGNhbiBvbmx5IHNob3cgc3RhcnQgYW5kIHJpbmcnKTtcbiAgICB9KTtcbiAgICAvKlxuICAgIC8vIFZlcnkgc2ltcGxlIGFsYXJtIHNjaGVkdWxlclxuICAgIHZhciBhbGFybXMgPSB7fTtcbiAgICBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7XG4gICAgICB2YXIgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICBmb3IgKHZhciBrZXkgaW4gYWxhcm1zKSB7XG4gICAgICAgIHZhciBhbGFybSA9IGFsYXJtc1trZXldO1xuICAgICAgICBpZiAobm93ID49IGFsYXJtLnRpbWVzdGFtcCkge1xuICAgICAgICAgIHZhciBtc2cgPSBuZXcgYnVpbGRlci5NZXNzYWdlKClcbiAgICAgICAgICAgIC5hZGRyZXNzKGFsYXJtLmFkZHJlc3MpXG4gICAgICAgICAgICAudGV4dCgnSGVyZVxcJ3MgeW91ciBcXCclc1xcJyBhbGFybS4nLCBhbGFybS50aXRsZSk7XG4gICAgICAgICAgYm90LnNlbmQobXNnKTtcbiAgICAgICAgICBkZWxldGUgYWxhcm1zW2tleV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LCAxNTAwMCk7XG4gICAgKi9cbn1cbmlmIChtb2R1bGUpIHtcbiAgICBtb2R1bGUuZXhwb3J0cyA9IHtcbiAgICAgICAgbWFrZUJvdDogbWFrZUJvdFxuICAgIH07XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
