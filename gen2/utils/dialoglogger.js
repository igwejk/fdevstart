/**
 * a logger for dialog conversations
 */
//declare module pg {};
"use strict";

var debug = require('debug');
var process = require('process');
exports.sqlActive = !!process.env.ABOT_LOGDB;
var debuglog = debug('dialoglogger');
;
;
var columns = ["botid", "userid", "message", "response", "action", "intent", "conversationid", "meta", "delta"];
// 0 indicates do not process /truncate, e.g. non string type
var columnLengths = [10, 40, 1024, 1024, 512, 20, 40, 0, 0];
function assureColumnLengthNotExceeded(obj) {
    columns.forEach(function (sCol, iIndex) {
        if (obj[sCol] && columnLengths[iIndex] && obj[sCol].length > columnLengths[iIndex]) {
            obj[sCol] = obj[sCol].substring(0, columnLengths[iIndex]);
        }
    });
    return obj;
}
exports.assureColumnLengthNotExceeded = assureColumnLengthNotExceeded;
function logAnswer(answer, callback) {
    "use strict";

    callback = callback || function () {};
    var session = answer.session;
    var pg = this.pg;
    var oLogEntry = {
        botid: this.name,
        userid: session.message.address && session.message.address.user && session.message.address.user.id || "",
        message: session.message.text,
        response: answer.response,
        action: answer.action,
        intent: answer.intent,
        conversationid: session.message.address && session.message.address.conversation && session.message.address.conversation.id || "",
        meta: answer.result || {},
        delta: Date.now() - Date.parse(session.message.timestamp)
    };
    oLogEntry = assureColumnLengthNotExceeded(oLogEntry);
    if (!exports.sqlActive) {
        return;
    }
    pg.connect(this.dburl, function (err, client, pgDone) {
        if (err) {
            // failed to acquire connection
            //logger.emit('error', err);
            debuglog('Error connecting to db' + err);
            callback(err);
        } else {
            var query = "INSERT INTO logconv (" + columns.join(",") + ") " +
            //   (convid, sessionid, user, message, response, meta) ` +
            "VALUES ( " +
            // $1, $2, ...
            columns.map(function (o, iIndex) {
                return "$" + (iIndex + 1);
            }).join(", ") + ")";
            var values = columns.map(function (sCol) {
                return oLogEntry[sCol];
            });
            //  [level, msg, meta instanceof Array ? JSON.stringify(meta) : meta],
            client.query(query, values, function (err, result) {
                pgDone();
                if (err) {
                    // logger.emit('error', err);
                    debuglog('Error inserting record into db ' + err);
                    callback(err);
                } else {
                    //  logger.emit('logged');
                    callback(null, true);
                }
            });
        }
    });
}
exports.logAnswer = logAnswer;
var loggers = {};
function logger(name, dburl, pg) {
    if (!dburl) {
        throw new Error('need database url');
    }
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            dburl: dburl,
            pg: pg
        };
        alogger.logIt = logAnswer.bind(alogger);
        loggers[name] = alogger;
    }
    if (loggers[name].dburl !== dburl) {
        throw new Error('Flags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9kaWFsb2dsb2dnZXIudHMiLCJ1dGlscy9kaWFsb2dsb2dnZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwicHJvY2VzcyIsImV4cG9ydHMiLCJzcWxBY3RpdmUiLCJlbnYiLCJBQk9UX0xPR0RCIiwiZGVidWdsb2ciLCJjb2x1bW5zIiwiY29sdW1uTGVuZ3RocyIsImFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkIiwib2JqIiwiZm9yRWFjaCIsInNDb2wiLCJpSW5kZXgiLCJsZW5ndGgiLCJzdWJzdHJpbmciLCJsb2dBbnN3ZXIiLCJhbnN3ZXIiLCJjYWxsYmFjayIsInNlc3Npb24iLCJwZyIsIm9Mb2dFbnRyeSIsImJvdGlkIiwibmFtZSIsInVzZXJpZCIsIm1lc3NhZ2UiLCJhZGRyZXNzIiwidXNlciIsImlkIiwidGV4dCIsInJlc3BvbnNlIiwiYWN0aW9uIiwiaW50ZW50IiwiY29udmVyc2F0aW9uaWQiLCJjb252ZXJzYXRpb24iLCJtZXRhIiwicmVzdWx0IiwiZGVsdGEiLCJEYXRlIiwibm93IiwicGFyc2UiLCJ0aW1lc3RhbXAiLCJjb25uZWN0IiwiZGJ1cmwiLCJlcnIiLCJjbGllbnQiLCJwZ0RvbmUiLCJxdWVyeSIsImpvaW4iLCJtYXAiLCJvIiwidmFsdWVzIiwibG9nZ2VycyIsImxvZ2dlciIsIkVycm9yIiwiZXhlYyIsImFsb2dnZXIiLCJsb2dJdCIsImJpbmQiXSwibWFwcGluZ3MiOiJBQUFBOzs7QUFHQTtBQ0NBOztBREdBLElBQVlBLFFBQUtDLFFBQU0sT0FBTixDQUFqQjtBQUNBLElBQVlDLFVBQU9ELFFBQU0sU0FBTixDQUFuQjtBQUdXRSxRQUFBQyxTQUFBLEdBQVksQ0FBQyxDQUFFRixRQUFRRyxHQUFSLENBQVlDLFVBQTNCO0FBRVgsSUFBTUMsV0FBV1AsTUFBTSxjQUFOLENBQWpCO0FBT0M7QUFlQTtBQVVELElBQU1RLFVBQVUsQ0FBQyxPQUFELEVBQVMsUUFBVCxFQUFtQixTQUFuQixF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SVcsS0FBSixDQUFVLDZCQUE2Qi9CLElBQXZDLENBQU47QUFDRDtBQUNELFdBQU82QixRQUFRN0IsSUFBUixFQUFja0MsS0FBckI7QUFDRDtBQXBCZXZELFFBQUFtRCxNQUFBLEdBQU1BLE1BQU4iLCJmaWxlIjoidXRpbHMvZGlhbG9nbG9nZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBhIGxvZ2dlciBmb3IgZGlhbG9nIGNvbnZlcnNhdGlvbnNcbiAqL1xuLy9kZWNsYXJlIG1vZHVsZSBwZyB7fTtcblxuaW1wb3J0ICogYXMgYnVpbGRlciBmcm9tICdib3RidWlsZGVyJztcbmltcG9ydCAqIGFzIHBnIGZyb20gJ3BnJztcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XG5cblxuZXhwb3J0IHZhciBzcWxBY3RpdmUgPSAhIShwcm9jZXNzLmVudi5BQk9UX0xPR0RCKTtcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnZGlhbG9nbG9nZ2VyJyk7XG5cbmludGVyZmFjZSBJTG9nZ2VyIHtcbiAgbmFtZTogc3RyaW5nLFxuICBkYnVybDogc3RyaW5nLFxuICBsb2dJdD86IChhIDogSUFuc3dlciwgY2FsbGJhY2sgOiAoZXJyIDogYW55LCByZXM/IDogYW55KSA9PiB2b2lkKSA9PiB2b2lkLFxuICBwZyA6IGFueVxufTtcblxuZXhwb3J0IGludGVyZmFjZSBJTG9nRW50cnkge1xuICBib3RpZCA6IHN0cmluZywgLyogMTAgKi9cbiAgdXNlcmlkIDogc3RyaW5nLFxuICBtZXNzYWdlIDogc3RyaW5nLFxuICByZXNwb25zZSA6IHN0cmluZyxcbiAgYWN0aW9uIDogc3RyaW5nLFxuICBpbnRlbnQgOiBzdHJpbmcsXG4gIGNvbnZlcnNhdGlvbmlkIDogc3RyaW5nLFxuICAvKipcbiAgICogYW4gcmVzdWx0XG4gICAqKi9cbiAgbWV0YSA6IGFueSxcbiAgZGVsdGE6IG51bWJlclxufTtcblxuZXhwb3J0IGludGVyZmFjZSBJQW5zd2VyIHtcbiAgc2Vzc2lvbiA6IGJ1aWxkZXIuU2Vzc2lvbixcbiAgaW50ZW50IDogc3RyaW5nLFxuICByZXNwb25zZSA6IHN0cmluZyxcbiAgYWN0aW9uPyA6IHN0cmluZyxcbiAgcmVzdWx0PyA6IGFueSxcbn1cblxuY29uc3QgY29sdW1ucyA9IFtcImJvdGlkXCIsXCJ1c2VyaWRcIiwgXCJtZXNzYWdlXCIsIFwicmVzcG9uc2VcIiwgXCJhY3Rpb25cIiwgXCJpbnRlbnRcIiwgXCJjb252ZXJzYXRpb25pZFwiLCBcIm1ldGFcIiwgXCJkZWx0YVwiXTtcbi8vIDAgaW5kaWNhdGVzIGRvIG5vdCBwcm9jZXNzIC90cnVuY2F0ZSwgZS5nLiBub24gc3RyaW5nIHR5cGVcbmNvbnN0IGNvbHVtbkxlbmd0aHMgPSBbMTAsIDQwLCAxMDI0LCAxMDI0LCA1MTIsIDIwLCA0MCwgMCwwIF07XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9iaiA6IElMb2dFbnRyeSkgOiBJTG9nRW50cnkge1xuICBjb2x1bW5zLmZvckVhY2goZnVuY3Rpb24oc0NvbCxpSW5kZXgpIHtcbiAgICBpZihvYmpbc0NvbF0gJiYgY29sdW1uTGVuZ3Roc1tpSW5kZXhdICYmIG9ialtzQ29sXS5sZW5ndGggPiBjb2x1bW5MZW5ndGhzW2lJbmRleF0pIHtcbiAgICAgIG9ialtzQ29sXSA9IG9ialtzQ29sXS5zdWJzdHJpbmcoMCxjb2x1bW5MZW5ndGhzW2lJbmRleF0pO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBvYmo7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dBbnN3ZXIoYW5zd2VyOiBJQW5zd2VyLCBjYWxsYmFjayA6IChlcnI6IGFueSwgcmVzPzogYW55KSA9PiB2b2lkICkge1xuICBcInVzZSBzdHJpY3RcIjtcbiAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCAoZnVuY3Rpb24oKSB7fSk7XG4gIHZhciBzZXNzaW9uID0gYW5zd2VyLnNlc3Npb247XG4gIHZhciBwZyA9IHRoaXMucGc7XG4gIHZhciBvTG9nRW50cnkgOiBJTG9nRW50cnkgPSB7XG4gICAgYm90aWQgOiB0aGlzLm5hbWUsXG4gICAgdXNlcmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXJcbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyLmlkIHx8IFwiXCIsXG4gICAgbWVzc2FnZTogc2Vzc2lvbi5tZXNzYWdlLnRleHQsXG4gICAgcmVzcG9uc2UgOiBhbnN3ZXIucmVzcG9uc2UsXG4gICAgYWN0aW9uIDogYW5zd2VyLmFjdGlvbixcblxuICAgIGludGVudDogYW5zd2VyLmludGVudCxcblxuICAgIGNvbnZlcnNhdGlvbmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvblxuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvbi5pZCB8fCBcIlwiLFxuXG4gICAgbWV0YSA6IGFuc3dlci5yZXN1bHQgfHwge30sXG5cbiAgICBkZWx0YSA6IERhdGUubm93KCkgLSBEYXRlLnBhcnNlKHNlc3Npb24ubWVzc2FnZS50aW1lc3RhbXApLFxuICB9O1xuXG4gIG9Mb2dFbnRyeSA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9Mb2dFbnRyeSk7XG4gIGlmICghc3FsQWN0aXZlKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHBnLmNvbm5lY3QodGhpcy5kYnVybCwgKGVyciwgY2xpZW50IDogcGcuQ2xpZW50LCBwZ0RvbmUpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgLy8gZmFpbGVkIHRvIGFjcXVpcmUgY29ubmVjdGlvblxuICAgICAgICAvL2xvZ2dlci5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgIGRlYnVnbG9nKCdFcnJvciBjb25uZWN0aW5nIHRvIGRiJyArIGVycik7XG4gICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgcXVlcnkgPWBJTlNFUlQgSU5UTyBsb2djb252IChgICsgY29sdW1ucy5qb2luKFwiLFwiKSArIFwiKSBcIiArXG4gICAgICAgIC8vICAgKGNvbnZpZCwgc2Vzc2lvbmlkLCB1c2VyLCBtZXNzYWdlLCByZXNwb25zZSwgbWV0YSkgYCArXG4gICAgICAgIFwiVkFMVUVTICggXCIgICtcbiAgICAgICAgLy8gJDEsICQyLCAuLi5cbiAgICAgICAgIGNvbHVtbnMubWFwKGZ1bmN0aW9uKG8saUluZGV4KSB7IHJldHVybiBcIiRcIiArIChpSW5kZXgrMSk7IH0pLmpvaW4oXCIsIFwiKSArIFwiKVwiO1xuXG4gICAgICAgIHZhciB2YWx1ZXMgPSBjb2x1bW5zLm1hcChmdW5jdGlvbihzQ29sKSB7XG4gICAgICAgICAgICAgcmV0dXJuIG9Mb2dFbnRyeVtzQ29sXTtcbiAgICAgICAgICAgfSk7XG4gICAgICAgICAgIC8vICBbbGV2ZWwsIG1zZywgbWV0YSBpbnN0YW5jZW9mIEFycmF5ID8gSlNPTi5zdHJpbmdpZnkobWV0YSkgOiBtZXRhXSxcblxuICAgICAgICBjbGllbnQucXVlcnkocXVlcnksdmFsdWVzLFxuXG4gICAgICAgICAgICAgICAgICAgICAoZXJyLCByZXN1bHQpID0+IHtcbiAgICAgICAgICAgIHBnRG9uZSgpO1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgIC8vIGxvZ2dlci5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgICAgICAgZGVidWdsb2coJ0Vycm9yIGluc2VydGluZyByZWNvcmQgaW50byBkYiAnICsgZXJyKTtcbiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyAgbG9nZ2VyLmVtaXQoJ2xvZ2dlZCcpO1xuICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxudmFyIGxvZ2dlcnMgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IElMb2dnZXIgfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxvZ2dlcihuYW1lOiBzdHJpbmcsIGRidXJsIDogc3RyaW5nLCBwZzogYW55KSA6IChhOiBJQW5zd2VyLCBjYWxsYmFjaz86IChlcnI6YW55LCByZXM/IDphbnkpID0+IHZvaWQpID0+IHZvaWQgIHtcbiAgaWYgKCFkYnVybCkge1xuICAgIHRocm93IG5ldyBFcnJvcignbmVlZCBkYXRhYmFzZSB1cmwnKTtcbiAgfVxuICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIgfHwgIS9eW0EtWmEtel1bQS1aYS16MC05X10rJC8uZXhlYyhuYW1lKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKVxuICB9XG4gIGlmICghbG9nZ2Vyc1tuYW1lXSkge1xuICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgbmFtZTogbmFtZSxcbiAgICAgIGRidXJsOiBkYnVybCxcbiAgICAgIHBnIDogcGdcbiAgICB9IGFzIElMb2dnZXI7XG4gICAgYWxvZ2dlci5sb2dJdCA9IGxvZ0Fuc3dlci5iaW5kKGFsb2dnZXIpO1xuICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICB9XG4gIGlmIChsb2dnZXJzW25hbWVdLmRidXJsICE9PSBkYnVybCkge1xuICAgIHRocm93IG5ldyBFcnJvcignRmxhZ3MgbWlzbWF0Y2ggaW4gbG9nZ2VyJyArIG5hbWUpO1xuICB9XG4gIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufSIsIi8qKlxuICogYSBsb2dnZXIgZm9yIGRpYWxvZyBjb252ZXJzYXRpb25zXG4gKi9cbi8vZGVjbGFyZSBtb2R1bGUgcGcge307XG5cInVzZSBzdHJpY3RcIjtcbnZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG52YXIgcHJvY2VzcyA9IHJlcXVpcmUoJ3Byb2Nlc3MnKTtcbmV4cG9ydHMuc3FsQWN0aXZlID0gISEocHJvY2Vzcy5lbnYuQUJPVF9MT0dEQik7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnZGlhbG9nbG9nZ2VyJyk7XG47XG47XG52YXIgY29sdW1ucyA9IFtcImJvdGlkXCIsIFwidXNlcmlkXCIsIFwibWVzc2FnZVwiLCBcInJlc3BvbnNlXCIsIFwiYWN0aW9uXCIsIFwiaW50ZW50XCIsIFwiY29udmVyc2F0aW9uaWRcIiwgXCJtZXRhXCIsIFwiZGVsdGFcIl07XG4vLyAwIGluZGljYXRlcyBkbyBub3QgcHJvY2VzcyAvdHJ1bmNhdGUsIGUuZy4gbm9uIHN0cmluZyB0eXBlXG52YXIgY29sdW1uTGVuZ3RocyA9IFsxMCwgNDAsIDEwMjQsIDEwMjQsIDUxMiwgMjAsIDQwLCAwLCAwXTtcbmZ1bmN0aW9uIGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9iaikge1xuICAgIGNvbHVtbnMuZm9yRWFjaChmdW5jdGlvbiAoc0NvbCwgaUluZGV4KSB7XG4gICAgICAgIGlmIChvYmpbc0NvbF0gJiYgY29sdW1uTGVuZ3Roc1tpSW5kZXhdICYmIG9ialtzQ29sXS5sZW5ndGggPiBjb2x1bW5MZW5ndGhzW2lJbmRleF0pIHtcbiAgICAgICAgICAgIG9ialtzQ29sXSA9IG9ialtzQ29sXS5zdWJzdHJpbmcoMCwgY29sdW1uTGVuZ3Roc1tpSW5kZXhdKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBvYmo7XG59XG5leHBvcnRzLmFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkID0gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQ7XG5mdW5jdGlvbiBsb2dBbnN3ZXIoYW5zd2VyLCBjYWxsYmFjaykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgKGZ1bmN0aW9uICgpIHsgfSk7XG4gICAgdmFyIHNlc3Npb24gPSBhbnN3ZXIuc2Vzc2lvbjtcbiAgICB2YXIgcGcgPSB0aGlzLnBnO1xuICAgIHZhciBvTG9nRW50cnkgPSB7XG4gICAgICAgIGJvdGlkOiB0aGlzLm5hbWUsXG4gICAgICAgIHVzZXJpZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXJcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIuaWQgfHwgXCJcIixcbiAgICAgICAgbWVzc2FnZTogc2Vzc2lvbi5tZXNzYWdlLnRleHQsXG4gICAgICAgIHJlc3BvbnNlOiBhbnN3ZXIucmVzcG9uc2UsXG4gICAgICAgIGFjdGlvbjogYW5zd2VyLmFjdGlvbixcbiAgICAgICAgaW50ZW50OiBhbnN3ZXIuaW50ZW50LFxuICAgICAgICBjb252ZXJzYXRpb25pZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvblxuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uLmlkIHx8IFwiXCIsXG4gICAgICAgIG1ldGE6IGFuc3dlci5yZXN1bHQgfHwge30sXG4gICAgICAgIGRlbHRhOiBEYXRlLm5vdygpIC0gRGF0ZS5wYXJzZShzZXNzaW9uLm1lc3NhZ2UudGltZXN0YW1wKSxcbiAgICB9O1xuICAgIG9Mb2dFbnRyeSA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9Mb2dFbnRyeSk7XG4gICAgaWYgKCFleHBvcnRzLnNxbEFjdGl2ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHBnLmNvbm5lY3QodGhpcy5kYnVybCwgZnVuY3Rpb24gKGVyciwgY2xpZW50LCBwZ0RvbmUpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgLy8gZmFpbGVkIHRvIGFjcXVpcmUgY29ubmVjdGlvblxuICAgICAgICAgICAgLy9sb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgZGVidWdsb2coJ0Vycm9yIGNvbm5lY3RpbmcgdG8gZGInICsgZXJyKTtcbiAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB2YXIgcXVlcnkgPSBcIklOU0VSVCBJTlRPIGxvZ2NvbnYgKFwiICsgY29sdW1ucy5qb2luKFwiLFwiKSArIFwiKSBcIiArXG4gICAgICAgICAgICAgICAgLy8gICAoY29udmlkLCBzZXNzaW9uaWQsIHVzZXIsIG1lc3NhZ2UsIHJlc3BvbnNlLCBtZXRhKSBgICtcbiAgICAgICAgICAgICAgICBcIlZBTFVFUyAoIFwiICtcbiAgICAgICAgICAgICAgICAvLyAkMSwgJDIsIC4uLlxuICAgICAgICAgICAgICAgIGNvbHVtbnMubWFwKGZ1bmN0aW9uIChvLCBpSW5kZXgpIHsgcmV0dXJuIFwiJFwiICsgKGlJbmRleCArIDEpOyB9KS5qb2luKFwiLCBcIikgKyBcIilcIjtcbiAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBjb2x1bW5zLm1hcChmdW5jdGlvbiAoc0NvbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBvTG9nRW50cnlbc0NvbF07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vICBbbGV2ZWwsIG1zZywgbWV0YSBpbnN0YW5jZW9mIEFycmF5ID8gSlNPTi5zdHJpbmdpZnkobWV0YSkgOiBtZXRhXSxcbiAgICAgICAgICAgIGNsaWVudC5xdWVyeShxdWVyeSwgdmFsdWVzLCBmdW5jdGlvbiAoZXJyLCByZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBwZ0RvbmUoKTtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGxvZ2dlci5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKCdFcnJvciBpbnNlcnRpbmcgcmVjb3JkIGludG8gZGIgJyArIGVycik7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyAgbG9nZ2VyLmVtaXQoJ2xvZ2dlZCcpO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuZXhwb3J0cy5sb2dBbnN3ZXIgPSBsb2dBbnN3ZXI7XG52YXIgbG9nZ2VycyA9IHt9O1xuZnVuY3Rpb24gbG9nZ2VyKG5hbWUsIGRidXJsLCBwZykge1xuICAgIGlmICghZGJ1cmwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCduZWVkIGRhdGFiYXNlIHVybCcpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIgfHwgIS9eW0EtWmEtel1bQS1aYS16MC05X10rJC8uZXhlYyhuYW1lKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJyk7XG4gICAgfVxuICAgIGlmICghbG9nZ2Vyc1tuYW1lXSkge1xuICAgICAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBkYnVybDogZGJ1cmwsXG4gICAgICAgICAgICBwZzogcGdcbiAgICAgICAgfTtcbiAgICAgICAgYWxvZ2dlci5sb2dJdCA9IGxvZ0Fuc3dlci5iaW5kKGFsb2dnZXIpO1xuICAgICAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgICB9XG4gICAgaWYgKGxvZ2dlcnNbbmFtZV0uZGJ1cmwgIT09IGRidXJsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRmxhZ3MgbWlzbWF0Y2ggaW4gbG9nZ2VyJyArIG5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn1cbmV4cG9ydHMubG9nZ2VyID0gbG9nZ2VyO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
