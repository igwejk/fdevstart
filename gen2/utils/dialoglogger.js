/**
 * a logger for dialog conversations
 */
//declare module pg {};
"use strict";

var debug = require('debug');
var process = require('process');
exports.sqlActive = !!process.env.ABOT_LOGDB;
var debuglog = debug('dialoglogger');
;
;
var columns = ["botid", "userid", "message", "response", "action", "intent", "conversationid", "meta", "delta"];
// 0 indicates do not process /truncate, e.g. non string type
var columnLengths = [10, 40, 1024, 1024, 512, 20, 40, 0, 0];
function assureColumnLengthNotExceeded(obj) {
    columns.forEach(function (sCol, iIndex) {
        if (columnLengths[iIndex] && typeof obj[sCol] !== "string") {
            debuglog("Unexpected non-string value " + JSON.stringify(obj[sCol]));
            obj[sCol] = "" + obj[sCol];
        }
        if (obj[sCol] && columnLengths[iIndex] && obj[sCol].length > columnLengths[iIndex]) {
            obj[sCol] = obj[sCol].substring(0, columnLengths[iIndex]);
        }
    });
    return obj;
}
exports.assureColumnLengthNotExceeded = assureColumnLengthNotExceeded;
function logAnswer(answer, callback) {
    "use strict";

    callback = callback || function () {};
    var session = answer.session;
    var pg = this.pg;
    debuglog("here user id of message session.message.address " + JSON.stringify(session.message.address.user));
    var oLogEntry = {
        botid: this.name,
        userid: session.message.address && session.message.address.user && session.message.address.user.id || "",
        message: session.message.text,
        response: answer.response,
        action: answer.action,
        intent: answer.intent,
        conversationid: session.message.address && session.message.address.conversation && session.message.address.conversation.id || "",
        meta: answer.result || {},
        delta: Date.now() - Date.parse(session.message.timestamp)
    };
    oLogEntry = assureColumnLengthNotExceeded(oLogEntry);
    if (!exports.sqlActive) {
        return;
    }
    pg.connect(this.dburl, function (err, client, pgDone) {
        if (err) {
            // failed to acquire connection
            //logger.emit('error', err);
            debuglog('Error connecting to db' + err);
            callback(err);
        } else {
            var query = "INSERT INTO logconv (" + columns.join(",") + ") " +
            //   (convid, sessionid, user, message, response, meta) ` +
            "VALUES ( " +
            // $1, $2, ...
            columns.map(function (o, iIndex) {
                return "$" + (iIndex + 1);
            }).join(", ") + ")";
            var values = columns.map(function (sCol) {
                return oLogEntry[sCol];
            });
            //  [level, msg, meta instanceof Array ? JSON.stringify(meta) : meta],
            client.query(query, values, function (err, result) {
                pgDone();
                if (err) {
                    // logger.emit('error', err);
                    debuglog('Error inserting record into db ' + err + '\n' + values.join("\n"));
                    callback(err);
                } else {
                    //  logger.emit('logged');
                    callback(null, true);
                }
            });
        }
    });
}
exports.logAnswer = logAnswer;
var loggers = {};
function logger(name, dburl, pg) {
    if (!dburl) {
        throw new Error('need database url');
    }
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            dburl: dburl,
            pg: pg
        };
        alogger.logIt = logAnswer.bind(alogger);
        loggers[name] = alogger;
    }
    if (loggers[name].dburl !== dburl) {
        throw new Error('Flags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9kaWFsb2dsb2dnZXIudHMiLCJ1dGlscy9kaWFsb2dsb2dnZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwicHJvY2VzcyIsImV4cG9ydHMiLCJzcWxBY3RpdmUiLCJlbnYiLCJBQk9UX0xPR0RCIiwiZGVidWdsb2ciLCJjb2x1bW5zIiwiY29sdW1uTGVuZ3RocyIsImFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkIiwib2JqIiwiZm9yRWFjaCIsInNDb2wiLCJpSW5kZXgiLCJKU09OIiwic3RyaW5naWZ5IiwibGVuZ3RoIiwic3Vic3RyaW5nIiwibG9nQW5zd2VyIiwiYW5zd2VyIiwiY2FsbGJhY2siLCJzZXNzaW9uIiwicGciLCJtZXNzYWdlIiwiYWRkcmVzcyIsInVzZXIiLCJvTG9nRW50cnkiLCJib3RpZCIsIm5hbWUiLCJ1c2VyaWQiLCJpZCIsInRleHQiLCJyZXNwb25zZSIsImFjdGlvbiIsImludGVudCIsImNvbnZlcnNhdGlvbmlkIiwiY29udmVyc2F0aW9uIiwibWV0YSIsInJlc3VsdCIsImRlbHRhIiwiRGF0ZSIsIm5vdyIsInBhcnNlIiwidGltZXN0YW1wIiwiY29ubmVjdCIsImRidXJsIiwiZXJyIiwiY2xpZW50IiwicGdEb25lIiwicXVlcnkiLCJqb2luIiwibWFwIiwibyIsInZhbHVlcyIsImxvZ2dlcnMiLCJsb2dnZXIiLCJFcnJvciIsImV4ZWMiLCJhbG9nZ2VyIiwibG9nSXQiLCJiaW5kIl0sIm1hcHBpbmdzIjoiQUFBQTs7O0FBR0E7QUNDQTs7QURHQSxJQUFZQSxRQUFLQyxRQUFNLE9BQU4sQ0FBakI7QUFDQSxJQUFZQyxVQUFPRCxRQUFNLFNBQU4sQ0FBbkI7QUFHV0UsUUFBQUMsU0FBQSxHQUFZLENBQUMsQ0FBRUYsUUFBUUcsR0FBUixDQUFZQyxVQUEzQjtBQUVYLElBQU1DLFdBQVdQLE1BQU0sY0FBTixDQUFqQjtBQU9DO0FBZUE7QUFVRCxJQUFNUSxVQUFVLENBQUMsT0FBRCxFQUFTLFFBQVQsRUFBbUIsU0FBbkIsRUFBOEIsVUFBOUIsRUFBMEMsUUFBMUMsRUFBb0QsUUFBcEQsRUFBOEQsZ0JBQTlELEVBQWdGLE1BQWhGLEVBQXdGLE9BQXhGLENBQWhCO0FBQ0E7QUFDQSxJQUFNQyxnQkFBZ0IsQ0FBQyxFQUFELEVBQUssRUFBTCxFQUFTLElBQVQsRUFBZSxJQUFmLEVBQXFCLEdBQXJCLEVBQTBCLEVBQTFCLEVBQThCLEVBQTlCLEVBQWtDLENBQWxDLEVBQW9DLENBQXBDLENBQXRCO0FBR0EsU0FBQUMsNkJBQUEsQ0FBOENDLEdBQTlDLEVBQTZEO0FBQzNESCxZQUFRSSxPQUFSLENBQWdCLFVBQVNDLElBQVQsRUFBY0MsTUFBZCxFQUFvQjtBQUNsQyxZQUFHTCxjQUFjSyxNQUFkLEtBQXlCLE9BQU9ILElBQUlFLElBQUosQ0FBUCxLQUFzQixRQUFsRCxFQUE0RDtBQUMxRE4scUJBQVMsaUNBQWlDUSxLQUFLQyxTQUFMLENBQWVMLElBQUlFLElBQUosQ0FBZixDQUExQztBQUNBRixnQkFBSUUsSUFBSixJQUFZLEtBQUlGLElBQUlFLElBQUosQ0FBaEI7QUFDRDtBQUNELFlBQUdGLElBQUlFLElBQUosS0FBYUosY0FBY0ssTUFBZCxDQUFiLElBQXNDSCxJQUFJRSxJQUFKLEVBQVVJLE1BQVYsR0FBbUJSLGNBQWNLLE1BQWQsQ0FBNUQsRUFBbUY7QUFDakZILGdCQUFJRSxJQUFKLElBQVlGLElBQUlFLElBQUosRUFBVUssU0FBVixDQUFvQixDQUFwQixFQUFzQlQsY0FBY0ssTUFBZCxDQUF0QixDQUFaO0FBQ0Q7QUFDRixLQVJEO0FBU0EsV0FBT0gsR0FBUDtBQUNEO0FBWGVSLFFBQUFPLDZCQUFBLEdBQTZCQSw2QkFBN0I7QUFhaEIsU0FBQVMsU0FBQSxDQUEwQkMsTUFBMUIsRUFBMkNDLFFBQTNDLEVBQW1GO0FBQ2pGOztBQUNBQSxlQUFXQSxZQUFhLFlBQUEsQ0FBYSxDQUFyQztBQUNBLFFBQUlDLFVBQVVGLE9BQU9FLE9BQXJCO0FBQ0EsUUFBSUMsS0FBSyxLQUFLQSxFQUFkO0FBQ0FoQixhQUFTLHFEQUNUUSxLQUFLQyxTQUFMLENBQWVNLFFBQVFFLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCQyxJQUF2QyxDQURBO0FBRUEsUUFBSUMsWUFBd0I7QUFDMUJDLGVBQVEsS0FBS0MsSUFEYTtBQUUxQkMsZ0JBQVFSLFFBQVFFLE9BQVIsQ0FBZ0JDLE9BQWhCLElBQ0xILFFBQVFFLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCQyxJQURuQixJQUVMSixRQUFRRSxPQUFSLENBQWdCQyxPQUFoQixDQUF3QkMsSUFBeEIsQ0FBNkJLLEVBRnhCLElBRThCLEVBSlo7QUFLMUJQLGlCQUFTRixRQUFRRSxPQUFSLENBQWdCUSxJQUxDO0FBTTFCQyxrQkFBV2IsT0FBT2EsUUFOUTtBQU8xQkMsZ0JBQVNkLE9BQU9jLE1BUFU7QUFTMUJDLGdCQUFRZixPQUFPZSxNQVRXO0FBVzFCQyx3QkFBZ0JkLFFBQVFFLE9BQVIsQ0FBZ0JDLE9BQWhCLElBQ2JILFFBQVFFLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCWSxZQURYLElBRWJmLFFBQVFFLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCWSxZQUF4QixDQUFxQ04sRUFGeEIsSUFFOEIsRUFicEI7QUFlMUJPLGNBQU9sQixPQUFPbUIsTUFBUCxJQUFpQixFQWZFO0FBaUIxQkMsZUFBUUMsS0FBS0MsR0FBTCxLQUFhRCxLQUFLRSxLQUFMLENBQVdyQixRQUFRRSxPQUFSLENBQWdCb0IsU0FBM0I7QUFqQkssS0FBNUI7QUFvQkFqQixnQkFBWWpCLDhCQUE4QmlCLFNBQTlCLENBQVo7QUFDQSxRQUFJLENBQUN4QixRQUFBQyxTQUFMLEVBQWdCO0FBQ2Q7QUFDRDtBQUNEbUIsT0FBR3NCLE9BQUgsQ0FBVyxLQUFLQyxLQUFoQixFQUF1QixVQUFDQyxHQUFELEVBQU1DLE1BQU4sRUFBMEJDLE1BQTFCLEVBQWdDO0FBQ25ELFlBQUlGLEdBQUosRUFBUztBQUNQO0FBQ0E7QUFDQXhDLHFCQUFTLDJCQUEyQndDLEdBQXBDO0FBQ0ExQixxQkFBUzBCLEdBQVQ7QUFDRCxTQUxELE1BS087QUFDTCxnQkFBSUcsUUFBTywwQkFBMEIxQyxRQUFRMkMsSUFBUixDQUFhLEdBQWIsQ0FBMUIsR0FBOEMsSUFBOUM7QUFDWDtBQUNBLHVCQUZXO0FBR1g7QUFDQzNDLG9CQUFRNEMsR0FBUixDQUFZLFVBQVNDLENBQVQsRUFBV3ZDLE1BQVgsRUFBaUI7QUFBSSx1QkFBTyxPQUFPQSxTQUFPLENBQWQsQ0FBUDtBQUEwQixhQUEzRCxFQUE2RHFDLElBQTdELENBQWtFLElBQWxFLENBSlUsR0FJZ0UsR0FKM0U7QUFNQSxnQkFBSUcsU0FBUzlDLFFBQVE0QyxHQUFSLENBQVksVUFBU3ZDLElBQVQsRUFBYTtBQUNqQyx1QkFBT2MsVUFBVWQsSUFBVixDQUFQO0FBQ0QsYUFGUyxDQUFiO0FBR0c7QUFFSG1DLG1CQUFPRSxLQUFQLENBQWFBLEtBQWIsRUFBbUJJLE1BQW5CLEVBRWEsVUFBQ1AsR0FBRCxFQUFNUixNQUFOLEVBQVk7QUFDckJVO0FBQ0Esb0JBQUlGLEdBQUosRUFBUztBQUNSO0FBQ0F4Qyw2QkFBUyxvQ0FBb0N3QyxHQUFwQyxHQUEwQyxJQUExQyxHQUNOTyxPQUFPSCxJQUFQLENBQVksSUFBWixDQURIO0FBRUM5Qiw2QkFBUzBCLEdBQVQ7QUFDRCxpQkFMRCxNQUtPO0FBQ1A7QUFDRTFCLDZCQUFTLElBQVQsRUFBZSxJQUFmO0FBQ0Q7QUFDSixhQWJEO0FBY0Q7QUFDRixLQWpDSDtBQWtDQztBQWpFYWxCLFFBQUFnQixTQUFBLEdBQVNBLFNBQVQ7QUFtRWhCLElBQUlvQyxVQUFVLEVBQWQ7QUFFQSxTQUFBQyxNQUFBLENBQXVCM0IsSUFBdkIsRUFBcUNpQixLQUFyQyxFQUFxRHZCLEVBQXJELEVBQTREO0FBQzFELFFBQUksQ0FBQ3VCLEtBQUwsRUFBWTtBQUNWLGNBQU0sSUFBSVcsS0FBSixDQUFVLG1CQUFWLENBQU47QUFDRDtBQUNELFFBQUksT0FBTzVCLElBQVAsS0FBZ0IsUUFBaEIsSUFBNEIsQ0FBQywwQkFBMEI2QixJQUExQixDQUErQjdCLElBQS9CLENBQWpDLEVBQXVFO0FBQ3JFLGNBQU0sSUFBSTRCLEtBQUosQ0FBVSwwREFBVixDQUFOO0FBQ0Q7QUFDRCxRQUFJLENBQUNGLFFBQVExQixJQUFSLENBQUwsRUFBb0I7QUFDbEIsWUFBSThCLFVBQVU7QUFDWjlCLGtCQUFNQSxJQURNO0FBRVppQixtQkFBT0EsS0FGSztBQUdadkIsZ0JBQUtBO0FBSE8sU0FBZDtBQUtBb0MsZ0JBQVFDLEtBQVIsR0FBZ0J6QyxVQUFVMEMsSUFBVixDQUFlRixPQUFmLENBQWhCO0FBQ0FKLGdCQUFRMUIsSUFBUixJQUFnQjhCLE9BQWhCO0FBQ0Q7QUFDRCxRQUFJSixRQUFRMUIsSUFBUixFQUFjaUIsS0FBZCxLQUF3QkEsS0FBNUIsRUFBbUM7QUFDakMsY0FBTSxJQUFJVyxLQUFKLENBQVUsNkJBQTZCNUIsSUFBdkMsQ0FBTjtBQUNEO0FBQ0QsV0FBTzBCLFFBQVExQixJQUFSLEVBQWMrQixLQUFyQjtBQUNEO0FBcEJlekQsUUFBQXFELE1BQUEsR0FBTUEsTUFBTiIsImZpbGUiOiJ1dGlscy9kaWFsb2dsb2dnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIGEgbG9nZ2VyIGZvciBkaWFsb2cgY29udmVyc2F0aW9uc1xuICovXG4vL2RlY2xhcmUgbW9kdWxlIHBnIHt9O1xuXG5pbXBvcnQgKiBhcyBidWlsZGVyIGZyb20gJ2JvdGJ1aWxkZXInO1xuaW1wb3J0ICogYXMgcGcgZnJvbSAncGcnO1xuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0ICogYXMgcHJvY2VzcyBmcm9tICdwcm9jZXNzJztcblxuXG5leHBvcnQgdmFyIHNxbEFjdGl2ZSA9ICEhKHByb2Nlc3MuZW52LkFCT1RfTE9HREIpO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdkaWFsb2dsb2dnZXInKTtcblxuaW50ZXJmYWNlIElMb2dnZXIge1xuICBuYW1lOiBzdHJpbmcsXG4gIGRidXJsOiBzdHJpbmcsXG4gIGxvZ0l0PzogKGEgOiBJQW5zd2VyLCBjYWxsYmFjayA6IChlcnIgOiBhbnksIHJlcz8gOiBhbnkpID0+IHZvaWQpID0+IHZvaWQsXG4gIHBnIDogYW55XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIElMb2dFbnRyeSB7XG4gIGJvdGlkIDogc3RyaW5nLCAvKiAxMCAqL1xuICB1c2VyaWQgOiBzdHJpbmcsXG4gIG1lc3NhZ2UgOiBzdHJpbmcsXG4gIHJlc3BvbnNlIDogc3RyaW5nLFxuICBhY3Rpb24gOiBzdHJpbmcsXG4gIGludGVudCA6IHN0cmluZyxcbiAgY29udmVyc2F0aW9uaWQgOiBzdHJpbmcsXG4gIC8qKlxuICAgKiBhbiByZXN1bHRcbiAgICoqL1xuICBtZXRhIDogYW55LFxuICBkZWx0YTogbnVtYmVyXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIElBbnN3ZXIge1xuICBzZXNzaW9uIDogYnVpbGRlci5TZXNzaW9uLFxuICBpbnRlbnQgOiBzdHJpbmcsXG4gIHJlc3BvbnNlIDogc3RyaW5nLFxuICBhY3Rpb24/IDogc3RyaW5nLFxuICByZXN1bHQ/IDogYW55LFxufVxuXG5jb25zdCBjb2x1bW5zID0gW1wiYm90aWRcIixcInVzZXJpZFwiLCBcIm1lc3NhZ2VcIiwgXCJyZXNwb25zZVwiLCBcImFjdGlvblwiLCBcImludGVudFwiLCBcImNvbnZlcnNhdGlvbmlkXCIsIFwibWV0YVwiLCBcImRlbHRhXCJdO1xuLy8gMCBpbmRpY2F0ZXMgZG8gbm90IHByb2Nlc3MgL3RydW5jYXRlLCBlLmcuIG5vbiBzdHJpbmcgdHlwZVxuY29uc3QgY29sdW1uTGVuZ3RocyA9IFsxMCwgNDAsIDEwMjQsIDEwMjQsIDUxMiwgMjAsIDQwLCAwLDAgXTtcblxuXG5leHBvcnQgZnVuY3Rpb24gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob2JqIDogSUxvZ0VudHJ5KSA6IElMb2dFbnRyeSB7XG4gIGNvbHVtbnMuZm9yRWFjaChmdW5jdGlvbihzQ29sLGlJbmRleCkge1xuICAgIGlmKGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiB0eXBlb2Ygb2JqW3NDb2xdICE9PSAgXCJzdHJpbmdcIikge1xuICAgICAgZGVidWdsb2coXCJVbmV4cGVjdGVkIG5vbi1zdHJpbmcgdmFsdWUgXCIgKyBKU09OLnN0cmluZ2lmeShvYmpbc0NvbF0pKTtcbiAgICAgIG9ialtzQ29sXSA9IFwiXCIrIG9ialtzQ29sXTtcbiAgICB9XG4gICAgaWYob2JqW3NDb2xdICYmIGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiBvYmpbc0NvbF0ubGVuZ3RoID4gY29sdW1uTGVuZ3Roc1tpSW5kZXhdKSB7XG4gICAgICBvYmpbc0NvbF0gPSBvYmpbc0NvbF0uc3Vic3RyaW5nKDAsY29sdW1uTGVuZ3Roc1tpSW5kZXhdKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gb2JqO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9nQW5zd2VyKGFuc3dlcjogSUFuc3dlciwgY2FsbGJhY2sgOiAoZXJyOiBhbnksIHJlcz86IGFueSkgPT4gdm9pZCApIHtcbiAgXCJ1c2Ugc3RyaWN0XCI7XG4gIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgKGZ1bmN0aW9uKCkge30pO1xuICB2YXIgc2Vzc2lvbiA9IGFuc3dlci5zZXNzaW9uO1xuICB2YXIgcGcgPSB0aGlzLnBnO1xuICBkZWJ1Z2xvZyhcImhlcmUgdXNlciBpZCBvZiBtZXNzYWdlIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzIFwiICtcbiAgSlNPTi5zdHJpbmdpZnkoc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlcikpO1xuICB2YXIgb0xvZ0VudHJ5IDogSUxvZ0VudHJ5ID0ge1xuICAgIGJvdGlkIDogdGhpcy5uYW1lLFxuICAgIHVzZXJpZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlci5pZCB8fCBcIlwiLFxuICAgIG1lc3NhZ2U6IHNlc3Npb24ubWVzc2FnZS50ZXh0LFxuICAgIHJlc3BvbnNlIDogYW5zd2VyLnJlc3BvbnNlLFxuICAgIGFjdGlvbiA6IGFuc3dlci5hY3Rpb24sXG5cbiAgICBpbnRlbnQ6IGFuc3dlci5pbnRlbnQsXG5cbiAgICBjb252ZXJzYXRpb25pZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5jb252ZXJzYXRpb25cbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5jb252ZXJzYXRpb24uaWQgfHwgXCJcIixcblxuICAgIG1ldGEgOiBhbnN3ZXIucmVzdWx0IHx8IHt9LFxuXG4gICAgZGVsdGEgOiBEYXRlLm5vdygpIC0gRGF0ZS5wYXJzZShzZXNzaW9uLm1lc3NhZ2UudGltZXN0YW1wKSxcbiAgfTtcblxuICBvTG9nRW50cnkgPSBhc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZChvTG9nRW50cnkpO1xuICBpZiAoIXNxbEFjdGl2ZSkge1xuICAgIHJldHVybjtcbiAgfVxuICBwZy5jb25uZWN0KHRoaXMuZGJ1cmwsIChlcnIsIGNsaWVudCA6IHBnLkNsaWVudCwgcGdEb25lKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIC8vIGZhaWxlZCB0byBhY3F1aXJlIGNvbm5lY3Rpb25cbiAgICAgICAgLy9sb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICBkZWJ1Z2xvZygnRXJyb3IgY29ubmVjdGluZyB0byBkYicgKyBlcnIpO1xuICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIHF1ZXJ5ID1gSU5TRVJUIElOVE8gbG9nY29udiAoYCArIGNvbHVtbnMuam9pbihcIixcIikgKyBcIikgXCIgK1xuICAgICAgICAvLyAgIChjb252aWQsIHNlc3Npb25pZCwgdXNlciwgbWVzc2FnZSwgcmVzcG9uc2UsIG1ldGEpIGAgK1xuICAgICAgICBcIlZBTFVFUyAoIFwiICArXG4gICAgICAgIC8vICQxLCAkMiwgLi4uXG4gICAgICAgICBjb2x1bW5zLm1hcChmdW5jdGlvbihvLGlJbmRleCkgeyByZXR1cm4gXCIkXCIgKyAoaUluZGV4KzEpOyB9KS5qb2luKFwiLCBcIikgKyBcIilcIjtcblxuICAgICAgICB2YXIgdmFsdWVzID0gY29sdW1ucy5tYXAoZnVuY3Rpb24oc0NvbCkge1xuICAgICAgICAgICAgIHJldHVybiBvTG9nRW50cnlbc0NvbF07XG4gICAgICAgICAgIH0pO1xuICAgICAgICAgICAvLyAgW2xldmVsLCBtc2csIG1ldGEgaW5zdGFuY2VvZiBBcnJheSA/IEpTT04uc3RyaW5naWZ5KG1ldGEpIDogbWV0YV0sXG5cbiAgICAgICAgY2xpZW50LnF1ZXJ5KHF1ZXJ5LHZhbHVlcyxcblxuICAgICAgICAgICAgICAgICAgICAgKGVyciwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBwZ0RvbmUoKTtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAvLyBsb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgIGRlYnVnbG9nKCdFcnJvciBpbnNlcnRpbmcgcmVjb3JkIGludG8gZGIgJyArIGVyciArICdcXG4nICtcbiAgICAgICAgICAgICAgICB2YWx1ZXMuam9pbihcIlxcblwiKSk7XG4gICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gIGxvZ2dlci5lbWl0KCdsb2dnZWQnKTtcbiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbnZhciBsb2dnZXJzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBJTG9nZ2VyIH07XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dnZXIobmFtZTogc3RyaW5nLCBkYnVybCA6IHN0cmluZywgcGc6IGFueSkgOiAoYTogSUFuc3dlciwgY2FsbGJhY2s/OiAoZXJyOmFueSwgcmVzPyA6YW55KSA9PiB2b2lkKSA9PiB2b2lkICB7XG4gIGlmICghZGJ1cmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ25lZWQgZGF0YWJhc2UgdXJsJyk7XG4gIH1cbiAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiIHx8ICEvXltBLVphLXpdW0EtWmEtejAtOV9dKyQvLmV4ZWMobmFtZSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJylcbiAgfVxuICBpZiAoIWxvZ2dlcnNbbmFtZV0pIHtcbiAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgIG5hbWU6IG5hbWUsXG4gICAgICBkYnVybDogZGJ1cmwsXG4gICAgICBwZyA6IHBnXG4gICAgfSBhcyBJTG9nZ2VyO1xuICAgIGFsb2dnZXIubG9nSXQgPSBsb2dBbnN3ZXIuYmluZChhbG9nZ2VyKTtcbiAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgfVxuICBpZiAobG9nZ2Vyc1tuYW1lXS5kYnVybCAhPT0gZGJ1cmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZsYWdzIG1pc21hdGNoIGluIGxvZ2dlcicgKyBuYW1lKTtcbiAgfVxuICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn0iLCIvKipcbiAqIGEgbG9nZ2VyIGZvciBkaWFsb2cgY29udmVyc2F0aW9uc1xuICovXG4vL2RlY2xhcmUgbW9kdWxlIHBnIHt9O1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xudmFyIHByb2Nlc3MgPSByZXF1aXJlKCdwcm9jZXNzJyk7XG5leHBvcnRzLnNxbEFjdGl2ZSA9ICEhKHByb2Nlc3MuZW52LkFCT1RfTE9HREIpO1xudmFyIGRlYnVnbG9nID0gZGVidWcoJ2RpYWxvZ2xvZ2dlcicpO1xuO1xuO1xudmFyIGNvbHVtbnMgPSBbXCJib3RpZFwiLCBcInVzZXJpZFwiLCBcIm1lc3NhZ2VcIiwgXCJyZXNwb25zZVwiLCBcImFjdGlvblwiLCBcImludGVudFwiLCBcImNvbnZlcnNhdGlvbmlkXCIsIFwibWV0YVwiLCBcImRlbHRhXCJdO1xuLy8gMCBpbmRpY2F0ZXMgZG8gbm90IHByb2Nlc3MgL3RydW5jYXRlLCBlLmcuIG5vbiBzdHJpbmcgdHlwZVxudmFyIGNvbHVtbkxlbmd0aHMgPSBbMTAsIDQwLCAxMDI0LCAxMDI0LCA1MTIsIDIwLCA0MCwgMCwgMF07XG5mdW5jdGlvbiBhc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZChvYmopIHtcbiAgICBjb2x1bW5zLmZvckVhY2goZnVuY3Rpb24gKHNDb2wsIGlJbmRleCkge1xuICAgICAgICBpZiAoY29sdW1uTGVuZ3Roc1tpSW5kZXhdICYmIHR5cGVvZiBvYmpbc0NvbF0gIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIGRlYnVnbG9nKFwiVW5leHBlY3RlZCBub24tc3RyaW5nIHZhbHVlIFwiICsgSlNPTi5zdHJpbmdpZnkob2JqW3NDb2xdKSk7XG4gICAgICAgICAgICBvYmpbc0NvbF0gPSBcIlwiICsgb2JqW3NDb2xdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvYmpbc0NvbF0gJiYgY29sdW1uTGVuZ3Roc1tpSW5kZXhdICYmIG9ialtzQ29sXS5sZW5ndGggPiBjb2x1bW5MZW5ndGhzW2lJbmRleF0pIHtcbiAgICAgICAgICAgIG9ialtzQ29sXSA9IG9ialtzQ29sXS5zdWJzdHJpbmcoMCwgY29sdW1uTGVuZ3Roc1tpSW5kZXhdKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBvYmo7XG59XG5leHBvcnRzLmFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkID0gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQ7XG5mdW5jdGlvbiBsb2dBbnN3ZXIoYW5zd2VyLCBjYWxsYmFjaykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgKGZ1bmN0aW9uICgpIHsgfSk7XG4gICAgdmFyIHNlc3Npb24gPSBhbnN3ZXIuc2Vzc2lvbjtcbiAgICB2YXIgcGcgPSB0aGlzLnBnO1xuICAgIGRlYnVnbG9nKFwiaGVyZSB1c2VyIGlkIG9mIG1lc3NhZ2Ugc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MgXCIgK1xuICAgICAgICBKU09OLnN0cmluZ2lmeShzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyKSk7XG4gICAgdmFyIG9Mb2dFbnRyeSA9IHtcbiAgICAgICAgYm90aWQ6IHRoaXMubmFtZSxcbiAgICAgICAgdXNlcmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlclxuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlci5pZCB8fCBcIlwiLFxuICAgICAgICBtZXNzYWdlOiBzZXNzaW9uLm1lc3NhZ2UudGV4dCxcbiAgICAgICAgcmVzcG9uc2U6IGFuc3dlci5yZXNwb25zZSxcbiAgICAgICAgYWN0aW9uOiBhbnN3ZXIuYWN0aW9uLFxuICAgICAgICBpbnRlbnQ6IGFuc3dlci5pbnRlbnQsXG4gICAgICAgIGNvbnZlcnNhdGlvbmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uXG4gICAgICAgICAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5jb252ZXJzYXRpb24uaWQgfHwgXCJcIixcbiAgICAgICAgbWV0YTogYW5zd2VyLnJlc3VsdCB8fCB7fSxcbiAgICAgICAgZGVsdGE6IERhdGUubm93KCkgLSBEYXRlLnBhcnNlKHNlc3Npb24ubWVzc2FnZS50aW1lc3RhbXApLFxuICAgIH07XG4gICAgb0xvZ0VudHJ5ID0gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob0xvZ0VudHJ5KTtcbiAgICBpZiAoIWV4cG9ydHMuc3FsQWN0aXZlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcGcuY29ubmVjdCh0aGlzLmRidXJsLCBmdW5jdGlvbiAoZXJyLCBjbGllbnQsIHBnRG9uZSkge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAvLyBmYWlsZWQgdG8gYWNxdWlyZSBjb25uZWN0aW9uXG4gICAgICAgICAgICAvL2xvZ2dlci5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgICAgICBkZWJ1Z2xvZygnRXJyb3IgY29ubmVjdGluZyB0byBkYicgKyBlcnIpO1xuICAgICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHZhciBxdWVyeSA9IFwiSU5TRVJUIElOVE8gbG9nY29udiAoXCIgKyBjb2x1bW5zLmpvaW4oXCIsXCIpICsgXCIpIFwiICtcbiAgICAgICAgICAgICAgICAvLyAgIChjb252aWQsIHNlc3Npb25pZCwgdXNlciwgbWVzc2FnZSwgcmVzcG9uc2UsIG1ldGEpIGAgK1xuICAgICAgICAgICAgICAgIFwiVkFMVUVTICggXCIgK1xuICAgICAgICAgICAgICAgIC8vICQxLCAkMiwgLi4uXG4gICAgICAgICAgICAgICAgY29sdW1ucy5tYXAoZnVuY3Rpb24gKG8sIGlJbmRleCkgeyByZXR1cm4gXCIkXCIgKyAoaUluZGV4ICsgMSk7IH0pLmpvaW4oXCIsIFwiKSArIFwiKVwiO1xuICAgICAgICAgICAgdmFyIHZhbHVlcyA9IGNvbHVtbnMubWFwKGZ1bmN0aW9uIChzQ29sKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9Mb2dFbnRyeVtzQ29sXTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gIFtsZXZlbCwgbXNnLCBtZXRhIGluc3RhbmNlb2YgQXJyYXkgPyBKU09OLnN0cmluZ2lmeShtZXRhKSA6IG1ldGFdLFxuICAgICAgICAgICAgY2xpZW50LnF1ZXJ5KHF1ZXJ5LCB2YWx1ZXMsIGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHBnRG9uZSgpO1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbG9nZ2VyLmVtaXQoJ2Vycm9yJywgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coJ0Vycm9yIGluc2VydGluZyByZWNvcmQgaW50byBkYiAnICsgZXJyICsgJ1xcbicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gIGxvZ2dlci5lbWl0KCdsb2dnZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cbmV4cG9ydHMubG9nQW5zd2VyID0gbG9nQW5zd2VyO1xudmFyIGxvZ2dlcnMgPSB7fTtcbmZ1bmN0aW9uIGxvZ2dlcihuYW1lLCBkYnVybCwgcGcpIHtcbiAgICBpZiAoIWRidXJsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignbmVlZCBkYXRhYmFzZSB1cmwnKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiIHx8ICEvXltBLVphLXpdW0EtWmEtejAtOV9dKyQvLmV4ZWMobmFtZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdMb2dnZXIgbmFtZSBtdXN0IGJlIGF0IGxlYXN0IHR3byBhbHBoYW51bWVyaWMgY2hhcmFjdGVycycpO1xuICAgIH1cbiAgICBpZiAoIWxvZ2dlcnNbbmFtZV0pIHtcbiAgICAgICAgdmFyIGFsb2dnZXIgPSB7XG4gICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgZGJ1cmw6IGRidXJsLFxuICAgICAgICAgICAgcGc6IHBnXG4gICAgICAgIH07XG4gICAgICAgIGFsb2dnZXIubG9nSXQgPSBsb2dBbnN3ZXIuYmluZChhbG9nZ2VyKTtcbiAgICAgICAgbG9nZ2Vyc1tuYW1lXSA9IGFsb2dnZXI7XG4gICAgfVxuICAgIGlmIChsb2dnZXJzW25hbWVdLmRidXJsICE9PSBkYnVybCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZsYWdzIG1pc21hdGNoIGluIGxvZ2dlcicgKyBuYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIGxvZ2dlcnNbbmFtZV0ubG9nSXQ7XG59XG5leHBvcnRzLmxvZ2dlciA9IGxvZ2dlcjtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
