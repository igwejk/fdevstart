/**
 * a logger for dialog conversations
 */
//declare module pg {};
"use strict";

var debug = require("debug");
var process = require("process");
exports.sqlActive = !!process.env.ABOT_LOGDB;
var debuglog = debug('dialoglogger');
;
;
var columns = ["botid", "userid", "message", "response", "action", "intent", "conversationid", "meta", "delta"];
// 0 indicates do not process /truncate, e.g. non string type
var columnLengths = [10, 40, 1024, 1024, 512, 20, 40, 0, 0];
function assureColumnLengthNotExceeded(obj) {
    columns.forEach(function (sCol, iIndex) {
        if (columnLengths[iIndex] && typeof obj[sCol] !== "string") {
            debuglog("Unexpected non-string value " + JSON.stringify(obj[sCol]));
            obj[sCol] = "" + obj[sCol];
        }
        if (obj[sCol] && columnLengths[iIndex] && obj[sCol].length > columnLengths[iIndex]) {
            obj[sCol] = obj[sCol].substring(0, columnLengths[iIndex]);
        }
    });
    return obj;
}
exports.assureColumnLengthNotExceeded = assureColumnLengthNotExceeded;
function logAnswer(answer, callback) {
    "use strict";

    callback = callback || function () {};
    var session = answer.session;
    var pg = this.pg;
    debuglog("here user id of message session.message.address " + JSON.stringify(session.message.address.user));
    var oLogEntry = {
        botid: session.message && session.message.address && session.message.address.bot && session.message.address.bot.id || this.name,
        userid: session.message.address && session.message.address.user && session.message.address.user.id || "",
        message: session.message.text,
        response: answer.response,
        action: answer.action,
        intent: answer.intent,
        conversationid: session.message.address && session.message.address.conversation && session.message.address.conversation.id || "",
        meta: answer.result || {},
        delta: Date.now() - Date.parse(session.message.timestamp)
    };
    oLogEntry = assureColumnLengthNotExceeded(oLogEntry);
    if (!exports.sqlActive) {
        return;
    }
    pg.connect(this.dburl, function (err, client, pgDone) {
        if (err) {
            // failed to acquire connection
            //logger.emit('error', err);
            debuglog('Error connecting to db' + err);
            callback(err);
        } else {
            var query = "INSERT INTO logconv (" + columns.join(",") + ") " +
            //   (convid, sessionid, user, message, response, meta) ` +
            "VALUES ( " +
            // $1, $2, ...
            columns.map(function (o, iIndex) {
                return "$" + (iIndex + 1);
            }).join(", ") + ")";
            var values = columns.map(function (sCol) {
                return oLogEntry[sCol];
            });
            //  [level, msg, meta instanceof Array ? JSON.stringify(meta) : meta],
            client.query(query, values, function (err, result) {
                pgDone();
                if (err) {
                    // logger.emit('error', err);
                    debuglog('Error inserting record into db ' + err + '\n' + values.join("\n"));
                    callback(err);
                } else {
                    //  logger.emit('logged');
                    callback(null, true);
                }
            });
        }
    });
}
exports.logAnswer = logAnswer;
var loggers = {};
function logger(name, dburl, pg) {
    if (!dburl) {
        throw new Error('need database url');
    }
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            dburl: dburl,
            pg: pg
        };
        alogger.logIt = logAnswer.bind(alogger);
        loggers[name] = alogger;
    }
    if (loggers[name].dburl !== dburl) {
        throw new Error('Flags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9kaWFsb2dsb2dnZXIudHMiLCJ1dGlscy9kaWFsb2dsb2dnZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwicHJvY2VzcyIsImV4cG9ydHMiLCJzcWxBY3RpdmUiLCJlbnYiLCJBQk9UX0xPR0RCIiwiZGVidWdsb2ciLCJjb2x1bW5zIiwiY29sdW1uTGVuZ3RocyIsImFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkIiwib2JqIiwiZm9yRWFjaCIsInNDb2wiLCJpSW5kZXgiLCJKU09OIiwic3RyaW5naWZ5IiwibGVuZ3RoIiwic3Vic3RyaW5nIiwibG9nQW5zd2VyIiwiYW5zd2VyIiwiY2FsbGJhY2siLCJzZXNzaW9uIiwicGciLCJtZXNzYWdlIiwiYWRkcmVzcyIsInVzZXIiLCJvTG9nRW50cnkiLCJib3RpZCIsImJvdCIsImlkIiwibmFtZSIsInVzZXJpZCIsInRleHQiLCJyZXNwb25zZSIsImFjdGlvbiIsImludGVudCIsImNvbnZlcnNhdGlvbmlkIiwiY29udmVyc2F0aW9uIiwibWV0YSIsInJlc3VsdCIsImRlbHRhIiwiRGF0ZSIsIm5vdyIsInBhcnNlIiwidGltZXN0YW1wIiwiY29ubmVjdCIsImRidXJsIiwiZXJyIiwiY2xpZW50IiwicGdEb25lIiwicXVlcnkiLCJqb2luIiwibWFwIiwibyIsInZhbHVlcyIsImxvZ2dlcnMiLCJsb2dnZXIiLCJFcnJvciIsImV4ZWMiLCJhbG9nZ2VyIiwibG9nSXQiLCJiaW5kIl0sIm1hcHBpbmdzIjoiQUFBQTs7O0FBR0E7QUNDQTs7QURHQSxJQUFBQSxRQUFBQyxRQUFBLE9BQUEsQ0FBQTtBQUNBLElBQUFDLFVBQUFELFFBQUEsU0FBQSxDQUFBO0FBR1dFLFFBQUFDLFNBQUEsR0FBWSxDQUFDLENBQUVGLFFBQVFHLEdBQVIsQ0FBWUMsVUFBM0I7QUFFWCxJQUFNQyxXQUFXUCxNQUFNLGNBQU4sQ0FBakI7QUFPQztBQWVBO0FBVUQsSUFBTVEsVUFBVSxDQUFDLE9BQUQs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RCxRQUFJLENBQUN3QixLQUFMLEVBQVk7QUFDVixjQUFNLElBQUlXLEtBQUosQ0FBVSxtQkFBVixDQUFOO0FBQ0Q7QUFDRCxRQUFJLE9BQU8zQixJQUFQLEtBQWdCLFFBQWhCLElBQTRCLENBQUMsMEJBQTBCNEIsSUFBMUIsQ0FBK0I1QixJQUEvQixDQUFqQyxFQUF1RTtBQUNyRSxjQUFNLElBQUkyQixLQUFKLENBQVUsMERBQVYsQ0FBTjtBQUNEO0FBQ0QsUUFBSSxDQUFDRixRQUFRekIsSUFBUixDQUFMLEVBQW9CO0FBQ2xCLFlBQUk2QixVQUFVO0FBQ1o3QixrQkFBTUEsSUFETTtBQUVaZ0IsbUJBQU9BLEtBRks7QUFHWnhCLGdCQUFLQTtBQUhPLFNBQWQ7QUFLQXFDLGdCQUFRQyxLQUFSLEdBQWdCMUMsVUFBVTJDLElBQVYsQ0FBZUYsT0FBZixDQUFoQjtBQUNBSixnQkFBUXpCLElBQVIsSUFBZ0I2QixPQUFoQjtBQUNEO0FBQ0QsUUFBSUosUUFBUXpCLElBQVIsRUFBY2dCLEtBQWQsS0FBd0JBLEtBQTVCLEVBQW1DO0FBQ2pDLGNBQU0sSUFBSVcsS0FBSixDQUFVLDZCQUE2QjNCLElBQXZDLENBQU47QUFDRDtBQUNELFdBQU95QixRQUFRekIsSUFBUixFQUFjOEIsS0FBckI7QUFDRDtBQXBCRDFELFFBQUFzRCxNQUFBLEdBQUFBLE1BQUEiLCJmaWxlIjoidXRpbHMvZGlhbG9nbG9nZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBhIGxvZ2dlciBmb3IgZGlhbG9nIGNvbnZlcnNhdGlvbnNcbiAqL1xuLy9kZWNsYXJlIG1vZHVsZSBwZyB7fTtcblxuaW1wb3J0ICogYXMgYnVpbGRlciBmcm9tICdib3RidWlsZGVyJztcbmltcG9ydCAqIGFzIHBnIGZyb20gJ3BnJztcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XG5cblxuZXhwb3J0IHZhciBzcWxBY3RpdmUgPSAhIShwcm9jZXNzLmVudi5BQk9UX0xPR0RCKTtcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnZGlhbG9nbG9nZ2VyJyk7XG5cbmludGVyZmFjZSBJTG9nZ2VyIHtcbiAgbmFtZTogc3RyaW5nLFxuICBkYnVybDogc3RyaW5nLFxuICBsb2dJdD86IChhIDogSUFuc3dlciwgY2FsbGJhY2sgOiAoZXJyIDogYW55LCByZXM/IDogYW55KSA9PiB2b2lkKSA9PiB2b2lkLFxuICBwZyA6IGFueVxufTtcblxuZXhwb3J0IGludGVyZmFjZSBJTG9nRW50cnkge1xuICBib3RpZCA6IHN0cmluZywgLyogMTAgKi9cbiAgdXNlcmlkIDogc3RyaW5nLFxuICBtZXNzYWdlIDogc3RyaW5nLFxuICByZXNwb25zZSA6IHN0cmluZyxcbiAgYWN0aW9uIDogc3RyaW5nLFxuICBpbnRlbnQgOiBzdHJpbmcsXG4gIGNvbnZlcnNhdGlvbmlkIDogc3RyaW5nLFxuICAvKipcbiAgICogYW4gcmVzdWx0XG4gICAqKi9cbiAgbWV0YSA6IGFueSxcbiAgZGVsdGE6IG51bWJlclxufTtcblxuZXhwb3J0IGludGVyZmFjZSBJQW5zd2VyIHtcbiAgc2Vzc2lvbiA6IGJ1aWxkZXIuU2Vzc2lvbixcbiAgaW50ZW50IDogc3RyaW5nLFxuICByZXNwb25zZSA6IHN0cmluZyxcbiAgYWN0aW9uPyA6IHN0cmluZyxcbiAgcmVzdWx0PyA6IGFueSxcbn1cblxuY29uc3QgY29sdW1ucyA9IFtcImJvdGlkXCIsXCJ1c2VyaWRcIiwgXCJtZXNzYWdlXCIsIFwicmVzcG9uc2VcIiwgXCJhY3Rpb25cIiwgXCJpbnRlbnRcIiwgXCJjb252ZXJzYXRpb25pZFwiLCBcIm1ldGFcIiwgXCJkZWx0YVwiXTtcbi8vIDAgaW5kaWNhdGVzIGRvIG5vdCBwcm9jZXNzIC90cnVuY2F0ZSwgZS5nLiBub24gc3RyaW5nIHR5cGVcbmNvbnN0IGNvbHVtbkxlbmd0aHMgPSBbMTAsIDQwLCAxMDI0LCAxMDI0LCA1MTIsIDIwLCA0MCwgMCwwIF07XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9iaiA6IElMb2dFbnRyeSkgOiBJTG9nRW50cnkge1xuICBjb2x1bW5zLmZvckVhY2goZnVuY3Rpb24oc0NvbCxpSW5kZXgpIHtcbiAgICBpZihjb2x1bW5MZW5ndGhzW2lJbmRleF0gJiYgdHlwZW9mIG9ialtzQ29sXSAhPT0gIFwic3RyaW5nXCIpIHtcbiAgICAgIGRlYnVnbG9nKFwiVW5leHBlY3RlZCBub24tc3RyaW5nIHZhbHVlIFwiICsgSlNPTi5zdHJpbmdpZnkob2JqW3NDb2xdKSk7XG4gICAgICBvYmpbc0NvbF0gPSBcIlwiKyBvYmpbc0NvbF07XG4gICAgfVxuICAgIGlmKG9ialtzQ29sXSAmJiBjb2x1bW5MZW5ndGhzW2lJbmRleF0gJiYgb2JqW3NDb2xdLmxlbmd0aCA+IGNvbHVtbkxlbmd0aHNbaUluZGV4XSkge1xuICAgICAgb2JqW3NDb2xdID0gb2JqW3NDb2xdLnN1YnN0cmluZygwLGNvbHVtbkxlbmd0aHNbaUluZGV4XSk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIG9iajtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvZ0Fuc3dlcihhbnN3ZXI6IElBbnN3ZXIsIGNhbGxiYWNrIDogKGVycjogYW55LCByZXM/OiBhbnkpID0+IHZvaWQgKSB7XG4gIFwidXNlIHN0cmljdFwiO1xuICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IChmdW5jdGlvbigpIHt9KTtcbiAgdmFyIHNlc3Npb24gPSBhbnN3ZXIuc2Vzc2lvbjtcbiAgdmFyIHBnID0gdGhpcy5wZztcbiAgZGVidWdsb2coXCJoZXJlIHVzZXIgaWQgb2YgbWVzc2FnZSBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcyBcIiArXG4gIEpTT04uc3RyaW5naWZ5KHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIpKTtcbiAgdmFyIG9Mb2dFbnRyeSA6IElMb2dFbnRyeSA9IHtcbiAgICBib3RpZCA6IChzZXNzaW9uLm1lc3NhZ2UgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuYm90ICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmJvdC5pZCApIHx8IHRoaXMubmFtZSxcbiAgICB1c2VyaWQ6IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MudXNlclxuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIuaWQgfHwgXCJcIixcbiAgICBtZXNzYWdlOiBzZXNzaW9uLm1lc3NhZ2UudGV4dCxcbiAgICByZXNwb25zZSA6IGFuc3dlci5yZXNwb25zZSxcbiAgICBhY3Rpb24gOiBhbnN3ZXIuYWN0aW9uLFxuXG4gICAgaW50ZW50OiBhbnN3ZXIuaW50ZW50LFxuXG4gICAgY29udmVyc2F0aW9uaWQ6IHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uXG4gICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uLmlkIHx8IFwiXCIsXG5cbiAgICBtZXRhIDogYW5zd2VyLnJlc3VsdCB8fCB7fSxcblxuICAgIGRlbHRhIDogRGF0ZS5ub3coKSAtIERhdGUucGFyc2Uoc2Vzc2lvbi5tZXNzYWdlLnRpbWVzdGFtcCksXG4gIH07XG5cbiAgb0xvZ0VudHJ5ID0gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob0xvZ0VudHJ5KTtcbiAgaWYgKCFzcWxBY3RpdmUpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgcGcuY29ubmVjdCh0aGlzLmRidXJsLCAoZXJyLCBjbGllbnQgOiBwZy5DbGllbnQsIHBnRG9uZSkgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICAvLyBmYWlsZWQgdG8gYWNxdWlyZSBjb25uZWN0aW9uXG4gICAgICAgIC8vbG9nZ2VyLmVtaXQoJ2Vycm9yJywgZXJyKTtcbiAgICAgICAgZGVidWdsb2coJ0Vycm9yIGNvbm5lY3RpbmcgdG8gZGInICsgZXJyKTtcbiAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBxdWVyeSA9YElOU0VSVCBJTlRPIGxvZ2NvbnYgKGAgKyBjb2x1bW5zLmpvaW4oXCIsXCIpICsgXCIpIFwiICtcbiAgICAgICAgLy8gICAoY29udmlkLCBzZXNzaW9uaWQsIHVzZXIsIG1lc3NhZ2UsIHJlc3BvbnNlLCBtZXRhKSBgICtcbiAgICAgICAgXCJWQUxVRVMgKCBcIiAgK1xuICAgICAgICAvLyAkMSwgJDIsIC4uLlxuICAgICAgICAgY29sdW1ucy5tYXAoZnVuY3Rpb24obyxpSW5kZXgpIHsgcmV0dXJuIFwiJFwiICsgKGlJbmRleCsxKTsgfSkuam9pbihcIiwgXCIpICsgXCIpXCI7XG5cbiAgICAgICAgdmFyIHZhbHVlcyA9IGNvbHVtbnMubWFwKGZ1bmN0aW9uKHNDb2wpIHtcbiAgICAgICAgICAgICByZXR1cm4gb0xvZ0VudHJ5W3NDb2xdO1xuICAgICAgICAgICB9KTtcbiAgICAgICAgICAgLy8gIFtsZXZlbCwgbXNnLCBtZXRhIGluc3RhbmNlb2YgQXJyYXkgPyBKU09OLnN0cmluZ2lmeShtZXRhKSA6IG1ldGFdLFxuXG4gICAgICAgIGNsaWVudC5xdWVyeShxdWVyeSx2YWx1ZXMsXG5cbiAgICAgICAgICAgICAgICAgICAgIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgcGdEb25lKCk7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgLy8gbG9nZ2VyLmVtaXQoJ2Vycm9yJywgZXJyKTtcbiAgICAgICAgICAgICBkZWJ1Z2xvZygnRXJyb3IgaW5zZXJ0aW5nIHJlY29yZCBpbnRvIGRiICcgKyBlcnIgKyAnXFxuJyArXG4gICAgICAgICAgICAgICAgdmFsdWVzLmpvaW4oXCJcXG5cIikpO1xuICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vICBsb2dnZXIuZW1pdCgnbG9nZ2VkJyk7XG4gICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG52YXIgbG9nZ2VycyA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSUxvZ2dlciB9O1xuXG5leHBvcnQgZnVuY3Rpb24gbG9nZ2VyKG5hbWU6IHN0cmluZywgZGJ1cmwgOiBzdHJpbmcsIHBnOiBhbnkpIDogKGE6IElBbnN3ZXIsIGNhbGxiYWNrPzogKGVycjphbnksIHJlcz8gOmFueSkgPT4gdm9pZCkgPT4gdm9pZCAge1xuICBpZiAoIWRidXJsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCduZWVkIGRhdGFiYXNlIHVybCcpO1xuICB9XG4gIGlmICh0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIiB8fCAhL15bQS1aYS16XVtBLVphLXowLTlfXSskLy5leGVjKG5hbWUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdMb2dnZXIgbmFtZSBtdXN0IGJlIGF0IGxlYXN0IHR3byBhbHBoYW51bWVyaWMgY2hhcmFjdGVycycpXG4gIH1cbiAgaWYgKCFsb2dnZXJzW25hbWVdKSB7XG4gICAgdmFyIGFsb2dnZXIgPSB7XG4gICAgICBuYW1lOiBuYW1lLFxuICAgICAgZGJ1cmw6IGRidXJsLFxuICAgICAgcGcgOiBwZ1xuICAgIH0gYXMgSUxvZ2dlcjtcbiAgICBhbG9nZ2VyLmxvZ0l0ID0gbG9nQW5zd2VyLmJpbmQoYWxvZ2dlcik7XG4gICAgbG9nZ2Vyc1tuYW1lXSA9IGFsb2dnZXI7XG4gIH1cbiAgaWYgKGxvZ2dlcnNbbmFtZV0uZGJ1cmwgIT09IGRidXJsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGbGFncyBtaXNtYXRjaCBpbiBsb2dnZXInICsgbmFtZSk7XG4gIH1cbiAgcmV0dXJuIGxvZ2dlcnNbbmFtZV0ubG9nSXQ7XG59IiwiLyoqXG4gKiBhIGxvZ2dlciBmb3IgZGlhbG9nIGNvbnZlcnNhdGlvbnNcbiAqL1xuLy9kZWNsYXJlIG1vZHVsZSBwZyB7fTtcblwidXNlIHN0cmljdFwiO1xudmFyIGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpO1xudmFyIHByb2Nlc3MgPSByZXF1aXJlKFwicHJvY2Vzc1wiKTtcbmV4cG9ydHMuc3FsQWN0aXZlID0gISEocHJvY2Vzcy5lbnYuQUJPVF9MT0dEQik7XG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnZGlhbG9nbG9nZ2VyJyk7XG47XG47XG52YXIgY29sdW1ucyA9IFtcImJvdGlkXCIsIFwidXNlcmlkXCIsIFwibWVzc2FnZVwiLCBcInJlc3BvbnNlXCIsIFwiYWN0aW9uXCIsIFwiaW50ZW50XCIsIFwiY29udmVyc2F0aW9uaWRcIiwgXCJtZXRhXCIsIFwiZGVsdGFcIl07XG4vLyAwIGluZGljYXRlcyBkbyBub3QgcHJvY2VzcyAvdHJ1bmNhdGUsIGUuZy4gbm9uIHN0cmluZyB0eXBlXG52YXIgY29sdW1uTGVuZ3RocyA9IFsxMCwgNDAsIDEwMjQsIDEwMjQsIDUxMiwgMjAsIDQwLCAwLCAwXTtcbmZ1bmN0aW9uIGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9iaikge1xuICAgIGNvbHVtbnMuZm9yRWFjaChmdW5jdGlvbiAoc0NvbCwgaUluZGV4KSB7XG4gICAgICAgIGlmIChjb2x1bW5MZW5ndGhzW2lJbmRleF0gJiYgdHlwZW9mIG9ialtzQ29sXSAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgZGVidWdsb2coXCJVbmV4cGVjdGVkIG5vbi1zdHJpbmcgdmFsdWUgXCIgKyBKU09OLnN0cmluZ2lmeShvYmpbc0NvbF0pKTtcbiAgICAgICAgICAgIG9ialtzQ29sXSA9IFwiXCIgKyBvYmpbc0NvbF07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9ialtzQ29sXSAmJiBjb2x1bW5MZW5ndGhzW2lJbmRleF0gJiYgb2JqW3NDb2xdLmxlbmd0aCA+IGNvbHVtbkxlbmd0aHNbaUluZGV4XSkge1xuICAgICAgICAgICAgb2JqW3NDb2xdID0gb2JqW3NDb2xdLnN1YnN0cmluZygwLCBjb2x1bW5MZW5ndGhzW2lJbmRleF0pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIG9iajtcbn1cbmV4cG9ydHMuYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQgPSBhc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZDtcbmZ1bmN0aW9uIGxvZ0Fuc3dlcihhbnN3ZXIsIGNhbGxiYWNrKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCAoZnVuY3Rpb24gKCkgeyB9KTtcbiAgICB2YXIgc2Vzc2lvbiA9IGFuc3dlci5zZXNzaW9uO1xuICAgIHZhciBwZyA9IHRoaXMucGc7XG4gICAgZGVidWdsb2coXCJoZXJlIHVzZXIgaWQgb2YgbWVzc2FnZSBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcyBcIiArXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIpKTtcbiAgICB2YXIgb0xvZ0VudHJ5ID0ge1xuICAgICAgICBib3RpZDogKHNlc3Npb24ubWVzc2FnZSAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcyAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5ib3QgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuYm90LmlkKSB8fCB0aGlzLm5hbWUsXG4gICAgICAgIHVzZXJpZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXJcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIuaWQgfHwgXCJcIixcbiAgICAgICAgbWVzc2FnZTogc2Vzc2lvbi5tZXNzYWdlLnRleHQsXG4gICAgICAgIHJlc3BvbnNlOiBhbnN3ZXIucmVzcG9uc2UsXG4gICAgICAgIGFjdGlvbjogYW5zd2VyLmFjdGlvbixcbiAgICAgICAgaW50ZW50OiBhbnN3ZXIuaW50ZW50LFxuICAgICAgICBjb252ZXJzYXRpb25pZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvblxuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uLmlkIHx8IFwiXCIsXG4gICAgICAgIG1ldGE6IGFuc3dlci5yZXN1bHQgfHwge30sXG4gICAgICAgIGRlbHRhOiBEYXRlLm5vdygpIC0gRGF0ZS5wYXJzZShzZXNzaW9uLm1lc3NhZ2UudGltZXN0YW1wKSxcbiAgICB9O1xuICAgIG9Mb2dFbnRyeSA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9Mb2dFbnRyeSk7XG4gICAgaWYgKCFleHBvcnRzLnNxbEFjdGl2ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHBnLmNvbm5lY3QodGhpcy5kYnVybCwgZnVuY3Rpb24gKGVyciwgY2xpZW50LCBwZ0RvbmUpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgLy8gZmFpbGVkIHRvIGFjcXVpcmUgY29ubmVjdGlvblxuICAgICAgICAgICAgLy9sb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgZGVidWdsb2coJ0Vycm9yIGNvbm5lY3RpbmcgdG8gZGInICsgZXJyKTtcbiAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB2YXIgcXVlcnkgPSBcIklOU0VSVCBJTlRPIGxvZ2NvbnYgKFwiICsgY29sdW1ucy5qb2luKFwiLFwiKSArIFwiKSBcIiArXG4gICAgICAgICAgICAgICAgLy8gICAoY29udmlkLCBzZXNzaW9uaWQsIHVzZXIsIG1lc3NhZ2UsIHJlc3BvbnNlLCBtZXRhKSBgICtcbiAgICAgICAgICAgICAgICBcIlZBTFVFUyAoIFwiICtcbiAgICAgICAgICAgICAgICAvLyAkMSwgJDIsIC4uLlxuICAgICAgICAgICAgICAgIGNvbHVtbnMubWFwKGZ1bmN0aW9uIChvLCBpSW5kZXgpIHsgcmV0dXJuIFwiJFwiICsgKGlJbmRleCArIDEpOyB9KS5qb2luKFwiLCBcIikgKyBcIilcIjtcbiAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBjb2x1bW5zLm1hcChmdW5jdGlvbiAoc0NvbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBvTG9nRW50cnlbc0NvbF07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vICBbbGV2ZWwsIG1zZywgbWV0YSBpbnN0YW5jZW9mIEFycmF5ID8gSlNPTi5zdHJpbmdpZnkobWV0YSkgOiBtZXRhXSxcbiAgICAgICAgICAgIGNsaWVudC5xdWVyeShxdWVyeSwgdmFsdWVzLCBmdW5jdGlvbiAoZXJyLCByZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBwZ0RvbmUoKTtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGxvZ2dlci5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIGRlYnVnbG9nKCdFcnJvciBpbnNlcnRpbmcgcmVjb3JkIGludG8gZGIgJyArIGVyciArICdcXG4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vICBsb2dnZXIuZW1pdCgnbG9nZ2VkJyk7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5leHBvcnRzLmxvZ0Fuc3dlciA9IGxvZ0Fuc3dlcjtcbnZhciBsb2dnZXJzID0ge307XG5mdW5jdGlvbiBsb2dnZXIobmFtZSwgZGJ1cmwsIHBnKSB7XG4gICAgaWYgKCFkYnVybCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25lZWQgZGF0YWJhc2UgdXJsJyk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIiB8fCAhL15bQS1aYS16XVtBLVphLXowLTlfXSskLy5leGVjKG5hbWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKTtcbiAgICB9XG4gICAgaWYgKCFsb2dnZXJzW25hbWVdKSB7XG4gICAgICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIGRidXJsOiBkYnVybCxcbiAgICAgICAgICAgIHBnOiBwZ1xuICAgICAgICB9O1xuICAgICAgICBhbG9nZ2VyLmxvZ0l0ID0gbG9nQW5zd2VyLmJpbmQoYWxvZ2dlcik7XG4gICAgICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICAgIH1cbiAgICBpZiAobG9nZ2Vyc1tuYW1lXS5kYnVybCAhPT0gZGJ1cmwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGbGFncyBtaXNtYXRjaCBpbiBsb2dnZXInICsgbmFtZSk7XG4gICAgfVxuICAgIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufVxuZXhwb3J0cy5sb2dnZXIgPSBsb2dnZXI7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
