/**
 * a logger for dialog conversations
 */
//declare module pg {};
"use strict";

var debug = require("debug");
var process = require("process");
exports.sqlActive = !!process.env.ABOT_LOGDB;
var debuglog = debug('dialoglogger');
;
;
var columns = ["botid", "userid", "message", "response", "action", "intent", "conversationid", "meta", "delta"];
// 0 indicates do not process /truncate, e.g. non string type
var columnLengths = [10, 40, 1024, 1024, 512, 20, 40, 0, 0];
function assureColumnLengthNotExceeded(obj) {
    columns.forEach(function (sCol, iIndex) {
        if (columnLengths[iIndex] && typeof obj[sCol] !== "string") {
            debuglog("Unexpected non-string value " + JSON.stringify(obj[sCol]));
            obj[sCol] = "" + obj[sCol];
        }
        if (obj[sCol] && columnLengths[iIndex] && obj[sCol].length > columnLengths[iIndex]) {
            obj[sCol] = obj[sCol].substring(0, columnLengths[iIndex]);
        }
    });
    return obj;
}
exports.assureColumnLengthNotExceeded = assureColumnLengthNotExceeded;
function logAnswer(answer, callback, ForceSqlActive) {
    "use strict";

    callback = callback || function () {};
    var session = answer.session;
    var sqlIsActive = ForceSqlActive || exports.sqlActive;
    var pg = this.pg;
    debuglog("here user id of message session.message.address " + JSON.stringify(session.message.address.user));
    var oLogEntry = {
        botid: session.message && session.message.address && session.message.address.bot && session.message.address.bot.id || this.name,
        userid: session.message.address && session.message.address.user && session.message.address.user.id || "",
        message: session.message.text,
        response: answer.response,
        action: answer.action,
        intent: answer.intent,
        conversationid: session.message.address && session.message.address.conversation && session.message.address.conversation.id || "",
        meta: answer.result || {},
        delta: Date.now() - Date.parse(session.message.timestamp)
    };
    oLogEntry = assureColumnLengthNotExceeded(oLogEntry);
    debuglog("sqlIsActive" + sqlIsActive);
    if (!sqlIsActive) {
        return;
    }
    pg.connect(this.dburl, function (err, client, pgDone) {
        if (err) {
            // failed to acquire connection
            //logger.emit('error', err);
            debuglog('Error connecting to db' + err);
            callback(err);
        } else {
            var query = "INSERT INTO logconv (" + columns.join(",") + ") " +
            //   (convid, sessionid, user, message, response, meta) ` +
            "VALUES ( " +
            // $1, $2, ...
            columns.map(function (o, iIndex) {
                return "$" + (iIndex + 1);
            }).join(", ") + ")";
            var values = columns.map(function (sCol) {
                return oLogEntry[sCol];
            });
            //  [level, msg, meta instanceof Array ? JSON.stringify(meta) : meta],
            client.query(query, values, function (err, result) {
                pgDone();
                if (err) {
                    // logger.emit('error', err);
                    debuglog('Error inserting record into db ' + err + '\n' + values.join("\n"));
                    callback(err);
                } else {
                    //  logger.emit('logged');
                    callback(null, true);
                }
            });
        }
    });
}
exports.logAnswer = logAnswer;
var loggers = {};
function logger(name, dburl, pg) {
    if (!dburl) {
        throw new Error('need database url');
    }
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            dburl: dburl,
            pg: pg
        };
        alogger.logIt = logAnswer.bind(alogger);
        loggers[name] = alogger;
    }
    if (loggers[name].dburl !== dburl) {
        throw new Error('Flags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9kaWFsb2dsb2dnZXIudHMiLCJ1dGlscy9kaWFsb2dsb2dnZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwicHJvY2VzcyIsImV4cG9ydHMiLCJzcWxBY3RpdmUiLCJlbnYiLCJBQk9UX0xPR0RCIiwiZGVidWdsb2ciLCJjb2x1bW5zIiwiY29sdW1uTGVuZ3RocyIsImFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkIiwib2JqIiwiZm9yRWFjaCIsInNDb2wiLCJpSW5kZXgiLCJKU09OIiwic3RyaW5naWZ5IiwibGVuZ3RoIiwic3Vic3RyaW5nIiwibG9nQW5zd2VyIiwiYW5zd2VyIiwiY2FsbGJhY2siLCJGb3JjZVNxbEFjdGl2ZSIsInNlc3Npb24iLCJzcWxJc0FjdGl2ZSIsInBnIiwibWVzc2FnZSIsImFkZHJlc3MiLCJ1c2VyIiwib0xvZ0VudHJ5IiwiYm90aWQiLCJib3QiLCJpZCIsIm5hbWUiLCJ1c2VyaWQiLCJ0ZXh0IiwicmVzcG9uc2UiLCJhY3Rpb24iLCJpbnRlbnQiLCJjb252ZXJzYXRpb25pZCIsImNvbnZlcnNhdGlvbiIsIm1ldGEiLCJyZXN1bHQiLCJkZWx0YSIsIkRhdGUiLCJub3ciLCJwYXJzZSIsInRpbWVzdGFtcCIsImNvbm5lY3QiLCJkYnVybCIsImVyciIsImNsaWVudCIsInBnRG9uZSIsInF1ZXJ5Iiwiam9pbiIsIm1hcCIsIm8iLCJ2YWx1ZXMiLCJsb2dnZXJzIiwibG9nZ2VyIiwiRXJyb3IiLCJleGVjIiwiYWxvZ2dlciIsImxvZ0l0IiwiYmluZCJdLCJtYXBwaW5ncyI6IkFBQUE7OztBQUdBO0FDQ0E7O0FER0EsSUFBQUEsUUFBQUMsUUFBQSxPQUFBLENBQUE7QUFDQSxJQUFBQyxVQUFBRCxRQUFBLFNBQUEsQ0FBQTtBQUdXRSxRQUFBQyxTQUFBLEdBQVksQ0FBQyxDQUFFRixRQUFRRyxHQUFSLENBQVlDLFVBQTNCO0FBRVgsSUFBTUMsV0FBV1AsTUFBTSxjQUFOLENBQWpCO0FBT0M7QUFlQTtBQVVELElBQU1RLFVBQVUsQ0FBQyxPQUFELEVBQVMsUUFBVCxFQUFtQixTQUFuQixFQUE4QixVQUE5QixFQUEwQyxRQUExQyxFQUFvRCxRQUFwRCxFQUE4RCxnQkFBOUQsRUFBZ0YsTUFBaEYsRUFBd0YsT0FBeEYsQ0FBaEI7QUFDQTtBQUNBLElBQU1DLGdCQUFnQixDQUFDLEVBQUQsRUFBSyxFQUFMLEVBQVMsSUFBVCxFQUFlLElBQWYsRUFBcUIsR0FBckIsRUFBMEIsRUFBMUIsRUFBOEIsRUFBOUIsRUFBa0MsQ0FBbEMsRUFBb0MsQ0FBcEMsQ0FBdEI7QUFHQSxTQUFBQyw2QkFBQSxDQUE4Q0MsR0FBOUMsRUFBNkQ7QUFDM0RILFlBQVFJLE9BQVIsQ0FBZ0IsVUFBU0MsSUFBVCxFQUFjQyxNQUFkLEVBQW9CO0FBQ2xDLFlBQUdMLGNBQWNLLE1BQWQsS0FBeUIsT0FBT0gsSUFBSUUsSUFBSixDQUFQLEtBQXNCLFFBQWxELEVBQTREO0FBQzFETixxQkFBUyxpQ0FBaUNRLEtBQUtDLFNBQUwsQ0FBZUwsSUFBSUUsSUFBSixDQUFmLENBQTFDO0FBQ0FGLGdCQUFJRSxJQUFKLElBQVksS0FBSUYsSUFBSUUsSUFBSixDQUFoQjtBQUNEO0FBQ0QsWUFBR0YsSUFBSUUsSUFBSixLQUFhSixjQUFjSyxNQUFkLENBQWIsSUFBc0NILElBQUlFLElBQUosRUFBVUksTUFBVixHQUFtQlIsY0FBY0ssTUFBZCxDQUE1RCxFQUFtRjtBQUNqRkgsZ0JBQUlFLElBQUosSUFBWUYsSUFBSUUsSUFBSixFQUFVSyxTQUFWLENBQW9CLENBQXBCLEVBQXNCVCxjQUFjSyxNQUFkLENBQXRCLENBQVo7QUFDRDtBQUNGLEtBUkQ7QUFTQSxXQUFPSCxHQUFQO0FBQ0Q7QUFYRFIsUUFBQU8sNkJBQUEsR0FBQUEsNkJBQUE7QUFhQSxTQUFBUyxTQUFBLENBQTBCQyxNQUExQixFQUEyQ0MsUUFBM0MsRUFBc0ZDLGNBQXRGLEVBQStHO0FBQzdHOztBQUNBRCxlQUFXQSxZQUFhLFlBQUEsQ0FBYSxDQUFyQztBQUNBLFFBQUlFLFVBQVVILE9BQU9HLE9BQXJCO0FBQ0EsUUFBSUMsY0FBY0Ysa0JBQWtCbkIsUUFBQUMsU0FBcEM7QUFDQSxRQUFJcUIsS0FBSyxLQUFLQSxFQUFkO0FBQ0FsQixhQUFTLHFEQUNUUSxLQUFLQyxTQUFMLENBQWVPLFFBQVFHLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCQyxJQUF2QyxDQURBO0FBRUEsUUFBSUMsWUFBd0I7QUFDMUJDLGVBQVNQLFFBQVFHLE9BQVIsSUFBbUJILFFBQVFHLE9BQVIsQ0FBZ0JDLE9BQW5DLElBQThDSixRQUFRRyxPQUFSLENBQWdCQyxPQUFoQixDQUF3QkksR0FBdEUsSUFBNkVSLFFBQVFHLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCSSxHQUF4QixDQUE0QkMsRUFBMUcsSUFBa0gsS0FBS0MsSUFEckc7QUFFMUJDLGdCQUFRWCxRQUFRRyxPQUFSLENBQWdCQyxPQUFoQixJQUNMSixRQUFRRyxPQUFSLENBQWdCQyxPQUFoQixDQUF3QkMsSUFEbkIsSUFFTEwsUUFBUUcsT0FBUixDQUFnQkMsT0FBaEIsQ0FBd0JDLElBQXhCLENBQTZCSSxFQUZ4QixJQUU4QixFQUpaO0FBSzFCTixpQkFBU0gsUUFBUUcsT0FBUixDQUFnQlMsSUFMQztBQU0xQkMsa0JBQVdoQixPQUFPZ0IsUUFOUTtBQU8xQkMsZ0JBQVNqQixPQUFPaUIsTUFQVTtBQVMxQkMsZ0JBQVFsQixPQUFPa0IsTUFUVztBQVcxQkMsd0JBQWdCaEIsUUFBUUcsT0FBUixDQUFnQkMsT0FBaEIsSUFDYkosUUFBUUcsT0FBUixDQUFnQkMsT0FBaEIsQ0FBd0JhLFlBRFgsSUFFYmpCLFFBQVFHLE9BQVIsQ0FBZ0JDLE9BQWhCLENBQXdCYSxZQUF4QixDQUFxQ1IsRUFGeEIsSUFFOEIsRUFicEI7QUFlMUJTLGNBQU9yQixPQUFPc0IsTUFBUCxJQUFpQixFQWZFO0FBaUIxQkMsZUFBUUMsS0FBS0MsR0FBTCxLQUFhRCxLQUFLRSxLQUFMLENBQVd2QixRQUFRRyxPQUFSLENBQWdCcUIsU0FBM0I7QUFqQkssS0FBNUI7QUFvQkFsQixnQkFBWW5CLDhCQUE4Qm1CLFNBQTlCLENBQVo7QUFDQXRCLGFBQVMsZ0JBQWdCaUIsV0FBekI7QUFDQSxRQUFJLENBQUNBLFdBQUwsRUFBa0I7QUFDaEI7QUFDRDtBQUNEQyxPQUFHdUIsT0FBSCxDQUFXLEtBQUtDLEtBQWhCLEVBQXVCLFVBQUNDLEdBQUQsRUFBTUMsTUFBTixFQUEwQkMsTUFBMUIsRUFBZ0M7QUFDbkQsWUFBSUYsR0FBSixFQUFTO0FBQ1A7QUFDQTtBQUNBM0MscUJBQVMsMkJBQTJCMkMsR0FBcEM7QUFDQTdCLHFCQUFTNkIsR0FBVDtBQUNELFNBTEQsTUFLTztBQUNMLGdCQUFJRyxRQUFPLDBCQUEwQjdDLFFBQVE4QyxJQUFSLENBQWEsR0FBYixDQUExQixHQUE4QyxJQUE5QztBQUNYO0FBQ0EsdUJBRlc7QUFHWDtBQUNDOUMsb0JBQVErQyxHQUFSLENBQVksVUFBU0MsQ0FBVCxFQUFXMUMsTUFBWCxFQUFpQjtBQUFJLHVCQUFPLE9BQU9BLFNBQU8sQ0FBZCxDQUFQO0FBQTBCLGFBQTNELEVBQTZEd0MsSUFBN0QsQ0FBa0UsSUFBbEUsQ0FKVSxHQUlnRSxHQUozRTtBQU1BLGdCQUFJRyxTQUFTakQsUUFBUStDLEdBQVIsQ0FBWSxVQUFTMUMsSUFBVCxFQUFhO0FBQ2pDLHVCQUFPZ0IsVUFBVWhCLElBQVYsQ0FBUDtBQUNELGFBRlMsQ0FBYjtBQUdHO0FBRUhzQyxtQkFBT0UsS0FBUCxDQUFhQSxLQUFiLEVBQW1CSSxNQUFuQixFQUVhLFVBQUNQLEdBQUQsRUFBTVIsTUFBTixFQUFZO0FBQ3JCVTtBQUNBLG9CQUFJRixHQUFKLEVBQVM7QUFDUjtBQUNBM0MsNkJBQVMsb0NBQW9DMkMsR0FBcEMsR0FBMEMsSUFBMUMsR0FDTk8sT0FBT0gsSUFBUCxDQUFZLElBQVosQ0FESDtBQUVDakMsNkJBQVM2QixHQUFUO0FBQ0QsaUJBTEQsTUFLTztBQUNQO0FBQ0U3Qiw2QkFBUyxJQUFULEVBQWUsSUFBZjtBQUNEO0FBQ0osYUFiRDtBQWNEO0FBQ0YsS0FqQ0g7QUFrQ0M7QUFuRUhsQixRQUFBZ0IsU0FBQSxHQUFBQSxTQUFBO0FBcUVBLElBQUl1QyxVQUFVLEVBQWQ7QUFFQSxTQUFBQyxNQUFBLENBQXVCMUIsSUFBdkIsRUFBcUNnQixLQUFyQyxFQUFxRHhCLEVBQXJELEVBQTREO0FBQzFELFFBQUksQ0FBQ3dCLEtBQUwsRUFBWTtBQUNWLGNBQU0sSUFBSVcsS0FBSixDQUFVLG1CQUFWLENBQU47QUFDRDtBQUNELFFBQUksT0FBTzNCLElBQVAsS0FBZ0IsUUFBaEIsSUFBNEIsQ0FBQywwQkFBMEI0QixJQUExQixDQUErQjVCLElBQS9CLENBQWpDLEVBQXVFO0FBQ3JFLGNBQU0sSUFBSTJCLEtBQUosQ0FBVSwwREFBVixDQUFOO0FBQ0Q7QUFDRCxRQUFJLENBQUNGLFFBQVF6QixJQUFSLENBQUwsRUFBb0I7QUFDbEIsWUFBSTZCLFVBQVU7QUFDWjdCLGtCQUFNQSxJQURNO0FBRVpnQixtQkFBT0EsS0FGSztBQUdaeEIsZ0JBQUtBO0FBSE8sU0FBZDtBQUtBcUMsZ0JBQVFDLEtBQVIsR0FBZ0I1QyxVQUFVNkMsSUFBVixDQUFlRixPQUFmLENBQWhCO0FBQ0FKLGdCQUFRekIsSUFBUixJQUFnQjZCLE9BQWhCO0FBQ0Q7QUFDRCxRQUFJSixRQUFRekIsSUFBUixFQUFjZ0IsS0FBZCxLQUF3QkEsS0FBNUIsRUFBbUM7QUFDakMsY0FBTSxJQUFJVyxLQUFKLENBQVUsNkJBQTZCM0IsSUFBdkMsQ0FBTjtBQUNEO0FBQ0QsV0FBT3lCLFFBQVF6QixJQUFSLEVBQWM4QixLQUFyQjtBQUNEO0FBcEJENUQsUUFBQXdELE1BQUEsR0FBQUEsTUFBQSIsImZpbGUiOiJ1dGlscy9kaWFsb2dsb2dnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIGEgbG9nZ2VyIGZvciBkaWFsb2cgY29udmVyc2F0aW9uc1xuICovXG4vL2RlY2xhcmUgbW9kdWxlIHBnIHt9O1xuXG5pbXBvcnQgKiBhcyBidWlsZGVyIGZyb20gJ2JvdGJ1aWxkZXInO1xuaW1wb3J0ICogYXMgcGcgZnJvbSAncGcnO1xuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0ICogYXMgcHJvY2VzcyBmcm9tICdwcm9jZXNzJztcblxuXG5leHBvcnQgdmFyIHNxbEFjdGl2ZSA9ICEhKHByb2Nlc3MuZW52LkFCT1RfTE9HREIpO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdkaWFsb2dsb2dnZXInKTtcblxuaW50ZXJmYWNlIElMb2dnZXIge1xuICBuYW1lOiBzdHJpbmcsXG4gIGRidXJsOiBzdHJpbmcsXG4gIGxvZ0l0PzogKGEgOiBJQW5zd2VyLCBjYWxsYmFjayA6IChlcnIgOiBhbnksIHJlcz8gOiBhbnkpID0+IHZvaWQpID0+IHZvaWQsXG4gIHBnIDogYW55XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIElMb2dFbnRyeSB7XG4gIGJvdGlkIDogc3RyaW5nLCAvKiAxMCAqL1xuICB1c2VyaWQgOiBzdHJpbmcsXG4gIG1lc3NhZ2UgOiBzdHJpbmcsXG4gIHJlc3BvbnNlIDogc3RyaW5nLFxuICBhY3Rpb24gOiBzdHJpbmcsXG4gIGludGVudCA6IHN0cmluZyxcbiAgY29udmVyc2F0aW9uaWQgOiBzdHJpbmcsXG4gIC8qKlxuICAgKiBhbiByZXN1bHRcbiAgICoqL1xuICBtZXRhIDogYW55LFxuICBkZWx0YTogbnVtYmVyXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIElBbnN3ZXIge1xuICBzZXNzaW9uIDogYnVpbGRlci5TZXNzaW9uLFxuICBpbnRlbnQgOiBzdHJpbmcsXG4gIHJlc3BvbnNlIDogc3RyaW5nLFxuICBhY3Rpb24/IDogc3RyaW5nLFxuICByZXN1bHQ/IDogYW55LFxufVxuXG5jb25zdCBjb2x1bW5zID0gW1wiYm90aWRcIixcInVzZXJpZFwiLCBcIm1lc3NhZ2VcIiwgXCJyZXNwb25zZVwiLCBcImFjdGlvblwiLCBcImludGVudFwiLCBcImNvbnZlcnNhdGlvbmlkXCIsIFwibWV0YVwiLCBcImRlbHRhXCJdO1xuLy8gMCBpbmRpY2F0ZXMgZG8gbm90IHByb2Nlc3MgL3RydW5jYXRlLCBlLmcuIG5vbiBzdHJpbmcgdHlwZVxuY29uc3QgY29sdW1uTGVuZ3RocyA9IFsxMCwgNDAsIDEwMjQsIDEwMjQsIDUxMiwgMjAsIDQwLCAwLDAgXTtcblxuXG5leHBvcnQgZnVuY3Rpb24gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob2JqIDogSUxvZ0VudHJ5KSA6IElMb2dFbnRyeSB7XG4gIGNvbHVtbnMuZm9yRWFjaChmdW5jdGlvbihzQ29sLGlJbmRleCkge1xuICAgIGlmKGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiB0eXBlb2Ygb2JqW3NDb2xdICE9PSAgXCJzdHJpbmdcIikge1xuICAgICAgZGVidWdsb2coXCJVbmV4cGVjdGVkIG5vbi1zdHJpbmcgdmFsdWUgXCIgKyBKU09OLnN0cmluZ2lmeShvYmpbc0NvbF0pKTtcbiAgICAgIG9ialtzQ29sXSA9IFwiXCIrIG9ialtzQ29sXTtcbiAgICB9XG4gICAgaWYob2JqW3NDb2xdICYmIGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiBvYmpbc0NvbF0ubGVuZ3RoID4gY29sdW1uTGVuZ3Roc1tpSW5kZXhdKSB7XG4gICAgICBvYmpbc0NvbF0gPSBvYmpbc0NvbF0uc3Vic3RyaW5nKDAsY29sdW1uTGVuZ3Roc1tpSW5kZXhdKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gb2JqO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9nQW5zd2VyKGFuc3dlcjogSUFuc3dlciwgY2FsbGJhY2sgOiAoZXJyOiBhbnksIHJlcz86IGFueSkgPT4gdm9pZCAsIEZvcmNlU3FsQWN0aXZlPyA6IGJvb2xlYW4pIHtcbiAgXCJ1c2Ugc3RyaWN0XCI7XG4gIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgKGZ1bmN0aW9uKCkge30pO1xuICB2YXIgc2Vzc2lvbiA9IGFuc3dlci5zZXNzaW9uO1xuICB2YXIgc3FsSXNBY3RpdmUgPSBGb3JjZVNxbEFjdGl2ZSB8fCBzcWxBY3RpdmU7XG4gIHZhciBwZyA9IHRoaXMucGc7XG4gIGRlYnVnbG9nKFwiaGVyZSB1c2VyIGlkIG9mIG1lc3NhZ2Ugc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MgXCIgK1xuICBKU09OLnN0cmluZ2lmeShzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyKSk7XG4gIHZhciBvTG9nRW50cnkgOiBJTG9nRW50cnkgPSB7XG4gICAgYm90aWQgOiAoc2Vzc2lvbi5tZXNzYWdlICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmJvdCAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5ib3QuaWQgKSB8fCB0aGlzLm5hbWUsXG4gICAgdXNlcmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXJcbiAgICAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy51c2VyLmlkIHx8IFwiXCIsXG4gICAgbWVzc2FnZTogc2Vzc2lvbi5tZXNzYWdlLnRleHQsXG4gICAgcmVzcG9uc2UgOiBhbnN3ZXIucmVzcG9uc2UsXG4gICAgYWN0aW9uIDogYW5zd2VyLmFjdGlvbixcblxuICAgIGludGVudDogYW5zd2VyLmludGVudCxcblxuICAgIGNvbnZlcnNhdGlvbmlkOiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzc1xuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvblxuICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvbi5pZCB8fCBcIlwiLFxuXG4gICAgbWV0YSA6IGFuc3dlci5yZXN1bHQgfHwge30sXG5cbiAgICBkZWx0YSA6IERhdGUubm93KCkgLSBEYXRlLnBhcnNlKHNlc3Npb24ubWVzc2FnZS50aW1lc3RhbXApLFxuICB9O1xuXG4gIG9Mb2dFbnRyeSA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9Mb2dFbnRyeSk7XG4gIGRlYnVnbG9nKFwic3FsSXNBY3RpdmVcIiArIHNxbElzQWN0aXZlKTtcbiAgaWYgKCFzcWxJc0FjdGl2ZSkge1xuICAgIHJldHVybjtcbiAgfVxuICBwZy5jb25uZWN0KHRoaXMuZGJ1cmwsIChlcnIsIGNsaWVudCA6IHBnLkNsaWVudCwgcGdEb25lKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIC8vIGZhaWxlZCB0byBhY3F1aXJlIGNvbm5lY3Rpb25cbiAgICAgICAgLy9sb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICBkZWJ1Z2xvZygnRXJyb3IgY29ubmVjdGluZyB0byBkYicgKyBlcnIpO1xuICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIHF1ZXJ5ID1gSU5TRVJUIElOVE8gbG9nY29udiAoYCArIGNvbHVtbnMuam9pbihcIixcIikgKyBcIikgXCIgK1xuICAgICAgICAvLyAgIChjb252aWQsIHNlc3Npb25pZCwgdXNlciwgbWVzc2FnZSwgcmVzcG9uc2UsIG1ldGEpIGAgK1xuICAgICAgICBcIlZBTFVFUyAoIFwiICArXG4gICAgICAgIC8vICQxLCAkMiwgLi4uXG4gICAgICAgICBjb2x1bW5zLm1hcChmdW5jdGlvbihvLGlJbmRleCkgeyByZXR1cm4gXCIkXCIgKyAoaUluZGV4KzEpOyB9KS5qb2luKFwiLCBcIikgKyBcIilcIjtcblxuICAgICAgICB2YXIgdmFsdWVzID0gY29sdW1ucy5tYXAoZnVuY3Rpb24oc0NvbCkge1xuICAgICAgICAgICAgIHJldHVybiBvTG9nRW50cnlbc0NvbF07XG4gICAgICAgICAgIH0pO1xuICAgICAgICAgICAvLyAgW2xldmVsLCBtc2csIG1ldGEgaW5zdGFuY2VvZiBBcnJheSA/IEpTT04uc3RyaW5naWZ5KG1ldGEpIDogbWV0YV0sXG5cbiAgICAgICAgY2xpZW50LnF1ZXJ5KHF1ZXJ5LHZhbHVlcyxcblxuICAgICAgICAgICAgICAgICAgICAgKGVyciwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBwZ0RvbmUoKTtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAvLyBsb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgIGRlYnVnbG9nKCdFcnJvciBpbnNlcnRpbmcgcmVjb3JkIGludG8gZGIgJyArIGVyciArICdcXG4nICtcbiAgICAgICAgICAgICAgICB2YWx1ZXMuam9pbihcIlxcblwiKSk7XG4gICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gIGxvZ2dlci5lbWl0KCdsb2dnZWQnKTtcbiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbnZhciBsb2dnZXJzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBJTG9nZ2VyIH07XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dnZXIobmFtZTogc3RyaW5nLCBkYnVybCA6IHN0cmluZywgcGc6IGFueSkgOiAoYTogSUFuc3dlciwgY2FsbGJhY2s/OiAoZXJyOmFueSwgcmVzPyA6YW55KSA9PiB2b2lkKSA9PiB2b2lkICB7XG4gIGlmICghZGJ1cmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ25lZWQgZGF0YWJhc2UgdXJsJyk7XG4gIH1cbiAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiIHx8ICEvXltBLVphLXpdW0EtWmEtejAtOV9dKyQvLmV4ZWMobmFtZSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJylcbiAgfVxuICBpZiAoIWxvZ2dlcnNbbmFtZV0pIHtcbiAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgIG5hbWU6IG5hbWUsXG4gICAgICBkYnVybDogZGJ1cmwsXG4gICAgICBwZyA6IHBnXG4gICAgfSBhcyBJTG9nZ2VyO1xuICAgIGFsb2dnZXIubG9nSXQgPSBsb2dBbnN3ZXIuYmluZChhbG9nZ2VyKTtcbiAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgfVxuICBpZiAobG9nZ2Vyc1tuYW1lXS5kYnVybCAhPT0gZGJ1cmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZsYWdzIG1pc21hdGNoIGluIGxvZ2dlcicgKyBuYW1lKTtcbiAgfVxuICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn0iLCIvKipcbiAqIGEgbG9nZ2VyIGZvciBkaWFsb2cgY29udmVyc2F0aW9uc1xuICovXG4vL2RlY2xhcmUgbW9kdWxlIHBnIHt9O1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIik7XG52YXIgcHJvY2VzcyA9IHJlcXVpcmUoXCJwcm9jZXNzXCIpO1xuZXhwb3J0cy5zcWxBY3RpdmUgPSAhIShwcm9jZXNzLmVudi5BQk9UX0xPR0RCKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdkaWFsb2dsb2dnZXInKTtcbjtcbjtcbnZhciBjb2x1bW5zID0gW1wiYm90aWRcIiwgXCJ1c2VyaWRcIiwgXCJtZXNzYWdlXCIsIFwicmVzcG9uc2VcIiwgXCJhY3Rpb25cIiwgXCJpbnRlbnRcIiwgXCJjb252ZXJzYXRpb25pZFwiLCBcIm1ldGFcIiwgXCJkZWx0YVwiXTtcbi8vIDAgaW5kaWNhdGVzIGRvIG5vdCBwcm9jZXNzIC90cnVuY2F0ZSwgZS5nLiBub24gc3RyaW5nIHR5cGVcbnZhciBjb2x1bW5MZW5ndGhzID0gWzEwLCA0MCwgMTAyNCwgMTAyNCwgNTEyLCAyMCwgNDAsIDAsIDBdO1xuZnVuY3Rpb24gYXNzdXJlQ29sdW1uTGVuZ3RoTm90RXhjZWVkZWQob2JqKSB7XG4gICAgY29sdW1ucy5mb3JFYWNoKGZ1bmN0aW9uIChzQ29sLCBpSW5kZXgpIHtcbiAgICAgICAgaWYgKGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiB0eXBlb2Ygb2JqW3NDb2xdICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBkZWJ1Z2xvZyhcIlVuZXhwZWN0ZWQgbm9uLXN0cmluZyB2YWx1ZSBcIiArIEpTT04uc3RyaW5naWZ5KG9ialtzQ29sXSkpO1xuICAgICAgICAgICAgb2JqW3NDb2xdID0gXCJcIiArIG9ialtzQ29sXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAob2JqW3NDb2xdICYmIGNvbHVtbkxlbmd0aHNbaUluZGV4XSAmJiBvYmpbc0NvbF0ubGVuZ3RoID4gY29sdW1uTGVuZ3Roc1tpSW5kZXhdKSB7XG4gICAgICAgICAgICBvYmpbc0NvbF0gPSBvYmpbc0NvbF0uc3Vic3RyaW5nKDAsIGNvbHVtbkxlbmd0aHNbaUluZGV4XSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gb2JqO1xufVxuZXhwb3J0cy5hc3N1cmVDb2x1bW5MZW5ndGhOb3RFeGNlZWRlZCA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkO1xuZnVuY3Rpb24gbG9nQW5zd2VyKGFuc3dlciwgY2FsbGJhY2ssIEZvcmNlU3FsQWN0aXZlKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCAoZnVuY3Rpb24gKCkgeyB9KTtcbiAgICB2YXIgc2Vzc2lvbiA9IGFuc3dlci5zZXNzaW9uO1xuICAgIHZhciBzcWxJc0FjdGl2ZSA9IEZvcmNlU3FsQWN0aXZlIHx8IGV4cG9ydHMuc3FsQWN0aXZlO1xuICAgIHZhciBwZyA9IHRoaXMucGc7XG4gICAgZGVidWdsb2coXCJoZXJlIHVzZXIgaWQgb2YgbWVzc2FnZSBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcyBcIiArXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIpKTtcbiAgICB2YXIgb0xvZ0VudHJ5ID0ge1xuICAgICAgICBib3RpZDogKHNlc3Npb24ubWVzc2FnZSAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcyAmJiBzZXNzaW9uLm1lc3NhZ2UuYWRkcmVzcy5ib3QgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuYm90LmlkKSB8fCB0aGlzLm5hbWUsXG4gICAgICAgIHVzZXJpZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXJcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLnVzZXIuaWQgfHwgXCJcIixcbiAgICAgICAgbWVzc2FnZTogc2Vzc2lvbi5tZXNzYWdlLnRleHQsXG4gICAgICAgIHJlc3BvbnNlOiBhbnN3ZXIucmVzcG9uc2UsXG4gICAgICAgIGFjdGlvbjogYW5zd2VyLmFjdGlvbixcbiAgICAgICAgaW50ZW50OiBhbnN3ZXIuaW50ZW50LFxuICAgICAgICBjb252ZXJzYXRpb25pZDogc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3NcbiAgICAgICAgICAgICYmIHNlc3Npb24ubWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvblxuICAgICAgICAgICAgJiYgc2Vzc2lvbi5tZXNzYWdlLmFkZHJlc3MuY29udmVyc2F0aW9uLmlkIHx8IFwiXCIsXG4gICAgICAgIG1ldGE6IGFuc3dlci5yZXN1bHQgfHwge30sXG4gICAgICAgIGRlbHRhOiBEYXRlLm5vdygpIC0gRGF0ZS5wYXJzZShzZXNzaW9uLm1lc3NhZ2UudGltZXN0YW1wKSxcbiAgICB9O1xuICAgIG9Mb2dFbnRyeSA9IGFzc3VyZUNvbHVtbkxlbmd0aE5vdEV4Y2VlZGVkKG9Mb2dFbnRyeSk7XG4gICAgZGVidWdsb2coXCJzcWxJc0FjdGl2ZVwiICsgc3FsSXNBY3RpdmUpO1xuICAgIGlmICghc3FsSXNBY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBwZy5jb25uZWN0KHRoaXMuZGJ1cmwsIGZ1bmN0aW9uIChlcnIsIGNsaWVudCwgcGdEb25lKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIC8vIGZhaWxlZCB0byBhY3F1aXJlIGNvbm5lY3Rpb25cbiAgICAgICAgICAgIC8vbG9nZ2VyLmVtaXQoJ2Vycm9yJywgZXJyKTtcbiAgICAgICAgICAgIGRlYnVnbG9nKCdFcnJvciBjb25uZWN0aW5nIHRvIGRiJyArIGVycik7XG4gICAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gXCJJTlNFUlQgSU5UTyBsb2djb252IChcIiArIGNvbHVtbnMuam9pbihcIixcIikgKyBcIikgXCIgK1xuICAgICAgICAgICAgICAgIC8vICAgKGNvbnZpZCwgc2Vzc2lvbmlkLCB1c2VyLCBtZXNzYWdlLCByZXNwb25zZSwgbWV0YSkgYCArXG4gICAgICAgICAgICAgICAgXCJWQUxVRVMgKCBcIiArXG4gICAgICAgICAgICAgICAgLy8gJDEsICQyLCAuLi5cbiAgICAgICAgICAgICAgICBjb2x1bW5zLm1hcChmdW5jdGlvbiAobywgaUluZGV4KSB7IHJldHVybiBcIiRcIiArIChpSW5kZXggKyAxKTsgfSkuam9pbihcIiwgXCIpICsgXCIpXCI7XG4gICAgICAgICAgICB2YXIgdmFsdWVzID0gY29sdW1ucy5tYXAoZnVuY3Rpb24gKHNDb2wpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb0xvZ0VudHJ5W3NDb2xdO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyAgW2xldmVsLCBtc2csIG1ldGEgaW5zdGFuY2VvZiBBcnJheSA/IEpTT04uc3RyaW5naWZ5KG1ldGEpIDogbWV0YV0sXG4gICAgICAgICAgICBjbGllbnQucXVlcnkocXVlcnksIHZhbHVlcywgZnVuY3Rpb24gKGVyciwgcmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgcGdEb25lKCk7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAvLyBsb2dnZXIuZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICBkZWJ1Z2xvZygnRXJyb3IgaW5zZXJ0aW5nIHJlY29yZCBpbnRvIGRiICcgKyBlcnIgKyAnXFxuJyArXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMuam9pbihcIlxcblwiKSk7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyAgbG9nZ2VyLmVtaXQoJ2xvZ2dlZCcpO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuZXhwb3J0cy5sb2dBbnN3ZXIgPSBsb2dBbnN3ZXI7XG52YXIgbG9nZ2VycyA9IHt9O1xuZnVuY3Rpb24gbG9nZ2VyKG5hbWUsIGRidXJsLCBwZykge1xuICAgIGlmICghZGJ1cmwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCduZWVkIGRhdGFiYXNlIHVybCcpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIgfHwgIS9eW0EtWmEtel1bQS1aYS16MC05X10rJC8uZXhlYyhuYW1lKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJyk7XG4gICAgfVxuICAgIGlmICghbG9nZ2Vyc1tuYW1lXSkge1xuICAgICAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBkYnVybDogZGJ1cmwsXG4gICAgICAgICAgICBwZzogcGdcbiAgICAgICAgfTtcbiAgICAgICAgYWxvZ2dlci5sb2dJdCA9IGxvZ0Fuc3dlci5iaW5kKGFsb2dnZXIpO1xuICAgICAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgICB9XG4gICAgaWYgKGxvZ2dlcnNbbmFtZV0uZGJ1cmwgIT09IGRidXJsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRmxhZ3MgbWlzbWF0Y2ggaW4gbG9nZ2VyJyArIG5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn1cbmV4cG9ydHMubG9nZ2VyID0gbG9nZ2VyO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
