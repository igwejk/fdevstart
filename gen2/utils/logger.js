/**
 * a simple logger utility
 *
 *
 * There are two types of logs ( append and overwrite, default is append)
 */
"use strict";
// <reference path="../../lib/node-4.d.ts" />

var debug = require('debug');
var debuglog = debug('logger');
;
var perfs = {};
function logPerf(sString) {
    if (!this || !this.enabled) {
        return;
    }
    var label = 'perf' + this.name;
    console.log('Perf' + this.name);
    if (this.first === 0) {
        this.first = Date.now();
    } else {
        console.log('Perf' + this.name + ' total ' + (Date.now() - this.first));
    }
    if (this.on[sString]) {
        console.timeEnd(sString);
        delete this.on[sString];
    } else {
        console.time(sString);
        this.on[sString] = 1;
    }
}
function perf(string) {
    perfs[string] = { name: string, last: 0, first: 0, on: {}, enabled: false };
    if (debug('perf' + string).enabled) {
        perfs[string].enabled = true;
    }
    return logPerf.bind(perfs[string]);
}
exports.perf = perf;
var fs = require('fs');
var loggers = {};
var os = require('os');
function getWritableDir() {
    // return process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
    return os.tmpdir();
}
function setupOnce() {
    var home = getWritableDir();
    try {
        fs.mkdirSync(home + '/' + 'fdevstart');
    } catch (e) {}
    try {
        fs.mkdirSync(home + '/fdevstart/logs');
    } catch (e) {}
}
setupOnce();
function getFileName(name) {
    return os.tmpdir() + '/fdevstart/logs/' + name + ".log";
}
exports._test = {
    getFileName: getFileName
};
function logIt(logger, arg) {
    var text;
    if (typeof arg === "string") {
        text = arg;
    } else if (arg instanceof Error) {
        text = "Error:" + arg.message + " " + arg.stack;
    }
    if (!text) {
        throw new Error("Illegal argument to log");
    }
    var filename = getFileName(logger.name);
    var d = new Date();
    var n = d.toUTCString() + "\t" + text;
    debuglog('writing log entry to ' + filename + ' ' + n);
    fs.writeFileSync(filename, n, { encoding: 'utf-8', flag: 'a' });
}
function logger(name, flags) {
    if (flags !== 'a' && flags !== '' && flags !== undefined) {
        throw new Error('only a allowed as flags');
    }
    flags = flags === undefined ? 'a' : flags;
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            flags: flags
        };
        alogger.logIt = logIt.bind(undefined, alogger);
        // reset the file
        if (flags === '') {
            try {
                fs.unlinkSync(getFileName(name));
            } catch (e) {
                debuglog("***ERROR: unable to remove log file " + getFileName(name));
            }
        }
        loggers[name] = alogger;
    }
    if (loggers[name].flags !== flags) {
        throw new Error('FLags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9sb2dnZXIudHMiLCJ1dGlscy9sb2dnZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJwZXJmcyIsImxvZ1BlcmYiLCJzU3RyaW5nIiwiZW5hYmxlZCIsImxhYmVsIiwibmFtZSIsImNvbnNvbGUiLCJsb2ciLCJmaXJzdCIsIkRhdGUiLCJub3ciLCJvbiIsInRpbWVFbmQiLCJ0aW1lIiwicGVyZiIsInN0cmluZyIsImxhc3QiLCJiaW5kIiwiZXhwb3J0cyIsImZzIiwibG9nZ2VycyIsIm9zIiwiZ2V0V3JpdGFibGVEaXIiLCJ0bXBkaXIiLCJzZXR1cE9uY2UiLCJob21lIiwibWtkaXJTeW5jIiwiZSIsImdldEZpbGVOYW1lIiwiX3Rlc3QiLCJsb2dJdCIsImxvZ2dlciIsImFyZyIsInRleHQiLCJFcnJvciIsIm1lc3NhZ2UiLCJzdGFjayIsImZpbGVuYW1lIiwiZCIsIm4iLCJ0b1VUQ1N0cmluZyIsIndyaXRlRmlsZVN5bmMiLCJlbmNvZGluZyIsImZsYWciLCJmbGFncyIsInVuZGVmaW5lZCIsImV4ZWMiLCJhbG9nZ2VyIiwidW5saW5rU3luYyJdLCJtYXBwaW5ncyI6IkFBRUE7Ozs7OztBQ0lBO0FER0E7O0FBRUEsSUFBWUEsUUFBS0MsUUFBTSxPQUFOLENBQWpCO0FBRUEsSUFBTUMsV0FBV0YsTUFBTSxRQUFOLENBQWpCO0FBTUM7QUFFRCxJQUFJRyxRQUFRLEVBQVo7QUFFQSxTQUFBQyxPQUFBLENBQWlCQyxPQUFqQixFQUF3QjtBQUN0QixRQUFHLENBQUMsSUFBRCxJQUFTLENBQUMsS0FBS0MsT0FBbEIsRUFBMkI7QUFDekI7QUFDRDtBQUNELFFBQUlDLFFBQVEsU0FBUyxLQUFLQyxJQUExQjtBQUNBQyxZQUFRQyxHQUFSLENBQVksU0FBUyxLQUFLRixJQUExQjtBQUNBLFFBQUcsS0FBS0csS0FBTCxLQUFlLENBQWxCLEVBQXFCO0FBQ2pCLGFBQUtBLEtBQUwsR0FBYUMsS0FBS0MsR0FBTCxF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LFVBQVUsR0FBVixJQUFpQkEsVUFBVSxFQUEzQixJQUFpQ0EsVUFBVUMsU0FBL0MsRUFBMEQ7QUFDeEQsY0FBTSxJQUFJWCxLQUFKLENBQVUseUJBQVYsQ0FBTjtBQUNEO0FBQ0RVLFlBQVNBLFVBQVVDLFNBQVgsR0FBeUIsR0FBekIsR0FBK0JELEtBQXZDO0FBQ0EsUUFBSSxPQUFPdkMsSUFBUCxLQUFnQixRQUFoQixJQUE0QixDQUFDLDBCQUEwQnlDLElBQTFCLENBQStCekMsSUFBL0IsQ0FBakMsRUFBdUU7QUFDckUsY0FBTSxJQUFJNkIsS0FBSixDQUFVLDBEQUFWLENBQU47QUFDRDtBQUNELFFBQUksQ0FBQ2QsUUFBUWYsSUFBUixDQUFMLEVBQW9CO0FBQ2xCLFlBQUkwQyxVQUFVO0FBQ1oxQyxrQkFBTUEsSUFETTtBQUVadUMsbUJBQU9BO0FBRkssU0FBZDtBQUlBRyxnQkFBUWpCLEtBQVIsR0FBZ0JBLE1BQU1iLElBQU4sQ0FBVzRCLFNBQVgsRUFBc0JFLE9BQXRCLENBQWhCO0FBQ0E7QUFDQSxZQUFJSCxVQUFVLEVBQWQsRUFBa0I7QUFDaEIsZ0JBQUk7QUFDRnpCLG1CQUFHNkIsVUFBSCxDQUFjcEIsWUFBWXZCLElBQVosQ0FBZDtBQUNBLGFBRkYsQ0FFRSxPQUFPc0IsQ0FBUCxFQUFVO0FBQ1Y1Qix5QkFBUyx5Q0FBeUM2QixZQUFZdkIsSUFBWixDQUFsRDtBQUNEO0FBQ0Y7QUFDRGUsZ0JBQVFmLElBQVIsSUFBZ0IwQyxPQUFoQjtBQUNEO0FBQ0QsUUFBSTNCLFFBQVFmLElBQVIsRUFBY3VDLEtBQWQsS0FBd0JBLEtBQTVCLEVBQW1DO0FBQ2pDLGNBQU0sSUFBSVYsS0FBSixDQUFVLDZCQUE2QjdCLElBQXZDLENBQU47QUFDRDtBQUNELFdBQU9lLFFBQVFmLElBQVIsRUFBY3lCLEtBQXJCO0FBQ0Q7QUE1QmVaLFFBQUFhLE1BQUEsR0FBTUEsTUFBTiIsImZpbGUiOiJ1dGlscy9sb2dnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcblxuLyoqXG4gKiBhIHNpbXBsZSBsb2dnZXIgdXRpbGl0eVxuICpcbiAqXG4gKiBUaGVyZSBhcmUgdHdvIHR5cGVzIG9mIGxvZ3MgKCBhcHBlbmQgYW5kIG92ZXJ3cml0ZSwgZGVmYXVsdCBpcyBhcHBlbmQpXG4gKi9cblxuLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vbGliL25vZGUtNC5kLnRzXCIgLz5cblxuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1Z2xvZyA9IGRlYnVnKCdsb2dnZXInKTtcblxuaW50ZXJmYWNlIElMb2dnZXIge1xuICBuYW1lOiBzdHJpbmcsXG4gIGZsYWdzOiBzdHJpbmcsXG4gIGxvZ0l0PzogKGFueSkgPT4gdm9pZFxufTtcblxudmFyIHBlcmZzID0ge30gYXMge1trZXkgOiBzdHJpbmddIDogeyBlbmFibGVkIDogYm9vbGVhbiwgbmFtZSA6IHN0cmluZywgbGFzdDogbnVtYmVyLCBmaXJzdCA6IG51bWJlciwgb24gOiB7fX19O1xuXG5mdW5jdGlvbiBsb2dQZXJmKHNTdHJpbmcpIHtcbiAgaWYoIXRoaXMgfHwgIXRoaXMuZW5hYmxlZCkge1xuICAgIHJldHVybjtcbiAgfVxuICB2YXIgbGFiZWwgPSAncGVyZicgKyB0aGlzLm5hbWU7XG4gIGNvbnNvbGUubG9nKCdQZXJmJyArIHRoaXMubmFtZSk7XG4gIGlmKHRoaXMuZmlyc3QgPT09IDApIHtcbiAgICAgIHRoaXMuZmlyc3QgPSBEYXRlLm5vdygpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKCdQZXJmJyArIHRoaXMubmFtZSArICcgdG90YWwgJyArIChEYXRlLm5vdygpIC0gdGhpcy5maXJzdCkpO1xuICB9XG4gIGlmKCB0aGlzLm9uW3NTdHJpbmddKSB7XG4gICAgIGNvbnNvbGUudGltZUVuZChzU3RyaW5nKVxuICAgICBkZWxldGUgdGhpcy5vbltzU3RyaW5nXTtcbiAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUudGltZShzU3RyaW5nKTtcbiAgICAgIHRoaXMub25bc1N0cmluZ10gPSAxO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZXJmKHN0cmluZykge1xuICBwZXJmc1tzdHJpbmddID0geyBuYW1lIDogc3RyaW5nLCBsYXN0IDogMCwgZmlyc3Q6IDAsIG9uIDoge30sIGVuYWJsZWQgOiBmYWxzZSB9O1xuICBpZiAoZGVidWcoJ3BlcmYnICsgc3RyaW5nKS5lbmFibGVkIClcbiAgeyBwZXJmc1tzdHJpbmddLmVuYWJsZWQgPSB0cnVlO1xuICB9XG4gIHJldHVybiBsb2dQZXJmLmJpbmQocGVyZnNbc3RyaW5nXSk7XG59XG5cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcblxudmFyIGxvZ2dlcnMgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IElMb2dnZXIgfTtcblxudmFyIG9zID0gcmVxdWlyZSgnb3MnKTtcblxuZnVuY3Rpb24gZ2V0V3JpdGFibGVEaXIoKSB7XG4gIC8vIHJldHVybiBwcm9jZXNzLmVudlsocHJvY2Vzcy5wbGF0Zm9ybSA9PSAnd2luMzInKSA/ICdVU0VSUFJPRklMRScgOiAnSE9NRSddO1xuICByZXR1cm4gb3MudG1wZGlyKCk7XG59XG5cblxuZnVuY3Rpb24gc2V0dXBPbmNlKCkge1xuXG4gIHZhciBob21lID0gZ2V0V3JpdGFibGVEaXIoKTtcbiAgdHJ5IHtcbiAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvJyArICdmZGV2c3RhcnQnICk7XG4gIH0gY2F0Y2ggKGUpIHtcblxuICB9XG4gIHRyeSB7XG4gICAgZnMubWtkaXJTeW5jKGhvbWUgKyAnL2ZkZXZzdGFydC9sb2dzJyApO1xuICB9IGNhdGNoKGUpIHtcblxuICB9XG59XG5zZXR1cE9uY2UoKTtcblxuXG5mdW5jdGlvbiBnZXRGaWxlTmFtZShuYW1lOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG9zLnRtcGRpcigpICArICcvZmRldnN0YXJ0L2xvZ3MvJyArIG5hbWUgKyBcIi5sb2dcIjtcbn1cblxuZXhwb3J0IGNvbnN0IF90ZXN0ID0ge1xuICBnZXRGaWxlTmFtZTogZ2V0RmlsZU5hbWVcbn07XG5cbmZ1bmN0aW9uIGxvZ0l0KGxvZ2dlcjogSUxvZ2dlciwgYXJnKSB7XG4gIHZhciB0ZXh0OiBzdHJpbmc7XG4gIGlmICh0eXBlb2YgYXJnID09PSBcInN0cmluZ1wiKSB7XG4gICAgdGV4dCA9IGFyZztcbiAgfSBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgIHRleHQgPSBcIkVycm9yOlwiICsgYXJnLm1lc3NhZ2UgKyBcIiBcIiArIGFyZy5zdGFjaztcbiAgfVxuICBpZiAoIXRleHQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbGxlZ2FsIGFyZ3VtZW50IHRvIGxvZ1wiKTtcbiAgfVxuICB2YXIgZmlsZW5hbWUgPSBnZXRGaWxlTmFtZShsb2dnZXIubmFtZSk7XG4gIHZhciBkID0gbmV3IERhdGUoKTtcbiAgdmFyIG4gPSBkLnRvVVRDU3RyaW5nKCkgKyBcIlxcdFwiICsgdGV4dDtcbiAgZGVidWdsb2coJ3dyaXRpbmcgbG9nIGVudHJ5IHRvICcgKyBmaWxlbmFtZSArICcgJyArIG4pO1xuICBmcy53cml0ZUZpbGVTeW5jKGZpbGVuYW1lLCBuLCB7IGVuY29kaW5nOiAndXRmLTgnLCBmbGFnOiAnYScgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dnZXIobmFtZTogc3RyaW5nLCBmbGFncz86IHN0cmluZyk6IChhbnkpID0+IHZvaWQge1xuICBpZiAoZmxhZ3MgIT09ICdhJyAmJiBmbGFncyAhPT0gJycgJiYgZmxhZ3MgIT09IHVuZGVmaW5lZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignb25seSBhIGFsbG93ZWQgYXMgZmxhZ3MnKTtcbiAgfVxuICBmbGFncyA9IChmbGFncyA9PT0gdW5kZWZpbmVkICk/ICAnYScgOiBmbGFncztcbiAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiIHx8ICEvXltBLVphLXpdW0EtWmEtejAtOV9dKyQvLmV4ZWMobmFtZSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJylcbiAgfVxuICBpZiAoIWxvZ2dlcnNbbmFtZV0pIHtcbiAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgIG5hbWU6IG5hbWUsXG4gICAgICBmbGFnczogZmxhZ3NcbiAgICB9IGFzIElMb2dnZXI7XG4gICAgYWxvZ2dlci5sb2dJdCA9IGxvZ0l0LmJpbmQodW5kZWZpbmVkLCBhbG9nZ2VyKTtcbiAgICAvLyByZXNldCB0aGUgZmlsZVxuICAgIGlmIChmbGFncyA9PT0gJycpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGZzLnVubGlua1N5bmMoZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBkZWJ1Z2xvZyhcIioqKkVSUk9SOiB1bmFibGUgdG8gcmVtb3ZlIGxvZyBmaWxlIFwiICsgZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgfVxuICAgIH1cbiAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgfVxuICBpZiAobG9nZ2Vyc1tuYW1lXS5mbGFncyAhPT0gZmxhZ3MpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZMYWdzIG1pc21hdGNoIGluIGxvZ2dlcicgKyBuYW1lKTtcbiAgfVxuICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn0iLCIvKipcbiAqIGEgc2ltcGxlIGxvZ2dlciB1dGlsaXR5XG4gKlxuICpcbiAqIFRoZXJlIGFyZSB0d28gdHlwZXMgb2YgbG9ncyAoIGFwcGVuZCBhbmQgb3ZlcndyaXRlLCBkZWZhdWx0IGlzIGFwcGVuZClcbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG4vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdsb2dnZXInKTtcbjtcbnZhciBwZXJmcyA9IHt9O1xuZnVuY3Rpb24gbG9nUGVyZihzU3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzIHx8ICF0aGlzLmVuYWJsZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbGFiZWwgPSAncGVyZicgKyB0aGlzLm5hbWU7XG4gICAgY29uc29sZS5sb2coJ1BlcmYnICsgdGhpcy5uYW1lKTtcbiAgICBpZiAodGhpcy5maXJzdCA9PT0gMCkge1xuICAgICAgICB0aGlzLmZpcnN0ID0gRGF0ZS5ub3coKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQZXJmJyArIHRoaXMubmFtZSArICcgdG90YWwgJyArIChEYXRlLm5vdygpIC0gdGhpcy5maXJzdCkpO1xuICAgIH1cbiAgICBpZiAodGhpcy5vbltzU3RyaW5nXSkge1xuICAgICAgICBjb25zb2xlLnRpbWVFbmQoc1N0cmluZyk7XG4gICAgICAgIGRlbGV0ZSB0aGlzLm9uW3NTdHJpbmddO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY29uc29sZS50aW1lKHNTdHJpbmcpO1xuICAgICAgICB0aGlzLm9uW3NTdHJpbmddID0gMTtcbiAgICB9XG59XG5mdW5jdGlvbiBwZXJmKHN0cmluZykge1xuICAgIHBlcmZzW3N0cmluZ10gPSB7IG5hbWU6IHN0cmluZywgbGFzdDogMCwgZmlyc3Q6IDAsIG9uOiB7fSwgZW5hYmxlZDogZmFsc2UgfTtcbiAgICBpZiAoZGVidWcoJ3BlcmYnICsgc3RyaW5nKS5lbmFibGVkKSB7XG4gICAgICAgIHBlcmZzW3N0cmluZ10uZW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiBsb2dQZXJmLmJpbmQocGVyZnNbc3RyaW5nXSk7XG59XG5leHBvcnRzLnBlcmYgPSBwZXJmO1xudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciBsb2dnZXJzID0ge307XG52YXIgb3MgPSByZXF1aXJlKCdvcycpO1xuZnVuY3Rpb24gZ2V0V3JpdGFibGVEaXIoKSB7XG4gICAgLy8gcmV0dXJuIHByb2Nlc3MuZW52Wyhwcm9jZXNzLnBsYXRmb3JtID09ICd3aW4zMicpID8gJ1VTRVJQUk9GSUxFJyA6ICdIT01FJ107XG4gICAgcmV0dXJuIG9zLnRtcGRpcigpO1xufVxuZnVuY3Rpb24gc2V0dXBPbmNlKCkge1xuICAgIHZhciBob21lID0gZ2V0V3JpdGFibGVEaXIoKTtcbiAgICB0cnkge1xuICAgICAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvJyArICdmZGV2c3RhcnQnKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgICAgZnMubWtkaXJTeW5jKGhvbWUgKyAnL2ZkZXZzdGFydC9sb2dzJyk7XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgfVxufVxuc2V0dXBPbmNlKCk7XG5mdW5jdGlvbiBnZXRGaWxlTmFtZShuYW1lKSB7XG4gICAgcmV0dXJuIG9zLnRtcGRpcigpICsgJy9mZGV2c3RhcnQvbG9ncy8nICsgbmFtZSArIFwiLmxvZ1wiO1xufVxuZXhwb3J0cy5fdGVzdCA9IHtcbiAgICBnZXRGaWxlTmFtZTogZ2V0RmlsZU5hbWVcbn07XG5mdW5jdGlvbiBsb2dJdChsb2dnZXIsIGFyZykge1xuICAgIHZhciB0ZXh0O1xuICAgIGlmICh0eXBlb2YgYXJnID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHRleHQgPSBhcmc7XG4gICAgfVxuICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgIHRleHQgPSBcIkVycm9yOlwiICsgYXJnLm1lc3NhZ2UgKyBcIiBcIiArIGFyZy5zdGFjaztcbiAgICB9XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIklsbGVnYWwgYXJndW1lbnQgdG8gbG9nXCIpO1xuICAgIH1cbiAgICB2YXIgZmlsZW5hbWUgPSBnZXRGaWxlTmFtZShsb2dnZXIubmFtZSk7XG4gICAgdmFyIGQgPSBuZXcgRGF0ZSgpO1xuICAgIHZhciBuID0gZC50b1VUQ1N0cmluZygpICsgXCJcXHRcIiArIHRleHQ7XG4gICAgZGVidWdsb2coJ3dyaXRpbmcgbG9nIGVudHJ5IHRvICcgKyBmaWxlbmFtZSArICcgJyArIG4pO1xuICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZW5hbWUsIG4sIHsgZW5jb2Rpbmc6ICd1dGYtOCcsIGZsYWc6ICdhJyB9KTtcbn1cbmZ1bmN0aW9uIGxvZ2dlcihuYW1lLCBmbGFncykge1xuICAgIGlmIChmbGFncyAhPT0gJ2EnICYmIGZsYWdzICE9PSAnJyAmJiBmbGFncyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignb25seSBhIGFsbG93ZWQgYXMgZmxhZ3MnKTtcbiAgICB9XG4gICAgZmxhZ3MgPSAoZmxhZ3MgPT09IHVuZGVmaW5lZCkgPyAnYScgOiBmbGFncztcbiAgICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIgfHwgIS9eW0EtWmEtel1bQS1aYS16MC05X10rJC8uZXhlYyhuYW1lKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJyk7XG4gICAgfVxuICAgIGlmICghbG9nZ2Vyc1tuYW1lXSkge1xuICAgICAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBmbGFnczogZmxhZ3NcbiAgICAgICAgfTtcbiAgICAgICAgYWxvZ2dlci5sb2dJdCA9IGxvZ0l0LmJpbmQodW5kZWZpbmVkLCBhbG9nZ2VyKTtcbiAgICAgICAgLy8gcmVzZXQgdGhlIGZpbGVcbiAgICAgICAgaWYgKGZsYWdzID09PSAnJykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBmcy51bmxpbmtTeW5jKGdldEZpbGVOYW1lKG5hbWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCIqKipFUlJPUjogdW5hYmxlIHRvIHJlbW92ZSBsb2cgZmlsZSBcIiArIGdldEZpbGVOYW1lKG5hbWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgICB9XG4gICAgaWYgKGxvZ2dlcnNbbmFtZV0uZmxhZ3MgIT09IGZsYWdzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRkxhZ3MgbWlzbWF0Y2ggaW4gbG9nZ2VyJyArIG5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn1cbmV4cG9ydHMubG9nZ2VyID0gbG9nZ2VyO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
