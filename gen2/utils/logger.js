/**
 * a simple logger utility
 *
 *
 * There are two types of logs ( append and overwrite, default is append)
 */
"use strict";
// <reference path="../../lib/node-4.d.ts" />

var debug = require("debug");
var debuglog = debug('logger');
;
var perfs = {};
function logPerf(cons, sString) {
    if (!this || !this.enabled) {
        return;
    }
    var label = 'perf' + this.name;
    cons.log('Perf' + this.name);
    if (this.first === 0) {
        this.first = Date.now();
        this.last = this.first;
    } else {
        var t = Date.now();
        cons.log('Perf' + this.name + ' delta: ' + String("      " + (t - this.last)).slice(-6) + ' total: ' + String("      " + (t - this.first)).slice(-6));
        this.last = t;
    }
    if (this.on[sString]) {
        cons.timeEnd(sString);
        delete this.on[sString];
    } else {
        cons.time(sString);
        this.on[sString] = 1;
    }
}
exports.logPerf = logPerf;
function perf(string) {
    perfs[string] = { name: string, last: 0, first: 0, on: {}, enabled: false };
    if (debug('perf' + string).enabled) {
        perfs[string].enabled = true;
    }
    return logPerf.bind(perfs[string], console);
}
exports.perf = perf;
var fs = require("fs");
var loggers = {};
var os = require('os');
function getWritableDir() {
    // return process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
    return os.tmpdir();
}
function setupOnce() {
    var home = getWritableDir();
    try {
        fs.mkdirSync(home + '/' + 'fdevstart');
    } catch (e) {}
    try {
        fs.mkdirSync(home + '/fdevstart/logs');
    } catch (e) {}
}
setupOnce();
function getFileName(name) {
    return os.tmpdir() + '/fdevstart/logs/' + name + ".log";
}
exports._test = {
    getFileName: getFileName
};
function logIt(logger, arg) {
    var text;
    if (typeof arg === "string") {
        text = arg;
    } else if (arg instanceof Error) {
        text = "Error:" + arg.message + " " + arg.stack;
    }
    if (!text) {
        throw new Error("Illegal argument to log");
    }
    var filename = getFileName(logger.name);
    var d = new Date();
    var n = d.toUTCString() + "\t" + text;
    debuglog('writing log entry to ' + filename + ' ' + n);
    fs.writeFileSync(filename, n, { encoding: 'utf-8', flag: 'a' });
}
function logger(name, flags) {
    if (flags !== 'a' && flags !== '' && flags !== undefined) {
        throw new Error('only a allowed as flags');
    }
    flags = flags === undefined ? 'a' : flags;
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            flags: flags
        };
        alogger.logIt = logIt.bind(undefined, alogger);
        // reset the file
        if (flags === '') {
            try {
                fs.unlinkSync(getFileName(name));
            } catch (e) {
                debuglog("***ERROR: unable to remove log file " + getFileName(name));
            }
        }
        loggers[name] = alogger;
    }
    if (loggers[name].flags !== flags) {
        throw new Error('FLags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9sb2dnZXIudHMiLCJ1dGlscy9sb2dnZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJwZXJmcyIsImxvZ1BlcmYiLCJjb25zIiwic1N0cmluZyIsImVuYWJsZWQiLCJsYWJlbCIsIm5hbWUiLCJsb2ciLCJmaXJzdCIsIkRhdGUiLCJub3ciLCJsYXN0IiwidCIsIlN0cmluZyIsInNsaWNlIiwib24iLCJ0aW1lRW5kIiwidGltZSIsImV4cG9ydHMiLCJwZXJmIiwic3RyaW5nIiwiYmluZCIsImNvbnNvbGUiLCJmcyIsImxvZ2dlcnMiLCJvcyIsImdldFdyaXRhYmxlRGlyIiwidG1wZGlyIiwic2V0dXBPbmNlIiwiaG9tZSIsIm1rZGlyU3luYyIsImUiLCJnZXRGaWxlTmFtZSIsIl90ZXN0IiwibG9nSXQiLCJsb2dnZXIiLCJhcmciLCJ0ZXh0IiwiRXJyb3IiLCJtZXNzYWdlIiwic3RhY2siLCJmaWxlbmFtZSIsImQiLCJuIiwidG9VVENTdHJpbmciLCJ3cml0ZUZpbGVTeW5jIiwiZW5jb2RpbmciLCJmbGFnIiwiZmxhZ3MiLCJ1bmRlZmluZWQiLCJleGVjIiwiYWxvZ2dlciIsInVubGlua1N5bmMiXSwibWFwcGluZ3MiOiJBQUVBOzs7Ozs7QUNJQTtBREdBOztBQUVBLElBQUFBLFFBQUFDLFFBQUEsT0FBQSxDQUFBO0FBRUEsSUFBTUMsV0FBV0YsTUFBTSxRQUFOLENBQWpCO0FBTUM7QUFFRCxJQUFJRyxRQUFRLEVBQVo7QUFFQSxTQUFBQyxPQUFBLENBQXdCQyxJQUF4QixFQUFvQ0MsT0FBcEMsRUFBb0Q7QUFDbEQsUUFBRyxDQUFDLElBQUQsSUFBUyxDQUFDLEtBQUtDLE9BQWxCLEVBQTJCO0FBQ3pCO0FBQ0Q7QUFDRCxRQUFJQyxRQUFRLFNBQVMsS0FBS0MsSUFBMUI7QUFDQUosU0FBS0ssR0FBTCxDQUFTLFNBQVMsS0FBS0QsSUFBdkI7QUFDQSxRQUFHLEtBQUtFLEtBQUwsS0FBZSxDQUFsQixF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RDtBQUNGO0FBQ0RrQixnQkFBUWxCLElBQVIsSUFBZ0I2QyxPQUFoQjtBQUNEO0FBQ0QsUUFBSTNCLFFBQVFsQixJQUFSLEVBQWMwQyxLQUFkLEtBQXdCQSxLQUE1QixFQUFtQztBQUNqQyxjQUFNLElBQUlWLEtBQUosQ0FBVSw2QkFBNkJoQyxJQUF2QyxDQUFOO0FBQ0Q7QUFDRCxXQUFPa0IsUUFBUWxCLElBQVIsRUFBYzRCLEtBQXJCO0FBQ0Q7QUE1QkRoQixRQUFBaUIsTUFBQSxHQUFBQSxNQUFBIiwiZmlsZSI6InV0aWxzL2xvZ2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuXG4vKipcbiAqIGEgc2ltcGxlIGxvZ2dlciB1dGlsaXR5XG4gKlxuICpcbiAqIFRoZXJlIGFyZSB0d28gdHlwZXMgb2YgbG9ncyAoIGFwcGVuZCBhbmQgb3ZlcndyaXRlLCBkZWZhdWx0IGlzIGFwcGVuZClcbiAqL1xuXG4vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxuXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cbmNvbnN0IGRlYnVnbG9nID0gZGVidWcoJ2xvZ2dlcicpO1xuXG5pbnRlcmZhY2UgSUxvZ2dlciB7XG4gIG5hbWU6IHN0cmluZyxcbiAgZmxhZ3M6IHN0cmluZyxcbiAgbG9nSXQ/OiAoYW55KSA9PiB2b2lkXG59O1xuXG52YXIgcGVyZnMgPSB7fSBhcyB7W2tleSA6IHN0cmluZ10gOiB7IGVuYWJsZWQgOiBib29sZWFuLCBuYW1lIDogc3RyaW5nLCBsYXN0OiBudW1iZXIsIGZpcnN0IDogbnVtYmVyLCBvbiA6IHt9fX07XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dQZXJmKGNvbnMgOiBhbnksIHNTdHJpbmcgOiBzdHJpbmcpIHtcbiAgaWYoIXRoaXMgfHwgIXRoaXMuZW5hYmxlZCkge1xuICAgIHJldHVybjtcbiAgfVxuICB2YXIgbGFiZWwgPSAncGVyZicgKyB0aGlzLm5hbWU7XG4gIGNvbnMubG9nKCdQZXJmJyArIHRoaXMubmFtZSk7XG4gIGlmKHRoaXMuZmlyc3QgPT09IDApIHtcbiAgICAgIHRoaXMuZmlyc3QgPSBEYXRlLm5vdygpO1xuICAgICAgdGhpcy5sYXN0ID0gdGhpcy5maXJzdDtcbiAgfSBlbHNlIHtcbiAgICB2YXIgdCA9IERhdGUubm93KCk7XG4gICAgY29ucy5sb2coJ1BlcmYnICsgdGhpcy5uYW1lICtcbiAgICAgJyBkZWx0YTogJyAgKyBTdHJpbmcoXCIgICAgICBcIiArICh0LXRoaXMubGFzdCkpLnNsaWNlKC02KVxuICAgICsnIHRvdGFsOiAnICArIFN0cmluZyhcIiAgICAgIFwiICsgKHQtdGhpcy5maXJzdCkpLnNsaWNlKC02KSk7XG4gICAgdGhpcy5sYXN0ID0gIHQ7XG4gIH1cbiAgaWYodGhpcy5vbltzU3RyaW5nXSkge1xuICAgICBjb25zLnRpbWVFbmQoc1N0cmluZylcbiAgICAgZGVsZXRlIHRoaXMub25bc1N0cmluZ107XG4gIH0gZWxzZSB7XG4gICAgICBjb25zLnRpbWUoc1N0cmluZyk7XG4gICAgICB0aGlzLm9uW3NTdHJpbmddID0gMTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGVyZihzdHJpbmcpIHtcbiAgcGVyZnNbc3RyaW5nXSA9IHsgbmFtZSA6IHN0cmluZywgbGFzdCA6IDAsIGZpcnN0OiAwLCBvbiA6IHt9LCBlbmFibGVkIDogZmFsc2UgfTtcbiAgaWYgKGRlYnVnKCdwZXJmJyArIHN0cmluZykuZW5hYmxlZCApXG4gIHsgcGVyZnNbc3RyaW5nXS5lbmFibGVkID0gdHJ1ZTtcbiAgfVxuICByZXR1cm4gbG9nUGVyZi5iaW5kKHBlcmZzW3N0cmluZ10sIGNvbnNvbGUpO1xufVxuXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5cbnZhciBsb2dnZXJzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBJTG9nZ2VyIH07XG5cbnZhciBvcyA9IHJlcXVpcmUoJ29zJyk7XG5cbmZ1bmN0aW9uIGdldFdyaXRhYmxlRGlyKCkge1xuICAvLyByZXR1cm4gcHJvY2Vzcy5lbnZbKHByb2Nlc3MucGxhdGZvcm0gPT0gJ3dpbjMyJykgPyAnVVNFUlBST0ZJTEUnIDogJ0hPTUUnXTtcbiAgcmV0dXJuIG9zLnRtcGRpcigpO1xufVxuXG5cbmZ1bmN0aW9uIHNldHVwT25jZSgpIHtcblxuICB2YXIgaG9tZSA9IGdldFdyaXRhYmxlRGlyKCk7XG4gIHRyeSB7XG4gICAgZnMubWtkaXJTeW5jKGhvbWUgKyAnLycgKyAnZmRldnN0YXJ0JyApO1xuICB9IGNhdGNoIChlKSB7XG5cbiAgfVxuICB0cnkge1xuICAgIGZzLm1rZGlyU3luYyhob21lICsgJy9mZGV2c3RhcnQvbG9ncycgKTtcbiAgfSBjYXRjaChlKSB7XG5cbiAgfVxufVxuc2V0dXBPbmNlKCk7XG5cblxuZnVuY3Rpb24gZ2V0RmlsZU5hbWUobmFtZTogc3RyaW5nKSB7XG4gIHJldHVybiBvcy50bXBkaXIoKSAgKyAnL2ZkZXZzdGFydC9sb2dzLycgKyBuYW1lICsgXCIubG9nXCI7XG59XG5cbmV4cG9ydCBjb25zdCBfdGVzdCA9IHtcbiAgZ2V0RmlsZU5hbWU6IGdldEZpbGVOYW1lXG59O1xuXG5mdW5jdGlvbiBsb2dJdChsb2dnZXI6IElMb2dnZXIsIGFyZykge1xuICB2YXIgdGV4dDogc3RyaW5nO1xuICBpZiAodHlwZW9mIGFyZyA9PT0gXCJzdHJpbmdcIikge1xuICAgIHRleHQgPSBhcmc7XG4gIH0gZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICB0ZXh0ID0gXCJFcnJvcjpcIiArIGFyZy5tZXNzYWdlICsgXCIgXCIgKyBhcmcuc3RhY2s7XG4gIH1cbiAgaWYgKCF0ZXh0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiSWxsZWdhbCBhcmd1bWVudCB0byBsb2dcIik7XG4gIH1cbiAgdmFyIGZpbGVuYW1lID0gZ2V0RmlsZU5hbWUobG9nZ2VyLm5hbWUpO1xuICB2YXIgZCA9IG5ldyBEYXRlKCk7XG4gIHZhciBuID0gZC50b1VUQ1N0cmluZygpICsgXCJcXHRcIiArIHRleHQ7XG4gIGRlYnVnbG9nKCd3cml0aW5nIGxvZyBlbnRyeSB0byAnICsgZmlsZW5hbWUgKyAnICcgKyBuKTtcbiAgZnMud3JpdGVGaWxlU3luYyhmaWxlbmFtZSwgbiwgeyBlbmNvZGluZzogJ3V0Zi04JywgZmxhZzogJ2EnIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9nZ2VyKG5hbWU6IHN0cmluZywgZmxhZ3M/OiBzdHJpbmcpOiAoYW55KSA9PiB2b2lkIHtcbiAgaWYgKGZsYWdzICE9PSAnYScgJiYgZmxhZ3MgIT09ICcnICYmIGZsYWdzICE9PSB1bmRlZmluZWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ29ubHkgYSBhbGxvd2VkIGFzIGZsYWdzJyk7XG4gIH1cbiAgZmxhZ3MgPSAoZmxhZ3MgPT09IHVuZGVmaW5lZCApPyAgJ2EnIDogZmxhZ3M7XG4gIGlmICh0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIiB8fCAhL15bQS1aYS16XVtBLVphLXowLTlfXSskLy5leGVjKG5hbWUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdMb2dnZXIgbmFtZSBtdXN0IGJlIGF0IGxlYXN0IHR3byBhbHBoYW51bWVyaWMgY2hhcmFjdGVycycpXG4gIH1cbiAgaWYgKCFsb2dnZXJzW25hbWVdKSB7XG4gICAgdmFyIGFsb2dnZXIgPSB7XG4gICAgICBuYW1lOiBuYW1lLFxuICAgICAgZmxhZ3M6IGZsYWdzXG4gICAgfSBhcyBJTG9nZ2VyO1xuICAgIGFsb2dnZXIubG9nSXQgPSBsb2dJdC5iaW5kKHVuZGVmaW5lZCwgYWxvZ2dlcik7XG4gICAgLy8gcmVzZXQgdGhlIGZpbGVcbiAgICBpZiAoZmxhZ3MgPT09ICcnKSB7XG4gICAgICB0cnkge1xuICAgICAgICBmcy51bmxpbmtTeW5jKGdldEZpbGVOYW1lKG5hbWUpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgZGVidWdsb2coXCIqKipFUlJPUjogdW5hYmxlIHRvIHJlbW92ZSBsb2cgZmlsZSBcIiArIGdldEZpbGVOYW1lKG5hbWUpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbG9nZ2Vyc1tuYW1lXSA9IGFsb2dnZXI7XG4gIH1cbiAgaWYgKGxvZ2dlcnNbbmFtZV0uZmxhZ3MgIT09IGZsYWdzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGTGFncyBtaXNtYXRjaCBpbiBsb2dnZXInICsgbmFtZSk7XG4gIH1cbiAgcmV0dXJuIGxvZ2dlcnNbbmFtZV0ubG9nSXQ7XG59IiwiLyoqXG4gKiBhIHNpbXBsZSBsb2dnZXIgdXRpbGl0eVxuICpcbiAqXG4gKiBUaGVyZSBhcmUgdHdvIHR5cGVzIG9mIGxvZ3MgKCBhcHBlbmQgYW5kIG92ZXJ3cml0ZSwgZGVmYXVsdCBpcyBhcHBlbmQpXG4gKi9cblwidXNlIHN0cmljdFwiO1xuLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vbGliL25vZGUtNC5kLnRzXCIgLz5cbnZhciBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdsb2dnZXInKTtcbjtcbnZhciBwZXJmcyA9IHt9O1xuZnVuY3Rpb24gbG9nUGVyZihjb25zLCBzU3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzIHx8ICF0aGlzLmVuYWJsZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbGFiZWwgPSAncGVyZicgKyB0aGlzLm5hbWU7XG4gICAgY29ucy5sb2coJ1BlcmYnICsgdGhpcy5uYW1lKTtcbiAgICBpZiAodGhpcy5maXJzdCA9PT0gMCkge1xuICAgICAgICB0aGlzLmZpcnN0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgdGhpcy5sYXN0ID0gdGhpcy5maXJzdDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhciB0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgY29ucy5sb2coJ1BlcmYnICsgdGhpcy5uYW1lICtcbiAgICAgICAgICAgICcgZGVsdGE6ICcgKyBTdHJpbmcoXCIgICAgICBcIiArICh0IC0gdGhpcy5sYXN0KSkuc2xpY2UoLTYpXG4gICAgICAgICAgICArICcgdG90YWw6ICcgKyBTdHJpbmcoXCIgICAgICBcIiArICh0IC0gdGhpcy5maXJzdCkpLnNsaWNlKC02KSk7XG4gICAgICAgIHRoaXMubGFzdCA9IHQ7XG4gICAgfVxuICAgIGlmICh0aGlzLm9uW3NTdHJpbmddKSB7XG4gICAgICAgIGNvbnMudGltZUVuZChzU3RyaW5nKTtcbiAgICAgICAgZGVsZXRlIHRoaXMub25bc1N0cmluZ107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjb25zLnRpbWUoc1N0cmluZyk7XG4gICAgICAgIHRoaXMub25bc1N0cmluZ10gPSAxO1xuICAgIH1cbn1cbmV4cG9ydHMubG9nUGVyZiA9IGxvZ1BlcmY7XG5mdW5jdGlvbiBwZXJmKHN0cmluZykge1xuICAgIHBlcmZzW3N0cmluZ10gPSB7IG5hbWU6IHN0cmluZywgbGFzdDogMCwgZmlyc3Q6IDAsIG9uOiB7fSwgZW5hYmxlZDogZmFsc2UgfTtcbiAgICBpZiAoZGVidWcoJ3BlcmYnICsgc3RyaW5nKS5lbmFibGVkKSB7XG4gICAgICAgIHBlcmZzW3N0cmluZ10uZW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiBsb2dQZXJmLmJpbmQocGVyZnNbc3RyaW5nXSwgY29uc29sZSk7XG59XG5leHBvcnRzLnBlcmYgPSBwZXJmO1xudmFyIGZzID0gcmVxdWlyZShcImZzXCIpO1xudmFyIGxvZ2dlcnMgPSB7fTtcbnZhciBvcyA9IHJlcXVpcmUoJ29zJyk7XG5mdW5jdGlvbiBnZXRXcml0YWJsZURpcigpIHtcbiAgICAvLyByZXR1cm4gcHJvY2Vzcy5lbnZbKHByb2Nlc3MucGxhdGZvcm0gPT0gJ3dpbjMyJykgPyAnVVNFUlBST0ZJTEUnIDogJ0hPTUUnXTtcbiAgICByZXR1cm4gb3MudG1wZGlyKCk7XG59XG5mdW5jdGlvbiBzZXR1cE9uY2UoKSB7XG4gICAgdmFyIGhvbWUgPSBnZXRXcml0YWJsZURpcigpO1xuICAgIHRyeSB7XG4gICAgICAgIGZzLm1rZGlyU3luYyhob21lICsgJy8nICsgJ2ZkZXZzdGFydCcpO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvZmRldnN0YXJ0L2xvZ3MnKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICB9XG59XG5zZXR1cE9uY2UoKTtcbmZ1bmN0aW9uIGdldEZpbGVOYW1lKG5hbWUpIHtcbiAgICByZXR1cm4gb3MudG1wZGlyKCkgKyAnL2ZkZXZzdGFydC9sb2dzLycgKyBuYW1lICsgXCIubG9nXCI7XG59XG5leHBvcnRzLl90ZXN0ID0ge1xuICAgIGdldEZpbGVOYW1lOiBnZXRGaWxlTmFtZVxufTtcbmZ1bmN0aW9uIGxvZ0l0KGxvZ2dlciwgYXJnKSB7XG4gICAgdmFyIHRleHQ7XG4gICAgaWYgKHR5cGVvZiBhcmcgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgdGV4dCA9IGFyZztcbiAgICB9XG4gICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgdGV4dCA9IFwiRXJyb3I6XCIgKyBhcmcubWVzc2FnZSArIFwiIFwiICsgYXJnLnN0YWNrO1xuICAgIH1cbiAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSWxsZWdhbCBhcmd1bWVudCB0byBsb2dcIik7XG4gICAgfVxuICAgIHZhciBmaWxlbmFtZSA9IGdldEZpbGVOYW1lKGxvZ2dlci5uYW1lKTtcbiAgICB2YXIgZCA9IG5ldyBEYXRlKCk7XG4gICAgdmFyIG4gPSBkLnRvVVRDU3RyaW5nKCkgKyBcIlxcdFwiICsgdGV4dDtcbiAgICBkZWJ1Z2xvZygnd3JpdGluZyBsb2cgZW50cnkgdG8gJyArIGZpbGVuYW1lICsgJyAnICsgbik7XG4gICAgZnMud3JpdGVGaWxlU3luYyhmaWxlbmFtZSwgbiwgeyBlbmNvZGluZzogJ3V0Zi04JywgZmxhZzogJ2EnIH0pO1xufVxuZnVuY3Rpb24gbG9nZ2VyKG5hbWUsIGZsYWdzKSB7XG4gICAgaWYgKGZsYWdzICE9PSAnYScgJiYgZmxhZ3MgIT09ICcnICYmIGZsYWdzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdvbmx5IGEgYWxsb3dlZCBhcyBmbGFncycpO1xuICAgIH1cbiAgICBmbGFncyA9IChmbGFncyA9PT0gdW5kZWZpbmVkKSA/ICdhJyA6IGZsYWdzO1xuICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIiB8fCAhL15bQS1aYS16XVtBLVphLXowLTlfXSskLy5leGVjKG5hbWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKTtcbiAgICB9XG4gICAgaWYgKCFsb2dnZXJzW25hbWVdKSB7XG4gICAgICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIGZsYWdzOiBmbGFnc1xuICAgICAgICB9O1xuICAgICAgICBhbG9nZ2VyLmxvZ0l0ID0gbG9nSXQuYmluZCh1bmRlZmluZWQsIGFsb2dnZXIpO1xuICAgICAgICAvLyByZXNldCB0aGUgZmlsZVxuICAgICAgICBpZiAoZmxhZ3MgPT09ICcnKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMoZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIioqKkVSUk9SOiB1bmFibGUgdG8gcmVtb3ZlIGxvZyBmaWxlIFwiICsgZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICAgIH1cbiAgICBpZiAobG9nZ2Vyc1tuYW1lXS5mbGFncyAhPT0gZmxhZ3MpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGTGFncyBtaXNtYXRjaCBpbiBsb2dnZXInICsgbmFtZSk7XG4gICAgfVxuICAgIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufVxuZXhwb3J0cy5sb2dnZXIgPSBsb2dnZXI7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
