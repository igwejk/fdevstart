/**
 * a simple logger utility
 *
 *
 * There are two types of logs ( append and overwrite, default is append)
 */
"use strict";
/// <reference path="../../lib/node-4.d.ts" />

var debug = require('debug');
var debuglog = debug('logger');
;
var perfs = {};
function logPerf(sString) {
    if (!this || !this.enabled) {
        return;
    }
    var label = 'perf' + this.name;
    console.log('Perf' + this.name);
    if (this.first === 0) {
        this.first = Date.now();
    } else {
        console.log('Perf' + this.name + ' total ' + (Date.now() - this.first));
    }
    if (this.on[sString]) {
        console.timeEnd(sString);
        delete this.on[sString];
    } else {
        console.time(sString);
        this.on[sString] = 1;
    }
}
function perf(string) {
    perfs[string] = { name: string, last: 0, first: 0, on: {}, enabled: false };
    if (debug('perf' + string).enabled) {
        perfs[string].enabled = true;
    }
    return logPerf.bind(perfs[string]);
}
exports.perf = perf;
var fs = require('fs');
var loggers = {};
var os = require('os');
function getWritableDir() {
    // return process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
    return os.tmpdir();
}
function setupOnce() {
    var home = getWritableDir();
    try {
        fs.mkdirSync(home + '/' + 'fdevstart');
    } catch (e) {}
    try {
        fs.mkdirSync(home + '/fdevstart/logs');
    } catch (e) {}
}
setupOnce();
function getFileName(name) {
    return os.tmpdir() + '/fdevstart/logs/' + name + ".log";
}
exports._test = {
    getFileName: getFileName
};
function logIt(logger, arg) {
    var text;
    if (typeof arg === "string") {
        text = arg;
    } else if (arg instanceof Error) {
        text = "Error:" + arg.message + " " + arg.stack;
    }
    if (!text) {
        throw new Error("Illegal argument to log");
    }
    var filename = getFileName(logger.name);
    var d = new Date();
    var n = d.toUTCString() + "\t" + text;
    debuglog('writing log entry to ' + filename + ' ' + n);
    fs.writeFileSync(filename, n, { encoding: 'utf-8', flag: 'a' });
}
function logger(name, flags) {
    if (flags !== 'a' && flags !== '' && flags !== undefined) {
        throw new Error('only a allowed as flags');
    }
    flags = flags === undefined ? 'a' : flags;
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            flags: flags
        };
        alogger.logIt = logIt.bind(undefined, alogger);
        // reset the file
        if (flags === '') {
            try {
                fs.unlinkSync(getFileName(name));
            } catch (e) {
                debuglog("***ERROR: unable to remove log file " + getFileName(name));
            }
        }
        loggers[name] = alogger;
    }
    if (loggers[name].flags !== flags) {
        throw new Error('FLags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9sb2dnZXIudHMiLCJ1dGlscy9sb2dnZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJwZXJmcyIsImxvZ1BlcmYiLCJzU3RyaW5nIiwiZW5hYmxlZCIsImxhYmVsIiwibmFtZSIsImNvbnNvbGUiLCJsb2ciLCJmaXJzdCIsIkRhdGUiLCJub3ciLCJvbiIsInRpbWVFbmQiLCJ0aW1lIiwicGVyZiIsInN0cmluZyIsImxhc3QiLCJiaW5kIiwiZXhwb3J0cyIsImZzIiwibG9nZ2VycyIsIm9zIiwiZ2V0V3JpdGFibGVEaXIiLCJ0bXBkaXIiLCJzZXR1cE9uY2UiLCJob21lIiwibWtkaXJTeW5jIiwiZSIsImdldEZpbGVOYW1lIiwiX3Rlc3QiLCJsb2dJdCIsImxvZ2dlciIsImFyZyIsInRleHQiLCJFcnJvciIsIm1lc3NhZ2UiLCJzdGFjayIsImZpbGVuYW1lIiwiZCIsIm4iLCJ0b1VUQ1N0cmluZyIsIndyaXRlRmlsZVN5bmMiLCJlbmNvZGluZyIsImZsYWciLCJmbGFncyIsInVuZGVmaW5lZCIsImV4ZWMiLCJhbG9nZ2VyIiwidW5saW5rU3luYyJdLCJtYXBwaW5ncyI6IkFBRUE7Ozs7OztBQ0lBO0FER0E7O0FBRUEsSUFBWUEsUUFBS0MsUUFBTSxPQUFOLENBQWpCO0FBRUEsSUFBTUMsV0FBV0YsTUFBTSxRQUFOLENBQWpCO0FBTUM7QUFHRCxJQUFJRyxRQUFRLEVBQVo7QUFHQSxTQUFBQyxPQUFBLENBQWlCQyxPQUFqQixFQUF3QjtBQUN0QixRQUFHLENBQUMsSUFBRCxJQUFTLENBQUMsS0FBS0MsT0FBbEIsRUFBMkI7QUFDekI7QUFDRDtBQUNELFFBQUlDLFFBQVEsU0FBUyxLQUFLQyxJQUExQjtBQUNBQyxZQUFRQyxHQUFSLENBQVksU0FBUyxLQUFLRixJQUExQjtBQUNBLFFBQUcsS0FBS0csS0FBTCxLQUFlLENBQWxCLEVBQXFCO0FBQ2pCLGFBQUtBLEtBQUwsR0FBYUMsS0FBS0MsR0FBTCxF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LFVBQVUsR0FBVixJQUFpQkEsVUFBVSxFQUEzQixJQUFpQ0EsVUFBVUMsU0FBL0MsRUFBMEQ7QUFDeEQsY0FBTSxJQUFJWCxLQUFKLENBQVUseUJBQVYsQ0FBTjtBQUNEO0FBQ0RVLFlBQVNBLFVBQVVDLFNBQVgsR0FBeUIsR0FBekIsR0FBK0JELEtBQXZDO0FBQ0EsUUFBSSxPQUFPdkMsSUFBUCxLQUFnQixRQUFoQixJQUE0QixDQUFDLDBCQUEwQnlDLElBQTFCLENBQStCekMsSUFBL0IsQ0FBakMsRUFBdUU7QUFDckUsY0FBTSxJQUFJNkIsS0FBSixDQUFVLDBEQUFWLENBQU47QUFDRDtBQUNELFFBQUksQ0FBQ2QsUUFBUWYsSUFBUixDQUFMLEVBQW9CO0FBQ2xCLFlBQUkwQyxVQUFVO0FBQ1oxQyxrQkFBTUEsSUFETTtBQUVadUMsbUJBQU9BO0FBRkssU0FBZDtBQUlBRyxnQkFBUWpCLEtBQVIsR0FBZ0JBLE1BQU1iLElBQU4sQ0FBVzRCLFNBQVgsRUFBc0JFLE9BQXRCLENBQWhCO0FBQ0E7QUFDQSxZQUFJSCxVQUFVLEVBQWQsRUFBa0I7QUFDaEIsZ0JBQUk7QUFDRnpCLG1CQUFHNkIsVUFBSCxDQUFjcEIsWUFBWXZCLElBQVosQ0FBZDtBQUNBLGFBRkYsQ0FFRSxPQUFPc0IsQ0FBUCxFQUFVO0FBQ1Y1Qix5QkFBUyx5Q0FBeUM2QixZQUFZdkIsSUFBWixDQUFsRDtBQUNEO0FBQ0Y7QUFDRGUsZ0JBQVFmLElBQVIsSUFBZ0IwQyxPQUFoQjtBQUNEO0FBQ0QsUUFBSTNCLFFBQVFmLElBQVIsRUFBY3VDLEtBQWQsS0FBd0JBLEtBQTVCLEVBQW1DO0FBQ2pDLGNBQU0sSUFBSVYsS0FBSixDQUFVLDZCQUE2QjdCLElBQXZDLENBQU47QUFDRDtBQUNELFdBQU9lLFFBQVFmLElBQVIsRUFBY3lCLEtBQXJCO0FBQ0Q7QUE1QmVaLFFBQUFhLE1BQUEsR0FBTUEsTUFBTiIsImZpbGUiOiJ1dGlscy9sb2dnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcblxuLyoqXG4gKiBhIHNpbXBsZSBsb2dnZXIgdXRpbGl0eVxuICpcbiAqXG4gKiBUaGVyZSBhcmUgdHdvIHR5cGVzIG9mIGxvZ3MgKCBhcHBlbmQgYW5kIG92ZXJ3cml0ZSwgZGVmYXVsdCBpcyBhcHBlbmQpXG4gKi9cblxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL2xpYi9ub2RlLTQuZC50c1wiIC8+XG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnbG9nZ2VyJyk7XG5cbmludGVyZmFjZSBJTG9nZ2VyIHtcbiAgbmFtZTogc3RyaW5nLFxuICBmbGFnczogc3RyaW5nLFxuICBsb2dJdD86IChhbnkpID0+IHZvaWRcbn07XG5cblxudmFyIHBlcmZzID0ge30gYXMge1trZXkgOiBzdHJpbmddIDogeyBlbmFibGVkIDogYm9vbGVhbiwgbmFtZSA6IHN0cmluZywgbGFzdDogbnVtYmVyLCBmaXJzdCA6IG51bWJlciwgb24gOiB7fX19O1xuXG5cbmZ1bmN0aW9uIGxvZ1BlcmYoc1N0cmluZykge1xuICBpZighdGhpcyB8fCAhdGhpcy5lbmFibGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHZhciBsYWJlbCA9ICdwZXJmJyArIHRoaXMubmFtZTtcbiAgY29uc29sZS5sb2coJ1BlcmYnICsgdGhpcy5uYW1lKTtcbiAgaWYodGhpcy5maXJzdCA9PT0gMCkge1xuICAgICAgdGhpcy5maXJzdCA9IERhdGUubm93KCk7XG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5sb2coJ1BlcmYnICsgdGhpcy5uYW1lICsgJyB0b3RhbCAnICsgKERhdGUubm93KCkgLSB0aGlzLmZpcnN0KSk7XG4gIH1cbiAgaWYoIHRoaXMub25bc1N0cmluZ10pIHtcbiAgICAgY29uc29sZS50aW1lRW5kKHNTdHJpbmcpXG4gICAgIGRlbGV0ZSB0aGlzLm9uW3NTdHJpbmddO1xuICB9IGVsc2Uge1xuICAgICAgY29uc29sZS50aW1lKHNTdHJpbmcpO1xuICAgICAgdGhpcy5vbltzU3RyaW5nXSA9IDE7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlcmYoc3RyaW5nKSB7XG4gIHBlcmZzW3N0cmluZ10gPSB7IG5hbWUgOiBzdHJpbmcsIGxhc3QgOiAwLCBmaXJzdDogMCwgb24gOiB7fSwgZW5hYmxlZCA6IGZhbHNlIH07XG4gIGlmIChkZWJ1ZygncGVyZicgKyBzdHJpbmcpLmVuYWJsZWQgKVxuICB7IHBlcmZzW3N0cmluZ10uZW5hYmxlZCA9IHRydWU7XG4gIH1cbiAgcmV0dXJuIGxvZ1BlcmYuYmluZChwZXJmc1tzdHJpbmddKTtcbn1cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuXG52YXIgbG9nZ2VycyA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogSUxvZ2dlciB9O1xuXG52YXIgb3MgPSByZXF1aXJlKCdvcycpO1xuXG5mdW5jdGlvbiBnZXRXcml0YWJsZURpcigpIHtcbiAgLy8gcmV0dXJuIHByb2Nlc3MuZW52Wyhwcm9jZXNzLnBsYXRmb3JtID09ICd3aW4zMicpID8gJ1VTRVJQUk9GSUxFJyA6ICdIT01FJ107XG4gIHJldHVybiBvcy50bXBkaXIoKTtcbn1cblxuXG5mdW5jdGlvbiBzZXR1cE9uY2UoKSB7XG5cbiAgdmFyIGhvbWUgPSBnZXRXcml0YWJsZURpcigpO1xuICB0cnkge1xuICAgIGZzLm1rZGlyU3luYyhob21lICsgJy8nICsgJ2ZkZXZzdGFydCcgKTtcbiAgfSBjYXRjaCAoZSkge1xuXG4gIH1cbiAgdHJ5IHtcbiAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvZmRldnN0YXJ0L2xvZ3MnICk7XG4gIH0gY2F0Y2goZSkge1xuXG4gIH1cbn1cbnNldHVwT25jZSgpO1xuXG5cbmZ1bmN0aW9uIGdldEZpbGVOYW1lKG5hbWU6IHN0cmluZykge1xuICByZXR1cm4gb3MudG1wZGlyKCkgICsgJy9mZGV2c3RhcnQvbG9ncy8nICsgbmFtZSArIFwiLmxvZ1wiO1xufVxuXG5leHBvcnQgY29uc3QgX3Rlc3QgPSB7XG4gIGdldEZpbGVOYW1lOiBnZXRGaWxlTmFtZVxufTtcblxuZnVuY3Rpb24gbG9nSXQobG9nZ2VyOiBJTG9nZ2VyLCBhcmcpIHtcbiAgdmFyIHRleHQ6IHN0cmluZztcbiAgaWYgKHR5cGVvZiBhcmcgPT09IFwic3RyaW5nXCIpIHtcbiAgICB0ZXh0ID0gYXJnO1xuICB9IGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgdGV4dCA9IFwiRXJyb3I6XCIgKyBhcmcubWVzc2FnZSArIFwiIFwiICsgYXJnLnN0YWNrO1xuICB9XG4gIGlmICghdGV4dCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIklsbGVnYWwgYXJndW1lbnQgdG8gbG9nXCIpO1xuICB9XG4gIHZhciBmaWxlbmFtZSA9IGdldEZpbGVOYW1lKGxvZ2dlci5uYW1lKTtcbiAgdmFyIGQgPSBuZXcgRGF0ZSgpO1xuICB2YXIgbiA9IGQudG9VVENTdHJpbmcoKSArIFwiXFx0XCIgKyB0ZXh0O1xuICBkZWJ1Z2xvZygnd3JpdGluZyBsb2cgZW50cnkgdG8gJyArIGZpbGVuYW1lICsgJyAnICsgbik7XG4gIGZzLndyaXRlRmlsZVN5bmMoZmlsZW5hbWUsIG4sIHsgZW5jb2Rpbmc6ICd1dGYtOCcsIGZsYWc6ICdhJyB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvZ2dlcihuYW1lOiBzdHJpbmcsIGZsYWdzPzogc3RyaW5nKTogKGFueSkgPT4gdm9pZCB7XG4gIGlmIChmbGFncyAhPT0gJ2EnICYmIGZsYWdzICE9PSAnJyAmJiBmbGFncyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdvbmx5IGEgYWxsb3dlZCBhcyBmbGFncycpO1xuICB9XG4gIGZsYWdzID0gKGZsYWdzID09PSB1bmRlZmluZWQgKT8gICdhJyA6IGZsYWdzO1xuICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIgfHwgIS9eW0EtWmEtel1bQS1aYS16MC05X10rJC8uZXhlYyhuYW1lKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKVxuICB9XG4gIGlmICghbG9nZ2Vyc1tuYW1lXSkge1xuICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgbmFtZTogbmFtZSxcbiAgICAgIGZsYWdzOiBmbGFnc1xuICAgIH0gYXMgSUxvZ2dlcjtcbiAgICBhbG9nZ2VyLmxvZ0l0ID0gbG9nSXQuYmluZCh1bmRlZmluZWQsIGFsb2dnZXIpO1xuICAgIC8vIHJlc2V0IHRoZSBmaWxlXG4gICAgaWYgKGZsYWdzID09PSAnJykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgZnMudW5saW5rU3luYyhnZXRGaWxlTmFtZShuYW1lKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGRlYnVnbG9nKFwiKioqRVJST1I6IHVuYWJsZSB0byByZW1vdmUgbG9nIGZpbGUgXCIgKyBnZXRGaWxlTmFtZShuYW1lKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICB9XG4gIGlmIChsb2dnZXJzW25hbWVdLmZsYWdzICE9PSBmbGFncykge1xuICAgIHRocm93IG5ldyBFcnJvcignRkxhZ3MgbWlzbWF0Y2ggaW4gbG9nZ2VyJyArIG5hbWUpO1xuICB9XG4gIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufSIsIi8qKlxuICogYSBzaW1wbGUgbG9nZ2VyIHV0aWxpdHlcbiAqXG4gKlxuICogVGhlcmUgYXJlIHR3byB0eXBlcyBvZiBsb2dzICggYXBwZW5kIGFuZCBvdmVyd3JpdGUsIGRlZmF1bHQgaXMgYXBwZW5kKVxuICovXG5cInVzZSBzdHJpY3RcIjtcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdsb2dnZXInKTtcbjtcbnZhciBwZXJmcyA9IHt9O1xuZnVuY3Rpb24gbG9nUGVyZihzU3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzIHx8ICF0aGlzLmVuYWJsZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbGFiZWwgPSAncGVyZicgKyB0aGlzLm5hbWU7XG4gICAgY29uc29sZS5sb2coJ1BlcmYnICsgdGhpcy5uYW1lKTtcbiAgICBpZiAodGhpcy5maXJzdCA9PT0gMCkge1xuICAgICAgICB0aGlzLmZpcnN0ID0gRGF0ZS5ub3coKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQZXJmJyArIHRoaXMubmFtZSArICcgdG90YWwgJyArIChEYXRlLm5vdygpIC0gdGhpcy5maXJzdCkpO1xuICAgIH1cbiAgICBpZiAodGhpcy5vbltzU3RyaW5nXSkge1xuICAgICAgICBjb25zb2xlLnRpbWVFbmQoc1N0cmluZyk7XG4gICAgICAgIGRlbGV0ZSB0aGlzLm9uW3NTdHJpbmddO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY29uc29sZS50aW1lKHNTdHJpbmcpO1xuICAgICAgICB0aGlzLm9uW3NTdHJpbmddID0gMTtcbiAgICB9XG59XG5mdW5jdGlvbiBwZXJmKHN0cmluZykge1xuICAgIHBlcmZzW3N0cmluZ10gPSB7IG5hbWU6IHN0cmluZywgbGFzdDogMCwgZmlyc3Q6IDAsIG9uOiB7fSwgZW5hYmxlZDogZmFsc2UgfTtcbiAgICBpZiAoZGVidWcoJ3BlcmYnICsgc3RyaW5nKS5lbmFibGVkKSB7XG4gICAgICAgIHBlcmZzW3N0cmluZ10uZW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiBsb2dQZXJmLmJpbmQocGVyZnNbc3RyaW5nXSk7XG59XG5leHBvcnRzLnBlcmYgPSBwZXJmO1xudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciBsb2dnZXJzID0ge307XG52YXIgb3MgPSByZXF1aXJlKCdvcycpO1xuZnVuY3Rpb24gZ2V0V3JpdGFibGVEaXIoKSB7XG4gICAgLy8gcmV0dXJuIHByb2Nlc3MuZW52Wyhwcm9jZXNzLnBsYXRmb3JtID09ICd3aW4zMicpID8gJ1VTRVJQUk9GSUxFJyA6ICdIT01FJ107XG4gICAgcmV0dXJuIG9zLnRtcGRpcigpO1xufVxuZnVuY3Rpb24gc2V0dXBPbmNlKCkge1xuICAgIHZhciBob21lID0gZ2V0V3JpdGFibGVEaXIoKTtcbiAgICB0cnkge1xuICAgICAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvJyArICdmZGV2c3RhcnQnKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgICAgZnMubWtkaXJTeW5jKGhvbWUgKyAnL2ZkZXZzdGFydC9sb2dzJyk7XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgfVxufVxuc2V0dXBPbmNlKCk7XG5mdW5jdGlvbiBnZXRGaWxlTmFtZShuYW1lKSB7XG4gICAgcmV0dXJuIG9zLnRtcGRpcigpICsgJy9mZGV2c3RhcnQvbG9ncy8nICsgbmFtZSArIFwiLmxvZ1wiO1xufVxuZXhwb3J0cy5fdGVzdCA9IHtcbiAgICBnZXRGaWxlTmFtZTogZ2V0RmlsZU5hbWVcbn07XG5mdW5jdGlvbiBsb2dJdChsb2dnZXIsIGFyZykge1xuICAgIHZhciB0ZXh0O1xuICAgIGlmICh0eXBlb2YgYXJnID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHRleHQgPSBhcmc7XG4gICAgfVxuICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgIHRleHQgPSBcIkVycm9yOlwiICsgYXJnLm1lc3NhZ2UgKyBcIiBcIiArIGFyZy5zdGFjaztcbiAgICB9XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIklsbGVnYWwgYXJndW1lbnQgdG8gbG9nXCIpO1xuICAgIH1cbiAgICB2YXIgZmlsZW5hbWUgPSBnZXRGaWxlTmFtZShsb2dnZXIubmFtZSk7XG4gICAgdmFyIGQgPSBuZXcgRGF0ZSgpO1xuICAgIHZhciBuID0gZC50b1VUQ1N0cmluZygpICsgXCJcXHRcIiArIHRleHQ7XG4gICAgZGVidWdsb2coJ3dyaXRpbmcgbG9nIGVudHJ5IHRvICcgKyBmaWxlbmFtZSArICcgJyArIG4pO1xuICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZW5hbWUsIG4sIHsgZW5jb2Rpbmc6ICd1dGYtOCcsIGZsYWc6ICdhJyB9KTtcbn1cbmZ1bmN0aW9uIGxvZ2dlcihuYW1lLCBmbGFncykge1xuICAgIGlmIChmbGFncyAhPT0gJ2EnICYmIGZsYWdzICE9PSAnJyAmJiBmbGFncyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignb25seSBhIGFsbG93ZWQgYXMgZmxhZ3MnKTtcbiAgICB9XG4gICAgZmxhZ3MgPSAoZmxhZ3MgPT09IHVuZGVmaW5lZCkgPyAnYScgOiBmbGFncztcbiAgICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIgfHwgIS9eW0EtWmEtel1bQS1aYS16MC05X10rJC8uZXhlYyhuYW1lKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJyk7XG4gICAgfVxuICAgIGlmICghbG9nZ2Vyc1tuYW1lXSkge1xuICAgICAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBmbGFnczogZmxhZ3NcbiAgICAgICAgfTtcbiAgICAgICAgYWxvZ2dlci5sb2dJdCA9IGxvZ0l0LmJpbmQodW5kZWZpbmVkLCBhbG9nZ2VyKTtcbiAgICAgICAgLy8gcmVzZXQgdGhlIGZpbGVcbiAgICAgICAgaWYgKGZsYWdzID09PSAnJykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBmcy51bmxpbmtTeW5jKGdldEZpbGVOYW1lKG5hbWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgZGVidWdsb2coXCIqKipFUlJPUjogdW5hYmxlIHRvIHJlbW92ZSBsb2cgZmlsZSBcIiArIGdldEZpbGVOYW1lKG5hbWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgICB9XG4gICAgaWYgKGxvZ2dlcnNbbmFtZV0uZmxhZ3MgIT09IGZsYWdzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRkxhZ3MgbWlzbWF0Y2ggaW4gbG9nZ2VyJyArIG5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn1cbmV4cG9ydHMubG9nZ2VyID0gbG9nZ2VyO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
