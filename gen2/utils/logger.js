/**
 * a simple logger utility
 *
 *
 * There are two types of logs ( append and overwrite, default is append)
 */
"use strict";
// <reference path="../../lib/node-4.d.ts" />

var debug = require('debug');
var debuglog = debug('logger');
;
var perfs = {};
function logPerf(sString) {
    if (!this || !this.enabled) {
        return;
    }
    var label = 'perf' + this.name;
    console.log('Perf' + this.name);
    if (this.first === 0) {
        this.first = Date.now();
        this.last = this.first;
    } else {
        var t = Date.now();
        console.log('Perf' + this.name + ' delta: ' + String("      " + (t - this.last)).slice(-6) + ' total: ' + String("      " + (t - this.first)).slice(-6));
        this.last = t;
    }
    if (this.on[sString]) {
        console.timeEnd(sString);
        delete this.on[sString];
    } else {
        console.time(sString);
        this.on[sString] = 1;
    }
}
function perf(string) {
    perfs[string] = { name: string, last: 0, first: 0, on: {}, enabled: false };
    if (debug('perf' + string).enabled) {
        perfs[string].enabled = true;
    }
    return logPerf.bind(perfs[string]);
}
exports.perf = perf;
var fs = require('fs');
var loggers = {};
var os = require('os');
function getWritableDir() {
    // return process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
    return os.tmpdir();
}
function setupOnce() {
    var home = getWritableDir();
    try {
        fs.mkdirSync(home + '/' + 'fdevstart');
    } catch (e) {}
    try {
        fs.mkdirSync(home + '/fdevstart/logs');
    } catch (e) {}
}
setupOnce();
function getFileName(name) {
    return os.tmpdir() + '/fdevstart/logs/' + name + ".log";
}
exports._test = {
    getFileName: getFileName
};
function logIt(logger, arg) {
    var text;
    if (typeof arg === "string") {
        text = arg;
    } else if (arg instanceof Error) {
        text = "Error:" + arg.message + " " + arg.stack;
    }
    if (!text) {
        throw new Error("Illegal argument to log");
    }
    var filename = getFileName(logger.name);
    var d = new Date();
    var n = d.toUTCString() + "\t" + text;
    debuglog('writing log entry to ' + filename + ' ' + n);
    fs.writeFileSync(filename, n, { encoding: 'utf-8', flag: 'a' });
}
function logger(name, flags) {
    if (flags !== 'a' && flags !== '' && flags !== undefined) {
        throw new Error('only a allowed as flags');
    }
    flags = flags === undefined ? 'a' : flags;
    if (typeof name !== "string" || !/^[A-Za-z][A-Za-z0-9_]+$/.exec(name)) {
        throw new Error('Logger name must be at least two alphanumeric characters');
    }
    if (!loggers[name]) {
        var alogger = {
            name: name,
            flags: flags
        };
        alogger.logIt = logIt.bind(undefined, alogger);
        // reset the file
        if (flags === '') {
            try {
                fs.unlinkSync(getFileName(name));
            } catch (e) {
                debuglog("***ERROR: unable to remove log file " + getFileName(name));
            }
        }
        loggers[name] = alogger;
    }
    if (loggers[name].flags !== flags) {
        throw new Error('FLags mismatch in logger' + name);
    }
    return loggers[name].logIt;
}
exports.logger = logger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9sb2dnZXIudHMiLCJ1dGlscy9sb2dnZXIuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwiZGVidWdsb2ciLCJwZXJmcyIsImxvZ1BlcmYiLCJzU3RyaW5nIiwiZW5hYmxlZCIsImxhYmVsIiwibmFtZSIsImNvbnNvbGUiLCJsb2ciLCJmaXJzdCIsIkRhdGUiLCJub3ciLCJsYXN0IiwidCIsIlN0cmluZyIsInNsaWNlIiwib24iLCJ0aW1lRW5kIiwidGltZSIsInBlcmYiLCJzdHJpbmciLCJiaW5kIiwiZXhwb3J0cyIsImZzIiwibG9nZ2VycyIsIm9zIiwiZ2V0V3JpdGFibGVEaXIiLCJ0bXBkaXIiLCJzZXR1cE9uY2UiLCJob21lIiwibWtkaXJTeW5jIiwiZSIsImdldEZpbGVOYW1lIiwiX3Rlc3QiLCJsb2dJdCIsImxvZ2dlciIsImFyZyIsInRleHQiLCJFcnJvciIsIm1lc3NhZ2UiLCJzdGFjayIsImZpbGVuYW1lIiwiZCIsIm4iLCJ0b1VUQ1N0cmluZyIsIndyaXRlRmlsZVN5bmMiLCJlbmNvZGluZyIsImZsYWciLCJmbGFncyIsInVuZGVmaW5lZCIsImV4ZWMiLCJhbG9nZ2VyIiwidW5saW5rU3luYyJdLCJtYXBwaW5ncyI6IkFBRUE7Ozs7OztBQ0lBO0FER0E7O0FBRUEsSUFBWUEsUUFBS0MsUUFBTSxPQUFOLENBQWpCO0FBRUEsSUFBTUMsV0FBV0YsTUFBTSxRQUFOLENBQWpCO0FBTUM7QUFFRCxJQUFJRyxRQUFRLEVBQVo7QUFFQSxTQUFBQyxPQUFBLENBQWlCQyxPQUFqQixFQUF3QjtBQUN0QixRQUFHLENBQUMsSUFBRCxJQUFTLENBQUMsS0FBS0MsT0FBbEIsRUFBMkI7QUFDekI7QUFDRDtBQUNELFFBQUlDLFFBQVEsU0FBUyxLQUFLQyxJQUExQjtBQUNBQyxZQUFRQyxHQUFSLENBQVksU0FBUyxLQUFLRixJQUExQjtBQUNBLFFBQUcsS0FBS0csS0FBTCxLQUFlLENBQWxCLEVBQXFCO0FBQ2pCLGFBQUtBLEtB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QixRQUFRbEIsSUFBUixFQUFjMEMsS0FBZCxLQUF3QkEsS0FBNUIsRUFBbUM7QUFDakMsY0FBTSxJQUFJVixLQUFKLENBQVUsNkJBQTZCaEMsSUFBdkMsQ0FBTjtBQUNEO0FBQ0QsV0FBT2tCLFFBQVFsQixJQUFSLEVBQWM0QixLQUFyQjtBQUNEO0FBNUJlWixRQUFBYSxNQUFBLEdBQU1BLE1BQU4iLCJmaWxlIjoidXRpbHMvbG9nZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5cbi8qKlxuICogYSBzaW1wbGUgbG9nZ2VyIHV0aWxpdHlcbiAqXG4gKlxuICogVGhlcmUgYXJlIHR3byB0eXBlcyBvZiBsb2dzICggYXBwZW5kIGFuZCBvdmVyd3JpdGUsIGRlZmF1bHQgaXMgYXBwZW5kKVxuICovXG5cbi8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL2xpYi9ub2RlLTQuZC50c1wiIC8+XG5cbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnJztcblxuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygnbG9nZ2VyJyk7XG5cbmludGVyZmFjZSBJTG9nZ2VyIHtcbiAgbmFtZTogc3RyaW5nLFxuICBmbGFnczogc3RyaW5nLFxuICBsb2dJdD86IChhbnkpID0+IHZvaWRcbn07XG5cbnZhciBwZXJmcyA9IHt9IGFzIHtba2V5IDogc3RyaW5nXSA6IHsgZW5hYmxlZCA6IGJvb2xlYW4sIG5hbWUgOiBzdHJpbmcsIGxhc3Q6IG51bWJlciwgZmlyc3QgOiBudW1iZXIsIG9uIDoge319fTtcblxuZnVuY3Rpb24gbG9nUGVyZihzU3RyaW5nKSB7XG4gIGlmKCF0aGlzIHx8ICF0aGlzLmVuYWJsZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgdmFyIGxhYmVsID0gJ3BlcmYnICsgdGhpcy5uYW1lO1xuICBjb25zb2xlLmxvZygnUGVyZicgKyB0aGlzLm5hbWUpO1xuICBpZih0aGlzLmZpcnN0ID09PSAwKSB7XG4gICAgICB0aGlzLmZpcnN0ID0gRGF0ZS5ub3coKTtcbiAgICAgIHRoaXMubGFzdCA9IHRoaXMuZmlyc3Q7XG4gIH0gZWxzZSB7XG4gICAgdmFyIHQgPSBEYXRlLm5vdygpO1xuICAgIGNvbnNvbGUubG9nKCdQZXJmJyArIHRoaXMubmFtZSArXG4gICAgICcgZGVsdGE6ICcgICsgU3RyaW5nKFwiICAgICAgXCIgKyAodC10aGlzLmxhc3QpKS5zbGljZSgtNilcbiAgICArJyB0b3RhbDogJyAgKyBTdHJpbmcoXCIgICAgICBcIiArICh0LXRoaXMuZmlyc3QpKS5zbGljZSgtNikpO1xuICAgIHRoaXMubGFzdCA9ICB0O1xuICB9XG4gIGlmKCB0aGlzLm9uW3NTdHJpbmddKSB7XG4gICAgIGNvbnNvbGUudGltZUVuZChzU3RyaW5nKVxuICAgICBkZWxldGUgdGhpcy5vbltzU3RyaW5nXTtcbiAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUudGltZShzU3RyaW5nKTtcbiAgICAgIHRoaXMub25bc1N0cmluZ10gPSAxO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZXJmKHN0cmluZykge1xuICBwZXJmc1tzdHJpbmddID0geyBuYW1lIDogc3RyaW5nLCBsYXN0IDogMCwgZmlyc3Q6IDAsIG9uIDoge30sIGVuYWJsZWQgOiBmYWxzZSB9O1xuICBpZiAoZGVidWcoJ3BlcmYnICsgc3RyaW5nKS5lbmFibGVkIClcbiAgeyBwZXJmc1tzdHJpbmddLmVuYWJsZWQgPSB0cnVlO1xuICB9XG4gIHJldHVybiBsb2dQZXJmLmJpbmQocGVyZnNbc3RyaW5nXSk7XG59XG5cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcblxudmFyIGxvZ2dlcnMgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IElMb2dnZXIgfTtcblxudmFyIG9zID0gcmVxdWlyZSgnb3MnKTtcblxuZnVuY3Rpb24gZ2V0V3JpdGFibGVEaXIoKSB7XG4gIC8vIHJldHVybiBwcm9jZXNzLmVudlsocHJvY2Vzcy5wbGF0Zm9ybSA9PSAnd2luMzInKSA/ICdVU0VSUFJPRklMRScgOiAnSE9NRSddO1xuICByZXR1cm4gb3MudG1wZGlyKCk7XG59XG5cblxuZnVuY3Rpb24gc2V0dXBPbmNlKCkge1xuXG4gIHZhciBob21lID0gZ2V0V3JpdGFibGVEaXIoKTtcbiAgdHJ5IHtcbiAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvJyArICdmZGV2c3RhcnQnICk7XG4gIH0gY2F0Y2ggKGUpIHtcblxuICB9XG4gIHRyeSB7XG4gICAgZnMubWtkaXJTeW5jKGhvbWUgKyAnL2ZkZXZzdGFydC9sb2dzJyApO1xuICB9IGNhdGNoKGUpIHtcblxuICB9XG59XG5zZXR1cE9uY2UoKTtcblxuXG5mdW5jdGlvbiBnZXRGaWxlTmFtZShuYW1lOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG9zLnRtcGRpcigpICArICcvZmRldnN0YXJ0L2xvZ3MvJyArIG5hbWUgKyBcIi5sb2dcIjtcbn1cblxuZXhwb3J0IGNvbnN0IF90ZXN0ID0ge1xuICBnZXRGaWxlTmFtZTogZ2V0RmlsZU5hbWVcbn07XG5cbmZ1bmN0aW9uIGxvZ0l0KGxvZ2dlcjogSUxvZ2dlciwgYXJnKSB7XG4gIHZhciB0ZXh0OiBzdHJpbmc7XG4gIGlmICh0eXBlb2YgYXJnID09PSBcInN0cmluZ1wiKSB7XG4gICAgdGV4dCA9IGFyZztcbiAgfSBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgIHRleHQgPSBcIkVycm9yOlwiICsgYXJnLm1lc3NhZ2UgKyBcIiBcIiArIGFyZy5zdGFjaztcbiAgfVxuICBpZiAoIXRleHQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbGxlZ2FsIGFyZ3VtZW50IHRvIGxvZ1wiKTtcbiAgfVxuICB2YXIgZmlsZW5hbWUgPSBnZXRGaWxlTmFtZShsb2dnZXIubmFtZSk7XG4gIHZhciBkID0gbmV3IERhdGUoKTtcbiAgdmFyIG4gPSBkLnRvVVRDU3RyaW5nKCkgKyBcIlxcdFwiICsgdGV4dDtcbiAgZGVidWdsb2coJ3dyaXRpbmcgbG9nIGVudHJ5IHRvICcgKyBmaWxlbmFtZSArICcgJyArIG4pO1xuICBmcy53cml0ZUZpbGVTeW5jKGZpbGVuYW1lLCBuLCB7IGVuY29kaW5nOiAndXRmLTgnLCBmbGFnOiAnYScgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dnZXIobmFtZTogc3RyaW5nLCBmbGFncz86IHN0cmluZyk6IChhbnkpID0+IHZvaWQge1xuICBpZiAoZmxhZ3MgIT09ICdhJyAmJiBmbGFncyAhPT0gJycgJiYgZmxhZ3MgIT09IHVuZGVmaW5lZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignb25seSBhIGFsbG93ZWQgYXMgZmxhZ3MnKTtcbiAgfVxuICBmbGFncyA9IChmbGFncyA9PT0gdW5kZWZpbmVkICk/ICAnYScgOiBmbGFncztcbiAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiIHx8ICEvXltBLVphLXpdW0EtWmEtejAtOV9dKyQvLmV4ZWMobmFtZSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZ2dlciBuYW1lIG11c3QgYmUgYXQgbGVhc3QgdHdvIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzJylcbiAgfVxuICBpZiAoIWxvZ2dlcnNbbmFtZV0pIHtcbiAgICB2YXIgYWxvZ2dlciA9IHtcbiAgICAgIG5hbWU6IG5hbWUsXG4gICAgICBmbGFnczogZmxhZ3NcbiAgICB9IGFzIElMb2dnZXI7XG4gICAgYWxvZ2dlci5sb2dJdCA9IGxvZ0l0LmJpbmQodW5kZWZpbmVkLCBhbG9nZ2VyKTtcbiAgICAvLyByZXNldCB0aGUgZmlsZVxuICAgIGlmIChmbGFncyA9PT0gJycpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGZzLnVubGlua1N5bmMoZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBkZWJ1Z2xvZyhcIioqKkVSUk9SOiB1bmFibGUgdG8gcmVtb3ZlIGxvZyBmaWxlIFwiICsgZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgfVxuICAgIH1cbiAgICBsb2dnZXJzW25hbWVdID0gYWxvZ2dlcjtcbiAgfVxuICBpZiAobG9nZ2Vyc1tuYW1lXS5mbGFncyAhPT0gZmxhZ3MpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZMYWdzIG1pc21hdGNoIGluIGxvZ2dlcicgKyBuYW1lKTtcbiAgfVxuICByZXR1cm4gbG9nZ2Vyc1tuYW1lXS5sb2dJdDtcbn0iLCIvKipcbiAqIGEgc2ltcGxlIGxvZ2dlciB1dGlsaXR5XG4gKlxuICpcbiAqIFRoZXJlIGFyZSB0d28gdHlwZXMgb2YgbG9ncyAoIGFwcGVuZCBhbmQgb3ZlcndyaXRlLCBkZWZhdWx0IGlzIGFwcGVuZClcbiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG4vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9saWIvbm9kZS00LmQudHNcIiAvPlxudmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTtcbnZhciBkZWJ1Z2xvZyA9IGRlYnVnKCdsb2dnZXInKTtcbjtcbnZhciBwZXJmcyA9IHt9O1xuZnVuY3Rpb24gbG9nUGVyZihzU3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzIHx8ICF0aGlzLmVuYWJsZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbGFiZWwgPSAncGVyZicgKyB0aGlzLm5hbWU7XG4gICAgY29uc29sZS5sb2coJ1BlcmYnICsgdGhpcy5uYW1lKTtcbiAgICBpZiAodGhpcy5maXJzdCA9PT0gMCkge1xuICAgICAgICB0aGlzLmZpcnN0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgdGhpcy5sYXN0ID0gdGhpcy5maXJzdDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhciB0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgY29uc29sZS5sb2coJ1BlcmYnICsgdGhpcy5uYW1lICtcbiAgICAgICAgICAgICcgZGVsdGE6ICcgKyBTdHJpbmcoXCIgICAgICBcIiArICh0IC0gdGhpcy5sYXN0KSkuc2xpY2UoLTYpXG4gICAgICAgICAgICArICcgdG90YWw6ICcgKyBTdHJpbmcoXCIgICAgICBcIiArICh0IC0gdGhpcy5maXJzdCkpLnNsaWNlKC02KSk7XG4gICAgICAgIHRoaXMubGFzdCA9IHQ7XG4gICAgfVxuICAgIGlmICh0aGlzLm9uW3NTdHJpbmddKSB7XG4gICAgICAgIGNvbnNvbGUudGltZUVuZChzU3RyaW5nKTtcbiAgICAgICAgZGVsZXRlIHRoaXMub25bc1N0cmluZ107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjb25zb2xlLnRpbWUoc1N0cmluZyk7XG4gICAgICAgIHRoaXMub25bc1N0cmluZ10gPSAxO1xuICAgIH1cbn1cbmZ1bmN0aW9uIHBlcmYoc3RyaW5nKSB7XG4gICAgcGVyZnNbc3RyaW5nXSA9IHsgbmFtZTogc3RyaW5nLCBsYXN0OiAwLCBmaXJzdDogMCwgb246IHt9LCBlbmFibGVkOiBmYWxzZSB9O1xuICAgIGlmIChkZWJ1ZygncGVyZicgKyBzdHJpbmcpLmVuYWJsZWQpIHtcbiAgICAgICAgcGVyZnNbc3RyaW5nXS5lbmFibGVkID0gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGxvZ1BlcmYuYmluZChwZXJmc1tzdHJpbmddKTtcbn1cbmV4cG9ydHMucGVyZiA9IHBlcmY7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIGxvZ2dlcnMgPSB7fTtcbnZhciBvcyA9IHJlcXVpcmUoJ29zJyk7XG5mdW5jdGlvbiBnZXRXcml0YWJsZURpcigpIHtcbiAgICAvLyByZXR1cm4gcHJvY2Vzcy5lbnZbKHByb2Nlc3MucGxhdGZvcm0gPT0gJ3dpbjMyJykgPyAnVVNFUlBST0ZJTEUnIDogJ0hPTUUnXTtcbiAgICByZXR1cm4gb3MudG1wZGlyKCk7XG59XG5mdW5jdGlvbiBzZXR1cE9uY2UoKSB7XG4gICAgdmFyIGhvbWUgPSBnZXRXcml0YWJsZURpcigpO1xuICAgIHRyeSB7XG4gICAgICAgIGZzLm1rZGlyU3luYyhob21lICsgJy8nICsgJ2ZkZXZzdGFydCcpO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgICBmcy5ta2RpclN5bmMoaG9tZSArICcvZmRldnN0YXJ0L2xvZ3MnKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICB9XG59XG5zZXR1cE9uY2UoKTtcbmZ1bmN0aW9uIGdldEZpbGVOYW1lKG5hbWUpIHtcbiAgICByZXR1cm4gb3MudG1wZGlyKCkgKyAnL2ZkZXZzdGFydC9sb2dzLycgKyBuYW1lICsgXCIubG9nXCI7XG59XG5leHBvcnRzLl90ZXN0ID0ge1xuICAgIGdldEZpbGVOYW1lOiBnZXRGaWxlTmFtZVxufTtcbmZ1bmN0aW9uIGxvZ0l0KGxvZ2dlciwgYXJnKSB7XG4gICAgdmFyIHRleHQ7XG4gICAgaWYgKHR5cGVvZiBhcmcgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgdGV4dCA9IGFyZztcbiAgICB9XG4gICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgdGV4dCA9IFwiRXJyb3I6XCIgKyBhcmcubWVzc2FnZSArIFwiIFwiICsgYXJnLnN0YWNrO1xuICAgIH1cbiAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSWxsZWdhbCBhcmd1bWVudCB0byBsb2dcIik7XG4gICAgfVxuICAgIHZhciBmaWxlbmFtZSA9IGdldEZpbGVOYW1lKGxvZ2dlci5uYW1lKTtcbiAgICB2YXIgZCA9IG5ldyBEYXRlKCk7XG4gICAgdmFyIG4gPSBkLnRvVVRDU3RyaW5nKCkgKyBcIlxcdFwiICsgdGV4dDtcbiAgICBkZWJ1Z2xvZygnd3JpdGluZyBsb2cgZW50cnkgdG8gJyArIGZpbGVuYW1lICsgJyAnICsgbik7XG4gICAgZnMud3JpdGVGaWxlU3luYyhmaWxlbmFtZSwgbiwgeyBlbmNvZGluZzogJ3V0Zi04JywgZmxhZzogJ2EnIH0pO1xufVxuZnVuY3Rpb24gbG9nZ2VyKG5hbWUsIGZsYWdzKSB7XG4gICAgaWYgKGZsYWdzICE9PSAnYScgJiYgZmxhZ3MgIT09ICcnICYmIGZsYWdzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdvbmx5IGEgYWxsb3dlZCBhcyBmbGFncycpO1xuICAgIH1cbiAgICBmbGFncyA9IChmbGFncyA9PT0gdW5kZWZpbmVkKSA/ICdhJyA6IGZsYWdzO1xuICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIiB8fCAhL15bQS1aYS16XVtBLVphLXowLTlfXSskLy5leGVjKG5hbWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTG9nZ2VyIG5hbWUgbXVzdCBiZSBhdCBsZWFzdCB0d28gYWxwaGFudW1lcmljIGNoYXJhY3RlcnMnKTtcbiAgICB9XG4gICAgaWYgKCFsb2dnZXJzW25hbWVdKSB7XG4gICAgICAgIHZhciBhbG9nZ2VyID0ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIGZsYWdzOiBmbGFnc1xuICAgICAgICB9O1xuICAgICAgICBhbG9nZ2VyLmxvZ0l0ID0gbG9nSXQuYmluZCh1bmRlZmluZWQsIGFsb2dnZXIpO1xuICAgICAgICAvLyByZXNldCB0aGUgZmlsZVxuICAgICAgICBpZiAoZmxhZ3MgPT09ICcnKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMoZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZyhcIioqKkVSUk9SOiB1bmFibGUgdG8gcmVtb3ZlIGxvZyBmaWxlIFwiICsgZ2V0RmlsZU5hbWUobmFtZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxvZ2dlcnNbbmFtZV0gPSBhbG9nZ2VyO1xuICAgIH1cbiAgICBpZiAobG9nZ2Vyc1tuYW1lXS5mbGFncyAhPT0gZmxhZ3MpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGTGFncyBtaXNtYXRjaCBpbiBsb2dnZXInICsgbmFtZSk7XG4gICAgfVxuICAgIHJldHVybiBsb2dnZXJzW25hbWVdLmxvZ0l0O1xufVxuZXhwb3J0cy5sb2dnZXIgPSBsb2dnZXI7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
